<!DOCTYPE html>
<html lang="en" data-theme="neptune-vibe">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>&#x2666; Activity - Attendance Tracker</title> <!-- Added diamond emoji to title -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- For icons, e.g., for user profile or arrows -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Basic Reset & Global Styles */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Poppins:wght@400;500;600&display=swap');

        :root {
            /* Default Light Theme Colors (Fallback) */
            --bg-primary: linear-gradient(135deg, #F0F4F8 0%, #E6EEF5 100%);
            --bg-secondary: #FFFFFF;
            --text-primary: #2C3E50;
            --text-secondary: #607D8B;
            --accent-color: #007BFF;
            --border-color: #DDE6ED;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --input-bg: #F8FAFC;
            --gradient-start: #6DD5FA;
            --gradient-mid1: #2980B9;
            --gradient-mid2: #1ABC9C;
            --gradient-mid3: #3498DB;
            --gradient-end: #8E44AD;
            --nav-bg: #2C3E50;
            --nav-text: #ffffff;
            --footer-bg: #2C3E50;
            --footer-text: #ffffff;
            --table-header-bg: #007BFF;
            --table-row-even: #F0F4F8;
            --table-row-hover: #E6EEF5;
            --status-present: #2C3E50;
            --status-absent: #E74C3C;
            --status-weekend: #808080;
            --status-holiday: #4CAF50;
            --status-govt-holiday: #FFD700;
            --status-sick-leave: #FF8C00;

            --status-present-bg: #E3F2FD;
            --status-absent-bg: #FFEBEE;
            --status-weekend-bg: #EEEEEE;
            --status-holiday-bg: #E8F5E9;
            --status-govt-holiday-bg: #FFFDE7;
            --status-sick-leave-bg: #FFF3E0;

            --chart-color-present: #007BFF;
            --chart-color-absent: #E74C3C;
            --chart-color-late: #FFC107;
            --chart-color-weekend: #808080;
            --chart-color-holiday: #4CAF50;
        }

        /* Dark Theme Overrides */
        html[data-theme='dark'] {
            --bg-primary: linear-gradient(135deg, #1A2A3A 0%, #0A1620 100%);
            --bg-secondary: #2A3B4D;
            --text-primary: #E0E6EB;
            --text-secondary: #AAB8C2;
            --accent-color: #00C896;
            --border-color: #4A5C6F;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --input-bg: #3A4C5E;
            --gradient-start: #0A1620;
            --gradient-mid1: #1A2A3A;
            --gradient-mid2: #2A3B4D;
            --gradient-mid3: #3A4C5E;
            --gradient-end: #4A5C6F;
            --nav-bg: #0A1620;
            --nav-text: #E0E6EB;
            --footer-bg: #0A1620;
            --footer-text: #E0E6EB;
            --table-header-bg: #00C896;
            --table-row-even: #203040;
            --table-row-hover: #30455A;
            --status-present: #E0E6EB;
            --status-absent: #FF6B6B;
            --status-weekend: #AAB8C2;
            --status-holiday: #00FF00;
            --status-govt-holiday: #FFD700;
            --status-sick-leave: #FFA500;

            --status-present-bg: #2B4C6D;
            --status-absent-bg: #4D2626;
            --status-weekend-bg: #3A4C5E;
            --status-holiday-bg: #2E4E2E;
            --status-govt-holiday-bg: #4D4A26;
            --status-sick-leave-bg: #4D3A26;

            --chart-color-present: #00C896;
            --chart-color-absent: #FF6B6B;
            --chart-color-late: #FFD700;
            --chart-color-weekend: #AAB8C2;
            --chart-color-holiday: #00FF00;
        }
        
        /* NeptuneVibe Theme (New & Default) */
        html[data-theme='neptune-vibe'] {
            --bg-primary: linear-gradient(135deg, #0A192F 0%, #172A45 100%); /* Deep ocean blue */
            --bg-secondary: #0F2038; /* Slightly lighter deep blue */
            --text-primary: #8892B0; /* Light grayish blue */
            --text-secondary: #CCD6F6; /* Lighter blue-gray for accents */
            --accent-color: #4A90E2; /* Deeper blue for main accent */
            --button-gradient-start: #4A90E2; /* New start for button gradient */
            --button-gradient-end: #00BFFF; /* New end for button gradient */
            --border-color: #2A3B4D; /* Medium desaturated blue */
            --shadow-color: rgba(2, 12, 27, 0.7); /* Darker, more intense shadow */
            --input-bg: #112240; /* Dark blue for inputs */
            --gradient-start: #0F2038;
            --gradient-mid1: #0A192F;
            --gradient-mid2: #172A45;
            --gradient-mid3: #0F2038;
            --gradient-end: #112240;
            --nav-bg: #0A192F;
            --nav-text: #CCD6F6; /* Lighter blue-gray for nav text */
            --footer-bg: #0A192F;
            --footer-text: #8892B0;

            --table-header-bg: linear-gradient(90deg, #112240, #2A3B4D); /* Gradient for table header */
            --table-row-even: #112240;
            --table-row-hover: #172A45;
            --status-present: #64FFDA; /* Keep a bright accent for present status text */
            --status-absent: #E74C3C; /* Red */
            --status-weekend: #8892B0; /* Light grayish blue */
            --status-holiday: #FFD700; /* Gold */
            --status-govt-holiday: #7FFF00; /* Chartreuse */
            --status-sick-leave: #FFA500; /* Orange */

            --status-present-bg: rgba(100, 255, 218, 0.1); /* Light aqua transparent */
            --status-absent-bg: rgba(231, 76, 60, 0.1); /* Light red transparent */
            --status-weekend-bg: rgba(136, 146, 176, 0.1); /* Light gray transparent */
            --status-holiday-bg: rgba(255, 215, 0, 0.1); /* Light gold transparent */
            --status-govt-holiday-bg: rgba(127, 255, 0, 0.1); /* Light chartreuse transparent */
            --status-sick-leave-bg: rgba(255, 165, 0, 0.1); /* Light orange transparent */

            --chart-color-present: #4A90E2; /* New chart color for present */
            --chart-color-absent: #E74C3C; /* Red */
            --chart-color-late: #FFC107; /* Amber */
            --chart-color-weekend: #8892B0; /* Light grayish blue (if used) */
            --chart-color-holiday: #7FFF00; /* Chartreuse (if used) */

            /* Specific styling for neptune-vibe elements */
            .premium-button {
                background: linear-gradient(135deg, var(--button-gradient-start) 0%, var(--button-gradient-end) 100%);
                color: var(--text-secondary); /* Lighter text for buttons */
                box-shadow: 0 4px 15px rgba(0, 191, 255, 0.4); /* Shadow based on blue gradient */
            }
            .premium-button:hover {
                box-shadow: 0 6px 20px rgba(0, 191, 255, 0.6);
            }
            .auth-container {
                box-shadow: 0 15px 40px var(--shadow-color);
            }
            .section-card {
                box-shadow: 0 8px 30px var(--shadow-color);
            }
            #main-navbar {
                box-shadow: 0 2px 15px var(--shadow-color);
            }
            .logo-icon {
                filter: drop-shadow(0 0 5px var(--accent-color));
            }
            .user-photo {
                border: 2px solid var(--accent-color);
            }
            .user-dashboard-photo {
                border: 3px solid var(--accent-color);
            }
            .summary-grid div {
                background-color: var(--input-bg);
                box-shadow: 0 1px 8px rgba(0, 0, 0, 0.3);
            }
            .summary-grid span {
                color: var(--accent-color);
            }
            #attendanceTable thead, #historyAttendanceTable thead {
                background: var(--table-header-bg); /* Use gradient for table header */
                color: var(--nav-text); /* Ensure good contrast */
            }
            .table-actions button {
                background: linear-gradient(90deg, var(--button-gradient-start), var(--button-gradient-end)); /* Small buttons also gradient */
                color: var(--text-secondary); /* Lighter text for small buttons */
                box-shadow: 0 1px 6px rgba(0, 191, 255, 0.3);
            }
            .table-actions button:hover {
                background: linear-gradient(90deg, var(--button-gradient-end), var(--button-gradient-start));
                box-shadow: 0 2px 8px rgba(0, 191, 255, 0.5);
            }
            .table-actions .delete-button {
                background-color: var(--status-absent);
                color: var(--bg-secondary);
            }
            .modal-content {
                box-shadow: 0 10px 40px var(--shadow-color);
            }
            #customAlertModal .modal-content,
            #customConfirmModal .modal-content {
                border-left: 6px solid var(--accent-color);
            }
            .help-modal-content h2 {
                text-shadow: 0 0 10px var(--accent-color);
            }
            footer {
                border-top: 3px solid var(--accent-color);
                box-shadow: 0 -3px 20px var(--shadow-color);
            }
            footer .footer-section h4 {
                color: var(--accent-color);
            }
            /* Headlines with subtle text shadow for NeptuneVibe */
            html[data-theme='neptune-vibe'] h1, 
            html[data-theme='neptune-vibe'] h2, 
            html[data-theme='neptune-vibe'] h3, 
            html[data-theme='neptune-vibe'] h4 {
                text-shadow: 0px 0px 8px rgba(0, 191, 255, 0.3); /* Subtle blue glow */
            }
        }


        /* Alert/Warning Colors (remain consistent but adapt to theme text) */
        --alert-info: #2196F3;
        --alert-success: #4CAF50;
        --alert-warning: #FFC107;
        --alert-error: #F44336;

        --transition-speed: 0.3s ease-in-out;
        --border-radius-base: 8px; /* Slightly more rounded */
        --border-radius-large: 12px;

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            color: var(--text-primary);
            line-height: 1.6; /* Slightly increased for readability */
            overflow-x: hidden; /* Prevent horizontal scroll */
            background: var(--bg-primary); /* Default background now uses gradient variable */
            transition: background var(--transition-speed), color var(--transition-speed);
        }

        body.main-page-body {
            background: var(--bg-primary); /* Use theme primary background for main page */
            padding-top: 60px; /* Space for fixed navbar */
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        h1, h2, h3, h4 {
            font-family: 'Poppins', sans-serif;
            color: var(--text-primary);
            font-weight: 500; /* Standard font weight */
            transition: color var(--transition-speed);
        }

        /* Premium Button Style */
        .premium-button {
            background-color: var(--accent-color); /* Vibrant accent color */
            color: var(--nav-text); /* White text for buttons */
            padding: 10px 20px; /* Standard padding */
            border: none;
            border-radius: 6px; /* Slightly less rounded */
            font-size: 0.9rem; /* Standard font size */
            font-weight: 500; /* Standard font weight */
            cursor: pointer;
            transition: all var(--transition-speed);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2); /* Standard shadow */
            letter-spacing: 0.3px;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .premium-button:hover {
            background-color: var(--accent-color); /* Keep same color, but change shadow/transform */
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3); /* Slightly larger shadow */
            transform: translateY(-1px) scale(1.005);
        }

        .premium-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        /* Secondary Button Style */
        .premium-button.secondary {
            background-color: var(--border-color);
            color: var(--text-primary);
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .premium-button.secondary:hover {
            background-color: var(--border-color); /* Keep same color, but change shadow/transform */
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px) scale(1.005);
        }

        /* Delete Button Style */
        .premium-button.delete-button {
            background-color: var(--status-absent); /* Red for delete */
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
        }

        .premium-button.delete-button:hover {
            background-color: var(--status-absent);
            box-shadow: 0 3px 8px rgba(192, 57, 43, 0.3);
        }

        /* --- Login Page Specific Styles --- */
        .login-page-body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%); /* Use theme gradient */
            background-size: 200% 200%;
            animation: gradientAnimation 15s ease infinite;
            color: var(--nav-text);
            transition: background var(--transition-speed);
        }

        .auth-container {
            background-color: var(--bg-secondary); /* Use secondary background for auth container */
            backdrop-filter: blur(8px); /* More pronounced blur effect */
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 15px 40px var(--shadow-color);
            text-align: center;
            width: 90%;
            max-width: 320px; /* Slightly wider */
            animation: fadeInScale 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
            color: var(--text-primary);
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed), border-color var(--transition-speed);
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .auth-container h1.premium-heading {
            font-size: 1.8rem; /* Adjusted font size */
            margin-bottom: 10px;
            color: var(--text-primary);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }

        .auth-container .sub-heading {
            font-size: 0.9rem;
            margin-bottom: 25px;
            color: var(--accent-color);
            font-weight: 400; /* Standard font weight */
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            animation: slideIn 0.5s ease-out forwards;
        }

        .input-group {
            text-align: left;
            position: relative;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500; /* Standard font weight */
            color: var(--text-primary);
            font-size: 0.85rem;
            letter-spacing: 0.2px;
        }

        .input-group input[type="email"],
        .input-group input[type="password"],
        .input-group input[type="text"],
        .input-group input[type="date"],
        .input-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px; /* Less rounded */
            font-size: 0.9rem;
            transition: all var(--transition-speed);
            background-color: var(--input-bg);
            color: var(--text-primary);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        }

        .input-group input::placeholder {
            color: var(--text-secondary);
        }

        .input-group input[type="email"]:focus,
        .input-group input[type="password"]:focus,
        .input-group input[type="text"]:focus,
        .input-group input[type="date"]:focus,
        .input-group select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.25);
            outline: none;
        }

        /* Styles for input error states */
        .input-group input.error {
            border-color: var(--alert-error);
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.25);
        }

        .input-group .error-message {
            color: var(--alert-error);
            font-size: 0.75rem;
            margin-top: 3px;
            display: none;
        }

        .input-group input.error + .error-message {
            display: block;
        }

        .login-links {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 0.85rem;
        }

        .login-links a {
            color: var(--accent-color);
            text-decoration: none;
            transition: color var(--transition-speed);
            font-weight: 400; /* Standard font weight */
        }

        .login-links a:hover {
            color: var(--text-primary);
            text-decoration: underline;
        }

        /* --- Main Page General Styles --- */
        .container {
            max-width: 1000px; /* Slightly smaller max width */
            margin: 20px auto;
            padding: 0 15px;
        }

        .section-card {
            background-color: var(--bg-secondary);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 6px 20px var(--shadow-color); /* Slightly smaller shadow */
            animation: slideUp 0.6s ease-out forwards;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color var(--transition-speed), border-color var(--transition-speed);
        }

        .section-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-size: 1.6rem; /* Adjusted font size */
            color: var(--text-primary);
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        /* --- Navigation Bar --- */
        #main-navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--nav-bg);
            color: var(--nav-text);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: background-color 0.3s ease, padding 0.3s ease, backdrop-filter 0.3s ease, color var(--transition-speed);
        }

        #main-navbar.scrolled {
            background-color: rgba(44, 62, 80, 0.9);
            padding: 8px 20px;
            backdrop-filter: blur(6px);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .logo-text {
            font-family: 'Poppins', sans-serif;
            font-size: 1.3rem; /* Adjusted font size */
            font-weight: 600; /* Standard font weight */
            color: var(--nav-text);
            letter-spacing: 0.5px;
        }

        .logo-icon {
            width: 20px;
            height: 20px;
            fill: var(--accent-color);
            transition: fill var(--transition-speed);
        }

        .nav-links {
            display: flex;
            gap: 20px; /* Slightly more space */
            list-style: none;
            margin-right: auto;
            margin-left: 20px;
        }

        .nav-links a {
            color: var(--nav-text);
            text-decoration: none;
            font-weight: 400; /* Standard font weight */
            font-size: 0.9rem;
            transition: color var(--transition-speed);
            position: relative;
            padding-bottom: 3px;
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            background-color: var(--accent-color);
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            transition: width var(--transition-speed), background-color var(--transition-speed);
        }

        .nav-links a:hover::after {
            width: 100%;
        }

        .nav-links a:hover {
            color: var(--accent-color);
        }

        .user-profile-menu {
            position: relative;
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 400; /* Standard font weight */
            color: var(--nav-text);
            padding: 3px 8px;
            border-radius: var(--border-radius-base);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .user-profile-menu:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-photo {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-left: 8px;
            border: 2px solid var(--accent-color);
            object-fit: cover;
            transition: transform var(--transition-speed), border-color var(--transition-speed);
        }

        .user-photo:hover {
            transform: scale(1.08);
            border-color: var(--nav-text);
        }

        .user-profile-menu i {
            margin-left: 4px;
            transition: transform var(--transition-speed);
        }

        .user-profile-menu.active i {
            transform: rotate(180deg);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--bg-secondary);
            min-width: 140px;
            box-shadow: 0 6px 12px var(--shadow-color);
            z-index: 1;
            top: 100%;
            right: 0;
            border-radius: 8px;
            overflow: hidden;
            transform-origin: top right;
            animation: scaleIn 0.2s ease-out forwards;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .user-profile-menu:hover .dropdown-content,
        .user-profile-menu.active .dropdown-content {
            display: block;
        }

        .dropdown-content a {
            color: var(--text-primary);
            padding: 10px 14px;
            text-decoration: none;
            display: block;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            font-weight: 400;
            font-size: 0.85rem;
        }

        .dropdown-content a:hover {
            background-color: var(--bg-primary);
            color: var(--accent-color);
        }

        /* Theme Toggle Button */
        #themeToggle {
            background: none;
            border: none;
            color: var(--nav-text);
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 15px;
            transition: color 0.3s ease, transform 0.2s ease;
        }

        #themeToggle:hover {
            color: var(--accent-color);
            transform: scale(1.1);
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            animation: fadeInOverlay 0.2s ease-out;
        }

        @keyframes fadeInOverlay {
            from { background-color: rgba(0,0,0,0); }
            to { background-color: rgba(0,0,0,0.7); }
        }

        .modal-content {
            background-color: var(--bg-secondary);
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-color);
            width: 90%;
            max-width: 450px;
            position: relative;
            animation: slideDownFadeIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        @keyframes slideDownFadeIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.6rem;
            color: var(--text-primary);
            text-align: center;
        }

        .modal-content .close-button {
            color: var(--border-color);
            font-size: 24px;
            font-weight: 600; /* Standard font weight */
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .modal-content .close-button:hover,
        .modal-content .close-button:focus {
            color: var(--text-primary);
            transform: rotate(90deg);
        }

        .user-photo-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-color);
            margin-top: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: border-color var(--transition-speed);
        }

        /* --- User Dashboard Section --- */
        .user-dashboard-section {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 25px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 8px 25px var(--shadow-color);
            margin-bottom: 20px;
            animation: slideUp 0.6s ease-out forwards;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        .user-dashboard-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: border-color var(--transition-speed);
        }

        .user-dashboard-info {
            text-align: left;
            flex-grow: 1;
            min-width: 250px;
        }

        .user-dashboard-info h3 {
            font-size: 2rem;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .user-dashboard-info p {
            font-size: 0.95rem;
            margin-bottom: 4px;
            color: var(--text-secondary);
        }

        .user-dashboard-info strong {
            font-weight: 500; /* Standard font weight */
            color: var(--text-primary);
        }

        /* --- Month Selector & History Summary --- */
        .month-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 18px;
        }

        /* Styling for the new month dropdown */
        #monthSelectDropdown {
            padding: 8px 16px;
            font-size: 0.9rem; /* Standard font size */
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-speed);
            box-shadow: 0 2px 6px var(--shadow-color);
            font-weight: 400; /* Standard font weight */
        }

        #monthSelectDropdown:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.25);
            outline: none;
        }

        .current-month {
            font-size: 1.1rem; /* Standard font size */
            font-weight: 500; /* Standard font weight */
            color: var(--text-primary);
            transition: color var(--transition-speed);
        }

        .date-range-display {
            text-align: center;
            margin-bottom: 15px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            transition: color var(--transition-speed);
        }

        .history-summary {
            background-color: var(--bg-primary);
            border-radius: var(--border-radius-base);
            padding: 15px;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);
            margin-top: 15px;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
            display: grid; /* Use grid for layout */
            grid-template-columns: 1fr; /* Default to single column */
            gap: 20px; /* Space between summary and chart */
        }

        @media (min-width: 768px) {
            .history-summary {
                grid-template-columns: 1fr 250px; /* Two columns: summary grid and chart */
            }
        }

        .history-summary h3 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 1.2rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            text-align: center;
        }

        .summary-grid div {
            background-color: var(--bg-secondary);
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 1px 6px var(--shadow-color);
            font-weight: 400; /* Standard font weight */
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color var(--transition-speed);
            border: 1px solid var(--border-color);
        }

        .summary-grid div:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .summary-grid strong {
            color: var(--text-primary);
            display: block;
            margin-bottom: 3px;
            font-size: 0.8rem; /* Adjusted font size */
        }

        .summary-grid span {
            font-size: 1rem; /* Adjusted font size */
            color: var(--accent-color);
            font-weight: 600; /* Standard font weight */
        }

        /* Chart container styling */
        .chart-container {
            position: relative;
            width: 100%; /* Take full width of its grid column */
            max-width: 250px; /* Max width for circular chart */
            margin: 0 auto;
            padding: 10px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 1px 6px var(--shadow-color);
            align-self: center; /* Vertically align in grid */
        }

        /* --- Data Entry Form (if visible) --- */
        .data-entry-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .data-entry-form .input-group {
            margin-bottom: 0;
        }

        .data-entry-form input[type="date"],
        .data-entry-form input[type="number"],
        .data-entry-form input[type="text"],
        .data-entry-form select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-base);
            font-size: 0.9rem;
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: background-color var(--transition-speed), border-color var(--transition-speed), color var(--transition-speed);
        }

        .data-entry-form input:focus,
        .data-entry-form select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(108, 99, 255, 0.2);
            outline: none;
        }

        #addEntryBtn {
            grid-column: 1 / -1;
            width: 70%;
            margin: 0 auto;
            display: block;
        }

        /* --- Saved Entries Table --- */
        .table-responsive {
            overflow-x: auto;
        }

        #attendanceTable, #historyAttendanceTable {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            background-color: var(--bg-secondary);
            box-shadow: 0 4px 15px var(--shadow-color);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        #attendanceTable thead, #historyAttendanceTable thead {
            background-color: var(--table-header-bg);
            color: var(--nav-text);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        #attendanceTable th,
        #attendanceTable td,
        #historyAttendanceTable th,
        #historyAttendanceTable td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: color var(--transition-speed), border-color var(--transition-speed);
        }

        #attendanceTable th, #historyAttendanceTable th {
            font-weight: 500; /* Standard font weight */
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.2px;
        }

        #attendanceTable tbody tr:nth-child(even), #historyAttendanceTable tbody tr:nth-child(even) {
            background-color: var(--table-row-even);
            transition: background-color var(--transition-speed);
        }

        #attendanceTable tbody tr:hover, #historyAttendanceTable tbody tr:hover {
            background-color: var(--table-row-hover);
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }

        /* Status Background Colors for Table Rows */
        .status-present-row { background-color: var(--status-present-bg) !important; }
        .status-absent-row { background-color: var(--status-absent-bg) !important; }
        .status-weekend-row { background-color: var(--status-weekend-bg) !important; }
        .status-holiday-row { background-color: var(--status-holiday-bg) !important; }
        .status-government_holiday-row { background-color: var(--status-govt-holiday-bg) !important; }
        .status-sick_leave-row { background-color: var(--status-sick-leave-bg) !important; }


        .table-actions button {
            background-color: var(--accent-color);
            color: var(--nav-text);
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem; /* Adjusted font size */
            margin-right: 4px;
            transition: all var(--transition-speed);
            box-shadow: 0 1px 4px rgba(108, 99, 255, 0.2);
        }

        .table-actions button:hover {
            background-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(108, 99, 255, 0.3);
        }

        .table-actions .delete-button {
            background-color: var(--status-absent);
            box-shadow: 0 1px 4px rgba(231, 76, 60, 0.2);
        }

        .table-actions .delete-button:hover {
            background-color: var(--status-absent);
            box-shadow: 0 2px 6px rgba(192, 57, 43, 0.3);
        }

        /* Specific Status Colors (Text Only) */
        .status-present { color: var(--status-present); font-weight: 500; transition: color var(--transition-speed); }
        .status-absent { color: var(--status-absent); font-weight: 500; transition: color var(--transition-speed); }
        .status-weekend { color: var(--status-weekend); font-weight: 500; transition: color var(--transition-speed); }
        .status-holiday { color: var(--status-holiday); font-weight: 500; transition: color var(--transition-speed); }
        .status-government_holiday { color: var(--status-govt-holiday); font-weight: 500; transition: color var(--transition-speed); }
        .status-sick_leave { color: var(--status-sick-leave); font-weight: 500; transition: color var(--transition-speed); }
        
        /* Modal for Status Selection */
        #statusSelectionModal .modal-options button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all var(--transition-speed);
            box-shadow: 0 2px 6px var(--shadow-color);
            font-weight: 400; /* Standard font weight */
        }
        #statusSelectionModal .modal-options button:hover {
            background-color: var(--border-color);
            transform: translateY(-1px);
            box-shadow: 0 3px 9px rgba(0, 0, 0, 0.2);
        }
        #statusSelectionModal .modal-options button:last-child {
            margin-bottom: 0;
        }

        /* Modal for Present Entry */
        #presentEntryModal .input-group {
            margin-bottom: 12px;
        }
        #presentEntryModal .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500; /* Standard font weight */
            color: var(--text-primary);
        }
        #presentEntryModal .input-group input,
        #presentEntryModal .input-group select {
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            width: 100%;
            font-size: 0.9rem;
            background-color: var(--input-bg);
            color: var(--text-primary);
            font-weight: 400; /* Standard font weight */
        }
        #presentEntryModal .input-group input:focus,
        #presentEntryModal .input-group select:focus {
            box-shadow: 0 0 0 2px rgba(108, 99, 255, 0.2);
            outline: none;
        }
        #presentEntryModal .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 15px;
        }
        #presentEntryModal .modal-buttons .premium-button {
            padding: 8px 16px;
            font-size: 0.85rem; /* Adjusted font size */
        }
        #presentEntryModal .modal-buttons .premium-button.save {
            background-color: var(--accent-color);
            color: var(--nav-text);
        }
        #presentEntryModal .modal-buttons .premium-button.save:hover {
            background-color: var(--accent-color);
        }
        #presentEntryModal .modal-buttons .premium-button.cancel {
            background-color: var(--border-color);
            color: var(--text-primary);
        }
        #presentEntryModal .modal-buttons .premium-button.cancel:hover {
            background-color: var(--border-color);
        }

        /* Edit/Delete Modal specific styles */
        #editDeleteModal .modal-content .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500; /* Standard font weight */
            color: var(--text-primary);
        }
        #editDeleteModal .modal-content .input-group input,
        #editDeleteModal .modal-content .input-group select {
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            width: 100%;
            font-size: 0.9rem;
            background-color: var(--input-bg);
            color: var(--text-primary);
            font-weight: 400; /* Standard font weight */
        }
        #editDeleteModal .modal-content .input-group input:focus,
        #editDeleteModal .modal-content .input-group select:focus {
            box-shadow: 0 0 0 2px rgba(108, 99, 255, 0.2);
            outline: none;
        }
        #editDeleteModal .modal-content .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 15px;
        }
        #editDeleteModal .modal-content .modal-buttons .premium-button {
            padding: 8px 16px;
            font-size: 0.85rem; /* Adjusted font size */
        }
        #editDeleteModal .modal-content .modal-buttons .premium-button.save {
            background-color: var(--accent-color);
            color: var(--nav-text);
        }
        #editDeleteModal .modal-content .modal-buttons .premium-button.save:hover {
            background-color: var(--accent-color);
        }
        #editDeleteModal .modal-content .modal-buttons .premium-button.delete-button {
            background-color: var(--status-absent);
        }
        #editDeleteModal .modal-content .modal-buttons .premium-button.delete-button:hover {
            background-color: var(--status-absent);
        }

        /* --- History Page Specific Styles --- */
        #historySection {
            display: none;
        }

        #historySection .date-range-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        #historySection .date-range-inputs .input-group {
            flex: 1;
            min-width: 220px;
        }

        #historySection .date-range-inputs button {
            flex-grow: 1;
            max-width: 160px;
            margin-top: 24px;
        }

        #historySummaryResult {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--bg-primary);
            border-radius: var(--border-radius-base);
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }

        #historySummaryResult h3 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 1.2rem;
        }

        /* --- Footer --- */
        footer {
            text-align: center;
            padding: 20px 15px;
            background-color: var(--footer-bg);
            color: var(--footer-text);
            font-size: 0.8rem;
            margin-top: 30px;
            border-top: 3px solid var(--accent-color);
            animation: fadeIn 0.8s ease-out;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            align-items: flex-start;
            gap: 15px;
            box-shadow: 0 -3px 15px rgba(0,0,0,0.3);
            transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed);
        }

        footer .footer-section {
            flex: 1;
            min-width: 200px;
            text-align: center;
        }

        footer .footer-section h4 {
            font-size: 1rem;
            margin-bottom: 10px;
            color: var(--accent-color);
            font-family: 'Poppins', sans-serif;
            font-weight: 600; /* Standard font weight */
            transition: color var(--transition-speed);
        }

        footer .footer-section p {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem; /* Adjusted font size */
        }

        footer .footer-section p i {
            margin-right: 8px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1rem;
        }

        footer .footer-section a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: color var(--transition-speed);
        }

        footer .footer-section a:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }

        /* Custom Alert/Confirm Modal Styles */
        #customAlertModal .modal-content,
        #customConfirmModal .modal-content {
            padding: 25px;
            max-width: 380px;
            text-align: center;
            border-left: 6px solid;
            animation: slideDownFadeIn 0.3s ease-out;
            transition: border-color var(--transition-speed);
        }

        #customAlertModal .modal-content.info,
        #customConfirmModal .modal-content.info { border-color: var(--alert-info); }
        #customAlertModal .modal-content.success,
        #customConfirmModal .modal-content.success { border-color: var(--alert-success); }
        #customAlertModal .modal-content.warning,
        #customConfirmModal .modal-content.warning { border-color: var(--alert-warning); }
        #customAlertModal .modal-content.error,
        #customConfirmModal .modal-content.error { border-color: var(--alert-error); }

        #customAlertModal h2,
        #customConfirmModal h2 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        #customAlertModal p,
        #customConfirmModal p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        #customAlertModal .modal-buttons,
        #customConfirmModal .modal-buttons {
            justify-content: center;
            gap: 10px;
        }

        #customAlertModal .modal-buttons .premium-button,
        #customConfirmModal .modal-buttons .premium-button {
            padding: 8px 20px;
            font-size: 0.9rem;
        }

        /* Help Modal Specific Styles */
        .help-modal-content {
            background-color: var(--bg-secondary);
            text-align: center;
            padding: 40px;
            animation: bounceIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px var(--shadow-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        .help-modal-content h2 {
            font-size: 2.2rem;
            color: var(--accent-color);
            margin-bottom: 15px;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        .help-modal-content p {
            font-size: 1.2rem; /* Adjusted font size */
            color: var(--text-primary);
            font-weight: 500; /* Standard font weight */
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #main-navbar {
                flex-direction: column;
                padding: 10px 15px;
                gap: 8px;
            }
            .nav-links {
                margin-left: 0;
                justify-content: center;
                width: 100%;
                gap: 10px;
            }
            .user-profile-menu {
                margin-top: 8px;
            }
            .auth-container {
                padding: 25px;
                max-width: 90%;
            }
            .auth-container h1.premium-heading {
                font-size: 1.6rem;
            }
            .auth-container .sub-heading {
                font-size: 0.85rem;
            }
            .premium-button {
                padding: 10px 20px;
                font-size: 0.85rem;
            }
            .data-entry-form {
                grid-template-columns: 1fr;
            }
            #addEntryBtn {
                width: 90%;
            }
            footer {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            footer .footer-section {
                text-align: center;
            }
            footer .footer-section p {
                justify-content: center;
            }

            .user-dashboard-section {
                flex-direction: column;
                text-align: center;
            }
            .user-dashboard-info {
                text-align: center;
            }

            #historySection .date-range-inputs button {
                margin-top: 8px;
            }

            .history-summary {
                grid-template-columns: 1fr; /* Stack summary and chart vertically */
            }
        }
    </style>
</head>
<body>
    <!-- Login/Registration Section -->
    <div id="authSection" class="login-page-body">
        <div class="auth-container">
            <h1 class="premium-heading" id="authHeading"></h1> 

            <form id="loginForm" class="auth-form active">
                <div class="input-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                    <span class="error-message" id="loginEmailError"></span>
                </div>
                <div class="input-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    <span class="error-message" id="loginPasswordError"></span>
                </div>
                <div class="login-links">
                    <a href="#" id="registerHereLink">Register Here</a>
                </div>
                <button type="submit" class="premium-button">Login</button>
            </form>

            <form id="registerForm" class="auth-form" style="display: none;">
                <div class="input-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email address" required>
                    <span class="error-message" id="registerEmailError"></span>
                </div>
                <div id="registrationDetails" style="display: block;"> <!-- Always visible now -->
                    <div class="input-group">
                        <label for="registerUsername">Username</label>
                        <input type="text" id="registerUsername" placeholder="Choose a username" required>
                    </div>
                    <div class="input-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" placeholder="Create a password" required>
                        <span class="error-message" id="registerPasswordError"></span>
                    </div>
                    <div class="input-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                        <span class="error-message" id="confirmPasswordError"></span>
                    </div>
                    <div class="input-group">
                        <label for="registerJoiningDate">Joining Date</label>
                        <input type="date" id="registerJoiningDate" required>
                    </div>
                    <div class="input-group">
                        <label for="registerLngId">LnG ID</label>
                        <input type="text" id="registerLngId" placeholder="Enter your LnG ID" required>
                    </div>
                </div>
                <button type="submit" class="premium-button" id="registerSubmitBtn">Register</button> <!-- Not disabled anymore -->
                <p style="color: var(--text-primary); font-size: 0.95rem;">Already have an account? <a href="#" id="loginHereLink" style="color: var(--accent-color); text-decoration: underline;">Login Here</a></p>
            </form>
        </div>
    </div>

    <!-- Main Activity Page Section (Initially hidden) -->
    <div id="mainActivitySection" style="display: none;">
        <!-- First Section: Navigation Bar -->
        <nav id="main-navbar">
            <div class="logo-container">
                <span class="logo-text">Activity</span>
                <!-- Diamond Logo SVG -->
                <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 12L12 22L22 12L12 2Z"/>
                </svg>
            </div>
            <ul class="nav-links">
                <li><a href="#" id="homeNavLink">Home</a></li>
                <li><a href="#" id="historyNavLink">History</a></li>
                <li><a href="#" id="helpNavLink">Help</a></li>
            </ul>
            <div class="nav-right">
                <button id="themeToggle" class="fas fa-sun"></button> <!-- Theme Toggle Button -->
                <div class="user-profile-menu">
                    <span id="usernameDisplay">Username</span>
                    <img id="userPhotoDisplay" src="https://placehold.co/40x40/000000/ffffff?text=User" alt="User Photo" class="user-photo">
                    <i class="fas fa-caret-down"></i>
                    <div class="dropdown-content">
                        <a href="#" id="personalProfileBtn">Personal Profile</a>
                        <a href="#" id="logoutBtn">Logout</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Personal Profile Modal -->
        <div id="profileModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h2>Edit Profile</h2>
                <div class="input-group">
                    <label for="profileNameInput">Profile Name</label>
                    <input type="text" id="profileNameInput" placeholder="Enter your display name">
                </div>
                <div class="input-group">
                    <label for="usernameInput">Username</label>
                    <input type="text" id="usernameInput" placeholder="Enter your username">
                </div>
                <div class="input-group">
                    <label for="emailInput">Email Address</label>
                    <input type="email" id="emailInput" readonly>
                </div>
                <div class="input-group">
                    <label for="profileJoiningDateInput">Joining Date</label>
                    <input type="date" id="profileJoiningDateInput">
                </div>
                <div class="input-group">
                    <label for="profileLngIdInput">LnG ID</label>
                    <input type="text" id="profileLngIdInput" placeholder="Your LnG ID">
                </div>
                <div class="input-group">
                    <label for="profilePictureInput">Profile Picture</label>
                    <input type="file" id="profilePictureInput" accept="image/*">
                    <img id="profilePicturePreview" src="https://placehold.co/100x100/000000/ffffff?text=User" alt="Profile Picture Preview" class="user-photo-preview">
                </div>
                <button id="saveProfileBtn" class="premium-button">Save Changes</button>
            </div>
        </div>

        <main class="container">
            <!-- New 1st Section: User Dashboard -->
            <section id="dashboardSection" class="user-dashboard-section">
                <img id="dashboardUserPhoto" src="https://placehold.co/150x150/000000/ffffff?text=User" alt="User Photo" class="user-dashboard-photo">
                <div class="user-dashboard-info">
                    <h3 id="dashboardUsername">Username</h3>
                    <p><strong>Worked For:</strong> <span id="workedForDisplay">0 years 0 months</span></p>
                    <p><strong>LnG ID:</b> <span id="lngIdDisplay">N/A</span></p>
                </div>
            </section>

            <!-- Second Section: Month Selection and History Result -->
            <section id="monthlySummarySection" class="section-card">
                <h2>Attendance History</h2>
                <div class="month-selector">
                    <select id="monthSelectDropdown"></select>
                </div>

                <div class="date-range-display">
                    <p><strong>From:</strong> <span id="dateFrom"></span> | <strong>To:</strong> <span id="dateTo"></span></p>
                </div>

                <div class="history-summary">
                    <div>
                        <h3>Monthly Summary</h3>
                        <div class="summary-grid">
                            <div><strong>Total Hours:</strong> <span id="summaryTotalHours">0</span></div>
                            <div><strong>Late:</strong> <span id="summaryLate">0</span></div>
                            <div><strong>Absent:</strong> <span id="summaryAbsent">0</span></div>
                            <div><strong>Weekends:</strong> <span id="summaryWeekend">0</span></div>
                            <div><strong>Holidays:</strong> <span id="summaryHoliday">0</span></div> <!-- New Holiday summary -->
                            <div><strong>Working Days:</strong> <span id="summaryWorkingDays">0</span></div>
                            <div><strong>Total Present:</strong> <span id="summaryTotalPresent">0</span></div> <!-- New Total Present -->
                            <div><strong>Night Shifts:</strong> <span id="summaryNightShifts">0</span></div>
                            <div><strong>Grace:</strong> <span id="summaryGrace">0</span></div>
                            <div><strong>Day Shifts:</b> <span id="summaryDayShifts">0</span></div>
                        </div>
                    </div>
                    <!-- Chart container -->
                    <div class="chart-container">
                        <canvas id="monthlyAttendanceChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Fourth Section: Saved Entries Data -->
            <section id="dailyEntriesSection" class="section-card">
                <h2>Daily Attendance Entries</h2> <!-- Heading added here -->
                <div class="table-responsive">
                    <table id="attendanceTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th> <!-- New Day column -->
                                <th>Status</th>
                                <th>Hour</th>
                                <th>Extra Hour</th>
                                <th>Late</th>
                                <th>Shift</th>
                                <th>Grace</th>
                                <th>Approval</th> <!-- New Approval column -->
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- History Page Section (Initially hidden) -->
        <section id="historySection" class="container">
            <div class="section-card">
                <h2>Custom History Report</h2>
                <div class="date-range-inputs">
                    <div class="input-group">
                        <label for="historyDateFrom">From Date:</label>
                        <input type="date" id="historyDateFrom">
                    </div>
                    <div class="input-group">
                        <label for="historyDateTo">To Date:</label>
                        <input type="date" id="historyDateTo">
                    </div>
                    <button id="findHistoryResultBtn" class="premium-button">Find Result</button>
                </div>
                
                <div id="historySummaryResult" class="history-summary">
                    <h3>Report Summary</h3>
                    <div class="summary-grid">
                        <div><strong>Total Hours:</strong> <span id="historySummaryTotalHours">0</span></div>
                        <div><strong>Late:</b> <span id="historySummaryLate">0</span></div>
                        <div><strong>Absent:</strong> <span id="historySummaryAbsent">0</span></div>
                        <div><strong>Weekends:</strong> <span id="historySummaryWeekend">0</span></div>
                        <div><strong>Holidays:</strong> <span id="historySummaryHoliday">0</span></div> <!-- New Holiday summary for history -->
                        <div><strong>Working Days:</strong> <span id="historySummaryWorkingDays">0</span></div>
                        <div><strong>Total Present:</strong> <span id="historySummaryTotalPresent">0</span></div> <!-- New Total Present for history -->
                        <div><strong>Day Shifts:</strong> <span id="historySummaryDayShifts">0</span></div>
                        <div><strong>Night Shifts:</strong> <span id="historySummaryNightShifts">0</span></div>
                        <div><strong>Grace:</strong> <span id="historySummaryGrace">0</span></div>
                    </div>
                </div>

                <div id="historyDetailedEntries" class="table-responsive" style="margin-top: 30px;">
                    <h3>Detailed Entries for Selected Period</h3>
                    <table id="historyAttendanceTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th> <!-- New Day column -->
                                <th>Status</th>
                                <th>Hour</th>
                                <th>Extra Hour</th>
                                <th>Late</th>
                                <th>Shift</th>
                                <th>Grace</th>
                                <th>Approval</th> <!-- New Approval column -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Detailed entries will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Status Selection Modal -->
        <div id="statusSelectionModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeStatusSelectionModal">&times;</span>
                <h2>Select Status</h2>
                <div class="modal-options">
                    <button class="premium-button" id="selectPresent">Present</button>
                    <button class="premium-button" id="selectWeekend">Weekend</button>
                    <button class="premium-button" id="selectAbsent">Absent</button>
                    <button class="premium-button" id="selectHoliday">Holiday</button>
                    <button class="premium-button" id="selectGovernmentHoliday">Government Holiday</button> <!-- New button -->
                    <button class="premium-button" id="selectSickLeave">Sick Leave</button> <!-- New button -->
                </div>
            </div>
        </div>

        <!-- Present Entry Modal -->
        <div id="presentEntryModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closePresentEntryModal">&times;</span>
                <h2>Enter Details</h2>
                <div class="input-group">
                    <label for="presentEntryDate">Date</label>
                    <input type="date" id="presentEntryDate" readonly>
                </div>
                <div class="input-group">
                    <label for="presentEntryStatus">Status</label> <!-- New status display in present modal -->
                    <input type="text" id="presentEntryStatus" readonly value="Present">
                </div>
                <div class="input-group" id="presentHourGroup">
                    <label for="presentHour">Hour</label>
                    <input type="number" id="presentHour" min="0" max="24" value="9" placeholder="e.g., 9">
                </div>
                <div class="input-group" id="presentExtraHourGroup">
                    <label for="presentExtraHour">Extra Hour</label>
                    <input type="number" id="presentExtraHour" min="0" max="24" value="0" placeholder="e.g., 2">
                </div>
                <div class="input-group" id="presentLateGroup">
                    <label for="presentLate">Late (HH:MM)</label>
                    <input type="text" id="presentLate" value="00:00" readonly>
                </div>
                <div class="input-group" id="presentShiftTypeGroup">
                    <label for="presentShiftType">Shift</label>
                    <select id="presentShiftType">
                        <option value="Day">Day</option>
                        <option value="Night">Night</option>
                    </select>
                </div>
                <div class="input-group" id="presentGraceGroup">
                    <label for="presentGrace">Grace</label>
                    <select id="presentGrace">
                        <option value="-">-</option>
                        <option value="Yes">Yes</option>
                    </select>
                    <small id="graceLimitMessage" style="color: var(--alert-error); display: none;">Grace limit reached for this month (5/5)</small>
                </div>
                <div class="input-group" id="presentApprovalGroup"> <!-- New Approval group -->
                    <label for="presentApproval">Approval</label>
                    <select id="presentApproval">
                        <option value="-">-</option>
                        <option value="Approved">Approved</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button id="savePresentEntryBtn" class="premium-button save">Save</button>
                    <button id="cancelPresentEntryBtn" class="premium-button cancel secondary">Cancel</button>
                </div>
            </div>
        </div>


        <!-- Edit/Delete Modal -->
        <div id="editDeleteModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeEditDeleteModal">&times;</span>
                <h2>Edit Entry</h2>
                <div class="input-group">
                    <label for="editDate">Date</label>
                    <input type="date" id="editDate" readonly>
                </div>
                <div class="input-group">
                    <label for="editStatus">Status</label>
                    <select id="editStatus">
                        <option value="Present">Present</option>
                        <option value="Weekend">Weekend</option>
                        <option value="Absent">Absent</option>
                        <option value="Holiday">Holiday</option>
                        <option value="Government_Holiday">Government Holiday</option> <!-- New Holiday option -->
                        <option value="Sick_Leave">Sick Leave</option> <!-- New Sick Leave option -->
                    </select>
                </div>
                <div class="input-group" id="editHourGroup">
                    <label for="editHour">Hour</label>
                    <input type="number" id="editHour" min="0" max="24" placeholder="e.g., 9">
                </div>
                <div class="input-group" id="editExtraHourGroup">
                    <label for="editExtraHour">Extra Hour</label>
                    <input type="number" id="editExtraHour" min="0" max="24" placeholder="e.g., 2">
                </div>
                <div class="input-group" id="editLateHourGroup">
                    <label for="editLateHour">Late (HH:MM)</label>
                    <input type="text" id="editLateHour" value="00:00" readonly>
                </div>
                <div class="input-group" id="editShiftTypeGroup">
                    <label for="editShiftType">Shift</label>
                    <select id="editShiftType">
                        <option value="Day">Day</option>
                        <option value="Night">Night</option>
                    </select>
                </div>
                <div class="input-group" id="editGraceGroup">
                    <label for="editGrace">Grace</label>
                    <select id="editGrace">
                        <option value="-">-</option>
                        <option value="Yes">Yes</option>
                    </select>
                    <small id="editGraceLimitMessage" style="color: var(--alert-error); display: none;">Grace limit reached for this month (5/5)</small>
                </div>
                <div class="input-group" id="editApprovalGroup"> <!-- New Approval group -->
                    <label for="editApproval">Approval</label>
                    <select id="editApproval">
                        <option value="-">-</option>
                        <option value="Approved">Approved</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button id="updateEntryBtn" class="premium-button save">Update</button>
                    <button id="deleteEntryBtn" class="premium-button delete-button">Delete</button>
                </div>
            </div>
        </div>

        <!-- Custom Alert Modal (for general messages) -->
        <div id="customAlertModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeCustomAlertModal">&times;</span>
                <h2 id="customAlertTitle"></h2>
                <p id="customAlertMessage"></p>
                <div class="modal-buttons">
                    <button id="customAlertOkBtn" class="premium-button save">OK</button>
                </div>
            </div>
        </div>

        <!-- Custom Confirm Modal (for yes/no questions) -->
        <div id="customConfirmModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeCustomConfirmModal">&times;</span>
                <h2 id="customConfirmTitle"></h2>
                <p id="customConfirmMessage"></p>
                <div class="modal-buttons">
                    <button id="customConfirmYesBtn" class="premium-button save">Yes</button>
                    <button id="customConfirmNoBtn" class="premium-button secondary">No</button>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="modal">
            <div class="modal-content help-modal-content">
                <span class="close-button" id="closeHelpModal">&times;</span>
                <h2 id="helpModalTitle">Nothing to Help Here</h2>
                <p id="helpModalMessage">😁😁</p>
            </div>
        </div>

        <!-- Fifth Section: Footer -->
        <footer>
            <div class="footer-section">
                <h4>Contact Us</h4>
                <p><i class="fas fa-phone"></i> Phone: +8801518138951</p>
                <p><i class="fas fa-envelope"></i> E-Mail: <a href="mailto:prantorodrix9@gmail.com">prantorodrix9@gmail.com</a></p>
                <p><i class="fas fa-map-marker-alt"></i> Address: Baridhara-DOHS, Gulshan, Dhaka</p>
                <p><i class="fas fa-globe"></i> Website: <a href="https://www.reallygreatsite.com" target="_blank">www.abcd.com</a></p>
            </div>
            <div class="footer-section">
                <h4>Activity</h4>
                <p>&copy; <span id="currentYear"></span> Made by @PrantoAnthonyRodrix. All rights reserved.</p>
             </div>
        </footer>
    </div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            // Local Data Storage (Loaded from localStorage or initialized)
            // Changed localUserData to registeredUsers for multiple user storage
            let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers')) || [];
            let currentLoggedInUser = null; // To store the currently logged-in user's data

            // Save registeredUsers to localStorage
            function saveRegisteredUsers() {
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            }

            // Save currentLoggedInUser's specific data
            function saveCurrentUserData() {
                if (currentLoggedInUser) {
                    // Find the index of the current user in registeredUsers array
                    const userIndex = registeredUsers.findIndex(user => user.email === currentLoggedInUser.email);
                    if (userIndex !== -1) {
                        registeredUsers[userIndex] = currentLoggedInUser;
                    } else {
                        // This case should ideally not happen if user is truly logged in
                        // But as a fallback, add if not found (e.g., first login after clearing localStorage for some reason)
                        registeredUsers.push(currentLoggedInUser);
                    }
                    saveRegisteredUsers();
                }
            }


            // --- DOM Elements - Authentication Section ---
            const authSection = document.getElementById('authSection');
            const mainActivitySection = document.getElementById('mainActivitySection');
            const authHeading = document.getElementById('authHeading');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const registerHereLink = document.getElementById('registerHereLink');
            const loginHereLink = document.getElementById('loginHereLink');
            const loginEmailInput = document.getElementById('loginEmail');
            const loginPasswordInput = document.getElementById('loginPassword');
            const loginEmailError = document.getElementById('loginEmailError');
            const loginPasswordError = document.getElementById('loginPasswordError');


            // Register form specific inputs
            const registerEmailInput = document.getElementById('registerEmail');
            const registerEmailError = document.getElementById('registerEmailError');
            const registrationDetails = document.getElementById('registrationDetails'); 
            const registerUsernameInput = document.getElementById('registerUsername');
            const registerPasswordInput = document.getElementById('registerPassword');
            const registerPasswordError = document.getElementById('registerPasswordError');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const confirmPasswordError = document.getElementById('confirmPasswordError');
            const registerJoiningDateInput = document.getElementById('registerJoiningDate');
            const registerLngIdInput = document.getElementById('registerLngId');
            const registerSubmitBtn = document.getElementById('registerSubmitBtn'); 

            // --- Custom Alert/Confirm Modals DOM Elements (always present in HTML) ---
            const customAlertModal = document.getElementById('customAlertModal');
            const customAlertTitle = document.getElementById('customAlertTitle');
            const customAlertMessage = document.getElementById('customAlertMessage');
            const customAlertOkBtn = document.getElementById('customAlertOkBtn');
            const closeCustomAlertModal = document.getElementById('closeCustomAlertModal');

            const customConfirmModal = document.getElementById('customConfirmModal');
            const customConfirmTitle = document.getElementById('customConfirmTitle');
            const customConfirmMessage = document.getElementById('customConfirmMessage');
            const customConfirmYesBtn = document.getElementById('customConfirmYesBtn');
            const customConfirmNoBtn = document.getElementById('customConfirmNoBtn');
            const closeCustomConfirmModal = document.getElementById('closeCustomConfirmModal');
            let confirmCallback = null; // To store the callback for customConfirmModal

            // Theme toggle button (always present in HTML)
            const themeToggle = document.getElementById('themeToggle');
            const themeList = ['light', 'dark', 'neptune-vibe']; // Updated theme list
            let currentThemeIndex = 0;

            // Help Modal elements (always present in HTML)
            const helpModal = document.getElementById('helpModal');
            const closeHelpModal = helpModal ? helpModal.querySelector('.close-button') : null;
            const helpModalTitle = document.getElementById('helpModalTitle');
            const helpModalMessage = document.getElementById('helpModalMessage');


            // --- DOM Elements - Main Activity Section (will be queried after main section is visible) ---
            let mainNavbar, usernameDisplay, userPhotoDisplay, personalProfileBtn, logoutBtn, profileModal, profileModalCloseBtn,
                profileNameInput, usernameInput, emailInput, profilePictureInput, profilePicturePreview, saveProfileBtn,
                profileJoiningDateInput, profileLngIdInput, dashboardUserPhoto, dashboardUsername, workedForDisplay, lngIdDisplay,
                monthSelectDropdown, dateFromDisplay, dateToDisplay, summaryTotalHours,
                summaryLate, summaryAbsent, summaryWeekend, summaryHoliday, summaryWorkingDays, summaryDayShifts, summaryNightShifts, summaryGrace, summaryTotalPresent,
                attendanceTableBody, editDeleteModal, editDeleteModalCloseBtn, editDateInput, editHourInput,
                editExtraHourInput, editLateHourInput, editShiftTypeInput, updateEntryBtn, deleteEntryBtn, currentYearSpan,
                editStatusInput, editPresentDetailsGroup, editExtraHourGroup, editLateHourGroup, editShiftTypeGroup, editGraceGroup, editGraceInput, editGraceLimitMessage,
                editApprovalGroup, editApprovalInput;

            // Status selection modal elements
            let statusSelectionModal, closeStatusSelectionModal, selectPresentBtn, selectWeekendBtn, selectAbsentBtn, selectHolidayBtn,
                selectGovernmentHolidayBtn, selectSickLeaveBtn; // New status buttons
            let currentSelectedDateForStatus = null; // To store the date for which status is being set

            // Present entry modal elements
            let presentEntryModal, closePresentEntryModal, presentEntryDateInput, presentEntryStatusInput, presentHourInput, presentExtraHourInput,
                presentLateInput, presentShiftTypeInput, presentGraceInput, presentApprovalInput, savePresentEntryBtn, cancelPresentEntryBtn, graceLimitMessage,
                presentHourGroup, presentExtraHourGroup, presentLateGroup, presentShiftTypeGroup, presentGraceGroup, presentApprovalGroup;

            // Navigation elements
            let homeNavLink, historyNavLink, helpNavLinkRef; 
            let dashboardSection, monthlySummarySection, dailyEntriesSection, historySection; 

            // History page elements
            let historyDateFromInput, historyDateToInput, findHistoryResultBtn;
            let historySummaryTotalHours, historySummaryLate, historySummaryAbsent, historySummaryWeekend, historySummaryHoliday,
                historySummaryWorkingDays, historySummaryDayShifts, historySummaryNightShifts, historySummaryGrace, historySummaryTotalPresent;
            let historyAttendanceTableBody;

            // Chart.js instance
            let monthlyChart = null;

            let currentMonthView = new Date(); // Define currentMonthView here globally

            // --- Initial Setup and Authentication Flow ---
            function initializeApp() {
                const savedTheme = localStorage.getItem('theme') || 'neptune-vibe'; // Default to neptune-vibe
                applyTheme(savedTheme);

                // Check if there's a logged-in user session
                const lastLoggedInEmail = localStorage.getItem('lastLoggedInUserEmail');
                if (lastLoggedInEmail) {
                    const user = registeredUsers.find(u => u.email === lastLoggedInEmail);
                    if (user) {
                        currentLoggedInUser = user;
                        showMainActivitySection();
                        return; // Exit if already logged in
                    }
                }
                showAuthSection(); // Show login/registration if no active session
            }

            function showAuthSection() {
                authSection.style.display = 'flex';
                mainActivitySection.style.display = 'none';
                document.body.classList.add('login-page-body');
                document.body.classList.remove('main-page-body');
                setupAuthPage();
            }

            function showMainActivitySection() {
                authSection.style.display = 'none';
                mainActivitySection.style.display = 'block';
                document.body.classList.remove('login-page-body');
                document.body.classList.add('main-page-body');
                queryMainAppElements(); // Query elements once main section is visible
                setupMainApp();
                updateUserProfileDisplay(); // Display initial user data
                populateMonthDropdown(); // Populate month dropdown on main app load
                setupMonthView(currentMonthView); // Set up initial month view
                showSection('dashboard');
            }

            function clearErrors() {
                loginEmailInput.classList.remove('error');
                loginPasswordInput.classList.remove('error');
                loginEmailError.textContent = '';
                loginPasswordError.textContent = '';

                registerEmailInput.classList.remove('error');
                registerPasswordInput.classList.remove('error');
                confirmPasswordInput.classList.remove('error');
                registerEmailError.textContent = '';
                registerPasswordError.textContent = '';
                confirmPasswordError.textContent = '';
            }

            function setupAuthPage() {
                clearErrors(); // Clear errors on page load/switch

                if (loginForm.classList.contains('active')) {
                    if (authHeading) authHeading.textContent = 'ENTER YOUR ACCOUNT';
                } else if (registerForm.classList.contains('active')) {
                    if (authHeading) authHeading.textContent = 'CREATE ACCOUNT';
                }

                if (registerHereLink) {
                    registerHereLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        loginForm.style.display = 'none';
                        registerForm.style.display = 'flex';
                        if (authHeading) authHeading.textContent = 'CREATE ACCOUNT';
                        // Reset register form fields and errors
                        registerEmailInput.value = '';
                        registerUsernameInput.value = '';
                        registerPasswordInput.value = '';
                        confirmPasswordInput.value = '';
                        registerJoiningDateInput.value = '';
                        registerLngIdInput.value = '';
                        clearErrors();
                    });
                }

                if (loginHereLink) {
                    loginHereLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        registerForm.style.display = 'none';
                        loginForm.style.display = 'flex';
                        if (authHeading) authHeading.textContent = 'ENTER YOUR ACCOUNT';
                        clearErrors(); // Clear errors on switch back to login
                    });
                }

                if (loginForm) {
                    loginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        clearErrors(); // Clear previous errors

                        const email = loginEmailInput.value.trim();
                        const password = loginPasswordInput.value.trim();

                        if (!email) {
                            loginEmailInput.classList.add('error');
                            loginEmailError.textContent = 'Email is required.';
                            return;
                        }
                        if (!password) {
                            loginPasswordInput.classList.add('error');
                            loginPasswordError.textContent = 'Password is required.';
                            return;
                        }

                        const user = registeredUsers.find(u => u.email === email);

                        if (!user) {
                            loginEmailInput.classList.add('error');
                            loginEmailError.textContent = 'Email not registered.';
                            return;
                        }

                        if (user.password !== password) { // In a real app, use hashed passwords
                            loginPasswordInput.classList.add('error');
                            loginPasswordError.textContent = 'Incorrect password.';
                            return;
                            }

                        // Successful login
                        currentLoggedInUser = user;
                        // Ensure all new fields are initialized for existing users
                        if (!currentLoggedInUser.attendance) currentLoggedInUser.attendance = {};
                        if (!currentLoggedInUser.graceCounts) currentLoggedInUser.graceCounts = {};

                        localStorage.setItem('lastLoggedInUserEmail', email); // Remember last logged in user
                        showMainActivitySection();
                    });
                }

                if (registerForm) {
                    registerForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        clearErrors(); // Clear previous errors

                        const email = registerEmailInput.value.trim();
                        const username = registerUsernameInput.value.trim();
                        const password = registerPasswordInput.value.trim();
                        const confirmPassword = confirmPasswordInput.value.trim();
                        const joiningDate = registerJoiningDateInput.value;
                        const lngId = registerLngIdInput.value.trim();

                        let hasError = false;

                        if (!email) {
                            registerEmailInput.classList.add('error');
                            registerEmailError.textContent = 'Email is required.';
                            hasError = true;
                        } else if (registeredUsers.some(u => u.email === email)) {
                            registerEmailInput.classList.add('error');
                            registerEmailError.textContent = 'This email is already registered.';
                            hasError = true;
                        }
                        if (!username) {
                            // No specific error message for username, but it's required
                            // For simplicity, not adding .error class to username for now
                        }
                        if (!password) {
                            registerPasswordInput.classList.add('error');
                            registerPasswordError.textContent = 'Password is required.';
                            hasError = true;
                        } else if (password.length < 6) {
                            registerPasswordInput.classList.add('error');
                            registerPasswordError.textContent = 'Password must be at least 6 characters.';
                            hasError = true;
                        }
                        if (!confirmPassword) {
                            confirmPasswordInput.classList.add('error');
                            confirmPasswordError.textContent = 'Confirm password is required.';
                            hasError = true;
                        } else if (password !== confirmPassword) {
                            confirmPasswordInput.classList.add('error');
                            confirmPasswordError.textContent = 'Passwords do not match!';
                            hasError = true;
                        }
                        if (!joiningDate) {
                            // No specific error message for joining date, but it's required
                        }
                        if (!lngId) {
                            // No specific error message for LnG ID, but it's required
                        }

                        if (hasError) {
                            return;
                        }

                        // Simulate registration success
                        const newUser = {
                            profileName: username,
                            username: username,
                            email: email,
                            password: password, // In a real app, hash this password!
                            photo: `https://placehold.co/40x40/000000/ffffff?text=${username.charAt(0).toUpperCase()}`,
                            joiningDate: joiningDate,
                            lngId: lngId,
                            attendance: {},
                            graceCounts: {}
                        };
                        registeredUsers.push(newUser);
                        saveRegisteredUsers();
                        
                        showCustomAlert('Success!', 'Registration successful! You can now login with this email.', 'success');
                        loginForm.style.display = 'flex';
                        registerForm.style.display = 'none';
                        if (authHeading) authHeading.textContent = 'ENTER YOUR ACCOUNT';
                    });
                }
            }

            function queryMainAppElements() {
                // This function is called only when mainActivitySection is displayed.
                // All these elements should exist in the DOM at this point.
                mainNavbar = document.getElementById('main-navbar');
                usernameDisplay = document.getElementById('usernameDisplay');
                userPhotoDisplay = document.getElementById('userPhotoDisplay');
                personalProfileBtn = document.getElementById('personalProfileBtn');
                logoutBtn = document.getElementById('logoutBtn');
                
                profileModal = document.getElementById('profileModal');
                profileModalCloseBtn = profileModal.querySelector('.close-button');
                profileNameInput = document.getElementById('profileNameInput');
                usernameInput = document.getElementById('usernameInput');
                emailInput = document.getElementById('emailInput');
                profilePictureInput = document.getElementById('profilePictureInput');
                saveProfileBtn = document.getElementById('saveProfileBtn');
                profileJoiningDateInput = document.getElementById('profileJoiningDateInput');
                profileLngIdInput = document.getElementById('profileLngIdInput');
                profilePicturePreview = document.getElementById('profilePicturePreview');

                dashboardUserPhoto = document.getElementById('dashboardUserPhoto');
                dashboardUsername = document.getElementById('dashboardUsername');
                workedForDisplay = document.getElementById('workedForDisplay');
                lngIdDisplay = document.getElementById('lngIdDisplay');

                // monthSelectDropdown replaces prevMonthBtn, nextMonthBtn, currentMonthDisplay
                monthSelectDropdown = document.getElementById('monthSelectDropdown');
                dateFromDisplay = document.getElementById('dateFrom');
                dateToDisplay = document.getElementById('dateTo');

                summaryTotalHours = document.getElementById('summaryTotalHours');
                summaryLate = document.getElementById('summaryLate');
                summaryAbsent = document.getElementById('summaryAbsent');
                summaryWeekend = document.getElementById('summaryWeekend');
                summaryHoliday = document.getElementById('summaryHoliday'); // New Holiday summary element
                summaryWorkingDays = document.getElementById('summaryWorkingDays');
                summaryDayShifts = document.getElementById('summaryDayShifts');
                summaryNightShifts = document.getElementById('summaryNightShifts');
                summaryGrace = document.getElementById('summaryGrace');
                summaryTotalPresent = document.getElementById('summaryTotalPresent'); // New Total Present element

                attendanceTableBody = document.querySelector('#attendanceTable tbody');
                editDeleteModal = document.getElementById('editDeleteModal');
                editDeleteModalCloseBtn = editDeleteModal.querySelector('.close-button');
                editDateInput = document.getElementById('editDate');
                editStatusInput = document.getElementById('editStatus');
                editHourInput = document.getElementById('editHour');
                editExtraHourInput = document.getElementById('editExtraHour');
                editLateHourInput = document.getElementById('editLateHour');
                editShiftTypeInput = document.getElementById('editShiftType');
                editGraceInput = document.getElementById('editGrace');
                editGraceLimitMessage = document.getElementById('editGraceLimitMessage');
                updateEntryBtn = document.getElementById('updateEntryBtn');
                deleteEntryBtn = document.getElementById('deleteEntryBtn');

                editHourGroup = document.getElementById('editHourGroup');
                editExtraHourGroup = document.getElementById('editExtraHourGroup');
                editLateHourGroup = document.getElementById('editLateHourGroup');
                editShiftTypeGroup = document.getElementById('editShiftTypeGroup');
                editGraceGroup = document.getElementById('editGraceGroup');
                editApprovalGroup = document.getElementById('editApprovalGroup'); // New
                editApprovalInput = document.getElementById('editApproval'); // New

                currentYearSpan = document.getElementById('currentYear');

                statusSelectionModal = document.getElementById('statusSelectionModal');
                closeStatusSelectionModal = statusSelectionModal.querySelector('.close-button');
                selectPresentBtn = document.getElementById('selectPresent');
                selectWeekendBtn = document.getElementById('selectWeekend');
                selectAbsentBtn = document.getElementById('selectAbsent');
                selectHolidayBtn = document.getElementById('selectHoliday'); // New Holiday button element
                selectGovernmentHolidayBtn = document.getElementById('selectGovernmentHoliday'); // New
                selectSickLeaveBtn = document.getElementById('selectSickLeave'); // New

                presentEntryModal = document.getElementById('presentEntryModal');
                closePresentEntryModal = presentEntryModal.querySelector('.close-button');
                presentEntryDateInput = document.getElementById('presentEntryDate');
                presentEntryStatusInput = document.getElementById('presentEntryStatus'); // New
                presentHourInput = document.getElementById('presentHour');
                presentExtraHourInput = document.getElementById('presentExtraHour');
                presentLateInput = document.getElementById('presentLate');
                presentShiftTypeInput = document.getElementById('presentShiftType');
                presentGraceInput = document.getElementById('presentGrace');
                presentApprovalInput = document.getElementById('presentApproval'); // New
                savePresentEntryBtn = document.getElementById('savePresentEntryBtn');
                cancelPresentEntryBtn = document.getElementById('cancelPresentEntryBtn');
                graceLimitMessage = document.getElementById('graceLimitMessage');

                presentHourGroup = document.getElementById('presentHourGroup');
                presentExtraHourGroup = document.getElementById('presentExtraHourGroup');
                presentLateGroup = document.getElementById('presentLateGroup');
                presentShiftTypeGroup = document.getElementById('presentShiftTypeGroup');
                presentGraceGroup = document.getElementById('presentGraceGroup');
                presentApprovalGroup = document.getElementById('presentApprovalGroup');


                homeNavLink = document.getElementById('homeNavLink');
                historyNavLink = document.getElementById('historyNavLink');
                helpNavLinkRef = document.getElementById('helpNavLink'); 
                dashboardSection = document.getElementById('dashboardSection');
                monthlySummarySection = document.getElementById('monthlySummarySection');
                dailyEntriesSection = document.getElementById('dailyEntriesSection');
                historySection = document.getElementById('historySection');

                historyDateFromInput = document.getElementById('historyDateFrom');
                historyDateToInput = document.getElementById('historyDateTo');
                findHistoryResultBtn = document.getElementById('findHistoryResultBtn');
                historySummaryTotalHours = document.getElementById('historySummaryTotalHours');
                historySummaryLate = document.getElementById('historySummaryLate');
                historySummaryAbsent = document.getElementById('historySummaryAbsent');
                historySummaryWeekend = document.getElementById('historySummaryWeekend');
                historySummaryHoliday = document.getElementById('historySummaryHoliday'); // New Holiday summary element for history
                historySummaryWorkingDays = document.getElementById('historySummaryWorkingDays');
                historySummaryDayShifts = document.getElementById('historySummaryDayShifts');
                historySummaryNightShifts = document.getElementById('historySummaryNightShifts');
                historySummaryGrace = document.getElementById('historySummaryGrace');
                historySummaryTotalPresent = document.getElementById('historySummaryTotalPresent'); // New Total Present for history
                historyAttendanceTableBody = document.querySelector('#historyAttendanceTable tbody');
            }


            // --- Theme Management ---
            function applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                if (themeToggle) { // Ensure themeToggle is available
                    // Update icon based on the current theme
                    if (theme === 'light') {
                        themeToggle.className = 'fas fa-sun';
                    } else if (theme === 'dark') {
                        themeToggle.className = 'fas fa-moon';
                    } else if (theme === 'neptune-vibe') {
                        themeToggle.className = 'fas fa-tint'; // Using a water drop icon for NeptuneVibe
                    }
                    currentThemeIndex = themeList.indexOf(theme);
                }
            }

            function toggleTheme() {
                currentThemeIndex = (currentThemeIndex + 1) % themeList.length;
                const newTheme = themeList[currentThemeIndex];
                applyTheme(newTheme);
            }

            // --- Custom Alert/Confirm Modal Functions ---
            function showCustomAlert(title, message, type = 'info') {
                if (customAlertModal) { // Ensure modal exists
                    customAlertTitle.textContent = title;
                    customAlertMessage.textContent = message;
                    customAlertModal.querySelector('.modal-content').className = 'modal-content ' + type;
                    customAlertModal.style.display = 'flex';
                }
            }

            function closeCustomAlertModalFunc() {
                if (customAlertModal) { // Ensure modal exists
                    customAlertModal.style.display = 'none';
                }
            }

            function showCustomConfirm(title, message, onConfirm) {
                if (customConfirmModal) { // Ensure modal exists
                    customConfirmTitle.textContent = title;
                    customConfirmMessage.textContent = message;
                    customConfirmModal.querySelector('.modal-content').className = 'modal-content info';
                    confirmCallback = onConfirm;
                    customConfirmModal.style.display = 'flex';
                }
            }

            function closeCustomConfirmModalFunc() {
                if (customConfirmModal) { // Ensure modal exists
                    customConfirmModal.style.display = 'none';
                    confirmCallback = null;
                }
            }

            function setupMainApp() {
                if (currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();
                
                window.addEventListener('scroll', () => {
                    if (mainNavbar) {
                        if (window.scrollY > 50) {
                            mainNavbar.classList.add('scrolled');
                        } else {
                            mainNavbar.classList.remove('scrolled');
                        }
                    }
                });

                if (usernameDisplay && usernameDisplay.parentElement) {
                    usernameDisplay.parentElement.addEventListener('click', () => {
                        usernameDisplay.parentElement.classList.toggle('active');
                    });
                }

                if (personalProfileBtn) {
                    personalProfileBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        openProfileModal();
                        if (usernameDisplay && usernameDisplay.parentElement) {
                            usernameDisplay.parentElement.classList.remove('active');
                        }
                    });
                }

                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        logout();
                    });
                }

                if (profileModalCloseBtn) profileModalCloseBtn.addEventListener('click', closeProfileModal);
                if (profileModal) {
                    profileModal.addEventListener('click', (event) => {
                        if (event.target == profileModal) {
                            closeProfileModal();
                        }
                    });
                }

                if (profilePictureInput) profilePictureInput.addEventListener('change', handleProfilePictureChange);
                if (saveProfileBtn) saveProfileBtn.addEventListener('click', saveProfileChanges);

                // Removed event listeners for prevMonthBtn and nextMonthBtn
                if (monthSelectDropdown) {
                    monthSelectDropdown.addEventListener('change', (e) => {
                        const [year, month] = e.target.value.split('-').map(Number);
                        currentMonthView = new Date(year, month - 1, 1); // Set to the first day of the selected month
                        setupMonthView(currentMonthView);
                    });
                }
                
                if (closeStatusSelectionModal) closeStatusSelectionModal.addEventListener('click', closeStatusSelectionModalFunc);
                if (statusSelectionModal) {
                    statusSelectionModal.addEventListener('click', (event) => {
                        if (event.target == statusSelectionModal) {
                            closeStatusSelectionModalFunc();
                        }
                    });
                }
                if (selectPresentBtn) selectPresentBtn.addEventListener('click', () => openPresentEntryModal('Present'));
                if (selectWeekendBtn) selectWeekendBtn.addEventListener('click', () => setAttendanceStatus('Weekend'));
                if (selectAbsentBtn) selectAbsentBtn.addEventListener('click', () => setAttendanceStatus('Absent'));
                if (selectHolidayBtn) selectHolidayBtn.addEventListener('click', () => setAttendanceStatus('Holiday')); // Event listener for new Holiday button
                if (selectGovernmentHolidayBtn) selectGovernmentHolidayBtn.addEventListener('click', () => openPresentEntryModal('Government_Holiday')); // New
                if (selectSickLeaveBtn) selectSickLeaveBtn.addEventListener('click', () => openPresentEntryModal('Sick_Leave')); // New

                if (closePresentEntryModal) closePresentEntryModal.addEventListener('click', closePresentEntryModalFunc);
                if (presentEntryModal) {
                    presentEntryModal.addEventListener('click', (event) => {
                        if (event.target == presentEntryModal) {
                            closePresentEntryModalFunc();
                        }
                        if (event.target.closest('.modal-content')) {
                            event.stopPropagation();
                        }
                    });
                }
                if (presentHourInput && presentExtraHourInput && presentLateInput) {
                    const updateLate = () => {
                        presentLateInput.value = calculateLateTime(parseFloat(presentHourInput.value || 0));
                    };
                    presentHourInput.addEventListener('input', updateLate);
                }
                if (presentGraceInput) {
                    presentGraceInput.addEventListener('change', () => {
                        if (presentGraceInput.value === 'Yes') {
                            const currentMonthKey = `${currentMonthView.getFullYear()}-${String(currentMonthView.getMonth() + 1).padStart(2, '0')}`;
                            const graceUsed = currentLoggedInUser.graceCounts[currentMonthKey] || 0;
                            if (graceUsed >= 5) {
                                if (graceLimitMessage) graceLimitMessage.style.display = 'block';
                                presentGraceInput.value = '-';
                            } else {
                                if (graceLimitMessage) graceLimitMessage.style.display = 'none';
                            }
                        } else {
                            if (graceLimitMessage) graceLimitMessage.style.display = 'none';
                        }
                    });
                }
                if (savePresentEntryBtn) savePresentEntryBtn.addEventListener('click', savePresentEntry);
                if (cancelPresentEntryBtn) cancelPresentEntryBtn.addEventListener('click', closePresentEntryModalFunc);


                if (closeEditDeleteModal) closeEditDeleteModal.addEventListener('click', closeEditDeleteModalFunc);
                if (editDeleteModal) {
                    editDeleteModal.addEventListener('click', (event) => {
                        if (event.target == editDeleteModal) {
                            closeEditDeleteModalFunc();
                        }
                        if (event.target.closest('.modal-content')) {
                            event.stopPropagation();
                        }
                    });
                }
                if (editHourInput && editExtraHourInput && editLateHourInput) {
                    const updateEditLate = () => {
                        editLateHourInput.value = calculateLateTime(parseFloat(editHourInput.value || 0));
                    };
                    editHourInput.addEventListener('input', updateEditLate);
                }
                if (editStatusInput) {
                    editStatusInput.addEventListener('change', toggleEditPresentDetails);
                }
                if (editGraceInput) {
                    editGraceInput.addEventListener('change', () => {
                        if (editGraceInput.value === 'Yes') {
                            const currentMonthKey = `${new Date(editDateInput.value).getFullYear()}-${String(new Date(editDateInput.value).getMonth() + 1).padStart(2, '0')}`; // Use date from editDateInput
                            const graceUsed = currentLoggedInUser.graceCounts[currentMonthKey] || 0;
                            const originalEntry = currentLoggedInUser.attendance[editDateInput.value]; // Use editDateInput.value for the current editing date
                            const wasGrace = originalEntry && originalEntry.status === 'Present' && originalEntry.grace === 'Yes';

                            if (graceUsed >= 5 && !wasGrace) {
                                if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'block';
                                editGraceInput.value = '-';
                            } else {
                                if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';
                            }
                        } else {
                            if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';
                        }
                    });
                }
                if (updateEntryBtn) updateEntryBtn.addEventListener('click', updateAttendanceEntry);
                if (deleteEntryBtn) deleteEntryBtn.addEventListener('click', confirmDeleteEntry);

                if (homeNavLink) homeNavLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection('dashboard');
                });
                if (historyNavLink) historyNavLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection('history');
                });
                if (helpNavLinkRef) {
                    helpNavLinkRef.addEventListener('click', (e) => {
                        e.preventDefault();
                        openHelpModal();
                    });
                }

                if (findHistoryResultBtn) findHistoryResultBtn.addEventListener('click', displayCustomHistorySummary);

                if (customAlertOkBtn) customAlertOkBtn.addEventListener('click', closeCustomAlertModalFunc);
                if (closeCustomAlertModal) closeCustomAlertModal.addEventListener('click', closeCustomAlertModalFunc);
                if (customAlertModal) {
                    customAlertModal.addEventListener('click', (event) => {
                        if (event.target == customAlertModal) {
                            closeCustomAlertModalFunc();
                        }
                    });
                }

                if (customConfirmYesBtn) customConfirmYesBtn.addEventListener('click', () => {
                    if (confirmCallback) {
                        confirmCallback(true);
                    }
                    closeCustomConfirmModalFunc();
                });
                if (customConfirmNoBtn) customConfirmNoBtn.addEventListener('click', () => {
                    if (confirmCallback) {
                        confirmCallback(false);
                    }
                    closeCustomConfirmModalFunc();
                });
                if (closeCustomConfirmModal) closeCustomConfirmModal.addEventListener('click', closeCustomConfirmModalFunc);
                if (customConfirmModal) {
                    customConfirmModal.addEventListener('click', (event) => {
                        if (event.target == customConfirmModal) {
                            closeCustomConfirmModalFunc();
                        }
                    });
                }

                if (themeToggle) {
                    themeToggle.addEventListener('click', toggleTheme);
                }

                if (closeHelpModal) closeHelpModal.addEventListener('click', closeHelpModalFunc);
                if (helpModal) {
                    helpModal.addEventListener('click', (event) => {
                        if (event.target == helpModal) {
                            closeHelpModalFunc();
                        }
                    });
                }

                // Initialize Chart.js
                const ctx = document.getElementById('monthlyAttendanceChart').getContext('2d');
                monthlyChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Present (incl. Excused)', 'Absent', 'Late (Equivalent Days)'],
                        datasets: [{
                            data: [0, 0, 0], // Initial data
                            backgroundColor: [
                                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-present'),
                                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-absent'),
                                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-late')
                            ],
                            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-secondary'),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%', // Makes it a doughnut chart
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                    font: {
                                        family: 'Montserrat',
                                        size: 10 // Smaller font size for legend
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed + ' Days'; // Display as days
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                // Update chart colors on theme change
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'data-theme') {
                            if (monthlyChart) {
                                monthlyChart.data.datasets[0].backgroundColor = [
                                    getComputedStyle(document.documentElement).getPropertyValue('--chart-color-present'),
                                    getComputedStyle(document.documentElement).getPropertyValue('--chart-color-absent'),
                                    getComputedStyle(document.documentElement).getPropertyValue('--chart-color-late')
                                ];
                                monthlyChart.options.plugins.legend.labels.color = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
                                monthlyChart.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-secondary');
                                monthlyChart.update();
                            }
                        }
                    });
                });
                observer.observe(document.documentElement, { attributes: true });
            }

            // --- Section Visibility Control ---
            function showSection(sectionName) {
                if (dashboardSection) dashboardSection.style.display = 'none';
                if (monthlySummarySection) monthlySummarySection.style.display = 'none';
                if (dailyEntriesSection) dailyEntriesSection.style.display = 'none';
                if (historySection) historySection.style.display = 'none';

                if (sectionName === 'dashboard') {
                    if (dashboardSection) dashboardSection.style.display = 'flex';
                    if (monthlySummarySection) monthlySummarySection.style.display = 'block';
                    if (dailyEntriesSection) dailyEntriesSection.style.display = 'block';
                    setupMonthView(currentMonthView);
                } else if (sectionName === 'history') {
                    if (historySection) historySection.style.display = 'block';
                    // Reset summary values for history section
                    if (historySummaryTotalHours) historySummaryTotalHours.textContent = '0';
                    if (historySummaryLate) historySummaryLate.textContent = '00:00';
                    if (historySummaryAbsent) historySummaryAbsent.textContent = '0';
                    if (historySummaryWeekend) historySummaryWeekend.textContent = '0';
                    if (historySummaryHoliday) historySummaryHoliday.textContent = '0';
                    if (historySummaryWorkingDays) historySummaryWorkingDays.textContent = '0';
                    if (historySummaryDayShifts) historySummaryDayShifts.textContent = '0';
                    if (historySummaryNightShifts) historySummaryNightShifts.textContent = '0';
                    if (historySummaryGrace) historySummaryGrace.textContent = '0';
                    if (historySummaryTotalPresent) historySummaryTotalPresent.textContent = '0';
                    if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';
                }
            }


            // --- Functions (Shared & Main App) ---

            function calculateWorkedFor(joiningDateStr) {
                if (!joiningDateStr) return "N/A";

                const joiningDate = new Date(joiningDateStr);
                const today = new Date();

                let years = today.getFullYear() - joiningDate.getFullYear();
                let months = today.getMonth() - joiningDate.getMonth();
                let days = today.getDate() - joiningDate.getDate();

                if (days < 0) {
                    months--;
                    days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
                }

                if (months < 0) {
                    years--;
                    months += 12;
                }
                return `${years} years ${months} months`;
            }

            function updateUserProfileDisplay() {
                if (!currentLoggedInUser) return;

                const displayName = currentLoggedInUser.profileName || currentLoggedInUser.username || currentLoggedInUser.email.split('@')[0] || 'User';
                const displayPhoto = currentLoggedInUser.photo || `https://placehold.co/40x40/000000/ffffff?text=${displayName.charAt(0).toUpperCase()}`;

                if (usernameDisplay) usernameDisplay.textContent = displayName;
                if (userPhotoDisplay) userPhotoDisplay.src = displayPhoto;
                
                if (dashboardUserPhoto) dashboardUserPhoto.src = currentLoggedInUser.photo || `https://placehold.co/150x150/000000/ffffff?text=${displayName.charAt(0).toUpperCase()}`;
                if (dashboardUsername) dashboardUsername.textContent = displayName;
                if (workedForDisplay) workedForDisplay.textContent = calculateWorkedFor(currentLoggedInUser.joiningDate);
                if (lngIdDisplay) lngIdDisplay.textContent = currentLoggedInUser.lngId || 'N/A';

                if (emailInput) emailInput.value = currentLoggedInUser.email || '';
                if (profileNameInput) profileNameInput.value = currentLoggedInUser.profileName || '';
                if (usernameInput) usernameInput.value = currentLoggedInUser.username || '';
                if (profileJoiningDateInput) profileJoiningDateInput.value = currentLoggedInUser.joiningDate || '';
                if (profileLngIdInput) profileLngIdInput.value = currentLoggedInUser.lngId || '';
                if (profilePicturePreview) profilePicturePreview.src = currentLoggedInUser.photo || `https://placehold.co/100x100/000000/ffffff?text=${displayName.charAt(0).toUpperCase()}`;
            }

            function openProfileModal() {
                if (profileModal) profileModal.style.display = 'flex';
                updateUserProfileDisplay(); // Ensure latest data is loaded into modal
            }

            function closeProfileModal() {
                if (profileModal) profileModal.style.display = 'none';
            }

            function saveProfileChanges() {
                if (!currentLoggedInUser) return;

                const updatedProfile = {
                    profileName: profileNameInput.value.trim(),
                    username: usernameInput.value.trim(),
                    joiningDate: profileJoiningDateInput.value,
                    lngId: profileLngIdInput.value.trim(),
                    photo: profilePicturePreview.src // Use the preview src
                };

                // Update current logged-in user object
                currentLoggedInUser = { ...currentLoggedInUser, ...updatedProfile };
                saveCurrentUserData(); // Save to localStorage (updates the specific user in registeredUsers)

                updateUserProfileDisplay();
                showCustomAlert('Profile Update', 'Profile updated successfully!', 'success');
                closeProfileModal();
            }

            function handleProfilePictureChange(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (profilePicturePreview) profilePicturePreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }

            function logout() {
                localStorage.removeItem('lastLoggedInUserEmail'); // Clear logged in user session
                currentLoggedInUser = null; // Clear current user data
                showAuthSection(); // Go back to login page
                showCustomAlert('Logged Out', 'You have been successfully logged out.', 'info');
            }

            function getMonthRange(date) {
                const year = date.getFullYear();
                const month = date.getMonth(); // 0-indexed

                // Start date is 26th of previous month
                const startDate = new Date(year, month - 1, 26);
                // End date is 25th of current month
                const endDate = new Date(year, month, 25);

                return { start: startDate, end: endDate };
            }

            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function formatDisplayDate(date) {
                return new Date(date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            function getDayOfWeek(date) {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return days[new Date(date).getDay()];
            }

            function populateMonthDropdown() {
                if (!monthSelectDropdown) return;

                monthSelectDropdown.innerHTML = ''; // Clear existing options
                const today = new Date();
                const currentMonth = today.getMonth(); // 0-indexed
                const currentYear = today.getFullYear();

                // Add previous 6 months and next 6 months
                for (let i = -6; i <= 6; i++) {
                    const date = new Date(currentYear, currentMonth + i, 1);
                    const optionValue = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const optionText = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionText;

                    // Select the current month in the dropdown
                    if (date.getFullYear() === currentMonthView.getFullYear() && date.getMonth() === currentMonthView.getMonth()) {
                        option.selected = true;
                    }
                    monthSelectDropdown.appendChild(option);
                }
            }

            function setupMonthView(date) {
                const { start, end } = getMonthRange(date);
                // currentMonthDisplay is removed, so we don't update it
                if (dateFromDisplay) dateFromDisplay.textContent = formatDisplayDate(start);
                if (dateToDisplay) dateToDisplay.textContent = formatDisplayDate(end);
                displayAttendanceHistory();
            }

            function calculateLateTime(hour) {
                const standardHour = 9;
                if (hour < standardHour) {
                    const diffMinutes = (standardHour - hour) * 60;
                    const hours = Math.floor(diffMinutes / 60);
                    const minutes = Math.round(diffMinutes % 60);
                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                }
                return "00:00";
            }

            function getGraceCount(monthKey) {
                if (!currentLoggedInUser || !currentLoggedInUser.graceCounts) return 0;
                return currentLoggedInUser.graceCounts[monthKey] || 0;
            }

            function updateGraceCount(monthKey, increment) {
                let newGraceCounts = { ...(currentLoggedInUser.graceCounts || {}) };
                newGraceCounts[monthKey] = (newGraceCounts[monthKey] || 0) + increment;
                currentLoggedInUser.graceCounts = newGraceCounts; // Update current user's grace counts
                saveCurrentUserData(); // Save the updated current user data
            }

            function checkGraceLimit(monthKey) {
                return getGraceCount(monthKey) >= 5;
            }

            function openStatusSelectionModal(dateKey) {
                currentSelectedDateForStatus = dateKey;
                if (statusSelectionModal) statusSelectionModal.style.display = 'flex';
            }

            function closeStatusSelectionModalFunc() {
                if (statusSelectionModal) statusSelectionModal.style.display = 'none';
                currentSelectedDateForStatus = null;
            }

            function openPresentEntryModal(status) {
                closeStatusSelectionModalFunc();
                if (presentEntryModal) {
                    presentEntryDateInput.value = currentSelectedDateForStatus;
                    presentEntryStatusInput.value = status.replace(/_/g, ' '); // Display selected status

                    const existingEntry = currentLoggedInUser.attendance[currentSelectedDateForStatus];

                    // Default values for new entry or non-present entry
                    let defaultHour = 9;
                    let defaultExtraHour = 0;
                    let defaultLate = '00:00';
                    let defaultShift = 'Day';
                    let defaultGrace = '-';
                    let defaultApproval = '-';

                    if (status === 'Sick_Leave' || status === 'Government_Holiday') {
                        // For sick leave and government holiday, auto-select 9 hours present
                        defaultHour = 9;
                        defaultExtraHour = 0;
                        defaultLate = calculateLateTime(defaultHour);
                        defaultApproval = 'Approved';
                    }

                    // If existing entry is present, use its values
                    if (existingEntry && existingEntry.status === status) { // Only pre-fill if existing entry matches the chosen status
                        defaultHour = existingEntry.hour;
                        defaultExtraHour = existingEntry.extraHour;
                        defaultLate = existingEntry.late;
                        defaultShift = existingEntry.shift;
                        defaultGrace = existingEntry.grace || '-';
                        defaultApproval = existingEntry.approval || '-';
                    }

                    presentHourInput.value = defaultHour;
                    presentExtraHourInput.value = defaultExtraHour;
                    presentLateInput.value = defaultLate;
                    presentShiftTypeInput.value = defaultShift;
                    presentGraceInput.value = defaultGrace;
                    presentApprovalInput.value = defaultApproval;


                    const monthKey = `${new Date(currentSelectedDateForStatus).getFullYear()}-${String(new Date(currentSelectedDateForStatus).getMonth() + 1).padStart(2, '0')}`;
                    const graceLimitReached = checkGraceLimit(monthKey);
                    
                    if (presentGraceInput.querySelector('option[value="Yes"]')) {
                        const originalEntry = currentLoggedInUser.attendance[currentSelectedDateForStatus];
                        const wasGrace = originalEntry && originalEntry.status === 'Present' && originalEntry.grace === 'Yes';
                        if (graceLimitReached && !wasGrace) {
                            presentGraceInput.querySelector('option[value="Yes"]').disabled = true;
                            if (graceLimitMessage) graceLimitMessage.style.display = 'block';
                        } else {
                            presentGraceInput.querySelector('option[value="Yes"]').disabled = false;
                            if (graceLimitMessage) graceLimitMessage.style.display = 'none';
                        }
                    }

                    // Toggle visibility of present-specific fields based on status
                    const isPresentLike = (status === 'Present' || status === 'Government_Holiday' || status === 'Sick_Leave');
                    presentHourGroup.style.display = isPresentLike ? 'block' : 'none';
                    presentExtraHourGroup.style.display = isPresentLike ? 'block' : 'none';
                    presentLateGroup.style.display = isPresentLike ? 'block' : 'none';
                    presentShiftTypeGroup.style.display = isPresentLike ? 'block' : 'none';
                    presentGraceGroup.style.display = (status === 'Present') ? 'block' : 'none'; // Grace only for 'Present'
                    presentApprovalGroup.style.display = (status === 'Sick_Leave' || status === 'Holiday' || status === 'Government_Holiday' || (isPresentLike && (parseFloat(presentExtraHourInput.value || 0) > 0))) ? 'block' : 'none';

                    presentEntryModal.style.display = 'flex';
                    presentLateInput.value = calculateLateTime(parseFloat(presentHourInput.value || 0));
                }
            }

            function closePresentEntryModalFunc() {
                if (presentEntryModal) presentEntryModal.style.display = 'none';
                currentSelectedDateForStatus = null;
            }

            function savePresentEntry() {
                const date = presentEntryDateInput.value;
                const status = presentEntryStatusInput.value.replace(/ /g, '_'); // Get status from the display input
                
                let hour = parseFloat(presentHourInput.value || 0);
                let extraHour = parseFloat(presentExtraHourInput.value || 0); // Auto-select 0 if empty
                const shift = presentShiftTypeInput.value;
                const grace = presentGraceInput.value;
                const approval = presentApprovalInput.value;

                if (status === 'Sick_Leave' || status === 'Government_Holiday') {
                    hour = 9;
                    extraHour = 0;
                }

                if (isNaN(hour) || hour < 0 || hour > 24) {
                    showCustomAlert('Input Error', "Please enter a valid hour (0-24).", 'error');
                    return;
                }
                if (isNaN(extraHour) || extraHour < 0 || extraHour > 24) {
                    showCustomAlert('Input Error', "Please enter a valid extra hour (0-24).", 'error');
                    return;
                }
                const late = calculateLateTime(hour);

                const monthKey = `${new Date(date).getFullYear()}-${String(new Date(date).getMonth() + 1).padStart(2, '0')}`;
                const existingEntry = currentLoggedInUser.attendance[date];
                const wasGrace = existingEntry && existingEntry.status === 'Present' && existingEntry.grace === 'Yes';
                const isGraceNow = grace === 'Yes';

                if (status === 'Present' && isGraceNow && !wasGrace && checkGraceLimit(monthKey)) {
                    showCustomAlert('Grace Limit Reached', "Cannot apply grace. Monthly limit (5) reached.", 'warning');
                    return;
                }

                const newEntry = {
                    status: status,
                    hour: hour,
                    extraHour: extraHour,
                    late: late,
                    shift: shift,
                    grace: grace,
                    approval: approval
                };

                // Update grace count if grace status changes AND it's a 'Present' entry
                if (status === 'Present') {
                    if (isGraceNow && !wasGrace) {
                        updateGraceCount(monthKey, 1);
                    } else if (!isGraceNow && wasGrace) {
                        updateGraceCount(monthKey, -1);
                    }
                } else if (wasPresent && wasGrace) { // If changing from Present (with grace) to another status
                    updateGraceCount(monthKey, -1);
                }

                currentLoggedInUser.attendance = { ...currentLoggedInUser.attendance, [date]: newEntry };
                saveCurrentUserData(); // Save the updated current user data

                closePresentEntryModalFunc();
                displayAttendanceHistory();
            }

            function setAttendanceStatus(status) { // For Weekend, Absent, Holiday
                const date = currentSelectedDateForStatus;
                const monthKey = `${new Date(date).getFullYear()}-${String(new Date(date).getMonth() + 1).padStart(2, '0')}`;
                const existingEntry = currentLoggedInUser.attendance[date];
                const wasPresent = existingEntry && existingEntry.status === 'Present';
                const wasGrace = wasPresent && existingEntry.grace === 'Yes';

                const newEntry = { status: status, approval: '-' }; // Default approval for these statuses

                if (wasPresent && wasGrace) {
                    updateGraceCount(monthKey, -1);
                }
                
                currentLoggedInUser.attendance = { ...currentLoggedInUser.attendance, [date]: newEntry };
                saveCurrentUserData(); // Save the updated current user data

                closeStatusSelectionModalFunc();
                displayAttendanceHistory();
            }

            function displayAttendanceHistory() {
                if (!attendanceTableBody || !currentLoggedInUser) return;

                attendanceTableBody.innerHTML = '';
                const { start, end } = getMonthRange(currentMonthView);

                const currentUserAttendance = currentLoggedInUser.attendance || {};

                let totalHours = 0;
                let totalLateMinutes = 0;
                let totalAbsentDays = 0;
                let totalWeekendDays = 0;
                let totalHolidayDays = 0;
                let totalGovernmentHolidayDays = 0; // New
                let totalSickLeaveDays = 0; // New
                let totalWorkingDays = 0;
                let totalDayShifts = 0;
                let totalNightShifts = 0;
                let totalGraceDays = 0;
                let totalPresentLikeDaysForChart = 0; // New variable for chart's 'Present (incl. Excused)' slice
                let totalPresentCount = 0; // To count days marked as Present (or equivalent) for summary text

                let currentDate = new Date(start);
                while (currentDate <= end) {
                    const dateKey = formatDate(currentDate);
                    const dayOfWeek = getDayOfWeek(currentDate);
                    const entry = currentUserAttendance[dateKey];

                    const row = attendanceTableBody.insertRow();
                    row.classList.add(`status-${(entry?.status || 'unmarked').toLowerCase()}-row`); // Add status background class

                    const cellDate = row.insertCell();
                    const cellDay = row.insertCell();
                    const cellStatus = row.insertCell();
                    const cellHour = row.insertCell();
                    const cellExtraHour = row.insertCell();
                    const cellLate = row.insertCell();
                    const cellShift = row.insertCell();
                    const cellGrace = row.insertCell();
                    const cellApproval = row.insertCell(); // New cell for Approval
                    const cellActions = row.insertCell();

                    cellDate.textContent = formatDisplayDate(currentDate);
                    cellDay.textContent = dayOfWeek;
                    cellStatus.className = '';

                    if (entry && entry.status) {
                        cellStatus.textContent = entry.status.replace(/_/g, ' '); // Display with spaces
                        cellStatus.classList.add(`status-${entry.status.toLowerCase()}`);

                        if (entry.status === 'Present' || entry.status === 'Government_Holiday' || entry.status === 'Sick_Leave') {
                            cellHour.textContent = entry.hour;
                            cellExtraHour.textContent = entry.extraHour;
                            cellLate.textContent = entry.late;
                            cellShift.textContent = entry.shift;
                            cellGrace.textContent = entry.grace || '-';
                            cellApproval.textContent = entry.approval || '-';

                            totalHours += entry.hour + (entry.extraHour || 0);
                            const [lateHours, lateMinutes] = entry.late.split(':').map(Number);
                            totalLateMinutes += (lateHours * 60) + lateMinutes;

                            if (entry.shift === 'Day') totalDayShifts++;
                            else if (entry.shift === 'Night') totalNightShifts++;
                            totalWorkingDays++;
                            if (entry.grace === 'Yes') totalGraceDays++;

                            if (entry.status === 'Government_Holiday') totalGovernmentHolidayDays++;
                            else if (entry.status === 'Sick_Leave') totalSickLeaveDays++;
                            totalPresentCount++; // Count this as a present day for summary text
                            totalPresentLikeDaysForChart++; // Count for chart as well
                        } else {
                            cellHour.textContent = '-';
                            cellExtraHour.textContent = '-';
                            cellLate.textContent = '-';
                            cellShift.textContent = '-';
                            cellGrace.textContent = '-';
                            cellApproval.textContent = entry.approval || '-';
                            if (entry.status === 'Absent') {
                                totalAbsentDays++;
                                totalWorkingDays++;
                            } else if (entry.status === 'Weekend') {
                                totalWeekendDays++;
                                totalPresentLikeDaysForChart++; // Count weekends as "present-like" for chart
                            } else if (entry.status === 'Holiday') {
                                totalHolidayDays++;
                                totalPresentLikeDaysForChart++; // Count holidays as "present-like" for chart
                            }
                        }
                    } else {
                        // If no entry, assume it's a regular day that hasn't been marked.
                        cellStatus.textContent = '-';
                        cellHour.textContent = '-';
                        cellExtraHour.textContent = '-';
                        cellLate.textContent = '-';
                        cellShift.textContent = '-';
                        cellGrace.textContent = '-';
                        cellApproval.textContent = '-';
                    }

                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.classList.add('premium-button');
                    editBtn.dataset.date = dateKey;
                    editBtn.onclick = openEditModal;

                    cellActions.classList.add('table-actions');
                    cellActions.appendChild(editBtn);

                    currentDate.setDate(currentDate.getDate() + 1);
                }

                if (summaryTotalHours) summaryTotalHours.textContent = totalHours;
                const formattedLateTime = `${String(Math.floor(totalLateMinutes / 60)).padStart(2, '0')}:${String(totalLateMinutes % 60).padStart(2, '0')}`;
                if (summaryLate) summaryLate.textContent = formattedLateTime;
                if (summaryAbsent) summaryAbsent.textContent = totalAbsentDays;
                if (summaryWeekend) summaryWeekend.textContent = totalWeekendDays;
                if (summaryHoliday) summaryHoliday.textContent = totalHolidayDays + totalGovernmentHolidayDays + totalSickLeaveDays; // All holiday types
                if (summaryWorkingDays) summaryWorkingDays.textContent = totalWorkingDays;
                if (summaryDayShifts) summaryDayShifts.textContent = totalDayShifts;
                if (summaryNightShifts) summaryNightShifts.textContent = totalNightShifts;
                if (summaryGrace) summaryGrace.textContent = totalGraceDays;
                if (summaryTotalPresent) summaryTotalPresent.textContent = totalPresentCount + totalGovernmentHolidayDays + totalSickLeaveDays + totalWeekendDays + totalHolidayDays; // All present-like for text summary


                // Update the chart
                if (monthlyChart) {
                    // Update chart with the new 'Present (incl. Excused)' logic
                    monthlyChart.data.datasets[0].data = [
                        totalPresentLikeDaysForChart, // Total present-like days for the chart
                        totalAbsentDays,
                        Math.round(totalLateMinutes / (24 * 60)) // Convert late minutes to approximate days for chart
                    ];
                    monthlyChart.update();
                }
            }


            function openEditModal(event) {
                const dateToEdit = event.target.dataset.date;
                const entry = currentLoggedInUser.attendance[dateToEdit];

                if (editDateInput) editDateInput.value = dateToEdit;

                if (entry) {
                    if (editStatusInput) editStatusInput.value = entry.status;
                    if (entry.status === 'Present' || entry.status === 'Government_Holiday' || entry.status === 'Sick_Leave') {
                        if (editHourInput) editHourInput.value = entry.hour || 9; // Auto-select 9 if 0 or undefined
                        if (editExtraHourInput) editExtraHourInput.value = entry.extraHour;
                        if (editLateHourInput) editLateHourInput.value = entry.late;
                        if (editShiftTypeInput) editShiftTypeInput.value = entry.shift;
                        if (editGraceInput) editGraceInput.value = entry.grace || '-';
                        if (editApprovalInput) editApprovalInput.value = entry.approval || '-';
                    } else {
                        // For non-present statuses, clear present-specific fields
                        if (editHourInput) editHourInput.value = '';
                        if (editExtraHourInput) editExtraHourInput.value = '';
                        if (editLateHourInput) editLateHourInput.value = '00:00';
                        if (editShiftTypeInput) editShiftTypeInput.value = 'Day';
                        if (editGraceInput) editGraceInput.value = '-';
                        if (editApprovalInput) editApprovalInput.value = entry.approval || '-'; // Keep approval if exists
                    }
                } else {
                    // If no entry exists for this date, pre-fill with defaults for 'Absent'
                    if (editStatusInput) editStatusInput.value = 'Absent';
                    if (editHourInput) editHourInput.value = '';
                    if (editExtraHourInput) editExtraHourInput.value = '';
                    if (editLateHourInput) editLateHourInput.value = '00:00';
                    if (editShiftTypeInput) editShiftTypeInput.value = 'Day';
                    if (editGraceInput) editGraceInput.value = '-';
                    if (editApprovalInput) editApprovalInput.value = '-';
                }

                toggleEditPresentDetails(); // Call to adjust field visibility

                const monthKey = `${new Date(dateToEdit).getFullYear()}-${String(new Date(dateToEdit).getMonth() + 1).padStart(2, '0')}`;
                const graceLimitReached = checkGraceLimit(monthKey);
                const originalGraceStatus = entry && entry.status === 'Present' && entry.grace === 'Yes';

                if (editGraceInput) {
                    if (graceLimitReached && !originalGraceStatus) {
                        editGraceInput.querySelector('option[value="Yes"]').disabled = true;
                        if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'block';
                    } else {
                        editGraceInput.querySelector('option[value="Yes"]').disabled = false;
                        if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';
                    }
                }
                
                if (editDeleteModal) editDeleteModal.style.display = 'flex';
            }

            function closeEditDeleteModalFunc() {
                if (editDeleteModal) {
                    editDeleteModal.style.display = 'none';
                    // Clear fields after closing to prevent showing old data on next open
                    if (editDateInput) editDateInput.value = '';
                    if (editStatusInput) editStatusInput.value = 'Absent'; // Default to Absent
                    if (editHourInput) editHourInput.value = '';
                    if (editExtraHourInput) editExtraHourInput.value = '';
                    if (editLateHourInput) editLateHourInput.value = '00:00';
                    if (editShiftTypeInput) editShiftTypeInput.value = 'Day';
                    if (editGraceInput) editGraceInput.value = '-';
                    if (editApprovalInput) editApprovalInput.value = '-';
                    if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';
                    toggleEditPresentDetails(); // Reset visibility of fields
                }
            }

            function toggleEditPresentDetails() {
                const status = editStatusInput.value;
                const isPresentLike = (status === 'Present' || status === 'Government_Holiday' || status === 'Sick_Leave');
                // Ensure editExtraHourInput value is used for checking if approval is needed
                const currentExtraHourValue = parseFloat(editExtraHourInput ? editExtraHourInput.value : 0) || 0;
                const requiresApproval = (status === 'Sick_Leave' || status === 'Holiday' || status === 'Government_Holiday' || (isPresentLike && (currentExtraHourValue > 0)));

                if (editHourGroup) editHourGroup.style.display = isPresentLike ? 'block' : 'none';
                if (editExtraHourGroup) editExtraHourGroup.style.display = isPresentLike ? 'block' : 'none';
                if (editLateHourGroup) editLateHourGroup.style.display = isPresentLike ? 'block' : 'none';
                if (editShiftTypeGroup) editShiftTypeGroup.style.display = isPresentLike ? 'block' : 'none';
                if (editGraceGroup) editGraceGroup.style.display = (status === 'Present') ? 'block' : 'none'; // Grace only for Present
                if (editApprovalGroup) editApprovalGroup.style.display = requiresApproval ? 'block' : 'none';

                 // Auto-set 9 hours for Sick_Leave and Government_Holiday if not already set or cleared
                if ((status === 'Sick_Leave' || status === 'Government_Holiday') && editHourInput) {
                    if (!editHourInput.value || parseFloat(editHourInput.value) === 0) { // Only set if empty or 0
                        editHourInput.value = 9;
                    }
                    if (editExtraHourInput) editExtraHourInput.value = 0; // Ensure extra hour is 0
                    if (editLateHourInput) editLateHourInput.value = '00:00'; // Ensure late is 00:00
                }
                if (editApprovalInput) { // Auto-set approval for specific statuses
                    if (requiresApproval) {
                        if (editApprovalInput.value === '-') { // Only change if not already set by user
                            editApprovalInput.value = 'Approved';
                        }
                    } else {
                         editApprovalInput.value = '-';
                    }
                }
            }

            function updateAttendanceEntry() {
                const date = editDateInput.value;
                if (!date || !currentLoggedInUser) return;

                const status = editStatusInput.value;
                const monthKey = `${new Date(date).getFullYear()}-${String(new Date(date).getMonth() + 1).padStart(2, '0')}`;
                const existingEntry = currentLoggedInUser.attendance[date];
                const wasPresent = existingEntry && existingEntry.status === 'Present';
                const wasGrace = wasPresent && existingEntry.grace === 'Yes';

                let updatedEntry = { status: status, approval: editApprovalInput.value || '-' };

                if (status === 'Present' || status === 'Government_Holiday' || status === 'Sick_Leave') {
                    const updatedHour = parseFloat(editHourInput.value || 0); // Auto-select 0 if empty
                    const updatedExtraHour = parseFloat(editExtraHourInput.value || 0); // Auto-select 0 if empty
                    const updatedShift = editShiftTypeInput.value;
                    const updatedGrace = editGraceInput.value;
                    const updatedLate = calculateLateTime(updatedHour);

                    if (isNaN(updatedHour) || updatedHour < 0 || updatedHour > 24 ||
                        isNaN(updatedExtraHour) || updatedExtraHour < 0 || updatedExtraHour > 24) {
                        showCustomAlert('Input Error', "Please enter valid hour and extra hour values (0-24) for this status.", 'error');
                        return;
                    }

                    const isGraceNow = updatedGrace === 'Yes';
                    if (status === 'Present' && isGraceNow && !wasGrace && checkGraceLimit(monthKey)) {
                        showCustomAlert('Grace Limit Reached', "Cannot apply grace. Monthly limit (5) reached.", 'warning');
                        return;
                    }

                    updatedEntry = {
                        status: status,
                        hour: updatedHour,
                        extraHour: updatedExtraHour,
                        late: updatedLate,
                        shift: updatedShift,
                        grace: updatedGrace,
                        approval: editApprovalInput.value || '-'
                    };

                    // Update grace count only for 'Present' status
                    if (status === 'Present') {
                        if (isGraceNow && !wasGrace) {
                            updateGraceCount(monthKey, 1);
                        } else if (!isGraceNow && wasGrace) {
                            updateGraceCount(monthKey, -1);
                        }
                    } else if (wasPresent && wasGrace) { // If changing from Present (with grace) to another present-like status
                        updateGraceCount(monthKey, -1);
                    }
                } else {
                    if (wasPresent && wasGrace) {
                        updateGraceCount(monthKey, -1);
                    }
                }

                currentLoggedInUser.attendance = { ...currentLoggedInUser.attendance, [date]: updatedEntry };
                saveCurrentUserData(); // Save the updated current user data

                closeEditDeleteModalFunc();
                displayAttendanceHistory();
            }

            function confirmDeleteEntry() {
                const dateToDelete = editDateInput.value;
                showCustomConfirm('Confirm Deletion', `Are you sure you want to delete ALL data for ${formatDisplayDate(new Date(dateToDelete))}?`, (confirmed) => {
                    if (confirmed) {
                        deleteAttendanceEntry(dateToDelete);
                    }
                });
            }

            function deleteAttendanceEntry(dateToDelete) {
                if (!currentLoggedInUser || !currentLoggedInUser.attendance[dateToDelete]) return;

                const existingEntry = currentLoggedInUser.attendance[dateToDelete];
                const wasPresent = existingEntry && existingEntry.status === 'Present';
                const wasGrace = wasPresent && existingEntry.grace === 'Yes';
                const monthKey = `${new Date(dateToDelete).getFullYear()}-${String(new Date(dateToDelete).getMonth() + 1).padStart(2, '0')}`;

                const updatedAttendance = { ...currentLoggedInUser.attendance };
                delete updatedAttendance[dateToDelete];
                currentLoggedInUser.attendance = updatedAttendance; // Update current user's attendance
                saveCurrentUserData(); // Save the updated current user data

                if (wasPresent && wasGrace) {
                    updateGraceCount(monthKey, -1);
                }

                showCustomAlert('Entry Deleted', 'Entry deleted successfully! Data for this date has been cleared.', 'success');
                closeEditDeleteModalFunc();
                displayAttendanceHistory(); // Refresh the table after deletion
            }

            // --- History Page Functions ---
            function displayCustomHistorySummary() {
                const startDateStr = historyDateFromInput.value;
                const endDateStr = historyDateToInput.value;

                if (!startDateStr || !endDateStr) {
                    showCustomAlert('Input Error', "Please select both 'From Date' and 'To Date'.", 'warning');
                    if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';
                    return;
                }

                const startDate = new Date(startDateStr + 'T00:00:00');
                const endDate = new Date(endDateStr + 'T00:00:00');

                if (startDate > endDate) {
                    showCustomAlert('Input Error', "'From Date' cannot be after 'To Date'.", 'error');
                    if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';
                    return;
                }

                const currentUserAttendance = currentLoggedInUser.attendance || {};

                let totalHours = 0;
                let totalLateMinutes = 0;
                let totalAbsentDays = 0;
                let totalWeekendDays = 0;
                let totalHolidayDays = 0;
                let totalGovernmentHolidayDays = 0; // New
                let totalSickLeaveDays = 0; // New
                let totalWorkingDays = 0;
                let totalDayShifts = 0;
                let totalNightShifts = 0;
                let totalGraceDays = 0;
                let totalPresentCount = 0; // for summary text

                if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';

                let currentDate = new Date(startDate);
                while (currentDate.getTime() <= endDate.getTime()) { 
                    const dateKey = formatDate(currentDate);
                    const dayOfWeek = getDayOfWeek(currentDate);
                    const entry = currentUserAttendance[dateKey];

                    const row = historyAttendanceTableBody.insertRow();
                    row.classList.add(`status-${(entry?.status || 'unmarked').toLowerCase()}-row`); // Add status background class

                    const cellDate = row.insertCell();
                    const cellDay = row.insertCell();
                    const cellStatus = row.insertCell();
                    const cellHour = row.insertCell();
                    const cellExtraHour = row.insertCell();
                    const cellLate = row.insertCell();
                    const cellShift = row.insertCell();
                    const cellGrace = row.insertCell();
                    const cellApproval = row.insertCell(); // New cell for Approval

                    cellDate.textContent = formatDisplayDate(currentDate);
                    cellDay.textContent = dayOfWeek;
                    cellStatus.className = '';

                    if (entry && entry.status) {
                        cellStatus.textContent = entry.status.replace(/_/g, ' '); // Display with spaces
                        cellStatus.classList.add(`status-${entry.status.toLowerCase()}`);

                        if (entry.status === 'Present' || entry.status === 'Government_Holiday' || entry.status === 'Sick_Leave') {
                            cellHour.textContent = entry.hour;
                            cellExtraHour.textContent = entry.extraHour;
                            cellLate.textContent = entry.late;
                            cellShift.textContent = entry.shift;
                            cellGrace.textContent = entry.grace || '-';
                            cellApproval.textContent = entry.approval || '-';

                            totalHours += entry.hour + (entry.extraHour || 0);
                            const [lateHours, lateMinutes] = entry.late.split(':').map(Number);
                            totalLateMinutes += (lateHours * 60) + lateMinutes;

                            if (entry.shift === 'Day') totalDayShifts++;
                            else if (entry.shift === 'Night') totalNightShifts++;
                            totalWorkingDays++;
                            if (entry.grace === 'Yes') totalGraceDays++;

                            if (entry.status === 'Government_Holiday') totalGovernmentHolidayDays++;
                            else if (entry.status === 'Sick_Leave') totalSickLeaveDays++;
                            totalPresentCount++; // Count this as a present day
                        } else {
                            cellHour.textContent = '-';
                            cellExtraHour.textContent = '-';
                            cellLate.textContent = '-';
                            cellShift.textContent = '-';
                            cellGrace.textContent = '-';
                            cellApproval.textContent = entry.approval || '-';
                            if (entry.status === 'Absent') {
                                totalAbsentDays++;
                                totalWorkingDays++;
                            } else if (entry.status === 'Weekend') {
                                totalWeekendDays++;
                            } else if (entry.status === 'Holiday') {
                                totalHolidayDays++;
                            }
                        }
                    } else {
                        // If no entry, assume it's a regular day that hasn't been marked.
                        cellStatus.textContent = '-';
                        cellHour.textContent = '-';
                        cellExtraHour.textContent = '-';
                        cellLate.textContent = '-';
                        cellShift.textContent = '-';
                        cellGrace.textContent = '-';
                        cellApproval.textContent = '-';
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                if (historySummaryTotalHours) historySummaryTotalHours.textContent = totalHours;
                const formattedLateTime = `${String(Math.floor(totalLateMinutes / 60)).padStart(2, '0')}:${String(totalLateMinutes % 60).padStart(2, '0')}`;
                if (historySummaryLate) historySummaryLate.textContent = formattedLateTime;
                if (historySummaryAbsent) historySummaryAbsent.textContent = totalAbsentDays;
                if (historySummaryWeekend) historySummaryWeekend.textContent = totalWeekendDays;
                if (historySummaryHoliday) historySummaryHoliday.textContent = totalHolidayDays + totalGovernmentHolidayDays + totalSickLeaveDays;
                if (historySummaryWorkingDays) historySummaryWorkingDays.textContent = totalWorkingDays;
                if (historySummaryDayShifts) historySummaryDayShifts.textContent = totalDayShifts;
                if (historySummaryNightShifts) historySummaryNightShifts.textContent = totalNightShifts;
                if (historySummaryGrace) historySummaryGrace.textContent = totalGraceDays;
                if (historySummaryTotalPresent) historySummaryTotalPresent.textContent = totalPresentCount + totalGovernmentHolidayDays + totalSickLeaveDays + totalWeekendDays + totalHolidayDays;
            }

            // --- Help Modal Functions ---
            function openHelpModal() {
                if (helpModal) {
                    helpModal.style.display = 'flex';
                }
            }

            function closeHelpModalFunc() {
                if (helpModal) {
                    helpModal.style.display = 'none';
                }
            }

            // Initial call
            initializeApp();
        });
    </script>
</body>
</html>
