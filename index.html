<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>&#x2666; Activity - Attendance Tracker</title> <!-- Added diamond emoji to title -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- For icons, e.g., for user profile or arrows -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Basic Reset & Global Styles (PixelBloom UI Design) */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@400;600;700&display=swap');

        :root {
            /* Default Light Theme Colors (Refined) */
            --bg-primary: linear-gradient(135deg, #F0F4F8 0%, #E6EEF5 100%); /* Subtle light blue-grey gradient */
            --bg-secondary: #FFFFFF; /* Pure white for cards/elements */
            --text-primary: #2C3E50; /* Dark blue-grey for main text */
            --text-secondary: #607D8B; /* Medium grey for secondary text */
            --accent-color: #007BFF; /* Vibrant blue, slightly softer */
            --border-color: #DDE6ED; /* Light grey-blue */
            --shadow-color: rgba(0, 0, 0, 0.08); /* Softer shadow */
            --input-bg: #F8FAFC;
            --gradient-start: #6DD5FA; /* Main page gradient start (Light blue) */
            --gradient-mid1: #2980B9; /* Main page gradient mid (Medium blue) */
            --gradient-mid2: #1ABC9C; /* Main page gradient mid (Teal) */
            --gradient-mid3: #3498DB; /* Main page gradient mid (Sky blue) */
            --gradient-end: #8E44AD; /* Main page gradient end (Purple) */
            --nav-bg: #2C3E50; /* Deep blue-grey */
            --nav-text: #ffffff;
            --footer-bg: #2C3E50;
            --footer-text: #ffffff;
            --table-header-bg: #007BFF;
            --table-row-even: #F0F4F8;
            --table-row-hover: #E6EEF5;
            --status-present: #2C3E50;
            --status-absent: #E74C3C;
            --status-weekend: #808080;
            --status-holiday: #4CAF50; /* Green for Holiday */
        }

        /* Dark Theme Overrides (Midnight Blue) */
        html[data-theme='dark'] {
            --bg-primary: linear-gradient(135deg, #1A2A3A 0%, #0A1620 100%); /* Deep blue-black gradient */
            --bg-secondary: #2A3B4D; /* Dark desaturated blue for cards */
            --text-primary: #E0E6EB; /* Off-white */
            --text-secondary: #AAB8C2; /* Light grey-blue */
            --accent-color: #00C896; /* Vibrant teal-green */
            --border-color: #4A5C6F; /* Medium desaturated blue */
            --shadow-color: rgba(0, 0, 0, 0.4); /* Stronger shadow */
            --input-bg: #3A4C5E;
            --gradient-start: #0A1620;
            --gradient-mid1: #1A2A3A;
            --gradient-mid2: #2A3B4D;
            --gradient-mid3: #3A4C5E;
            --gradient-end: #4A5C6F;
            --nav-bg: #0A1620;
            --nav-text: #E0E6EB;
            --footer-bg: #0A1620;
            --footer-text: #E0E6EB;
            --table-header-bg: #00C896;
            --table-row-even: #203040;
            --table-row-hover: #30455A;
            --status-present: #E0E6EB;
            --status-absent: #FF6B6B; /* Brighter red for dark theme */
            --status-weekend: #AAB8C2; /* Lighter grey for dark theme */
            --status-holiday: #00FF00; /* Neon Green for Holiday in dark mode */
        }

        /* Sunset Glow Theme */
        html[data-theme='sunset-glow'] {
            --bg-primary: linear-gradient(135deg, #FFDAB9 0%, #FFC0CB 100%); /* Peach to Pink gradient */
            --bg-secondary: #FFFFFF;
            --text-primary: #5C3A3A; /* Dark brown */
            --text-secondary: #8B7355; /* Medium brown */
            --accent-color: #FF6347; /* Tomato red */
            --border-color: #F5DEB3; /* Wheat */
            --shadow-color: rgba(0, 0, 0, 0.15);
            --input-bg: #FFF8DC;
            --gradient-start: #FF7F50; /* Coral */
            --gradient-mid1: #FFD700; /* Gold */
            --gradient-mid2: #FFA07A; /* Light Salmon */
            --gradient-mid3: #FF6347; /* Tomato */
            --gradient-end: #CD5C5C; /* Indian Red */
            --nav-bg: #8B4513; /* Saddle Brown */
            --nav-text: #FFFFFF;
            --footer-bg: #8B4513;
            --footer-text: #FFFFFF;
            --table-header-bg: #FF6347;
            --table-row-even: #FFF0F5; /* Lavender Blush */
            --table-row-hover: #FFE4E1; /* Misty Rose */
            --status-present: #5C3A3A;
            --status-absent: #DC143C; /* Crimson */
            --status-weekend: #A9A9A9; /* Dark Gray */
            --status-holiday: #32CD32; /* Lime Green for Holiday */
        }

        /* Neon Theme */
        html[data-theme='neon'] {
            --bg-primary: linear-gradient(45deg, #00FFFF, #FF00FF, #FFFF00, #00FF00); /* Cyan, Magenta, Yellow, Green */
            --bg-secondary: rgba(25, 25, 25, 0.8); /* Dark, slightly transparent for contrast */
            --text-primary: #00FFFF; /* Bright Cyan */
            --text-secondary: #FF00FF; /* Bright Magenta */
            --accent-color: #00FF00; /* Neon Green */
            --border-color: #FFFF00; /* Neon Yellow */
            --shadow-color: rgba(0, 255, 255, 0.5); /* Cyan glow */
            --input-bg: rgba(0, 0, 0, 0.6); /* Darker transparent for inputs */
            
            --gradient-start: #00FFFF;
            --gradient-mid1: #FF00FF;
            --gradient-mid2: #FFFF00;
            --gradient-mid3: #00FF00;
            --gradient-end: #FF00FF; /* Repeating */

            --nav-bg: rgba(0, 0, 0, 0.9);
            --nav-text: #00FFFF;
            --footer-bg: rgba(0, 0, 0, 0.9);
            --footer-text: #FF00FF;
            --table-header-bg: #00FF00;
            --table-row-even: rgba(50, 50, 50, 0.7);
            --table-row-hover: rgba(75, 75, 75, 0.8);
            --status-present: #00FFFF;
            --status-absent: #FF00FF;
            --status-weekend: #FFFF00;
            --status-holiday: #00FF7F; /* Spring Green for Holiday */

            /* Override specific element styles for neon glow */
            .premium-button {
                box-shadow: 0 0 15px var(--accent-color), 0 0 25px var(--accent-color);
                border: 2px solid var(--accent-color);
            }
            .premium-button:hover {
                box-shadow: 0 0 20px var(--accent-color), 0 0 35px var(--accent-color);
            }
            .auth-container {
                box-shadow: 0 0 30px var(--shadow-color), 0 0 50px var(--shadow-color);
                border: 2px solid var(--border-color);
            }
            .input-group input:focus,
            .input-group select:focus {
                box-shadow: 0 0 0 4px var(--accent-color);
            }
            .input-group input.error {
                border-color: var(--text-secondary); /* Magenta for error */
                box-shadow: 0 0 0 4px var(--text-secondary);
            }
            .input-group .error-message {
                color: var(--text-secondary);
            }
            .section-card {
                box-shadow: 0 0 20px var(--shadow-color);
                border: 2px solid var(--border-color);
            }
            #main-navbar {
                box-shadow: 0 0 20px var(--shadow-color);
            }
            #main-navbar.scrolled {
                background-color: rgba(0, 0, 0, 0.9); /* More opaque */
                backdrop-filter: blur(12px); /* Stronger blur */
            }
            .logo-icon {
                filter: drop-shadow(0 0 5px var(--accent-color));
            }
            .nav-links a::after {
                background-color: var(--accent-color);
            }
            .user-photo {
                border: 2px solid var(--accent-color);
            }
            .user-dashboard-photo {
                border: 4px solid var(--accent-color);
            }
            .summary-grid span {
                color: var(--accent-color);
            }
            #attendanceTable thead, #historyAttendanceTable thead, #usersTable thead {
                background-color: var(--table-header-bg);
            }
            .table-actions button {
                box-shadow: 0 0 10px var(--accent-color);
            }
            .table-actions .delete-button {
                box-shadow: 0 0 10px var(--status-absent);
            }
            .modal-content {
                box-shadow: 0 0 20px var(--shadow-color);
                border: 2px solid var(--border-color);
            }
            #customAlertModal .modal-content,
            #customConfirmModal .modal-content {
                border-left: 8px solid var(--accent-color); /* Use accent color for alerts */
            }
            .help-modal-content h2 {
                text-shadow: 0 0 10px var(--accent-color);
            }
            .tic-tac-toe-board {
                border: 2px solid var(--border-color);
                box-shadow: 0 0 15px var(--shadow-color);
            }
            .cell {
                border: 1px solid var(--border-color);
            }
            .cell.x { color: var(--accent-color); }
            .cell.o { color: var(--text-secondary); } /* Magenta for O */
            .typing-stats span {
                color: var(--accent-color);
            }
            .level-selection .premium-button.active {
                box-shadow: 0 0 10px var(--accent-color);
            }
            footer {
                border-top: 5px solid var(--accent-color);
                box-shadow: 0 -5px 20px var(--shadow-color);
            }
            footer .footer-section h4 {
                color: var(--accent-color);
            }
            footer .footer-section a:hover {
                color: var(--accent-color);
            }
        }

        /* Alert/Warning Colors (remain consistent but adapt to theme text) */
        --alert-info: #2196F3;
        --alert-success: #4CAF50;
        --alert-warning: #FFC107;
        --alert-error: #F44336;

        --transition-speed: 0.3s ease-in-out;
        --border-radius-base: 12px;
        --border-radius-large: 20px;

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden; /* Prevent horizontal scroll */
            background: var(--bg-primary); /* Default background now uses gradient variable */
            transition: background var(--transition-speed), color var(--transition-speed);
        }

        body.main-page-body {
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-mid1) 25%, var(--gradient-mid2) 50%, var(--gradient-mid3) 75%, var(--gradient-end) 100%);
            background-size: 400% 400%; /* Increased size for smoother animation */
            animation: gradientAnimation 20s ease infinite; /* Slower animation */
            padding-top: 80px; /* Space for fixed navbar */
        }

        /* Animation for Neon Theme */
        html[data-theme='neon'] body.main-page-body {
            animation: neonGradientAnimation 10s ease infinite alternate; /* Faster, alternating animation */
            background-size: 600% 600%; /* Even larger for more movement */
        }

        @keyframes neonGradientAnimation {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 100%; }
            100% { background-position: 0% 0%; }
        }


        h1, h2, h3, h4 {
            font-family: 'Poppins', sans-serif;
            color: var(--text-primary);
            font-weight: 700;
            transition: color var(--transition-speed);
        }

        /* Premium Button Style */
        .premium-button {
            background-color: var(--accent-color); /* Vibrant accent color */
            color: var(--nav-text); /* White text for buttons */
            padding: 16px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); /* Stronger shadow for pop */
            letter-spacing: 0.5px;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .premium-button:hover {
            background-color: var(--accent-color); /* Keep same color, but change shadow/transform */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(-3px) scale(1.02); /* More pronounced lift and slight scale */
        }

        .premium-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Secondary Button Style */
        .premium-button.secondary {
            background-color: var(--border-color);
            color: var(--text-primary);
            box-shadow: 0 3px 8px var(--shadow-color);
        }

        .premium-button.secondary:hover {
            background-color: var(--border-color); /* Keep same color, but change shadow/transform */
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px) scale(1.01);
        }

        /* Delete Button Style */
        .premium-button.delete-button {
            background-color: var(--status-absent); /* Red for delete */
            box-shadow: 0 3px 8px rgba(231, 76, 60, 0.3);
        }

        .premium-button.delete-button:hover {
            background-color: var(--status-absent);
            box-shadow: 0 5px 12px rgba(192, 57, 43, 0.4);
            transform: translateY(-2px) scale(1.01);
        }

        /* --- Login Page Specific Styles --- */
        .login-page-body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%); /* Use theme gradient */
            background-size: 200% 200%;
            animation: gradientAnimation 15s ease infinite;
            color: var(--nav-text);
            transition: background var(--transition-speed);
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .auth-container {
            background-color: var(--bg-secondary); /* Use secondary background for auth container */
            backdrop-filter: blur(8px); /* More pronounced blur effect */
            padding: 50px;
            border-radius: 10px;
            box-shadow: 0 25px 70px var(--shadow-color); /* More pronounced shadow */
            text-align: center;
            width: 90%;
            max-width: 300px;
            animation: fadeInScale 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); /* Bouncier animation */
            color: var(--text-primary);
            overflow: hidden;
            border: 1px solid var(--border-color); /* Light border for transparency */
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed), border-color var(--transition-speed);
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .auth-container h1.premium-heading {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--text-primary);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }

        .auth-container .sub-heading {
            font-size: 1.1rem;
            margin-bottom: 40px;
            color: var(--accent-color); /* Accent color for sub-heading */
            font-weight: 500;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 22px;
            animation: slideIn 0.5s ease-out forwards;
        }

        .input-group {
            text-align: left;
            position: relative;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
            letter-spacing: 0.2px;
        }

        .input-group input[type="email"],
        .input-group input[type="password"],
        .input-group input[type="text"],
        .input-group input[type="date"],
        .input-group select {
            width: 80%;
            padding: 14px 18px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: all var(--transition-speed);
            background-color: var(--input-bg);
            color: var(--text-primary);
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.08); /* Slightly deeper inner shadow */
        }

        .input-group input::placeholder {
            color: var(--text-secondary);
        }

        .input-group input[type="email"]:focus,
        .input-group input[type="password"]:focus,
        .input-group input[type="text"]:focus,
        .input-group input[type="date"]:focus,
        .input-group select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.35); /* More prominent glow */
            outline: none;
        }

        /* Styles for input error states */
        .input-group input.error {
            border-color: var(--alert-error); /* Red border for error */
            box-shadow: 0 0 0 4px rgba(244, 67, 54, 0.35); /* Red glow for error */
        }

        .input-group .error-message {
            color: var(--alert-error);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none; /* Hidden by default */
        }

        .input-group input.error + .error-message {
            display: block; /* Show message when input has error class */
        }

        .login-links {
            display: flex;
            justify-content: space-between; /* Space between links */
            margin-top: 18px;
            font-size: 0.9rem;
        }

        .login-links a {
            color: var(--accent-color);
            text-decoration: none;
            transition: color var(--transition-speed);
            font-weight: 500;
        }

        .login-links a:hover {
            color: var(--text-primary);
            text-decoration: underline;
        }

        /* --- Main Page General Styles --- */
        body.main-page-body {
            background: var(--bg-primary); /* Use theme primary background for main page */
            padding-top: 80px; /* Space for fixed navbar */
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .section-card {
            background-color: var(--bg-secondary);
            padding: 35px;
            margin-bottom: 30px;
            border-radius: 10px; /* Apply large border-radius */
            box-shadow: 0 12px 35px var(--shadow-color); /* Slightly larger shadow */
            animation: slideUp 0.6s ease-out forwards;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color var(--transition-speed), border-color var(--transition-speed); /* Add transition for hover */
        }

        .section-card:hover {
            transform: translateY(-5px); /* Subtle lift on hover */
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.12); /* More pronounced shadow on hover */
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-size: 2rem;
            color: var(--text-primary);
            margin-bottom: 25px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        /* --- Navigation Bar --- */
        #main-navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: var(--nav-bg);
            color: var(--nav-text);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            transition: background-color 0.3s ease, padding 0.3s ease, backdrop-filter 0.3s ease, color var(--transition-speed);
        }

        #main-navbar.scrolled {
            background-color: rgba(44, 62, 80, 0.9); /* More transparency when scrolled */
            padding: 10px 30px;
            backdrop-filter: blur(8px); /* Blur effect when scrolled */
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-text {
            font-family: 'Poppins', sans-serif;
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--nav-text);
            letter-spacing: 0.8px;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            fill: var(--accent-color); /* Accent color for logo icon */
            transition: fill var(--transition-speed);
        }

        .nav-links {
            display: flex;
            gap: 20px;
            list-style: none;
            margin-right: auto;
            margin-left: 25px;
        }

        .nav-links a {
            color: var(--nav-text);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: color var(--transition-speed);
            position: relative;
            padding-bottom: 5px;
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            background-color: var(--accent-color);
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            transition: width var(--transition-speed), background-color var(--transition-speed);
        }

        .nav-links a:hover::after {
            width: 100%;
        }

        .nav-links a:hover {
            color: var(--accent-color);
        }

        .user-profile-menu {
            position: relative;
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: var(--nav-text);
            padding: 5px 10px;
            border-radius: var(--border-radius-base);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .user-profile-menu:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-photo {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-left: 12px;
            border: 2px solid var(--accent-color);
            object-fit: cover;
            transition: transform var(--transition-speed), border-color var(--transition-speed);
        }

        .user-photo:hover {
            transform: scale(1.08);
            border-color: var(--nav-text);
        }

        .user-profile-menu i {
            margin-left: 6px;
            transition: transform var(--transition-speed);
        }

        .user-profile-menu.active i {
            transform: rotate(180deg);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--bg-secondary);
            min-width: 160px;
            box-shadow: 0 8px 16px var(--shadow-color);
            z-index: 1;
            top: 100%;
            right: 0;
            border-radius: var(--border-radius-base);
            overflow: hidden;
            transform-origin: top right;
            animation: scaleIn 0.2s ease-out forwards;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .user-profile-menu:hover .dropdown-content,
        .user-profile-menu.active .dropdown-content {
            display: block;
        }

        .dropdown-content a {
            color: var(--text-primary);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            font-weight: 400;
            font-size: 0.9rem;
        }

        .dropdown-content a:hover {
            background-color: var(--bg-primary);
            color: var(--accent-color);
        }

        /* Theme Toggle Button */
        #themeToggle {
            background: none;
            border: none;
            color: var(--nav-text);
            font-size: 1.4rem;
            cursor: pointer;
            margin-left: 20px;
            transition: color 0.3s ease, transform 0.2s ease;
        }

        #themeToggle:hover {
            color: var(--accent-color);
            transform: scale(1.1);
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7); /* Slightly lighter overlay */
            justify-content: center;
            align-items: center;
            animation: fadeInOverlay 0.2s ease-out;
        }

        @keyframes fadeInOverlay {
            from { background-color: rgba(0,0,0,0); }
            to { background-color: rgba(0,0,0,0.7); }
        }

        .modal-content {
            background-color: var(--bg-secondary);
            margin: auto;
            padding: 40px;
            border-radius: var(--border-radius-large);
            box-shadow: 0 15px 40px var(--shadow-color);
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: slideDownFadeIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        /* Specific modal content animation for zoom in/out */
        .modal.zoom-anim .modal-content {
            animation: zoomInFadeIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes zoomInFadeIn {
            from { opacity: 0; transform: scale(0.7); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes slideDownFadeIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.8rem;
            color: var(--text-primary);
            text-align: center;
        }

        .modal-content .close-button {
            color: var(--border-color);
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 15px;
            right: 20px;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .modal-content .close-button:hover,
        .modal-content .close-button:focus {
            color: var(--text-primary);
            transform: rotate(90deg);
        }

        .user-photo-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-color);
            margin-top: 15px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 3px 10px var(--shadow-color);
            transition: border-color var(--transition-speed);
        }

        /* --- User Dashboard Section --- */
        .user-dashboard-section {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 30px;
            padding: 35px;
            background-color: var(--bg-secondary);
            border-radius: 10px; /* Apply large border-radius */
            box-shadow: 0 10px 30px var(--shadow-color);
            margin-bottom: 30px;
            animation: slideUp 0.6s ease-out forwards;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        .user-dashboard-photo {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--accent-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: border-color var(--transition-speed);
        }

        .user-dashboard-info {
            text-align: left;
            flex-grow: 1;
            min-width: 280px;
        }

        .user-dashboard-info h3 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .user-dashboard-info p {
            font-size: 1rem;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .user-dashboard-info strong {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* --- Month Selector & History Summary --- */
        .month-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .month-selector .premium-button {
            padding: 10px 20px;
            font-size: 0.9rem;
            border-radius: 25px; /* Pill shape */
            box-shadow: 0 3px 8px var(--shadow-color);
        }

        .month-selector .premium-button:hover {
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
        }

        /* Styling for the new month dropdown */
        #monthSelectDropdown {
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-speed);
            box-shadow: 0 3px 8px var(--shadow-color);
        }

        #monthSelectDropdown:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.35);
            outline: none;
        }

        .current-month {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
            transition: color var(--transition-speed);
        }

        .date-range-display {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-secondary);
            font-size: 0.95rem;
            transition: color var(--transition-speed);
        }

        .history-summary {
            background-color: var(--bg-primary);
            border-radius: var(--border-radius-base);
            padding: 20px;
            box-shadow: inset 0 1px 5px rgba(0,0,0,0.05);
            margin-top: 20px;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }

        .history-summary h3 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 18px;
            font-size: 1.3rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            text-align: center;
        }

        .summary-grid div {
            background-color: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
            font-weight: 500;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color var(--transition-speed);
            border: 1px solid var(--border-color);
        }

        .summary-grid div:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .summary-grid strong {
            color: var(--text-primary);
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .summary-grid span {
            font-size: 1.2rem;
            color: var(--accent-color);
            font-weight: 700;
        }

        /* --- Data Entry Form (if visible) --- */
        .data-entry-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .data-entry-form .input-group {
            margin-bottom: 0;
        }

        .data-entry-form input[type="date"],
        .data-entry-form input[type="number"],
        .data-entry-form input[type="text"],
        .data-entry-form select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-base);
            font-size: 0.95rem;
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: background-color var(--transition-speed), border-color var(--transition-speed), color var(--transition-speed);
        }

        .data-entry-form input:focus,
        .data-entry-form select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.2);
            outline: none;
        }

        #addEntryBtn {
            grid-column: 1 / -1;
            width: 70%;
            margin: 0 auto;
            display: block;
        }

        /* --- Saved Entries Table --- */
        .table-responsive {
            overflow-x: auto;
        }

        #attendanceTable, #historyAttendanceTable, #usersTable {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            background-color: var(--bg-secondary);
            box-shadow: 0 5px 20px var(--shadow-color);
            border-radius: var(--border-radius-large); /* Apply large border-radius */
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        #attendanceTable thead, #historyAttendanceTable thead, #usersTable thead {
            background-color: var(--table-header-bg);
            color: var(--nav-text);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        #attendanceTable th,
        #attendanceTable td,
        #historyAttendanceTable th,
        #historyAttendanceTable td,
        #usersTable th,
        #usersTable td {
            padding: 15px 18px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: color var(--transition-speed), border-color var(--transition-speed);
        }

        #attendanceTable th, #historyAttendanceTable th, #usersTable th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.3px;
        }

        #attendanceTable tbody tr:nth-child(even), #historyAttendanceTable tbody tr:nth-child(even), #usersTable tbody tr:nth-child(even) {
            background-color: var(--table-row-even);
            transition: background-color var(--transition-speed);
        }

        #attendanceTable tbody tr:hover, #historyAttendanceTable tbody tr:hover, #usersTable tbody tr:hover {
            background-color: var(--table-row-hover);
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }

        .table-actions button {
            background-color: var(--accent-color);
            color: var(--nav-text);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 6px;
            transition: all var(--transition-speed);
            box-shadow: 0 2px 5px rgba(108, 99, 255, 0.2);
        }

        .table-actions button:hover {
            background-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(108, 99, 255, 0.3);
        }

        .table-actions .delete-button {
            background-color: var(--status-absent);
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.2);
        }

        .table-actions .delete-button:hover {
            background-color: var(--status-absent);
            box-shadow: 0 3px 8px rgba(192, 57, 43, 0.3);
        }

        /* Specific Status Colors (Text Only) */
        .status-present { color: var(--status-present); font-weight: 600; transition: color var(--transition-speed); }
        .status-absent { color: var(--status-absent); font-weight: 600; transition: color var(--transition-speed); }
        .status-weekend { color: var(--status-weekend); font-weight: 600; transition: color var(--transition-speed); }
        .status-holiday { color: var(--status-holiday); font-weight: 600; transition: color var(--transition-speed); }
        
        /* Modal for Status Selection */
        #statusSelectionModal .modal-options button {
            display: block;
            width: 100%;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-base);
            background-color: var(--input-bg);
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            transition: all var(--transition-speed);
            box-shadow: 0 3px 8px var(--shadow-color);
        }
        #statusSelectionModal .modal-options button:hover {
            background-color: var(--border-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
        }
        #statusSelectionModal .modal-options button:last-child {
            margin-bottom: 0;
        }

        /* Modal for Present Entry */
        #presentEntryModal .input-group {
            margin-bottom: 18px;
        }
        #presentEntryModal .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-primary);
        }
        #presentEntryModal .input-group input,
        #presentEntryModal .input-group select {
            padding: 12px 15px;
            border-radius: var(--border-radius-base);
            border: 1px solid var(--border-color);
            width: 100%;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--text-primary);
        }
        #presentEntryModal .input-group input:focus,
        #presentEntryModal .input-group select:focus {
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.2);
            outline: none;
        }
        #presentEntryModal .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }
        #presentEntryModal .modal-buttons .premium-button {
            padding: 10px 20px;
            font-size: 0.9rem;
        }
        #presentEntryModal .modal-buttons .premium-button.save {
            background-color: var(--accent-color);
            color: var(--nav-text);
        }
        #presentEntryModal .modal-buttons .premium-button.save:hover {
            background-color: var(--accent-color);
        }
        #presentEntryModal .modal-buttons .premium-button.cancel {
            background-color: var(--border-color);
            color: var(--text-primary);
        }
        #presentEntryModal .modal-buttons .premium-button.cancel:hover {
            background-color: var(--border-color);
        }

        /* Edit/Delete Modal specific styles */
        #editDeleteModal .modal-content .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-primary);
        }
        #editDeleteModal .modal-content .input-group input,
        #editDeleteModal .modal-content .input-group select {
            padding: 12px 15px;
            border-radius: var(--border-radius-base);
            border: 1px solid var(--border-color);
            width: 100%;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--text-primary);
        }
        #editDeleteModal .modal-content .input-group input:focus,
        #editDeleteModal .modal-content .input-group select:focus {
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.2);
            outline: none;
        }
        #editDeleteModal .modal-content .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }
        #editDeleteModal .modal-content .modal-buttons .premium-button {
            padding: 10px 20px;
            font-size: 0.9rem;
        }
        #editDeleteModal .modal-content .modal-buttons .premium-button.save {
            background-color: var(--accent-color);
            color: var(--nav-text);
        }
        #editDeleteModal .modal-content .modal-buttons .premium-button.save:hover {
            background-color: var(--accent-color);
        }
        #editDeleteModal .modal-content .modal-buttons .premium-button.delete-button {
            background-color: var(--status-absent);
        }
        #editDeleteModal .modal-content .modal-buttons .premium-button.delete-button:hover {
            background-color: var(--status-absent);
        }

        /* --- History Page Specific Styles --- */
        #historySection {
            display: none;
        }

        #historySection .date-range-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        #historySection .date-range-inputs .input-group {
            flex: 1;
            min-width: 250px;
        }

        #historySection .date-range-inputs button {
            flex-grow: 1;
            max-width: 180px;
            margin-top: 28px;
        }

        #historySummaryResult {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--bg-primary);
            border-radius: var(--border-radius-base);
            box-shadow: inset 0 1px 5px rgba(0,0,0,0.05);
            margin-top: 20px;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }

        #historySummaryResult h3 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 18px;
            font-size: 1.3rem;
        }

        /* --- Footer --- */
        footer {
            text-align: center;
            padding: 30px 20px;
            background-color: var(--footer-bg);
            color: var(--footer-text);
            font-size: 0.85rem;
            margin-top: 40px;
            border-top: 5px solid var(--accent-color); /* Accent border for premium look */
            animation: fadeIn 0.8s ease-out;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            align-items: flex-start;
            gap: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3); /* Shadow for depth */
            transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed);
        }

        footer .footer-section {
            flex: 1;
            min-width: 220px;
            text-align: center;
        }

        footer .footer-section h4 {
            font-size: 1.1rem; /* Slightly larger */
            margin-bottom: 15px;
            color: var(--accent-color); /* Accent color for footer headings */
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            transition: color var(--transition-speed);
        }

        footer .footer-section p {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem; /* Slightly larger */
        }

        footer .footer-section p i {
            margin-right: 10px;
            color: rgba(255, 255, 255, 0.6); /* Softer icon color */
            font-size: 1.1rem; /* Slightly larger icon */
        }

        footer .footer-section a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: color var(--transition-speed);
        }

        footer .footer-section a:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }

        /* Custom Alert/Confirm Modal Styles */
        #customAlertModal .modal-content,
        #customConfirmModal .modal-content {
            padding: 30px;
            max-width: 400px;
            text-align: center;
            border-left: 8px solid; /* Dynamic color based on type */
            animation: slideDownFadeIn 0.3s ease-out;
            transition: border-color var(--transition-speed);
        }

        #customAlertModal .modal-content.info,
        #customConfirmModal .modal-content.info { border-color: var(--alert-info); }
        #customAlertModal .modal-content.success,
        #customConfirmModal .modal-content.success { border-color: var(--alert-success); }
        #customAlertModal .modal-content.warning,
        #customConfirmModal .modal-content.warning { border-color: var(--alert-warning); }
        #customAlertModal .modal-content.error,
        #customConfirmModal .modal-content.error { border-color: var(--alert-error); }

        #customAlertModal h2,
        #customConfirmModal h2 {
            font-size: 1.6rem;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        #customAlertModal p,
        #customConfirmModal p {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 25px;
        }

        #customAlertModal .modal-buttons,
        #customConfirmModal .modal-buttons {
            justify-content: center;
            gap: 15px;
        }

        #customAlertModal .modal-buttons .premium-button,
        #customConfirmModal .modal-buttons .premium-button {
            padding: 10px 25px;
            font-size: 0.95rem;
        }

        /* Help Modal Specific Styles */
        .help-modal-content {
            background-color: var(--bg-secondary); /* Use theme background */
            text-align: center;
            padding: 50px;
            animation: bounceIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy animation */
            border: 1px solid var(--border-color);
            box-shadow: 0 15px 40px var(--shadow-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        .help-modal-content h2 {
            font-size: 2.5rem;
            color: var(--accent-color);
            margin-bottom: 20px;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        .help-modal-content p {
            font-size: 1.5rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        /* Tic-Tac-Toe Modal Specific Styles */
        #ticTacToeModal .modal-content {
            max-width: 450px; /* Adjust for Tic-Tac-Toe board */
            padding: 30px;
        }

        .tic-tac-toe-board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 5px;
            width: 315px; /* 3*100 + 2*5 */
            margin: 20px auto;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-base);
            overflow: hidden;
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }

        .cell {
            width: 100px;
            height: 100px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3.5em; /* Larger X/O */
            font-weight: 700;
            cursor: pointer;
            user-select: none; /* Prevent text selection on click */
            transition: background-color 0.2s ease, color 0.2s ease, border-color var(--transition-speed);
            color: var(--text-primary); /* Default color, overridden by .x/.o */
        }

        .cell:hover {
            background-color: var(--input-bg);
        }

        .cell.x { color: var(--accent-color); } /* Use accent color for X */
        .cell.o { color: var(--status-absent); } /* Use alert-error color for O */

        #ticTacToeGameOptions { /* Renamed from #gameOptions to be specific */
            margin-bottom: 20px;
        }

        #ticTacToeGameOptions button { /* Renamed from #gameOptions button */
            margin: 5px;
        }

        #ticTacToeGameStatus { /* Renamed from #gameStatus to be specific */
            font-size: 1.3rem;
            font-weight: 600;
            margin-top: 20px;
            color: var(--text-primary);
        }

        .tic-tac-toe-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            gap: 10px;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .tic-tac-toe-stats div {
            padding: 8px 15px;
            border-radius: 8px;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: background-color 0.2s ease;
        }
        .tic-tac-toe-stats div span {
            font-weight: 700;
            color: var(--accent-color);
        }
        .tic-tac-toe-stats .wins span { color: var(--alert-success); }
        .tic-tac-toe-stats .losses span { color: var(--alert-error); }
        .tic-tac-toe-stats .draws span { color: var(--alert-info); }


        /* Typing Test Section Styling */
        #typingTestSection {
            display: none; /* Hidden by default */
            padding-top: 30px;
        }

        #paragraphDisplay {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-wrap; /* Preserves formatting */
            word-wrap: break-word; /* Breaks long words */
            background-color: var(--input-bg);
            padding: 20px;
            border-radius: var(--border-radius-base);
            border: 1px solid var(--border-color);
            min-height: 150px;
            display: flex; /* Use flex to wrap spans */
            flex-wrap: wrap;
            align-content: flex-start;
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }

        #paragraphDisplay span {
            transition: background-color 0.1s ease, color 0.1s ease;
            padding: 1px 0; /* Small padding for highlighting visibility */
        }

        #typingInput {
            font-family: monospace; /* For better character alignment */
            font-size: 1.1em;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-base);
            width: 100%;
            box-sizing: border-box; /* Include padding in width */
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: background-color var(--transition-speed), border-color var(--transition-speed), color var(--transition-speed);
            resize: vertical; /* Allow vertical resizing */
            min-height: 100px;
        }

        #typingInput:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.2);
            outline: none;
        }

        /* Highlight correct/incorrect characters (JS will add these classes) */
        .correct {
            color: green;
        }
        .incorrect {
            color: red;
            background-color: rgba(255, 0, 0, 0.1); /* Subtle red background for errors */
            border-bottom: 1px dashed red; /* Underline for errors */
        }
        .current-char {
            background-color: yellow;
            border-radius: 3px;
            color: black; /* Ensure contrast */
        }

        .typing-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .typing-stats div {
            flex: 1;
            min-width: 150px;
            text-align: center;
            margin: 10px;
            padding: 15px;
            background-color: var(--bg-primary);
            border-radius: var(--border-radius-base);
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: background-color var(--transition-speed);
        }

        .typing-stats h5 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .typing-stats span {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-color);
        }

        .level-selection .premium-button {
            margin: 5px;
            padding: 8px 18px;
            font-size: 0.9rem;
            border-radius: 8px;
        }
        .level-selection .premium-button.active {
            background-color: var(--accent-color);
            color: var(--nav-text);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .level-selection .premium-button.active:hover {
            transform: translateY(-2px);
        }

        #testResultsList {
            list-style: none;
            padding: 0;
        }

        #testResultsList .list-item {
            background-color: var(--bg-primary);
            margin-bottom: 10px;
            padding: 15px;
            border-radius: var(--border-radius-base);
            box-shadow: 0 1px 5px var(--shadow-color);
            font-size: 0.95rem;
            color: var(--text-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        #testResultsList .list-item:last-child {
            margin-bottom: 0;
        }

        /* Users List Section */
        /* This section is removed from the HTML based on user request */
        /* #usersListSection {
            display: none;
            padding-top: 30px;
        } */

        /* Add User Modal */
        /* This modal is removed from the HTML based on user request */
        /* #addUserModal .modal-content {
            max-width: 400px;
        } */

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #main-navbar {
                flex-direction: column;
                padding: 15px 20px;
                gap: 10px;
            }
            .nav-links {
                margin-left: 0;
                justify-content: center;
                width: 100%;
                gap: 15px;
            }
            .user-profile-menu {
                margin-top: 10px;
            }
            .auth-container {
                padding: 30px;
            }
            .auth-container h1.premium-heading {
                font-size: 2.2rem;
            }
            .auth-container .sub-heading {
                font-size: 1rem;
            }
            .premium-button {
                padding: 12px 25px;
                font-size: 0.9rem;
            }
            .data-entry-form {
                grid-template-columns: 1fr;
            }
            #addEntryBtn {
                width: 90%;
            }
            footer {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            footer .footer-section {
                text-align: center;
            }
            footer .footer-section p {
                justify-content: center;
            }

            .user-dashboard-section {
                flex-direction: column;
                text-align: center;
            }
            .user-dashboard-info {
                text-align: center;
            }

            #historySection .date-range-inputs button {
                margin-top: 10px;
            }

            /* Adjust game canvas size for smaller screens */
            #gameCanvas { /* This is for snake game, which is removed, but keeping for reference */
                width: 100%; /* Make canvas fill width */
                height: 300px; /* Set a fixed height or adjust dynamically */
            }
            #gameControls { /* This is for snake game, which is removed, but keeping for reference */
                flex-direction: column; /* Stack buttons vertically */
            }
            #gameControls button { /* This is for snake game, which is removed, but keeping for reference */
                width: 80%; /* Make buttons wider */
            }

            .tic-tac-toe-board {
                grid-template-columns: repeat(3, 80px);
                grid-template-rows: repeat(3, 80px);
                width: 255px; /* 3*80 + 2*5 */
            }

            .cell {
                width: 80px;
                height: 80px;
                font-size: 3em;
            }

            .game-list-grid {
                grid-template-columns: 1fr; /* Stack game cards on small screens */
            }

            .typing-stats {
                flex-direction: column;
            }
            .typing-stats div {
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login/Registration Section -->
    <div id="authSection" class="login-page-body">
        <div class="auth-container">
            <!-- The sub-heading is outside the forms, so it applies to the whole auth-container -->
            <!-- We will update the h1 content dynamically in JS -->
            <h1 class="premium-heading" id="authHeading"></h1> 

            <form id="loginForm" class="auth-form active">
                <div class="input-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                    <span class="error-message" id="loginEmailError"></span>
                </div>
                <div class="input-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    <span class="error-message" id="loginPasswordError"></span>
                </div>
                <div class="login-links">
                    <a href="#" id="registerHereLink">Register Here</a>
                </div>
                <button type="submit" class="premium-button">Login</button>
            </form>

            <form id="registerForm" class="auth-form" style="display: none;">
                <div class="input-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email address" required>
                    <span class="error-message" id="registerEmailError"></span>
                </div>
                <div id="registrationDetails" style="display: block;"> <!-- Always visible now -->
                    <div class="input-group">
                        <label for="registerUsername">Username</label>
                        <input type="text" id="registerUsername" placeholder="Choose a username" required>
                    </div>
                    <div class="input-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" placeholder="Create a password" required>
                        <span class="error-message" id="registerPasswordError"></span>
                    </div>
                    <div class="input-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                        <span class="error-message" id="confirmPasswordError"></span>
                    </div>
                    <div class="input-group">
                        <label for="registerJoiningDate">Joining Date</label>
                        <input type="date" id="registerJoiningDate" required>
                    </div>
                    <div class="input-group">
                        <label for="registerLngId">LnG ID</label>
                        <input type="text" id="registerLngId" placeholder="Enter your LnG ID" required>
                    </div>
                </div>
                <button type="submit" class="premium-button" id="registerSubmitBtn">Register</button> <!-- Not disabled anymore -->
                <p style="color: var(--text-primary); font-size: 0.95rem;">Already have an account? <a href="#" id="loginHereLink" style="color: var(--accent-color); text-decoration: underline;">Login Here</a></p>
            </form>
        </div>
    </div>

    <!-- Main Activity Page Section (Initially hidden) -->
    <div id="mainActivitySection" style="display: none;">
        <!-- First Section: Navigation Bar -->
        <nav id="main-navbar">
            <div class="logo-container">
                <span class="logo-text">Activity</span>
                <!-- Diamond Logo SVG -->
                <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 12L12 22L22 12L12 2Z"/>
                </svg>
            </div>
            <ul class="nav-links">
                <li><a href="#" id="homeNavLink">Home</a></li>
                <li><a href="#" id="historyNavLink">History</a></li>
                <li><a href="#" id="gamesNavLink">Games</a></li> <!-- New Games Link -->
                <li><a href="#" id="typingTestNavLink">Typing Test</a></li> <!-- New Typing Test Link -->
                <!-- <li><a href="#" id="usersNavLink">Users</a></li> Removed Users Link -->
                <li><a href="#" id="helpNavLink">Help</a></li>
            </ul>
            <div class="nav-right">
                <button id="themeToggle" class="fas fa-sun"></button> <!-- Theme Toggle Button -->
                <div class="user-profile-menu">
                    <span id="usernameDisplay">Username</span>
                    <img id="userPhotoDisplay" src="https://placehold.co/40x40/000000/ffffff?text=User" alt="User Photo" class="user-photo">
                    <i class="fas fa-caret-down"></i>
                    <div class="dropdown-content">
                        <a href="#" id="personalProfileBtn">Personal Profile</a>
                        <a href="#" id="logoutBtn">Logout</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Personal Profile Modal -->
        <div id="profileModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h2>Edit Profile</h2>
                <div class="input-group">
                    <label for="profileNameInput">Profile Name</label>
                    <input type="text" id="profileNameInput" placeholder="Enter your display name">
                </div>
                <div class="input-group">
                    <label for="usernameInput">Username</label>
                    <input type="text" id="usernameInput" placeholder="Enter your username">
                </div>
                <div class="input-group">
                    <label for="emailInput">Email Address</label>
                    <input type="email" id="emailInput" readonly>
                </div>
                <div class="input-group">
                    <label for="profileJoiningDateInput">Joining Date</label>
                    <input type="date" id="profileJoiningDateInput">
                </div>
                <div class="input-group">
                    <label for="profileLngIdInput">LnG ID</label>
                    <input type="text" id="profileLngIdInput" placeholder="Your LnG ID">
                </div>
                <div class="input-group">
                    <label for="profilePictureInput">Profile Picture</label>
                    <input type="file" id="profilePictureInput" accept="image/*">
                    <img id="profilePicturePreview" src="https://placehold.co/100x100/000000/ffffff?text=User" alt="Profile Picture Preview" class="user-photo-preview">
                </div>
                <button id="saveProfileBtn" class="premium-button">Save Changes</button>
            </div>
        </div>

        <main class="container">
            <!-- New 1st Section: User Dashboard -->
            <section id="dashboardSection" class="user-dashboard-section">
                <img id="dashboardUserPhoto" src="https://placehold.co/150x150/000000/ffffff?text=User" alt="User Photo" class="user-dashboard-photo">
                <div class="user-dashboard-info">
                    <h3 id="dashboardUsername">Username</h3>
                    <p><strong>Worked For:</strong> <span id="workedForDisplay">0 years 0 months</span></p>
                    <p><strong>LnG ID:</b> <span id="lngIdDisplay">N/A</span></p>
                </div>
                <!-- Optional: Graph/Chart can go here -->
            </section>

            <!-- Second Section: Month Selection and History Result -->
            <section id="monthlySummarySection" class="section-card">
                <h2>Attendance History</h2>
                <div class="month-selector">
                    <!-- Removed prevMonthBtn and nextMonthBtn -->
                    <select id="monthSelectDropdown"></select>
                </div>

                <div class="date-range-display">
                    <p><strong>From:</strong> <span id="dateFrom"></span> | <strong>To:</strong> <span id="dateTo"></span></p>
                </div>

                <div class="history-summary">
                    <h3>Monthly Summary</h3>
                    <div class="summary-grid">
                        <div><strong>Total Hours:</strong> <span id="summaryTotalHours">0</span></div>
                        <div><strong>Late:</strong> <span id="summaryLate">0</span></div>
                        <div><strong>Absent:</strong> <span id="summaryAbsent">0</span></div>
                        <div><strong>Weekends:</strong> <span id="summaryWeekend">0</span></div>
                        <div><strong>Holidays:</strong> <span id="summaryHoliday">0</span></div> <!-- New Holiday summary -->
                        <div><strong>Working Days:</strong> <span id="summaryWorkingDays">0</span></div>
                        <!-- Combined Shift & Grace into a single div -->
                        <div>
                            <strong>Night Shifts:</strong> <span id="summaryNightShifts">0</span><br>
                            <strong>Grace:</strong> <span id="summaryGrace">0</span>
                        </div>
                        <div><strong>Day Shifts:</b> <span id="summaryDayShifts">0</span></div>
                    </div>
                </div>
            </section>

            <!-- Fourth Section: Saved Entries Data -->
            <section id="dailyEntriesSection" class="section-card">
                <h2>Daily Attendance Entries</h2> <!-- Heading added here -->
                <div class="table-responsive">
                    <table id="attendanceTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Hour</th>
                                <th>Extra Hour</th>
                                <th>Late</th>
                                <th>Shift</th>
                                <th>Grace</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- History Page Section (Initially hidden) -->
        <section id="historySection" class="container">
            <div class="section-card">
                <h2>Custom History Report</h2>
                <div class="date-range-inputs">
                    <div class="input-group">
                        <label for="historyDateFrom">From Date:</label>
                        <input type="date" id="historyDateFrom">
                    </div>
                    <div class="input-group">
                        <label for="historyDateTo">To Date:</label>
                        <input type="date" id="historyDateTo">
                    </div>
                    <button id="findHistoryResultBtn" class="premium-button">Find Result</button>
                </div>
                
                <div id="historySummaryResult" class="history-summary">
                    <h3>Report Summary</h3>
                    <div class="summary-grid">
                        <div><strong>Total Hours:</strong> <span id="historySummaryTotalHours">0</span></div>
                        <div><strong>Late:</b> <span id="historySummaryLate">0</span></div>
                        <div><strong>Absent:</strong> <span id="historySummaryAbsent">0</span></div>
                        <div><strong>Weekends:</strong> <span id="historySummaryWeekend">0</span></div>
                        <div><strong>Holidays:</strong> <span id="historySummaryHoliday">0</span></div> <!-- New Holiday summary for history -->
                        <div><strong>Working Days:</strong> <span id="historySummaryWorkingDays">0</span></div>
                        <div><strong>Day Shifts:</strong> <span id="historySummaryDayShifts">0</span></div>
                        <div><strong>Night Shifts:</strong> <span id="historySummaryNightShifts">0</span></div>
                        <div><strong>Grace:</strong> <span id="historySummaryGrace">0</span></div>
                    </div>
                </div>

                <div id="historyDetailedEntries" class="table-responsive" style="margin-top: 30px;">
                    <h3>Detailed Entries for Selected Period</h3>
                    <table id="historyAttendanceTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Hour</th>
                                <th>Extra Hour</th>
                                <th>Late</th>
                                <th>Shift</th>
                                <th>Grace</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Detailed entries will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Games Section (New) -->
        <section id="gamesSection" class="container">
            <div class="section-card">
                <h2>Our Games</h2>
                <div class="game-list-grid">
                    <div class="game-card" id="ticTacToeGameCard">
                        <i class="fas fa-times-circle game-icon" style="color: blue;"></i> <!-- X icon for Tic-Tac-Toe -->
                        <h3>Tic-Tac-Toe</h3>
                        <button class="premium-button open-tic-tac-toe-modal">Play Now</button>
                    </div>
                    <div class="game-card">
                        <i class="fas fa-palette game-icon"></i>
                        <h3>Coloring Game</h3>
                        <button class="premium-button secondary" disabled>Coming Soon</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Typing Test Section (New) -->
        <section id="typingTestSection" class="container">
            <div class="section-card">
                <h2>Improve Your Typing Speed</h2>
                <!-- Level Selection -->
                <div class="text-center mb-4 level-selection">
                    <h4>Select Difficulty:</h4>
                    <div class="btn-group" role="group" aria-label="Typing Levels">
                        <button type="button" class="premium-button secondary" id="levelEasy">Easy</button>
                        <button type="button" class="premium-button secondary" id="levelNormal">Normal</button>
                        <button type="button" class="premium-button secondary" id="levelHard">Hard</button>
                    </div>
                </div>

                <!-- Paragraph Selection -->
                <div class="input-group mb-4">
                    <label for="paragraphHeadlineSelect">Select Paragraph:</label>
                    <select id="paragraphHeadlineSelect" class="form-control">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>

                <!-- Time Selection -->
                <div class="input-group mb-4">
                    <label for="testDuration">Test Duration (minutes):</label>
                    <select id="testDuration" class="form-control">
                        <option value="1">1 minute</option>
                        <option value="2" selected>2 minutes</option>
                        <option value="3">3 minutes</option>
                        <option value="4">4 minutes</option>
                        <option value="5">5 minutes</option>
                        <option value="6">6 minutes</option>
                        <option value="7">7 minutes</option>
                        <option value="8">8 minutes</option>
                        <option value="9">9 minutes</option>
                        <option value="10">10 minutes</option>
                    </select>
                </div>

                <!-- Paragraph Display Area -->
                <div class="card mb-4">
                    <div class="card-body">
                        <p id="paragraphDisplay" class="lead text-muted"></p>
                        <textarea id="typingInput" class="form-control" rows="5" placeholder="Start typing here..." autofocus></textarea>
                    </div>
                </div>

                <!-- Speed and Accuracy Display -->
                <div class="typing-stats">
                    <div>
                        <h5>Speed:</h5>
                        <span id="wpmDisplay">0</span> WPM
                    </div>
                    <div>
                        <h5>Accuracy:</h5>
                        <span id="accuracyDisplay">100</span>%
                    </div>
                    <div>
                        <h5>Time Left:</h5>
                        <span id="timeLeftDisplay">00:00</span>
                    </div>
                    <div>
                        <h5>Highest Score:</h5>
                        <span id="highestWPMDisplay">0</span> WPM
                    </div>
                </div>

                <!-- Timer/Controls -->
                <div class="text-center mb-4">
                    <button class="premium-button" id="startTest">Start Test</button>
                    <button class="premium-button secondary" id="resetTest" style="display: none;">Reset Test</button>
                </div>

                <!-- Results Section -->
                <div class="card mt-5 section-card">
                    <div class="card-header">
                        <h3>Your Typing History</h3>
                    </div>
                    <ul id="testResultsList" class="list-group list-group-flush">
                        <!-- Results will be added here dynamically -->
                    </ul>
                    <div class="card-footer text-muted text-center" style="background-color: var(--bg-primary); border-top: 1px solid var(--border-color); padding-top: 15px;">
                        Results saved locally in your browser.
                    </div>
                </div>
            </div>
        </section>

        <!-- Status Selection Modal -->
        <div id="statusSelectionModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeStatusSelectionModal">&times;</span>
                <h2>Select Status</h2>
                <div class="modal-options">
                    <button class="premium-button" id="selectPresent">Present</button>
                    <button class="premium-button" id="selectWeekend">Weekend</button>
                    <button class="premium-button" id="selectAbsent">Absent</button>
                    <button class="premium-button" id="selectHoliday">Holiday</button> <!-- New Holiday button -->
                </div>
            </div>
        </div>

        <!-- Present Entry Modal -->
        <div id="presentEntryModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closePresentEntryModal">&times;</span>
                <h2>Enter Present Details</h2>
                <div class="input-group">
                    <label for="presentEntryDate">Date</label>
                    <input type="date" id="presentEntryDate" readonly>
                </div>
                <div class="input-group">
                    <label for="presentHour">Hour</label>
                    <input type="number" id="presentHour" min="0" max="24" value="9" placeholder="e.g., 9" required>
                </div>
                <div class="input-group">
                    <label for="presentExtraHour">Extra Hour</label>
                    <input type="number" id="presentExtraHour" min="0" max="24" value="0" placeholder="e.g., 2" required>
                </div>
                <div class="input-group">
                    <label for="presentLate">Late (HH:MM)</label>
                    <input type="text" id="presentLate" value="00:00" readonly>
                </div>
                <div class="input-group">
                    <label for="presentShiftType">Shift</label>
                    <select id="presentShiftType">
                        <option value="Day">Day</option>
                        <option value="Night">Night</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="presentGrace">Grace</label>
                    <select id="presentGrace">
                        <option value="-">-</option>
                        <option value="Yes">Yes</option>
                    </select>
                    <small id="graceLimitMessage" style="color: var(--alert-error); display: none;">Grace limit reached for this month (5/5)</small>
                </div>
                <div class="modal-buttons">
                    <button id="savePresentEntryBtn" class="premium-button save">Save</button>
                    <button id="cancelPresentEntryBtn" class="premium-button cancel secondary">Cancel</button>
                </div>
            </div>
        </div>


        <!-- Edit/Delete Modal -->
        <div id="editDeleteModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeEditDeleteModal">&times;</span>
                <h2>Edit Entry</h2>
                <div class="input-group">
                    <label for="editDate">Date</label>
                    <input type="date" id="editDate" readonly>
                </div>
                <div class="input-group">
                    <label for="editStatus">Status</label>
                    <select id="editStatus">
                        <option value="Present">Present</option>
                        <option value="Weekend">Weekend</option>
                        <option value="Absent">Absent</option>
                        <option value="Holiday">Holiday</option> <!-- New Holiday option -->
                    </select>
                </div>
                <div class="input-group" id="editPresentDetailsGroup">
                    <label for="editHour">Hour</label>
                    <input type="number" id="editHour" min="0" max="24" placeholder="e.g., 9" required>
                </div>
                <div class="input-group" id="editExtraHourGroup">
                    <label for="editExtraHour">Extra Hour</label>
                    <input type="number" id="editExtraHour" min="0" max="24" placeholder="e.g., 2" required>
                </div>
                <div class="input-group" id="editLateHourGroup">
                    <label for="editLateHour">Late (HH:MM)</label>
                    <input type="text" id="editLateHour" value="00:00" readonly>
                </div>
                <div class="input-group" id="editShiftTypeGroup">
                    <label for="editShiftType">Shift</label>
                    <select id="editShiftType">
                        <option value="Day">Day</option>
                        <option value="Night">Night</option>
                    </select>
                </div>
                <div class="input-group" id="editGraceGroup">
                    <label for="editGrace">Grace</label>
                    <select id="editGrace">
                        <option value="-">-</option>
                        <option value="Yes">Yes</option>
                    </select>
                    <small id="editGraceLimitMessage" style="color: var(--alert-error); display: none;">Grace limit reached for this month (5/5)</small>
                </div>
                <div class="modal-buttons">
                    <button id="updateEntryBtn" class="premium-button save">Update</button>
                    <button id="deleteEntryBtn" class="premium-button delete-button">Delete</button>
                </div>
            </div>
        </div>

        <!-- Custom Alert Modal (for general messages) -->
        <div id="customAlertModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeCustomAlertModal">&times;</span>
                <h2 id="customAlertTitle"></h2>
                <p id="customAlertMessage"></p>
                <div class="modal-buttons">
                    <button id="customAlertOkBtn" class="premium-button save">OK</button>
                </div>
            </div>
        </div>

        <!-- Custom Confirm Modal (for yes/no questions) -->
        <div id="customConfirmModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeCustomConfirmModal">&times;</span>
                <h2 id="customConfirmTitle"></h2>
                <p id="customConfirmMessage"></p>
                <div class="modal-buttons">
                    <button id="customConfirmYesBtn" class="premium-button save">Yes</button>
                    <button id="customConfirmNoBtn" class="premium-button secondary">No</button>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="modal">
            <div class="modal-content help-modal-content">
                <span class="close-button" id="closeHelpModal">&times;</span>
                <h2 id="helpModalTitle">Nothing to Help Here</h2>
                <p id="helpModalMessage"></p>
            </div>
        </div>

        <!-- Tic-Tac-Toe Game Modal (New) -->
        <div id="ticTacToeModal" class="modal zoom-anim">
            <div class="modal-content">
                <span class="close-button" id="closeTicTacToeModal">&times;</span>
                <h2>Tic-Tac-Toe</h2>
                <!-- Game Options -->
                <div id="ticTacToeGameOptions">
                    <p>Select Opponent:</p>
                    <button class="premium-button" id="playVsComputer">Play vs. Computer</button>
                    <button class="premium-button secondary" id="playVsPlayer">Play vs. Player 2</button>
                </div>

                <!-- Game Area (initially hidden) -->
                <div id="ticTacToeGameArea" style="display: none;">
                    <div id="ticTacToeBoard" class="tic-tac-toe-board">
                        <!-- 3x3 grid for the game -->
                        <div class="cell" data-cell-index="0"></div>
                        <div class="cell" data-cell-index="1"></div>
                        <div class="cell" data-cell-index="2"></div>
                        <div class="cell" data-cell-index="3"></div>
                        <div class="cell" data-cell-index="4"></div>
                        <div class="cell" data-cell-index="5"></div>
                        <div class="cell" data-cell-index="6"></div>
                        <div class="cell" data-cell-index="7"></div>
                        <div class="cell" data-cell-index="8"></div>
                    </div>
                    <div id="ticTacToeGameStatus" class="mt-3 text-center"></div>
                    <div class="tic-tac-toe-stats">
                        <div class="wins">Wins: <span id="ticTacToeWins">0</span></div>
                        <div class="losses">Losses: <span id="ticTacToeLosses">0</span></div>
                        <div class="draws">Draws: <span id="ticTacToeDraws">0</span></div>
                    </div>
                    <button class="premium-button secondary mt-3" id="ticTacToeResetGame">Reset Game</button>
                </div>
            </div>
        </div>

        <!-- Fifth Section: Footer -->
        <footer>
            <div class="footer-section">
                <h4>Contact Us</h4>
                <p><i class="fas fa-phone"></i> Phone: +8801518138951</p>
                <p><i class="fas fa-envelope"></i> E-Mail: <a href="mailto:prantorodrix9@gmail.com">prantorodrix9@gmail.com</a></p>
                <p><i class="fas fa-map-marker-alt"></i> Address: Baridhara-DOHS, Gulshan, Dhaka</p>
                <p><i class="fas fa-globe"></i> Website: <a href="https://www.reallygreatsite.com" target="_blank">www.abcd.com</a></p>
            </div>
            <div class="footer-section">
                <h4>Activity</h4>
                <p>&copy; <span id="currentYear"></span> Made by @PrantoAnthonyRodrix. All rights reserved.</p>
             </div>
        </footer>
    </div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            // Local Data Storage (Loaded from localStorage or initialized)
            // Changed localUserData to registeredUsers for multiple user storage
            let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers')) || [];
            let currentLoggedInUser = null; // To store the currently logged-in user's data

            // Save registeredUsers to localStorage
            function saveRegisteredUsers() {
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            }

            // Save currentLoggedInUser's specific data
            function saveCurrentUserData() {
                if (currentLoggedInUser) {
                    // Find the index of the current user in registeredUsers array
                    const userIndex = registeredUsers.findIndex(user => user.email === currentLoggedInUser.email);
                    if (userIndex !== -1) {
                        registeredUsers[userIndex] = currentLoggedInUser;
                    } else {
                        // This case should ideally not happen if user is truly logged in
                        // But as a fallback, add if not found (e.g., first login after clearing localStorage for some reason)
                        registeredUsers.push(currentLoggedInUser);
                    }
                    saveRegisteredUsers();
                }
            }


            // --- DOM Elements - Authentication Section ---
            const authSection = document.getElementById('authSection');
            const mainActivitySection = document.getElementById('mainActivitySection');
            const authHeading = document.getElementById('authHeading');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const registerHereLink = document.getElementById('registerHereLink');
            const loginHereLink = document.getElementById('loginHereLink');
            const loginEmailInput = document.getElementById('loginEmail');
            const loginPasswordInput = document.getElementById('loginPassword');
            const loginEmailError = document.getElementById('loginEmailError');
            const loginPasswordError = document.getElementById('loginPasswordError');


            // Register form specific inputs
            const registerEmailInput = document.getElementById('registerEmail');
            const registerEmailError = document.getElementById('registerEmailError');
            const registrationDetails = document.getElementById('registrationDetails'); 
            const registerUsernameInput = document.getElementById('registerUsername');
            const registerPasswordInput = document.getElementById('registerPassword');
            const registerPasswordError = document.getElementById('registerPasswordError');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const confirmPasswordError = document.getElementById('confirmPasswordError');
            const registerJoiningDateInput = document.getElementById('registerJoiningDate');
            const registerLngIdInput = document.getElementById('registerLngId');
            const registerSubmitBtn = document.getElementById('registerSubmitBtn'); 

            // --- Custom Alert/Confirm Modals DOM Elements (always present in HTML) ---
            const customAlertModal = document.getElementById('customAlertModal');
            const customAlertTitle = document.getElementById('customAlertTitle');
            const customAlertMessage = document.getElementById('customAlertMessage');
            const customAlertOkBtn = document.getElementById('customAlertOkBtn');
            const closeCustomAlertModal = document.getElementById('closeCustomAlertModal');

            const customConfirmModal = document.getElementById('customConfirmModal');
            const customConfirmTitle = document.getElementById('customConfirmTitle');
            const customConfirmMessage = document.getElementById('customConfirmMessage');
            const customConfirmYesBtn = document.getElementById('customConfirmYesBtn');
            const customConfirmNoBtn = document.getElementById('customConfirmNoBtn');
            const closeCustomConfirmModal = document.getElementById('closeCustomConfirmModal');
            let confirmCallback = null; // To store the callback for customConfirmModal

            // Theme toggle button (always present in HTML)
            const themeToggle = document.getElementById('themeToggle');
            const themeList = ['light', 'dark', 'sunset-glow', 'neon']; // Added 'neon' theme
            let currentThemeIndex = 0;

            // Help Modal elements (always present in HTML)
            const helpModal = document.getElementById('helpModal');
            const closeHelpModal = helpModal ? helpModal.querySelector('.close-button') : null;
            const helpModalTitle = document.getElementById('helpModalTitle');
            const helpModalMessage = document.getElementById('helpModalMessage');


            // --- DOM Elements - Main Activity Section (will be queried after main section is visible) ---
            let mainNavbar, usernameDisplay, userPhotoDisplay, personalProfileBtn, logoutBtn, profileModal, profileModalCloseBtn,
                profileNameInput, usernameInput, emailInput, profilePictureInput, profilePicturePreview, saveProfileBtn,
                profileJoiningDateInput, profileLngIdInput, dashboardUserPhoto, dashboardUsername, workedForDisplay, lngIdDisplay,
                monthSelectDropdown, dateFromDisplay, dateToDisplay, summaryTotalHours,
                summaryLate, summaryAbsent, summaryWeekend, summaryHoliday, summaryWorkingDays, summaryDayShifts, summaryNightShifts, summaryGrace,
                attendanceTableBody, editDeleteModal, editDeleteModalCloseBtn, editDateInput, editHourInput,
                editExtraHourInput, editLateHourInput, editShiftTypeInput, updateEntryBtn, deleteEntryBtn, currentYearSpan,
                editStatusInput, editPresentDetailsGroup, editExtraHourGroup, editLateHourGroup, editShiftTypeGroup, editGraceGroup, editGraceInput, editGraceLimitMessage;

            // Status selection modal elements
            let statusSelectionModal, closeStatusSelectionModal, selectPresentBtn, selectWeekendBtn, selectAbsentBtn, selectHolidayBtn;
            let currentSelectedDateForStatus = null; // To store the date for which status is being set

            // Present entry modal elements
            let presentEntryModal, closePresentEntryModal, presentEntryDateInput, presentHourInput, presentExtraHourInput,
                presentLateInput, presentShiftTypeInput, presentGraceInput, savePresentEntryBtn, cancelPresentEntryBtn, graceLimitMessage;

            // Navigation elements
            let homeNavLink, historyNavLink, gamesNavLink, typingTestNavLink, helpNavLinkRef; 
            let dashboardSection, monthlySummarySection, dailyEntriesSection, historySection, gamesSection, typingTestSection; 

            // History page elements
            let historyDateFromInput, historyDateToInput, findHistoryResultBtn;
            let historySummaryTotalHours, historySummaryLate, historySummaryAbsent, historySummaryWeekend, historySummaryHoliday,
                historySummaryWorkingDays, historySummaryDayShifts, historySummaryNightShifts, historySummaryGrace;
            let historyAttendanceTableBody;

            // Tic-Tac-Toe Game Elements
            let ticTacToeModal, closeTicTacToeModal, ticTacToeGameOptions, playVsComputerBtn, playVsPlayerBtn,
                ticTacToeGameArea, ticTacToeBoard, ticTacToeCells, ticTacToeGameStatus, ticTacToeResetGameBtn;
            let ticTacToeBoardState = ['', '', '', '', '', '', '', '', ''];
            let ticTacToeCurrentPlayer = 'X';
            let ticTacToeIsGameActive = false;
            let ticTacToeIsVsComputer = false;
            let ticTacToeWinsDisplay, ticTacToeLossesDisplay, ticTacToeDrawsDisplay; 
            const ticTacToeWinningConditions = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
                [0, 4, 8], [2, 4, 6]             // Diagonals
            ];

            // Typing Test Elements
            let paragraphDisplay, typingInput, wpmDisplay, accuracyDisplay, startTestBtn, resetTestBtn,
                levelEasyBtn, levelNormalBtn, levelHardBtn, testResultsList, testDurationSelect, timeLeftDisplay, highestWPMDisplay,
                paragraphHeadlineSelect; // New element for paragraph selection
            
            // Hardcoded paragraphs
            const paragraphs = {
                easy: [
                    { headline: "A Peaceful Morning", text: "The sun rises slowly, casting a golden light over everything. Birds begin to chirp, filling the air with cheerful sounds. The streets are still quiet, and only a few people are out for a morning walk. The smell of fresh bread and tea comes from nearby homes. This is the best time of the day to think, plan, or simply enjoy the calm. A peaceful morning can make the whole day feel better. You can sit with a warm drink, listen to the sounds around you, and feel your stress fade away. Many people start their day with some quiet time or a walk to clear their minds." },
                    { headline: "My Visit to the Zoo", text: "Last weekend, I went to the zoo with my family. It was a sunny day, perfect for walking around and seeing animals. We saw lions, tigers, bears, and even colorful birds. The giraffes looked calm and tall, and the monkeys were playing in the trees. My favorite part was watching the elephants. They sprayed water on each other and seemed very happy. The zoo also had a small train that took visitors around the park. We took lots of photos and enjoyed ice cream near the panda area. It was a fun day full of joy and learning about animals." },
                    { headline: "Helping Others", text: "Helping people is a kind thing to do, and it can make you feel good too. When someone is in trouble or needs help, a simple act of kindness can mean a lot. You don't always need to give money. Sometimes just listening to someone or giving your time can be more helpful. At school, helping a classmate understand a lesson or picking up something they dropped is a great way to show kindness. In your neighborhood, helping an older person carry their groceries or clean their yard can make a big difference. Kindness spreads easily." },
                    { headline: "My Favorite Hobby", text: "Everyone should have a hobby. My favorite hobby is drawing. I love to sit with my pencil and colors and draw everything I see. Sometimes I draw animals, sometimes people, and sometimes just shapes and designs. Drawing helps me feel calm and happy. I often draw when I am bored or when I want to express how I feel. Its a great way to be creative. I even made a small album of my best drawings. My family and friends like to see my artwork. One day, I want to learn painting too." },
                    { headline: "Why Cleanliness Matters", text: "Being clean is not just about looking nice. It helps us stay healthy too. Washing hands before eating, brushing teeth twice a day, and keeping our clothes clean are all good habits. Clean surroundings also make us feel fresh. When our home and school are clean, it is easier to think and work better. Cleanliness also shows respect for others. If everyone keeps their area clean, the whole community benefits. So lets throw trash in the bin, keep water sources clean, and teach others to do the same." }
                ],
                normal: [
                    { headline: "The Power of Habit", text: "Habits are powerful because they shape our daily lives. What we do repeatedly becomes a part of us. Good habits such as waking up early, reading, or exercising regularly can make us healthier, smarter, and more productive. On the other hand, bad habits like procrastination, unhealthy eating, or wasting too much time on social media can slow us down. The good news is that habits can be changed. It takes time, effort, and a clear goal. Once you decide to improve, taking small steps every day can lead to big changes. A consistent habit forms a routine, and routines build discipline." },
                    { headline: "The Magic of Nature", text: "Nature has a special way of healing and inspiring us. Whether its the sound of a river, the sight of a mountain, or the calm of a green forest, nature connects with our inner peace. Studies show that people who spend time in nature often feel less stress and more happiness. Walking barefoot on grass, listening to birds, or just watching the sky can clear your mind and refresh your energy. Nature is also full of lessons: patience from a tree that grows slowly, strength from a river that flows endlessly, and unity in how everything works together." },
                    { headline: "Learning from Failure", text: "Failure is something everyone experiences, but it is not the end of the road. In fact, failure can teach us more than success. When we fail, we understand what doesnt work, and that helps us try better next time. Great people like Thomas Edison and J.K. Rowling faced many failures before they succeeded. The key is to not give up. Each time you fall, stand up stronger. Learn from your mistakes and keep moving forward. Success tastes sweeter after youve struggled. Failure builds resilience, confidence, and wisdom. So dont fear itembrace it." },
                    { headline: "Life in a Village", text: "Village life is simple but beautiful. People live closer to nature and lead peaceful lives. Most people grow their own food, wake up early, and go to bed early too. There is less pollution, and the air feels fresh. You can hear birds instead of car horns. The community in a village is often very close. People know each other well, help each other, and share festivals together. While there may not be big malls or cinemas, theres a strong feeling of togetherness. Many people from cities visit villages just to relax and find peace." },
                    { headline: "Why We Should Save Water", text: "Water is one of the most important resources on Earth. Every living being needs water to survive. However, many people waste water without realizing its value. Leaving taps open, using too much water for cleaning, and polluting rivers are serious problems. In some places, people dont even get clean drinking water. We need to save water by fixing leaks, turning off taps when not needed, and using buckets instead of hoses. Schools and homes can spread awareness. If we dont act now, future generations may suffer. Saving water today ensures life tomorrow." }
                ],
                hard: [
                    { headline: "Digital Dependency and Human Behavior", text: "In todays world, people are becoming increasingly dependent on digital technology. From smartphones to smart homes, our lives revolve around screens and devices. While this has brought great convenience, it has also raised concerns. Human behavior is shiftingattention spans are shrinking, social skills are declining, and people are becoming less present in the moment. Face-to-face interactions are being replaced by texts and emojis. Children are growing up with devices in their hands rather than books. While technology itself is not the problem, our over-reliance on it is. We must learn to find balance, using tech as a tool, not a crutch." },
                    { headline: "The Value of Critical Thinking", text: "Critical thinking is the ability to analyze information, question assumptions, and make reasoned decisions. In a world full of misinformation, fake news, and social media influence, this skill is more important than ever. It helps us avoid blindly following trends or falling into emotional traps. When we think critically, we seek evidence, evaluate sources, and look at multiple viewpoints before forming opinions. Schools should encourage this habit from an early age. A society that thinks critically is more informed, rational, and less likely to be misled. Its not about arguing moreits about understanding better." },
                    { headline: "Climate Crisis and Global Unity", text: "Climate change is not just a future threatits a present danger. Rising temperatures, melting glaciers, and unpredictable weather are already affecting millions. Yet, political delays and lack of action continue. True progress can only be made if all nations act together. This requires cooperation, not competition. Its not enough for one country to reduce emissions if others continue polluting. Individual action matters toochoosing sustainable products, using less plastic, and saving energy can help. Climate change is a global challenge that demands global unity, urgency, and responsibility from both leaders and citizens." },
                    { headline: "The Evolution of Language", text: "Language is one of the most fascinating aspects of human culture. It evolves constantly, shaped by time, technology, and interaction. Words are born, meanings change, and some languages even disappear. The internet has accelerated this changeslang, emojis, abbreviations, and memes have added a new dimension to communication. While language evolves, it also reflects social values and identity. Preserving endangered languages, studying linguistics, and understanding how language affects thought are important tasks. Language isnt just a toolits a mirror of the human mind." },
                    { headline: "The Psychology Behind Procrastination", text: "Procrastination is not always about laziness. Psychologists suggest it's often tied to fear of failure, perfectionism, or lack of motivation. When people avoid tasks, they may be trying to protect their self-esteem or cope with anxiety. The mind tricks us into seeking temporary comfort by delaying discomfort. However, this usually leads to more stress later. Overcoming procrastination involves understanding your triggers, breaking tasks into smaller steps, and using positive reinforcement. Productivity isn't about working non-stopit's about managing your time and mind wisely. Procrastination is common, but with awareness and strategy, it can be conquered." }
                ]
            };
            let currentParagraph = '';
            let currentLevel = 'normal';
            let startTime;
            let timerInterval;
            let isTestRunning = false;
            let charactersTyped = 0;
            let correctCharacters = 0;
            let typedCharactersSpan; // To hold the span element for character highlighting
            let testCompleted = false; // Flag to track if the test was completed successfully


            let currentMonthView = new Date(); // Define currentMonthView here globally

            // --- Initial Setup and Authentication Flow ---
            function initializeApp() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                applyTheme(savedTheme);

                // Check if there's a logged-in user session
                const lastLoggedInEmail = localStorage.getItem('lastLoggedInUserEmail');
                if (lastLoggedInEmail) {
                    const user = registeredUsers.find(u => u.email === lastLoggedInEmail);
                    if (user) {
                        currentLoggedInUser = user;
                        showMainActivitySection();
                        return; // Exit if already logged in
                    }
                }
                showAuthSection(); // Show login/registration if no active session
            }

            function showAuthSection() {
                authSection.style.display = 'flex';
                mainActivitySection.style.display = 'none';
                document.body.classList.add('login-page-body');
                document.body.classList.remove('main-page-body');
                setupAuthPage();
            }

            function showMainActivitySection() {
                authSection.style.display = 'none';
                mainActivitySection.style.display = 'block';
                document.body.classList.remove('login-page-body');
                document.body.classList.add('main-page-body');
                queryMainAppElements(); // Query elements once main section is visible
                setupMainApp();
                updateUserProfileDisplay(); // Display initial user data
                populateMonthDropdown(); // Populate month dropdown on main app load
                setupMonthView(currentMonthView); // Set up initial month view
                showSection('dashboard');
            }

            function clearErrors() {
                loginEmailInput.classList.remove('error');
                loginPasswordInput.classList.remove('error');
                loginEmailError.textContent = '';
                loginPasswordError.textContent = '';

                registerEmailInput.classList.remove('error');
                registerPasswordInput.classList.remove('error');
                confirmPasswordInput.classList.remove('error');
                registerEmailError.textContent = '';
                registerPasswordError.textContent = '';
                confirmPasswordError.textContent = '';
            }

            function setupAuthPage() {
                clearErrors(); // Clear errors on page load/switch

                if (loginForm.classList.contains('active')) {
                    if (authHeading) authHeading.textContent = 'ENTER YOUR ACCOUNT';
                } else if (registerForm.classList.contains('active')) {
                    if (authHeading) authHeading.textContent = 'CREATE ACCOUNT';
                }

                if (registerHereLink) {
                    registerHereLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        loginForm.style.display = 'none';
                        registerForm.style.display = 'flex';
                        if (authHeading) authHeading.textContent = 'CREATE ACCOUNT';
                        // Reset register form fields and errors
                        registerEmailInput.value = '';
                        registerUsernameInput.value = '';
                        registerPasswordInput.value = '';
                        confirmPasswordInput.value = '';
                        registerJoiningDateInput.value = '';
                        registerLngIdInput.value = '';
                        clearErrors();
                    });
                }

                if (loginHereLink) {
                    loginHereLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        registerForm.style.display = 'none';
                        loginForm.style.display = 'flex';
                        if (authHeading) authHeading.textContent = 'ENTER YOUR ACCOUNT';
                        clearErrors(); // Clear errors on switch back to login
                    });
                }

                if (loginForm) {
                    loginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        clearErrors(); // Clear previous errors

                        const email = loginEmailInput.value.trim();
                        const password = loginPasswordInput.value.trim();

                        if (!email) {
                            loginEmailInput.classList.add('error');
                            loginEmailError.textContent = 'Email is required.';
                            return;
                        }
                        if (!password) {
                            loginPasswordInput.classList.add('error');
                            loginPasswordError.textContent = 'Password is required.';
                            return;
                        }

                        const user = registeredUsers.find(u => u.email === email);

                        if (!user) {
                            loginEmailInput.classList.add('error');
                            loginEmailError.textContent = 'Email not registered.';
                            return;
                        }

                        if (user.password !== password) { // In a real app, use hashed passwords
                            loginPasswordInput.classList.add('error');
                            loginPasswordError.textContent = 'Incorrect password.';
                            return;
                        }

                        // Successful login
                        currentLoggedInUser = user;
                        localStorage.setItem('lastLoggedInUserEmail', email); // Remember last logged in user
                        showMainActivitySection();
                    });
                }

                if (registerForm) {
                    registerForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        clearErrors(); // Clear previous errors

                        const email = registerEmailInput.value.trim();
                        const username = registerUsernameInput.value.trim();
                        const password = registerPasswordInput.value.trim();
                        const confirmPassword = confirmPasswordInput.value.trim();
                        const joiningDate = registerJoiningDateInput.value;
                        const lngId = registerLngIdInput.value.trim();

                        let hasError = false;

                        if (!email) {
                            registerEmailInput.classList.add('error');
                            registerEmailError.textContent = 'Email is required.';
                            hasError = true;
                        } else if (registeredUsers.some(u => u.email === email)) {
                            registerEmailInput.classList.add('error');
                            registerEmailError.textContent = 'This email is already registered.';
                            hasError = true;
                        }
                        if (!username) {
                            // No specific error message for username, but it's required
                            // For simplicity, not adding .error class to username for now
                        }
                        if (!password) {
                            registerPasswordInput.classList.add('error');
                            registerPasswordError.textContent = 'Password is required.';
                            hasError = true;
                        } else if (password.length < 6) {
                            registerPasswordInput.classList.add('error');
                            registerPasswordError.textContent = 'Password must be at least 6 characters.';
                            hasError = true;
                        }
                        if (!confirmPassword) {
                            confirmPasswordInput.classList.add('error');
                            confirmPasswordError.textContent = 'Confirm password is required.';
                            hasError = true;
                        } else if (password !== confirmPassword) {
                            confirmPasswordInput.classList.add('error');
                            confirmPasswordError.textContent = 'Passwords do not match!';
                            hasError = true;
                        }
                        if (!joiningDate) {
                            // No specific error message for joining date, but it's required
                        }
                        if (!lngId) {
                            // No specific error message for LnG ID, but it's required
                        }

                        if (hasError) {
                            return;
                        }

                        // Simulate registration success
                        const newUser = {
                            profileName: username,
                            username: username,
                            email: email,
                            password: password, // In a real app, hash this password!
                            photo: `https://placehold.co/40x40/000000/ffffff?text=${username.charAt(0).toUpperCase()}`,
                            joiningDate: joiningDate,
                            lngId: lngId,
                            attendance: {},
                            graceCounts: {},
                            ticTacToeStats: { wins: 0, losses: 0, draws: 0 },
                            highestWPM: 0
                        };
                        registeredUsers.push(newUser);
                        saveRegisteredUsers();
                        
                        showCustomAlert('Success!', 'Registration successful! You can now login with this email.', 'success');
                        loginForm.style.display = 'flex';
                        registerForm.style.display = 'none';
                        if (authHeading) authHeading.textContent = 'ENTER YOUR ACCOUNT';
                    });
                }
            }

            function queryMainAppElements() {
                // This function is called only when mainActivitySection is displayed.
                // All these elements should exist in the DOM at this point.
                mainNavbar = document.getElementById('main-navbar');
                usernameDisplay = document.getElementById('usernameDisplay');
                userPhotoDisplay = document.getElementById('userPhotoDisplay');
                personalProfileBtn = document.getElementById('personalProfileBtn');
                logoutBtn = document.getElementById('logoutBtn');
                
                profileModal = document.getElementById('profileModal');
                profileModalCloseBtn = profileModal.querySelector('.close-button');
                profileNameInput = document.getElementById('profileNameInput');
                usernameInput = document.getElementById('usernameInput');
                emailInput = document.getElementById('emailInput');
                profilePictureInput = document.getElementById('profilePictureInput');
                saveProfileBtn = document.getElementById('saveProfileBtn');
                profileJoiningDateInput = document.getElementById('profileJoiningDateInput');
                profileLngIdInput = document.getElementById('profileLngIdInput');
                profilePicturePreview = document.getElementById('profilePicturePreview');

                dashboardUserPhoto = document.getElementById('dashboardUserPhoto');
                dashboardUsername = document.getElementById('dashboardUsername');
                workedForDisplay = document.getElementById('workedForDisplay');
                lngIdDisplay = document.getElementById('lngIdDisplay');

                // monthSelectDropdown replaces prevMonthBtn, nextMonthBtn, currentMonthDisplay
                monthSelectDropdown = document.getElementById('monthSelectDropdown');
                dateFromDisplay = document.getElementById('dateFrom');
                dateToDisplay = document.getElementById('dateTo');

                summaryTotalHours = document.getElementById('summaryTotalHours');
                summaryLate = document.getElementById('summaryLate');
                summaryAbsent = document.getElementById('summaryAbsent');
                summaryWeekend = document.getElementById('summaryWeekend');
                summaryHoliday = document.getElementById('summaryHoliday'); // New Holiday summary element
                summaryWorkingDays = document.getElementById('summaryWorkingDays');
                summaryDayShifts = document.getElementById('summaryDayShifts');
                summaryNightShifts = document.getElementById('summaryNightShifts');
                summaryGrace = document.getElementById('summaryGrace');

                attendanceTableBody = document.querySelector('#attendanceTable tbody');
                editDeleteModal = document.getElementById('editDeleteModal');
                editDeleteModalCloseBtn = editDeleteModal.querySelector('.close-button');
                editDateInput = document.getElementById('editDate');
                editStatusInput = document.getElementById('editStatus');
                editHourInput = document.getElementById('editHour');
                editExtraHourInput = document.getElementById('editExtraHour');
                editLateHourInput = document.getElementById('editLateHour');
                editShiftTypeInput = document.getElementById('editShiftType');
                editGraceInput = document.getElementById('editGrace');
                editGraceLimitMessage = document.getElementById('editGraceLimitMessage');
                updateEntryBtn = document.getElementById('updateEntryBtn');
                deleteEntryBtn = document.getElementById('deleteEntryBtn');

                editPresentDetailsGroup = document.getElementById('editPresentDetailsGroup');
                editExtraHourGroup = document.getElementById('editExtraHourGroup');
                editLateHourGroup = document.getElementById('editLateHourGroup');
                editShiftTypeGroup = document.getElementById('editShiftTypeGroup');
                editGraceGroup = document.getElementById('editGraceGroup');

                currentYearSpan = document.getElementById('currentYear');

                statusSelectionModal = document.getElementById('statusSelectionModal');
                closeStatusSelectionModal = statusSelectionModal.querySelector('.close-button');
                selectPresentBtn = document.getElementById('selectPresent');
                selectWeekendBtn = document.getElementById('selectWeekend');
                selectAbsentBtn = document.getElementById('selectAbsent');
                selectHolidayBtn = document.getElementById('selectHoliday'); // New Holiday button element

                presentEntryModal = document.getElementById('presentEntryModal');
                closePresentEntryModal = presentEntryModal.querySelector('.close-button');
                presentEntryDateInput = document.getElementById('presentEntryDate');
                presentHourInput = document.getElementById('presentHour');
                presentExtraHourInput = document.getElementById('presentExtraHour');
                presentLateInput = document.getElementById('presentLate');
                presentShiftTypeInput = document.getElementById('presentShiftType');
                presentGraceInput = document.getElementById('presentGrace');
                savePresentEntryBtn = document.getElementById('savePresentEntryBtn');
                cancelPresentEntryBtn = document.getElementById('cancelPresentEntryBtn');
                graceLimitMessage = document.getElementById('graceLimitMessage');

                homeNavLink = document.getElementById('homeNavLink');
                historyNavLink = document.getElementById('historyNavLink');
                gamesNavLink = document.getElementById('gamesNavLink');
                typingTestNavLink = document.getElementById('typingTestNavLink');
                helpNavLinkRef = document.getElementById('helpNavLink'); 
                dashboardSection = document.getElementById('dashboardSection');
                monthlySummarySection = document.getElementById('monthlySummarySection');
                dailyEntriesSection = document.getElementById('dailyEntriesSection');
                historySection = document.getElementById('historySection');
                gamesSection = document.getElementById('gamesSection');
                typingTestSection = document.getElementById('typingTestSection');

                historyDateFromInput = document.getElementById('historyDateFrom');
                historyDateToInput = document.getElementById('historyDateTo');
                findHistoryResultBtn = document.getElementById('findHistoryResultBtn');
                historySummaryTotalHours = document.getElementById('historySummaryTotalHours');
                historySummaryLate = document.getElementById('historySummaryLate');
                historySummaryAbsent = document.getElementById('historySummaryAbsent');
                historySummaryWeekend = document.getElementById('historySummaryWeekend');
                historySummaryHoliday = document.getElementById('historySummaryHoliday'); // New Holiday summary element for history
                historySummaryWorkingDays = document.getElementById('historySummaryWorkingDays');
                historySummaryDayShifts = document.getElementById('historySummaryDayShifts');
                historySummaryNightShifts = document.getElementById('historySummaryNightShifts');
                historySummaryGrace = document.getElementById('historySummaryGrace');
                historyAttendanceTableBody = document.querySelector('#historyAttendanceTable tbody');

                ticTacToeModal = document.getElementById('ticTacToeModal');
                closeTicTacToeModal = ticTacToeModal.querySelector('.close-button');
                ticTacToeGameOptions = document.getElementById('ticTacToeGameOptions');
                playVsComputerBtn = document.getElementById('playVsComputer');
                playVsPlayerBtn = document.getElementById('playVsPlayer');
                ticTacToeGameArea = document.getElementById('ticTacToeGameArea');
                ticTacToeBoard = document.getElementById('ticTacToeBoard');
                ticTacToeCells = document.querySelectorAll('#ticTacToeBoard .cell');
                ticTacToeGameStatus = document.getElementById('ticTacToeGameStatus');
                ticTacToeResetGameBtn = document.getElementById('ticTacToeResetGame');
                ticTacToeWinsDisplay = document.getElementById('ticTacToeWins');
                ticTacToeLossesDisplay = document.getElementById('ticTacToeLosses');
                ticTacToeDrawsDisplay = document.getElementById('ticTacToeDraws');

                paragraphDisplay = document.getElementById('paragraphDisplay');
                typingInput = document.getElementById('typingInput');
                wpmDisplay = document.getElementById('wpmDisplay');
                accuracyDisplay = document.getElementById('accuracyDisplay');
                startTestBtn = document.getElementById('startTest');
                resetTestBtn = document.getElementById('resetTest');
                levelEasyBtn = document.getElementById('levelEasy');
                levelNormalBtn = document.getElementById('levelNormal');
                levelHardBtn = document.getElementById('levelHard');
                testResultsList = document.getElementById('testResultsList');
                testDurationSelect = document.getElementById('testDuration'); // New element
                timeLeftDisplay = document.getElementById('timeLeftDisplay'); // New element
                highestWPMDisplay = document.getElementById('highestWPMDisplay'); // New element
                paragraphHeadlineSelect = document.getElementById('paragraphHeadlineSelect'); // New element
            }


            // --- Theme Management ---
            function applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                if (themeToggle) { // Ensure themeToggle is available
                    // Update icon based on the current theme
                    if (theme === 'light') {
                        themeToggle.className = 'fas fa-sun';
                    } else if (theme === 'dark') {
                        themeToggle.className = 'fas fa-moon';
                    } else if (theme === 'sunset-glow') {
                        themeToggle.className = 'fas fa-cloud-sun'; // A different icon for the new theme
                    } else if (theme === 'neon') {
                        themeToggle.className = 'fas fa-atom'; // A different icon for neon theme
                    }
                    currentThemeIndex = themeList.indexOf(theme);
                }
            }

            function toggleTheme() {
                currentThemeIndex = (currentThemeIndex + 1) % themeList.length;
                const newTheme = themeList[currentThemeIndex];
                applyTheme(newTheme);
            }

            // --- Custom Alert/Confirm Modal Functions ---
            function showCustomAlert(title, message, type = 'info') {
                if (customAlertModal) { // Ensure modal exists
                    customAlertTitle.textContent = title;
                    customAlertMessage.textContent = message;
                    customAlertModal.querySelector('.modal-content').className = 'modal-content ' + type;
                    customAlertModal.style.display = 'flex';
                }
            }

            function closeCustomAlertModalFunc() {
                if (customAlertModal) { // Ensure modal exists
                    customAlertModal.style.display = 'none';
                }
            }

            function showCustomConfirm(title, message, onConfirm) {
                if (customConfirmModal) { // Ensure modal exists
                    customConfirmTitle.textContent = title;
                    customConfirmMessage.textContent = message;
                    customConfirmModal.querySelector('.modal-content').className = 'modal-content info';
                    confirmCallback = onConfirm;
                    customConfirmModal.style.display = 'flex';
                }
            }

            function closeCustomConfirmModalFunc() {
                if (customConfirmModal) { // Ensure modal exists
                    customConfirmModal.style.display = 'none';
                    confirmCallback = null;
                }
            }

            function setupMainApp() {
                if (currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();
                
                window.addEventListener('scroll', () => {
                    if (mainNavbar) {
                        if (window.scrollY > 50) {
                            mainNavbar.classList.add('scrolled');
                        } else {
                            mainNavbar.classList.remove('scrolled');
                        }
                    }
                });

                if (usernameDisplay && usernameDisplay.parentElement) {
                    usernameDisplay.parentElement.addEventListener('click', () => {
                        usernameDisplay.parentElement.classList.toggle('active');
                    });
                }

                if (personalProfileBtn) {
                    personalProfileBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        openProfileModal();
                        if (usernameDisplay && usernameDisplay.parentElement) {
                            usernameDisplay.parentElement.classList.remove('active');
                        }
                    });
                }

                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        logout();
                    });
                }

                if (profileModalCloseBtn) profileModalCloseBtn.addEventListener('click', closeProfileModal);
                if (profileModal) {
                    profileModal.addEventListener('click', (event) => {
                        if (event.target == profileModal) {
                            closeProfileModal();
                        }
                    });
                }

                if (profilePictureInput) profilePictureInput.addEventListener('change', handleProfilePictureChange);
                if (saveProfileBtn) saveProfileBtn.addEventListener('click', saveProfileChanges);

                // Removed event listeners for prevMonthBtn and nextMonthBtn
                if (monthSelectDropdown) {
                    monthSelectDropdown.addEventListener('change', (e) => {
                        const [year, month] = e.target.value.split('-').map(Number);
                        currentMonthView = new Date(year, month - 1, 1); // Set to the first day of the selected month
                        setupMonthView(currentMonthView);
                    });
                }
                
                if (closeStatusSelectionModal) closeStatusSelectionModal.addEventListener('click', closeStatusSelectionModalFunc);
                if (statusSelectionModal) {
                    statusSelectionModal.addEventListener('click', (event) => {
                        if (event.target == statusSelectionModal) {
                            closeStatusSelectionModalFunc();
                        }
                    });
                }
                if (selectPresentBtn) selectPresentBtn.addEventListener('click', () => openPresentEntryModal('Present'));
                if (selectWeekendBtn) selectWeekendBtn.addEventListener('click', () => setAttendanceStatus('Weekend'));
                if (selectAbsentBtn) selectAbsentBtn.addEventListener('click', () => setAttendanceStatus('Absent'));
                if (selectHolidayBtn) selectHolidayBtn.addEventListener('click', () => setAttendanceStatus('Holiday')); // Event listener for new Holiday button

                if (closePresentEntryModal) closePresentEntryModal.addEventListener('click', closePresentEntryModalFunc);
                if (presentEntryModal) {
                    presentEntryModal.addEventListener('click', (event) => {
                        if (event.target == presentEntryModal) {
                            closePresentEntryModalFunc();
                        }
                        if (event.target.closest('.modal-content')) {
                            event.stopPropagation();
                        }
                    });
                }
                if (presentHourInput && presentExtraHourInput && presentLateInput) {
                    const updateLate = () => {
                        presentLateInput.value = calculateLateTime(parseFloat(presentHourInput.value || 0));
                    };
                    presentHourInput.addEventListener('input', updateLate);
                }
                if (presentGraceInput) {
                    presentGraceInput.addEventListener('change', () => {
                        if (presentGraceInput.value === 'Yes') {
                            const currentMonthKey = `${currentMonthView.getFullYear()}-${String(currentMonthView.getMonth() + 1).padStart(2, '0')}`;
                            const graceUsed = currentLoggedInUser.graceCounts[currentMonthKey] || 0;
                            if (graceUsed >= 5) {
                                if (graceLimitMessage) graceLimitMessage.style.display = 'block';
                                presentGraceInput.value = '-';
                            } else {
                                if (graceLimitMessage) graceLimitMessage.style.display = 'none';
                            }
                        } else {
                            if (graceLimitMessage) graceLimitMessage.style.display = 'none';
                        }
                    });
                }
                if (savePresentEntryBtn) savePresentEntryBtn.addEventListener('click', savePresentEntry);
                if (cancelPresentEntryBtn) cancelPresentEntryBtn.addEventListener('click', closePresentEntryModalFunc);


                if (closeEditDeleteModal) closeEditDeleteModal.addEventListener('click', closeEditDeleteModalFunc);
                if (editDeleteModal) {
                    editDeleteModal.addEventListener('click', (event) => {
                        if (event.target == editDeleteModal) {
                            closeEditDeleteModalFunc();
                        }
                        if (event.target.closest('.modal-content')) {
                            event.stopPropagation();
                        }
                    });
                }
                if (editHourInput && editExtraHourInput && editLateHourInput) {
                    const updateEditLate = () => {
                        editLateHourInput.value = calculateLateTime(parseFloat(editHourInput.value || 0));
                    };
                    editHourInput.addEventListener('input', updateEditLate);
                }
                if (editStatusInput) {
                    editStatusInput.addEventListener('change', toggleEditPresentDetails);
                }
                if (editGraceInput) {
                    editGraceInput.addEventListener('change', () => {
                        if (editGraceInput.value === 'Yes') {
                            const currentMonthKey = `${new Date(editDateInput.value).getFullYear()}-${String(new Date(editDateInput.value).getMonth() + 1).padStart(2, '0')}`; // Use date from editDateInput
                            const graceUsed = currentLoggedInUser.graceCounts[currentMonthKey] || 0;
                            const originalEntry = currentLoggedInUser.attendance[editDateInput.value]; // Use editDateInput.value for the current editing date
                            const wasGrace = originalEntry && originalEntry.status === 'Present' && originalEntry.grace === 'Yes';

                            if (graceUsed >= 5 && !wasGrace) {
                                if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'block';
                                editGraceInput.value = '-';
                            } else {
                                if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';
                            }
                        } else {
                            if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';
                        }
                    });
                }
                if (updateEntryBtn) updateEntryBtn.addEventListener('click', updateAttendanceEntry);
                if (deleteEntryBtn) deleteEntryBtn.addEventListener('click', confirmDeleteEntry);

                if (homeNavLink) homeNavLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection('dashboard');
                });
                if (historyNavLink) historyNavLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection('history');
                });
                if (gamesNavLink) {
                    gamesNavLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        showSection('games');
                    });
                }
                if (typingTestNavLink) {
                    typingTestNavLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        showSection('typingTest');
                        // No need to clear typing history on navigation, it's user-specific
                        // clearTypingHistory(); 
                        populateParagraphHeadlines(); // Populate headlines based on current level
                        loadNewParagraph(); // Load new paragraph when navigating to the section
                        displayTypingResults();
                        updateHighestWPMDisplay(); // Update highest WPM display
                    });
                }
                if (helpNavLinkRef) {
                    helpNavLinkRef.addEventListener('click', (e) => {
                        e.preventDefault();
                        openHelpModal();
                    });
                }

                if (findHistoryResultBtn) findHistoryResultBtn.addEventListener('click', displayCustomHistorySummary);

                if (customAlertOkBtn) customAlertOkBtn.addEventListener('click', closeCustomAlertModalFunc);
                if (closeCustomAlertModal) closeCustomAlertModal.addEventListener('click', closeCustomAlertModalFunc);
                if (customAlertModal) {
                    customAlertModal.addEventListener('click', (event) => {
                        if (event.target == customAlertModal) {
                            closeCustomAlertModalFunc();
                        }
                    });
                }

                if (customConfirmYesBtn) customConfirmYesBtn.addEventListener('click', () => {
                    if (confirmCallback) {
                        confirmCallback(true);
                    }
                    closeCustomConfirmModalFunc();
                });
                if (customConfirmNoBtn) customConfirmNoBtn.addEventListener('click', () => {
                    if (confirmCallback) {
                        confirmCallback(false);
                    }
                    closeCustomConfirmModalFunc();
                });
                if (closeCustomConfirmModal) closeCustomConfirmModal.addEventListener('click', closeCustomConfirmModalFunc);
                if (customConfirmModal) {
                    customConfirmModal.addEventListener('click', (event) => {
                        if (event.target == customConfirmModal) {
                            closeCustomConfirmModalFunc();
                        }
                    });
                }

                if (themeToggle) {
                    themeToggle.addEventListener('click', toggleTheme);
                }

                if (closeHelpModal) closeHelpModal.addEventListener('click', closeHelpModalFunc);
                if (helpModal) {
                    helpModal.addEventListener('click', (event) => {
                        if (event.target == helpModal) {
                            closeHelpModalFunc();
                        }
                    });
                }

                document.getElementById('ticTacToeGameCard').addEventListener('click', () => {
                    openTicTacToeModal();
                });
                if (playVsComputerBtn) playVsComputerBtn.addEventListener('click', () => startTicTacToeGame(true));
                if (playVsPlayerBtn) playVsPlayerBtn.addEventListener('click', () => startTicTacToeGame(false));
                if (ticTacToeCells) ticTacToeCells.forEach(cell => cell.addEventListener('click', handleTicTacToeCellClick));
                if (ticTacToeResetGameBtn) ticTacToeResetGameBtn.addEventListener('click', resetTicTacToeGame);
                if (closeTicTacToeModal) closeTicTacToeModal.addEventListener('click', closeTicTacToeModalFunc);
                if (ticTacToeModal) {
                    ticTacToeModal.addEventListener('click', (event) => {
                        if (event.target == ticTacToeModal) {
                            closeTicTacToeModalFunc();
                        }
                    });
                }

                if (startTestBtn) startTestBtn.addEventListener('click', startTypingTest);
                if (resetTestBtn) resetTestBtn.addEventListener('click', resetTypingTest);

                if (levelEasyBtn) levelEasyBtn.addEventListener('click', () => {
                    currentLevel = 'easy';
                    [levelEasyBtn, levelNormalBtn, levelHardBtn].forEach(btn => btn.classList.remove('active'));
                    levelEasyBtn.classList.add('active');
                    populateParagraphHeadlines(); // Update headlines for new level
                    resetTypingTest();
                });
                if (levelNormalBtn) levelNormalBtn.addEventListener('click', () => {
                    currentLevel = 'normal';
                    [levelEasyBtn, levelNormalBtn, levelHardBtn].forEach(btn => btn.classList.remove('active'));
                    levelNormalBtn.classList.add('active');
                    populateParagraphHeadlines(); // Update headlines for new level
                    resetTypingTest();
                });
                if (levelHardBtn) levelHardBtn.addEventListener('click', () => {
                    currentLevel = 'hard';
                    [levelEasyBtn, levelNormalBtn, levelHardBtn].forEach(btn => btn.classList.remove('active'));
                    levelHardBtn.classList.add('active');
                    populateParagraphHeadlines(); // Update headlines for new level
                    resetTypingTest();
                });

                if (paragraphHeadlineSelect) paragraphHeadlineSelect.addEventListener('change', loadNewParagraph); // Listen for headline change
                if (typingInput) typingInput.addEventListener('input', handleTypingInput);
                if (testDurationSelect) testDurationSelect.addEventListener('change', resetTypingTest); // Reset test when duration changes
            }

            // --- Section Visibility Control ---
            function showSection(sectionName) {
                if (dashboardSection) dashboardSection.style.display = 'none';
                if (monthlySummarySection) monthlySummarySection.style.display = 'none';
                if (dailyEntriesSection) dailyEntriesSection.style.display = 'none';
                if (historySection) historySection.style.display = 'none';
                if (gamesSection) gamesSection.style.display = 'none';
                if (typingTestSection) typingTestSection.style.display = 'none';

                if (sectionName === 'dashboard') {
                    if (dashboardSection) dashboardSection.style.display = 'flex';
                    if (monthlySummarySection) monthlySummarySection.style.display = 'block';
                    if (dailyEntriesSection) dailyEntriesSection.style.display = 'block';
                    setupMonthView(currentMonthView);
                } else if (sectionName === 'history') {
                    if (historySection) historySection.style.display = 'block';
                    if (historySummaryTotalHours) historySummaryTotalHours.textContent = '0';
                    if (historySummaryLate) historySummaryLate.textContent = '0';
                    if (historySummaryAbsent) historySummaryAbsent.textContent = '0';
                    if (historySummaryWeekend) historySummaryWeekend.textContent = '0';
                    if (historySummaryHoliday) historySummaryHoliday.textContent = '0'; // Reset Holiday summary
                    if (historySummaryWorkingDays) historySummaryWorkingDays.textContent = '0';
                    if (historySummaryDayShifts) historySummaryDayShifts.textContent = '0';
                    if (historySummaryNightShifts) historySummaryNightShifts.textContent = '0';
                    if (historySummaryGrace) historySummaryGrace.textContent = '0';
                    if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';
                } else if (sectionName === 'games') {
                    if (gamesSection) gamesSection.style.display = 'block';
                } else if (sectionName === 'typingTest') {
                    if (typingTestSection) typingTestSection.style.display = 'block';
                }
            }


            // --- Functions (Shared & Main App) ---

            function calculateWorkedFor(joiningDateStr) {
                if (!joiningDateStr) return "N/A";

                const joiningDate = new Date(joiningDateStr);
                const today = new Date();

                let years = today.getFullYear() - joiningDate.getFullYear();
                let months = today.getMonth() - joiningDate.getMonth();
                let days = today.getDate() - joiningDate.getDate();

                if (days < 0) {
                    months--;
                    days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
                }

                if (months < 0) {
                    years--;
                    months += 12;
                }
                return `${years} years ${months} months`;
            }

            function updateUserProfileDisplay() {
                if (!currentLoggedInUser) return;

                const displayName = currentLoggedInUser.profileName || currentLoggedInUser.username || currentLoggedInUser.email.split('@')[0] || 'User';
                const displayPhoto = currentLoggedInUser.photo || `https://placehold.co/40x40/000000/ffffff?text=${displayName.charAt(0).toUpperCase()}`;

                if (usernameDisplay) usernameDisplay.textContent = displayName;
                if (userPhotoDisplay) userPhotoDisplay.src = displayPhoto;
                
                if (dashboardUserPhoto) dashboardUserPhoto.src = currentLoggedInUser.photo || `https://placehold.co/150x150/000000/ffffff?text=${displayName.charAt(0).toUpperCase()}`;
                if (dashboardUsername) dashboardUsername.textContent = displayName;
                if (workedForDisplay) workedForDisplay.textContent = calculateWorkedFor(currentLoggedInUser.joiningDate);
                if (lngIdDisplay) lngIdDisplay.textContent = currentLoggedInUser.lngId || 'N/A';

                if (emailInput) emailInput.value = currentLoggedInUser.email || '';
                if (profileNameInput) profileNameInput.value = currentLoggedInUser.profileName || '';
                if (usernameInput) usernameInput.value = currentLoggedInUser.username || '';
                if (profileJoiningDateInput) profileJoiningDateInput.value = currentLoggedInUser.joiningDate || '';
                if (profileLngIdInput) profileLngIdInput.value = currentLoggedInUser.lngId || '';
                if (profilePicturePreview) profilePicturePreview.src = currentLoggedInUser.photo || `https://placehold.co/100x100/000000/ffffff?text=${displayName.charAt(0).toUpperCase()}`;
            }

            function openProfileModal() {
                if (profileModal) profileModal.style.display = 'flex';
                updateUserProfileDisplay(); // Ensure latest data is loaded into modal
            }

            function closeProfileModal() {
                if (profileModal) profileModal.style.display = 'none';
            }

            function saveProfileChanges() {
                if (!currentLoggedInUser) return;

                const updatedProfile = {
                    profileName: profileNameInput.value.trim(),
                    username: usernameInput.value.trim(),
                    joiningDate: profileJoiningDateInput.value,
                    lngId: profileLngIdInput.value.trim(),
                    photo: profilePicturePreview.src // Use the preview src
                };

                // Update current logged-in user object
                currentLoggedInUser = { ...currentLoggedInUser, ...updatedProfile };
                saveCurrentUserData(); // Save to localStorage (updates the specific user in registeredUsers)

                updateUserProfileDisplay();
                showCustomAlert('Profile Update', 'Profile updated successfully!', 'success');
                closeProfileModal();
            }

            function handleProfilePictureChange(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (profilePicturePreview) profilePicturePreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }

            function logout() {
                localStorage.removeItem('lastLoggedInUserEmail'); // Clear logged in user session
                currentLoggedInUser = null; // Clear current user data
                showAuthSection(); // Go back to login page
                showCustomAlert('Logged Out', 'You have been successfully logged out.', 'info');
            }

            function getMonthRange(date) {
                const year = date.getFullYear();
                const month = date.getMonth(); // 0-indexed

                // Start date is 26th of previous month
                const startDate = new Date(year, month - 1, 26);
                // End date is 25th of current month
                const endDate = new Date(year, month, 25);

                return { start: startDate, end: endDate };
            }

            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function formatDisplayDate(date) {
                return new Date(date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            function populateMonthDropdown() {
                if (!monthSelectDropdown) return;

                monthSelectDropdown.innerHTML = ''; // Clear existing options
                const today = new Date();
                const currentMonth = today.getMonth(); // 0-indexed
                const currentYear = today.getFullYear();

                // Add previous 6 months and next 6 months
                for (let i = -6; i <= 6; i++) {
                    const date = new Date(currentYear, currentMonth + i, 1);
                    const optionValue = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const optionText = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionText;

                    // Select the current month in the dropdown
                    if (date.getFullYear() === currentMonthView.getFullYear() && date.getMonth() === currentMonthView.getMonth()) {
                        option.selected = true;
                    }
                    monthSelectDropdown.appendChild(option);
                }
            }

            function setupMonthView(date) {
                const { start, end } = getMonthRange(date);
                // currentMonthDisplay is removed, so we don't update it
                if (dateFromDisplay) dateFromDisplay.textContent = formatDisplayDate(start);
                if (dateToDisplay) dateToDisplay.textContent = formatDisplayDate(end);
                displayAttendanceHistory();
            }

            function calculateLateTime(hour) {
                const standardHour = 9;
                if (hour < standardHour) {
                    const diffMinutes = (standardHour - hour) * 60;
                    const hours = Math.floor(diffMinutes / 60);
                    const minutes = Math.round(diffMinutes % 60);
                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                }
                return "00:00";
            }

            function getGraceCount(monthKey) {
                if (!currentLoggedInUser || !currentLoggedInUser.graceCounts) return 0;
                return currentLoggedInUser.graceCounts[monthKey] || 0;
            }

            function updateGraceCount(monthKey, increment) {
                let newGraceCounts = { ...(currentLoggedInUser.graceCounts || {}) };
                newGraceCounts[monthKey] = (newGraceCounts[monthKey] || 0) + increment;
                currentLoggedInUser.graceCounts = newGraceCounts; // Update current user's grace counts
                saveCurrentUserData(); // Save the updated current user data
            }

            function checkGraceLimit(monthKey) {
                return getGraceCount(monthKey) >= 5;
            }

            function openStatusSelectionModal(dateKey) {
                currentSelectedDateForStatus = dateKey;
                if (statusSelectionModal) statusSelectionModal.style.display = 'flex';
            }

            function closeStatusSelectionModalFunc() {
                if (statusSelectionModal) statusSelectionModal.style.display = 'none';
                currentSelectedDateForStatus = null;
            }

            function openPresentEntryModal(status) {
                closeStatusSelectionModalFunc();
                if (presentEntryModal) {
                    presentEntryDateInput.value = currentSelectedDateForStatus;
                    
                    const existingEntry = currentLoggedInUser.attendance[currentSelectedDateForStatus];
                    if (existingEntry && existingEntry.status === 'Present') {
                        presentHourInput.value = existingEntry.hour;
                        presentExtraHourInput.value = existingEntry.extraHour;
                        presentLateInput.value = existingEntry.late;
                        presentShiftTypeInput.value = existingEntry.shift;
                        presentGraceInput.value = existingEntry.grace || '-';
                    } else {
                        presentHourInput.value = 9;
                        presentExtraHourInput.value = 0;
                        presentLateInput.value = '00:00';
                        presentShiftTypeInput.value = 'Day';
                        presentGraceInput.value = '-';
                    }

                    const monthKey = `${new Date(currentSelectedDateForStatus).getFullYear()}-${String(new Date(currentSelectedDateForStatus).getMonth() + 1).padStart(2, '0')}`;
                    const graceLimitReached = checkGraceLimit(monthKey);
                    
                    if (presentGraceInput.querySelector('option[value="Yes"]')) {
                        const originalEntry = currentLoggedInUser.attendance[currentSelectedDateForStatus];
                        const wasGrace = originalEntry && originalEntry.status === 'Present' && originalEntry.grace === 'Yes';
                        if (graceLimitReached && !wasGrace) {
                            presentGraceInput.querySelector('option[value="Yes"]').disabled = true;
                            if (graceLimitMessage) graceLimitMessage.style.display = 'block';
                        } else {
                            presentGraceInput.querySelector('option[value="Yes"]').disabled = false;
                            if (graceLimitMessage) graceLimitMessage.style.display = 'none';
                        }
                    }

                    presentEntryModal.style.display = 'flex';
                    presentLateInput.value = calculateLateTime(parseFloat(presentHourInput.value || 0));
                }
            }

            function closePresentEntryModalFunc() {
                if (presentEntryModal) presentEntryModal.style.display = 'none';
                currentSelectedDateForStatus = null;
            }

            function savePresentEntry() {
                const date = presentEntryDateInput.value;
                const hour = parseFloat(presentHourInput.value);
                const extraHour = parseFloat(presentExtraHourInput.value);
                const shift = presentShiftTypeInput.value;
                const grace = presentGraceInput.value;
                const late = calculateLateTime(hour);

                if (isNaN(hour) || hour < 0 || hour > 24) {
                    showCustomAlert('Input Error', "Please enter a valid hour (0-24).", 'error');
                    return;
                }
                if (isNaN(extraHour) || extraHour < 0 || extraHour > 24) {
                    showCustomAlert('Input Error', "Please enter a valid extra hour (0-24).", 'error');
                    return;
                }

                const monthKey = `${new Date(date).getFullYear()}-${String(new Date(date).getMonth() + 1).padStart(2, '0')}`;
                const existingEntry = currentLoggedInUser.attendance[date];
                const wasGrace = existingEntry && existingEntry.status === 'Present' && existingEntry.grace === 'Yes';
                const isGraceNow = grace === 'Yes';

                if (isGraceNow && !wasGrace && checkGraceLimit(monthKey)) {
                    showCustomAlert('Grace Limit Reached', "Cannot apply grace. Monthly limit (5) reached.", 'warning');
                    return;
                }

                const newEntry = {
                    status: 'Present',
                    hour: hour,
                    extraHour: extraHour,
                    late: late,
                    shift: shift,
                    grace: grace
                };

                // Update grace count if grace status changes
                if (isGraceNow && !wasGrace) {
                    updateGraceCount(monthKey, 1);
                } else if (!isGraceNow && wasGrace) {
                    updateGraceCount(monthKey, -1);
                }

                // Update attendance entry in current user's data
                currentLoggedInUser.attendance = { ...currentLoggedInUser.attendance, [date]: newEntry };
                saveCurrentUserData(); // Save the updated current user data

                // Removed: showCustomAlert('Success!', 'Present entry saved successfully!', 'success');
                closePresentEntryModalFunc();
                displayAttendanceHistory();
            }

            function setAttendanceStatus(status) {
                const date = currentSelectedDateForStatus;
                const monthKey = `${new Date(date).getFullYear()}-${String(new Date(date).getMonth() + 1).padStart(2, '0')}`;
                const existingEntry = currentLoggedInUser.attendance[date];
                const wasPresent = existingEntry && existingEntry.status === 'Present';
                const wasGrace = wasPresent && existingEntry.grace === 'Yes';

                const newEntry = { status: status };

                if (wasPresent && wasGrace && status !== 'Present') {
                    updateGraceCount(monthKey, -1);
                }
                
                currentLoggedInUser.attendance = { ...currentLoggedInUser.attendance, [date]: newEntry };
                saveCurrentUserData(); // Save the updated current user data

                // Removed: showCustomAlert('Status Updated', `Status set to ${status} for ${formatDisplayDate(new Date(date))}`, 'success');
                closeStatusSelectionModalFunc();
                displayAttendanceHistory();
            }

            function displayAttendanceHistory() {
                if (!attendanceTableBody || !currentLoggedInUser) return;

                attendanceTableBody.innerHTML = '';
                const { start, end } = getMonthRange(currentMonthView);

                const currentUserAttendance = currentLoggedInUser.attendance || {};

                let totalHours = 0;
                let totalLateMinutes = 0;
                let totalAbsentDays = 0;
                let totalWeekendDays = 0;
                let totalHolidayDays = 0; // New variable for holidays
                let totalWorkingDays = 0; // This will now count Present and Absent days
                let totalDayShifts = 0;
                let totalNightShifts = 0;
                let totalGraceDays = 0;

                let currentDate = new Date(start);
                while (currentDate <= end) {
                    const dateKey = formatDate(currentDate);
                    const entry = currentUserAttendance[dateKey];

                    const row = attendanceTableBody.insertRow();
                    const cellDate = row.insertCell();
                    const cellStatus = row.insertCell();
                    const cellHour = row.insertCell();
                    const cellExtraHour = row.insertCell();
                    const cellLate = row.insertCell();
                    const cellShift = row.insertCell();
                    const cellGrace = row.insertCell();
                    const cellActions = row.insertCell();

                    cellDate.textContent = formatDisplayDate(currentDate);
                    cellStatus.className = '';

                    if (entry && entry.status) {
                        cellStatus.textContent = entry.status;
                        cellStatus.classList.add(`status-${entry.status.toLowerCase()}`);

                        if (entry.status === 'Present') {
                            cellHour.textContent = entry.hour;
                            cellExtraHour.textContent = entry.extraHour;
                            cellLate.textContent = entry.late;
                            cellShift.textContent = entry.shift;
                            cellGrace.textContent = entry.grace || '-';

                            totalHours += entry.hour + entry.extraHour;
                            const [lateHours, lateMinutes] = entry.late.split(':').map(Number);
                            totalLateMinutes += (lateHours * 60) + lateMinutes;

                            if (entry.shift === 'Day') totalDayShifts++;
                            else if (entry.shift === 'Night') totalNightShifts++;
                            totalWorkingDays++; // Count Present as working day
                            if (entry.grace === 'Yes') totalGraceDays++;
                        } else {
                            cellHour.textContent = '-';
                            cellExtraHour.textContent = '-';
                            cellLate.textContent = '-';
                            cellShift.textContent = '-';
                            cellGrace.textContent = '-';
                            if (entry.status === 'Absent') {
                                totalAbsentDays++;
                                totalWorkingDays++; // Count Absent as working day
                            } else if (entry.status === 'Weekend') {
                                totalWeekendDays++;
                                // Weekend is not a working day, so no increment to totalWorkingDays
                            } else if (entry.status === 'Holiday') { // Handle new Holiday status
                                totalHolidayDays++;
                                // Holiday is not a working day
                            }
                        }
                    } else {
                        // If no entry, assume it's a regular day that hasn't been marked.
                        // For this calculation, we only count explicitly marked Present/Absent days as working days.
                        cellStatus.textContent = '-';
                        cellHour.textContent = '-';
                        cellExtraHour.textContent = '-';
                        cellLate.textContent = '-';
                        cellShift.textContent = '-';
                        cellGrace.textContent = '-';
                    }

                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.classList.add('premium-button');
                    editBtn.dataset.date = dateKey;
                    editBtn.onclick = openEditModal;

                    cellActions.classList.add('table-actions');
                    cellActions.appendChild(editBtn);

                    currentDate.setDate(currentDate.getDate() + 1);
                }

                if (summaryTotalHours) summaryTotalHours.textContent = totalHours;
                const formattedLateTime = `${String(Math.floor(totalLateMinutes / 60)).padStart(2, '0')}:${String(totalLateMinutes % 60).padStart(2, '0')}`;
                if (summaryLate) summaryLate.textContent = formattedLateTime;
                if (summaryAbsent) summaryAbsent.textContent = totalAbsentDays;
                if (summaryWeekend) summaryWeekend.textContent = totalWeekendDays;
                if (summaryHoliday) summaryHoliday.textContent = totalHolidayDays; // Display total holidays
                if (summaryWorkingDays) summaryWorkingDays.textContent = totalWorkingDays;
                if (summaryDayShifts) summaryDayShifts.textContent = totalDayShifts;
                // Update combined Night Shifts and Grace
                if (summaryNightShifts) summaryNightShifts.textContent = totalNightShifts;
                if (summaryGrace) summaryGrace.textContent = totalGraceDays;
            }


            function openEditModal(event) {
                const dateToEdit = event.target.dataset.date;
                const entry = currentLoggedInUser.attendance[dateToEdit];

                if (editDateInput) editDateInput.value = dateToEdit;

                if (entry) {
                    if (editStatusInput) editStatusInput.value = entry.status;
                    if (entry.status === 'Present') {
                        if (editHourInput) editHourInput.value = entry.hour;
                        if (editExtraHourInput) editExtraHourInput.value = entry.extraHour;
                        if (editLateHourInput) editLateHourInput.value = entry.late;
                        if (editShiftTypeInput) editShiftTypeInput.value = entry.shift;
                        if (editGraceInput) editGraceInput.value = entry.grace || '-';
                    } else {
                        if (editHourInput) editHourInput.value = '';
                        if (editExtraHourInput) editExtraHourInput.value = '';
                        if (editLateHourInput) editLateHourInput.value = '00:00';
                        if (editShiftTypeInput) editShiftTypeInput.value = 'Day';
                        if (editGraceInput) editGraceInput.value = '-';
                    }
                } else {
                    if (editStatusInput) editStatusInput.value = 'Absent'; 
                    if (editHourInput) editHourInput.value = '';
                    if (editExtraHourInput) editExtraHourInput.value = '';
                    if (editLateHourInput) editLateHourInput.value = '00:00';
                    if (editShiftTypeInput) editShiftTypeInput.value = 'Day';
                    if (editGraceInput) editGraceInput.value = '-';
                }

                toggleEditPresentDetails();

                const monthKey = `${new Date(dateToEdit).getFullYear()}-${String(new Date(dateToEdit).getMonth() + 1).padStart(2, '0')}`;
                const graceLimitReached = checkGraceLimit(monthKey);
                const originalGraceStatus = entry && entry.status === 'Present' && entry.grace === 'Yes';

                if (editGraceInput) {
                    if (graceLimitReached && !originalGraceStatus) {
                        editGraceInput.querySelector('option[value="Yes"]').disabled = true;
                        if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'block';
                    } else {
                        editGraceInput.querySelector('option[value="Yes"]').disabled = false;
                        if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';
                    }
                }
                
                if (editDeleteModal) editDeleteModal.style.display = 'flex';
            }

            function closeEditDeleteModalFunc() {
                if (editDeleteModal) editDeleteModal.style.display = 'none';
            }

            function toggleEditPresentDetails() {
                const isPresent = editStatusInput.value === 'Present';
                if (editPresentDetailsGroup) editPresentDetailsGroup.style.display = isPresent ? 'block' : 'none';
                if (editExtraHourGroup) editExtraHourGroup.style.display = isPresent ? 'block' : 'none';
                if (editLateHourGroup) editLateHourGroup.style.display = isPresent ? 'block' : 'none';
                if (editShiftTypeGroup) editShiftTypeGroup.style.display = isPresent ? 'block' : 'none';
                if (editGraceGroup) editGraceGroup.style.display = isPresent ? 'block' : 'none';
            }

            function updateAttendanceEntry() {
                const date = editDateInput.value;
                if (!date || !currentLoggedInUser) return;

                const status = editStatusInput.value;
                const monthKey = `${new Date(date).getFullYear()}-${String(new Date(date).getMonth() + 1).padStart(2, '0')}`;
                const existingEntry = currentLoggedInUser.attendance[date];
                const wasPresent = existingEntry && existingEntry.status === 'Present';
                const wasGrace = wasPresent && existingEntry.grace === 'Yes';

                let updatedEntry = { status: status };

                if (status === 'Present') {
                    const updatedHour = parseFloat(editHourInput.value);
                    const updatedExtraHour = parseFloat(editExtraHourInput.value);
                    const updatedShift = editShiftTypeInput.value;
                    const updatedGrace = editGraceInput.value;
                    const updatedLate = calculateLateTime(updatedHour);

                    if (isNaN(updatedHour) || updatedHour < 0 || updatedHour > 24 ||
                        isNaN(updatedExtraHour) || updatedExtraHour < 0 || updatedExtraHour > 24) {
                        showCustomAlert('Input Error', "Please enter valid hour and extra hour values (0-24) for Present status.", 'error');
                        return;
                    }

                    const isGraceNow = updatedGrace === 'Yes';
                    if (isGraceNow && !wasGrace && checkGraceLimit(monthKey)) {
                        showCustomAlert('Grace Limit Reached', "Cannot apply grace. Monthly limit (5) reached.", 'warning');
                        return;
                    }

                    updatedEntry = {
                        status: 'Present',
                        hour: updatedHour,
                        extraHour: updatedExtraHour,
                        late: updatedLate,
                        shift: updatedShift,
                        grace: updatedGrace
                    };

                    if (isGraceNow && !wasGrace) {
                        updateGraceCount(monthKey, 1);
                    } else if (!isGraceNow && wasGrace) {
                        updateGraceCount(monthKey, -1);
                    }
                } else {
                    if (wasPresent && wasGrace) {
                        updateGraceCount(monthKey, -1);
                    }
                }

                currentLoggedInUser.attendance = { ...currentLoggedInUser.attendance, [date]: updatedEntry };
                saveCurrentUserData(); // Save the updated current user data

                // Removed: showCustomAlert('Entry Updated', 'Entry updated successfully!', 'success');
                closeEditDeleteModalFunc();
                displayAttendanceHistory();
            }

            function confirmDeleteEntry() {
                const dateToDelete = editDateInput.value;
                showCustomConfirm('Confirm Deletion', `Are you sure you want to delete ALL data for ${formatDisplayDate(new Date(dateToDelete))}?`, (confirmed) => {
                    if (confirmed) {
                        deleteAttendanceEntry(dateToDelete);
                    }
                });
            }

            function deleteAttendanceEntry(dateToDelete) {
                if (!currentLoggedInUser || !currentLoggedInUser.attendance[dateToDelete]) return;

                const existingEntry = currentLoggedInUser.attendance[dateToDelete];
                const wasPresent = existingEntry && existingEntry.status === 'Present';
                const wasGrace = wasPresent && existingEntry.grace === 'Yes';
                const monthKey = `${new Date(dateToDelete).getFullYear()}-${String(new Date(dateToDelete).getMonth() + 1).padStart(2, '0')}`;

                const updatedAttendance = { ...currentLoggedInUser.attendance };
                delete updatedAttendance[dateToDelete];
                currentLoggedInUser.attendance = updatedAttendance; // Update current user's attendance
                saveCurrentUserData(); // Save the updated current user data

                if (wasPresent && wasGrace) {
                    updateGraceCount(monthKey, -1);
                }

                showCustomAlert('Entry Deleted', 'Entry deleted successfully! Data for this date has been cleared.', 'success');
                closeEditDeleteModalFunc();
                displayAttendanceHistory();
            }

            // --- History Page Functions ---
            function displayCustomHistorySummary() {
                const startDateStr = historyDateFromInput.value;
                const endDateStr = historyDateToInput.value;

                if (!startDateStr || !endDateStr) {
                    showCustomAlert('Input Error', "Please select both 'From Date' and 'To Date'.", 'warning');
                    if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';
                    return;
                }

                const startDate = new Date(startDateStr + 'T00:00:00');
                const endDate = new Date(endDateStr + 'T00:00:00');

                if (startDate > endDate) {
                    showCustomAlert('Input Error', "'From Date' cannot be after 'To Date'.", 'error');
                    if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';
                    return;
                }

                const currentUserAttendance = currentLoggedInUser.attendance || {};

                let totalHours = 0;
                let totalLateMinutes = 0;
                let totalAbsentDays = 0;
                let totalWeekendDays = 0;
                let totalHolidayDays = 0; // New variable for holidays
                let totalWorkingDays = 0; // This will now count Present and Absent days
                let totalDayShifts = 0;
                let totalNightShifts = 0;
                let totalGraceDays = 0;

                if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';

                let currentDate = new Date(startDate);
                while (currentDate.getTime() <= endDate.getTime()) { 
                    const dateKey = formatDate(currentDate);
                    const entry = currentUserAttendance[dateKey];

                    const row = historyAttendanceTableBody.insertRow();
                    const cellDate = row.insertCell();
                    const cellStatus = row.insertCell();
                    const cellHour = row.insertCell();
                    const cellExtraHour = row.insertCell();
                    const cellLate = row.insertCell();
                    const cellShift = row.insertCell();
                    const cellGrace = row.insertCell();

                    cellDate.textContent = formatDisplayDate(currentDate);
                    cellStatus.className = '';

                    if (entry && entry.status) {
                        cellStatus.textContent = entry.status;
                        cellStatus.classList.add(`status-${entry.status.toLowerCase()}`);

                        if (entry.status === 'Present') {
                            cellHour.textContent = entry.hour;
                            cellExtraHour.textContent = entry.extraHour;
                            cellLate.textContent = entry.late;
                            cellShift.textContent = entry.shift;
                            cellGrace.textContent = entry.grace || '-';

                            totalHours += entry.hour + entry.extraHour;
                            const [lateHours, lateMinutes] = entry.late.split(':').map(Number);
                            totalLateMinutes += (lateHours * 60) + lateMinutes;

                            if (entry.shift === 'Day') totalDayShifts++;
                            else if (entry.shift === 'Night') totalNightShifts++;
                            totalWorkingDays++; // Count Present as working day
                            if (entry.grace === 'Yes') totalGraceDays++;
                        } else {
                            cellHour.textContent = '-';
                            cellExtraHour.textContent = '-';
                            cellLate.textContent = '-';
                            cellShift.textContent = '-';
                            cellGrace.textContent = '-';
                            if (entry.status === 'Absent') {
                                totalAbsentDays++;
                                totalWorkingDays++; // Count Absent as working day
                            } else if (entry.status === 'Weekend') {
                                totalWeekendDays++;
                                // Weekend is not a working day, so no increment to totalWorkingDays
                            } else if (entry.status === 'Holiday') { // Handle new Holiday status
                                totalHolidayDays++;
                                // Holiday is not a working day
                            }
                        }
                    } else {
                        // If no entry, assume it's a regular day that hasn't been marked.
                        // For this calculation, we only count explicitly marked Present/Absent days as working days.
                        cellStatus.textContent = '-';
                        cellHour.textContent = '-';
                        cellExtraHour.textContent = '-';
                        cellLate.textContent = '-';
                        cellShift.textContent = '-';
                        cellGrace.textContent = '-';
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                if (historySummaryTotalHours) historySummaryTotalHours.textContent = totalHours;
                const formattedLateTime = `${String(Math.floor(totalLateMinutes / 60)).padStart(2, '0')}:${String(totalLateMinutes % 60).padStart(2, '0')}`;
                if (historySummaryLate) historySummaryLate.textContent = formattedLateTime;
                if (historySummaryAbsent) historySummaryAbsent.textContent = totalAbsentDays;
                if (historySummaryWeekend) historySummaryWeekend.textContent = totalWeekendDays;
                if (historySummaryHoliday) historySummaryHoliday.textContent = totalHolidayDays; // Display total holidays in history
                if (historySummaryWorkingDays) historySummaryWorkingDays.textContent = totalWorkingDays;
                if (historySummaryDayShifts) historySummaryDayShifts.textContent = totalDayShifts;
                if (historySummaryNightShifts) historySummaryNightShifts.textContent = totalNightShifts;
                if (historySummaryGrace) historySummaryGrace.textContent = totalGraceDays;
            }

            // --- Help Modal Functions ---
            function openHelpModal() {
                if (helpModal) {
                    helpModal.style.display = 'flex';
                }
            }

            function closeHelpModalFunc() {
                if (helpModal) {
                    helpModal.style.display = 'none';
                }
            }

            // --- Tic-Tac-Toe Game Functions ---
            function openTicTacToeModal() {
                if (ticTacToeModal) {
                    ticTacToeModal.style.display = 'flex';
                    resetTicTacToeGame();
                    updateTicTacToeStatsDisplay(); // Display stats when modal opens
                }
            }

            function closeTicTacToeModalFunc() {
                if (ticTacToeModal) {
                    ticTacToeModal.style.display = 'none';
                    ticTacToeIsGameActive = false;
                }
            }

            function startTicTacToeGame(vsComputer) {
                ticTacToeIsVsComputer = vsComputer;
                ticTacToeGameOptions.style.display = 'none';
                ticTacToeGameArea.style.display = 'block';
                ticTacToeIsGameActive = true;
                ticTacToeCurrentPlayer = 'X';
                ticTacToeGameStatus.textContent = `Player ${ticTacToeCurrentPlayer}'s turn`;
                if (ticTacToeIsVsComputer && ticTacToeCurrentPlayer === 'O') {
                    setTimeout(ticTacToeComputerMove, 500);
                }
            }

            function handleTicTacToeCellClick(e) {
                const clickedCell = e.target;
                const clickedCellIndex = parseInt(clickedCell.dataset.cellIndex);

                if (ticTacToeBoardState[clickedCellIndex] !== '' || !ticTacToeIsGameActive) {
                    return;
                }

                ticTacToeBoardState[clickedCellIndex] = ticTacToeCurrentPlayer;
                clickedCell.textContent = ticTacToeCurrentPlayer;
                clickedCell.classList.add(ticTacToeCurrentPlayer.toLowerCase());

                checkTicTacToeResult();

                if (ticTacToeIsGameActive && ticTacToeIsVsComputer && ticTacToeCurrentPlayer === 'O') {
                    setTimeout(ticTacToeComputerMove, 500);
                }
            }

            function ticTacToeComputerMove() {
                let availableCells = [];
                for (let i = 0; i < ticTacToeBoardState.length; i++) {
                    if (ticTacToeBoardState[i] === '') {
                        availableCells.push(i);
                    }
                }

                if (availableCells.length > 0) {
                    const randomIndex = Math.floor(Math.random() * availableCells.length);
                    const chosenIndex = availableCells[randomIndex];
                    ticTacToeBoardState[chosenIndex] = 'O';
                    ticTacToeCells[chosenIndex].textContent = 'O';
                    ticTacToeCells[chosenIndex].classList.add('o');
                    checkTicTacToeResult();
                }
            }

            function checkTicTacToeResult() {
                let roundWon = false;
                for (let i = 0; i < ticTacToeWinningConditions.length; i++) {
                    const winCondition = ticTacToeWinningConditions[i];
                    let a = ticTacToeBoardState[winCondition[0]];
                    let b = ticTacToeBoardState[winCondition[1]];
                    let c = ticTacToeBoardState[winCondition[2]];

                    if (a === '' || b === '' || c === '') {
                        continue;
                    }
                    if (a === b && b === c) {
                        roundWon = true;
                        break;
                    }
                }

                if (roundWon) {
                    ticTacToeGameStatus.textContent = `Player ${ticTacToeCurrentPlayer} has won!`;
                    ticTacToeIsGameActive = false;
                    updateTicTacToeStats(ticTacToeCurrentPlayer === 'X' ? 'win' : 'loss'); // Update stats
                    return;
                }

                let roundDraw = !ticTacToeBoardState.includes('');
                if (roundDraw) {
                    ticTacToeGameStatus.textContent = `Game ended in a draw!`;
                    ticTacToeIsGameActive = false;
                    updateTicTacToeStats('draw'); // Update stats
                    return;
                }

                changeTicTacToePlayer();
            }

            function changeTicTacToePlayer() {
                ticTacToeCurrentPlayer = ticTacToeCurrentPlayer === 'X' ? 'O' : 'X';
                ticTacToeGameStatus.textContent = `Player ${ticTacToeCurrentPlayer}'s turn`;
            }

            function resetTicTacToeGame() {
                ticTacToeBoardState = ['', '', '', '', '', '', '', '', ''];
                ticTacToeCurrentPlayer = 'X';
                ticTacToeIsGameActive = false;
                ticTacToeGameStatus.textContent = '';
                ticTacToeCells.forEach(cell => {
                    cell.textContent = '';
                    cell.classList.remove('x', 'o');
                });
                ticTacToeGameOptions.style.display = 'block';
                ticTacToeGameArea.style.display = 'none';
            }

            function updateTicTacToeStats(result) {
                // Ensure currentLoggedInUser and its ticTacToeStats are initialized
                if (!currentLoggedInUser) {
                    console.error("No user logged in to update Tic-Tac-Toe stats.");
                    return;
                }
                if (!currentLoggedInUser.ticTacToeStats) {
                    currentLoggedInUser.ticTacToeStats = { wins: 0, losses: 0, draws: 0 };
                }

                let stats = currentLoggedInUser.ticTacToeStats;
                if (result === 'win') {
                    stats.wins++;
                } else if (result === 'loss') {
                    stats.losses++;
                } else if (result === 'draw') {
                    stats.draws++;
                }
                saveCurrentUserData(); // Save the updated current user data
                updateTicTacToeStatsDisplay();
            }

            function updateTicTacToeStatsDisplay() {
                if (currentLoggedInUser && currentLoggedInUser.ticTacToeStats) {
                    ticTacToeWinsDisplay.textContent = currentLoggedInUser.ticTacToeStats.wins;
                    ticTacToeLossesDisplay.textContent = currentLoggedInUser.ticTacToeStats.losses;
                    ticTacToeDrawsDisplay.textContent = currentLoggedInUser.ticTacToeStats.draws;
                } else {
                    ticTacToeWinsDisplay.textContent = '0';
                    ticTacToeLossesDisplay.textContent = '0';
                    ticTacToeDrawsDisplay.textContent = '0';
                }
            }


            // --- Typing Test Functions ---
            function populateParagraphHeadlines() {
                if (!paragraphHeadlineSelect) return;

                paragraphHeadlineSelect.innerHTML = ''; // Clear existing options
                const currentLevelParagraphs = paragraphs[currentLevel];

                if (currentLevelParagraphs && currentLevelParagraphs.length > 0) {
                    currentLevelParagraphs.forEach((para, index) => {
                        const option = document.createElement('option');
                        option.value = index; // Store index to retrieve full text
                        option.textContent = para.headline;
                        paragraphHeadlineSelect.appendChild(option);
                    });
                    // Select the first paragraph by default
                    paragraphHeadlineSelect.value = 0;
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No paragraphs available for this level.';
                    paragraphHeadlineSelect.appendChild(option);
                    paragraphHeadlineSelect.disabled = true;
                }
            }

            function loadNewParagraph() {
                stopTypingTest(); // Stop any ongoing test

                if (!paragraphHeadlineSelect || paragraphHeadlineSelect.value === '') {
                    paragraphDisplay.textContent = "Please select a paragraph.";
                    typingInput.disabled = true;
                    startTestBtn.disabled = true;
                    resetTestBtn.disabled = true;
                    return;
                }

                const selectedParagraphIndex = parseInt(paragraphHeadlineSelect.value);
                const selectedParagraph = paragraphs[currentLevel][selectedParagraphIndex];
                
                if (!selectedParagraph) {
                    paragraphDisplay.textContent = "Error: Paragraph not found.";
                    typingInput.disabled = true;
                    startTestBtn.disabled = true;
                    resetTestBtn.disabled = true;
                    return;
                }

                currentParagraph = selectedParagraph.text;
                paragraphDisplay.innerHTML = '';
                currentParagraph.split('').forEach(char => {
                    const charSpan = document.createElement('span');
                    charSpan.textContent = char;
                    paragraphDisplay.appendChild(charSpan);
                });
                typedCharactersSpan = paragraphDisplay.querySelectorAll('span');
                typingInput.value = '';
                wpmDisplay.textContent = '0';
                accuracyDisplay.textContent = '100';
                charactersTyped = 0;
                correctCharacters = 0;
                testCompleted = false; // Reset completion flag
                if (typedCharactersSpan.length > 0) {
                    typedCharactersSpan[0].classList.add('current-char');
                }
                typingInput.disabled = false;
                startTestBtn.style.display = 'inline-block';
                resetTestBtn.style.display = 'none';
                clearInterval(timerInterval);
                isTestRunning = false;
                updateTimeLeftDisplay(parseInt(testDurationSelect.value) * 60); // Set initial time display
            }

            function updateTimeLeftDisplay(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                timeLeftDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
            }

            function calculateWPM() {
                const timeElapsed = (new Date() - startTime) / 1000 / 60;
                if (timeElapsed <= 0) return 0;
                // WPM = (Number of correct characters / 5) / time in minutes
                return Math.round((correctCharacters / 5) / timeElapsed);
            }

            function calculateAccuracy() {
                if (charactersTyped === 0) return 100;
                return Math.round((correctCharacters / charactersTyped) * 100);
            }

            function startTypingTest() {
                if (!currentLoggedInUser) {
                    showCustomAlert('Login Required', 'Please log in to start a typing test.', 'info');
                    return;
                }
                if (isTestRunning) return;
                startTime = new Date();
                isTestRunning = true;
                typingInput.focus();
                startTestBtn.style.display = 'none';
                resetTestBtn.style.display = 'inline-block';
                testDurationSelect.disabled = true; // Disable duration selection during test
                paragraphHeadlineSelect.disabled = true; // Disable paragraph selection during test
                levelEasyBtn.disabled = true;
                levelNormalBtn.disabled = true;
                levelHardBtn.disabled = true;

                let totalSeconds = parseInt(testDurationSelect.value) * 60;
                updateTimeLeftDisplay(totalSeconds);

                timerInterval = setInterval(() => {
                    totalSeconds--;
                    updateTimeLeftDisplay(totalSeconds);
                    if (totalSeconds <= 0) {
                        clearInterval(timerInterval);
                        stopTypingTest(true); // Indicate test ended by timer
                        showCustomAlert('Time Up!', "Your typing test time is up!", 'info');
                    }
                }, 1000);
            }

            function stopTypingTest(timerEnded = false) {
                isTestRunning = false;
                clearInterval(timerInterval);
                typingInput.disabled = true;
                testDurationSelect.disabled = false; // Re-enable duration selection
                paragraphHeadlineSelect.disabled = false; // Re-enable paragraph selection
                levelEasyBtn.disabled = false;
                levelNormalBtn.disabled = false;
                levelHardBtn.disabled = false;
                
                // Only save if the test was completed (all characters typed or timer ran out)
                if (testCompleted || timerEnded) {
                    saveTypingResult();
                }
            }

            function resetTypingTest() {
                stopTypingTest();
                loadNewParagraph();
                updateHighestWPMDisplay(); // Ensure highest WPM is updated on reset
            }

            function saveTypingResult() {
                if (!currentLoggedInUser) return; // Only save if a user is logged in

                const wpm = calculateWPM();
                const accuracy = calculateAccuracy();
                const now = new Date();
                const dateStr = now.toLocaleDateString();
                const timeStr = now.toLocaleTimeString();

                const result = {
                    wpm: wpm,
                    accuracy: accuracy,
                    level: currentLevel,
                    date: dateStr,
                    time: timeStr,
                    duration: parseInt(testDurationSelect.value),
                    paragraphHeadline: paragraphs[currentLevel][parseInt(paragraphHeadlineSelect.value)].headline // Save the headline
                };

                // Ensure typingTestResults array exists for the current user
                if (!currentLoggedInUser.typingTestResults) {
                    currentLoggedInUser.typingTestResults = [];
                }
                currentLoggedInUser.typingTestResults.push(result);
                saveCurrentUserData(); // Save the updated current user data
                displayTypingResults();

                // Update highest WPM for the current user
                if (wpm > (currentLoggedInUser.highestWPM || 0)) {
                    currentLoggedInUser.highestWPM = wpm;
                    saveCurrentUserData();
                    updateHighestWPMDisplay();
                }
            }

            function displayTypingResults() {
                testResultsList.innerHTML = '';
                if (!currentLoggedInUser || !currentLoggedInUser.typingTestResults) return;

                let results = [...currentLoggedInUser.typingTestResults]; // Create a copy to sort
                // Sort results by date/time descending for most recent first
                results.sort((a, b) => new Date(`${b.date} ${b.time}`) - new Date(`${a.date} ${a.date}`));

                results.forEach(res => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('list-item');
                    listItem.textContent = `Date: ${res.date} ${res.time} - Level: ${res.level.toUpperCase()} - Paragraph: "${res.paragraphHeadline}" - Speed: ${res.wpm} WPM - Accuracy: ${res.accuracy}% - Duration: ${res.duration} min`;
                    testResultsList.appendChild(listItem);
                });
            }

            function updateHighestWPMDisplay() {
                if (highestWPMDisplay && currentLoggedInUser) {
                    highestWPMDisplay.textContent = currentLoggedInUser.highestWPM || 0;
                } else if (highestWPMDisplay) {
                    highestWPMDisplay.textContent = '0'; // Display 0 if no user or no highest WPM
                }
            }

            function handleTypingInput(e) {
                if (!isTestRunning) {
                    startTypingTest();
                }

                const typedText = typingInput.value;
                charactersTyped = typedText.length;
                correctCharacters = 0;

                typedCharactersSpan.forEach((charSpan, index) => {
                    const paragraphChar = currentParagraph[index];
                    const typedChar = typedText[index];

                    charSpan.classList.remove('correct', 'incorrect', 'current-char');

                    if (typedChar == null) {
                        if (index === typedText.length) {
                            charSpan.classList.add('current-char');
                        }
                    } else if (typedChar === paragraphChar) {
                        charSpan.classList.add('correct');
                        correctCharacters++;
                    } else {
                        charSpan.classList.add('incorrect');
                    }
                });

                wpmDisplay.textContent = calculateWPM();
                accuracyDisplay.textContent = calculateAccuracy();

                // Check if the user has typed the entire paragraph
                if (typedText.length === currentParagraph.length) {
                    if (typedText === currentParagraph) {
                        testCompleted = true; // Mark as completed
                        stopTypingTest();
                        showCustomAlert('Test Complete!', "Well done! Your typing test is complete.", 'success');
                        typingInput.disabled = true;
                    }
                }
            }

            // Initial call
            initializeApp();
        });
    </script>
</body>
</html>
