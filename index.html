<!DOCTYPE html>
<html lang="en" data-theme="neptune-vibe">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrackFlow - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* NeptuneVibe Theme Variables */
        :root {
            --bg-primary: linear-gradient(135deg, #f5e4af, #f1f3f4, #d1e9f1, #ccf0c6, #eff3f6);
            --bg-secondary: #FFFFFF; /* White for cards/elements */
            --text-primary: #333333; /* Dark grey for main text */
            --text-secondary: #666666; /* Medium grey for secondary text */
            --accent-color: #6A67E9; /* Purple accent from logo */
            --accent-color-hover: #5A57D9; /* Darker purple hover */
            --border-color: #E0E6ED; /* Light grey border */
            --shadow-color: rgba(0, 0, 0, 0.05); /* Very light shadow */
            --input-bg: #F8F9FB; /* Off-white for inputs */
            
            --nav-bg: linear-gradient (90deg, #b9efda, #d4ffef, #d4fff1); /* Sidebar background */
            --nav-text: var(--text-primary); /* Sidebar text */
            --footer-bg: #FFFFFF; /* Footer background */
            --footer-text: var(--text-secondary); /* Footer text */

            --table-header-bg: #fef0c5; /* Light blue-grey header */
            --table-header-text: var(--text-primary); /* Table header text */
            --table-row-even: #FFFFFF; /* Even row background */
            --table-row-hover: #F8F9FB; /* Row hover background */

            /* Status Colors */
            --status-present: #28A745; /* Green */
            --status-absent: #DC3545; /* Red */
            --status-weekend: #6C757D; /* Grey */
            --status-holiday: #FFC107; /* Yellow */
            --status-govt-holiday: #17A2B8; /* Cyan */
            --status-sick-leave: #FD7E14; /* Orange */

            --status-present-bg: rgba(206,250,233,255); /* Deeper */
            --status-absent-bg: rgba(255,146,138,255); /* Deeper */
            --status-weekend-bg:rgb(216,232,219); /* Deeper */
            --status-holiday-bg: rgba(255, 193, 7, 0.15); /* Deeper */
            --status-govt-holiday-bg: rgba(23, 162, 184, 0.15); /* Deeper */
            --status-sick-leave-bg: rgba(253, 126, 20, 0.15); /* Deeper */

            /* Chart Colors */
            --chart-color-present: #3bff78; /* Use accent color for present */
            --chart-color-absent: #DC3545; /* Red for absent */

            /* Alert/Warning Colors */
            --alert-info: #2196F3;
            --alert-success: #4CAF50;
            --alert-warning: #FFC107;
            --alert-error: #F44336;

            --transition-speed: 0.2s ease-in-out; 
            --border-radius-base: 6px; 
            --border-radius-large: 10px; 

            /* Sidebar specific */
            --sidebar-width-expanded: 220px; /* Minimized width */
            --sidebar-width-collapsed: 60px; /* Further minimized */
            --right-sidebar-width-expanded: 280px;
            --right-sidebar-width-collapsed: 0px; /* Hidden when collapsed */
        }

        /* Dark Theme Variables */
        html[data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #1A1A1A 0%, #2C2C2C 100%); /* Dark gradient */
            --bg-secondary: rgba(40, 40, 40, 0.8); /* Darker, slightly transparent for glass effect */
            --text-primary: #E0E0E0; /* Light grey for main text */
            --text-secondary: #B0B0B0; /* Medium grey for secondary text */
            --accent-color: #9B98F0; /* Lighter purple accent */
            --accent-color-hover: #8A87E0; /* Darker lighter purple hover */
            --border-color: rgba(80, 80, 80, 0.5); /* Darker, transparent border */
            --shadow-color: rgba(0, 0, 0, 0.3); /* More prominent shadow */
            --input-bg: rgba(50, 50, 50, 0.7); /* Darker, transparent for inputs */
            
            --nav-bg: rgba(40, 40, 40, 0.8); /* Dark sidebar background */
            --nav-text: var(--text-primary);
            --footer-bg: rgba(40, 40, 40, 0.8); /* Dark footer background */
            --footer-text: var(--text-secondary);

            --table-header-bg: rgba(60, 60, 60, 0.7); /* Darker table header */
            --table-header-text: var(--text-primary);
            --table-row-even: rgba(40, 40, 40, 0.8); /* Darker even row */
            --table-row-hover: rgba(55, 55, 55, 0.8); /* Darker row hover */

            /* Status Colors for Dark Theme */
            --status-present: #4CAF50; 
            --status-absent: #F44336; 
            --status-weekend: #9E9E9E; 
            --status-holiday: #FFEB3B; 
            --status-govt-holiday: #03A9F4; 
            --status-sick-leave: #FF9800; 

            --status-present-bg: rgba(76, 175, 80, 0.25); /* Deeper */
            --status-absent-bg: rgba(244, 67, 54, 0.25); /* Deeper */
            --status-weekend-bg: rgba(158, 158, 158, 0.25); /* Deeper */
            --status-holiday-bg: rgba(255, 235, 59, 0.25); /* Deeper */
            --status-govt-holiday-bg: rgba(3, 169, 244, 0.25); /* Deeper */
            --status-sick-leave-bg: rgba(255, 152, 0, 0.25); /* Deeper */

            --chart-color-present: var(--accent-color);
            --chart-color-absent: var(--alert-error);

            /* Frosted glass effect for dark theme */
            .dashboard-fixed-top.scrolled,
            .modal-content,
            #rightSidebar {
                backdrop-filter: blur(10px) brightness(0.8); /* More blur, slightly darker */
                background-color: rgba(40, 40, 40, 0.6); /* More transparent dark */
            }
            .section-card, .summary-card, .month-selector-card, .chart-container-card,
            #attendanceTable, #historyAttendanceTable, .auth-container,
            .working-days-cola-category-wrapper .summary-card { /* Added new cards */
                background-color: rgba(40, 40, 40, 0.8); /* Darker, slightly transparent */
                border: 1px solid rgba(80, 80, 80, 0.5);
            }
            .premium-button.secondary {
                background-color: rgba(50, 50, 50, 0.7);
                border: 1px solid rgba(80, 80, 80, 0.5);
            }
            .premium-button.secondary:hover {
                background-color: rgba(80, 80, 80, 0.5);
            }
        }

        /* Animated Logo Colors */
        @keyframes colorChangeNewIcon {
            0% { color: #6A67E9; } /* Purple */
            25% { color: #28A745; } /* Green */
            50% { color: #17A2B8; } /* Cyan */
            75% { color: #FFC107; } /* Yellow */
            100% { color: #6A67E9; } /* Back to Purple */
        }

        .animated-new-icon {
            animation: colorChangeNewIcon 6s infinite ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            line-height: 1.4; /* Minimized line height */
            overflow-x: hidden;
            background: var(--bg-primary); /* Use subtle gradient */
            font-size: 0.85rem; /* Minimized base font size */
            min-height: 100vh;
            transition: background var(--transition-speed), color var(--transition-speed);
        }

        h1, h2, h3, h4 {
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            font-weight: 600; 
            transition: color var(--transition-speed);
        }
        h1 { font-size: 1.7rem; } /* Minimized */
        h2 { font-size: 1.4rem; } /* Minimized */
        h3 { font-size: 1.2rem; } /* Minimized */
        h4 { font-size: 1rem; } /* Minimized */

        .premium-button {
            background-color: var(--accent-color);
            color: #FFFFFF; 
            padding: 8px 12px; /* Minimized padding */
            border: none;
            border-radius: var(--border-radius-base); 
            font-size: 0.8rem; /* Minimized font size */
            font-weight: 500; 
            cursor: pointer;
            transition: all var(--transition-speed); 
            box-shadow: 0 2px 6px var(--shadow-color); /* Minimized shadow */
            letter-spacing: 0.2px; /* Minimized letter spacing */
            outline: none;
        }

        .premium-button:hover {
            background-color: var(--accent-color-hover); 
            box-shadow: 0 3px 8px rgba(0,0,0,0.1); /* Minimized shadow */
            transform: translateY(-1px); /* Minimized transform */
        }

        .premium-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .premium-button.secondary {
            background-color: var(--input-bg); 
            color: var(--text-primary);
            box-shadow: 0 1px 4px var(--shadow-color); /* Minimized shadow */
            border: 1px solid var(--border-color); 
        }

        .premium-button.secondary:hover {
            background-color: var(--border-color); 
            color: var(--accent-color);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .premium-button.delete-button {
            background-color: var(--alert-error); 
            box-shadow: 0 2px 6px rgba(244, 67, 54, 0.1); 
        }

        .premium-button.delete-button:hover {
            background-color: #C82333; 
        }

        /* --- Login Page Specific Styles --- */
        .login-page-body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-primary);
            background: var(--bg-primary); /* Use subtle gradient */
        }

        .auth-container {
            background-color: var(--bg-secondary);
            padding: 25px; /* Minimized padding */
            border-radius: var(--border-radius-large); 
            box-shadow: 0 10px 30px var(--shadow-color); /* Minimized shadow */
            text-align: center;
            width: 90%;
            max-width: 350px; /* Minimized max-width */
            animation: fadeInScale 0.4s ease-out; 
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: translateY(-20px) scale(0.98); } /* Minimized transform */
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .auth-container h1.premium-heading {
            font-size: 1.6rem; /* Minimized font size */
            margin-bottom: 8px; /* Minimized margin */
        }

        .auth-container .sub-heading {
            font-size: 0.85rem; /* Minimized font size */
            margin-bottom: 20px; /* Minimized margin */
            color: var(--text-secondary);
            font-weight: 400;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 12px; /* Minimized gap */
            animation: slideIn 0.3s ease-out forwards; 
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); } /* Minimized transform */
            to { opacity: 1; transform: translateY(0); }
        }

        .input-group {
            text-align: left;
            position: relative;
            margin-bottom: 8px; /* Minimized margin */
        }

        .input-group label {
            display: block;
            margin-bottom: 4px; /* Minimized margin */
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.8rem; /* Minimized font size */
        }

        .input-group input[type="email"],
        .input-group input[type="text"],
        .input-group input[type="date"],
        .input-group select {
            width: 100%;
            padding: 8px 10px; /* Minimized padding */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-base); 
            font-size: 0.85rem; /* Minimized font size */
            transition: all var(--transition-speed);
            background-color: var(--input-bg); 
            color: var(--text-primary); 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.04); 
            outline: none;
        }

        .input-group input::placeholder {
            color: var(--text-secondary);
            opacity: 0.8;
        }

        .input-group input:focus,
        .input-group select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(106, 103, 233, 0.2); /* Minimized shadow */
        }

        .input-group input.error {
            border-color: var(--alert-error);
            box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.2);
        }

        .input-group .error-message {
            color: var(--alert-error);
            font-size: 0.7rem; /* Minimized font size */
            margin-top: 3px; /* Minimized margin */
            display: none;
        }

        .input-group input.error + .error-message {
            display: block;
        }

        /* --- App Layout --- */
        .app-layout {
            display: flex;
            min-height: 100vh;
            background: var(--bg-primary); /* Use subtle gradient */
        }

        /* --- Sidebar --- */
        #sidebar {
            width: var(--sidebar-width-expanded);
            background-color: var(--nav-bg);
            box-shadow: 1px 0 8px var(--shadow-color); /* Minimized shadow */
            padding: 15px 0; /* Minimized padding */
            display: flex;
            flex-direction: column;
            transition: width var(--transition-speed), background-color var(--transition-speed);
            position: sticky;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 100;
        }

        #sidebar.collapsed {
            width: var(--sidebar-width-collapsed);
            padding: 15px 0;
            align-items: center;
        }

        #sidebar .sidebar-header {
            display: flex;
            align-items: center;
            gap: 6px; /* Minimized gap */
            padding: 0 15px 12px 15px; /* Minimized padding */
            margin-bottom: 15px; /* Minimized margin */
            border-bottom: 1px solid var(--border-color);
            transition: padding var(--transition-speed), opacity var(--transition-speed);
        }

        #sidebar.collapsed .sidebar-header {
            padding: 0 0 12px 0;
            justify-content: center;
        }

        #sidebar .sidebar-header .logo-text {
            font-size: 1.2rem; /* Minimized font size */
            font-weight: 700;
            color: var(--text-primary);
            transition: opacity var(--transition-speed), transform var(--transition-speed);
        }

        #sidebar.collapsed .sidebar-header .logo-text {
            opacity: 0;
            width: 0;
            overflow: hidden;
            transform: translateX(-15px); /* Minimized transform */
        }

        #sidebar .sidebar-header .logo-icon {
            width: 28px; /* Minimized size */
            height: 28px;
            fill: currentColor; /* Use current color for animation */
            transition: fill var(--transition-speed), transform 0.2s ease;
        }
        #sidebar .sidebar-header .logo-icon:hover {
            transform: rotate(8deg) scale(1.05); /* Minimized transform */
        }

        /* The main user profile display at the top, moved to bottom */
        #sidebar .sidebar-user-profile {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px; /* Minimized gap */
            padding: 0 15px; /* Minimized padding */
            margin-top: auto; /* Push to bottom */
            margin-bottom: 15px; /* Minimized margin */
            cursor: pointer;
            transition: opacity var(--transition-speed), transform var(--transition-speed);
            border-top: 1px solid var(--border-color); /* Separator */
            padding-top: 15px;
        }

        #sidebar.collapsed .sidebar-user-profile {
            flex-direction: column;
            padding: 0 5px;
            gap: 3px; /* Minimized gap */
        }
        #sidebar.collapsed .sidebar-user-profile .user-name,
        #sidebar.collapsed .sidebar-user-profile .user-role {
            opacity: 0;
            width: 0;
            height: 0;
            overflow: hidden;
        }
        #sidebar.collapsed .sidebar-user-profile .user-photo {
            margin-left: 0;
        }
        /* Hide additional profile details when collapsed */
        #sidebar.collapsed .sidebar-mini-profile-details {
            display: none;
        }


        #sidebar .sidebar-user-profile .user-photo {
            width: 100px; /* Minimized size */
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--accent-color); /* Minimized border */
            transition: border-color var(--transition-speed);
        }

        #sidebar .sidebar-user-profile .user-details {
            display: flex;
            flex-direction: column;
            align-items: center; /* Center align for compact view */
            text-align: center;
        }
        #sidebar .sidebar-user-profile .user-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem; /* Minimized font size */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #sidebar .sidebar-user-profile .user-role {
            font-size: 0.75rem; /* Minimized font size */
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Sidebar Mini Profile Details */
        .sidebar-mini-profile-details {
            display: flex;
            flex-direction: column;
            gap: 5px; /* Minimized gap */
            margin-top: 10px;
            width: 100%;
            text-align: left;
            transition: opacity var(--transition-speed);
        }
        .sidebar-mini-profile-details .detail-item {
            font-size: 0.7rem; /* Smaller font for compact details */
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .sidebar-mini-profile-details .detail-item strong {
            color: var(--text-primary);
            font-weight: 500;
        }
        .sidebar-mini-profile-details .detail-item i {
            font-size: 0.75rem;
            color: var(--accent-color);
        }


        #sidebar .sidebar-menu {
            list-style: none;
            flex-grow: 1; /* Allows menu to take available space */
        }

        #sidebar .sidebar-menu-item {
            margin-bottom: 5px; /* Minimized margin */
        }

        #sidebar .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 10px; /* Minimized gap */
            padding: 10px 15px; /* Minimized padding */
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem; /* Minimized font size */
            border-radius: var(--border-radius-base);
            margin: 0 8px; /* Minimized margin */
            transition: all var(--transition-speed);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #sidebar .sidebar-menu a:hover,
        #sidebar .sidebar-menu a.active {
            background-color: var(--accent-color);
            color: #FFFFFF;
            box-shadow: 0 1px 6px rgba(106, 103, 233, 0.2); /* Minimized shadow */
            transform: translateY(-1px); /* Minimized transform */
        }
        #sidebar .sidebar-menu a:hover i,
        #sidebar .sidebar-menu a.active i {
            color: #FFFFFF;
        }

        #sidebar .sidebar-menu a i {
            font-size: 0.9rem; /* Minimized size */
            color: var(--text-secondary);
            transition: color var(--transition-speed);
            flex-shrink: 0;
        }

        #sidebar.collapsed .sidebar-menu a {
            justify-content: center;
            padding: 10px 0;
            margin: 0 8px;
        }
        #sidebar.collapsed .sidebar-menu a span {
            display: none;
        }
        
        #sidebar .sidebar-footer {
            margin-top: 15px; /* Add margin after the user profile */
            padding: 12px 15px; /* Minimized padding */
            text-align: center;
            border-top: 1px solid var(--border-color);
            transition: opacity var(--transition-speed);
            font-size: 0.75rem; /* Minimized font size */
            border-radius: var(--border-radius-large); /* Rounded corners */
            box-shadow: 0 -2px 10px var(--shadow-color); /* Shadow from bottom */
            background-color: var(--footer-bg); 
            color: var(--footer-text);
            transition: all var(--transition-speed);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0; /* Rounded top corners */
        }
        #sidebar.collapsed .sidebar-footer {
            opacity: 0;
            height: 0;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        #sidebar .sidebar-toggle {
            position: absolute;
            top: 15px; /* Minimized top */
            right: 1px; /* Minimized right */
            background-color: #000;
            color: #FFFFFF;
            border: none;
            width: 28px; /* Minimized size */
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 1px 8px rgba(0, 0, 0, 0.15); /* Minimized shadow */
            font-size: 0.85rem; /* Minimized font size */
            transition: all var(--transition-speed);
            z-index: 101; 
        }
        #sidebar.collapsed .sidebar-toggle {
            right: -15px; 
            transform: rotate(180deg);
        }
        #sidebar .sidebar-toggle:hover {
            background-color: var(--accent-color-hover);
            transform: scale(1.03); /* Minimized transform */
        }
        #sidebar .sidebar-toggle i {
            transition: transform var(--transition-speed);
        }

        /* --- Main Content Area --- */
        .main-content-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Header (replaces old navbar) */
        .main-header {
            width: 100%;
            background-color: var(--bg-secondary);
            padding: 10px 20px; /* Minimized padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 6px var(--shadow-color); /* Minimized shadow */
            position: sticky;
            top: 0;
            z-index: 90;
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
            border-bottom: 1px solid var(--border-color);
        }

        .main-header .page-title-display {
            font-size: 1.3rem; /* Minimized font size */
            margin: 0;
            padding: 0;
            border-bottom: none;
            color: var(--text-primary);
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px; /* Minimized gap */
        }

        /* Search bar removed */

        .header-notification-icon {
            color: var(--text-secondary);
            font-size: 1rem; /* Minimized font size */
            cursor: pointer;
            transition: color var(--transition-speed);
        }
        .header-notification-icon:hover {
            color: var(--accent-color);
        }

        /* Fixed Dashboard Top Section */
        .dashboard-fixed-top {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px; /* Minimized gap */
            background: var(--bg-primary); /* Use subtle gradient */
            padding: 15px 20px; /* Minimized padding */
            position: sticky;
            top: 48px; /* Height of the main-header */
            z-index: 80;
            box-shadow: 0 1px 5px var(--shadow-color); /* Minimized shadow */
            border-bottom: 1px solid var(--border-color);
            transition: background var(--transition-speed), box-shadow var(--transition-speed), backdrop-filter var(--transition-speed);
        }
        .dashboard-fixed-top.scrolled {
            backdrop-filter: blur(5px); /* Frosted glass effect */
            background-color: rgba(255, 255, 255, 0.8); /* Slightly opaque white */
        }

        .month-chart-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .summary-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* 5 cards per row, adjust minmax */
            gap: 8px; /* Minimized gap */
        }
        .summary-card {
            margin-top: 4px;
            background-color: var(--bg-secondary);
            padding: 7px 12px; /* Minimized padding */
            border-radius: var(--border-radius-large);
            box-shadow: 5px 5px 1px #cdfaff; /* Minimized shadow */
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all var(--transition-speed);
            text-align: center; 
        }
        .summary-card:hover {
            transform: translateY(-1px); /* Minimized transform */
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .summary-card h4 {
            font-size: 0.75rem; /* Minimized font size */
            color: var(--text-secondary);
            margin-bottom: 2px; /* Minimized margin */
            font-weight: 500;
        }
        .summary-card .value {
            font-size: 1.1rem; /* Minimized font size */
            font-weight: 700;
            color: var(--text-primary);
        }

        .month-selector-card {
            background-color: var(--bg-secondary);
            padding: 55px 15px; /* Minimized padding */
            border-radius: var(--border-radius-large);
            box-shadow: 0 2px 8px var(--shadow-color); /* Minimized shadow */
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all var(--transition-speed);
        }
        .month-selector-card h4 {
            font-size: 0.9rem; /* Minimized font size */
            margin-bottom: 30px; /* Minimized margin */
        }
        .month-selector-card select {
            padding: 6px 10px; /* Minimized padding */
            font-size: 0.8rem; /* Minimized font size */
            border-radius: var(--border-radius-base);
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-primary);
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px; /* Minimized margin */
            transition: all var(--transition-speed), transform 0.1s ease-out; /* Add transform for animation */
        }
        .month-selector-card select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(106, 103, 233, 0.15); /* Minimized shadow */
            outline: none;
            transform: scale(1.02); /* Zoom in on focus */
        }
        .month-selector-card select:not(:focus) {
             transform: scale(1); /* Zoom out when not focused */
        }

        .month-selector-card .date-range-display p {
            font-size: 0.7rem; /* Minimized font size */
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 2px; /* Minimized margin */
        }
        .month-selector-card .date-range-display strong {
            font-weight: 500;
            color: var(--text-primary);
        }

        .chart-container-card {
            background-color: var(--bg-secondary);
            padding: 8px; /* Minimized padding */
            border-radius: var(--border-radius-large);
            box-shadow: 0 2px 8px var(--shadow-color); /* Minimized shadow */
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 250px; /* Minimized height for chart */
            transition: all var(--transition-speed);
            position: relative; /* For percentage text */
        }
        .chart-percentage-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            pointer-events: none; /* Allow clicks to pass through to chart */
        }

        /* Calendar Styles */
        .calendar-card {
            background-color: var(--bg-secondary);
            padding: 12px;
            border-radius: var(--border-radius-large);
            box-shadow: 0 2px 8px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: all var(--transition-speed);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .calendar-header button {
            background: none;
            border: none;
            font-size: 1rem;
            color: var(--accent-color);
            cursor: pointer;
            padding: 5px;
            border-radius: var(--border-radius-base);
            transition: background-color var(--transition-speed);
        }
        .calendar-header button:hover {
            background-color: var(--border-color);
        }
        .calendar-header h3 {
            font-size: 1rem;
            margin: 0;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day-name {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.75rem;
        }
        .calendar-date {
            padding: 5px;
            border-radius: var(--border-radius-base);
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: background-color var(--transition-speed), transform 0.1s ease-out;
            position: relative;
            overflow: hidden;
        }
        .calendar-date:hover {
            transform: scale(1.05);
        }
        .calendar-date.empty {
            visibility: hidden;
        }
        .calendar-date.current-month {
            background-color: var(--input-bg);
        }
        .calendar-date.today {
            border: 2px solid var(--accent-color);
            font-weight: 700;
        }
        /* Calendar Status Colors */
        .calendar-date.status-present { background-color: var(--status-present-bg); border: 1px solid var(--status-present); }
        .calendar-date.status-absent { background-color: var(--status-absent-bg); border: 1px solid var(--status-absent); }
        .calendar-date.status-weekend { background-color: var(--status-weekend-bg); border: 1px solid var(--status-weekend); }
        .calendar-date.status-holiday { background-color: var(--status-holiday-bg); border: 1px solid var(--status-holiday); }
        .calendar-date.status-government_holiday { background-color: var(--status-govt-holiday-bg); border: 1px solid var(--status-govt-holiday); }
        .calendar-date.status-sick_leave { background-color: var(--status-sick-leave-bg); border: 1px solid var(--status-sick-leave); }


        /* Scrolling Content Area */
        .dashboard-scrolling-content {
            flex-grow: 1;
            padding: 15px 20px; /* Minimized padding */
            background: var(--bg-primary); /* Use subtle gradient */
            min-height: calc(100vh - 48px - 200px); /* Adjust min-height to allow scrolling */
            transition: background var(--transition-speed);
            overflow-y: auto; /* Enable scrolling for this area */
        }
        @media (max-width: 768px) {
            .dashboard-scrolling-content {
                padding: 10px 15px;
            }
        }
        
        .section-card {
            background-color: var(--bg-secondary);
            padding: 20px; /* Minimized padding */
            margin-bottom: 15px; /* Minimized margin */
            border-radius: var(--border-radius-large);
            box-shadow: 0 4px 15px var(--shadow-color); /* Minimized shadow */
            border: 1px solid var(--border-color);
            transition: all var(--transition-speed);
        }
        .section-card:hover {
            transform: translateY(-2px); /* Minimized transform */
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
        }
        .section-card h2 {
            font-size: 1.25rem; /* Minimized font size */
            margin-bottom: 10px; /* Minimized margin */
            padding-bottom: 6px; /* Minimized padding */
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary); 
            text-align: left; 
        }

        /* --- Saved Entries Table --- */
        .table-responsive {
            overflow-x: auto;
        }

        #attendanceTable, #historyAttendanceTable {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 10px; /* Minimized margin */
            background-color: var(--bg-secondary); 
            box-shadow: 0 2px 10px var(--shadow-color); /* Minimized shadow */
            border-radius: var(--border-radius-large);
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all var(--transition-speed);
        }

        #attendanceTable thead, #historyAttendanceTable thead {
            background-color: var(--table-header-bg); 
            color: var(--table-header-text);
            transition: all var(--transition-speed);
        }

        #attendanceTable th,
        #attendanceTable td,
        #historyAttendanceTable th,
        #historyAttendanceTable td {
            padding: 8px 10px; /* Minimized padding */
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary); 
            transition: all var(--transition-speed);
            font-size: 0.75rem; /* Minimized font size */
        }

        #attendanceTable th, #historyAttendanceTable th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem; /* Minimized font size */
            letter-spacing: 0.2px; /* Minimized letter spacing */
        }

        #attendanceTable tbody tr:nth-child(even), #historyAttendanceTable tbody tr:nth-child(even) {
            background-color: var(--table-row-even); 
            transition: all var(--transition-speed);
        }

        #attendanceTable tbody tr:hover, #historyAttendanceTable tbody tr:hover {
            background-color: var(--table-row-hover); 
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }

        /* Status Background Colors for Table Rows */
        .status-present-row { background-color: var(--status-present-bg) !important; }
        .status-absent-row { background-color: var(--status-absent-bg) !important; }
        .status-weekend-row { background-color: var(--status-weekend-bg) !important; }
        .status-holiday-row { background-color: var(--status-holiday-bg) !important; }
        .status-government_holiday-row { background-color: var(--status-govt-holiday-bg) !important; }
        .status-sick_leave-row { background-color: var(--status-sick-leave-bg) !important; }

        .table-actions button {
            background-color: var(--accent-color); 
            color: #FFFFFF;
            border: none; 
            padding: 5px 8px; /* Minimized padding */
            border-radius: 4px; 
            cursor: pointer;
            font-size: 0.65rem; /* Minimized font size */
            margin-right: 3px; /* Minimized margin */
            transition: all 0.15s ease;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06); /* Minimized shadow */
        }

        .table-actions button:hover {
            background-color: var(--accent-color-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.09);
        }

        .table-actions .delete-button { 
            background-color: var(--alert-error);
            box-shadow: 0 1px 4px rgba(244, 67, 54, 0.1);
        }

        .table-actions .delete-button:hover {
            background-color: #C82333;
            box-shadow: 0 2px 6px rgba(244, 67, 54, 0.15);
        }

        /* Specific Status Colors (Text Only) */
        .status-present { color: var(--status-present); font-weight: 600; transition: color var(--transition-speed); }
        .status-absent { color: var(--status-absent); font-weight: 600; transition: color var(--transition-speed); }
        .status-weekend { color: var(--status-weekend); font-weight: 600; transition: color var(--transition-speed); }
        .status-holiday { color: var(--status-holiday); font-weight: 600; transition: color var(--transition-speed); }
        .status-government_holiday { color: var(--status-govt-holiday); font-weight: 600; transition: color var(--transition-speed); }
        .status-sick_leave { color: var(--status-sick-leave); font-weight: 600; transition: color var(--transition-speed); }
        
        /* Edit/Delete Modal specific styles */
        #editDeleteModal .modal-content .input-group {
            margin-bottom: 10px; /* Minimized margin */
        }
        #editDeleteModal .modal-content .input-group label {
            margin-bottom: 3px; /* Minimized margin */
            color: var(--text-primary); 
        }
        #editDeleteModal .modal-content .input-group input,
        #editDeleteModal .modal-content .input-group select {
            width:100%; 
            padding: 8px 10px; /* Minimized padding */
            border-radius: var(--border-radius-base);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.03); /* Minimized shadow */
            color: var(--text-primary); 
            background-color: var(--input-bg);
            font-size: 0.85rem; /* Minimized font size */
        }
        #editDeleteModal .modal-content .input-group input::placeholder,
        #editDeleteModal .modal-content .input-group select {
            color: var(--text-secondary); 
        }
        #editDeleteModal .modal-content .modal-buttons {
            display: flex; 
            justify-content: flex-end; 
            gap: 8px; /* Minimized gap */
            margin-top: 15px; /* Minimized margin */
        }
        #editDeleteModal .modal-content .modal-buttons .premium-button {
            padding: 8px 12px; /* Minimized padding */
            font-size: 0.8rem; /* Minimized font size */
        }

        /* Custom Alert/Confirm Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); 
            justify-content: center;
            align-items: center;
            animation: fadeInOverlay 0.2s ease-out; 
            backdrop-filter: blur(3px); /* Background blur for modal overlay */
        }
        @keyframes fadeInOverlay {
            from { background-color: rgba(0,0,0,0); backdrop-filter: blur(0px); }
            to { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: 20px; /* Minimized padding */
            border-radius: var(--border-radius-large);
            box-shadow: 0 10px 25px var(--shadow-color); /* Minimized shadow */
            width: 90%;
            max-width: 400px; /* Minimized max width */
            position: relative;
            animation: zoomIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; /* Zoom in animation */
            border: 1px solid var(--border-color);
            transition: all var(--transition-speed);
            backdrop-filter: blur(5px); /* Glass effect for modal content */
        }
        .modal.closing .modal-content {
            animation: zoomOut 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; /* Zoom out animation */
        }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.8); } 
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes zoomOut {
            from { opacity: 1; transform: scale(1); } 
            to { opacity: 0; transform: scale(0.8); }
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 12px; /* Minimized margin */
            font-size: 1.4rem; /* Minimized font size */
            text-align: center;
            color: var(--text-primary);
        }

        .modal-content .close-button {
            color: var(--text-secondary);
            font-size: 22px; /* Minimized font size */
            font-weight: 600;
            position: absolute;
            top: 10px; /* Minimized top */
            right: 12px; /* Minimized right */
            cursor: pointer;
            transition: all 0.2s ease; 
        }

        .modal-content .close-button:hover,
        .modal-content .close-button:focus {
            color: var(--accent-color);
            transform: rotate(90deg) scale(1.05); /* Minimized transform */
        }

        #customAlertModal .modal-content,
        #customConfirmModal .modal-content {
            padding: 20px; /* Minimized padding */
            max-width: 350px; /* Minimized max width */
            border-left: 5px solid var(--alert-info); /* Minimized border */
            animation: zoomIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; 
            transition: border-color var(--transition-speed);
            box-shadow: 0 8px 20px var(--shadow-color); /* Minimized shadow */
            background-color: var(--bg-secondary); 
        }

        #customAlertModal h2,
        #customConfirmModal h2 {
            font-size: 1.2rem; /* Minimized font size */
            margin-bottom: 10px; /* Minimized margin */
            color: var(--text-primary); 
        }

        #customAlertModal p,
        #customConfirmModal p {
            font-size: 0.8rem; /* Minimized font size */
            margin-bottom: 15px; /* Minimized margin */
            color: var(--text-secondary); 
        }

        #customAlertModal .modal-buttons,
        #customConfirmModal .modal-buttons {
            display: flex;
            justify-content: flex-end; 
            gap: 8px; /* Minimized gap */
        }

        #customAlertModal .modal-buttons .premium-button,
        #customConfirmModal .modal-buttons .premium-button {
            padding: 8px 12px; /* Minimized padding */
            font-size: 0.8rem; /* Minimized font size */
        }

        /* Help Modal Specific Styles */
        .help-modal-content {
            padding: 30px; /* Minimized padding */
            animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; 
            background-color: var(--bg-secondary);
        }

        .help-modal-content h2 {
            font-size: 1.6rem; /* Minimized font size */
            margin-bottom: 12px; /* Minimized margin */
            color: var(--text-primary); 
        }

        .help-modal-content p {
            font-size: 0.9rem; /* Minimized font size */
            color: var(--text-secondary); 
        }

        /* Profile Page Section Styles (replaces profile modal) */
        #profilePageSection {
            flex-grow: 1;
            padding: 15px 20px;
            background: var(--bg-primary); /* Use subtle gradient */
            transition: background var(--transition-speed);
            display: none; /* Hidden by default */
            flex-direction: column; /* Organize content vertically */
            align-items: center; /* Center items horizontally */
        }
        #profilePageSection .profile-content-card {
            background-color: var(--bg-secondary);
            padding: 25px;
            margin-bottom: 15px;
            border-radius: var(--border-radius-large);
            box-shadow: 0 4px 15px var(--shadow-color);
            border: 1px solid var(--border-color);
            width: 100%;
            max-width: 700px; /* Wider for profile details */
            display: flex;
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }

        #profilePageSection .profile-content-card h2 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.6rem;
        }

        #profilePageSection .profile-picture-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        #profilePageSection .user-photo-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-color);
        }
        #profilePageSection .photo-suggestions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        #profilePageSection .photo-suggestions img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }
        #profilePageSection .photo-suggestions img:hover {
            transform: scale(1.1);
            border-color: var(--accent-color);
        }
        #profilePageSection .photo-remove-btn {
            background-color: var(--alert-error);
            color: #FFFFFF;
        }

        /* History Page Section */
        #historySection {
            flex-grow: 1; /* Take remaining space */
            padding: 15px 20px; /* Minimized padding */
            background: var(--bg-primary); /* Use subtle gradient */
            transition: background var(--transition-speed);
            display: none; /* Hidden by default */
            flex-direction: column; /* Use flex to control child layout */
        }

        #historySection .date-range-inputs {
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 12px; /* Minimized gap */
            margin-bottom: 15px; /* Minimized margin */
        }

        #historySection .date-range-inputs .input-group {
            min-width: 180px; /* Minimized min-width */
            flex-grow: 1; 
        }

        #historySection .date-range-inputs .input-group label {
            color: var(--text-primary); 
            font-size: 0.8rem; /* Minimized font size */
        }
        #historySection .date-range-inputs .input-group input {
            color: var(--text-primary); 
            background-color: var(--input-bg);
            padding: 8px 10px; /* Minimized padding */
            font-size: 0.85rem; /* Minimized font size */
        }

        #historySection .date-range-inputs button {
            max-width: 120px; /* Minimized max-width */
            margin-top: 10px; /* Minimized margin */
            padding: 8px 12px; /* Minimized padding */
            font-size: 0.8rem; /* Minimized font size */
        }

        /* Removed historySummaryResult from historySection */
        /* #historySummaryResult {
            margin-top: 15px; 
            padding: 15px; 
            background-color: var(--bg-secondary); 
        } */

        #historyDetailedEntries {
            margin-top: 20px !important; /* Minimized margin */
        }

        /* --- Footer --- */
        footer {
            padding: 15px 15px; /* Minimized padding */
            font-size: 0.75rem; /* Minimized font size */
            margin-top: 15px; /* Minimized margin */
            border-top: 1px solid var(--border-color); 
            gap: 12px; /* Minimized gap */
            box-shadow: 0 -2px 10px var(--shadow-color); /* Minimized shadow */
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            background-color: var(--footer-bg); 
            color: var(--footer-text);
            transition: all var(--transition-speed);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0; /* Rounded top corners */
        }

        footer .footer-section {
            min-width: 250px; /* Minimized min-width */
            text-align: left; 
            padding: 0px 40px;
        }

        footer .footer-section h4 {
            font-size: 0.9rem; /* Minimized font size */
            margin-bottom: 8px; /* Minimized margin */
            color: var(--text-primary); /* Use text-primary for contrast */
        }

        footer .footer-section p {
            margin-bottom: 4px; /* Minimized margin */
            font-size: 0.75rem; /* Minimized font size */
            color: var(--footer-text);
        }

        footer .footer-section p i {
            margin-right: 6px; /* Minimized margin */
            font-size: 0.9rem; /* Minimized font size */
        }

        /* Right Sidebar Styles */
        #rightSidebar {
            background-color: var(--nav-bg);
            box-shadow: -1px 0 8px var(--shadow-color);
            padding: 15px;
            display: flex;
            flex-direction: column;
            transition: width var(--transition-speed), background-color var(--transition-speed);
            position: sticky;
            top: 0;
            right: 0;
            height: 100vh;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 99;
            border-left: 1px solid var(--border-color);
            border-radius: var(--border-radius-large) 0 0 var(--border-radius-large);
        }

        #rightSidebar.collapsed {
            width: var(--right-sidebar-width-collapsed);
            padding: 0;
            overflow: hidden;
        }

        #rightSidebar h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--text-primary);
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .right-sidebar-section {
            margin-bot0om: 20px;
            padding: 15px;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius-large);
            box-shadow: 0 2px 8px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: all var(--transition-speed);
        }
        /*.right-sidebar-section:hover {*/
        /*    transform: translateY(-2px);*/
        /*    box-shadow: 0 4px 12px rgba(0,0,0,0.1);*/
        /*}*/

        .right-sidebar-section h4 {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .right-sidebar-item {
            display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 5px;
    border: 1px solid var(--border-color);
    font-size: 0.8rem;
    color: var(--text-secondary);
    border-radius: 4px;
    margin-bottom: 10px;
    box-shadow: 1px 1px 4px 0px #a1ebd2;
        }
        .right-sidebar-item:last-child {
        }
        .right-sidebar-item strong {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.0rem;
        }

        /* Profile Details in Right Sidebar */
        .profile-detail-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .profile-detail-item label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 3px;
            font-size: 0.9rem;
        }
        .profile-detail-item span {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .profile-detail-item i {
            margin-right: 8px;
            color: var(--accent-color);
        }
        .profile-detail-item .value-wrapper {
            display: flex;
            align-items: center;
        }

        /* Theme Toggle Button */
        .theme-toggle-button {
            background-color: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all var(--transition-speed);
            box-shadow: 5px 5px 1px #cdfaff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .theme-toggle-button:hover {
            background-color: var(--border-color);
            color: var(--accent-color);
        }

        /* New Dashboard Cards */
        .working-days-cola-category-wrapper {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .working-days-cola-category-wrapper .summary-card {

            text-align: left;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 80%; /* Ensure cards take full height */
        }
        .working-days-cola-category-wrapper .summary-card h4 {
            font-size: 0.8rem;
           
            color: var(--text-primary);
        }
        .working-days-cola-category-wrapper .summary-card .value {
            font-size: 1.rem;
            font-weight: 700;
            color: var(--accent-color);
        }
        .working-days-cola-category-wrapper .summary-card .details-button {
            background-color: var(--input-bg);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: var(--border-radius-base);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--transition-speed);
            align-self: flex-end; /* Align button to the right */
        }
        .working-days-cola-category-wrapper .summary-card .details-button:hover {
            background-color: var(--border-color);
            color: var(--accent-color);
        }

        /* COLA Progress Bar */
        .cola-progress-bar-container {
            width: 100%;
            background-color:#e9eaed;
            border-radius: var(--border-radius-base);
            overflow: hidden;
            margin-top: 10px;
            height: 13px;
            position: relative;
        }
        .cola-progress-bar {
            height: 100%;
            background-color: #00fb93;    width: 0%;
            transition: width 0.5s ease-out;
            border-radius: var(--border-radius-base);
        }
        .cola-eligibility-status {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--status-present);
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .cola-eligibility-status i {
            font-size: 1rem;
        }

        /* Page Transition Animation */
        .page-transition {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .app-layout {
                flex-direction: column; /* Stack sidebars and main content */
            }
            #sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 1px 8px var(--shadow-color);
                border-radius: 0 0 var(--border-radius-large) var(--border-radius-large);
                padding-bottom: 0;
            }
            #sidebar.collapsed {
                width: 100%;
                align-items: flex-start;
            }
            #sidebar .sidebar-toggle {
                position: static; /* Remove fixed positioning */
                margin: 10px auto; /* Center toggle button */
                transform: none !important; /* Override collapsed transform */
            }
            #sidebar.collapsed .sidebar-toggle {
                transform: none;
            }
            #sidebar .sidebar-header, #sidebar .sidebar-user-profile, #sidebar .sidebar-footer {
                padding: 10px 15px;
                width: 100%;
                flex-direction: row;
                justify-content: center;
                gap: 10px;
            }
            #sidebar.collapsed .sidebar-header .logo-text,
            #sidebar.collapsed .sidebar-user-profile .user-name,
            #sidebar.collapsed .sidebar-user-profile .user-role,
            #sidebar.collapsed .sidebar-mini-profile-details,
            #sidebar.collapsed .sidebar-footer {
                display: block; /* Show content when sidebar is "collapsed" on mobile */
                opacity: 1;
                width: auto;
                height: auto;
                overflow: visible;
                transform: none;
            }
            #sidebar .sidebar-menu {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                padding: 10px 0;
            }
            #sidebar .sidebar-menu-item {
                margin: 5px;
            }
            #sidebar .sidebar-menu a {
                padding: 8px 12px;
                font-size: 0.8rem;
                margin: 0;
            }
            #sidebar .sidebar-menu a span {
                display: inline;
            }
            #sidebar .sidebar-menu a i {
                margin-right: 5px;
            }
            #sidebar.collapsed .sidebar-menu a {
                justify-content: flex-start;
            }

            #rightSidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 -1px 8px var(--shadow-color);
                border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
                border-left: none;
                border-top: 1px solid var(--border-color);
                margin-top: 15px;
            }
            #rightSidebar.collapsed {
                width: 100%;
                height: auto;
                padding: 15px; /* Always show content on mobile */
                overflow: visible;
            }
            .main-content-wrapper {
                width: 100%;
            }

            .dashboard-fixed-top {
                grid-template-columns: 1fr; /* Stack all sections on smaller screens */
            }
            .working-days-cola-category-wrapper {
                flex-direction: row; /* Arrange new cards horizontally on tablet */
                flex-wrap: wrap;
                justify-content: center;
            }
            .working-days-cola-category-wrapper .summary-card {
                flex: 1 1 45%; /* Allow cards to grow and wrap */
                max-width: 48%; /* Max width to allow two per row */
            }
        }

        @media (max-width: 768px) {
            #sidebar {
                width: 100%; /* Force full width on mobile */
            }
            #sidebar.collapsed {
                width: 100%;
            }
            #sidebar .sidebar-toggle {
                right: auto;
                left: 50%;
                transform: translateX(-50%) !important;
                top: 10px;
                width: 24px;
                height: 24px;
                font-size: 0.75rem;
            }
            #sidebar.collapsed .sidebar-toggle {
                transform: translateX(-50%);
            }

            .main-header {
                padding: 8px 10px;
            }
            .main-header .page-title-display {
                font-size: 1.1rem;
            }
            /* Search bar is removed */

            .dashboard-fixed-top {
                grid-template-columns: 1fr;
                padding: 10px;
                top: 40px; /* Adjust sticky top for smaller header */
            }
            .summary-cards-grid {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); /* Further minimized cards */
                gap: 6px;
            }
            .summary-card .value {
                font-size: 0.9rem;
            }
            .summary-card h4 {
                font-size: 0.65rem;
            }

            .month-selector-card select {
                font-size: 0.75rem;
            }
            .chart-container-card {
                height: auto; /* Further minimized height */
                padding: 5px;
            }

            .dashboard-scrolling-content {
                padding: 10px;
            }
            .section-card {
                padding: 15px;
            }
            .section-card h2 {
                font-size: 1.05rem;
            }

            #attendanceTable th,
            #attendanceTable td,
            #historyAttendanceTable th,
            #historyAttendanceTable td {
                padding: 6px 8px;
                font-size: 0.65rem;
            }
            .table-actions button {
                padding: 4px 6px;
                font-size: 0.6rem;
            }

            footer {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            footer .footer-section {
                min-width: 100%;
            }

            /* Sidebar mini profile details on small screens */
            .sidebar-user-profile {
                padding: 10px 0;
            }
            .sidebar-mini-profile-details {
                font-size: 0.65rem;
                gap: 3px;
            }
            .sidebar-mini-profile-details .detail-item i {
                font-size: 0.7rem;
            }

            .working-days-cola-category-wrapper {
                flex-direction: column; /* Stack new cards vertically on mobile */
            }
            .working-days-cola-category-wrapper .summary-card {
                max-width: 100%; /* Full width on mobile */
            }
        }
    </style>
</head>
<body>
    <!-- Login/Registration Section -->
    <div id="authSection" class="login-page-body">
        <div class="auth-container">
            <h1 class="premium-heading">Welcome to TrackFlow!</h1> 
            <p class="sub-heading">Please login with your Gmail account.</p>

            <form id="gmailLoginForm" class="auth-form active">
                <div class="input-group">
                    <label for="gmailEmail">Gmail Address</label>
                    <input type="email" id="gmailEmail" placeholder="Enter your Gmail" required>
                    <span class="error-message" id="gmailEmailError"></span>
                </div>
                <button type="submit" class="premium-button">Login with Gmail</button>
            </form>
        </div>
    </div>

    <!-- Main Activity Page Section (Initially hidden) -->
    <div id="mainActivitySection" style="display: none;" class="app-layout">
        <!-- Sidebar -->
        <aside id="sidebar">
            <button id="sidebarToggle" class="sidebar-toggle">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="sidebar-header">
                <!-- New Animated SVG Icon -->
                <svg class="logo-icon animated-new-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 20H4V14H10V20ZM10 12H4V4H10V12ZM12 2H22V12H12V2ZM12 14H22V22H12V14Z"/>
                    <path fill="var(--accent-color)" d="M10 20H4V14H10V20ZM10 12H4V4H10V12ZM12 2H22V12H12V2ZM12 14H22V22H12V14Z"/>
                </svg>
                <span class="logo-text">TrackFlow</span>
            </div>

            <ul class="sidebar-menu">
                <li class="sidebar-menu-item"><a href="#" id="homeNavLink" class="active"><i class="fas fa-th-large"></i> <span>Dashboard</span></a></li>
                <li class="sidebar-menu-item"><a href="#" id="historyNavLink"><i class="fas fa-history"></i> <span>Attendance History</span></a></li>
                <li class="sidebar-menu-item"><a href="#" id="personalProfileBtn"><i class="fas fa-user-circle"></i> <span>My Profile</span></a></li>
                <li class="sidebar-menu-item"><a href="#" id="helpNavLink"><i class="fas fa-question-circle"></i> <span>Help</span></a></li>
                <li class="sidebar-menu-item"><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
            </ul>
            
            <!-- User Profile Section moved to the bottom of sidebar -->
            <div class="sidebar-user-profile" id="sidebarUserProfile">
                <img id="sidebarUserPhoto" src="https://placehold.co/36x36/A767E9/FFFFFF?text=U" alt="User Photo" class="user-photo">
                <div class="user-details">
                    <span class="user-name" id="sidebarUsername">Sebastian L.</span>
                    <span class="user-role" id="sidebarUserRole">HR Manager</span>
                </div>
                <!-- New: Compact Profile Details for Sidebar -->
                <div class="sidebar-mini-profile-details">
                    <div class="detail-item"><i class="fas fa-clock"></i> <span>Joining: <strong><span id="sidebarJoiningDuration"></span></strong></span></div>
                    <div class="detail-item"><i class="fas fa-id-badge"></i> <span>LnG ID: <strong><span id="sidebarLngId"></span></strong></span></div>
                    <div class="detail-item"><i class="fas fa-user-tag"></i> <span>Emp.Type: <strong><span id="sidebarEmployeeType"></span></strong></span></div>
                    <div class="detail-item"><i class="fas fa-users"></i> <span>Team: <strong><span id="sidebarTeam"></span></strong></span></div>
                    <div class="detail-item"><i class="fas fa-briefcase"></i> <span>Desig.: <strong><span id="sidebarDesignation"></span></strong></span></div>
                </div>
                 <div class="working-days-cola-category-wrapper">
                  <div class="summary-card">
                        <h4>Category</h4>
                        <span class="value" id="employeeCategoryDisplay">Category: A, Excellent</span>
                        <button class="details-button" id="categoryDetailsBtn">Details</button>
                    </div>
                  </div>
            </div>

            <div class="sidebar-footer">
                <p>&copy; <span id="currentYear"></span> TrackFlow</p>
                
            </div>
        </aside>

        <div class="main-content-wrapper">
            <!-- Header -->
            <header class="main-header">
                <span class="page-title-display" id="pageTitleDisplay">Dashboard</span>

                <button id="themeToggle" class="theme-toggle-button">
                    <i class="fas fa-moon"></i> <span>Dark Mode</span>
                </button>
            </header>

            <!-- Fixed Dashboard Top Section -->
            <div class="dashboard-fixed-top" id="dashboardFixedTop">
              
                <div class="month-chart-wrapper">
                    <div class="month-selector-card">
                        <h4>Select Month</h4>
                        <select id="monthSelectDropdown"></select>
                        <div class="date-range-display">
                            <p><strong>From:</strong> <span id="dateFrom"></span></p>
                            <p><strong>To:</strong> <span id="dateTo"></span></p>
                        </div>
                    </div>
                </div>
                <div class="chart-container-card">
                        <canvas id="monthlyAttendanceChart"></canvas>
                        <div class="chart-percentage-text" id="chartPercentageText"></div>
                </div>

                <!-- New: Working Days, COLA, Category Wrapper -->
                <div class="working-days-cola-category-wrapper">
                    <div class="summary-card">
                        <h4>Total Working Days</h4>
                        <span class="value" id="totalWorkingDaysDisplay">0 Days</span>
                        <button class="details-button" id="totalWorkingDaysDetailsBtn">Details</button>
                    </div>
                    <div class="summary-card">
                        <h4>COLA Eligibility</h4>
                        <span class="value" id="colaEligibilityDisplay">Need present 0 days</span>
                        <div class="cola-progress-bar-container">
                            <div class="cola-progress-bar" id="colaProgressBar"></div>
                        </div>
                        <div class="cola-eligibility-status" id="colaEligibilityStatus"></div>
                        <button class="details-button" id="colaEligibilityDetailsBtn">Details</button>
                    </div>
                    <!--<div class="summary-card">-->
                    <!--    <h4>Category</h4>-->
                    <!--    <span class="value" id="employeeCategoryDisplay">Category: A, Excellent</span>-->
                    <!--    <button class="details-button" id="categoryDetailsBtn">Details</button>-->
                    <!--</div>-->
                </div>
               

                <!-- Calendar Card -->
                <div class="calendar-card">
                    <div class="calendar-header">
                        <button id="prevMonthBtn"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="currentMonthYear"></h3>
                        <button id="nextMonthBtn"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <div class="calendar-day-name">Sun</div>
                        <div class="calendar-day-name">Mon</div>
                        <div class="calendar-day-name">Tue</div>
                        <div class="calendar-day-name">Wed</div>
                        <div class="calendar-day-name">Thu</div>
                        <div class="calendar-day-name">Fri</div>
                        <div class="calendar-day-name">Sat</div>
                        <!-- Dates will be populated here by JavaScript -->
                    </div>
                </div>
                
            </div>

            <!-- Scrolling Content Area -->
            <div class="dashboard-scrolling-content">
                <!-- Daily Entries Data -->
                <section id="dailyEntriesSection" class="section-card page-transition">
                    <h2>Daily Entries</h2>
                    <div class="table-responsive">
                        <table id="attendanceTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Day</th>
                                    <th>Status</th>
                                    <th>Hour</th>
                                    <th>Extra Hour</th>
                                    <th>Late</th>
                                    <th>Shift</th>
                                    <th>Grace</th>
                                    <th>Approval</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- History Page Section (Initially hidden) -->
                <section id="historySection" class="section-card page-transition" style="display: none;">
                    <h2>Custom Report Generator</h2>
                    <div class="date-range-inputs">
                        <div class="input-group">
                            <label for="historyDateFrom">From Date:</label>
                            <input type="date" id="historyDateFrom">
                        </div>
                        <div class="input-group">
                            <label for="historyDateTo">To Date:</label>
                            <input type="date" id="historyDateTo">
                        </div>
                        <button id="findHistoryResultBtn" class="premium-button">Generate Report</button>
                    </div>
                    
                    <!-- Removed historySummaryResult from here -->
                    <!-- <div id="historySummaryResult" class="section-card" style="margin-top: 20px;">
                        <h2>Report Summary</h2>
                        <div class="summary-cards-grid">
                            <div class="summary-card">
                                <h4>Total Hours</h4>
                                <span class="value" id="historySummaryTotalHours">0</span>
                            </div>
                            <div class="summary-card">
                                <h4>Late</h4>
                                <span class="value" id="historySummaryLate">00:00</span>
                            </div>
                            <div class="summary-card">
                                <h4>Absent</h4>
                                <span class="value" id="historySummaryAbsent">0</span>
                            </div>
                            <div class="summary-card">
                                <h4>Weekends</h4>
                                <span class="value" id="historySummaryWeekend">0</span>
                            </div>
                            <div class="summary-card">
                                <h4>Holidays</h4>
                                <span class="value" id="historySummaryHoliday">0</span>
                            </div>
                            <div class="summary-card">
                                <h4>Working Days</h4>
                                <span class="value" id="historySummaryWorkingDays">0</span>
                            </div>
                            <div class="summary-card">
                                <h4>Total Present</h4>
                                <span class="value" id="historySummaryTotalPresent">0</span>
                            </div>
                            <div class="summary-card">
                                <h4>Night Shifts</h4>
                                <span class="value" id="historySummaryNightShifts">0</span>
                            </div>
                            <div class="summary-card">
                                <h4>Day Shifts</h4>
                                <span class="value" id="historySummaryDayShifts">0</span>
                            </div>
                            <div class="summary-card">
                                <h4>Grace Used</h4>
                                <span class="value" id="historySummaryGrace">0</span>
                            </div>
                        </div>
                    </div> -->

                    <div id="historyDetailedEntries" class="table-responsive" style="margin-top: 20px;">
                        <h2>Detailed Entries</h2>
                        <table id="historyAttendanceTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Day</th>
                                    <th>Status</th>
                                    <th>Hour</th>
                                    <th>Extra Hour</th>
                                    <th>Late</th>
                                    <th>Shift</th>
                                    <th>Grace</th>
                                    <th>Approval</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Detailed entries will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </section>
                
                <!-- My Profile Page Section (initially hidden) -->
                <section id="profilePageSection" class="page-transition" style="display: none;">
                    <div class="profile-content-card">
                        <h2>Edit Profile</h2>
                        <div class="profile-picture-upload">
                            <img id="profilePicturePreview" src="https://placehold.co/120x120/DEE2E6/343A40?text=U" alt="Profile Picture Preview" class="user-photo-preview">
                            <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                            <label for="profilePictureInput" class="premium-button secondary">Upload New Photo</label>
                            <button id="removeProfilePhotoBtn" class="premium-button delete-button" style="display: none;">Remove Photo</button>
                            <div class="photo-suggestions">
                                <img src="https://placehold.co/50x50/A6D1F5/000000?text=Boy1" alt="Suggested Photo Boy 1" data-url="https://placehold.co/120x120/A6D1F5/000000?text=Boy1">
                                <img src="https://placehold.co/50x50/C6E2FF/000000?text=Boy2" alt="Suggested Photo Boy 2" data-url="https://placehold.co/120x120/C6E2FF/000000?text=Boy2">
                                <img src="https://placehold.co/50x50/FFD9E2/000000?text=Girl1" alt="Suggested Photo Girl 1" data-url="https://placehold.co/120x120/FFD9E2/000000?text=Girl1">
                                <img src="https://placehold.co/50x50/FFC9E2/000000?text=Girl2" alt="Suggested Photo Girl 2" data-url="https://placehold.co/120x120/FFC9E2/000000?text=Girl2">
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="profileNameInput">Profile Name</label>
                            <input type="text" id="profileNameInput" placeholder="Enter your display name">
                        </div>
                        <div class="input-group">
                            <label for="usernameInput">Username</label>
                            <input type="text" id="usernameInput" placeholder="Enter your username">
                        </div>
                        <div class="input-group">
                            <label for="emailInput">Email Address</label>
                            <input type="email" id="emailInput" placeholder="Your email address">
                            <small style="color: var(--text-secondary); font-size: 0.75rem;">Changing email here will not change your primary login account.</small>
                        </div>
                        <div class="input-group">
                            <label for="profileJoiningDateInput">Joining Date</label>
                            <input type="date" id="profileJoiningDateInput">
                        </div>
                        <div class="input-group">
                            <label for="profileLngIdInput">LnG ID</label>
                            <input type="text" id="profileLngIdInput" placeholder="Your LnG ID">
                        </div>
                        <div class="input-group">
                            <label for="employeeTypeInput">Employee Type</label>
                            <input type="text" id="employeeTypeInput" value="Resource pool" placeholder="e.g., Resource pool">
                        </div>
                        <div class="input-group">
                            <label for="resourcefulTypeInput">Resourceful Type</label>
                            <input type="text" id="resourcefulTypeInput" value="Associate Department Operations" placeholder="e.g., Associate Department Operations">
                        </div>
                        <div class="input-group">
                            <label for="unitInput">Unit</label>
                            <input type="text" id="unitInput" value="Collection & Projects" placeholder="e.g., Collection & Projects">
                        </div>
                        <div class="input-group">
                            <label for="teamInput">Team</label>
                            <input type="text" id="teamInput" value="BCBS" placeholder="e.g., BCBS">
                        </div>
                        <div class="input-group">
                            <label for="designationInput">Designation</label>
                            <input type="text" id="designationInput" value="Junior Associate" placeholder="e.g., Junior Associate">
                        </div>
                        <button id="saveProfileBtn" class="premium-button">Save Changes</button>
                    </div>
                    <!-- Removed extra profile details from here -->
                </section>
            </div>
            
            <!-- Footer -->
            <footer>
                <div class="footer-section">
                    <h4>Contact Us</h4>
                    <p><i class="fas fa-phone"></i> +8801518138951</p>
                    <p><i class="fas fa-envelope"></i> <a href="mailto:prantorodrix9@gmail.com">prantorodrix9@gmail.com</a></p>
                    <p><i class="fas fa-map-marker-alt"></i> Baridhara-DOHS, Gulshan, Dhaka</p>
                </div>
                <div class="footer-section">
                    <h4>TrackFlow</h4>
                    <p>&copy; <span id="currentYear"></span> TrackFlow</p>
                </div>
                <div class="footer-section">
                    <h4>Connect</h4>
                    <p><i class="fab fa-linkedin"></i> <a href="https://www.linkedin.com/in/prantoanthonyrodrix" target="_blank">LinkedIn</a></p>
                    <p><i class="fab fa-github"></i> <a href="https://github.com/PrantoAnthonyRodrix" target="_blank">GitHub</a></p>
                </div>
            </footer>
        </div>

        <!-- Right Sidebar -->
        <aside id="rightSidebar" class="collapsed">
            <!-- Dashboard Summary (visible only on dashboard) -->
            <div id="dashboardSummaryRight" class="right-sidebar-section">
                <h3>Monthly Summary</h3>
                <div class="right-sidebar-item"><span>Total Hours:</span> <strong id="rsTotalHours">0</strong></div>
                <div class="right-sidebar-item"><span>Late:</span> <strong id="rsLate">00:00</strong></div>
                <div class="right-sidebar-item"><span>Absent:</span> <strong id="rsAbsent">0</strong></div>
                <div class="right-sidebar-item"><span>Weekends:</span> <strong id="rsWeekend">0</strong></div>
                <div class="right-sidebar-item"><span>Holidays:</span> <strong id="rsHoliday">0</strong></div>
                <div class="right-sidebar-item"><span>Working Days:</span> <strong id="rsWorkingDays">0</strong></div>
                <div class="right-sidebar-item"><span>Total Present:</span> <strong id="rsTotalPresent">0</strong></div>
                <div class="right-sidebar-item"><span>Night Shifts:</span> <strong id="rsNightShifts">0</strong></div>
                <div class="right-sidebar-item"><span>Day Shifts:</span> <strong id="rsDayShifts">0</strong></div>
                <div class="right-sidebar-item"><span>Grace Used:</span> <strong id="rsGrace">0</strong></div>
            </div>

            <!-- History Summary (visible only on history page) -->
            <div id="historySummaryRight" class="right-sidebar-section" style="display: none;">
                <h3>Report Summary</h3>
                <div class="right-sidebar-item"><span>Total Hours:</span> <strong id="rhsTotalHours">0</strong></div>
                <div class="right-sidebar-item"><span>Late:</span> <strong id="rhsLate">00:00</strong></div>
                <div class="right-sidebar-item"><span>Absent:</span> <strong id="rhsAbsent">0</strong></div>
                <div class="right-sidebar-item"><span>Weekends:</span> <strong id="rhsWeekend">0</strong></div>
                <div class="right-sidebar-item"><span>Holidays:</span> <strong id="rhsHoliday">0</strong></div>
                <div class="right-sidebar-item"><span>Working Days:</span> <strong id="rhsWorkingDays">0</strong></div>
                <div class="right-sidebar-item"><span>Total Present:</span> <strong id="rhsTotalPresent">0</strong></div>
                <div class="right-sidebar-item"><span>Night Shifts:</span> <strong id="rhsNightShifts">0</strong></div>
                <div class="right-sidebar-item"><span>Day Shifts:</span> <strong id="rhsDayShifts">0</strong></div>
                <div class="right-sidebar-item"><span>Grace Used:</span> <strong id="rhsGrace">0</strong></div>
            </div>

            <!-- Profile Details (visible only on profile page) -->
            <div id="profileDetailsRight" class="right-sidebar-section" style="display: none;">
                <h3>My Details</h3>
                <div class="profile-detail-item">
                    <label>Profile Name:</label>
                    <div class="value-wrapper"><i class="fas fa-user"></i> <span id="rpProfileName"></span></div>
                </div>
                <div class="profile-detail-item">
                    <label>Username:</label>
                    <div class="value-wrapper"><i class="fas fa-user-tag"></i> <span id="rpUsername"></span></div>
                </div>
                <div class="profile-detail-item">
                    <label>Email:</label>
                    <div class="value-wrapper"><i class="fas fa-envelope"></i> <span id="rpEmail"></span></div>
                </div>
                <div class="profile-detail-item">
                    <label>Joining Date:</label>
                    <div class="value-wrapper"><i class="fas fa-calendar-alt"></i> <span id="rpJoiningDate"></span></div>
                </div>
                <div class="profile-detail-item">
                    <label>LnG ID:</label>
                    <div class="value-wrapper"><i class="fas fa-id-badge"></i> <span id="rpLngId"></span></div>
                </div>
                <div class="profile-detail-item">
                    <label>Employee Type:</label>
                    <div class="value-wrapper"><i class="fas fa-user-tie"></i> <span id="rpEmployeeType"></span></div>
                </div>
                <div class="profile-detail-item">
                    <label>Resourceful Type:</label>
                    <div class="value-wrapper"><i class="fas fa-briefcase"></i> <span id="rpResourcefulType"></span></div>
                </div>
                <div class="profile-detail-item">
                    <label>Unit:</label>
                    <div class="value-wrapper"><i class="fas fa-building"></i> <span id="rpUnit"></span></div>
                </div>
                <div class="profile-detail-item">
                    <label>Team:</label>
                    <div class="value-wrapper"><i class="fas fa-users"></i> <span id="rpTeam"></span></div>
                </div>
                <div class="profile-detail-item">
                    <label>Designation:</label>
                    <div class="value-wrapper"><i class="fas fa-user-graduate"></i> <span id="rpDesignation"></span></div>
                </div>
            </div>
        </aside>

        <!-- Edit/Delete Modal (Now handles Add/Edit/Delete) -->
        <div id="editDeleteModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeEditDeleteModal">&times;</span>
                <h2 id="editDeleteModalTitle"></h2>
                <div class="input-group">
                    <label for="editDate">Date</label>
                    <input type="date" id="editDate" readonly>
                </div>
                <div class="input-group">
                    <label for="editStatus">Status</label>
                    <select id="editStatus">
                        <option value="Present">Present</option>
                        <option value="Weekend">Weekend</option>
                        <option value="Absent">Absent</option>
                        <option value="Holiday">General Holiday</option>
                        <option value="Government_Holiday">Government Holiday</option>
                        <option value="Sick_Leave">Sick Leave</option>
                    </select>
                </div>
                <div class="input-group" id="editHourGroup">
                    <label for="editHour">Hours Worked</label>
                    <input type="number" id="editHour" min="0" max="24" placeholder="e.g., 9">
                </div>
                <div class="input-group" id="editExtraHourGroup">
                    <label for="editExtraHour">Extra Hours</label>
                    <input type="number" id="editExtraHour" min="0" max="24" placeholder="e.g., 2">
                </div>
                <div class="input-group" id="editLateHourGroup">
                    <label for="editLateHour">Late (HH:MM)</label>
                    <input type="text" id="editLateHour" value="00:00" readonly>
                </div>
                <div class="input-group" id="editShiftTypeGroup">
                    <label for="editShiftType">Shift Type</label>
                    <select id="editShiftType">
                        <option value="Day">Day</option>
                        <option value="Night">Night</option>
                    </select>
                </div>
                <div class="input-group" id="editGraceGroup">
                    <label for="editGrace">Apply Grace Period</label>
                    <select id="editGrace">
                        <option value="-">-</option>
                        <option value="Yes">Yes</option>
                    </select>
                    <small id="editGraceLimitMessage" style="color: var(--alert-error); display: none;">Grace limit reached for this month (5/5)</small>
                </div>
                <div class="input-group" id="editApprovalGroup">
                    <label for="editApproval">Approval Status</label>
                    <select id="editApproval">
                        <option value="-">-</option>
                        <option value="Approved">Approved</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button id="updateEntryBtn" class="premium-button"></button> <!-- Text updated by JS -->
                    <button id="deleteEntryBtn" class="premium-button delete-button" style="display:none;">Delete Entry</button>
                    <button id="cancelEditEntryBtn" class="premium-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- New Modals for Dashboard Details -->
        <!-- Total Working Days Modal -->
        <div id="totalWorkingDaysModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeTotalWorkingDaysModal">&times;</span>
                <h2>Total Working Days Details</h2>
                <p><strong>Selected Month:</strong> <span id="twdMonthDisplay"></span></p>
                <p><strong>Total Days in Month:</strong> <span id="twdTotalDays"></span></p>
                <p><strong>Total Sundays:</strong> <span id="twdTotalSundays"></span></p>
                <p><strong>Calculated Working Days:</strong> <span id="twdCalculatedWorkingDays"></span></p>
                <div class="modal-buttons">
                    <button class="premium-button" onclick="closeCustomModal(document.getElementById('totalWorkingDaysModal'))">OK</button>
                </div>
            </div>
        </div>

        <!-- COLA Eligibility Modal -->
        <div id="colaEligibilityModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeColaEligibilityModal">&times;</span>
                <h2>COLA Eligibility Details</h2>
                <p><strong>Selected Month:</strong> <span id="colaMonthDisplay"></span></p>
                <p><strong>Total Working Days:</strong> <span id="colaTotalWorkingDays"></span></p>
                <p><strong>Required Present Days:</strong> <span id="colaRequiredPresentDays"></span></p>
                <p><strong>Your Present Days:</strong> <span id="colaYourPresentDays"></span></p>
                <div class="cola-progress-bar-container" style="height: 20px; margin-top: 15px;">
                    <div class="cola-progress-bar" id="colaModalProgressBar" style="height: 100%;"></div>
                </div>
                <div class="cola-eligibility-status" id="colaModalEligibilityStatus" style="justify-content: center; margin-top: 10px; font-size: 1rem;"></div>
                
                <h4 style="margin-top: 20px; text-align: center;">COLA Rules:</h4>
                <ul style="list-style-type: disc; padding-left: 20px; font-size: 0.85rem; color: var(--text-secondary);">
                    <li>If Working days 27-26 days, Need present 22 days.</li>
                    <li>If working days 25-24 days, Need present 21 Days.</li>
                    <li>If working days below 24 days, Need Present 20 days.</li>
                </ul>
                <div class="modal-buttons">
                    <button class="premium-button" onclick="closeCustomModal(document.getElementById('colaEligibilityModal'))">OK</button>
                </div>
            </div>
        </div>

        <!-- Category Details Modal -->
        <div id="categoryDetailsModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeCategoryDetailsModal">&times;</span>
                <h2>Employee Category Details</h2>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead>
                        <tr style="background-color: var(--table-header-bg);">
                            <th style="padding: 8px; border: 1px solid var(--border-color); text-align: left;">Category</th>
                            <th style="padding: 8px; border: 1px solid var(--border-color); text-align: left;">Treated As</th>
                            <th style="padding: 8px; border: 1px solid var(--border-color); text-align: left;">Eligibility Working Hours %</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">A</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">Excellent</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">90%-100%</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">B</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">Very Good</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">85%-89%</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">C</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">Good</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">80%-84%</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">D</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">Need Improvement</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">75%-79%</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">E</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">Failure</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">Below 70% or equal to 74%</td>
                        </tr>
                    </tbody>
                </table>
                <div class="modal-buttons">
                    <button class="premium-button" onclick="closeCustomModal(document.getElementById('categoryDetailsModal'))">OK</button>
                </div>
            </div>
        </div>


        <!-- Custom Alert Modal (for general messages) -->
        <div id="customAlertModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeCustomAlertModal">&times;</span>
                <h2 id="customAlertTitle"></h2>
                <p id="customAlertMessage"></p>
                <div class="modal-buttons">
                    <button id="customAlertOkBtn" class="premium-button">OK</button>
                </div>
            </div>
        </div>

        <!-- Custom Confirm Modal (for yes/no questions) -->
        <div id="customConfirmModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeCustomConfirmModal">&times;</span>
                <h2 id="customConfirmTitle"></h2>
                <p id="customConfirmMessage"></p>
                <div class="modal-buttons">
                    <button id="customConfirmYesBtn" class="premium-button">Yes</button>
                    <button id="customConfirmNoBtn" class="premium-button secondary">No</button>
                </div>
            </div>
        </div>

        <!-- Notification Modal -->
        <div id="notificationModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeNotificationModal">&times;</span>
                <h2>Notifications</h2>
                <p>No Notification here 🥱</p>
                <div class="modal-buttons">
                    <button id="notificationOkBtn" class="premium-button">OK</button>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="modal">
            <div class="modal-content help-modal-content">
                <span class="close-button" id="closeHelpModal">&times;</span>
                <h2 id="helpModalTitle">Need Assistance?</h2>
                <p id="helpModalMessage">Feel free to contact support or refer to the documentation for any queries!</p>
            </div>
        </div>

    </div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            // Local Data Storage (Loaded from localStorage or initialized)
            let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers')) || [];
            let currentLoggedInUser = null; 

            // Save registeredUsers to localStorage
            function saveRegisteredUsers() {
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            }

            // Save currentLoggedInUser's specific data
            function saveCurrentUserData() {
                if (currentLoggedInUser) {
                    const userIndex = registeredUsers.findIndex(user => user.email === currentLoggedInUser.email);
                    if (userIndex !== -1) {
                        registeredUsers[userIndex] = currentLoggedInUser;
                    } else {
                        // If user not found (e.g., first run after localStorage clear), add them
                        registeredUsers.push(currentLoggedInUser);
                    }
                    saveRegisteredUsers();
                }
            }

            // --- Custom Alert/Confirm Modals DOM Elements ---
            const customAlertModal = document.getElementById('customAlertModal');
            const customAlertTitle = document.getElementById('customAlertTitle');
            const customAlertMessage = document.getElementById('customAlertMessage');
            const customAlertOkBtn = document.getElementById('customAlertOkBtn');
            const closeCustomAlertModal = document.getElementById('closeCustomAlertModal');

            const customConfirmModal = document.getElementById('customConfirmModal');
            const customConfirmTitle = document.getElementById('customConfirmTitle');
            const customConfirmMessage = document.getElementById('customConfirmMessage');
            const customConfirmYesBtn = document.getElementById('customConfirmYesBtn');
            const customConfirmNoBtn = document.getElementById('customConfirmNoBtn');
            const closeCustomConfirmModal = document.getElementById('closeCustomConfirmModal');
            let confirmCallback = null; 

            // Notification Modal Elements
            const notificationModal = document.getElementById('notificationModal');
            const closeNotificationModal = document.getElementById('closeNotificationModal');
            const notificationOkBtn = document.getElementById('notificationOkBtn');
            const headerNotificationIcon = document.querySelector('.header-actions .fa-bell');

            // Help Modal elements
            const helpModal = document.getElementById('helpModal');
            const closeHelpModal = helpModal ? helpModal.querySelector('.close-button') : null;

            // --- DOM Elements - Authentication Section ---
            const authSection = document.getElementById('authSection');
            const mainActivitySection = document.getElementById('mainActivitySection');
            const gmailLoginForm = document.getElementById('gmailLoginForm');
            const gmailEmailInput = document.getElementById('gmailEmail');
            const gmailEmailError = document.getElementById('gmailEmailError');


            // --- DOM Elements - Main Activity Section ---
            let sidebar, sidebarToggle, sidebarUserPhoto, sidebarUsername, sidebarUserRole;
            let pageTitleDisplay; // Changed to span for dynamic text

            let personalProfileBtn, logoutBtn, profilePageSection, 
                profileNameInput, usernameInput, emailInput, profilePictureInput, profilePicturePreview, saveProfileBtn,
                profileJoiningDateInput, profileLngIdInput, removeProfilePhotoBtn, photoSuggestionImages;
            let employeeTypeInput, resourcefulTypeInput, unitInput, teamInput, designationInput; /* New Profile fields */

            let sidebarJoiningDuration, sidebarLngId, sidebarEmployeeType, sidebarTeam, sidebarDesignation; /* New sidebar profile fields */

            let monthSelectDropdown, dateFromDisplay, dateToDisplay, 
                summaryTotalHours, summaryLate, summaryAbsent, summaryWeekend, summaryHoliday, summaryWorkingDays, 
                summaryDayShifts, summaryNightShifts, summaryGrace, summaryTotalPresent;

            let dashboardFixedTop; // For blur effect on scroll
            let dashboardScrollingContent; // The scrollable container
            // let dashboardProfileSection; // Removed from dashboard

            let attendanceTableBody, editDeleteModal, editDeleteModalCloseBtn, editDeleteModalTitle, editDateInput, editHourInput,
                editExtraHourInput, editLateHourInput, editShiftTypeInput, updateEntryBtn, deleteEntryBtn, cancelEditEntryBtn, currentYearSpan,
                editStatusInput, editHourGroup, editExtraHourGroup, editLateHourGroup, editShiftTypeGroup, editGraceGroup, editGraceInput, editGraceLimitMessage,
                editApprovalGroup, editApprovalInput;

            let homeNavLink, historyNavLink, helpNavLinkRef; 
            let dailyEntriesSection, historySection; 

            let historyDateFromInput, historyDateToInput, findHistoryResultBtn;
            let historySummaryTotalHours, historySummaryLate, historySummaryAbsent, historySummaryWeekend, historySummaryHoliday,
                historySummaryWorkingDays, historySummaryDayShifts, historySummaryNightShifts, historySummaryGrace, historySummaryTotalPresent;
            let historyAttendanceTableBody;

            let monthlyChart = null;
            let chartPercentageText; // For chart percentage display
            let currentMonthView = new Date(); 

            // Calendar elements
            let calendarGrid, currentMonthYearDisplay, prevMonthBtn, nextMonthBtn;

            // Right Sidebar elements
            let rightSidebar, dashboardSummaryRight, historySummaryRight, profileDetailsRight;
            let rsTotalHours, rsLate, rsAbsent, rsWeekend, rsHoliday, rsWorkingDays, rsTotalPresent, rsNightShifts, rsDayShifts, rsGrace; // Dashboard summary
            let rhsTotalHours, rhsLate, rhsAbsent, rhsWeekend, rhsHoliday, rhsWorkingDays, rhsTotalPresent, rhsNightShifts, rhsDayShifts, rhsGrace; // History summary
            let rpProfileName, rpUsername, rpEmail, rpJoiningDate, rpLngId, rpEmployeeType, rpResourcefulType, rpUnit, rpTeam, rpDesignation; // Profile details

            // Theme Toggle
            let themeToggle;

            // New Dashboard Card Elements
            let totalWorkingDaysDisplay, totalWorkingDaysDetailsBtn,
                colaEligibilityDisplay, colaEligibilityDetailsBtn, colaProgressBar, colaEligibilityStatus,
                employeeCategoryDisplay, categoryDetailsBtn;

            // New Modals
            let totalWorkingDaysModal, closeTotalWorkingDaysModal, twdMonthDisplay, twdTotalDays, twdTotalSundays, twdCalculatedWorkingDays;
            let colaEligibilityModal, closeColaEligibilityModal, colaMonthDisplay, colaTotalWorkingDays, colaRequiredPresentDays, colaYourPresentDays, colaModalProgressBar, colaModalEligibilityStatus;
            let categoryDetailsModal, closeCategoryDetailsModal;


            // --- Initial Setup and Auto-Login Simulation ---
            function initializeApp() {
                const lastLoggedInEmail = localStorage.getItem('lastLoggedInUserEmail');
                if (lastLoggedInEmail) {
                    const user = registeredUsers.find(u => u.email === lastLoggedInEmail);
                    if (user) {
                        currentLoggedInUser = user;
                        showMainActivitySection();
                        return; 
                    }
                }
                showAuthSection(); 
            }

            function showAuthSection() {
                authSection.style.display = 'flex';
                mainActivitySection.style.display = 'none';
                setupAuthPage();
            }

            function showMainActivitySection() {
                authSection.style.display = 'none';
                mainActivitySection.style.display = 'flex'; // Changed to flex for app-layout
                queryMainAppElements(); 
                setupMainApp();
                updateUserProfileDisplay(); 
                populateMonthDropdown(); 
                setupMonthView(currentMonthView); 
                showSection('dashboard');
                // Set initial theme based on localStorage
                const savedTheme = localStorage.getItem('theme') || 'neptune-vibe';
                document.documentElement.setAttribute('data-theme', savedTheme);
                if (themeToggle) {
                    themeToggle.querySelector('i').className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                    themeToggle.querySelector('span').textContent = savedTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
                }
            }

            // --- Authentication Page Setup ---
            function setupAuthPage() {
                if (gmailLoginForm) {
                    gmailLoginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        gmailEmailInput.classList.remove('error');
                        gmailEmailError.textContent = '';

                        const email = gmailEmailInput.value.trim();

                        if (!email) {
                            gmailEmailInput.classList.add('error');
                            gmailEmailError.textContent = 'Gmail address is required.';
                            return;
                        }

                        // Basic Gmail format check
                        if (!email.endsWith('@gmail.com')) {
                            gmailEmailInput.classList.add('error');
                            gmailEmailError.textContent = 'Please enter a valid Gmail address.';
                            return;
                        }

                        let user = registeredUsers.find(u => u.email === email);

                        if (!user) {
                            // Create new user if not found
                            const usernameFromEmail = email.split('@')[0];
                            user = {
                                profileName: usernameFromEmail,
                                username: usernameFromEmail,
                                email: email,
                                photo: `https://placehold.co/36x36/${(Math.random()*0xFFFFFF<<0).toString(16).padStart(6,'0')}/FFFFFF?text=${usernameFromEmail.charAt(0).toUpperCase()}`,
                                joiningDate: new Date().toISOString().split('T')[0], // Current date
                                lngId: `TRK-${Math.floor(Math.random() * 900) + 100}`, // Random ID
                                role: 'Employee',
                                employeeType: 'Resource pool',
                                resourcefulType: 'Associate Department Operations',
                                unit: 'Collection & Projects',
                                team: 'BCBS',
                                designation: 'Junior Associate',
                                attendance: {},
                                graceCounts: {}
                            };
                            registeredUsers.push(user);
                            saveRegisteredUsers();
                        }
                        
                        currentLoggedInUser = user;
                        if (!currentLoggedInUser.attendance) currentLoggedInUser.attendance = {};
                        if (!currentLoggedInUser.graceCounts) currentLoggedInUser.graceCounts = {};
                        // Ensure new profile fields are initialized for existing users (for backward compatibility)
                        if (!currentLoggedInUser.employeeType) currentLoggedInUser.employeeType = 'Resource pool';
                        if (!currentLoggedInUser.resourcefulType) currentLoggedInUser.resourcefulType = 'Associate Department Operations';
                        if (!currentLoggedInUser.unit) currentLoggedInUser.unit = 'Collection & Projects';
                        if (!currentLoggedInUser.team) currentLoggedInUser.team = 'BCBS';
                        if (!currentLoggedInUser.designation) currentLoggedInUser.designation = 'Junior Associate';


                        localStorage.setItem('lastLoggedInUserEmail', email); 
                        showMainActivitySection();
                    });
                }
            }


            // --- Query Main App Elements (after app starts) ---
            function queryMainAppElements() {
                sidebar = document.getElementById('sidebar');
                sidebarToggle = document.getElementById('sidebarToggle');
                sidebarUserPhoto = document.getElementById('sidebarUserPhoto');
                sidebarUsername = document.getElementById('sidebarUsername');
                sidebarUserRole = document.getElementById('sidebarUserRole');
                sidebarJoiningDuration = document.getElementById('sidebarJoiningDuration');
                sidebarLngId = document.getElementById('sidebarLngId');
                sidebarEmployeeType = document.getElementById('sidebarEmployeeType');
                sidebarTeam = document.getElementById('sidebarTeam');
                sidebarDesignation = document.getElementById('sidebarDesignation');


                pageTitleDisplay = document.getElementById('pageTitleDisplay'); // Update to span

                personalProfileBtn = document.getElementById('personalProfileBtn');
                logoutBtn = document.getElementById('logoutBtn');
                
                profilePageSection = document.getElementById('profilePageSection');
                profileNameInput = document.getElementById('profileNameInput');
                usernameInput = document.getElementById('usernameInput');
                emailInput = document.getElementById('emailInput');
                profilePictureInput = document.getElementById('profilePictureInput');
                saveProfileBtn = document.getElementById('saveProfileBtn');
                profileJoiningDateInput = document.getElementById('profileJoiningDateInput');
                profileLngIdInput = document.getElementById('profileLngIdInput');
                profilePicturePreview = document.querySelector('#profilePageSection .user-photo-preview');
                removeProfilePhotoBtn = document.getElementById('removeProfilePhotoBtn');
                photoSuggestionImages = document.querySelectorAll('.photo-suggestions img');

                employeeTypeInput = document.getElementById('employeeTypeInput');
                resourcefulTypeInput = document.getElementById('resourcefulTypeInput');
                unitInput = document.getElementById('unitInput');
                teamInput = document.getElementById('teamInput');
                designationInput = document.getElementById('designationInput');


                monthSelectDropdown = document.getElementById('monthSelectDropdown');
                dateFromDisplay = document.getElementById('dateFrom');
                dateToDisplay = document.getElementById('dateTo');

                summaryTotalHours = document.getElementById('summaryTotalHours');
                summaryLate = document.getElementById('summaryLate');
                summaryAbsent = document.getElementById('summaryAbsent');
                summaryWeekend = document.getElementById('summaryWeekend');
                summaryHoliday = document.getElementById('summaryHoliday');
                summaryWorkingDays = document.getElementById('summaryWorkingDays');
                summaryDayShifts = document.getElementById('summaryDayShifts');
                summaryNightShifts = document.getElementById('summaryNightShifts');
                summaryGrace = document.getElementById('summaryGrace');
                summaryTotalPresent = document.getElementById('summaryTotalPresent');

                dashboardFixedTop = document.getElementById('dashboardFixedTop'); // Get fixed top section
                dashboardScrollingContent = document.querySelector('.dashboard-scrolling-content'); // Get the scrollable container
                // dashboardProfileSection = document.getElementById('dashboardProfileSection'); // Removed from dashboard

                attendanceTableBody = document.querySelector('#attendanceTable tbody');
                
                editDeleteModal = document.getElementById('editDeleteModal');
                editDeleteModalCloseBtn = editDeleteModal.querySelector('.close-button');
                editDeleteModalTitle = editDeleteModal.querySelector('h2');
                editDateInput = document.getElementById('editDate');
                editStatusInput = document.getElementById('editStatus');
                editHourInput = document.getElementById('editHour');
                editExtraHourInput = document.getElementById('editExtraHour');
                editLateHourInput = document.getElementById('editLateHour');
                editShiftTypeInput = document.getElementById('editShiftType');
                editGraceInput = document.getElementById('editGrace');
                editGraceLimitMessage = document.getElementById('editGraceLimitMessage');
                updateEntryBtn = document.getElementById('updateEntryBtn');
                deleteEntryBtn = document.getElementById('deleteEntryBtn');
                cancelEditEntryBtn = document.getElementById('cancelEditEntryBtn');

                editHourGroup = document.getElementById('editHourGroup');
                editExtraHourGroup = document.getElementById('editExtraHourGroup');
                editLateHourGroup = document.getElementById('editLateHourGroup');
                editShiftTypeGroup = document.getElementById('editShiftTypeGroup');
                editGraceGroup = document.getElementById('editGraceGroup');
                editApprovalGroup = document.getElementById('editApprovalGroup');
                editApprovalInput = document.getElementById('editApproval');

                currentYearSpan = document.getElementById('currentYear');
                
                homeNavLink = document.getElementById('homeNavLink');
                historyNavLink = document.getElementById('historyNavLink');
                helpNavLinkRef = document.getElementById('helpNavLink');
                dailyEntriesSection = document.getElementById('dailyEntriesSection');
                historySection = document.getElementById('historySection');

                historyDateFromInput = document.getElementById('historyDateFrom');
                historyDateToInput = document.getElementById('historyDateTo');
                findHistoryResultBtn = document.getElementById('findHistoryResultBtn');
                historySummaryTotalHours = document.getElementById('historySummaryTotalHours');
                historySummaryLate = document.getElementById('historySummaryLate');
                historySummaryAbsent = document.getElementById('historySummaryAbsent');
                historySummaryWeekend = document.getElementById('historySummaryWeekend');
                historySummaryHoliday = document.getElementById('historySummaryHoliday');
                historySummaryWorkingDays = document.getElementById('historySummaryWorkingDays');
                historySummaryDayShifts = document.getElementById('historySummaryDayShifts');
                historySummaryNightShifts = document.getElementById('historySummaryNightShifts');
                historySummaryGrace = document.getElementById('historySummaryGrace');
                historySummaryTotalPresent = document.getElementById('historySummaryTotalPresent');
                historyAttendanceTableBody = document.querySelector('#historyAttendanceTable tbody');

                chartPercentageText = document.getElementById('chartPercentageText');

                // Calendar elements
                calendarGrid = document.getElementById('calendarGrid');
                currentMonthYearDisplay = document.getElementById('currentMonthYear');
                prevMonthBtn = document.getElementById('prevMonthBtn');
                nextMonthBtn = document.getElementById('nextMonthBtn');

                // Right Sidebar elements
                rightSidebar = document.getElementById('rightSidebar');
                dashboardSummaryRight = document.getElementById('dashboardSummaryRight');
                historySummaryRight = document.getElementById('historySummaryRight');
                profileDetailsRight = document.getElementById('profileDetailsRight');

                rsTotalHours = document.getElementById('rsTotalHours');
                rsLate = document.getElementById('rsLate');
                rsAbsent = document.getElementById('rsAbsent');
                rsWeekend = document.getElementById('rsWeekend');
                rsHoliday = document.getElementById('rsHoliday');
                rsWorkingDays = document.getElementById('rsWorkingDays');
                rsTotalPresent = document.getElementById('rsTotalPresent');
                rsNightShifts = document.getElementById('rsNightShifts');
                rsDayShifts = document.getElementById('rsDayShifts');
                rsGrace = document.getElementById('rsGrace');

                rhsTotalHours = document.getElementById('rhsTotalHours');
                rhsLate = document.getElementById('rhsLate');
                rhsAbsent = document.getElementById('rhsAbsent');
                rhsWeekend = document.getElementById('rhsWeekend');
                rhsHoliday = document.getElementById('rhsHoliday');
                rhsWorkingDays = document.getElementById('rhsWorkingDays');
                rhsTotalPresent = document.getElementById('rhsTotalPresent');
                rhsNightShifts = document.getElementById('rhsNightShifts');
                rhsDayShifts = document.getElementById('rhsDayShifts');
                rhsGrace = document.getElementById('rhsGrace');

                rpProfileName = document.getElementById('rpProfileName');
                rpUsername = document.getElementById('rpUsername');
                rpEmail = document.getElementById('rpEmail');
                rpJoiningDate = document.getElementById('rpJoiningDate');
                rpLngId = document.getElementById('rpLngId');
                rpEmployeeType = document.getElementById('rpEmployeeType');
                rpResourcefulType = document.getElementById('rpResourcefulType');
                rpUnit = document.getElementById('rpUnit');
                rpTeam = document.getElementById('rpTeam');
                rpDesignation = document.getElementById('rpDesignation');

                themeToggle = document.getElementById('themeToggle');

                // New Dashboard Card Elements
                totalWorkingDaysDisplay = document.getElementById('totalWorkingDaysDisplay');
                totalWorkingDaysDetailsBtn = document.getElementById('totalWorkingDaysDetailsBtn');
                colaEligibilityDisplay = document.getElementById('colaEligibilityDisplay');
                colaEligibilityDetailsBtn = document.getElementById('colaEligibilityDetailsBtn');
                colaProgressBar = document.getElementById('colaProgressBar');
                colaEligibilityStatus = document.getElementById('colaEligibilityStatus');
                employeeCategoryDisplay = document.getElementById('employeeCategoryDisplay');
                categoryDetailsBtn = document.getElementById('categoryDetailsBtn');

                // New Modals
                totalWorkingDaysModal = document.getElementById('totalWorkingDaysModal');
                closeTotalWorkingDaysModal = document.getElementById('closeTotalWorkingDaysModal');
                twdMonthDisplay = document.getElementById('twdMonthDisplay');
                twdTotalDays = document.getElementById('twdTotalDays');
                twdTotalSundays = document.getElementById('twdTotalSundays');
                twdCalculatedWorkingDays = document.getElementById('twdCalculatedWorkingDays');

                colaEligibilityModal = document.getElementById('colaEligibilityModal');
                closeColaEligibilityModal = document.getElementById('closeColaEligibilityModal');
                colaMonthDisplay = document.getElementById('colaMonthDisplay');
                colaTotalWorkingDays = document.getElementById('colaTotalWorkingDays');
                colaRequiredPresentDays = document.getElementById('colaRequiredPresentDays');
                colaYourPresentDays = document.getElementById('colaYourPresentDays');
                colaModalProgressBar = document.getElementById('colaModalProgressBar');
                colaModalEligibilityStatus = document.getElementById('colaModalEligibilityStatus');

                categoryDetailsModal = document.getElementById('categoryDetailsModal');
                closeCategoryDetailsModal = document.getElementById('closeCategoryDetailsModal');
            }


            // --- Custom Alert/Confirm Modal Functions ---
            function showCustomAlert(title, message, type = 'info') {
                if (customAlertModal) {
                    customAlertTitle.textContent = title;
                    customAlertMessage.textContent = message;
                    customAlertModal.querySelector('.modal-content').className = 'modal-content ' + type;
                    customAlertModal.style.display = 'flex';
                }
            }

            function closeCustomModal(modalElement) {
                if (modalElement) {
                    modalElement.classList.add('closing'); // Add closing class for animation
                    modalElement.addEventListener('animationend', function handler() {
                        modalElement.style.display = 'none';
                        modalElement.classList.remove('closing');
                        modalElement.removeEventListener('animationend', handler);
                    });
                }
            }

            function closeCustomAlertModalFunc() {
                closeCustomModal(customAlertModal);
            }

            function showCustomConfirm(title, message, onConfirm) {
                if (customConfirmModal) {
                    customConfirmTitle.textContent = title;
                    customConfirmMessage.textContent = message;
                    customConfirmModal.querySelector('.modal-content').className = 'modal-content info';
                    confirmCallback = onConfirm;
                    customConfirmModal.style.display = 'flex';
                }
            }

            function closeCustomConfirmModalFunc() {
                closeCustomModal(customConfirmModal);
                confirmCallback = null;
            }

            function setupMainApp() {
                if (currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();
                
                // Sidebar toggle
                if (sidebarToggle) {
                    sidebarToggle.addEventListener('click', () => {
                        sidebar.classList.toggle('collapsed');
                        // Update icon direction
                        const icon = sidebarToggle.querySelector('i');
                        if (sidebar.classList.contains('collapsed')) {
                            icon.classList.remove('fa-chevron-left');
                            icon.classList.add('fa-chevron-right');
                        } else {
                            icon.classList.remove('fa-chevron-right');
                            icon.classList.add('fa-chevron-left');
                        }
                    });
                }

                if (personalProfileBtn) {
                    personalProfileBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        showSection('profile');
                    });
                }

                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        logout();
                    });
                }

                if (removeProfilePhotoBtn) {
                    removeProfilePhotoBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (profilePicturePreview) {
                            profilePicturePreview.src = `https://placehold.co/120x120/DEE2E6/343A40?text=U`;
                            currentLoggedInUser.photo = profilePicturePreview.src; // Update user object
                            saveCurrentUserData();
                            updateUserProfileDisplay(); // Update all displayed profile info immediately
                            removeProfilePhotoBtn.style.display = 'none'; // Hide remove button
                        }
                    });
                }

                if (photoSuggestionImages) {
                    photoSuggestionImages.forEach(img => {
                        img.addEventListener('click', () => {
                            if (profilePicturePreview) {
                                profilePicturePreview.src = img.dataset.url;
                                currentLoggedInUser.photo = img.dataset.url; // Update user object immediately
                                saveCurrentUserData();
                                updateUserProfileDisplay(); // Update all displayed profile info immediately
                                removeProfilePhotoBtn.style.display = 'inline-flex'; // Show remove button
                            }
                        });
                    });
                }

                if (profilePictureInput) profilePictureInput.addEventListener('change', handleProfilePictureChange);
                if (saveProfileBtn) saveProfileBtn.addEventListener('click', saveProfileChanges);

                if (monthSelectDropdown) {
                    monthSelectDropdown.addEventListener('change', (e) => {
                        const [year, month] = e.target.value.split('-').map(Number);
                        currentMonthView = new Date(year, month - 1, 1);
                        setupMonthView(currentMonthView);
                    });
                }
                
                // Edit/Delete/Add Modal Event Listeners
                if (closeEditDeleteModal) closeEditDeleteModal.addEventListener('click', closeCustomModal.bind(null, editDeleteModal));
                if (editDeleteModal) {
                    editDeleteModal.addEventListener('click', (event) => {
                        if (event.target == editDeleteModal) {
                            closeCustomModal(editDeleteModal);
                        }
                        if (event.target.closest('.modal-content')) {
                            event.stopPropagation();
                        }
                    });
                }
                if (editHourInput && editExtraHourInput && editLateHourInput) {
                    const updateEditLate = () => {
                        editLateHourInput.value = calculateLateTime(parseFloat(editHourInput.value || 0));
                    };
                    editHourInput.addEventListener('input', updateEditLate);
                }
                if (editStatusInput) {
                    editStatusInput.addEventListener('change', toggleEditPresentDetails);
                }
                if (editGraceInput) {
                    editGraceInput.addEventListener('change', () => {
                        const date = editDateInput.value;
                        if (!date) return; 
                        
                        const monthKey = `${new Date(date).getFullYear()}-${String(new Date(date).getMonth() + 1).padStart(2, '0')}`;
                        const graceUsed = getGraceCount(monthKey);
                        const originalEntry = currentLoggedInUser.attendance[date];
                        const wasGrace = originalEntry && originalEntry.status === 'Present' && originalEntry.grace === 'Yes';

                        if (editGraceInput.value === 'Yes') {
                            if (graceUsed >= 5 && !wasGrace) {
                                if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'block';
                                editGraceInput.value = '-'; 
                            } else {
                                if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';
                            }
                        } else {
                            if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';
                        }
                    });
                }
                if (updateEntryBtn) updateEntryBtn.addEventListener('click', handleSaveOrUpdateEntry);
                if (deleteEntryBtn) deleteEntryBtn.addEventListener('click', confirmDeleteEntry);
                if (cancelEditEntryBtn) cancelEditEntryBtn.addEventListener('click', closeCustomModal.bind(null, editDeleteModal));

                if (homeNavLink) homeNavLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection('dashboard');
                });
                if (historyNavLink) historyNavLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection('history');
                });
                if (helpNavLinkRef) {
                    helpNavLinkRef.addEventListener('click', (e) => {
                        e.preventDefault();
                        openHelpModal();
                    });
                }

                if (findHistoryResultBtn) findHistoryResultBtn.addEventListener('click', displayCustomHistorySummary);

                if (customAlertOkBtn) customAlertOkBtn.addEventListener('click', closeCustomAlertModalFunc);
                if (closeCustomAlertModal) closeCustomAlertModal.addEventListener('click', closeCustomAlertModalFunc);
                if (customAlertModal) {
                    customAlertModal.addEventListener('click', (event) => {
                        if (event.target == customAlertModal) {
                            closeCustomAlertModalFunc();
                        }
                    });
                }

                if (customConfirmYesBtn) customConfirmYesBtn.addEventListener('click', () => {
                    if (confirmCallback) {
                        confirmCallback(true);
                    }
                    closeCustomConfirmModalFunc();
                });
                if (customConfirmNoBtn) customConfirmNoBtn.addEventListener('click', () => {
                    if (confirmCallback) {
                        confirmCallback(false);
                    }
                    closeCustomConfirmModalFunc();
                });
                if (closeCustomConfirmModal) closeCustomConfirmModal.addEventListener('click', closeCustomConfirmModalFunc);
                if (customConfirmModal) {
                    customConfirmModal.addEventListener('click', (event) => {
                        if (event.target == customConfirmModal) {
                            closeCustomConfirmModalFunc();
                        }
                    });
                }

                if (headerNotificationIcon) {
                    headerNotificationIcon.addEventListener('click', () => {
                        if (notificationModal) notificationModal.style.display = 'flex';
                    });
                }
                if (closeNotificationModal) closeNotificationModal.addEventListener('click', closeCustomModal.bind(null, notificationModal));
                if (notificationOkBtn) notificationOkBtn.addEventListener('click', closeCustomModal.bind(null, notificationModal));
                if (notificationModal) {
                    notificationModal.addEventListener('click', (event) => {
                        if (event.target == notificationModal) {
                            closeCustomModal(notificationModal);
                        }
                    });
                }


                if (closeHelpModal) closeHelpModal.addEventListener('click', closeCustomModal.bind(null, helpModal));
                if (helpModal) {
                    helpModal.addEventListener('click', (event) => {
                        if (event.target == helpModal) {
                            closeCustomModal(helpModal);
                        }
                    });
                }

                // Add scroll event listener for dashboard fixed top blur effect
                if (dashboardFixedTop && dashboardScrollingContent) {
                    dashboardScrollingContent.addEventListener('scroll', () => {
                        if (dashboardScrollingContent.scrollTop > 50) { // Adjust scroll threshold as needed
                            dashboardFixedTop.classList.add('scrolled');
                        } else {
                            dashboardFixedTop.classList.remove('scrolled');
                        }
                    });
                }

                // Calendar navigation
                if (prevMonthBtn) prevMonthBtn.addEventListener('click', () => {
                    currentMonthView.setMonth(currentMonthView.getMonth() - 1);
                    setupMonthView(currentMonthView);
                    populateMonthDropdown(); // Update dropdown as well
                });
                if (nextMonthBtn) nextMonthBtn.addEventListener('click', () => {
                    currentMonthView.setMonth(currentMonthView.getMonth() + 1);
                    setupMonthView(currentMonthView);
                    populateMonthDropdown(); // Update dropdown as well
                });

                // Theme Toggle Listener
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => {
                        const currentTheme = document.documentElement.getAttribute('data-theme');
                        const newTheme = currentTheme === 'dark' ? 'neptune-vibe' : 'dark';
                        document.documentElement.setAttribute('data-theme', newTheme);
                        localStorage.setItem('theme', newTheme);
                        themeToggle.querySelector('i').className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                        themeToggle.querySelector('span').textContent = newTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
                        // Update chart colors immediately on theme change
                        if (monthlyChart) {
                            monthlyChart.data.datasets[0].backgroundColor = [
                                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-present'),
                                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-absent')
                            ];
                            monthlyChart.options.plugins.legend.labels.color = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
                            monthlyChart.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-secondary');
                            monthlyChart.update();
                        }
                    });
                }


                // Initialize Chart.js
                const ctx = document.getElementById('monthlyAttendanceChart').getContext('2d');
                monthlyChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Total Present', 'Total Absent'], 
                        datasets: [{
                            data: [0, 0], 
                            backgroundColor: [
                                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-present'),
                                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-absent')
                            ],
                            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-secondary'),
                            borderWidth: 1 
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%', 
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                    font: {
                                        family: 'Inter',
                                        size: 9 /* Minimized font size */
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed + ' Days';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                // Update chart colors on theme change (though only one theme now, good practice)
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'data-theme') {
                            if (monthlyChart) {
                                monthlyChart.data.datasets[0].backgroundColor = [
                                    getComputedStyle(document.documentElement).getPropertyValue('--chart-color-present'),
                                    getComputedStyle(document.documentElement).getPropertyValue('--chart-color-absent')
                                ];
                                monthlyChart.options.plugins.legend.labels.color = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
                                monthlyChart.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-secondary');
                                monthlyChart.update();
                            }
                        }
                    });
                });
                observer.observe(document.documentElement, { attributes: true });

                // New Dashboard Card Event Listeners
                if (totalWorkingDaysDetailsBtn) totalWorkingDaysDetailsBtn.addEventListener('click', showTotalWorkingDaysDetails);
                if (closeTotalWorkingDaysModal) closeTotalWorkingDaysModal.addEventListener('click', closeCustomModal.bind(null, totalWorkingDaysModal));
                if (totalWorkingDaysModal) {
                    totalWorkingDaysModal.addEventListener('click', (event) => {
                        if (event.target == totalWorkingDaysModal) {
                            closeCustomModal(totalWorkingDaysModal);
                        }
                    });
                }

                if (colaEligibilityDetailsBtn) colaEligibilityDetailsBtn.addEventListener('click', showColaEligibilityDetails);
                if (closeColaEligibilityModal) closeColaEligibilityModal.addEventListener('click', closeCustomModal.bind(null, colaEligibilityModal));
                if (colaEligibilityModal) {
                    colaEligibilityModal.addEventListener('click', (event) => {
                        if (event.target == colaEligibilityModal) {
                            closeCustomModal(colaEligibilityModal);
                        }
                    });
                }

                if (categoryDetailsBtn) categoryDetailsBtn.addEventListener('click', showCategoryDetails);
                if (closeCategoryDetailsModal) closeCategoryDetailsModal.addEventListener('click', closeCustomModal.bind(null, categoryDetailsModal));
                if (categoryDetailsModal) {
                    categoryDetailsModal.addEventListener('click', (event) => {
                        if (event.target == categoryDetailsModal) {
                            closeCustomModal(categoryDetailsModal);
                        }
                    });
                }
            }

            // --- Section Visibility Control ---
            function showSection(sectionName) {
                // Hide all main content sections wrappers
                if (dashboardFixedTop) dashboardFixedTop.style.display = 'none';
                if (dailyEntriesSection) dailyEntriesSection.style.display = 'none';
                if (historySection) historySection.style.display = 'none';
                if (profilePageSection) profilePageSection.style.display = 'none';

                // Remove page-transition class from all sections first
                document.querySelectorAll('.page-transition').forEach(section => {
                    section.classList.remove('page-transition');
                });

                // Hide all right sidebar sections
                if (dashboardSummaryRight) dashboardSummaryRight.style.display = 'none';
                if (historySummaryRight) historySummaryRight.style.display = 'none';
                if (profileDetailsRight) profileDetailsRight.style.display = 'none';
                if (rightSidebar) rightSidebar.classList.remove('collapsed'); // Ensure right sidebar is visible when a section is active

                const allNavLinks = document.querySelectorAll('.sidebar-menu a');
                allNavLinks.forEach(link => link.classList.remove('active'));

                if (sectionName === 'dashboard') {
                    if (dashboardFixedTop) dashboardFixedTop.style.display = 'flex'; // Changed to grid
                    if (dailyEntriesSection) {
                        dailyEntriesSection.style.display = 'block';
                        dailyEntriesSection.classList.add('page-transition'); // Add transition class
                    }
                    if (dashboardSummaryRight) dashboardSummaryRight.style.display = 'block';
                    setupMonthView(currentMonthView);
                    if (homeNavLink) homeNavLink.classList.add('active');
                    if (pageTitleDisplay) pageTitleDisplay.textContent = 'Dashboard';
                } else if (sectionName === 'history') {
                    if (historySection) {
                        historySection.style.display = 'flex';
                        historySection.classList.add('page-transition'); // Add transition class
                    }
                    if (historySummaryRight) historySummaryRight.style.display = 'block';
                    // Reset history summaries and table
                    if (historySummaryTotalHours) historySummaryTotalHours.textContent = '0';
                    if (historySummaryLate) historySummaryLate.textContent = '00:00';
                    if (historySummaryAbsent) historySummaryAbsent.textContent = '0';
                    if (historySummaryWeekend) historySummaryWeekend.textContent = '0';
                    if (historySummaryHoliday) historySummaryHoliday.textContent = '0';
                    if (historySummaryWorkingDays) historySummaryWorkingDays.textContent = '0';
                    if (historySummaryDayShifts) historySummaryDayShifts.textContent = '0';
                    if (historySummaryNightShifts) historySummaryNightShifts.textContent = '0';
                    if (historySummaryGrace) historySummaryGrace.textContent = '0';
                    if (historySummaryTotalPresent) historySummaryTotalPresent.textContent = '0';
                    if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';
                    
                    // Reset right sidebar history summary
                    if (rhsTotalHours) rhsTotalHours.textContent = '0';
                    if (rhsLate) rhsLate.textContent = '00:00';
                    if (rhsAbsent) rhsAbsent.textContent = '0';
                    if (rhsWeekend) rhsWeekend.textContent = '0';
                    if (rhsHoliday) rhsHoliday.textContent = '0';
                    if (rhsWorkingDays) rhsWorkingDays.textContent = '0';
                    if (rhsTotalPresent) rhsTotalPresent.textContent = '0';
                    if (rhsNightShifts) rhsNightShifts.textContent = '0';
                    if (rhsDayShifts) rhsDayShifts.textContent = '0';
                    if (rhsGrace) rhsGrace.textContent = '0';

                    if (historyNavLink) historyNavLink.classList.add('active');
                    if (pageTitleDisplay) pageTitleDisplay.textContent = 'Attendance History';
                } else if (sectionName === 'profile') {
                    if (profilePageSection) {
                        profilePageSection.style.display = 'flex';
                        profilePageSection.classList.add('page-transition'); // Add transition class
                    }
                    if (profileDetailsRight) profileDetailsRight.style.display = 'block';
                    updateUserProfileDisplay(); // Load profile data
                    if (personalProfileBtn) personalProfileBtn.classList.add('active');
                    if (pageTitleDisplay) pageTitleDisplay.textContent = 'My Profile';
                }
            }


            // --- Functions (Shared & Main App) ---

            function calculateJoiningDuration(joiningDateStr) {
                if (!joiningDateStr) return "N/A";

                const joiningDate = new Date(joiningDateStr + 'T00:00:00'); // Ensure UTC for consistent calculation
                const today = new Date();

                let years = today.getFullYear() - joiningDate.getFullYear();
                let months = today.getMonth() - joiningDate.getMonth();
                let days = today.getDate() - joiningDate.getDate();

                if (days < 0) {
                    months--;
                    // Get days in the month before 'today's month'
                    days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
                }

                if (months < 0) {
                    years--;
                    months += 12;
                }
                return `${years} Years, ${months} Months, ${days} Days`;
            }


            function updateUserProfileDisplay() {
                if (!currentLoggedInUser) return;

                const displayName = currentLoggedInUser.profileName || currentLoggedInUser.username || currentLoggedInUser.email.split('@')[0] || 'User';
                const placeholderBg = 'DEE2E6';
                const placeholderText = '343A40';

                const displayPhoto = currentLoggedInUser.photo || `https://placehold.co/36x36/${(Math.random()*0xFFFFFF<<0).toString(16).padStart(6,'0')}/FFFFFF?text=${displayName.charAt(0).toUpperCase()}`;

                // Sidebar main user info
                if (sidebarUsername) sidebarUsername.textContent = displayName;
                if (sidebarUserPhoto) sidebarUserPhoto.src = displayPhoto;
                if (sidebarUserRole) sidebarUserRole.textContent = currentLoggedInUser.designation || currentLoggedInUser.role || 'Employee';
                
                // Sidebar mini profile details
                if (sidebarJoiningDuration) sidebarJoiningDuration.textContent = calculateJoiningDuration(currentLoggedInUser.joiningDate);
                if (sidebarLngId) sidebarLngId.textContent = currentLoggedInUser.lngId || '';
                if (sidebarEmployeeType) sidebarEmployeeType.textContent = currentLoggedInUser.employeeType || '';
                if (sidebarTeam) sidebarTeam.textContent = currentLoggedInUser.team || '';
                if (sidebarDesignation) sidebarDesignation.textContent = currentLoggedInUser.designation || '';

                // My Profile Page (Edit Profile)
                if (emailInput) emailInput.value = currentLoggedInUser.email || '';
                if (profileNameInput) profileNameInput.value = currentLoggedInUser.profileName || '';
                if (usernameInput) usernameInput.value = currentLoggedInUser.username || '';
                if (profileJoiningDateInput) profileJoiningDateInput.value = currentLoggedInUser.joiningDate || '';
                if (profileLngIdInput) profileLngIdInput.value = currentLoggedInUser.lngId || '';
                if (profilePicturePreview) profilePicturePreview.src = currentLoggedInUser.photo || `https://placehold.co/120x120/${placeholderBg}/${placeholderText}?text=${displayName.charAt(0).toUpperCase()}`;
                
                // New profile fields for edit page
                if (employeeTypeInput) employeeTypeInput.value = currentLoggedInUser.employeeType || '';
                if (resourcefulTypeInput) resourcefulTypeInput.value = currentLoggedInUser.resourcefulType || '';
                if (unitInput) unitInput.value = currentLoggedInUser.unit || '';
                if (teamInput) teamInput.value = currentLoggedInUser.team || '';
                if (designationInput) designationInput.value = currentLoggedInUser.designation || '';

                if (profilePicturePreview && currentLoggedInUser.photo && currentLoggedInUser.photo.includes('placehold.co')) {
                    if (removeProfilePhotoBtn) removeProfilePhotoBtn.style.display = 'none';
                } else {
                    if (removeProfilePhotoBtn) removeProfilePhotoBtn.style.display = 'inline-flex';
                }

                // Right Sidebar Profile Details
                if (rpProfileName) rpProfileName.textContent = currentLoggedInUser.profileName || '';
                if (rpUsername) rpUsername.textContent = currentLoggedInUser.username || '';
                if (rpEmail) rpEmail.textContent = currentLoggedInUser.email || '';
                if (rpJoiningDate) rpJoiningDate.textContent = formatDisplayDate(currentLoggedInUser.joiningDate) || '';
                if (rpLngId) rpLngId.textContent = currentLoggedInUser.lngId || '';
                if (rpEmployeeType) rpEmployeeType.textContent = currentLoggedInUser.employeeType || '';
                if (rpResourcefulType) rpResourcefulType.textContent = currentLoggedInUser.resourcefulType || '';
                if (rpUnit) rpUnit.textContent = currentLoggedInUser.unit || '';
                if (rpTeam) rpTeam.textContent = currentLoggedInUser.team || '';
                if (rpDesignation) rpDesignation.textContent = currentLoggedInUser.designation || '';
            }

            function saveProfileChanges() {
                if (!currentLoggedInUser) return;

                const updatedProfile = {
                    profileName: profileNameInput.value.trim(),
                    username: usernameInput.value.trim(),
                    email: emailInput.value.trim(), // Now editable
                    joiningDate: profileJoiningDateInput.value,
                    lngId: profileLngIdInput.value.trim(),
                    photo: profilePicturePreview.src, 
                    employeeType: employeeTypeInput.value.trim(),
                    resourcefulType: resourcefulTypeInput.value.trim(),
                    unit: unitInput.value.trim(),
                    team: teamInput.value.trim(),
                    designation: designationInput.value.trim()
                };

                currentLoggedInUser = { ...currentLoggedInUser, ...updatedProfile };
                saveCurrentUserData(); 

                updateUserProfileDisplay(); // Update all displayed profile info immediately
                showCustomAlert('Profile Updated', 'Your profile changes have been saved successfully!', 'success');
            }

            function handleProfilePictureChange(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (profilePicturePreview) profilePicturePreview.src = e.target.result;
                        currentLoggedInUser.photo = e.target.result; // Update user object immediately
                        saveCurrentUserData();
                        updateUserProfileDisplay(); // Update all displayed profile info immediately
                        if (removeProfilePhotoBtn) removeProfilePhotoBtn.style.display = 'inline-flex';
                    };
                    reader.readAsDataURL(file);
                }
            }

            function logout() {
                localStorage.removeItem('lastLoggedInUserEmail'); 
                currentLoggedInUser = null; 
                showAuthSection(); 
            }

            function getMonthRange(date) {
                const year = date.getFullYear();
                const month = date.getMonth(); 

                // Start date is 26th of previous month
                const startDate = new Date(year, month - 1, 26);
                // End date is 25th of current month
                const endDate = new Date(year, month, 25);

                return { start: startDate, end: endDate };
            }

            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function formatDisplayDate(date) {
                const options = { month: 'short', day: '2-digit', year: 'numeric' };
                return new Date(date).toLocaleDateString('en-US', options);
            }
            
            function getDayOfWeek(date) {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return days[new Date(date).getDay()];
            }

            function populateMonthDropdown() {
                if (!monthSelectDropdown) return;

                monthSelectDropdown.innerHTML = ''; 
                const today = new Date();
                const currentMonth = today.getMonth(); 
                const currentYear = today.getFullYear();

                for (let i = -6; i <= 6; i++) {
                    const date = new Date(currentYear, currentMonth + i, 1);
                    const optionValue = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const optionText = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionText;

                    if (date.getFullYear() === currentMonthView.getFullYear() && date.getMonth() === currentMonthView.getMonth()) {
                        option.selected = true;
                    }
                    monthSelectDropdown.appendChild(option);
                }
            }

            function setupMonthView(date) {
                const { start, end } = getMonthRange(date);
                if (dateFromDisplay) dateFromDisplay.textContent = formatDisplayDate(start);
                if (dateToDisplay) dateToDisplay.textContent = formatDisplayDate(end);
                displayAttendanceHistory();
                renderCalendar(date); // Render calendar for the current month view
                updateDashboardCards(date); // Update new dashboard cards
            }

            function calculateLateTime(hour) {
                const standardHour = 9;
                if (hour < standardHour) {
                    const diffMinutes = (standardHour - hour) * 60;
                    const hours = Math.floor(diffMinutes / 60);
                    const minutes = Math.round(diffMinutes % 60);
                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                }
                return "00:00";
            }

            function getGraceCount(monthKey) {
                if (!currentLoggedInUser || !currentLoggedInUser.graceCounts) return 0;
                return currentLoggedInUser.graceCounts[monthKey] || 0;
            }

            function updateGraceCount(monthKey, increment) {
                let newGraceCounts = { ...(currentLoggedInUser.graceCounts || {}) };
                newGraceCounts[monthKey] = (newGraceCounts[monthKey] || 0) + increment;
                currentLoggedInUser.graceCounts = newGraceCounts; 
                saveCurrentUserData(); 
            }

            function checkGraceLimit(monthKey) {
                return getGraceCount(monthKey) >= 5;
            }

            function displayAttendanceHistory() {
                if (!attendanceTableBody || !currentLoggedInUser) return;

                attendanceTableBody.innerHTML = '';
                const { start, end } = getMonthRange(currentMonthView);

                const currentUserAttendance = currentLoggedInUser.attendance || {};

                let totalHours = 0;
                let totalLateMinutes = 0;
                let totalAbsentDays = 0;
                let totalWeekendDays = 0;
                let totalHolidayDays = 0;
                let totalGovernmentHolidayDays = 0; 
                let totalSickLeaveDays = 0; 
                let totalWorkingDays = 0; /* Only present, absent, govt holiday, sick leave */
                let totalDayShifts = 0;
                let totalNightShifts = 0;
                let totalGraceDays = 0;
                let totalPresentCount = 0; /* All present-like statuses for the chart/summary text */

                let currentDate = new Date(start);
                while (currentDate.getTime() <= end.getTime()) { 
                    const dateKey = formatDate(currentDate);
                    const dayOfWeek = getDayOfWeek(currentDate);
                    const entry = currentUserAttendance[dateKey];

                    const row = attendanceTableBody.insertRow();
                    row.classList.add(`status-${(entry?.status || 'unmarked').toLowerCase()}-row`); 

                    const cellDate = row.insertCell();
                    const cellDay = row.insertCell();
                    const cellStatus = row.insertCell();
                    const cellHour = row.insertCell();
                    const cellExtraHour = row.insertCell();
                    const cellLate = row.insertCell();
                    const cellShift = row.insertCell();
                    const cellGrace = row.insertCell();
                    const cellApproval = row.insertCell(); 
                    const cellActions = row.insertCell();

                    cellDate.textContent = formatDisplayDate(currentDate);
                    cellDay.textContent = dayOfWeek;
                    cellStatus.className = '';

                    if (entry && entry.status) {
                        cellStatus.textContent = entry.status.replace(/_/g, ' '); 
                        cellStatus.classList.add(`status-${entry.status.toLowerCase()}`);

                        if (entry.status === 'Present' || entry.status === 'Government_Holiday' || entry.status === 'Sick_Leave') {
                            cellHour.textContent = entry.hour || '-'; 
                            cellExtraHour.textContent = entry.extraHour || '-';
                            cellLate.textContent = entry.late || '00:00';
                            cellShift.textContent = entry.shift || '-';
                            cellGrace.textContent = entry.grace || '-';
                            cellApproval.textContent = entry.approval || '-';

                            totalHours += (entry.hour || 0) + (entry.extraHour || 0);
                            const [lateHours, lateMinutes] = (entry.late || '00:00').split(':').map(Number);
                            totalLateMinutes += (lateHours * 60) + lateMinutes;

                            if (entry.shift === 'Day') totalDayShifts++;
                            else if (entry.shift === 'Night') totalNightShifts++;
                            
                            // Only count these as working days for 'totalWorkingDays'
                            totalWorkingDays++; 

                            if (entry.grace === 'Yes') totalGraceDays++;

                            if (entry.status === 'Government_Holiday') totalGovernmentHolidayDays++;
                            else if (entry.status === 'Sick_Leave') totalSickLeaveDays++;
                            else if (entry.status === 'Present') totalPresentCount++;

                        } else if (entry.status === 'Absent') {
                            cellHour.textContent = '-';
                            cellExtraHour.textContent = '-';
                            cellLate.textContent = '-';
                            cellShift.textContent = '-';
                            cellGrace.textContent = '-';
                            cellApproval.textContent = entry.approval || '-'; 
                            totalAbsentDays++;
                            totalWorkingDays++; /* Absent also counts as a working day (but not present) */
                        }
                        else { 
                            cellHour.textContent = '-';
                            cellExtraHour.textContent = '-';
                            cellLate.textContent = '-';
                            cellShift.textContent = '-';
                            cellGrace.textContent = '-';
                            cellApproval.textContent = '-'; 
                            if (entry.status === 'Weekend') {
                                totalWeekendDays++;
                            } else if (entry.status === 'Holiday') { 
                                totalHolidayDays++;
                            }
                        }
                    } else { 
                        cellStatus.textContent = '-';
                        cellHour.textContent = '-';
                        cellExtraHour.textContent = '-';
                        cellLate.textContent = '-';
                        cellShift.textContent = '-';
                        cellGrace.textContent = '-';
                        cellApproval.textContent = '-';
                    }

                    const manageEntryBtn = document.createElement('button');
                    manageEntryBtn.textContent = (entry ? 'Manage' : 'Add'); 
                    manageEntryBtn.classList.add('premium-button');
                    if (!entry) manageEntryBtn.classList.add('secondary'); 
                    manageEntryBtn.dataset.date = dateKey;
                    manageEntryBtn.onclick = openManageEntryModal;

                    cellActions.classList.add('table-actions');
                    cellActions.appendChild(manageEntryBtn);

                    currentDate.setDate(currentDate.getDate() + 1);
                }

                if (summaryTotalHours) summaryTotalHours.textContent = totalHours;
                const formattedLateTime = `${String(Math.floor(totalLateMinutes / 60)).padStart(2, '0')}:${String(totalLateMinutes % 60).padStart(2, '0')}`;
                if (summaryLate) summaryLate.textContent = formattedLateTime;
                if (summaryAbsent) summaryAbsent.textContent = totalAbsentDays;
                if (summaryWeekend) summaryWeekend.textContent = totalWeekendDays;
                if (summaryHoliday) summaryHoliday.textContent = totalHolidayDays + totalGovernmentHolidayDays + totalSickLeaveDays; 
                if (summaryWorkingDays) summaryWorkingDays.textContent = totalWorkingDays;
                if (summaryDayShifts) summaryDayShifts.textContent = totalDayShifts;
                if (summaryNightShifts) summaryNightShifts.textContent = totalNightShifts;
                if (summaryGrace) summaryGrace.textContent = totalGraceDays;
                if (summaryTotalPresent) summaryTotalPresent.textContent = totalPresentCount + totalGovernmentHolidayDays + totalSickLeaveDays; 

                // Update right sidebar dashboard summary
                if (rsTotalHours) rsTotalHours.textContent = totalHours;
                if (rsLate) rsLate.textContent = formattedLateTime;
                if (rsAbsent) rsAbsent.textContent = totalAbsentDays;
                if (rsWeekend) rsWeekend.textContent = totalWeekendDays;
                if (rsHoliday) rsHoliday.textContent = totalHolidayDays + totalGovernmentHolidayDays + totalSickLeaveDays;
                if (rsWorkingDays) rsWorkingDays.textContent = totalWorkingDays;
                if (rsTotalPresent) rsTotalPresent.textContent = totalPresentCount + totalGovernmentHolidayDays + totalSickLeaveDays;
                if (rsNightShifts) rsNightShifts.textContent = totalNightShifts;
                if (rsDayShifts) rsDayShifts.textContent = totalDayShifts;
                if (rsGrace) rsGrace.textContent = totalGraceDays;


                if (monthlyChart) {
                    const totalPresentForChart = totalPresentCount + totalGovernmentHolidayDays + totalSickLeaveDays;
                    monthlyChart.data.datasets[0].data = [
                        totalPresentForChart, 
                        totalAbsentDays
                    ];
                    monthlyChart.update();

                    // Update chart percentage text
                    if (chartPercentageText) {
                        const totalDaysForPercentage = totalPresentForChart + totalAbsentDays;
                        if (totalDaysForPercentage > 0) {
                            const percentage = ((totalPresentForChart / totalDaysForPercentage) * 100).toFixed(0);
                            chartPercentageText.textContent = `P-${percentage}%`;
                        } else {
                            chartPercentageText.textContent = 'N/A';
                        }
                    }
                }
            }

            // Calendar Rendering Function
            function renderCalendar(date) {
                if (!calendarGrid || !currentMonthYearDisplay) return;

                calendarGrid.innerHTML = `
                    <div class="calendar-day-name">Sun</div>
                    <div class="calendar-day-name">Mon</div>
                    <div class="calendar-day-name">Tue</div>
                    <div class="calendar-day-name">Wed</div>
                    <div class="calendar-day-name">Thu</div>
                    <div class="calendar-day-name">Fri</div>
                    <div class="calendar-day-name">Sat</div>
                `;

                const year = date.getFullYear();
                const month = date.getMonth();
                currentMonthYearDisplay.textContent = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                const firstDayOfMonth = new Date(year, month, 1);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startingDay = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday, etc.

                const today = new Date();
                const todayKey = formatDate(today);

                const currentUserAttendance = currentLoggedInUser.attendance || {};

                // Add empty cells for days before the 1st of the month
                for (let i = 0; i < startingDay; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.classList.add('calendar-date', 'empty');
                    calendarGrid.appendChild(emptyCell);
                }

                // Add days of the month
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDate = new Date(year, month, i);
                    const dateKey = formatDate(dayDate);
                    const entry = currentUserAttendance[dateKey];

                    const dateCell = document.createElement('div');
                    dateCell.classList.add('calendar-date', 'current-month');
                    dateCell.textContent = i;
                    dateCell.dataset.date = dateKey; // Store full date for easy lookup

                    if (dateKey === todayKey) {
                        dateCell.classList.add('today');
                    }

                    if (entry && entry.status) {
                        dateCell.classList.add(`status-${entry.status.toLowerCase()}`);
                    }

                    dateCell.addEventListener('click', () => {
                        // Open the edit/add modal for this specific date
                        openManageEntryModal({ target: { dataset: { date: dateKey } } });
                    });

                    calendarGrid.appendChild(dateCell);
                }
            }


            function openManageEntryModal(event) {
                const dateToManage = event.target.dataset.date;
                const entry = currentLoggedInUser.attendance[dateToManage];

                if (editDateInput) editDateInput.value = dateToManage;

                if (editStatusInput) editStatusInput.value = 'Present';
                if (editHourInput) editHourInput.value = 9;
                if (editExtraHourInput) editExtraHourInput.value = 0;
                if (editLateHourInput) editLateHourInput.value = '00:00';
                if (editShiftTypeInput) editShiftTypeInput.value = 'Day';
                if (editGraceInput) editGraceInput.value = '-';
                if (editApprovalInput) editApprovalInput.value = '-';
                if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';

                if (entry) { 
                    if (editDeleteModalTitle) editDeleteModalTitle.textContent = 'Edit Attendance Entry';
                    if (updateEntryBtn) updateEntryBtn.textContent = 'Update Entry';
                    if (deleteEntryBtn) deleteEntryBtn.style.display = 'inline-flex'; 

                    if (editStatusInput) editStatusInput.value = entry.status;
                    if (entry.status === 'Present' || entry.status === 'Government_Holiday' || entry.status === 'Sick_Leave' || entry.status === 'Absent') {
                        if (editHourInput) editHourInput.value = entry.hour || 9; 
                        if (editExtraHourInput) editExtraHourInput.value = entry.extraHour || 0;
                        if (editLateHourInput) editLateHourInput.value = entry.late || calculateLateTime(entry.hour || 9);
                        if (editShiftTypeInput) editShiftTypeInput.value = entry.shift || 'Day';
                        if (editGraceInput) editGraceInput.value = entry.grace || '-';
                        if (editApprovalInput) editApprovalInput.value = entry.approval || '-';
                    } else { 
                        if (editHourInput) editHourInput.value = '';
                        if (editExtraHourInput) editExtraHourInput.value = '';
                        if (editLateHourInput) editLateHourInput.value = '00:00';
                        if (editShiftTypeInput) editShiftTypeInput.value = 'Day'; 
                        if (editGraceInput) editGraceInput.value = '-';
                        if (editApprovalInput) editApprovalInput.value = entry.approval || '-';
                    }
                } else { 
                    if (editDeleteModalTitle) editDeleteModalTitle.textContent = 'Add Attendance Entry';
                    if (updateEntryBtn) updateEntryBtn.textContent = 'Save Entry';
                    if (deleteEntryBtn) deleteEntryBtn.style.display = 'none'; 
                }

                toggleEditPresentDetails(); 

                const monthKey = `${new Date(dateToManage).getFullYear()}-${String(new Date(dateToManage).getMonth() + 1).padStart(2, '0')}`;
                const graceLimitReached = checkGraceLimit(monthKey);
                const originalEntry = currentLoggedInUser.attendance[dateToManage];
                const wasGrace = originalEntry && originalEntry.status === 'Present' && originalEntry.grace === 'Yes';

                if (editGraceInput) {
                    const graceOption = editGraceInput.querySelector('option[value="Yes"]');
                    if (graceOption) {
                        if (graceLimitReached && !wasGrace) {
                            graceOption.disabled = true;
                            if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'block';
                        } else {
                            graceOption.disabled = false;
                            if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';
                        }
                    }
                }
                
                if (editDeleteModal) editDeleteModal.style.display = 'flex';
            }

            function closeEditDeleteModalFunc() {
                if (editDeleteModal) {
                    editDeleteModal.classList.add('closing'); // Add closing class for animation
                    editDeleteModal.addEventListener('animationend', function handler() {
                        editDeleteModal.style.display = 'none';
                        editDeleteModal.classList.remove('closing');
                        editDeleteModal.removeEventListener('animationend', handler);

                        // Reset fields for next open to a truly clean state
                        if (editDateInput) editDateInput.value = '';
                        if (editStatusInput) editStatusInput.value = 'Present'; 
                        if (editHourInput) editHourInput.value = '9'; 
                        if (editExtraHourInput) editExtraHourInput.value = '0';
                        if (editLateHourInput) editLateHourInput.value = '00:00';
                        if (editShiftTypeInput) editShiftTypeInput.value = 'Day';
                        if (editGraceInput) editGraceInput.value = '-';
                        if (editApprovalInput) editApprovalInput.value = '-';
                        if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';
                        toggleEditPresentDetails(); 
                    });
                }
            }

            function toggleEditPresentDetails() {
                const status = editStatusInput.value;
                const isPresentLike = (status === 'Present' || status === 'Government_Holiday' || status === 'Sick_Leave');
                const requiresApproval = (status === 'Sick_Leave' || status === 'Holiday' || status === 'Government_Holiday' || (isPresentLike && (parseFloat(editExtraHourInput.value || 0) > 0)));

                // Control visibility of hour/shift related fields
                if (editHourGroup) editHourGroup.style.display = isPresentLike ? 'block' : 'none';
                if (editExtraHourGroup) editExtraHourGroup.style.display = isPresentLike ? 'block' : 'none';
                if (editLateHourGroup) editLateHourGroup.style.display = isPresentLike ? 'block' : 'none';
                if (editShiftTypeGroup) editShiftTypeGroup.style.display = isPresentLike ? 'block' : 'none';
                
                // Grace is only for "Present" status
                if (editGraceGroup) editGraceGroup.style.display = (status === 'Present') ? 'block' : 'none'; 
                
                // Approval is shown for Sick Leave, Holidays, and Present with Extra Hours
                if (editApprovalGroup) editApprovalGroup.style.display = requiresApproval ? 'block' : 'none';

                // Set default hours for some statuses if empty, and clear for "Absent"
                if (status === 'Sick_Leave' || status === 'Government_Holiday') {
                    if (editHourInput) editHourInput.value = 9; 
                    if (editExtraHourInput) editExtraHourInput.value = 0; 
                    if (editLateHourInput) editLateHourInput.value = '00:00'; 
                } else if (status === 'Absent') {
                    // When absent, clear the hour/shift related fields
                    if (editHourInput) editHourInput.value = ''; 
                    if (editExtraHourInput) editExtraHourInput.value = '';
                    if (editLateHourInput) editLateHourInput.value = '00:00'; 
                    if (editShiftTypeInput) editShiftTypeInput.value = 'Day'; 
                    if (editGraceInput) editGraceInput.value = '-'; 
                }

                if (editApprovalInput) { 
                    if (requiresApproval) {
                        if (editApprovalInput.value === '-') { 
                            editApprovalInput.value = 'Approved';
                        }
                    } else {
                         editApprovalInput.value = '-';
                    }
                }
            }

            function handleSaveOrUpdateEntry() {
                const date = editDateInput.value;
                if (!date || !currentLoggedInUser) return;

                const status = editStatusInput.value;
                const monthKey = `${new Date(date).getFullYear()}-${String(new Date(date).getMonth() + 1).padStart(2, '0')}`;
                const existingEntry = currentLoggedInUser.attendance[date];
                const wasPresent = existingEntry && existingEntry.status === 'Present';
                const wasGrace = wasPresent && existingEntry.grace === 'Yes';

                let updatedEntry = { status: status, approval: editApprovalInput.value || '-' };

                if (status === 'Present' || status === 'Government_Holiday' || status === 'Sick_Leave') {
                    const updatedHour = parseFloat(editHourInput.value || 0); 
                    const updatedExtraHour = parseFloat(editExtraHourInput.value || 0); 
                    const updatedShift = editShiftTypeInput.value;
                    const updatedGrace = editGraceInput.value;
                    const updatedLate = calculateLateTime(updatedHour);

                    if (isNaN(updatedHour) || updatedHour < 0 || updatedHour > 24 ||
                        isNaN(updatedExtraHour) || updatedExtraHour < 0 || updatedExtraHour > 24) {
                        showCustomAlert('Input Error', "Please enter valid hour and extra hour values (0-24) for this status.", 'error');
                        return;
                    }

                    const isGraceNow = updatedGrace === 'Yes';
                    if (status === 'Present' && isGraceNow && !wasGrace && checkGraceLimit(monthKey)) {
                        showCustomAlert('Grace Limit Reached', "Cannot apply grace. Monthly limit (5) reached.", 'warning');
                        return;
                    }

                    updatedEntry = {
                        status: status,
                        hour: updatedHour,
                        extraHour: updatedExtraHour,
                        late: updatedLate,
                        shift: updatedShift,
                        grace: updatedGrace,
                        approval: editApprovalInput.value || '-'
                    };

                    if (status === 'Present') {
                        if (isGraceNow && !wasGrace) { 
                            updateGraceCount(monthKey, 1);
                        } else if (!isGraceNow && wasGrace) { 
                            updateGraceCount(monthKey, -1);
                        }
                    } else if (wasPresent && wasGrace) { 
                        updateGraceCount(monthKey, -1);
                    }
                } else if (status === 'Absent') {
                     updatedEntry = {
                        status: status,
                        hour: 0, 
                        extraHour: 0,
                        late: '00:00',
                        shift: 'Day', 
                        grace: '-',
                        approval: editApprovalInput.value || '-'
                    };
                    if (wasPresent && wasGrace) { 
                        updateGraceCount(monthKey, -1);
                    }
                }
                else { 
                    if (wasPresent && wasGrace) { 
                        updateGraceCount(monthKey, -1);
                    }
                    // For Weekend/Holiday, remove hour, extraHour, late, shift, grace from entry
                    delete updatedEntry.hour;
                    delete updatedEntry.extraHour;
                    delete updatedEntry.late;
                    delete updatedEntry.shift;
                    delete updatedEntry.grace;
                }

                currentLoggedInUser.attendance = { ...currentLoggedInUser.attendance, [date]: updatedEntry };
                saveCurrentUserData(); 

                closeCustomModal(editDeleteModal);
                displayAttendanceHistory();
                renderCalendar(currentMonthView); // Update calendar after entry change
                updateDashboardCards(currentMonthView); // Update new dashboard cards
            }

            function confirmDeleteEntry() {
                const dateToDelete = editDateInput.value;
                // Directly call delete function without a separate confirmation modal
                deleteAttendanceEntry(dateToDelete);
            }

            function deleteAttendanceEntry(dateToDelete) {
                if (!currentLoggedInUser || !currentLoggedInUser.attendance[dateToDelete]) return;

                const existingEntry = currentLoggedInUser.attendance[dateToDelete];
                const wasPresent = existingEntry && existingEntry.status === 'Present';
                const wasGrace = wasPresent && existingEntry.grace === 'Yes';
                const monthKey = `${new Date(dateToDelete).getFullYear()}-${String(new Date(dateToDelete).getMonth() + 1).padStart(2, '0')}`;

                const updatedAttendance = { ...currentLoggedInUser.attendance };
                delete updatedAttendance[dateToDelete];
                currentLoggedInUser.attendance = updatedAttendance; 
                saveCurrentUserData(); 

                if (wasPresent && wasGrace) {
                    updateGraceCount(monthKey, -1);
                }

                closeCustomModal(editDeleteModal);
                displayAttendanceHistory(); 
                renderCalendar(currentMonthView); // Update calendar after entry change
                updateDashboardCards(currentMonthView); // Update new dashboard cards
            }

            // --- History Page Functions ---
            function displayCustomHistorySummary() {
                const startDateStr = historyDateFromInput.value;
                const endDateStr = historyDateToInput.value;

                if (!startDateStr || !endDateStr) {
                    showCustomAlert('Input Error', "Please select both 'From Date' and 'To Date'.", 'warning');
                    if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';
                    return;
                }

                const startDate = new Date(startDateStr + 'T00:00:00');
                const endDate = new Date(endDateStr + 'T00:00:00');

                if (startDate > endDate) {
                    showCustomAlert('Input Error', "'From Date' cannot be after 'To Date'.", 'error');
                    if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';
                    return;
                }

                const currentUserAttendance = currentLoggedInUser.attendance || {};

                let totalHours = 0;
                let totalLateMinutes = 0;
                let totalAbsentDays = 0;
                let totalWeekendDays = 0;
                let totalHolidayDays = 0;
                let totalGovernmentHolidayDays = 0; 
                let totalSickLeaveDays = 0; 
                let totalWorkingDays = 0; 
                let totalDayShifts = 0;
                let totalNightShifts = 0;
                let totalGraceDays = 0;
                let totalPresentCount = 0; 

                if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';

                let currentDate = new Date(startDate);
                while (currentDate.getTime() <= endDate.getTime()) { 
                    const dateKey = formatDate(currentDate);
                    const dayOfWeek = getDayOfWeek(currentDate);
                    const entry = currentUserAttendance[dateKey];

                    const row = historyAttendanceTableBody.insertRow();
                    row.classList.add(`status-${(entry?.status || 'unmarked').toLowerCase()}-row`); 

                    const cellDate = row.insertCell();
                    const cellDay = row.insertCell();
                    const cellStatus = row.insertCell();
                    const cellHour = row.insertCell();
                    const cellExtraHour = row.insertCell();
                    const cellLate = row.insertCell();
                    const cellShift = row.insertCell();
                    const cellGrace = row.insertCell();
                    const cellApproval = row.insertCell(); 

                    cellDate.textContent = formatDisplayDate(currentDate);
                    cellDay.textContent = dayOfWeek;
                    cellStatus.className = '';

                    if (entry && entry.status) {
                        cellStatus.textContent = entry.status.replace(/_/g, ' '); 
                        cellStatus.classList.add(`status-${entry.status.toLowerCase()}`);

                        if (entry.status === 'Present' || entry.status === 'Government_Holiday' || entry.status === 'Sick_Leave') {
                            cellHour.textContent = entry.hour || '-';
                            cellExtraHour.textContent = entry.extraHour || '-';
                            cellLate.textContent = entry.late || '00:00';
                            cellShift.textContent = entry.shift || '-';
                            cellGrace.textContent = entry.grace || '-';
                            cellApproval.textContent = entry.approval || '-';

                            totalHours += (entry.hour || 0) + (entry.extraHour || 0);
                            const [lateHours, lateMinutes] = (entry.late || '00:00').split(':').map(Number);
                            totalLateMinutes += (lateHours * 60) + lateMinutes;

                            if (entry.shift === 'Day') totalDayShifts++;
                            else if (entry.shift === 'Night') totalNightShifts++;
                            totalWorkingDays++; 
                            if (entry.grace === 'Yes') totalGraceDays++;

                            if (entry.status === 'Government_Holiday') totalGovernmentHolidayDays++;
                            else if (entry.status === 'Sick_Leave') totalSickLeaveDays++;
                            else if (entry.status === 'Present') totalPresentCount++;

                        } else if (entry.status === 'Absent') {
                             cellHour.textContent = '-';
                            cellExtraHour.textContent = '-';
                            cellLate.textContent = '-';
                            cellShift.textContent = '-';
                            cellGrace.textContent = '-';
                            cellApproval.textContent = entry.approval || '-';
                            totalAbsentDays++;
                            totalWorkingDays++; 
                        }
                        else {
                            cellHour.textContent = '-';
                            cellExtraHour.textContent = '-';
                            cellLate.textContent = '-';
                            cellShift.textContent = '-';
                            cellGrace.textContent = '-';
                            cellApproval.textContent = '-';
                            if (entry.status === 'Weekend') {
                                totalWeekendDays++;
                            } else if (entry.status === 'Holiday') {
                                totalHolidayDays++;
                            }
                        }
                    } else {
                        cellStatus.textContent = '-';
                        cellHour.textContent = '-';
                        cellExtraHour.textContent = '-';
                        cellLate.textContent = '-';
                        cellShift.textContent = '-';
                        cellGrace.textContent = '-';
                        cellApproval.textContent = '-';
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                if (historySummaryTotalHours) historySummaryTotalHours.textContent = totalHours;
                const formattedLateTime = `${String(Math.floor(totalLateMinutes / 60)).padStart(2, '0')}:${String(totalLateMinutes % 60).padStart(2, '0')}`;
                if (historySummaryLate) historySummaryLate.textContent = formattedLateTime;
                if (historySummaryAbsent) historySummaryAbsent.textContent = totalAbsentDays;
                if (historySummaryWeekend) historySummaryWeekend.textContent = totalWeekendDays;
                if (historySummaryHoliday) historySummaryHoliday.textContent = totalHolidayDays + totalGovernmentHolidayDays + totalSickLeaveDays;
                if (historySummaryWorkingDays) historySummaryWorkingDays.textContent = totalWorkingDays;
                if (historySummaryDayShifts) historySummaryDayShifts.textContent = totalDayShifts;
                if (historySummaryNightShifts) historySummaryNightShifts.textContent = totalNightShifts;
                if (historySummaryGrace) historySummaryGrace.textContent = totalGraceDays;
                if (historySummaryTotalPresent) historySummaryTotalPresent.textContent = totalPresentCount + totalGovernmentHolidayDays + totalSickLeaveDays;

                // Update right sidebar history summary
                if (rhsTotalHours) rhsTotalHours.textContent = totalHours;
                if (rhsLate) rhsLate.textContent = formattedLateTime;
                if (rhsAbsent) rhsAbsent.textContent = totalAbsentDays;
                if (rhsWeekend) rhsWeekend.textContent = totalWeekendDays;
                if (rhsHoliday) rhsHoliday.textContent = totalHolidayDays + totalGovernmentHolidayDays + totalSickLeaveDays;
                if (rhsWorkingDays) rhsWorkingDays.textContent = totalWorkingDays;
                if (rhsTotalPresent) rhsTotalPresent.textContent = totalPresentCount + totalGovernmentHolidayDays + totalSickLeaveDays;
                if (rhsNightShifts) rhsNightShifts.textContent = totalNightShifts;
                if (rhsDayShifts) rhsDayShifts.textContent = totalDayShifts;
                if (rhsGrace) rhsGrace.textContent = totalGraceDays;
            }

            // --- Notification Modal Functions ---
            function closeNotificationModalFunc() {
                closeCustomModal(notificationModal);
            }


            // --- Help Modal Functions ---
            function openHelpModal() {
                if (helpModal) {
                    helpModal.style.display = 'flex';
                }
            }

            function closeHelpModalFunc() {
                closeCustomModal(helpModal);
            }

            // --- New Dashboard Card Functions ---

            function updateDashboardCards(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let totalSundays = 0;
                for (let i = 1; i <= daysInMonth; i++) {
                    const d = new Date(year, month, i);
                    if (d.getDay() === 0) { // Sunday
                        totalSundays++;
                    }
                }
                const calculatedWorkingDays = daysInMonth - totalSundays;

                if (totalWorkingDaysDisplay) totalWorkingDaysDisplay.textContent = `${calculatedWorkingDays} Days`;

                // COLA Eligibility
                let requiredPresentDays;
                if (calculatedWorkingDays >= 26) { // 27-26 days
                    requiredPresentDays = 22;
                } else if (calculatedWorkingDays >= 24) { // 25-24 days
                    requiredPresentDays = 21;
                } else { // Below 24 days
                    requiredPresentDays = 20;
                }

                const { start, end } = getMonthRange(date);
                let presentDaysCount = 0;
                const currentUserAttendance = currentLoggedInUser.attendance || {};
                let currentDate = new Date(start);
                while (currentDate.getTime() <= end.getTime()) {
                    const dateKey = formatDate(currentDate);
                    const entry = currentUserAttendance[dateKey];
                    if (entry && (entry.status === 'Present' || entry.status === 'Government_Holiday' || entry.status === 'Sick_Leave')) {
                        presentDaysCount++;
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                if (colaEligibilityDisplay) colaEligibilityDisplay.textContent = `Need present ${requiredPresentDays} days`;
                
                const progressPercentage = (presentDaysCount / requiredPresentDays) * 100;
                if (colaProgressBar) colaProgressBar.style.width = `${Math.min(progressPercentage, 100)}%`;
                if (colaEligibilityStatus) {
                    if (presentDaysCount >= requiredPresentDays) {
                        colaEligibilityStatus.innerHTML = '<i class="fas fa-check-circle"></i> COLA Eligibility Met!';
                        colaEligibilityStatus.style.color = 'var(--status-present)';
                    } else {
                        colaEligibilityStatus.innerHTML = `Present: ${presentDaysCount} / ${requiredPresentDays} Days`;
                        colaEligibilityStatus.style.color = 'var(--text-secondary)';
                    }
                }

                // Category Employee Treated As
                const totalWorkingHours = parseFloat(summaryTotalHours.textContent) || 0;
                const totalPossibleHours = calculatedWorkingDays * 9; // Assuming 9 hours per working day
                let workingHoursPercentage = 0;
                if (totalPossibleHours > 0) {
                    workingHoursPercentage = (totalWorkingHours / totalPossibleHours) * 100;
                }

                let category = 'E';
                let treatedAs = 'Failure';
                if (workingHoursPercentage >= 90) {
                    category = 'A';
                    treatedAs = 'Excellent';
                } else if (workingHoursPercentage >= 85) {
                    category = 'B';
                    treatedAs = 'Very Good';
                } else if (workingHoursPercentage >= 80) {
                    category = 'C';
                    treatedAs = 'Good';
                } else if (workingHoursPercentage >= 75) {
                    category = 'D';
                    treatedAs = 'Need Improvement';
                }

                if (employeeCategoryDisplay) employeeCategoryDisplay.textContent = `Category: ${category}, ${treatedAs}`;
            }

            function showTotalWorkingDaysDetails() {
                const year = currentMonthView.getFullYear();
                const month = currentMonthView.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let totalSundays = 0;
                for (let i = 1; i <= daysInMonth; i++) {
                    const d = new Date(year, month, i);
                    if (d.getDay() === 0) { // Sunday
                        totalSundays++;
                    }
                }
                const calculatedWorkingDays = daysInMonth - totalSundays;

                if (twdMonthDisplay) twdMonthDisplay.textContent = currentMonthView.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                if (twdTotalDays) twdTotalDays.textContent = daysInMonth;
                if (twdTotalSundays) twdTotalSundays.textContent = totalSundays;
                if (twdCalculatedWorkingDays) twdCalculatedWorkingDays.textContent = calculatedWorkingDays;

                if (totalWorkingDaysModal) totalWorkingDaysModal.style.display = 'flex';
            }

            function showColaEligibilityDetails() {
                const year = currentMonthView.getFullYear();
                const month = currentMonthView.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let totalSundays = 0;
                for (let i = 1; i <= daysInMonth; i++) {
                    const d = new Date(year, month, i);
                    if (d.getDay() === 0) { // Sunday
                        totalSundays++;
                    }
                }
                const calculatedWorkingDays = daysInMonth - totalSundays;

                let requiredPresentDays;
                if (calculatedWorkingDays >= 26) { // 27-26 days
                    requiredPresentDays = 22;
                } else if (calculatedWorkingDays >= 24) { // 25-24 days
                    requiredPresentDays = 21;
                } else { // Below 24 days
                    requiredPresentDays = 20;
                }

                const { start, end } = getMonthRange(currentMonthView);
                let presentDaysCount = 0;
                const currentUserAttendance = currentLoggedInUser.attendance || {};
                let currentDate = new Date(start);
                while (currentDate.getTime() <= end.getTime()) {
                    const dateKey = formatDate(currentDate);
                    const entry = currentUserAttendance[dateKey];
                    if (entry && (entry.status === 'Present' || entry.status === 'Government_Holiday' || entry.status === 'Sick_Leave')) {
                        presentDaysCount++;
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                if (colaMonthDisplay) colaMonthDisplay.textContent = currentMonthView.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                if (colaTotalWorkingDays) colaTotalWorkingDays.textContent = calculatedWorkingDays;
                if (colaRequiredPresentDays) colaRequiredPresentDays.textContent = requiredPresentDays;
                if (colaYourPresentDays) colaYourPresentDays.textContent = presentDaysCount;

                const progressPercentage = (presentDaysCount / requiredPresentDays) * 100;
                if (colaModalProgressBar) colaModalProgressBar.style.width = `${Math.min(progressPercentage, 100)}%`;
                if (colaModalEligibilityStatus) {
                    if (presentDaysCount >= requiredPresentDays) {
                        colaModalEligibilityStatus.innerHTML = '<i class="fas fa-check-circle"></i> COLA Eligibility Met!';
                        colaModalEligibilityStatus.style.color = 'var(--status-present)';
                    } else {
                        colaModalEligibilityStatus.innerHTML = `Present: ${presentDaysCount} / ${requiredPresentDays} Days`;
                        colaModalEligibilityStatus.style.color = 'var(--text-secondary)';
                    }
                }

                if (colaEligibilityModal) colaEligibilityModal.style.display = 'flex';
            }

            function showCategoryDetails() {
                if (categoryDetailsModal) categoryDetailsModal.style.display = 'flex';
            }

            // Initial call
            initializeApp();
        });
    </script>
</body>
</html>

