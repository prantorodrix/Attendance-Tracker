<!DOCTYPE html>
<html lang="en" data-theme="neptune-vibe">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow - Effortless Attendance</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Basic Reset & Global Styles */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@400;600;700&display=swap');

        :root {
            /* Default Light Theme Colors (Fallback) */
            --bg-primary-light: linear-gradient(135deg, #F0F4F8 0%, #E6EEF5 100%);
            --bg-secondary-light: #FFFFFF;
            --text-primary-light: #2C3E50;
            --text-secondary-light: #607D8B;
            --accent-color-light: #007BFF;
            --border-color-light: #DDE6ED;
            --shadow-color-light: rgba(0, 0, 0, 0.08);
            --input-bg-light: #F8FAFC;
            
            --nav-bg-light: #FFFFFF;
            --nav-text-light: var(--text-primary-light);
            --footer-bg-light: #2C3E50;
            --footer-text-light: #ffffff;

            --table-header-bg-light: var(--accent-color-light);
            --table-header-text-light: #FFFFFF;
            --table-row-even-light: #F0F4F8;
            --table-row-hover-light: #E6EEF5;

            /* Status Colors (Light) */
            --status-present-light: #28a745;
            --status-absent-light: #dc3545;
            --status-weekend-light: #6c757d;
            --status-holiday-light: #ffc107;
            --status-govt-holiday-light: #17a2b8;
            --status-sick-leave-light: #fd7e14;

            --status-present-bg-light: rgba(40, 167, 69, 0.05);
            --status-absent-bg-light: rgba(220, 53, 69, 0.05);
            --status-weekend-bg-light: rgba(108, 117, 125, 0.05);
            --status-holiday-bg-light: rgba(255, 193, 7, 0.05);
            --status-govt-holiday-bg-light: rgba(23, 162, 184, 0.05);
            --status-sick-leave-bg-light: rgba(253, 126, 20, 0.05);

            /* Chart Colors (Light) */
            --chart-color-present-light: #007AFF;
            --chart-color-absent-light: #dc3545;
            --chart-color-late-light: #ffc107;
        }

        /* Dark Theme Overrides */
        html[data-theme='dark'] {
            --bg-primary-dark: linear-gradient(135deg, #1A2A3A 0%, #0A1620 100%);
            --bg-secondary-dark: #2A3B4D;
            --text-primary-dark: #E0E6EB;
            --text-secondary-dark: #AAB8C2;
            --accent-color-dark: #00C896;
            --border-color-dark: #4A5C6F;
            --shadow-color-dark: rgba(0, 0, 0, 0.4);
            --input-bg-dark: #3A4C5E;
            
            --nav-bg-dark: #0A1620;
            --nav-text-dark: #E0E6EB;
            --footer-bg-dark: #0A1620;
            --footer-text-dark: #E0E6EB;

            --table-header-bg-dark: var(--accent-color-dark);
            --table-header-text-dark: #FFFFFF;
            --table-row-even-dark: #203040;
            --table-row-hover-dark: #30455A;

            /* Status Colors (Dark) */
            --status-present-dark: #64FFDA;
            --status-absent-dark: #FF6B6B;
            --status-weekend-dark: #AAB8C2;
            --status-holiday-dark: #A9DC76; /* Brighter green for holiday */
            --status-govt-holiday-dark: #FFD700;
            --status-sick-leave-dark: #FFA500;

            --status-present-bg-dark: rgba(100, 255, 218, 0.1);
            --status-absent-bg-dark: rgba(255, 107, 107, 0.1);
            --status-weekend-bg-dark: rgba(170, 184, 194, 0.1);
            --status-holiday-bg-dark: rgba(169, 220, 118, 0.1);
            --status-govt-holiday-bg-dark: rgba(255, 215, 0, 0.1);
            --status-sick-leave-bg-dark: rgba(255, 165, 0, 0.1);

            /* Chart Colors (Dark) */
            --chart-color-present-dark: #00C896;
            --chart-color-absent-dark: #FF6B6B;
            --chart-color-late-dark: #FFD700;
        }
        
        /* NeptuneVibe Theme (New & Default - Glassmorphism) */
        html[data-theme='neptune-vibe'] {
            --bg-primary: linear-gradient(135deg, #0a192f, #172a45, #0a192f); /* Deep ocean blue with loop for animation */
            --bg-secondary: rgba(15, 32, 56, 0.7); /* Slightly lighter deep blue for cards, now semi-transparent */
            --text-primary: #CCD6F6; /* Lighter blue-gray for main text */
            --text-secondary: #8892B0; /* Light grayish blue for secondary text */
            --accent-color: #64FFDA; /* Bright aqua for main accent */
            --secondary-accent: #4A90E2; /* Deeper blue for secondary accent */
            --button-gradient-start: #64FFDA; /* Aqua start for button gradient */
            --button-gradient-end: #4A90E2; /* Blue end for button gradient */
            --border-color: rgba(42, 59, 77, 0.5); /* Medium desaturated blue, semi-transparent */
            --shadow-color: rgba(2, 12, 27, 0.7); /* Darker, more intense shadow */
            --input-bg: rgba(17, 34, 64, 0.6); /* Dark blue for inputs, semi-transparent */
            
            --nav-bg: rgba(10, 25, 47, 0.8); /* Semi-transparent nav */
            --nav-text: var(--text-primary);
            --footer-bg: rgba(10, 25, 47, 0.8); /* Semi-transparent footer */
            --footer-text: var(--text-secondary);

            --table-header-bg: linear-gradient(90deg, rgba(17, 34, 64, 0.7), rgba(42, 59, 77, 0.7)); /* Semi-transparent gradient for table header */
            --table-header-text: var(--text-primary); /* Ensure good contrast */
            --table-row-even: rgba(17, 34, 64, 0.5); /* Semi-transparent even row */
            --table-row-hover: rgba(23, 42, 69, 0.7); /* Semi-transparent hover row */

            /* Status Colors (NeptuneVibe) */
            --status-present: #64FFDA; 
            --status-absent: #E74C3C; 
            --status-weekend: #8892B0; 
            --status-holiday: #A9DC76; /* Bright green for holiday */
            --status-govt-holiday: #7FFF00; 
            --status-sick-leave: #FFA500; 

            --status-present-bg: rgba(100, 255, 218, 0.1); 
            --status-absent-bg: rgba(231, 76, 60, 0.1); 
            --status-weekend-bg: rgba(136, 146, 176, 0.1); 
            --status-holiday-bg: rgba(169, 220, 118, 0.1); 
            --status-govt-holiday-bg: rgba(127, 255, 0, 0.1); 
            --status-sick-leave-bg: rgba(255, 165, 0, 0.1); 

            /* Chart Colors (NeptuneVibe) */
            --chart-color-present: #64FFDA; /* Aqua */
            --chart-color-absent: #E74C3C; /* Red */
            --chart-color-late: #FFD700; /* Gold */
        }

        /* Alert/Warning Colors (remain consistent but adapt to theme text) */
        --alert-info: #2196F3;
        --alert-success: #4CAF50;
        --alert-warning: #FFC107;
        --alert-error: #F44336;

        --transition-speed: 0.3s ease-in-out;
        --border-radius-base: 8px; /* Slightly less rounded for tight fit */
        --border-radius-large: 12px; /* Less rounded for main cards */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            background: var(--bg-primary); 
            background-size: 200% 200%; /* For animated background */
            transition: background var(--transition-speed), color var(--transition-speed);
        }

        body.main-page-body {
            padding-top: 60px; /* Adjusted space for fixed navbar */
            background: var(--bg-primary); /* Ensure this is set for main page */
            background-size: 200% 200%;
            background-position: 0% 50%; /* Initial position */
            transition: background var(--transition-speed), color var(--transition-speed);
        }

        @keyframes gradientScroll {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        /* Dynamic scroll animation */
        body.main-page-body.animate-scroll {
            animation: none; /* Disable static animation if dynamic is active */
        }
        
        h1, h2, h3, h4 {
            font-family: 'Poppins', sans-serif;
            color: var(--text-primary);
            font-weight: 600; 
            transition: color var(--transition-speed);
            text-shadow: 0px 0px 6px rgba(100, 255, 218, 0.15); /* Subtle accent glow for headers */
        }

        /* Premium Button Style */
        .premium-button {
            background: linear-gradient(135deg, var(--button-gradient-start) 0%, var(--button-gradient-end) 100%);
            color: var(--nav-text); 
            padding: 10px 20px; /* Tighter padding */
            border: none;
            border-radius: 5px;
            font-size: 0.9rem; 
            font-weight: 600; 
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); 
            letter-spacing: 0.5px; 
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px; /* Tighter gap */
            outline: none;
            position: relative;
            overflow: hidden;
            z-index: 1;
            border: 1px solid rgba(100, 255, 218, 0.3); /* Subtle glass border */
        }

        .premium-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1); 
            transform: skewX(-30deg);
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: -1;
        }

        .premium-button:hover::before {
            left: 100%;
        }

        .premium-button:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px) scale(1.005); /* Less pronounced lift and scale */
        }

        .premium-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        /* Secondary Button Style */
        .premium-button.secondary {
            background: var(--input-bg); 
            color: var(--text-primary);
            box-shadow: 0 2px 8px var(--shadow-color);
            border: 1px solid var(--border-color); /* Subtle glass border */
        }

        .premium-button.secondary:hover {
            background-color: var(--border-color); 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Delete Button Style */
        .premium-button.delete-button {
            background: linear-gradient(135deg, var(--alert-error) 0%, #B71C1C 100%); 
            box-shadow: 0 3px 10px rgba(244, 67, 54, 0.3);
            border: 1px solid rgba(244, 67, 54, 0.3); /* Subtle glass border */
        }

        .premium-button.delete-button:hover {
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
            background: linear-gradient(135deg, #B71C1C 0%, var(--alert-error) 100%);
        }

        /* --- Login Page Specific Styles --- */
        .login-page-body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--bg-primary); /* Use primary bg for overall login page */
            background-size: 200% 200%;
            animation: gradientAnimation 15s ease infinite; /* Faster, more subtle animation */
            color: var(--text-primary);
            transition: background var(--transition-speed);
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .auth-container {
            background-color: var(--bg-secondary);
            backdrop-filter: blur(10px); /* Glassmorphism blur */
            padding: 30px; /* Reduced padding */
            border-radius: 10px; 
            box-shadow: 0 15px 40px var(--shadow-color); 
            text-align: center;
            width: 90%;
            max-width: 400px; /* Slightly narrower */
            animation: fadeInScale 0.7s cubic-bezier(0.2, 0.8, 0.2, 1);
            color: var(--text-primary);
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed), border-color var(--transition-speed);
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .auth-container h1.premium-heading {
            font-size: 2rem; 
            margin-bottom: 10px;
            color: var(--text-primary);
            text-shadow: 0px 0px 8px rgba(100, 255, 218, 0.25); 
        }

        .auth-container .sub-heading {
            font-size: 1rem;
            margin-bottom: 25px; /* Reduced margin */
            color: var(--text-secondary);
            font-weight: 400;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Reduced gap */
            animation: slideIn 0.5s ease-out forwards;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-group {
            text-align: left;
            position: relative;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px; /* Reduced margin */
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9rem;
            letter-spacing: 0.2px;
        }

        .input-group input[type="email"],
        .input-group input[type="password"],
        .input-group input[type="text"],
        .input-group input[type="date"],
        .input-group select {
            width: 100%;
            padding: 10px 14px; /* Reduced padding */
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem; 
            transition: all var(--transition-speed);
            background-color: var(--input-bg); /* Semi-transparent input background */
            color: var(--text-primary);
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.08); /* Lighter inset shadow */
            outline: none;
        }

        .input-group input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .input-group input[type="email"]:focus,
        .input-group input[type="password"]:focus,
        .input-group input[type="text"]:focus,
        .input-group input[type="date"]:focus,
        .input-group select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(100, 255, 218, 0.25); /* Tighter focus ring */
        }

        /* Styles for input error states */
        .input-group input.error {
            border-color: var(--alert-error);
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.25);
        }

        .input-group .error-message {
            color: var(--alert-error);
            font-size: 0.8rem;
            margin-top: 5px; /* Reduced margin */
            display: none;
        }

        .input-group input.error + .error-message {
            display: block;
        }

        .login-links {
            display: flex;
            justify-content: center; 
            margin-top: 15px; /* Reduced margin */
            font-size: 0.9rem;
            gap: 10px; 
        }

        .login-links a {
            color: var(--secondary-accent); 
            text-decoration: none;
            transition: color var(--transition-speed), text-decoration var(--transition-speed);
            font-weight: 500;
        }

        .login-links a:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }

        /* --- Main Page General Styles --- */
        .container {
            max-width: 1100px; /* Slightly narrower for focus */
            margin: 20px auto; /* Reduced margin */
            padding: 0 15px; /* Reduced padding */
        }

        .section-card {
            background-color: var(--bg-secondary);
            backdrop-filter: blur(8px); /* Glassmorphism blur */
            padding: 25px; /* Reduced padding */
            margin-bottom: 20px; /* Reduced margin */
            border-radius: 10px;
            box-shadow: 0 10px 30px var(--shadow-color); 
            animation: slideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            border: 1px solid var(--border-color);
            transition: transform 0.25s ease, box-shadow 0.25s ease, background-color var(--transition-speed), border-color var(--transition-speed);
        }

        .section-card:hover {
            transform: translateY(-5px); /* Less pronounced lift */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-size: 1.8rem; /* Slightly smaller */
            color: var(--text-primary);
            margin-bottom: 20px; /* Reduced margin */
            text-align: center;
            border-bottom: 1px solid var(--border-color); /* Thinner border */
            padding-bottom: 15px; /* Reduced padding */
        }

        /* --- Navigation Bar --- */
        #main-navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 25px; /* Reduced padding */
            background-color: var(--nav-bg); /* Semi-transparent nav background */
            backdrop-filter: blur(8px); /* Glassmorphism blur */
            color: var(--nav-text);
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            transition: background-color 0.3s ease, padding 0.3s ease, box-shadow 0.3s ease, color var(--transition-speed);
            border-bottom: 1px solid var(--border-color);
        }

        #main-navbar.scrolled {
            padding: 8px 25px; /* Even smaller padding on scroll */
            background-color: rgba(10, 25, 47, 0.7); /* More transparent on scroll */
            backdrop-filter: blur(12px); /* More blur on scroll */
            box-shadow: 0 1px 10px rgba(0, 0, 0, 0.2);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 8px; /* Reduced gap */
        }

        .logo-text {
            font-family: 'Poppins', sans-serif;
            font-size: 1.4rem; /* Smaller logo text */
            font-weight: 700;
            color: var(--nav-text);
            letter-spacing: 1px;
        }

        .logo-icon {
            width: 24px; /* Smaller icon */
            height: 24px;
            fill: var(--accent-color);
            transition: fill var(--transition-speed), transform 0.25s ease;
        }
        .logo-icon:hover {
            transform: rotate(10deg) scale(1.08); /* Less pronounced hover */
        }

        .nav-links {
            display: flex;
            gap: 25px; /* Reduced gap */
            list-style: none;
            margin-right: auto;
            margin-left: 25px; /* Reduced margin */
        }

        .nav-links a {
            color: var(--nav-text);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem; /* Slightly smaller nav links */
            position: relative;
            padding-bottom: 5px; /* Reduced padding */
            transition: color var(--transition-speed);
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 3px; /* Thinner underline */
            background-color: var(--accent-color);
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), background-color var(--transition-speed);
        }

        .nav-links a:hover::after, .nav-links a.active-nav-link::after {
            width: 100%;
        }

        .nav-links a:hover, .nav-links a.active-nav-link {
            color: var(--accent-color);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px; /* Reduced gap */
        }

        .nav-buttons .premium-button {
            padding: 8px 15px; /* Reduced padding */
            font-size: 0.85rem;
            text-transform: none;
            box-shadow: none; 
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color); /* Subtle glass border */
        }
        .nav-buttons .premium-button:hover {
            background-color: var(--border-color);
            color: var(--accent-color);
            box-shadow: none;
            transform: translateY(-1px);
        }

        .user-profile-menu {
            position: relative;
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: var(--nav-text);
            padding: 6px 10px; /* Reduced padding */
            border-radius: var(--border-radius-base);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .user-profile-menu:hover {
            background-color: var(--input-bg);
            color: var(--accent-color);
        }

        .user-photo {
            width: 35px; /* Smaller photo */
            height: 35px;
            border-radius: 50%;
            margin-left: 10px; /* Reduced margin */
            border: 2px solid var(--accent-color); /* Thinner border */
            object-fit: cover;
            transition: transform var(--transition-speed), border-color var(--transition-speed);
        }

        .user-photo:hover {
            transform: scale(1.05); /* Less pronounced scale */
            border-color: var(--secondary-accent);
        }

        .user-profile-menu i {
            margin-left: 6px; /* Reduced margin */
            transition: transform var(--transition-speed);
        }

        .user-profile-menu.active i {
            transform: rotate(180deg);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--bg-secondary);
            backdrop-filter: blur(8px); /* Glassmorphism blur */
            min-width: 160px; /* Slightly narrower */
            box-shadow: 0 8px 20px var(--shadow-color);
            z-index: 1;
            top: 100%;
            right: 0;
            border-radius: var(--border-radius-base);
            overflow: hidden;
            transform-origin: top right;
            animation: scaleIn 0.2s ease-out forwards; /* Faster animation */
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        .user-profile-menu:hover .dropdown-content,
        .user-profile-menu.active .dropdown-content {
            display: block;
        }

        .dropdown-content a {
            color: var(--text-primary);
            padding: 10px 15px; /* Reduced padding */
            text-decoration: none;
            display: block;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            font-weight: 400;
            font-size: 0.9rem;
        }

        .dropdown-content a:hover {
            background-color: var(--input-bg);
            color: var(--secondary-accent);
        }

        /* Theme Toggle Button */
        #themeToggle {
            background: none;
            border: none;
            color: var(--nav-text);
            font-size: 1.4rem; /* Smaller icon */
            cursor: pointer;
            margin-left: 15px; /* Reduced margin */
            transition: color 0.3s ease, transform 0.3s ease;
        }

        #themeToggle:hover {
            color: var(--accent-color);
            transform: rotate(10deg) scale(1.1);
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7); /* Slightly less opaque */
            justify-content: center;
            align-items: center;
            animation: fadeInOverlay 0.25s ease-out; /* Faster fade */
        }

        @keyframes fadeInOverlay {
            from { background-color: rgba(0,0,0,0); }
            to { background-color: rgba(0,0,0,0.7); }
        }

        .modal-content {
            background-color: var(--bg-secondary);
            backdrop-filter: blur(10px); /* Glassmorphism blur */
            margin: auto;
            padding: 20px; /* Reduced padding */
            border-radius: 10px;
            box-shadow: 0 15px 40px var(--shadow-color);
            width: 90%;
            max-width: 500px; /* Slightly narrower */
            position: relative;
            animation: slideDownFadeIn 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Faster animation */
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        @keyframes slideDownFadeIn {
            from { opacity: 0; transform: translateY(-80px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 20px; /* Reduced margin */
            font-size: 1.8rem;
            color: var(--text-primary);
            text-align: center;
            border-bottom: none; 
            padding-bottom: 0;
        }

        .modal-content .close-button {
            color: var(--text-secondary);
            font-size: 28px; /* Smaller close button */
            font-weight: 600;
            position: absolute;
            top: 15px; /* Adjusted position */
            right: 20px; /* Adjusted position */
            cursor: pointer;
            transition: all 0.25s ease; /* Faster transition */
        }

        .modal-content .close-button:hover,
        .modal-content .close-button:focus {
            color: var(--accent-color);
            transform: rotate(90deg) scale(1.1);
        }

        .user-photo-preview {
            width: 100px; /* Smaller preview */
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--secondary-accent); /* Thinner border */
            margin-top: 15px; /* Reduced margin */
            display: block;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: border-color var(--transition-speed);
        }

        /* --- User Dashboard Section --- */
        .user-dashboard-section {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 25px; /* Reduced gap */
            padding: 30px; /* Reduced padding */
            background-color: var(--bg-secondary);
            backdrop-filter: blur(8px); /* Glassmorphism blur */
            border-radius: 10px;
            box-shadow: 0 10px 30px var(--shadow-color);
            margin-bottom: 20px; /* Reduced margin */
            animation: slideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        .user-dashboard-photo {
            width: 150px; /* Smaller photo */
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--accent-color); /* Thinner border */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            transition: border-color var(--transition-speed), transform 0.25s ease;
        }
        .user-dashboard-photo:hover {
            transform: scale(1.02);
            border-color: var(--secondary-accent);
        }

        .user-dashboard-info {
            text-align: left;
            flex-grow: 1;
            min-width: 300px; /* Adjusted min-width */
        }

        .user-dashboard-info h3 {
            font-size: 2.2rem; /* Smaller heading */
            margin-bottom: 8px; /* Reduced margin */
            color: var(--text-primary);
        }

        .user-dashboard-info p {
            font-size: 1.05rem; /* Slightly smaller text */
            margin-bottom: 6px; /* Reduced margin */
            color: var(--text-secondary);
        }

        .user-dashboard-info strong {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* --- Month Selector & History Summary --- */
        .month-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px; /* Reduced gap */
            margin-bottom: 20px; /* Reduced margin */
        }

        #monthSelectDropdown {
            padding: 10px 18px; /* Reduced padding */
            font-size: 1rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-speed);
            box-shadow: 0 2px 8px var(--shadow-color);
            font-weight: 500;
            outline: none;
        }

        #monthSelectDropdown:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(100, 255, 218, 0.25);
        }

        .date-range-display {
            text-align: center;
            margin-bottom: 20px; /* Reduced margin */
            color: var(--text-secondary);
            font-size: 1rem;
            transition: color var(--transition-speed);
        }

        .history-summary {
            background-color: var(--input-bg); /* Use input-bg for inner element, for more transparency */
            backdrop-filter: blur(6px); /* Glassmorphism blur */
            border-radius: var(--border-radius-base);
            padding: 20px; /* Reduced padding */
            box-shadow: inset 0 1px 6px rgba(0,0,0,0.1); 
            margin-top: 20px; /* Reduced margin */
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px; /* Reduced gap */
        }

        @media (min-width: 768px) {
            .history-summary {
                grid-template-columns: 1fr 300px; /* Smaller chart column */
            }
        }

        .history-summary h3 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 15px; /* Reduced margin */
            font-size: 1.4rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Adjusted minmax */
            gap: 12px; /* Reduced gap */
            text-align: center;
        }

        .summary-grid div {
            background-color: var(--bg-secondary); /* Use secondary bg for individual items */
            backdrop-filter: blur(8px); /* Glassmorphism blur */
            padding: 15px; /* Reduced padding */
            border-radius:10px;
            box-shadow: -1px -1px 2px var(--shadow-color); /* Subtle shadow for glass effect */
            font-weight: 500;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color var(--transition-speed);
            border: 1px solid var(--border-color);
        }

        .summary-grid div:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .summary-grid strong {
            color: var(--text-secondary);
            display: block;
            margin-bottom: 6px; /* Reduced margin */
            font-size: 0.85rem;
        }

        .summary-grid span {
            font-size: 1.2rem; /* Slightly smaller */
            color: var(--accent-color);
            font-weight: 700;
        }

        /* Chart container styling */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 300px; /* Smaller max-width */
            height: 300px; /* Smaller height */
            margin: 0 auto;
            padding: 15px; /* Reduced padding */
            background-color: var(--bg-secondary);
            backdrop-filter: blur(8px); /* Glassmorphism blur */
            border-radius: 17px;
            box-shadow: -2px -2px 6px var(--shadow-color);
            align-self: center;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--border-color);
        }

        /* --- Saved Entries Table --- */
        .table-responsive {
            overflow-x: auto;
        }

        #attendanceTable, #historyAttendanceTable {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px; /* Reduced margin */
            background-color: var(--bg-secondary); /* Semi-transparent background */
            backdrop-filter: blur(8px); /* Glassmorphism blur */
            box-shadow: 0 8px 25px var(--shadow-color);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        #attendanceTable thead, #historyAttendanceTable thead {
            background: var(--table-header-bg); /* Semi-transparent gradient */
            color: var(--table-header-text);
            transition: background var(--transition-speed), color var(--transition-speed);
        }

        #attendanceTable th,
        #attendanceTable td,
        #historyAttendanceTable th,
        #historyAttendanceTable td {
            padding: 12px 15px; /* Reduced padding */
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: color var(--transition-speed), border-color var(--transition-speed);
            font-size: 0.80rem; /* Slightly smaller text */
        }

        #attendanceTable th, #historyAttendanceTable th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        #attendanceTable tbody tr:nth-child(even), #historyAttendanceTable tbody tr:nth-child(even) {
            background-color: var(--table-row-even); /* Semi-transparent even row */
            transition: background-color var(--transition-speed);
        }

        #attendanceTable tbody tr:hover, #historyAttendanceTable tbody tr:hover {
            background-color: var(--table-row-hover); /* Semi-transparent hover row */
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }

        /* Status Background Colors for Table Rows (keeping this, but will primarily use text colors) */
        .status-present-row { background-color: var(--status-present-bg) !important; }
        .status-absent-row { background-color: var(--status-absent-bg) !important; }
        .status-weekend-row { background-color: var(--status-weekend-bg) !important; }
        .status-holiday-row { background-color: var(--status-holiday-bg) !important; }
        .status-government_holiday-row { background-color: var(--status-govt-holiday-bg) !important; }
        .status-sick_leave-row { background-color: var(--status-sick-leave-bg) !important; }

        .table-actions button {
            background: linear-gradient(90deg, var(--secondary-accent), var(--button-gradient-start)); 
            color: var(--nav-text);
            border: 1px solid rgba(100, 255, 218, 0.3); /* Subtle glass border */
            padding: 8px 12px; /* Reduced padding */
            border-radius: 6px; /* Smaller radius */
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 6px; /* Reduced margin */
            transition: all 0.25s ease;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.15);
        }

        .table-actions button:hover {
            background: linear-gradient(90deg, var(--button-gradient-start), var(--secondary-accent));
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .table-actions .delete-button { /* Only for explicit delete button if any */
            background: linear-gradient(90deg, var(--alert-error), #B71C1C);
            box-shadow: 0 1px 6px rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.3); /* Subtle glass border */
        }

        .table-actions .delete-button:hover {
            background: linear-gradient(90deg, #B71C1C, var(--alert-error));
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.25);
        }

        /* Specific Status Colors (Text Only) */
        .status-present { color: var(--status-present); font-weight: 600; transition: color var(--transition-speed); }
        .status-absent { color: var(--status-absent); font-weight: 600; transition: color var(--transition-speed); }
        .status-weekend { color: var(--status-weekend); font-weight: 600; transition: color var(--transition-speed); }
        .status-holiday { color: var(--status-holiday); font-weight: 600; transition: color var(--transition-speed); }
        .status-government_holiday { color: var(--status-govt-holiday); font-weight: 600; transition: color var(--transition-speed); }
        .status-sick_leave { color: var(--status-sick-leave); font-weight: 600; transition: color var(--transition-speed); }
        
        /* Edit/Delete Modal specific styles (now handles all entry types) */
        #editDeleteModal .modal-content .input-group {
            margin-bottom: 12px; /* Reduced margin */
        }
        #editDeleteModal .modal-content .input-group label {
            margin-bottom: 6px; /* Reduced margin */
        }
        #editDeleteModal .modal-content .input-group input,
        #editDeleteModal .modal-content .input-group select {
            padding: 10px 14px; /* Reduced padding */
            width:80%;
            border-radius: 10px;
            transition: all var(--transition-speed);
            background-color: var(--input-bg); /* Semi-transparent input background */
            color: var(--text-primary);
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.08);
            outline: none;
        }
        #editDeleteModal .modal-content .modal-buttons {
            gap: 10px; /* Reduced gap */
            margin-top: 20px; /* Reduced margin */
        }
        #editDeleteModal .modal-content .modal-buttons .premium-button {
            padding: 10px 20px; /* Reduced padding */
            font-size: 0.9rem;
        }

        /* Custom Alert/Confirm Modal Styles */
        #customAlertModal .modal-content,
        #customConfirmModal .modal-content {
            padding: 25px; /* Reduced padding */
            max-width: 400px; /* Narrower */
            border-left: 8px solid; /* Thinner border */
            animation: slideDownFadeIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Faster animation */
            transition: border-color var(--transition-speed);
            box-shadow: 0 10px 30px var(--shadow-color);
            background-color: var(--bg-secondary); /* Semi-transparent */
            backdrop-filter: blur(10px); /* Glassmorphism blur */
        }

        #customAlertModal h2,
        #customConfirmModal h2 {
            font-size: 1.6rem; /* Smaller heading */
            margin-bottom: 15px; /* Reduced margin */
        }

        #customAlertModal p,
        #customConfirmModal p {
            font-size: 1rem;
            margin-bottom: 20px; /* Reduced margin */
        }

        #customAlertModal .modal-buttons,
        #customConfirmModal .modal-buttons {
            gap: 10px; /* Reduced gap */
        }

        #customAlertModal .modal-buttons .premium-button,
        #customConfirmModal .modal-buttons .premium-button {
            padding: 10px 20px; /* Reduced padding */
            font-size: 0.9rem;
        }

        /* Help Modal Specific Styles */
        .help-modal-content {
            padding: 50px; /* Reduced padding */
            animation: bounceIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Faster animation */
            background-color: var(--bg-secondary);
            backdrop-filter: blur(10px); /* Glassmorphism blur */
        }

        .help-modal-content h2 {
            font-size: 2.5rem; /* Smaller heading */
            margin-bottom: 20px; /* Reduced margin */
            text-shadow: 0 0 12px rgba(100, 255, 218, 0.4); 
        }

        .help-modal-content p {
            font-size: 1.2rem; /* Smaller text */
        }

        /* --- History Page Specific Styles --- */
        #historySection .date-range-inputs {
            gap: 20px; /* Reduced gap */
            margin-bottom: 25px; /* Reduced margin */
        }

        #historySection .date-range-inputs .input-group {
            min-width: 250px;
        }

        #historySection .date-range-inputs button {
            max-width: 180px;
            margin-top: 20px; /* Reduced margin */
        }

        #historySummaryResult {
            margin-top: 20px; /* Reduced margin */
            padding: 20px; /* Reduced padding */
            background-color: var(--input-bg); /* Use input-bg for more transparency */
            backdrop-filter: blur(6px); /* Glassmorphism blur */
        }

        #historyDetailedEntries {
            margin-top: 30px !important; /* Reduced margin */
        }

        /* --- Footer --- */
        footer {
            padding: 25px 15px; /* Reduced padding */
            font-size: 0.85rem;
            margin-top: 40px; /* Reduced margin */
            border-top: 3px solid var(--accent-color); /* Thinner border */
            gap: 20px; /* Reduced gap */
            box-shadow: 0 -3px 20px var(--shadow-color); /* Less strong shadow */
            display: flex;
            justify-content: center;
            background-color: var(--footer-bg); /* Semi-transparent footer */
            backdrop-filter: blur(8px); /* Glassmorphism blur */
        }

        footer .footer-section {
            min-width: 200px;
        }

        footer .footer-section h4 {
            font-size: 1.1rem;
            margin-bottom: 12px; /* Reduced margin */
        }

        footer .footer-section p {
            margin-bottom: 8px; /* Reduced margin */
            font-size: 0.9rem;
        }

        footer .footer-section p i {
            margin-right: 10px; /* Reduced margin */
            font-size: 1.1rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #main-navbar {
                padding: 10px 15px;
            }
            .nav-links {
                gap: 15px;
            }
            .auth-container {
                padding: 25px;
            }
            .auth-container h1.premium-heading {
                font-size: 1.8rem;
            }
            .premium-button {
                padding: 10px 20px;
                font-size: 0.85rem;
            }
            .user-dashboard-info {
                min-width: auto;
                text-align: center;
            }
            .history-summary {
                grid-template-columns: 1fr;
            }
            .chart-container {
                max-width: 100%;
                height: 250px;
            }
            #attendanceTable th,
            #attendanceTable td,
            #historyAttendanceTable th,
            #historyAttendanceTable td {
                padding: 10px 12px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login/Registration Section -->
    <div id="authSection" class="login-page-body">
        <div class="auth-container">
            <h1 class="premium-heading" id="authHeading"></h1> 
            <p class="sub-heading" id="authSubHeading"></p>

            <form id="loginForm" class="auth-form active">
                <div class="input-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                    <span class="error-message" id="loginEmailError"></span>
                </div>
                <div class="input-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    <span class="error-message" id="loginPasswordError"></span>
                </div>
                <div class="login-links">
                    <a href="#" id="registerHereLink">Create an Account</a>
                </div>
                <button type="submit" class="premium-button">Login</button>
            </form>

            <form id="registerForm" class="auth-form" style="display: none;">
                <div class="input-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email address" required>
                    <span class="error-message" id="registerEmailError"></span>
                </div>
                <div id="registrationDetails" style="display: block;">
                    <div class="input-group">
                        <label for="registerUsername">Username</label>
                        <input type="text" id="registerUsername" placeholder="Choose a username" required>
                    </div>
                    <div class="input-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" placeholder="Create a password" required>
                        <span class="error-message" id="registerPasswordError"></span>
                    </div>
                    <div class="input-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                        <span class="error-message" id="confirmPasswordError"></span>
                    </div>
                    <div class="input-group">
                        <label for="registerJoiningDate">Joining Date</label>
                        <input type="date" id="registerJoiningDate" required>
                    </div>
                    <div class="input-group">
                        <label for="registerLngId">LnG ID</label>
                        <input type="text" id="registerLngId" placeholder="Enter your LnG ID" required>
                    </div>
                </div>
                <button type="submit" class="premium-button" id="registerSubmitBtn">Register</button>
                <p style="color: var(--text-secondary); font-size: 0.95rem; margin-top: 15px;">Already have an account? <a href="#" id="loginHereLink" style="color: var(--secondary-accent); text-decoration: underline;">Login Here</a></p>
            </form>
        </div>
    </div>

    <!-- Main Activity Page Section (Initially hidden) -->
    <div id="mainActivitySection" style="display: none;">
        <!-- First Section: Navigation Bar -->
        <nav id="main-navbar">
            <div class="logo-container">
                <span class="logo-text">TaskFlow</span>
                <!-- Diamond Logo SVG (Updated to be more modern) -->
                <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 1L2 12H7L12 23L17 12H22L12 1Z" />
                </svg>
            </div>
            <ul class="nav-links">
                <li><a href="#" id="homeNavLink">Dashboard</a></li>
                <li><a href="#" id="historyNavLink">Reports</a></li>
                <li><a href="#" id="helpNavLink">Help</a></li>
            </ul>
            <div class="nav-right">
                <div class="nav-buttons">
                    <button class="premium-button secondary" id="navSignInBtn">Sign Out</button>
                </div>
                <button id="themeToggle" class="fas fa-palette"></button>
                <div class="user-profile-menu">
                    <img id="userPhotoDisplay" src="https://placehold.co/40x40/64FFDA/0A192F?text=U" alt="User Photo" class="user-photo">
                    <span id="usernameDisplay">Username</span>
                    <i class="fas fa-caret-down"></i>
                    <div class="dropdown-content">
                        <a href="#" id="personalProfileBtn">My Profile</a>
                        <a href="#" id="logoutBtn">Logout</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Personal Profile Modal -->
        <div id="profileModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h2>Edit Profile</h2>
                <div class="input-group">
                    <label for="profileNameInput">Profile Name</label>
                    <input type="text" id="profileNameInput" placeholder="Enter your display name">
                </div>
                <div class="input-group">
                    <label for="usernameInput">Username</label>
                    <input type="text" id="usernameInput" placeholder="Enter your username">
                </div>
                <div class="input-group">
                    <label for="emailInput">Email Address</label>
                    <input type="email" id="emailInput" readonly>
                </div>
                <div class="input-group">
                    <label for="profileJoiningDateInput">Joining Date</label>
                    <input type="date" id="profileJoiningDateInput">
                </div>
                <div class="input-group">
                    <label for="profileLngIdInput">LnG ID</label>
                    <input type="text" id="profileLngIdInput" placeholder="Your LnG ID">
                </div>
                <div class="input-group">
                    <label for="profilePictureInput">Profile Picture</label>
                    <input type="file" id="profilePictureInput" accept="image/*">
                    <img id="profilePicturePreview" src="https://placehold.co/120x120/64FFDA/0A192F?text=U" alt="Profile Picture Preview" class="user-photo-preview">
                </div>
                <button id="saveProfileBtn" class="premium-button">Save Changes</button>
            </div>
        </div>

        <main class="container">
            <!-- New 1st Section: User Dashboard -->
            <section id="dashboardSection" class="user-dashboard-section">
                <img id="dashboardUserPhoto" src="https://placehold.co/180x180/64FFDA/0A192F?text=U" alt="User Photo" class="user-dashboard-photo">
                <div class="user-dashboard-info">
                    <h3 id="dashboardUsername">Username</h3>
                    <p><strong>Worked For:</strong> <span id="workedForDisplay">0 years 0 months</span></p>
                    <p><strong>LnG ID:</b> <span id="lngIdDisplay">N/A</span></p>
                </div>
            </section>

            <!-- Second Section: Month Selection and History Result -->
            <section id="monthlySummarySection" class="section-card">
                <h2>Monthly Attendance Overview</h2>
                <div class="month-selector">
                    <select id="monthSelectDropdown"></select>
                </div>

                <div class="date-range-display">
                    <p><strong>From:</strong> <span id="dateFrom"></span> | <strong>To:</strong> <span id="dateTo"></span></p>
                </div>

                <div class="history-summary">
                    <div>
                        <h3>Summary Metrics</h3>
                        <div class="summary-grid">
                            <div><strong>Total Hours:</strong> <span id="summaryTotalHours">0</span></div>
                            <div><strong>Late:</strong> <span id="summaryLate">0</span></div>
                            <div><strong>Absent:</strong> <span id="summaryAbsent">0</span></div>
                            <div><strong>Weekends:</strong> <span id="summaryWeekend">0</span></div>
                            <div><strong>Holidays:</strong> <span id="summaryHoliday">0</span></div>
                            <div><strong>Working Days:</strong> <span id="summaryWorkingDays">0</span></div>
                            <div><strong>Total Present:</strong> <span id="summaryTotalPresent">0</span></div>
                            <div><strong>Night Shifts:</strong> <span id="summaryNightShifts">0</span></div>
                            <div><strong>Grace Used:</strong> <span id="summaryGrace">0</span></div>
                            <div><strong>Day Shifts:</b> <span id="summaryDayShifts">0</span></div>
                        </div>
                    </div>
                    <!-- Chart container -->
                    <div class="chart-container">
                        <canvas id="monthlyAttendanceChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Fourth Section: Saved Entries Data -->
            <section id="dailyEntriesSection" class="section-card">
                <h2>Daily Entries</h2>
                <div class="table-responsive">
                    <table id="attendanceTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Status</th>
                                <th>Hour</th>
                                <th>Extra Hour</th>
                                <th>Late</th>
                                <th>Shift</th>
                                <th>Grace</th>
                                <th>Approval</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- History Page Section (Initially hidden) -->
        <section id="historySection" class="container">
            <div class="section-card">
                <h2>Custom Report Generator</h2>
                <div class="date-range-inputs">
                    <div class="input-group">
                        <label for="historyDateFrom">From Date:</label>
                        <input type="date" id="historyDateFrom">
                    </div>
                    <div class="input-group">
                        <label for="historyDateTo">To Date:</label>
                        <input type="date" id="historyDateTo">
                    </div>
                    <button id="findHistoryResultBtn" class="premium-button">Generate Report</button>
                </div>
                
                <div id="historySummaryResult" class="history-summary">
                    <h3>Report Summary</h3>
                    <div class="summary-grid">
                        <div><strong>Total Hours:</strong> <span id="historySummaryTotalHours">0</span></div>
                        <div><strong>Late:</strong> <span id="historySummaryLate">0</span></div>
                        <div><strong>Absent:</strong> <span id="historySummaryAbsent">0</span></div>
                        <div><strong>Weekends:</strong> <span id="historySummaryWeekend">0</span></div>
                        <div><strong>Holidays:</strong> <span id="historySummaryHoliday">0</span></div>
                        <div><strong>Working Days:</strong> <span id="historySummaryWorkingDays">0</span></div>
                        <div><strong>Total Present:</strong> <span id="historySummaryTotalPresent">0</span></div>
                        <div><strong>Day Shifts:</strong> <span id="historySummaryDayShifts">0</span></div>
                        <div><strong>Night Shifts:</strong> <span id="historySummaryNightShifts">0</span></div>
                        <div><strong>Grace Used:</strong> <span id="historySummaryGrace">0</span></div>
                    </div>
                </div>

                <div id="historyDetailedEntries" class="table-responsive" style="margin-top: 30px;">
                    <h3>Detailed Entries</h3>
                    <table id="historyAttendanceTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Status</th>
                                <th>Hour</th>
                                <th>Extra Hour</th>
                                <th>Late</th>
                                <th>Shift</th>
                                <th>Grace</th>
                                <th>Approval</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Detailed entries will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Edit/Delete Modal (Now handles Add/Edit/Delete) -->
        <div id="editDeleteModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeEditDeleteModal">&times;</span>
                <h2 id="editDeleteModalTitle"></h2>
                <div class="input-group">
                    <label for="editDate">Date</label>
                    <input type="date" id="editDate" readonly>
                </div>
                <div class="input-group">
                    <label for="editStatus">Status</label>
                    <select id="editStatus">
                        <option value="Present">Present</option>
                        <option value="Weekend">Weekend</option>
                        <option value="Absent">Absent</option>
                        <option value="Holiday">General Holiday</option>
                        <option value="Government_Holiday">Government Holiday</option>
                        <option value="Sick_Leave">Sick Leave</option>
                    </select>
                </div>
                <div class="input-group" id="editHourGroup">
                    <label for="editHour">Hours Worked</label>
                    <input type="number" id="editHour" min="0" max="24" placeholder="e.g., 9">
                </div>
                <div class="input-group" id="editExtraHourGroup">
                    <label for="editExtraHour">Extra Hours</label>
                    <input type="number" id="editExtraHour" min="0" max="24" placeholder="e.g., 2">
                </div>
                <div class="input-group" id="editLateHourGroup">
                    <label for="editLateHour">Late (HH:MM)</label>
                    <input type="text" id="editLateHour" value="00:00" readonly>
                </div>
                <div class="input-group" id="editShiftTypeGroup">
                    <label for="editShiftType">Shift Type</label>
                    <select id="editShiftType">
                        <option value="Day">Day</option>
                        <option value="Night">Night</option>
                    </select>
                </div>
                <div class="input-group" id="editGraceGroup">
                    <label for="editGrace">Apply Grace Period</label>
                    <select id="editGrace">
                        <option value="-">-</option>
                        <option value="Yes">Yes</option>
                    </select>
                    <small id="editGraceLimitMessage" style="color: var(--alert-error); display: none;">Grace limit reached for this month (5/5)</small>
                </div>
                <div class="input-group" id="editApprovalGroup">
                    <label for="editApproval">Approval Status</label>
                    <select id="editApproval">
                        <option value="-">-</option>
                        <option value="Approved">Approved</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button id="updateEntryBtn" class="premium-button"></button> <!-- Text updated by JS -->
                    <button id="deleteEntryBtn" class="premium-button delete-button" style="display:none;">Delete Entry</button>
                    <button id="cancelEditEntryBtn" class="premium-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Custom Alert Modal (for general messages) -->
        <div id="customAlertModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeCustomAlertModal">&times;</span>
                <h2 id="customAlertTitle"></h2>
                <p id="customAlertMessage"></p>
                <div class="modal-buttons">
                    <button id="customAlertOkBtn" class="premium-button">OK</button>
                </div>
            </div>
        </div>

        <!-- Custom Confirm Modal (for yes/no questions) -->
        <div id="customConfirmModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeCustomConfirmModal">&times;</span>
                <h2 id="customConfirmTitle"></h2>
                <p id="customConfirmMessage"></p>
                <div class="modal-buttons">
                    <button id="customConfirmYesBtn" class="premium-button">Yes</button>
                    <button id="customConfirmNoBtn" class="premium-button secondary">No</button>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="modal">
            <div class="modal-content help-modal-content">
                <span class="close-button" id="closeHelpModal">&times;</span>
                <h2 id="helpModalTitle">Need Assistance?</h2>
                <p id="helpModalMessage">Feel free to contact support or refer to the documentation for any queries!</p>
            </div>
        </div>

        <!-- Fifth Section: Footer -->
        <footer>
            <div class="footer-section">
                <h4>Contact Us</h4>
                <p><i class="fas fa-phone"></i> +8801518138951</p>
                <p><i class="fas fa-envelope"></i> <a href="mailto:prantorodrix9@gmail.com">prantorodrix9@gmail.com</a></p>
                <p><i class="fas fa-map-marker-alt"></i> Baridhara-DOHS, Gulshan, Dhaka</p>
            </div>
            <div class="footer-section">
                <h4>TaskFlow</h4>
                <p>&copy; <span id="currentYear"></span> Crafted with ❤️ by PrantoAnthonyRodrix. All rights reserved.</p>
            </div>
            <div class="footer-section">
                <h4>Connect</h4>
                <p><i class="fab fa-linkedin"></i> <a href="https://www.linkedin.com/in/prantoanthonyrodrix" target="_blank">LinkedIn</a></p>
                <p><i class="fab fa-github"></i> <a href="https://github.com/PrantoAnthonyRodrix" target="_blank">GitHub</a></p>
            </div>
        </footer>
    </div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            // Local Data Storage (Loaded from localStorage or initialized)
            let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers')) || [];
            let currentLoggedInUser = null; // To store the currently logged-in user's data

            // Save registeredUsers to localStorage
            function saveRegisteredUsers() {
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            }

            // Save currentLoggedInUser's specific data
            function saveCurrentUserData() {
                if (currentLoggedInUser) {
                    const userIndex = registeredUsers.findIndex(user => user.email === currentLoggedInUser.email);
                    if (userIndex !== -1) {
                        registeredUsers[userIndex] = currentLoggedInUser;
                    } else {
                        registeredUsers.push(currentLoggedInUser);
                    }
                    saveRegisteredUsers();
                }
            }


            // --- DOM Elements - Authentication Section ---
            const authSection = document.getElementById('authSection');
            const mainActivitySection = document.getElementById('mainActivitySection');
            const authHeading = document.getElementById('authHeading');
            const authSubHeading = document.getElementById('authSubHeading'); // New sub-heading
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const registerHereLink = document.getElementById('registerHereLink');
            const loginHereLink = document.getElementById('loginHereLink');
            const loginEmailInput = document.getElementById('loginEmail');
            const loginPasswordInput = document.getElementById('loginPassword');
            const loginEmailError = document.getElementById('loginEmailError');
            const loginPasswordError = document.getElementById('loginPasswordError');

            const registerEmailInput = document.getElementById('registerEmail');
            const registerEmailError = document.getElementById('registerEmailError');
            const registrationDetails = document.getElementById('registrationDetails'); 
            const registerUsernameInput = document.getElementById('registerUsername');
            const registerPasswordInput = document.getElementById('registerPassword');
            const registerPasswordError = document.getElementById('registerPasswordError');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const confirmPasswordError = document.getElementById('confirmPasswordError');
            const registerJoiningDateInput = document.getElementById('registerJoiningDate');
            const registerLngIdInput = document.getElementById('registerLngId');
            const registerSubmitBtn = document.getElementById('registerSubmitBtn'); 

            // --- Custom Alert/Confirm Modals DOM Elements (always present in HTML) ---
            const customAlertModal = document.getElementById('customAlertModal');
            const customAlertTitle = document.getElementById('customAlertTitle');
            const customAlertMessage = document.getElementById('customAlertMessage');
            const customAlertOkBtn = document.getElementById('customAlertOkBtn');
            const closeCustomAlertModal = document.getElementById('closeCustomAlertModal');

            const customConfirmModal = document.getElementById('customConfirmModal');
            const customConfirmTitle = document.getElementById('customConfirmTitle');
            const customConfirmMessage = document.getElementById('customConfirmMessage');
            const customConfirmYesBtn = document.getElementById('customConfirmYesBtn');
            const customConfirmNoBtn = document.getElementById('customConfirmNoBtn');
            const closeCustomConfirmModal = document.getElementById('closeCustomConfirmModal');
            let confirmCallback = null; // To store the callback for customConfirmModal

            // Theme toggle button (always present in HTML)
            const themeToggle = document.getElementById('themeToggle');
            const themeList = ['light', 'dark', 'neptune-vibe']; 
            let currentThemeIndex = 0;

            // Help Modal elements (always present in HTML)
            const helpModal = document.getElementById('helpModal');
            const closeHelpModal = helpModal ? helpModal.querySelector('.close-button') : null;
            const helpModalTitle = document.getElementById('helpModalTitle');
            const helpModalMessage = document.getElementById('helpModalMessage');


            // --- DOM Elements - Main Activity Section (will be queried after main section is visible) ---
            let mainNavbar, usernameDisplay, userPhotoDisplay, personalProfileBtn, logoutBtn, profileModal, profileModalCloseBtn,
                profileNameInput, usernameInput, emailInput, profilePictureInput, profilePicturePreview, saveProfileBtn,
                profileJoiningDateInput, profileLngIdInput, dashboardUserPhoto, dashboardUsername, workedForDisplay, lngIdDisplay,
                monthSelectDropdown, dateFromDisplay, dateToDisplay, summaryTotalHours,
                summaryLate, summaryAbsent, summaryWeekend, summaryHoliday, summaryWorkingDays, summaryDayShifts, summaryNightShifts, summaryGrace, summaryTotalPresent,
                attendanceTableBody, editDeleteModal, editDeleteModalCloseBtn, editDeleteModalTitle, editDateInput, editHourInput,
                editExtraHourInput, editLateHourInput, editShiftTypeInput, updateEntryBtn, deleteEntryBtn, cancelEditEntryBtn, currentYearSpan,
                editStatusInput, editPresentDetailsGroup, editExtraHourGroup, editLateHourGroup, editShiftTypeGroup, editGraceGroup, editGraceInput, editGraceLimitMessage,
                editApprovalGroup, editApprovalInput;

            // Navigation elements
            let homeNavLink, historyNavLink, helpNavLinkRef; 
            let dashboardSection, monthlySummarySection, dailyEntriesSection, historySection; 
            let navSignInBtn; 

            // History page elements
            let historyDateFromInput, historyDateToInput, findHistoryResultBtn;
            let historySummaryTotalHours, historySummaryLate, historySummaryAbsent, historySummaryWeekend, historySummaryHoliday,
                historySummaryWorkingDays, historySummaryDayShifts, historySummaryNightShifts, historySummaryGrace, historySummaryTotalPresent;
            let historyAttendanceTableBody;

            // Chart.js instance
            let monthlyChart = null;

            let currentMonthView = new Date(); 

            // --- Initial Setup and Authentication Flow ---
            function initializeApp() {
                const savedTheme = localStorage.getItem('theme') || 'neptune-vibe';
                applyTheme(savedTheme);

                const lastLoggedInEmail = localStorage.getItem('lastLoggedInUserEmail');
                if (lastLoggedInEmail) {
                    const user = registeredUsers.find(u => u.email === lastLoggedInEmail);
                    if (user) {
                        currentLoggedInUser = user;
                        showMainActivitySection();
                        return; 
                    }
                }
                showAuthSection(); 
            }

            function showAuthSection() {
                authSection.style.display = 'flex';
                mainActivitySection.style.display = 'none';
                document.body.classList.add('login-page-body');
                document.body.classList.remove('main-page-body');
                document.body.classList.remove('animate-scroll'); // Remove dynamic scroll class
                setupAuthPage();
            }

            function showMainActivitySection() {
                authSection.style.display = 'none';
                mainActivitySection.style.display = 'block';
                document.body.classList.remove('login-page-body');
                document.body.classList.add('main-page-body');
                document.body.classList.add('animate-scroll'); // Add dynamic scroll class
                queryMainAppElements(); 
                setupMainApp();
                updateUserProfileDisplay(); 
                populateMonthDropdown(); 
                setupMonthView(currentMonthView); 
                showSection('dashboard');
            }

            function clearErrors() {
                if (loginEmailInput) loginEmailInput.classList.remove('error');
                if (loginPasswordInput) loginPasswordInput.classList.remove('error');
                if (loginEmailError) loginEmailError.textContent = '';
                if (loginPasswordError) loginPasswordError.textContent = '';

                if (registerEmailInput) registerEmailInput.classList.remove('error');
                if (registerPasswordInput) registerPasswordInput.classList.remove('error');
                if (confirmPasswordInput) confirmPasswordInput.classList.remove('error');
                if (registerEmailError) registerEmailError.textContent = '';
                if (registerPasswordError) registerPasswordError.textContent = '';
                if (confirmPasswordError) confirmPasswordError.textContent = '';
            }

            function setupAuthPage() {
                clearErrors(); 

                if (loginForm.classList.contains('active')) {
                    if (authHeading) authHeading.textContent = 'Welcome Back!';
                    if (authSubHeading) authSubHeading.textContent = 'Log in to your TaskFlow account.';
                } else if (registerForm.classList.contains('active')) {
                    if (authHeading) authHeading.textContent = 'Join TaskFlow';
                    if (authSubHeading) authSubHeading.textContent = 'Create an account to get started.';
                }

                if (registerHereLink) {
                    registerHereLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        loginForm.style.display = 'none';
                        registerForm.style.display = 'flex';
                        registerForm.classList.add('active'); 
                        loginForm.classList.remove('active'); 
                        if (authHeading) authHeading.textContent = 'Join TaskFlow';
                        if (authSubHeading) authSubHeading.textContent = 'Create an account to get started.';
                        registerEmailInput.value = '';
                        registerUsernameInput.value = '';
                        registerPasswordInput.value = '';
                        confirmPasswordInput.value = '';
                        registerJoiningDateInput.value = '';
                        registerLngIdInput.value = '';
                        clearErrors();
                    });
                }

                if (loginHereLink) {
                    loginHereLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        registerForm.style.display = 'none';
                        loginForm.style.display = 'flex';
                        loginForm.classList.add('active'); 
                        registerForm.classList.remove('active'); 
                        if (authHeading) authHeading.textContent = 'Welcome Back!';
                        if (authSubHeading) authSubHeading.textContent = 'Log in to your TaskFlow account.';
                        clearErrors(); 
                    });
                }

                if (loginForm) {
                    loginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        clearErrors(); 

                        const email = loginEmailInput.value.trim();
                        const password = loginPasswordInput.value.trim();

                        if (!email) {
                            loginEmailInput.classList.add('error');
                            loginEmailError.textContent = 'Email is required.';
                            return;
                        }
                        if (!password) {
                            loginPasswordInput.classList.add('error');
                            loginPasswordError.textContent = 'Password is required.';
                            return;
                        }

                        const user = registeredUsers.find(u => u.email === email);

                        if (!user) {
                            loginEmailInput.classList.add('error');
                            loginEmailError.textContent = 'Email not registered.';
                            return;
                        }

                        if (user.password !== password) { 
                            loginPasswordInput.classList.add('error');
                            loginPasswordError.textContent = 'Incorrect password.';
                            return;
                            }

                        currentLoggedInUser = user;
                        if (!currentLoggedInUser.attendance) currentLoggedInUser.attendance = {};
                        if (!currentLoggedInUser.graceCounts) currentLoggedInUser.graceCounts = {};

                        localStorage.setItem('lastLoggedInUserEmail', email); 
                        showMainActivitySection();
                    });
                }

                if (registerForm) {
                    registerForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        clearErrors(); 

                        const email = registerEmailInput.value.trim();
                        const username = registerUsernameInput.value.trim();
                        const password = registerPasswordInput.value.trim();
                        const confirmPassword = confirmPasswordInput.value.trim();
                        const joiningDate = registerJoiningDateInput.value;
                        const lngId = registerLngIdInput.value.trim();

                        let hasError = false;

                        if (!email) {
                            registerEmailInput.classList.add('error');
                            registerEmailError.textContent = 'Email is required.';
                            hasError = true;
                        } else if (registeredUsers.some(u => u.email === email)) {
                            registerEmailInput.classList.add('error');
                            registerEmailError.textContent = 'This email is already registered.';
                            hasError = true;
                        }
                        if (!username) { /* required, but no specific error class for now */ }
                        if (!password) {
                            registerPasswordInput.classList.add('error');
                            registerPasswordError.textContent = 'Password is required.';
                            hasError = true;
                        } else if (password.length < 6) {
                            registerPasswordInput.classList.add('error');
                            registerPasswordError.textContent = 'Password must be at least 6 characters.';
                            hasError = true;
                        }
                        if (!confirmPassword) {
                            confirmPasswordInput.classList.add('error');
                            confirmPasswordError.textContent = 'Confirm password is required.';
                            hasError = true;
                        } else if (password !== confirmPassword) {
                            confirmPasswordInput.classList.add('error');
                            confirmPasswordError.textContent = 'Passwords do not match!';
                            hasError = true;
                        }
                        if (!joiningDate) { /* required, but no specific error class for now */ }
                        if (!lngId) { /* required, but no specific error class for now */ }

                        if (hasError) {
                            return;
                        }

                        const newUser = {
                            profileName: username,
                            username: username,
                            email: email,
                            password: password,
                            photo: `https://placehold.co/40x40/${(Math.random()*0xFFFFFF<<0).toString(16).padStart(6,'0')}/ffffff?text=${username.charAt(0).toUpperCase()}`,
                            joiningDate: joiningDate,
                            lngId: lngId,
                            attendance: {},
                            graceCounts: {}
                        };
                        registeredUsers.push(newUser);
                        saveRegisteredUsers();
                        
                        showCustomAlert('Success!', 'Registration successful! You can now login with this email.', 'success');
                        loginForm.style.display = 'flex';
                        registerForm.style.display = 'none';
                        loginForm.classList.add('active'); 
                        registerForm.classList.remove('active'); 
                        if (authHeading) authHeading.textContent = 'Welcome Back!';
                        if (authSubHeading) authSubHeading.textContent = 'Log in to your TaskFlow account.';
                    });
                }
            }

            function queryMainAppElements() {
                mainNavbar = document.getElementById('main-navbar');
                usernameDisplay = document.getElementById('usernameDisplay');
                userPhotoDisplay = document.getElementById('userPhotoDisplay');
                personalProfileBtn = document.getElementById('personalProfileBtn');
                logoutBtn = document.getElementById('logoutBtn');
                
                profileModal = document.getElementById('profileModal');
                profileModalCloseBtn = profileModal.querySelector('.close-button');
                profileNameInput = document.getElementById('profileNameInput');
                usernameInput = document.getElementById('usernameInput');
                emailInput = document.getElementById('emailInput');
                profilePictureInput = document.getElementById('profilePictureInput');
                saveProfileBtn = document.getElementById('saveProfileBtn');
                profileJoiningDateInput = document.getElementById('profileJoiningDateInput');
                profileLngIdInput = document.getElementById('profileLngIdInput');
                profilePicturePreview = document.getElementById('profilePicturePreview');

                dashboardUserPhoto = document.getElementById('dashboardUserPhoto');
                dashboardUsername = document.getElementById('dashboardUsername');
                workedForDisplay = document.getElementById('workedForDisplay');
                lngIdDisplay = document.getElementById('lngIdDisplay');

                monthSelectDropdown = document.getElementById('monthSelectDropdown');
                dateFromDisplay = document.getElementById('dateFrom');
                dateToDisplay = document.getElementById('dateTo');

                summaryTotalHours = document.getElementById('summaryTotalHours');
                summaryLate = document.getElementById('summaryLate');
                summaryAbsent = document.getElementById('summaryAbsent');
                summaryWeekend = document.getElementById('summaryWeekend');
                summaryHoliday = document.getElementById('summaryHoliday');
                summaryWorkingDays = document.getElementById('summaryWorkingDays');
                summaryDayShifts = document.getElementById('summaryDayShifts');
                summaryNightShifts = document.getElementById('summaryNightShifts');
                summaryGrace = document.getElementById('summaryGrace');
                summaryTotalPresent = document.getElementById('summaryTotalPresent');

                attendanceTableBody = document.querySelector('#attendanceTable tbody');
                
                // Edit/Delete/Add Modal elements (consolidated)
                editDeleteModal = document.getElementById('editDeleteModal');
                editDeleteModalCloseBtn = editDeleteModal.querySelector('.close-button');
                editDeleteModalTitle = document.getElementById('editDeleteModalTitle');
                editDateInput = document.getElementById('editDate');
                editStatusInput = document.getElementById('editStatus');
                editHourInput = document.getElementById('editHour');
                editExtraHourInput = document.getElementById('editExtraHour');
                editLateHourInput = document.getElementById('editLateHour');
                editShiftTypeInput = document.getElementById('editShiftType');
                editGraceInput = document.getElementById('editGrace');
                editGraceLimitMessage = document.getElementById('editGraceLimitMessage');
                updateEntryBtn = document.getElementById('updateEntryBtn');
                deleteEntryBtn = document.getElementById('deleteEntryBtn');
                cancelEditEntryBtn = document.getElementById('cancelEditEntryBtn');

                editHourGroup = document.getElementById('editHourGroup');
                editExtraHourGroup = document.getElementById('editExtraHourGroup');
                editLateHourGroup = document.getElementById('editLateHourGroup');
                editShiftTypeGroup = document.getElementById('editShiftTypeGroup');
                editGraceGroup = document.getElementById('editGraceGroup');
                editApprovalGroup = document.getElementById('editApprovalGroup');
                editApprovalInput = document.getElementById('editApproval');

                currentYearSpan = document.getElementById('currentYear');
                
                homeNavLink = document.getElementById('homeNavLink');
                historyNavLink = document.getElementById('historyNavLink');
                helpNavLinkRef = document.getElementById('helpNavLink');
                dashboardSection = document.getElementById('dashboardSection');
                monthlySummarySection = document.getElementById('monthlySummarySection');
                dailyEntriesSection = document.getElementById('dailyEntriesSection');
                historySection = document.getElementById('historySection');

                historyDateFromInput = document.getElementById('historyDateFrom');
                historyDateToInput = document.getElementById('historyDateTo');
                findHistoryResultBtn = document.getElementById('findHistoryResultBtn');
                historySummaryTotalHours = document.getElementById('historySummaryTotalHours');
                historySummaryLate = document.getElementById('historySummaryLate');
                historySummaryAbsent = document.getElementById('historySummaryAbsent');
                historySummaryWeekend = document.getElementById('historySummaryWeekend');
                historySummaryHoliday = document.getElementById('historySummaryHoliday');
                historySummaryWorkingDays = document.getElementById('historySummaryWorkingDays');
                historySummaryDayShifts = document.getElementById('historySummaryDayShifts');
                historySummaryNightShifts = document.getElementById('historySummaryNightShifts');
                historySummaryGrace = document.getElementById('historySummaryGrace');
                historySummaryTotalPresent = document.getElementById('historySummaryTotalPresent');
                historyAttendanceTableBody = document.querySelector('#historyAttendanceTable tbody');

                navSignInBtn = document.getElementById('navSignInBtn');
            }


            // --- Theme Management ---
            function getThemeProperty(property) {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                if (currentTheme === 'light') return getComputedStyle(document.documentElement).getPropertyValue(`${property}-light`);
                if (currentTheme === 'dark') return getComputedStyle(document.documentElement).getPropertyValue(`${property}-dark`);
                return getComputedStyle(document.documentElement).getPropertyValue(`${property}`); // Neptune-vibe is default
            }

            function applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                if (themeToggle) {
                    if (theme === 'light') {
                        themeToggle.className = 'fas fa-sun';
                    } else if (theme === 'dark') {
                        themeToggle.className = 'fas fa-moon';
                    } else if (theme === 'neptune-vibe') {
                        themeToggle.className = 'fas fa-palette';
                    }
                    currentThemeIndex = themeList.indexOf(theme);
                }
            }

            function toggleTheme() {
                currentThemeIndex = (currentThemeIndex + 1) % themeList.length;
                const newTheme = themeList[currentThemeIndex];
                applyTheme(newTheme);
                // Update chart colors immediately after theme change
                if (monthlyChart) {
                    monthlyChart.data.datasets[0].backgroundColor = [
                        getThemeProperty('--chart-color-present'),
                        getThemeProperty('--chart-color-absent'),
                        getThemeProperty('--chart-color-late')
                    ];
                    monthlyChart.options.plugins.legend.labels.color = getThemeProperty('--text-primary');
                    monthlyChart.data.datasets[0].borderColor = getThemeProperty('--bg-secondary');
                    monthlyChart.update();
                }
            }

            // --- Custom Alert/Confirm Modal Functions ---
            function showCustomAlert(title, message, type = 'info') {
                if (customAlertModal) {
                    customAlertTitle.textContent = title;
                    customAlertMessage.textContent = message;
                    customAlertModal.querySelector('.modal-content').className = 'modal-content ' + type;
                    customAlertModal.style.display = 'flex';
                }
            }

            function closeCustomAlertModalFunc() {
                if (customAlertModal) {
                    customAlertModal.style.display = 'none';
                }
            }

            function showCustomConfirm(title, message, onConfirm) {
                if (customConfirmModal) {
                    customConfirmTitle.textContent = title;
                    customConfirmMessage.textContent = message;
                    customConfirmModal.querySelector('.modal-content').className = 'modal-content info';
                    confirmCallback = onConfirm;
                    customConfirmModal.style.display = 'flex';
                }
            }

            function closeCustomConfirmModalFunc() {
                if (customConfirmModal) {
                    customConfirmModal.style.display = 'none';
                    confirmCallback = null;
                }
            }

            function setupMainApp() {
                if (currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();
                
                window.addEventListener('scroll', () => {
                    if (mainNavbar) {
                        if (window.scrollY > 30) { // Reduced scroll threshold
                            mainNavbar.classList.add('scrolled');
                        } else {
                            mainNavbar.classList.remove('scrolled');
                        }
                    }
                    // Dynamic background position based on scroll
                    const scrollY = window.scrollY;
                    const totalHeight = document.body.scrollHeight - window.innerHeight;
                    const scrollPercentage = scrollY / totalHeight;
                    // Adjust multiplier for desired speed, 100% means 0% to 100% background-position change
                    const backgroundPositionX = scrollPercentage * 50; // Move from 0% to 50% across the 200% width
                    document.body.style.backgroundPosition = `${backgroundPositionX}% 50%`;
                });

                if (usernameDisplay && usernameDisplay.parentElement) {
                    usernameDisplay.parentElement.addEventListener('click', () => {
                        usernameDisplay.parentElement.classList.toggle('active');
                    });
                }

                if (personalProfileBtn) {
                    personalProfileBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        openProfileModal();
                        if (usernameDisplay && usernameDisplay.parentElement) {
                            usernameDisplay.parentElement.classList.remove('active');
                        }
                    });
                }

                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        logout();
                    });
                }

                if (navSignInBtn) {
                    navSignInBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        logout(); 
                    });
                }

                if (profileModalCloseBtn) profileModalCloseBtn.addEventListener('click', closeProfileModal);
                if (profileModal) {
                    profileModal.addEventListener('click', (event) => {
                        if (event.target == profileModal) {
                            closeProfileModal();
                        }
                    });
                }

                if (profilePictureInput) profilePictureInput.addEventListener('change', handleProfilePictureChange);
                if (saveProfileBtn) saveProfileBtn.addEventListener('click', saveProfileChanges);

                if (monthSelectDropdown) {
                    monthSelectDropdown.addEventListener('change', (e) => {
                        const [year, month] = e.target.value.split('-').map(Number);
                        currentMonthView = new Date(year, month - 1, 1);
                        setupMonthView(currentMonthView);
                    });
                }
                
                // Edit/Delete/Add Modal Event Listeners
                if (closeEditDeleteModal) closeEditDeleteModal.addEventListener('click', closeEditDeleteModalFunc);
                if (editDeleteModal) {
                    editDeleteModal.addEventListener('click', (event) => {
                        if (event.target == editDeleteModal) {
                            closeEditDeleteModalFunc();
                        }
                        if (event.target.closest('.modal-content')) {
                            event.stopPropagation();
                        }
                    });
                }
                if (editHourInput && editExtraHourInput && editLateHourInput) {
                    const updateEditLate = () => {
                        editLateHourInput.value = calculateLateTime(parseFloat(editHourInput.value || 0));
                    };
                    editHourInput.addEventListener('input', updateEditLate);
                }
                if (editStatusInput) {
                    editStatusInput.addEventListener('change', toggleEditPresentDetails);
                }
                if (editGraceInput) {
                    editGraceInput.addEventListener('change', () => {
                        const date = editDateInput.value;
                        if (!date) return; // Should not happen in this flow
                        
                        const monthKey = `${new Date(date).getFullYear()}-${String(new Date(date).getMonth() + 1).padStart(2, '0')}`;
                        const graceUsed = getGraceCount(monthKey);
                        const originalEntry = currentLoggedInUser.attendance[date];
                        const wasGrace = originalEntry && originalEntry.status === 'Present' && originalEntry.grace === 'Yes';

                        if (editGraceInput.value === 'Yes') {
                            // If grace limit reached AND it was NOT already a grace entry, disable
                            if (graceUsed >= 5 && !wasGrace) {
                                if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'block';
                                editGraceInput.value = '-'; // Revert selection
                            } else {
                                if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';
                            }
                        } else {
                            if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';
                        }
                    });
                }
                if (updateEntryBtn) updateEntryBtn.addEventListener('click', handleSaveOrUpdateEntry);
                if (deleteEntryBtn) deleteEntryBtn.addEventListener('click', confirmDeleteEntry);
                if (cancelEditEntryBtn) cancelEditEntryBtn.addEventListener('click', closeEditDeleteModalFunc);

                if (homeNavLink) homeNavLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection('dashboard');
                });
                if (historyNavLink) historyNavLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection('history');
                });
                if (helpNavLinkRef) {
                    helpNavLinkRef.addEventListener('click', (e) => {
                        e.preventDefault();
                        openHelpModal();
                    });
                }

                if (findHistoryResultBtn) findHistoryResultBtn.addEventListener('click', displayCustomHistorySummary);

                if (customAlertOkBtn) customAlertOkBtn.addEventListener('click', closeCustomAlertModalFunc);
                if (closeCustomAlertModal) closeCustomAlertModal.addEventListener('click', closeCustomAlertModalFunc);
                if (customAlertModal) {
                    customAlertModal.addEventListener('click', (event) => {
                        if (event.target == customAlertModal) {
                            closeCustomAlertModalFunc();
                        }
                    });
                }

                if (customConfirmYesBtn) customConfirmYesBtn.addEventListener('click', () => {
                    if (confirmCallback) {
                        confirmCallback(true);
                    }
                    closeCustomConfirmModalFunc();
                });
                if (customConfirmNoBtn) customConfirmNoBtn.addEventListener('click', () => {
                    if (confirmCallback) {
                        confirmCallback(false);
                    }
                    closeCustomConfirmModalFunc();
                });
                if (closeCustomConfirmModal) closeCustomConfirmModal.addEventListener('click', closeCustomConfirmModalFunc);
                if (customConfirmModal) {
                    customConfirmModal.addEventListener('click', (event) => {
                        if (event.target == customConfirmModal) {
                            closeCustomConfirmModalFunc();
                        }
                    });
                }

                if (themeToggle) {
                    themeToggle.addEventListener('click', toggleTheme);
                }

                if (closeHelpModal) closeHelpModal.addEventListener('click', closeHelpModalFunc);
                if (helpModal) {
                    helpModal.addEventListener('click', (event) => {
                        if (event.target == helpModal) {
                            closeHelpModalFunc();
                        }
                    });
                }

                // Initialize Chart.js
                const ctx = document.getElementById('monthlyAttendanceChart').getContext('2d');
                monthlyChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Present (incl. Excused)', 'Absent', 'Late (Equivalent Days)'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: [
                                getThemeProperty('--chart-color-present'),
                                getThemeProperty('--chart-color-absent'),
                                getThemeProperty('--chart-color-late')
                            ],
                            borderColor: getThemeProperty('--bg-secondary'),
                            borderWidth: 2 // Slightly thinner border for chart slices
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%', // Slightly smaller cutout
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: getThemeProperty('--text-primary'),
                                    font: {
                                        family: 'Montserrat',
                                        size: 11 // Smaller font size
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed + ' Days';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                // Update chart colors on theme change
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'data-theme') {
                            if (monthlyChart) {
                                monthlyChart.data.datasets[0].backgroundColor = [
                                    getThemeProperty('--chart-color-present'),
                                    getThemeProperty('--chart-color-absent'),
                                    getThemeProperty('--chart-color-late')
                                ];
                                monthlyChart.options.plugins.legend.labels.color = getThemeProperty('--text-primary');
                                monthlyChart.data.datasets[0].borderColor = getThemeProperty('--bg-secondary');
                                monthlyChart.update();
                            }
                        }
                    });
                });
                observer.observe(document.documentElement, { attributes: true });
            }

            // --- Section Visibility Control ---
            function showSection(sectionName) {
                if (dashboardSection) dashboardSection.style.display = 'none';
                if (monthlySummarySection) monthlySummarySection.style.display = 'none';
                if (dailyEntriesSection) dailyEntriesSection.style.display = 'none';
                if (historySection) historySection.style.display = 'none';

                const allNavLinks = document.querySelectorAll('.nav-links a');
                allNavLinks.forEach(link => link.classList.remove('active-nav-link'));

                if (sectionName === 'dashboard') {
                    if (dashboardSection) dashboardSection.style.display = 'flex';
                    if (monthlySummarySection) monthlySummarySection.style.display = 'block';
                    if (dailyEntriesSection) dailyEntriesSection.style.display = 'block';
                    setupMonthView(currentMonthView);
                    if (homeNavLink) homeNavLink.classList.add('active-nav-link');
                } else if (sectionName === 'history') {
                    if (historySection) historySection.style.display = 'block';
                    if (historySummaryTotalHours) historySummaryTotalHours.textContent = '0';
                    if (historySummaryLate) historySummaryLate.textContent = '00:00';
                    if (historySummaryAbsent) historySummaryAbsent.textContent = '0';
                    if (historySummaryWeekend) historySummaryWeekend.textContent = '0';
                    if (historySummaryHoliday) historySummaryHoliday.textContent = '0';
                    if (historySummaryWorkingDays) historySummaryWorkingDays.textContent = '0';
                    if (historySummaryDayShifts) historySummaryDayShifts.textContent = '0';
                    if (historySummaryNightShifts) historySummaryNightShifts.textContent = '0';
                    if (historySummaryGrace) historySummaryGrace.textContent = '0';
                    if (historySummaryTotalPresent) historySummaryTotalPresent.textContent = '0';
                    if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';
                    if (historyNavLink) historyNavLink.classList.add('active-nav-link');
                }
            }


            // --- Functions (Shared & Main App) ---

            function calculateWorkedFor(joiningDateStr) {
                if (!joiningDateStr) return "N/A";

                const joiningDate = new Date(joiningDateStr);
                const today = new Date();

                let years = today.getFullYear() - joiningDate.getFullYear();
                let months = today.getMonth() - joiningDate.getMonth();
                let days = today.getDate() - joiningDate.getDate();

                if (days < 0) {
                    months--;
                    days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
                }

                if (months < 0) {
                    years--;
                    months += 12;
                }
                return `${years} years ${months} months`;
            }

            function updateUserProfileDisplay() {
                if (!currentLoggedInUser) return;

                const displayName = currentLoggedInUser.profileName || currentLoggedInUser.username || currentLoggedInUser.email.split('@')[0] || 'User';
                const displayPhoto = currentLoggedInUser.photo || `https://placehold.co/40x40/${(Math.random()*0xFFFFFF<<0).toString(16).padStart(6,'0')}/ffffff?text=${displayName.charAt(0).toUpperCase()}`;

                if (usernameDisplay) usernameDisplay.textContent = displayName;
                if (userPhotoDisplay) userPhotoDisplay.src = displayPhoto;
                
                if (dashboardUserPhoto) dashboardUserPhoto.src = currentLoggedInUser.photo || `https://placehold.co/180x180/${(Math.random()*0xFFFFFF<<0).toString(16).padStart(6,'0')}/ffffff?text=${displayName.charAt(0).toUpperCase()}`;
                if (dashboardUsername) dashboardUsername.textContent = displayName;
                if (workedForDisplay) workedForDisplay.textContent = calculateWorkedFor(currentLoggedInUser.joiningDate);
                if (lngIdDisplay) lngIdDisplay.textContent = currentLoggedInUser.lngId || 'N/A';

                if (emailInput) emailInput.value = currentLoggedInUser.email || '';
                if (profileNameInput) profileNameInput.value = currentLoggedInUser.profileName || '';
                if (usernameInput) usernameInput.value = currentLoggedInUser.username || '';
                if (profileJoiningDateInput) profileJoiningDateInput.value = currentLoggedInUser.joiningDate || '';
                if (profileLngIdInput) profileLngIdInput.value = currentLoggedInUser.lngId || '';
                if (profilePicturePreview) profilePicturePreview.src = currentLoggedInUser.photo || `https://placehold.co/120x120/${(Math.random()*0xFFFFFF<<0).toString(16).padStart(6,'0')}/ffffff?text=${displayName.charAt(0).toUpperCase()}`;
            }

            function openProfileModal() {
                if (profileModal) profileModal.style.display = 'flex';
                updateUserProfileDisplay(); 
            }

            function closeProfileModal() {
                if (profileModal) profileModal.style.display = 'none';
            }

            function saveProfileChanges() {
                if (!currentLoggedInUser) return;

                const updatedProfile = {
                    profileName: profileNameInput.value.trim(),
                    username: usernameInput.value.trim(),
                    joiningDate: profileJoiningDateInput.value,
                    lngId: profileLngIdInput.value.trim(),
                    photo: profilePicturePreview.src 
                };

                currentLoggedInUser = { ...currentLoggedInUser, ...updatedProfile };
                saveCurrentUserData(); 

                updateUserProfileDisplay();
                showCustomAlert('Profile Update', 'Profile updated successfully!', 'success');
                closeProfileModal();
            }

            function handleProfilePictureChange(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (profilePicturePreview) profilePicturePreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }

            function logout() {
                localStorage.removeItem('lastLoggedInUserEmail'); 
                currentLoggedInUser = null; 
                showAuthSection(); 
                showCustomAlert('Logged Out', 'You have been successfully logged out.', 'info');
            }

            function getMonthRange(date) {
                const year = date.getFullYear();
                const month = date.getMonth(); 

                const startDate = new Date(year, month - 1, 26);
                const endDate = new Date(year, month, 25);

                return { start: startDate, end: endDate };
            }

            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function formatDisplayDate(date) {
                return new Date(date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            function getDayOfWeek(date) {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return days[new Date(date).getDay()];
            }

            function populateMonthDropdown() {
                if (!monthSelectDropdown) return;

                monthSelectDropdown.innerHTML = ''; 
                const today = new Date();
                const currentMonth = today.getMonth(); 
                const currentYear = today.getFullYear();

                for (let i = -6; i <= 6; i++) {
                    const date = new Date(currentYear, currentMonth + i, 1);
                    const optionValue = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const optionText = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionText;

                    if (date.getFullYear() === currentMonthView.getFullYear() && date.getMonth() === currentMonthView.getMonth()) {
                        option.selected = true;
                    }
                    monthSelectDropdown.appendChild(option);
                }
            }

            function setupMonthView(date) {
                const { start, end } = getMonthRange(date);
                if (dateFromDisplay) dateFromDisplay.textContent = formatDisplayDate(start);
                if (dateToDisplay) dateToDisplay.textContent = formatDisplayDate(end);
                displayAttendanceHistory();
            }

            function calculateLateTime(hour) {
                const standardHour = 9;
                if (hour < standardHour) {
                    const diffMinutes = (standardHour - hour) * 60;
                    const hours = Math.floor(diffMinutes / 60);
                    const minutes = Math.round(diffMinutes % 60);
                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                }
                return "00:00";
            }

            function getGraceCount(monthKey) {
                if (!currentLoggedInUser || !currentLoggedInUser.graceCounts) return 0;
                return currentLoggedInUser.graceCounts[monthKey] || 0;
            }

            function updateGraceCount(monthKey, increment) {
                let newGraceCounts = { ...(currentLoggedInUser.graceCounts || {}) };
                newGraceCounts[monthKey] = (newGraceCounts[monthKey] || 0) + increment;
                currentLoggedInUser.graceCounts = newGraceCounts; 
                saveCurrentUserData(); 
            }

            function checkGraceLimit(monthKey) {
                return getGraceCount(monthKey) >= 5;
            }

            function displayAttendanceHistory() {
                if (!attendanceTableBody || !currentLoggedInUser) return;

                attendanceTableBody.innerHTML = '';
                const { start, end } = getMonthRange(currentMonthView);

                const currentUserAttendance = currentLoggedInUser.attendance || {};

                let totalHours = 0;
                let totalLateMinutes = 0;
                let totalAbsentDays = 0;
                let totalWeekendDays = 0;
                let totalHolidayDays = 0;
                let totalGovernmentHolidayDays = 0; 
                let totalSickLeaveDays = 0; 
                let totalWorkingDays = 0;
                let totalDayShifts = 0;
                let totalNightShifts = 0;
                let totalGraceDays = 0;
                let totalPresentLikeDaysForChart = 0; 
                let totalPresentCount = 0; 

                let currentDate = new Date(start);
                while (currentDate <= end) {
                    const dateKey = formatDate(currentDate);
                    const dayOfWeek = getDayOfWeek(currentDate);
                    const entry = currentUserAttendance[dateKey];

                    const row = attendanceTableBody.insertRow();
                    row.classList.add(`status-${(entry?.status || 'unmarked').toLowerCase()}-row`); 

                    const cellDate = row.insertCell();
                    const cellDay = row.insertCell();
                    const cellStatus = row.insertCell();
                    const cellHour = row.insertCell();
                    const cellExtraHour = row.insertCell();
                    const cellLate = row.insertCell();
                    const cellShift = row.insertCell();
                    const cellGrace = row.insertCell();
                    const cellApproval = row.insertCell(); 
                    const cellActions = row.insertCell();

                    cellDate.textContent = formatDisplayDate(currentDate);
                    cellDay.textContent = dayOfWeek;
                    cellStatus.className = '';

                    if (entry && entry.status) {
                        cellStatus.textContent = entry.status.replace(/_/g, ' '); 
                        cellStatus.classList.add(`status-${entry.status.toLowerCase()}`);

                        if (entry.status === 'Present' || entry.status === 'Government_Holiday' || entry.status === 'Sick_Leave') {
                            cellHour.textContent = entry.hour;
                            cellExtraHour.textContent = entry.extraHour;
                            cellLate.textContent = entry.late;
                            cellShift.textContent = entry.shift;
                            cellGrace.textContent = entry.grace || '-';
                            cellApproval.textContent = entry.approval || '-';

                            totalHours += entry.hour + (entry.extraHour || 0);
                            const [lateHours, lateMinutes] = entry.late.split(':').map(Number);
                            totalLateMinutes += (lateHours * 60) + lateMinutes;

                            if (entry.shift === 'Day') totalDayShifts++;
                            else if (entry.shift === 'Night') totalNightShifts++;
                            totalWorkingDays++;
                            if (entry.grace === 'Yes') totalGraceDays++;

                            if (entry.status === 'Government_Holiday') totalGovernmentHolidayDays++;
                            else if (entry.status === 'Sick_Leave') totalSickLeaveDays++;
                            totalPresentCount++; 
                            totalPresentLikeDaysForChart++; 
                        } else {
                            cellHour.textContent = '-';
                            cellExtraHour.textContent = '-';
                            cellLate.textContent = '-';
                            cellShift.textContent = '-';
                            cellGrace.textContent = '-';
                            cellApproval.textContent = entry.approval || '-';
                            if (entry.status === 'Absent') {
                                totalAbsentDays++;
                                totalWorkingDays++;
                            } else if (entry.status === 'Weekend') {
                                totalWeekendDays++;
                                totalPresentLikeDaysForChart++; 
                            } else if (entry.status === 'Holiday') {
                                totalHolidayDays++;
                                totalPresentLikeDaysForChart++; 
                            }
                        }
                    } else {
                        cellStatus.textContent = '-';
                        cellHour.textContent = '-';
                        cellExtraHour.textContent = '-';
                        cellLate.textContent = '-';
                        cellShift.textContent = '-';
                        cellGrace.textContent = '-';
                        cellApproval.textContent = '-';
                    }

                    const manageEntryBtn = document.createElement('button');
                    manageEntryBtn.textContent = (entry ? 'Manage Entry' : 'Add Entry');
                    manageEntryBtn.classList.add('premium-button');
                    if (!entry) manageEntryBtn.classList.add('secondary'); // Style "Add" differently
                    manageEntryBtn.dataset.date = dateKey;
                    manageEntryBtn.onclick = openManageEntryModal;

                    cellActions.classList.add('table-actions');
                    cellActions.appendChild(manageEntryBtn);

                    currentDate.setDate(currentDate.getDate() + 1);
                }

                if (summaryTotalHours) summaryTotalHours.textContent = totalHours;
                const formattedLateTime = `${String(Math.floor(totalLateMinutes / 60)).padStart(2, '0')}:${String(totalLateMinutes % 60).padStart(2, '0')}`;
                if (summaryLate) summaryLate.textContent = formattedLateTime;
                if (summaryAbsent) summaryAbsent.textContent = totalAbsentDays;
                if (summaryWeekend) summaryWeekend.textContent = totalWeekendDays;
                if (summaryHoliday) summaryHoliday.textContent = totalHolidayDays + totalGovernmentHolidayDays + totalSickLeaveDays; 
                if (summaryWorkingDays) summaryWorkingDays.textContent = totalWorkingDays;
                if (summaryDayShifts) summaryDayShifts.textContent = totalDayShifts;
                if (summaryNightShifts) summaryNightShifts.textContent = totalNightShifts;
                if (summaryGrace) summaryGrace.textContent = totalGraceDays;
                if (summaryTotalPresent) summaryTotalPresent.textContent = totalPresentCount + totalGovernmentHolidayDays + totalSickLeaveDays + totalWeekendDays + totalHolidayDays; 

                if (monthlyChart) {
                    const lateEquivalentDays = Math.round(totalLateMinutes / (9 * 60)); 
                    monthlyChart.data.datasets[0].data = [
                        totalPresentLikeDaysForChart, 
                        totalAbsentDays,
                        lateEquivalentDays
                    ];
                    monthlyChart.update();
                }
            }


            function openManageEntryModal(event) {
                const dateToManage = event.target.dataset.date;
                const entry = currentLoggedInUser.attendance[dateToManage];

                if (editDateInput) editDateInput.value = dateToManage;

                // Reset all fields to default/empty state
                if (editStatusInput) editStatusInput.value = 'Present';
                if (editHourInput) editHourInput.value = 9;
                if (editExtraHourInput) editExtraHourInput.value = 0;
                if (editLateHourInput) editLateHourInput.value = '00:00';
                if (editShiftTypeInput) editShiftTypeInput.value = 'Day';
                if (editGraceInput) editGraceInput.value = '-';
                if (editApprovalInput) editApprovalInput.value = '-';
                if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';

                if (entry) { // Editing existing entry
                    if (editDeleteModalTitle) editDeleteModalTitle.textContent = 'Edit Attendance Entry';
                    if (updateEntryBtn) updateEntryBtn.textContent = 'Update Entry';
                    if (deleteEntryBtn) deleteEntryBtn.style.display = 'inline-flex'; // Show delete button

                    if (editStatusInput) editStatusInput.value = entry.status;
                    if (entry.status === 'Present' || entry.status === 'Government_Holiday' || entry.status === 'Sick_Leave') {
                        if (editHourInput) editHourInput.value = entry.hour || 9; 
                        if (editExtraHourInput) editExtraHourInput.value = entry.extraHour || 0;
                        if (editLateHourInput) editLateHourInput.value = entry.late || calculateLateTime(entry.hour || 9);
                        if (editShiftTypeInput) editShiftTypeInput.value = entry.shift || 'Day';
                        if (editGraceInput) editGraceInput.value = entry.grace || '-';
                        if (editApprovalInput) editApprovalInput.value = entry.approval || '-';
                    } else {
                        // For non-present statuses, clear related fields
                        if (editHourInput) editHourInput.value = '';
                        if (editExtraHourInput) editExtraHourInput.value = '';
                        if (editLateHourInput) editLateHourInput.value = '00:00';
                        if (editShiftTypeInput) editShiftTypeInput.value = 'Day';
                        if (editGraceInput) editGraceInput.value = '-';
                        if (editApprovalInput) editApprovalInput.value = entry.approval || '-'; 
                    }
                } else { // Adding new entry
                    if (editDeleteModalTitle) editDeleteModalTitle.textContent = 'Add Attendance Entry';
                    if (updateEntryBtn) updateEntryBtn.textContent = 'Save Entry';
                    if (deleteEntryBtn) deleteEntryBtn.style.display = 'none'; // Hide delete button
                    // Default values are already set above
                }

                toggleEditPresentDetails(); // Adjust visibility based on initial/current status

                const monthKey = `${new Date(dateToManage).getFullYear()}-${String(new Date(dateToManage).getMonth() + 1).padStart(2, '0')}`;
                const graceLimitReached = checkGraceLimit(monthKey);
                const originalGraceStatus = entry && entry.status === 'Present' && entry.grace === 'Yes';

                if (editGraceInput) {
                    const graceOption = editGraceInput.querySelector('option[value="Yes"]');
                    if (graceOption) {
                        if (graceLimitReached && !originalGraceStatus) {
                            graceOption.disabled = true;
                            if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'block';
                        } else {
                            graceOption.disabled = false;
                            if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';
                        }
                    }
                }
                
                if (editDeleteModal) editDeleteModal.style.display = 'flex';
            }

            function closeEditDeleteModalFunc() {
                if (editDeleteModal) {
                    editDeleteModal.style.display = 'none';
                    // Reset fields for next open
                    if (editDateInput) editDateInput.value = '';
                    if (editStatusInput) editStatusInput.value = 'Present'; 
                    if (editHourInput) editHourInput.value = '';
                    if (editExtraHourInput) editExtraHourInput.value = '';
                    if (editLateHourInput) editLateHourInput.value = '00:00';
                    if (editShiftTypeInput) editShiftTypeInput.value = 'Day';
                    if (editGraceInput) editGraceInput.value = '-';
                    if (editApprovalInput) editApprovalInput.value = '-';
                    if (editGraceLimitMessage) editGraceLimitMessage.style.display = 'none';
                    if (updateEntryBtn) updateEntryBtn.textContent = 'Save Entry';
                    if (deleteEntryBtn) deleteEntryBtn.style.display = 'none';
                    toggleEditPresentDetails(); // Ensure correct initial state
                }
            }

            function toggleEditPresentDetails() {
                const status = editStatusInput.value;
                const isPresentLike = (status === 'Present' || status === 'Government_Holiday' || status === 'Sick_Leave');
                const currentExtraHourValue = parseFloat(editExtraHourInput ? editExtraHourInput.value : 0) || 0;
                const requiresApproval = (status === 'Sick_Leave' || status === 'Holiday' || status === 'Government_Holiday' || (isPresentLike && (currentExtraHourValue > 0)));

                if (editHourGroup) editHourGroup.style.display = isPresentLike ? 'block' : 'none';
                if (editExtraHourGroup) editExtraHourGroup.style.display = isPresentLike ? 'block' : 'none';
                if (editLateHourGroup) editLateHourGroup.style.display = isPresentLike ? 'block' : 'none';
                if (editShiftTypeGroup) editShiftTypeGroup.style.display = isPresentLike ? 'block' : 'none';
                if (editGraceGroup) editGraceGroup.style.display = (status === 'Present') ? 'block' : 'none'; 
                if (editApprovalGroup) editApprovalGroup.style.display = requiresApproval ? 'block' : 'none';

                if ((status === 'Sick_Leave' || status === 'Government_Holiday') && editHourInput) {
                    if (!editHourInput.value || parseFloat(editHourInput.value) === 0) { 
                        editHourInput.value = 9;
                    }
                    if (editExtraHourInput) editExtraHourInput.value = 0; 
                    if (editLateHourInput) editLateHourInput.value = '00:00'; 
                }
                if (editApprovalInput) { 
                    if (requiresApproval) {
                        if (editApprovalInput.value === '-') { 
                            editApprovalInput.value = 'Approved';
                        }
                    } else {
                         editApprovalInput.value = '-';
                    }
                }
            }

            function handleSaveOrUpdateEntry() {
                const date = editDateInput.value;
                if (!date || !currentLoggedInUser) return;

                const status = editStatusInput.value;
                const monthKey = `${new Date(date).getFullYear()}-${String(new Date(date).getMonth() + 1).padStart(2, '0')}`;
                const existingEntry = currentLoggedInUser.attendance[date];
                const wasPresent = existingEntry && existingEntry.status === 'Present';
                const wasGrace = wasPresent && existingEntry.grace === 'Yes';

                let updatedEntry = { status: status, approval: editApprovalInput.value || '-' };

                if (status === 'Present' || status === 'Government_Holiday' || status === 'Sick_Leave') {
                    const updatedHour = parseFloat(editHourInput.value || 0); 
                    const updatedExtraHour = parseFloat(editExtraHourInput.value || 0); 
                    const updatedShift = editShiftTypeInput.value;
                    const updatedGrace = editGraceInput.value;
                    const updatedLate = calculateLateTime(updatedHour);

                    if (isNaN(updatedHour) || updatedHour < 0 || updatedHour > 24 ||
                        isNaN(updatedExtraHour) || updatedExtraHour < 0 || updatedExtraHour > 24) {
                        showCustomAlert('Input Error', "Please enter valid hour and extra hour values (0-24) for this status.", 'error');
                        return;
                    }

                    const isGraceNow = updatedGrace === 'Yes';
                    if (status === 'Present' && isGraceNow && !wasGrace && checkGraceLimit(monthKey)) {
                        showCustomAlert('Grace Limit Reached', "Cannot apply grace. Monthly limit (5) reached.", 'warning');
                        return;
                    }

                    updatedEntry = {
                        status: status,
                        hour: updatedHour,
                        extraHour: updatedExtraHour,
                        late: updatedLate,
                        shift: updatedShift,
                        grace: updatedGrace,
                        approval: editApprovalInput.value || '-'
                    };

                    // Grace count logic for the current month
                    if (status === 'Present') {
                        if (isGraceNow && !wasGrace) { // New grace entry
                            updateGraceCount(monthKey, 1);
                        } else if (!isGraceNow && wasGrace) { // Grace removed
                            updateGraceCount(monthKey, -1);
                        }
                    } else if (wasPresent && wasGrace) { // Status changed from present-with-grace to non-present
                        updateGraceCount(monthKey, -1);
                    }
                } else { // Non-present status
                    if (wasPresent && wasGrace) { // If original entry was present-with-grace, decrement grace count
                        updateGraceCount(monthKey, -1);
                    }
                    // For non-present statuses, ensure related fields are not saved
                    delete updatedEntry.hour;
                    delete updatedEntry.extraHour;
                    delete updatedEntry.late;
                    delete updatedEntry.shift;
                    delete updatedEntry.grace;
                }

                currentLoggedInUser.attendance = { ...currentLoggedInUser.attendance, [date]: updatedEntry };
                saveCurrentUserData(); 

                showCustomAlert('Entry Saved', 'Attendance entry has been successfully saved!', 'success');
                closeEditDeleteModalFunc();
                displayAttendanceHistory();
            }

            function confirmDeleteEntry() {
                const dateToDelete = editDateInput.value;
                showCustomConfirm('Confirm Deletion', `Are you sure you want to delete ALL data for ${formatDisplayDate(new Date(dateToDelete))}? This action cannot be undone.`, (confirmed) => {
                    if (confirmed) {
                        deleteAttendanceEntry(dateToDelete);
                    }
                });
            }

            function deleteAttendanceEntry(dateToDelete) {
                if (!currentLoggedInUser || !currentLoggedInUser.attendance[dateToDelete]) return;

                const existingEntry = currentLoggedInUser.attendance[dateToDelete];
                const wasPresent = existingEntry && existingEntry.status === 'Present';
                const wasGrace = wasPresent && existingEntry.grace === 'Yes';
                const monthKey = `${new Date(dateToDelete).getFullYear()}-${String(new Date(dateToDelete).getMonth() + 1).padStart(2, '0')}`;

                const updatedAttendance = { ...currentLoggedInUser.attendance };
                delete updatedAttendance[dateToDelete];
                currentLoggedInUser.attendance = updatedAttendance; 
                saveCurrentUserData(); 

                if (wasPresent && wasGrace) {
                    updateGraceCount(monthKey, -1);
                }

                showCustomAlert('Entry Deleted', 'Entry deleted successfully! Data for this date has been cleared.', 'success');
                closeEditDeleteModalFunc();
                displayAttendanceHistory(); 
            }

            // --- History Page Functions ---
            function displayCustomHistorySummary() {
                const startDateStr = historyDateFromInput.value;
                const endDateStr = historyDateToInput.value;

                if (!startDateStr || !endDateStr) {
                    showCustomAlert('Input Error', "Please select both 'From Date' and 'To Date'.", 'warning');
                    if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';
                    return;
                }

                const startDate = new Date(startDateStr + 'T00:00:00');
                const endDate = new Date(endDateStr + 'T00:00:00');

                if (startDate > endDate) {
                    showCustomAlert('Input Error', "'From Date' cannot be after 'To Date'.", 'error');
                    if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';
                    return;
                }

                const currentUserAttendance = currentLoggedInUser.attendance || {};

                let totalHours = 0;
                let totalLateMinutes = 0;
                let totalAbsentDays = 0;
                let totalWeekendDays = 0;
                let totalHolidayDays = 0;
                let totalGovernmentHolidayDays = 0; 
                let totalSickLeaveDays = 0; 
                let totalWorkingDays = 0;
                let totalDayShifts = 0;
                let totalNightShifts = 0;
                let totalGraceDays = 0;
                let totalPresentCount = 0; 

                if (historyAttendanceTableBody) historyAttendanceTableBody.innerHTML = '';

                let currentDate = new Date(startDate);
                while (currentDate.getTime() <= endDate.getTime()) { 
                    const dateKey = formatDate(currentDate);
                    const dayOfWeek = getDayOfWeek(currentDate);
                    const entry = currentUserAttendance[dateKey];

                    const row = historyAttendanceTableBody.insertRow();
                    row.classList.add(`status-${(entry?.status || 'unmarked').toLowerCase()}-row`); 

                    const cellDate = row.insertCell();
                    const cellDay = row.insertCell();
                    const cellStatus = row.insertCell();
                    const cellHour = row.insertCell();
                    const cellExtraHour = row.insertCell();
                    const cellLate = row.insertCell();
                    const cellShift = row.insertCell();
                    const cellGrace = row.insertCell();
                    const cellApproval = row.insertCell(); 

                    cellDate.textContent = formatDisplayDate(currentDate);
                    cellDay.textContent = dayOfWeek;
                    cellStatus.className = '';

                    if (entry && entry.status) {
                        cellStatus.textContent = entry.status.replace(/_/g, ' '); 
                        cellStatus.classList.add(`status-${entry.status.toLowerCase()}`);

                        if (entry.status === 'Present' || entry.status === 'Government_Holiday' || entry.status === 'Sick_Leave') {
                            cellHour.textContent = entry.hour;
                            cellExtraHour.textContent = entry.extraHour;
                            cellLate.textContent = entry.late;
                            cellShift.textContent = entry.shift;
                            cellGrace.textContent = entry.grace || '-';
                            cellApproval.textContent = entry.approval || '-';

                            totalHours += entry.hour + (entry.extraHour || 0);
                            const [lateHours, lateMinutes] = entry.late.split(':').map(Number);
                            totalLateMinutes += (lateHours * 60) + lateMinutes;

                            if (entry.shift === 'Day') totalDayShifts++;
                            else if (entry.shift === 'Night') totalNightShifts++;
                            totalWorkingDays++;
                            if (entry.grace === 'Yes') totalGraceDays++;

                            if (entry.status === 'Government_Holiday') totalGovernmentHolidayDays++;
                            else if (entry.status === 'Sick_Leave') totalSickLeaveDays++;
                            totalPresentCount++; 
                        } else {
                            cellHour.textContent = '-';
                            cellExtraHour.textContent = '-';
                            cellLate.textContent = '-';
                            cellShift.textContent = '-';
                            cellGrace.textContent = '-';
                            cellApproval.textContent = entry.approval || '-';
                            if (entry.status === 'Absent') {
                                totalAbsentDays++;
                                totalWorkingDays++;
                            } else if (entry.status === 'Weekend') {
                                totalWeekendDays++;
                            } else if (entry.status === 'Holiday') {
                                totalHolidayDays++;
                            }
                        }
                    } else {
                        cellStatus.textContent = '-';
                        cellHour.textContent = '-';
                        cellExtraHour.textContent = '-';
                        cellLate.textContent = '-';
                        cellShift.textContent = '-';
                        cellGrace.textContent = '-';
                        cellApproval.textContent = '-';
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                if (historySummaryTotalHours) historySummaryTotalHours.textContent = totalHours;
                const formattedLateTime = `${String(Math.floor(totalLateMinutes / 60)).padStart(2, '0')}:${String(totalLateMinutes % 60).padStart(2, '0')}`;
                if (historySummaryLate) historySummaryLate.textContent = formattedLateTime;
                if (historySummaryAbsent) historySummaryAbsent.textContent = totalAbsentDays;
                if (historySummaryWeekend) historySummaryWeekend.textContent = totalWeekendDays;
                if (historySummaryHoliday) historySummaryHoliday.textContent = totalHolidayDays + totalGovernmentHolidayDays + totalSickLeaveDays;
                if (historySummaryWorkingDays) historySummaryWorkingDays.textContent = totalWorkingDays;
                if (historySummaryDayShifts) historySummaryDayShifts.textContent = totalDayShifts;
                if (historySummaryNightShifts) historySummaryNightShifts.textContent = totalNightShifts;
                if (historySummaryGrace) historySummaryGrace.textContent = totalGraceDays;
                if (historySummaryTotalPresent) historySummaryTotalPresent.textContent = totalPresentCount + totalGovernmentHolidayDays + totalSickLeaveDays + totalWeekendDays + totalHolidayDays;
            }

            // --- Help Modal Functions ---
            function openHelpModal() {
                if (helpModal) {
                    helpModal.style.display = 'flex';
                }
            }

            function closeHelpModalFunc() {
                if (helpModal) {
                    helpModal.style.display = 'none';
                }
            }

            // Initial call
            initializeApp();
        });
    </script>
</body>
</html>
