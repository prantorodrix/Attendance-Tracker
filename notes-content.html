<!DOCTYPE html>
<!-- data-bs-theme="light" ডিফল্ট হিসেবে সেট করা হলো -->
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pranto's Note</title>
    <link rel="icon" type="image/png" href="note.png"> 
    <!-- Google Font: Roboto (index.html থেকে আনা) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* --- index.html থেকে আনা Base & Typography --- */
        :root {
            --bs-body-font-family: 'Roboto', sans-serif;
            --bs-heading-font-family: 'Roboto', sans-serif;
            
            /* --- Light Mode (Translucent Glass) --- */
            --bs-body-bg-light: #f3e7ff; 
            --bs-body-color-light: #212529;
            --bs-tertiary-bg-light: rgba(255, 255, 255, 0.7); 
            --bs-secondary-bg-light: #f8f9fa; 
            --bs-border-color-light: rgba(0, 0, 0, 0.1); 
            
            --bs-glass-bg-light: rgba(255, 255, 255, 0.6); 
            --bs-glass-border-light: var(--bs-border-color-light);
            --bs-card-bg-light: var(--bs-tertiary-bg-light);
            --bs-card-border-light: var(--bs-border-color-light);

            /* --- Dark Mode (Translucent Glass) --- */
            --bs-body-bg-dark: #0a0c10; 
            --bs-body-color-dark: #e0e0e0;
            --bs-tertiary-bg-dark: rgba(22, 27, 34, 0.7); 
            --bs-secondary-bg-dark: #2a2a2a;
            --bs-border-color-dark: rgba(255, 255, 255, 0.1); 
            --bs-light-bg-subtle-dark: #161b22;

            --bs-glass-bg-dark: rgba(10, 12, 16, 0.6); 
            --bs-glass-border-dark: var(--bs-border-color-dark);
            --bs-card-bg-dark: var(--bs-tertiary-bg-dark); /* ডার্ক মোড কার্ডের রঙ */
            --bs-card-border-dark: var(--bs-border-color-dark);

            --bs-primary-dark: #00f0b5;
            --bs-primary-rgb-dark: 0, 240, 181;
        }

        [data-bs-theme="light"] {
            --bs-body-bg: var(--bs-body-bg-light);
            --bs-body-color: var(--bs-body-color-light);
            --bs-tertiary-bg: var(--bs-tertiary-bg-light);
            --bs-secondary-bg: var(--bs-secondary-bg-light);
            --bs-border-color: var(--bs-border-color-light);
            --bs-light-bg-subtle: var(--bs-light-bg-subtle-light);

            --bs-glass-bg: var(--bs-glass-bg-light);
            --bs-glass-border: var(--bs-glass-border-light);
            --bs-card-bg: var(--bs-card-bg-light);
            --bs-card-border: var(--bs-card-border-light);
        }

        [data-bs-theme="dark"] {
            --bs-body-bg: var(--bs-body-bg-dark);
            --bs-body-color: var(--bs-body-color-dark);
            --bs-tertiary-bg: var(--bs-tertiary-bg-dark);
            --bs-secondary-bg: var(--bs-secondary-bg-dark);
            --bs-border-color: var(--bs-border-color-dark);
            --bs-light-bg-subtle: var(--bs-light-bg-subtle-dark);

            --bs-glass-bg: var(--bs-glass-bg-dark);
            --bs-glass-border: var(--bs-glass-border-dark);
            --bs-card-bg: var(--bs-card-bg-dark);
            --bs-card-border: var(--bs-border-color-dark);

            --bs-primary: var(--bs-primary-dark);
            --bs-primary-rgb: var(--bs-primary-rgb-dark);
            --bs-link-color: var(--bs-primary-dark);
            --bs-link-color-rgb: var(--bs-primary-rgb-dark);
            --bs-link-hover-color: #33ffc7;
        }

        body {
            font-family: var(--bs-body-font-family); /* Roboto ফন্ট ব্যবহার করা হলো */
            background-color: transparent; /* অ্যানিমেটেড ব্যাকগ্রাউন্ড দেখানোর জন্য */
            transition: background-color 0.3s ease;
        }
        
        /* --- index.html থেকে আনা Animated Background --- */
        #animated-bg-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: -10; 
            overflow: hidden;
        }
        .bg-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(20px); 
            -webkit-filter: blur(20px);
            opacity: 0;
            transition: opacity 1.5s ease-in-out; 
            transform: scale(1.1); 
        }
        .bg-image.active {
            opacity: 1;
        }

        /* Light Theme Images */
        [data-bs-theme="light"] .bg-image-light.bg-1 { background-image: url('https://cdn.pixabay.com/photo/2024/11/02/05/13/winter-9168141_1280.jpg'); }
        [data-bs-theme="light"] .bg-image-light.bg-2 { background-image: url('https://cdn.pixabay.com/photo/2024/11/02/05/13/winter-9168141_1280.jpg'); }
        [data-bs-theme="light"] .bg-image-light.bg-3 { background-image: url('https://cdn.pixabay.com/photo/2024/11/02/05/13/winter-9168141_1280.jpg'); }
        
        /* Dark Theme Images */
        [data-bs-theme="dark"] .bg-image-dark.bg-1 { background-image: url('https://cdn.pixabay.com/photo/2021/01/10/18/01/milky-way-5905903_1280.jpg'); }
        [data-bs-theme="dark"] .bg-image-dark.bg-2 { background-image: url('https://cdn.pixabay.com/photo/2021/01/10/18/01/milky-way-5905903_1280.jpg'); }
        [data-bs-theme="dark"] .bg-image-dark.bg-3 { background-image: url('https://cdn.pixabay.com/photo/2021/01/10/18/01/milky-way-5905903_1280.jpg'); }

        [data-bs-theme="light"] .bg-image-dark { display: none; }
        [data-bs-theme="dark"] .bg-image-light { display: none; }
        
        h1, h2, h3, h4, h5, h6, .fw-bold {
            font-family: var(--bs-heading-font-family);
            font-weight: 700;
        }

        /* --- index.html থেকে আনা Glass Card Style --- */
        .card {
            background-color: var(--bs-card-bg);
            border: 1px solid var(--bs-card-border);
            border-radius: 1.5rem; /* More rounded */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
        }
        
        [data-bs-theme="dark"] .card {
             box-shadow: none;
             border-radius: 0.75rem; /* Less rounded for tech look */
        }

        /* --- notes-content.txt থেকে আনা Tool Styles (UI Kit) --- */
        
        /* Input/Textarea গুলোকে Glass UI এর সাথে মানানসই করা */
        .form-control, .form-select {
            background-color: var(--bs-tertiary-bg);
            color: var(--bs-body-color);
            border: 1px solid var(--bs-border-color);
            border-radius: 10px;
            margin-top: 3px;
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--bs-tertiary-bg);
            color: var(--bs-body-color);
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 3px rgba(var(--bs-primary-rgb), 0.2);
        }

        /* === NEW: EOB Result Customization === */
        .eob-result-container {
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .eob-result-col {
            flex-basis: 48%;
            display: flex;
            flex-direction: column;
        }
        .eob-result-col.single {
            flex-basis: 100%;
            align-items: flex-end; /* Show on the right */
        }
        .eob-result-col .header {
            font-size: 0.8rem;
            font-weight: bold;
            color: var(--bs-secondary-color);
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .eob-result-value {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--bs-body-color);
            margin-bottom: 8px;
            min-height: 28px; /* Ensure alignment */
            width: 160px;
        }
         .eob-result-value.currency {
            color: #28a745;
         }
        .facility-truncate {
            max-width: 100%; /* Fill column but not overflow */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .eob-results-card .card-body {
            padding: 1rem 1.25rem;
        }
        /* === END: EOB Result Customization === */

        /* Legacy result-list (for note adjustment section) */
        .result-list {
            font-size: 0.9rem; 
        }
        .result-list p {
            margin-bottom: 0.5rem; 
            border-bottom: 1px solid var(--bs-border-color); /* Updated Border */
            padding-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            white-space: nowrap; 
        }
         .result-list p:last-child {
            border-bottom: none;
            margin-bottom: 0;
         }
        .result-list strong {
            color: var(--bs-body-color); /* Updated Text Color */
            margin-right: 10px;
        }
        .result-list .output-value {
            font-weight: bold;
            color: #28a745;
            text-align: right;
        }
        .result-list .output-value.text-dark {
             color: var(--bs-body-color) !important; /* Updated Text Color */
        }


        /* টেবিল স্টাইল Glass UI এর সাথে মানানসই করা */
        .result-table {
            font-size: 0.9rem; 
        }
        .result-table th, .result-table td {
            vertical-align: middle;
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            white-space: normal; /* Changed from nowrap to normal */
            border-color: var(--bs-border-color); /* Updated Border */
            color: var(--bs-body-color); /* Updated Text Color */
        }
        .result-table thead th { 
            background-color: var(--bs-secondary-bg); /* Updated Header BG */
            text-align: left;
            position: sticky; /* Make header sticky */
            top: 0; /* Stick to top */
            z-index: 10; /* Ensure it's above body */
        }
         .result-table tbody th {
            font-weight: bold;
            color: var(--bs-body-color);
            text-align: left;
         }
         .result-table td {
            font-weight: bold;
            color: var(--bs-body-color);
            text-align: left; 
         }
        .result-table .output-value-amount {
            color: #28a745;
        }
        /* NEW: Truncate Mediator */
        .truncate-mediator {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        textarea {
            font-family: monospace;
            min-height: 150px; /* Reduced default min-height */
        }
        
        .idr-textarea {
             min-height: 80px; /* Reduced height */
        }
        
        /* Comparison BG Colors (এগুলো ঠিক আছে) */
        .bg-match { 
            background-color: rgb(100 251 137 / 70%) !important; /* light green */
            color: #0f5132 !important;
            border-radius: 5px;
        }
        .bg-mismatch { 
            background-color: rgb(255 114 127 / 70%) !important; /* light red */
            color: #842029 !important;
            border-radius: 5px;
        }
        .bg-overpaid { 
            background-color: rgba(255, 243, 205, 0.7) !important; /* light yellow */
            color: #664d03 !important;
            border-radius: 5px;
        }
        
        /* ডার্ক মোডে Comparison কালার */
        [data-bs-theme="dark"] .bg-match { 
            background-color: rgba(13, 26, 18, 0.8) !important;
            color: #34c356 !important;
        }
        [data-bs-theme="dark"] .bg-mismatch { 
            background-color: rgba(43, 17, 20, 0.8) !important;
            color: #ea5462 !important;
        }
        [data-bs-theme="dark"] .bg-overpaid { 
            background-color: rgba(36, 28, 10, 0.8) !important;
            color: #ffca2c !important;
        }

        /* NEW: Green success warning for email */
        [data-bs-theme="light"] .form-control.bg-match.text-success {
            background-color: #d1e7dd !important;
            color: #0f5132 !important;
        }
        [data-bs-theme="dark"] .form-control.bg-match.text-success {
            background-color: #0a2614 !important;
            color: #34c356 !important;
        }

        /* NEW: Red error message div */
        .error-message {
            color: #dc3545;
            font-weight: bold;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .result-list .output-value.bg-match,
        .result-list .output-value.bg-mismatch,
        .result-list .output-value.bg-overpaid {
             padding: 2px 6px;
        }
        
        .editable-input {
            width: 100px;
            background-color: var(--bs-tertiary-bg); /* Updated */
            color: var(--bs-body-color); /* Updated */
            border: 1px solid var(--bs-border-color); /* Updated */
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
        }
        .editable-input:disabled {
            background-color: var(--bs-secondary-bg);
            border-color: var(--bs-border-color);
        }
        
        @keyframes shake-red {
            0% { transform: translateX(0); box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25); }
            25% { transform: translateX(5px); }
            50% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
            100% { transform: translateX(0); box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0); }
        }
        .is-invalid {
            border-color: #dc3545;
        }
        .form-control.is-invalid, .form-select.is-invalid {
             border-color: #dc3545;
             animation: shake-red 0.5s ease-out;
        }
        /* --- Footer --- */
        #main-footer {
            /* NEW: Minimized Footer Style */
            padding: 1.5rem 1rem;
            margin-top: 3rem;
            color: var(--bs-secondary-color);
            text-align: center;
            font-size: 0.9rem;
        }
        #main-footer p {
            margin-bottom: 0.25rem;
        }
        #main-footer a {
            color: var(--bs-primary);
            text-decoration: none;
            font-weight: 600;
        }
        #main-footer a:hover {
            text-decoration: underline;
        }


        
        /* Sticky Column CSS (REMOVED) */
        
        #note_Text, #note_Mail_Text, #mail_Note_Text {
            min-height: 200px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        /* Accordion Button Style (REMOVED) */
        
        /* --- NEW: Tab Navigation Styles --- */
        .nav-tabs-glass {
            border-bottom: 1px solid var(--bs-border-color);
            display: flex;
            margin-bottom: 1.5rem;
        }
        .nav-tabs-glass .nav-link {
            font-family: var(--bs-heading-font-family);
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--bs-secondary-color);
            border: none;
            border-radius: 0.75rem 0.75rem 0 0; /* Rounded top corners */
            padding: 0.75rem 1.5rem;
            margin-right: 0.5rem;
            transition: all 0.2s ease-out;
            background-color: transparent;
        }
        
        /* Non-active tab hover */
        .nav-tabs-glass .nav-link:hover:not(.active) {
            color: var(--bs-body-color);
            background-color: rgba(128, 128, 128, 0.1);
        }

        /* Active tab */
        .nav-tabs-glass .nav-link.active {
            color: var(--bs-body-color);
            /* Glass Card background */
            background-color: var(--bs-card-bg);
            border: 1px solid var(--bs-card-border);
            border-bottom: 1px solid var(--bs-card-bg); /* Hide bottom border */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            position: relative;
            top: 1px; /* Overlap the border-bottom */
        }
        
        [data-bs-theme="dark"] .nav-tabs-glass .nav-link.active {
             color: var(--bs-primary-dark);
        }

        /* Tab Content */
        .tab-content-glass {
            /* Main content area uses Glass Card style */
            background-color: var(--bs-card-bg);
            border: 1px solid var(--bs-card-border);
            border-radius: 1.5rem;
            /* Match active tab's top radius */
            border-top-left-radius: 0; 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            padding: 1.5rem;
        }
        /* --- END: Tab Navigation Styles --- */


        .form-control[readonly].copyable {
            cursor: pointer;
            background-color: var(--bs-secondary-bg);
        }
        [data-bs-theme="light"] .form-control[readonly].copyable:hover {
            background-color: #e9ecef;
        }
        [data-bs-theme="dark"] .form-control[readonly].copyable:hover {
            background-color: #3a3a3a;
        }
        
        /* --- index.html থেকে আনা Theme Toggle Button --- */
        #theme-toggle-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1030;
        }
        .btn-theme-toggle {
            background-color: var(--bs-glass-bg);
            border: 1px solid var(--bs-glass-border);
            color: var(--bs-secondary-color);
            font-weight: 600;
            transition: all 0.2s ease;
            border-radius: 13px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        [data-bs-theme="light"] .btn-theme-toggle {
            color: #495057;
        }
        .btn-theme-toggle:hover {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
            color: #fff;
            box-shadow: 0 4px 12px rgba(var(--bs-primary-rgb), 0.3);
        }
        [data-bs-theme="dark"] .btn-theme-toggle {
            color: var(--bs-body-color-dark);
        }
        [data-bs-theme="dark"] .btn-theme-toggle:hover {
            background-color: var(--bs-primary-dark);
            border-color: var(--bs-primary-dark);
            color: #000;
            box-shadow: 0 4px 12px rgba(var(--bs-primary-rgb-dark), 0.3);
        }
        
        /* --- NEW: Sticky Scroll Animation Styles --- */
        
        /* Main container for the whole tool */
        #idr-notes-section {
            position: relative;
        }

        /* Top Bar (Buttons) */
        #top-bar {
            /* This is already sticky, which is good. */
            top: 1rem; 
            z-index: 1030; 
        }

        /* EOB Input Row */
        #eob-input-row {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, height 0.3s ease-out, margin 0.3s ease-out, padding 0.3s ease-out;
            opacity: 1;
            transform: translateY(0);
            height: auto; /* Or specific height */
            overflow: hidden;
            margin-top: 1rem;
        }

        /* Sticky EOB Header (Initially Hidden) */
        #sticky-eob-header {
            visibility: hidden;
            opacity: 0;
            height: 0;
            position: sticky;
            /* Top value = top-bar height + its margin-top */
            top: calc(58px + 1rem); /* 58px approx height + 1rem margin */
            z-index: 1020;
            transition: all 0.3s ease-out;
            
            /* Glass UI */
            background-color: var(--bs-card-bg);
            border: 1px solid var(--bs-card-border);
            border-radius: 1.5rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            padding: 0 1.5rem; /* Padding set to 0 top/bottom */
            margin-top: 0; /* No margin when hidden */
            
            /* Gradient Animation */
            background-image: linear-gradient(120deg, var(--bs-tertiary-bg), var(--bs-secondary-bg), var(--bs-tertiary-bg));
            background-size: 200% 200%;
            animation: gradient-flow 8s ease infinite;
        }
        [data-bs-theme="dark"] #sticky-eob-header {
            animation: gradient-flow-dark 8s ease infinite;
             background-image: linear-gradient(120deg, var(--bs-tertiary-bg-dark), #1c222b, var(--bs-tertiary-bg-dark));
        }

        /* IDR Table Container - MODIFIED */
        #idr-table-container {
            position: relative; /* No longer sticky */
            z-index: 1019;
            transition: all 0.3s ease-out;
            margin-top: 0.75rem; /* Added margin top */
        }
        
        /* IDR Table Gradient BG */
        #idr-table-container .card {
             background-image: linear-gradient(120deg, var(--bs-card-bg), var(--bs-tertiary-bg), var(--bs-card-bg));
             background-size: 200% 200%;
             animation: gradient-flow 10s ease infinite;
        }
        [data-bs-theme="dark"] #idr-table-container .card {
            animation: gradient-flow-dark 10s ease infinite;
             background-image: linear-gradient(120deg, var(--bs-card-bg-dark), #1a2029, var(--bs-card-bg-dark));
        }
        
        /* Gradient Animation Keyframes */
        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes gradient-flow-dark {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }


        /* The "Active" state, triggered by JS */
        body.sticky-active #eob-input-row {
            opacity: 0;
            height: 0;
            transform: translateY(-20px);
            margin: 0 !important; /* Force no margin */
            padding: 0;
            visibility: hidden;
        }
        
        body.sticky-active #sticky-eob-header {
            visibility: visible;
            opacity: 1;
            height: auto; /* Auto height based on content */
            padding: 0.75rem 1.5rem; /* Add padding back */
            margin-top: 0.75rem; /* Add margin back */
        }
        
        /* Sticky EOB Header Content Styling (MODIFIED) */
        .sticky-eob-row {
            border-bottom: 1px solid var(--bs-border-color);
            padding: 0.5rem 0;
        }
        .sticky-eob-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .sticky-eob-row:first-child {
            padding-top: 0;
        }
        .sticky-eob-label {
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--bs-secondary-color);
            text-transform: uppercase;
        }
        .sticky-eob-value {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--bs-body-color);
            white-space: nowrap;
        }
        .sticky-eob-value.currency {
            color: #28a745;
        }


    </style>
</head>
<body>

    <!-- ======== index.html থেকে আনা Animated BG Container ======== -->
    <div id="animated-bg-container">
        <!-- Light Theme Images -->
        <div class="bg-image bg-image-light bg-1 active"></div>
        <div class="bg-image bg-image-light bg-2"></div>
        <div class="bg-image bg-image-light bg-3"></div>
        <!-- Dark Theme Images -->
        <div class="bg-image bg-image-dark bg-1"></div>
        <div class="bg-image bg-image-dark bg-2"></div>
        <div class="bg-image bg-image-dark bg-3"></div>
    </div>

    <!-- ======== index.html থেকে আনা Theme Toggle Button ======== -->
    <!-- NEW: Top Bar -->
    <div class="container-fluid px-4">
        <div id="top-bar" class="row sticky-top" style="
            font-family:'Poppins',sans-serif; font-weight:600;
            padding: 8px 15px;
            margin-top: 1rem;
            border-radius:10px;
            display:flex; justify-content:space-between; align-items:center;
            background:rgba(255,255,255,0.05); backdrop-filter:blur(8px);
            border:1px solid rgba(255,255,255,0.1);
            box-shadow:0 4px 15px rgba(0,0,0,0.1); color:#fff;
            font-size:14px;
            z-index: 1030;
            ">
            <!-- This div is the trigger for the intersection observer -->
            <div id="scroll-trigger" style="position: absolute; top: 0; left: 0; height: 1px; width: 1px;"></div>
            
            <div class="col-auto" style="flex-shrink: 0;">
                Made by
                <span style="
                    background:linear-gradient(90deg,#06b6d4 0%, #a855f7 50%, #ec4899 100%);
                    -webkit-background-clip:text; background-clip:text; color:transparent;
                    text-shadow:0 0 6px rgba(168,85,247,0.4);
                    font-weight:700;">
                    Pranto Rodrix
                </span>
            </div>

            <div class="col-auto d-flex align-items-center gap-2">
                
                <button type="button" class="btn btn-primary btn-lg rounded-pill" id="processButton" 
                        style="padding: 4px 8px; font-size: 13px; font-weight: 600; white-space: nowrap;">
                    <i class="bi bi-magic"></i> Extract
                </button>
                <button type="button" class="btn btn-outline-danger btn-lg rounded-pill" id="clearButton" 
                        style="padding: 4px 8px; font-size: 13px; font-weight: 600; white-space: nowrap;">
                    <i class="bi bi-x-lg"></i> Clear
                </button>

                <a href="index.html"
                    onclick="window.open(this.href, '_self'); return false;"
                    style="
                    display: inline-flex; align-items: center; text-decoration: none;
                    padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 13px;
                    white-space: nowrap; cursor: pointer; transition: all 0.2s ease;
                    background: rgba(255, 255, 255, 0.15);
                    color: #fff;
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                    text-shadow: 0 0 2px rgba(0,0,0,0.8);
                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'; this.style.transform='translateY(-1px)'"
                    onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'; this.style.transform='translateY(0)'">
                    
                    <span style="margin-right: 4px; font-size: 16px;">&#x2190;</span>
                    Main Page
                </a>

                <!-- Theme Toggle Button moved inside -->
                <button id="theme-toggle" class="btn btn-theme-toggle d-flex align-items-center justify-content-center px-3 py-1" style="font-size: 13px;">
                    <i id="theme-icon" class="bi bi-sun-fill me-2"></i>
                    <span id="theme-text" class="fw-medium"></span>
                </button>
            </div>
        </div>
    </div>


    <!-- ======== notes-content.txt থেকে আনা Tool Content ======== -->
    <!-- Glass UI এর সাথে মানানসই করার জন্য container-fluid ব্যবহার করা হলো -->
    <div id="dashboard-page" class="container-fluid eob-content my-3 px-4">
        
        <!-- ======== NEW: Sticky EOB Header (Initially Hidden) ======== -->
        <div id="sticky-eob-header">
            <!-- Content will be added by JS -->
            <div id="sticky-eob-content"></div>
        </div>
        <!-- ======== End Sticky EOB Header ======== -->


        <!-- NEW: 3-Column EOB Layout, Glass Card ব্যবহার করা হয়েছে -->
        <div class="row g-3" id="eob-input-row"> <!-- ID added for animation -->
            
            <!-- Column 1: Input Area -->
            <div class="col-lg-4">
                <!-- Section 1: Input Card (Glass UI) -->
                <div class="card p-3 h-100 d-flex flex-column">
                    <!-- Updated EOB Input -->
                    <div class="mb-3 flex-grow-1 d-flex flex-column">
                        <!--<label for="eobUpdatedInput" class="form-label fw-bold">Updated EOB:</label>-->
                        <textarea class="form-control h-100" id="eobUpdatedInput" 
                                  placeholder="Update EOB."></textarea>
                    </div>
                    <!-- Old EOB Input -->
                    <div class="flex-grow-1 d-flex flex-column">
                        <!--<label for="eobOldInput" class="form-label fw-bold">Old EOB:</label>-->
                        <textarea class="form-control h-100" id="eobOldInput" 
                                  placeholder="1st/Old EOB"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Column 2: EOB Output Area 1 -->
            <div class="col-lg-4">
                 <!-- EOB Output Card 1 (Glass UI) -->
                <div class="card p-3 h-100 eob-results-card">
                    <div class="card-body">
                        <!--<h5 class="text-success fw-bold">EOB Result 1</h5>-->
                        <!--<hr style="border-color: var(--bs-border-color);">-->
                        <div id="eob-results-list-1" class="eob-result-container">
                            <!-- JS will populate this -->
                        </div>
                        <div id="eob-errors-1" class="error-message"></div>
                    </div>
                </div>
            </div>
            
            <!-- Column 3: EOB Output Area 2 -->
            <div class="col-lg-4">
                 <!-- EOB Output Card 2 (Glass UI) -->
                <div class="card p-3 h-100 eob-results-card">
                    <div class="card-body">
                        <!--<h5 class="text-success fw-bold">EOB Result 2</h5>-->
                        <!--<hr style="border-color: var(--bs-border-color);">-->
                        <div id="eob-results-list-2" class="eob-result-container">
                            <!-- JS will populate this -->
                        </div>
                        <div id="eob-errors-2" class="error-message"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden row for global calculation results (for matching logic) -->
        <div class="d-none">
            <span id="eob_Ticket"></span>
            <span id="eob_AddlPaid"></span>
        </div>
        
        <!-- IDR Section Rows (Glass UI) -->
        <div class="row g-3 mt-2"> <!-- Reduced mt-3 to mt-2 -->
            
            <!-- NEW: Single IDR Input Card -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-3"> <!-- Reduced padding -->
                        <h5 class="text-primary fw-bold mb-2">IDR Inputs</h5>
                        <div class="row g-2"> <!-- Reduced g-3 to g-2 -->
                            <!-- Column 1: 2024+ -->
                            <div class="col-md-6">
                                <!--<h6 class="text-muted">2024+</h6>-->
                                <div class="row">
                                <div class="col-md-6">
                                  <!--<label for="idrTextInput1" class="form-label fw-bold mb-1">IDR Text 1:</label>-->
                                  <textarea class="form-control idr-textarea" id="idrTextInput1" rows="2" placeholder="2024+ 1"></textarea>
                                  <!--<label for="idrTextInput2" class="form-label fw-bold mt-2 mb-1">IDR Text 2:</label>-->
                                  <textarea class="form-control idr-textarea" id="idrTextInput2" rows="2" placeholder="2024+ 2"></textarea>
                                </div>
                                <div class="col-md-6">
                                  <!--<label for="idrTextInput3" class="form-label fw-bold mt-2 mb-1">IDR Text 3:</label>-->
                                  <textarea class="form-control idr-textarea" id="idrTextInput3" rows="2" placeholder="2024+ 3"></textarea>
                                  <!--<label for="idrTextInput4" class="form-label fw-bold mt-2 mb-1">IDR Text 4:</label>-->
                                  <textarea class="form-control idr-textarea" id="idrTextInput4" rows="2" placeholder="2024+ 4"></textarea>
                                </div>
                                </div>
                            </div>
                            <!-- Column 2: 2022-23 -->
                            <div class="col-md-6">
                                <!--<h6 class="text-muted">2022-23</h6>-->
                                  <div class="row">
                                    <div class="col-md-6">
                                      <!--<label for="idr2022TextInput1" class="form-label fw-bold mb-1">IDR Text 1 (22-23):</label>-->
                                      <textarea class="form-control idr-textarea" id="idr2022TextInput1" rows="2" placeholder="2022-23 1"></textarea>
                                      <!--<label for="idr2022TextInput2" class="form-label fw-bold mt-2 mb-1">IDR Text 2 (22-23):</label>-->
                                      <textarea class="form-control idr-textarea" id="idr2022TextInput2" rows="2" placeholder="2022-23 2"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                      <!--<label for="idr2022TextInput3" class="form-label fw-bold mt-2 mb-1">IDR Text 3 (22-23):</label>-->
                                <textarea class="form-control idr-textarea" id="idr2022TextInput3" rows="2" placeholder="2022-23 3"></textarea>
                                      <!--<label for="idr2022TextInput4" class="form-label fw-bold mt-2 mb-1">IDR Text 4 (22-23):</label>-->
                                      <textarea class="form-control idr-textarea" id="idr2022TextInput4" rows="2" placeholder="2022-23 4"></textarea>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- IDR Output Card (Glass UI) -->
            <!-- ======== NEW: IDR Table Container (for sticky) ======== -->
            <div class="col-12" id="idr-table-container"> <!-- MODIFIED: mt-2 removed -->
                 <div class="card p-4">
                     <h5 class="text-primary fw-bold">IDR Results</h5>
                     <hr style="border-color: var(--bs-border-color);">
                     <div class="table-responsive" style="max-height: 500px; overflow-y: auto;"> <!-- Added max-height -->
                        <!-- টেবিলকে ডার্ক মোডের সাথে মানানসই করা হয়েছে -->
                        <table class="table table-borderless result-table" id="idrResultTable">
                            <thead id="idrDataTableHeader">
                                <!-- NEW: Column widths set via CSS -->
                                <tr class="">
                                    <th scope="col" style="min-width: 80px;">Result #</th>
                                    <th scope="col" style="min-width: 110px;">Ticket #</th>
                                    <th scope="col" style="min-width: 110px;">IDR #</th>
                                    <th scope="col" style="min-width: 120px;">Claim #</th>
                                    <th scope="col" style="min-width: 70px;">CPT</th>
                                    <th scope="col" style="min-width: 100px;">Initial Pmt</th>
                                    <th scope="col" style="min-width: 120px;">Mediator</th>
                                    <th scope="col" style="min-width: 110px;">Determ. Date</th>
                                    <th scope="col" style="min-width: 100px;">Determ. W/L</th> 
                                    <th scope="col" style="min-width: 100px;">Addl. Pmt</th>
                                    <th scope="col" style="min-width: 110px;">Pmt Date</th>
                                    <th scope="col" style="min-width: 100px;">Fee Refund</th>
                                    <th scope="col" style="min-width: 120px;">Fee Refund Date</th>
                                    <th scope="col" style="min-width: 110px;">W/L (Manual)</th>
                                    <th scope="col" style="min-width: 100px;">Additional</th>
                                    <th scope="col" style="min-width: 100px;">Refund</th>
                                </tr>
                            </thead>
                            <tbody id="idrDataTableBody">
                                <!-- Body generated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div id="idr-errors" class="error-message"></div>
                 </div>
            </div>

            <!-- ======== NEW: Tab Navigation Section ======== -->
            <div class="col-12 mt-3">
                <!-- Tab Headers -->
                <ul class="nav nav-tabs-glass" id="noteTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="correspondence-tab" data-bs-toggle="tab" data-bs-target="#correspondence-pane" type="button" role="tab" aria-controls="correspondence-pane" aria-selected="true">
                            <i class="bi bi-pencil-square me-2"></i>Correspondence
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email-pane" type="button" role="tab" aria-controls="email-pane" aria-selected="false">
                            <i class="bi bi-envelope-at me-2"></i>Email
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="noteTabContent">
                    <!-- Correspondence Pane -->
                    <div class="tab-pane fade show active" id="correspondence-pane" role="tabpanel" aria-labelledby="correspondence-tab" tabindex="0">
                        <!-- Content from old accordion -->
                        <div class="tab-content-glass">
                            <div class="row g-3">
                                <div class="col-3">
                                    <label for="note_Name" class="form-label fw-bold">Name:</label>
                                    <input type="text" class="form-control" id="note_Name" value="PRANTO R">
                                    <label for="note_Initial" class="form-label fw-bold mt-2">Initial:</label>
                                    <input type="text" class="form-control" id="note_Initial">
                                    
                                    <div id="finalReviewAdjustments" class="mt-2" style="display: none;">
                                        <h6 class="text-decoration-underline" style="font-size: 0.9rem;">Adjustments:</h6>
                                        <p class="mb-1 result-list" style="font-size: 0.85rem;"><strong>Adjust with PT:</strong> <span id="adjustWithPt" class="output-value">--</span></p>
                                        <p class="mb-0 result-list" style="font-size: 0.85rem;"><strong>Adjust Without PT:</strong> <span id="adjustWithoutPt" class="output-value">--</span></p>
                                    </div>
                                    
                                    <div id="note_Warning_NoEOB" class="text-danger fw-bold mt-2" style="font-size: 0.9rem; display: none;">No EOB Found.</div>
                                    <div id="note_Warning_ClaimMismatch" class="text-danger fw-bold mt-2" style="font-size: 0.9rem; display: none;">IDR Claim numbers Didn't Match..</div>
                                </div>
                                <div class="col-7">
                                    <label for="note_Text" class="form-label fw-bold">Correspondence Note: (Click to Copy)</label>
                                    <textarea class="form-control copyable" id="note_Text" rows="10" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Note')"></textarea>
                                </div>
                                <div class="col-2 d-flex flex-column justify-content-end">
                                     <button class="btn btn-info rounded-pill w-100 mb-2" id="note_GenerateBtn">
                                         <i class="bi bi-pencil-square"></i> Generate Note
                                     </button>
                                     <button class="btn btn-secondary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#noteTemplateModal">
                                        <i class="bi bi-pencil"></i> Edit Note
                                    </button>
                                     <span id="copy_Confirmation_Note" class="text-success text-center fw-bold mt-1" style="display: none;">Copied!</span>
                                     <button class="btn btn-outline-secondary rounded-pill w-100 mt-2" id="note_ClearBtn">
                                         <i class="bi bi-x-circle"></i> Clear Note
                                     </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Email Pane -->
                    <div class="tab-pane fade" id="email-pane" role="tabpanel" aria-labelledby="email-tab" tabindex="0">
                        <!-- Content from old accordion -->
                        <div class="tab-content-glass">
                            <!-- Row for Inputs -->
                            <div class="row g-3 mb-3">
                                <div class="col-3">
                                    <label for="note_Mail_Name" class="form-label fw-bold">My Name:</label>
                                    <input type="text" class="form-control" id="note_Mail_Name" value="Pranto Rodrix">
                                    <label for="note_Mail_Initial" class="form-label fw-bold mt-2">My Initial:</label>
                                    <input type="text" class="form-control" id="note_Mail_Initial" value="PRANTO R">
                                </div>
                                <div class="col-3">
                                    <label for="note_Mail_To" class="form-label fw-bold">To: (Click to copy)</label>
                                    <input type="email" class="form-control copyable" id="note_Mail_To" value="nsa.disputes@bcbstx.com" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Mail')">
                                    <label for="note_Mail_CC" class="form-label fw-bold mt-2">CC: (Click to copy)</label>
                                    <input type="email" class="form-control copyable" id="note_Mail_CC" value="mislam@roundtmc.com, razo@leverngear.com" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Mail')">
                                </div>
                                <div class="col-4">
                                    <label for="note_Mail_Subject" class="form-label fw-bold">Subject: (Click to Copy)</label>
                                    <input type="text" class="form-control copyable" id="note_Mail_Subject" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Mail')">
                                    
                                    <label for="note_Mail_Determ_Date" class="form-label fw-bold mt-2">Determination Date:</label>
                                    <input type="text" class="form-control" id="note_Mail_Determ_Date" placeholder="Auto-fills from IDR Result 1">
                                </div>
                                <div class="col-2">
                                    <label for="note_Mail_Type" class="form-label fw-bold">Email Type:</label>
                                    <select class="form-select" id="note_Mail_Type">
                                        <option value="" selected>Select...</option>
                                        <option value="1st Email">1st Email</option>
                                        <option value="2nd Email">2nd Email</option>
                                    </select>
                                     <button class="btn btn-secondary w-100 mt-2" data-bs-toggle="modal" data-bs-target="#emailTemplateModal">
                                        <i class="bi bi-pencil"></i> Edit Template
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Row for Mail Body, Note, and Buttons -->
                            <div class="row g-3">
                                <!-- Mail Body -->
                                <div class="col-6">
                                    <label for="note_Mail_Text" class="form-label fw-bold">Mail Body: (Click to Copy)</label>
                                    <textarea class="form-control copyable" id="note_Mail_Text" rows="10" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Mail')"></textarea>
                                </div>
                                 <!-- Email Note -->
                                <div class="col-4">
                                    <label for="mail_Note_Text" class="form-label fw-bold">Note for Email: (Click to Copy)</label>
                                    <textarea class="form-control copyable" id="mail_Note_Text" rows="10" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Mail')"></textarea>
                                </div>
                                <!-- Mail Buttons -->
                                <div class="col-2 d-flex flex-column justify-content-start">
                                     <button class="btn btn-info rounded-pill w-100 mb-2" id="note_Mail_GenerateBtn">
                                         <i class="bi bi-pencil-square"></i> Generate
                                     </button>
                                     <span id="copy_Confirmation_Mail" class="text-success text-center fw-bold mt-1 mb-2" style="display: none;">Copied!</span>
                                     <button class="btn btn-outline-secondary rounded-pill w-100" id="note_Mail_ClearBtn">
                                         <i class="bi bi-x-circle"></i> Clear
                                     </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ======== END: Tab Navigation Section ======== -->

        </div>

    </div>
    
    <!-- Email Edit Modal (Glass UI) -->
    <div class="modal fade" id="emailTemplateModal" tabindex="-1" aria-labelledby="emailTemplateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <!-- Glass Modal Content -->
            <div class="modal-content" style="background-color: var(--bs-glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--bs-glass-border);">
                <div class="modal-header" style="border-bottom-color: var(--bs-border-color);">
                    <h5 class="modal-title" id="emailTemplateModalLabel">Edit Email Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Edit the template below. The placeholders like [CLAIM_NUMBER] will be filled automatically.</p>
                    <textarea id="email_Template_Text" class="form-control" rows="20"></textarea>
                </div>
                <div class="modal-footer" style="border-top-color: var(--bs-border-color);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveEmailTemplateBtn">Save Template</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ======== NEW: Correspondence Note Edit Modal ======== -->
    <div class="modal fade" id="noteTemplateModal" tabindex="-1" aria-labelledby="noteTemplateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background-color: var(--bs-glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--bs-glass-border);">
                <div class="modal-header" style="border-bottom-color: var(--bs-border-color);">
                    <h5 class="modal-title" id="noteTemplateModalLabel">Edit Correspondence Note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Edit the generated note below. The original note will be updated when you save.</p>
                    <textarea id="note_Edit_Text" class="form-control" rows="15"></textarea>
                </div>
                <div class="modal-footer" style="border-top-color: var(--bs-border-color);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="copyEditedNoteBtn">Copy & Close</button>
                    <button type="button" class="btn btn-primary" id="saveNoteTemplateBtn">Save & Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- ======== End Note Edit Modal ======== -->


    <!--Footer Section-->
    <!-- NEW: Minimized Footer -->
    <footer id="main-footer">
        <p class="mb-0">Made by <a href="https://www.facebook.com/pranto.anthony1/" target="black" title="Facebook">@PrantoRodrix</a></p>
        <p class="mb-0">&copy; <span id="footer-year">2025</span> My Portfolio. All rights reserved.</p>
    </footer>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Page Navigation & EOB Logic Script -->
    <script>
        // --- DOM Elements ---
        const htmlEl = document.documentElement;
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const themeText = document.getElementById('theme-text');

        // --- index.html থেকে আনা Theme Toggle Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            updateAnimatedBackground(); // ইনিশিয়াল ব্যাকগ্রাউন্ড সেট
            
            // Set footer year
            document.getElementById('footer-year').textContent = new Date().getFullYear();
            
            // NEW: Setup Sticky Scroll
            // MODIFIED: Run on window.onload
            window.onload = () => {
                setupStickyScroll();
            };
            
            // NEW: Setup Note Edit Modal
            setupNoteEditModal();
        });

        themeToggle.addEventListener('click', () => {
            const newTheme = htmlEl.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        });

        function setTheme(theme) {
            htmlEl.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            if (theme === 'dark') {
                themeIcon.classList.remove('bi-sun-fill');
                themeIcon.classList.add('bi-moon-fill');
                themeText.textContent = '';
            } else {
                themeIcon.classList.remove('bi-moon-fill');
                themeIcon.classList.add('bi-sun-fill');
                themeText.textContent = '';
            }
            updateAnimatedBackground(); // থিম চেঞ্জ হলে ব্যাকগ্রাউন্ড আপডেট
        }

        // --- index.html থেকে আনা Animated Background Logic ---
        // একটিভ ব্যাকগ্রাউন্ড ইমেজ ট্র্যাক করার জন্য
        let currentImageIndex = 0;

        function updateAnimatedBackground() {
            const theme = htmlEl.getAttribute('data-bs-theme');
            const bgImages = document.querySelectorAll(`.bg-image-${theme}`);
            if (bgImages.length === 0) return;

            // সব ইমেজ থেকে 'active' ক্লাস রিমুভ করা
            bgImages.forEach(img => img.classList.remove('active'));
            
            // পরবর্তী ইমেজ ইনডেক্স সেট করা
            currentImageIndex = (currentImageIndex + 1) % bgImages.length;
            
            // নতুন ইমেজকে 'active' করা
            bgImages[currentImageIndex].classList.add('active');
        }

        // প্রতি 5 সেকেন্ডে ব্যাকগ্রাউন্ড পরিবর্তন
        setInterval(updateAnimatedBackground, 5000);

        // --- NEW: Sticky Scroll Logic (MODIFIED) ---
        function setupStickyScroll() {
            const scrollTrigger = document.getElementById('scroll-trigger');
            const topBar = document.getElementById('top-bar');

            if (!scrollTrigger || !topBar) {
                console.error("Sticky scroll elements not found!");
                return;
            }
            
            // Calculate the correct top margin for the observer
            // topBar.offsetHeight is the height, 16 is 1rem margin-top
            // Adding 1px buffer to ensure it triggers correctly
            const topBarTotalHeight = topBar.offsetHeight + 16 + 1; 

            const observer = new IntersectionObserver(
                ([entry]) => {
                    // entry.isIntersecting = true when top of viewport hits the trigger
                    // We want to activate sticky when the trigger is *above* the viewport
                    document.body.classList.toggle('sticky-active', !entry.isIntersecting);
                },
                { 
                    root: null, // observes intersections in the viewport
                    threshold: 0,
                    // Trigger when the element is 1px *above* the top bar
                    rootMargin: `-${topBarTotalHeight}px 0px 0px 0px` 
                }
            );

            observer.observe(scrollTrigger);
        }


        // --- NEW: Note Edit Modal Logic ---
        function setupNoteEditModal() {
            const noteTemplateModal = new bootstrap.Modal(document.getElementById('noteTemplateModal'));
            const noteEditText = document.getElementById('note_Edit_Text');
            const mainNoteText = document.getElementById('note_Text');
            const saveNoteBtn = document.getElementById('saveNoteTemplateBtn');
            const copyNoteBtn = document.getElementById('copyEditedNoteBtn');

            // Open modal -> Load text
            document.getElementById('noteTemplateModal').addEventListener('show.bs.modal', () => {
                noteEditText.value = mainNoteText.value;
            });
            
            // Save button -> Update main textarea
            saveNoteBtn.addEventListener('click', () => {
                mainNoteText.value = noteEditText.value;
                noteTemplateModal.hide();
            });
            
            // Copy button -> Copy and close
            copyNoteBtn.addEventListener('click', () => {
                noteEditText.select();
                document.execCommand('copy');
                noteTemplateModal.hide();
                
                // Show temporary "Copied!" confirmation on main page
                copyConfirmationNote.style.display = 'block';
                setTimeout(() => { copyConfirmationNote.style.display = 'none'; }, 2000);
            });
        }


        // --- notes-content.txt থেকে আনা Data Extraction Logic ---
        
        // --- Global Variables ---
        let globalEobAdditionalPayment = 0;
        let globalEobTicket = 'Not Found';
        let globalEobData = { updated: null, old: null };

        // --- Utility Functions ---
        function formatCurrency(num) {
            if (isNaN(num)) {
                num = 0;
            }
            return '$' + num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function extractValueSkippingLines(text, labelRegex) {
            const match = text.match(labelRegex);
            if (!match) return null;

            const labelEndIndex = match.index + match[0].length;
            const subsequentText = text.substring(labelEndIndex);
            
            const lines = subsequentText.split(/[\r\n]+/);
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (trimmedLine.length > 0) {
                    if (trimmedLine.match(/^[a-zA-Z\s\.\/()-]+:/)) {
                        continue; 
                    }
                    return trimmedLine; 
                }
            }
            return null; 
        }
        
        function parseCurrency(value) {
            if (typeof value !== 'string') return 0;
            const cleaned = value.replace(/[$,\s]/g, '');
            return parseFloat(cleaned) || 0;
        }
        
        function getColumnValue(columns, index) {
            if (columns && columns.length > index && columns[index] !== "") {
                return columns[index].trim();
            }
            return "--";
        }
        
        function getFormattedDate() {
            const now = new Date();
            const bdTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Dhaka' }));
            
            const mm = String(bdTime.getMonth() + 1).padStart(2, '0');
            const dd = String(bdTime.getDate()).padStart(2, '0');
            const yy = String(bdTime.getFullYear()).slice(-2);
            
            return `${mm}/${dd}/${yy}`;
        }
        
        function copyToClipboard(input, confirmationId) {
            input.select();
            document.execCommand('copy');
            
            const confirmationEl = document.getElementById(confirmationId);
            if (confirmationEl) {
                confirmationEl.style.display = 'block';
                setTimeout(() => { confirmationEl.style.display = 'none'; }, 2000);
            }
        }

        // --- Get EOB Elements ---
        const eobUpdatedInput = document.getElementById('eobUpdatedInput');
        const eobOldInput = document.getElementById('eobOldInput');
        const eobResults1Container = document.getElementById('eob-results-list-1');
        const eobResults2Container = document.getElementById('eob-results-list-2');
        const eobErrors1 = document.getElementById('eob-errors-1');
        const eobErrors2 = document.getElementById('eob-errors-2');
        const idrErrors = document.getElementById('idr-errors');
        
        // NEW: Sticky Header EOB Content
        const stickyEobContent = document.getElementById('sticky-eob-content');

        // --- Get Note Generation Elements ---
        const noteNameInput = document.getElementById('note_Name');
        const noteInitialInput = document.getElementById('note_Initial');
        const noteTextInput = document.getElementById('note_Text');
        const noteGenerateBtn = document.getElementById('note_GenerateBtn'); 
        const noteClearBtn = document.getElementById('note_ClearBtn');
        const copyConfirmationNote = document.getElementById('copy_Confirmation_Note'); 
        const finalReviewAdjustments = document.getElementById('finalReviewAdjustments'); 
        const adjustWithPt = document.getElementById('adjustWithPt');
        const adjustWithoutPt = document.getElementById('adjustWithoutPt');
        const noteWarningNoEOB = document.getElementById('note_Warning_NoEOB'); 
        const noteWarningClaimMismatch = document.getElementById('note_Warning_ClaimMismatch'); 
        
        // --- Get Mail Generation Elements ---
        const mailNameInput = document.getElementById('note_Mail_Name');
        const mailInitialInput = document.getElementById('note_Mail_Initial'); 
        const mailToInput = document.getElementById('note_Mail_To');
        const mailCcInput = document.getElementById('note_Mail_CC');
        const mailTypeInput = document.getElementById('note_Mail_Type');
        const mailSubjectInput = document.getElementById('note_Mail_Subject');
        const mailDetermDateInput = document.getElementById('note_Mail_Determ_Date'); 
        const mailGenerateBtn = document.getElementById('note_Mail_GenerateBtn');
        const mailClearBtn = document.getElementById('note_Mail_ClearBtn');
        const mailTextInput = document.getElementById('note_Mail_Text');
        const mailNoteTextInput = document.getElementById('mail_Note_Text'); 
        const copyConfirmationMail = document.getElementById('copy_Confirmation_Mail'); 
        const emailTemplateText = document.getElementById('email_Template_Text');
        const saveEmailTemplateBtn = document.getElementById('saveEmailTemplateBtn');

        // --- Default Email Template ---
        let currentEmailTemplate = `Dear BCBS,

We are writing to formally request the prompt payment of the additional reimbursement as required by the final determination in the Federal Independent Dispute Resolution (IDR) process under the No Surpresas Act (NSA).
On [DETERMINATION_DATE], [MEDIATOR_NAME] —the certified IDR entity—issued a final, legally binding determination in favor of , [PROVIDER_NAME] regarding the above-referenced claim. The IDR entity selected the out-of-network payment amount of [OON_RATE] for service code [CPT_CODE]. as offered by [PROVIDER_NAME] as the appropriate rate for this claim.
According to the NSA and its implementing regulations (including 45 CFR 149.510(c)(4)(vii)), the plan or issuer must pay the balance of the total plan or coverage amount selected by the certified IDR entity, less any initial payment already made and any applicable patient cost-sharing, within 30 calendar days of the determination notification. As of today, this payment is outstanding.

Request for Payment:
Please remit the outstanding balance, calculated as follows:
Claim Number: [CLAIM_NUMBER]
IDR-Determined OON Rate: [OON_RATE]
Less Initial Payment: [INITIAL_PAYMENT]
------------------------
Total Outstanding Balance: [OUTSTANDING_BALANCE]

This request is made pursuant to the No Surpresas Act and its regulations, which require payment of the IDR-determined amount within 30 calendar days of the decision. Failure to remit payment in a timely manner may be reported to the appropriate regulatory authorities for noncompliance
If you have any questions or require additional documentation to process this payment, please contact us at bcbs_nsaandidr@roundtmc.com.

As per Federal guidelines additional payment amounts must be made within 30 days of the determination. If we do not receive the additional payment amount a CMS complaint may be filed. We appreciate your prompt attention to this matter.

For your reference we have attached the primary EOB and IDR determination.


Thank You
Regards
---------------
[MY_NAME]`;
        
        emailTemplateText.value = currentEmailTemplate;
        
        saveEmailTemplateBtn.addEventListener('click', () => {
            currentEmailTemplate = emailTemplateText.value;
            // Optionally save to localStorage
        });

        // --- Clear Functions ---
        
        function clearEobResults() {
             eobResults1Container.innerHTML = '';
             eobResults2Container.innerHTML = '';
             stickyEobContent.innerHTML = ''; // NEW: Clear sticky header
             eobErrors1.textContent = '';
             eobErrors2.textContent = '';
             idrErrors.textContent = '';
             globalEobAdditionalPayment = 0;
             globalEobTicket = 'Not Found';
             globalEobData = { updated: null, old: null };
        }

        function clearComparisonStyles() {
            // Clear EOB Result styles
            document.querySelectorAll('.eob-result-value, .sticky-eob-value').forEach(el => {
                el.classList.remove('bg-match', 'bg-mismatch', 'bg-overpaid');
            });
            
            // Clear IDR Table styles
            const idrCells = document.querySelectorAll('#idrDataTableBody td, #idrDataTableBody th');
            idrCells.forEach(cell => {
                cell.classList.remove('bg-match', 'bg-mismatch', 'bg-overpaid');
                const input = cell.querySelector('input');
                if(input) {
                    input.classList.remove('is-invalid');
                    input.closest('td').classList.remove('bg-mismatch'); 
                }
            });
        }
        
        document.getElementById('clearButton').addEventListener('click', function() {
            eobUpdatedInput.value = '';
            eobOldInput.value = '';
            document.getElementById('idrTextInput1').value = '';
            document.getElementById('idrTextInput2').value = '';
            document.getElementById('idrTextInput3').value = '';
            document.getElementById('idrTextInput4').value = ''; 
            document.getElementById('idr2022TextInput1').value = '';
            document.getElementById('idr2022TextInput2').value = '';
            document.getElementById('idr2022TextInput3').value = '';
            document.getElementById('idr2022TextInput4').value = ''; 

            clearEobResults();
            document.getElementById('idrDataTableBody').innerHTML = ''; 
            
            noteClearBtn.click();
            clearComparisonStyles();
            mailClearBtn.click();
        });
        
        noteClearBtn.addEventListener('click', function() {
             noteInitialInput.value = '';
             noteTextInput.value = '';
             finalReviewAdjustments.style.display = 'none'; 
             noteWarningNoEOB.style.display = 'none'; 
             noteWarningClaimMismatch.style.display = 'none'; 
        });
        
        mailClearBtn.addEventListener('click', function() {
            mailSubjectInput.value = '';
            mailTextInput.value = '';
            mailNoteTextInput.value = ''; 
            mailCcInput.value = 'mislam@roundtmc.com, razo@leverngear.com';
            mailToInput.value = 'nsa.disputes@bcbstx.com';
            mailTypeInput.value = '';
            mailDetermDateInput.value = ''; 
            mailTypeInput.classList.remove('is-invalid');
            mailDetermDateInput.classList.remove('is-invalid');
            mailTextInput.classList.remove('bg-match', 'text-success');
        });

        // --- Event Listeners ---
        
        noteTextInput.addEventListener('click', function() {
            copyToClipboard(noteTextInput, 'copy_Confirmation_Note');
        });
        noteGenerateBtn.addEventListener('click', function() {
            validateAndGenerateNote();
        });
        mailGenerateBtn.addEventListener('click', function() {
            generateMail();
        });
        mailNoteTextInput.addEventListener('click', function() {
             copyToClipboard(mailNoteTextInput, 'copy_Confirmation_Mail');
        });
        mailTextInput.addEventListener('click', function() {
             copyToClipboard(mailTextInput, 'copy_Confirmation_Mail');
        });
        mailSubjectInput.addEventListener('click', function() {
             copyToClipboard(mailSubjectInput, 'copy_Confirmation_Mail');
        });
        document.getElementById('processButton').addEventListener('click', processAllData);

        // --- EOB Parsing and Display Logic ---

        function parseEOB(eobText) {
            if (!eobText || eobText.trim() === "") {
                return null;
            }
            
            const ticketNoMatch = eobText.match(/(Patient Account Number|Pt Acct No)\s*:?[\s\r\n]+([^\r\n]+)/i); 
            const ptNameMatch = eobText.match(/(Patient|Pt Name)(?! Information)\s*:?[\s\r\n]+([^\r\n]+)/i); 
            const claimNoMatch = eobText.match(/(Claim I?D|Claim No|Claim Number|Control Number)\s*:?[\s\r\n]+([^\r\n]+)/i); 
            const billingProviderMatch = eobText.match(/(Billing Provider|Provider Name)\s*:?[\s\r\n]+([^\r\n]+)/i);
            
            const billedStr = extractValueSkippingLines(eobText, /Billed( Amount)?\s*:?/i) || '$0.00';
            const paidStr = extractValueSkippingLines(eobText, /(Plan Paid|Paid Amount)\s*:?/i) || '$0.00'; 
            const ptRespStr = extractValueSkippingLines(eobText, /(Copay\/Deductible Amount|Copay|Deductible|Responsibility)\s*:?/i) || '$0.00';
            const coinsuranceStr = extractValueSkippingLines(eobText, /(Coinsurance Amount|Coinsurance|Co-insurance)\s*:?/i) || '$0.00';
            const addlPaidStr = extractValueSkippingLines(eobText, /Additional Paid( Amount)?\s*:?/i) || '$0.00';

            const coinsuranceAmt = parseCurrency(coinsuranceStr);
            const ptRespAmt = parseCurrency(ptRespStr); 

            return {
                ticketNo: ticketNoMatch ? ticketNoMatch[2].trim() : 'Not Found',
                ptName: ptNameMatch ? ptNameMatch[2].trim() : 'Not Found',
                claimNo: claimNoMatch ? claimNoMatch[2].trim() : 'Not Found',
                provider: billingProviderMatch ? billingProviderMatch[2].trim() : 'Not Found',
                billedAmt: parseCurrency(billedStr),
                paidAmt: parseCurrency(paidStr),
                ptRespSum: ptRespAmt + coinsuranceAmt,
                addlPaidAmt: parseCurrency(addlPaidStr)
            };
        }

        /**
         * NEW: Populates both original cards AND the sticky header
         * MODIFIED: Sticky header only shows 5 columns
         */
        function displayEOBResults(updated, old) {
            // Clear all containers
            eobResults1Container.innerHTML = '';
            eobResults2Container.innerHTML = '';
            stickyEobContent.innerHTML = ''; 
            eobErrors1.textContent = '';
            globalEobAdditionalPayment = 0;
            globalEobTicket = 'Not Found';

            if (!updated && !old) {
                eobErrors1.textContent = 'EOB not found.';
                return;
            }

            // --- Calculate Additional Payment ---
            let addlPayResult = 0;
            if (updated && old) {
                addlPayResult = updated.paidAmt - old.paidAmt;
            } else if (updated) {
                addlPayResult = updated.addlPaidAmt || updated.paidAmt;
            } else if (old) {
                addlPayResult = old.addlPaidAmt || old.paidAmt;
            }
            globalEobAdditionalPayment = addlPayResult;
            
            globalEobTicket = updated?.ticketNo || old?.ticketNo || 'Not Found';

            // --- Build HTML for Original Cards ---
            let html1_card = '', html2_card = '', html_sticky = '';

            if (updated && old) {
                // --- CARD 1 (Ticket, Patient, Claim, Addl) ---
                html1_card = `
                    <div class="eob-result-col">
                        <span class="header">Updated</span>
                        <span class="eob-result-value" id="eob_up_Ticket">${updated.ticketNo}</span>
                        <span class="eob-result-value" id="eob_up_Patient">${updated.ptName}</span>
                        <span class="eob-result-value" id="eob_up_Claim">${updated.claimNo}</span>
                        <span class="eob-result-value currency bg-match" id="eob_calc_AddlPay" title="Updated Paid - Old Paid">${formatCurrency(addlPayResult)}</span>
                    </div>
                    <div class="eob-result-col">
                        <span class="header">Old</span>
                        <span class="eob-result-value" id="eob_old_Ticket">${old.ticketNo}</span>
                        <span class="eob-result-value" id="eob_old_Patient">${old.ptName}</span>
                        <span class="eob-result-value" id="eob_old_Claim">${old.claimNo}</span>
                        <span class="eob-result-value currency" id="eob_old_AddlPay" title="Old Addl. Paid">${formatCurrency(old.addlPaidAmt)}</span>
                    </div>`;
                
                // --- CARD 2 (Billed, Paid, Resp, Facility) ---
                html2_card = `
                    <div class="eob-result-col">
                        <span class="header">Updated</span>
                        <span class="eob-result-value currency" id="eob_up_Billed">${formatCurrency(updated.billedAmt)}</span>
                        <span class="eob-result-value currency" id="eob_up_Paid">${formatCurrency(updated.paidAmt)}</span>
                        <span class="eob-result-value currency" id="eob_up_PtResp">${formatCurrency(updated.ptRespSum)}</span>
                        <span class="eob-result-value facility-truncate" id="eob_up_Facility" title="${updated.provider}">${updated.provider}</span>
                    </div>
                    <div class="eob-result-col">
                        <span class="header">Old</span>
                        <span class="eob-result-value currency" id="eob_old_Billed">${formatCurrency(old.billedAmt)}</span>
                        <span class="eob-result-value currency" id="eob_old_Paid">${formatCurrency(old.paidAmt)}</span>
                        <span class="eob-result-value currency" id="eob_old_PtResp">${formatCurrency(old.ptRespSum)}</span>
                        <span class="eob-result-value facility-truncate" id="eob_old_Facility" title="${old.provider}">${old.provider}</span>
                    </div>`;

                // --- STICKY HEADER (Two rows, 5 columns) ---
                html_sticky = `
                    <div class="row sticky-eob-row">
                        <div class="col-auto"><span class="sticky-eob-label">Updated:</span></div>
                        <div class="col"><span class="sticky-eob-label">Ticket:</span> <span class="sticky-eob-value" id="sticky_up_Ticket">${updated.ticketNo}</span></div>
                        <div class="col"><span class="sticky-eob-label">Total Bill:</span> <span class="sticky-eob-value currency" id="sticky_up_Billed">${formatCurrency(updated.billedAmt)}</span></div>
                        <div class="col"><span class="sticky-eob-label">Paid:</span> <span class="sticky-eob-value currency" id="sticky_up_Paid">${formatCurrency(updated.paidAmt)}</span></div>
                        <div class="col"><span class="sticky-eob-label">PT Resp:</span> <span class="sticky-eob-value currency" id="sticky_up_PtResp">${formatCurrency(updated.ptRespSum)}</span></div>
                        <div class="col"><span class="sticky-eob-label">Additional:</span> <span class="sticky-eob-value currency bg-match" id="sticky_calc_AddlPay">${formatCurrency(addlPayResult)}</span></div>
                    </div>
                    <div class="row sticky-eob-row">
                        <div class="col-auto"><span class="sticky-eob-label">Old:</span></div>
                        <div class="col"><span class="sticky-eob-label">Ticket:</span> <span class="sticky-eob-value" id="sticky_old_Ticket">${old.ticketNo}</span></div>
                        <div class="col"><span class="sticky-eob-label">Total Bill:</span> <span class="sticky-eob-value currency" id="sticky_old_Billed">${formatCurrency(old.billedAmt)}</span></div>
                        <div class="col"><span class="sticky-eob-label">Paid:</span> <span class="sticky-eob-value currency" id="sticky_old_Paid">${formatCurrency(old.paidAmt)}</span></div>
                        <div class="col"><span class="sticky-eob-label">PT Resp:</span> <span class="sticky-eob-value currency" id="sticky_old_PtResp">${formatCurrency(old.ptRespSum)}</span></div>
                        <div class="col"><span class="sticky-eob-label">Additional:</span> <span class="sticky-eob-value currency" id="sticky_old_AddlPay">${formatCurrency(old.addlPaidAmt)}</span></div>
                    </div>`;

            } else {
                // --- SINGLE EOB ---
                const data = updated || old;
                const eobType = updated ? 'Updated' : 'Old';
                
                // --- CARD 1 (Ticket, Patient, Claim, Addl) ---
                html1_card = `
                    <div class="eob-result-col single">
                        <span class="header">${eobType}</span>
                        <span class="eob-result-value" id="eob_single_Ticket">${data.ticketNo}</span>
                        <span class="eob-result-value" id="eob_single_Patient">${data.ptName}</span>
                        <span class="eob-result-value" id="eob_single_Claim">${data.claimNo}</span>
                        <span class="eob-result-value currency bg-match" id="eob_calc_AddlPay" title="Single EOB Addl. Paid">${formatCurrency(addlPayResult)}</span>
                    </div>`;

                // --- CARD 2 (Billed, Paid, Resp, Facility) ---
                html2_card = `
                    <div class="eob-result-col single">
                        <span class="header">${eobType}</span>
                        <span class="eob-result-value currency" id="eob_single_Billed">${formatCurrency(data.billedAmt)}</span>
                        <span class="eob-result-value currency" id="eob_single_Paid">${formatCurrency(data.paidAmt)}</span>
                        <span class="eob-result-value currency" id="eob_single_PtResp">${formatCurrency(data.ptRespSum)}</span>
                        <span class="eob-result-value facility-truncate" id="eob_single_Facility" title="${data.provider}">${data.provider}</span>
                    </div>`;
                
                // --- STICKY HEADER (One row, 5 columns) ---
                 html_sticky = `
                    <div class="row sticky-eob-row">
                        <div class="col-auto"><span class="sticky-eob-label">${eobType}:</span></div>
                        <div class="col"><span class="sticky-eob-label">Ticket:</span> <span class="sticky-eob-value" id="sticky_single_Ticket">${data.ticketNo}</span></div>
                        <div class="col"><span class="sticky-eob-label">Total Bill:</span> <span class="sticky-eob-value currency" id="sticky_single_Billed">${formatCurrency(data.billedAmt)}</span></div>
                        <div class="col"><span class="sticky-eob-label">Paid:</span> <span class="sticky-eob-value currency" id="sticky_single_Paid">${formatCurrency(data.paidAmt)}</span></div>
                        <div class="col"><span class="sticky-eob-label">PT Resp:</span> <span class="sticky-eob-value currency" id="sticky_single_PtResp">${formatCurrency(data.ptRespSum)}</span></div>
                        <div class="col"><span class="sticky-eob-label">Additional:</span> <span class="sticky-eob-value currency bg-match" id="sticky_calc_AddlPay">${formatCurrency(addlPayResult)}</span></div>
                    </div>`;
            }
            
            // Populate all containers
            eobResults1Container.innerHTML = html1_card;
            eobResults2Container.innerHTML = html2_card;
            stickyEobContent.innerHTML = html_sticky;
        }


        // --- IDR Parsing ---
        
        function parseAndDisplayIDR() {
            const idrTextInputs = [
                { year: '2024+', text: document.getElementById('idrTextInput1').value, map: '2024+' },
                { year: '2024+', text: document.getElementById('idrTextInput2').value, map: '2024+' },
                { year: '2024+', text: document.getElementById('idrTextInput3').value, map: '2024+' },
                { year: '2024+', text: document.getElementById('idrTextInput4').value, map: '2024+' },
                { year: '2022-23', text: document.getElementById('idr2022TextInput1').value, map: '2022-23' },
                { year: '2022-23', text: document.getElementById('idr2022TextInput2').value, map: '2022-23' },
                { year: '2022-23', text: document.getElementById('idr2022TextInput3').value, map: '2022-23' },
                { year: '2022-23', text: document.getElementById('idr2022TextInput4').value, map: '2022-23' }
            ];
            
            const idrFields = [
                "Ticket #", "IDR #", "Claim #", "CPT", "Initial Pmt", "Mediator", 
                "Determ. Date", "Determ. W/L", "Addl. Pmt", "Pmt Date", 
                "Fee Refund", "Fee Refund Date",
                "W/L (Manual)", "Additional", "Refund" 
            ];
            
            const idrFieldIndexMap_2024 = {
                "Ticket #": 2, "IDR #": 1, "Claim #": 3, "CPT": 4, "Initial Pmt": 7, "Mediator": 8,
                "Determ. Date": 16, "Determ. W/L": 17, "Addl. Pmt": 18, "Pmt Date": 19,
                "Fee Refund": 20, "Fee Refund Date": 21,
                "W/L (Manual)": null, "Additional": null, "Refund": null
            };
            
            const idrFieldIndexMap_2022 = {
                "Ticket #": 1, "IDR #": 5, "Claim #": 2, "CPT": 3, "Initial Pmt": 7, "Mediator": 8,
                "Determ. Date": 18, "Determ. W/L": 19, "Addl. Pmt": 20, "Pmt Date": 21,
                "Fee Refund": 22, "Fee Refund Date": 23,
                "W/L (Manual)": null, "Additional": null, "Refund": null
            };
            
            const mapDictionary = {
                '2024+': idrFieldIndexMap_2024,
                '2022-23': idrFieldIndexMap_2022
            };

            const idrTableBody = document.getElementById('idrDataTableBody');
            idrTableBody.innerHTML = ''; 
            
            let resultCounter = 1;
            let firstIdrDetermDate = null; 

            idrTextInputs.forEach((input, index) => {
                if (input.text.trim() === "") {
                    return; 
                }
                
                const currentMap = mapDictionary[input.map];
                
                const columns = input.text.split(/\t|\s{2,}/);
                let rowHtml = `<tr><th scope="row">Res ${resultCounter} (${input.year})</th>`; // No sticky class
                let rowResult = {}; 

                idrFields.forEach(field => {
                    if (currentMap[field] !== null) {
                        rowResult[field] = getColumnValue(columns, currentMap[field]);
                    }
                });
                
                if (resultCounter === 1) {
                    firstIdrDetermDate = rowResult["Determ. Date"];
                }

                idrFields.forEach(field => {
                    let displayValue = rowResult[field];
                    let cellHtml = '';
                    let cellId = `idr_${field.replace(/[^A-Za-z0-9]/g, '_')}_${index+1}`; 
                    let stickyClass = ''; // No sticky class
                    
                    let isAmount = field === 'Initial Pmt' || field === 'Addl. Pmt' || field === 'Fee Refund';
                    let amountClass = isAmount ? 'output-value-amount' : '';
                    let mediatorClass = (field === 'Mediator') ? 'truncate-mediator' : '';
                    
                    if (isAmount && displayValue !== '--' && displayValue !== 'Not Found') {
                         displayValue = formatCurrency(parseCurrency(displayValue));
                    } else if (isAmount) {
                        displayValue = '$0.00'; 
                    }

                    if (field === "W/L (Manual)") {
                        let winLoseValue = rowResult["Determ. W/L"];
                        rowResult[field] = winLoseValue; 
                        if (winLoseValue === "--" || winLoseValue === "Not Found") {
                            cellHtml = `<td ${cellId} class="${stickyClass}"><input type="text" class="form-control form-control-sm editable-input win-lose-input" data-row-index="${index}"></td>`;
                        } else {
                            cellHtml = `<td ${cellId} class="${stickyClass}">${winLoseValue}</td>`;
                        }
                    } else if (field === "Additional") {
                        const paymentDate = rowResult["Pmt Date"];
                        displayValue = (paymentDate !== "--" && paymentDate !== "Not Found") ? "Received" : "Waiting";
                        rowResult[field] = displayValue; 
                        cellHtml = `<td ${cellId} class="${stickyClass}">${displayValue}</td>`;
                    } else if (field === "Refund") {
                        const winLoseValue = rowResult["Determ. W/L"] ? rowResult["Determ. W/L"].toLowerCase() : '';
                        let isDisabled = (winLoseValue === 'lose'); 
                        let isInvalid = (winLoseValue === 'win'); 
                        
                        if (winLoseValue === 'close' || winLoseValue === 'closed') { // Handle 'closed'
                            isDisabled = false;
                            isInvalid = false;
                        }
                        
                        cellHtml = `<td class="${stickyClass} ${isInvalid ? 'bg-mismatch' : ''}">
                                        <input type="text" 
                                               class="form-control form-control-sm editable-input refund-input ${isInvalid ? 'is-invalid' : ''}" 
                                               data-row-index="${index}" 
                                               oninput="autocompleteRefund(this)" 
                                               ${isDisabled ? 'disabled' : ''}>
                                    </td>`;
                        rowResult[field] = isDisabled ? 'N/A' : ''; 
                    } else {
                        // Standard cell
                        cellHtml = `<td id="${cellId}" class="${stickyClass} ${amountClass} ${mediatorClass}" title="${(field === 'Mediator') ? displayValue : ''}">${displayValue}</td>`;
                    }
                    
                    rowHtml += cellHtml;
                });

                rowHtml += '</tr>';
                idrTableBody.innerHTML += rowHtml;
                
                resultCounter++; 
            });
            
            if (firstIdrDetermDate) {
                mailDetermDateInput.value = firstIdrDetermDate;
            }
        }
        
        // --- Matching Logic ---

        function performMatching() {
            // 1. Ticket Number Matching
            const allIdrTicketCells = document.querySelectorAll('#idrDataTableBody td:nth-child(2)');
            let eobTicketMatched = false;
            
            if (globalEobTicket !== 'Not Found' && allIdrTicketCells.length > 0) {
                allIdrTicketCells.forEach(cell => {
                    if (cell.textContent !== '--') {
                         if (globalEobTicket === cell.textContent) {
                            cell.classList.add('bg-match');
                            eobTicketMatched = true;
                        } else {
                            cell.classList.add('bg-mismatch');
                        }
                    }
                });
            }
            
            // Highlight EOB Ticket field (both original and sticky)
            const eobTicketEls = document.querySelectorAll('#eob_up_Ticket, #eob_single_Ticket, #sticky_up_Ticket, #sticky_single_Ticket');
            if (eobTicketEls.length > 0) {
                if(allIdrTicketCells.length > 0) { 
                   eobTicketEls.forEach(el => el.classList.add(eobTicketMatched ? 'bg-match' : 'bg-mismatch'));
                }
            } else if (globalEobTicket === 'Not Found' && allIdrTicketCells.length > 0) {
                eobErrors1.textContent = 'EOB Ticket # not found for comparison.';
            }

            // 2. Additional Payment Matching
            const allIdrAddlPmtCells = document.querySelectorAll('#idrDataTableBody td:nth-child(10)');
            if (allIdrAddlPmtCells.length === 0) {
                return; // No IDRs to match
            }

            const idrAmounts = Array.from(allIdrAddlPmtCells).map(cell => ({
                amount: parseCurrency(cell.textContent),
                cell: cell
            }));

            const eobAddlPayEls = document.querySelectorAll('#eob_calc_AddlPay, #sticky_calc_AddlPay');
            if (globalEobAdditionalPayment === 0) {
                idrErrors.textContent = 'Calculated EOB Additional Payment is $0.00. Cannot perform match.';
                return;
            }

            let bestMatch = findMatchingSubset(globalEobAdditionalPayment, idrAmounts);

            if (bestMatch.indices.length > 0) {
                // Found a match
                idrAmounts.forEach((item, index) => {
                    if (bestMatch.indices.includes(index)) {
                        item.cell.classList.add('bg-match');
                    } else {
                        item.cell.classList.add('bg-mismatch');
                    }
                });
                if (eobAddlPayEls.length > 0) eobAddlPayEls.forEach(el => el.classList.add('bg-match'));
                idrErrors.textContent = `Match found: EOB Addl. ${formatCurrency(globalEobAdditionalPayment)} = IDR Sum ${formatCurrency(bestMatch.sum)}`;
                idrErrors.classList.add('text-success');
                idrErrors.classList.remove('text-danger');
            } else {
                // No match
                idrAmounts.forEach(item => item.cell.classList.add('bg-mismatch'));
                if (eobAddlPayEls.length > 0) eobAddlPayEls.forEach(el => el.classList.add('bg-mismatch'));
                idrErrors.textContent = `Additional mismatch: EOB Addl. ${formatCurrency(globalEobAdditionalPayment)} does not match any combination of IDR payments.`;
                idrErrors.classList.add('text-danger');
                idrErrors.classList.remove('text-success');
            }
        }

        /**
         * Finds a subset of IDR amounts that sums exactly to the target.
         */
        function findMatchingSubset(target, items) {
            let n = items.length;
            let bestMatch = { indices: [], sum: 0 };
            
            for (let i = 0; i < (1 << n); i++) {
                let currentSum = 0;
                let currentIndices = [];
                
                for (let j = 0; j < n; j++) {
                    if ((i >> j) & 1) {
                        currentSum += items[j].amount;
                        currentIndices.push(j);
                    }
                }
                
                if (Math.abs(currentSum - target) < 0.001) { 
                    return { indices: currentIndices, sum: currentSum };
                }
            }
            
            return bestMatch;
        }

        // --- Main Process Function ---

        function processAllData() {
            // 1. Clear previous results and styles
            clearComparisonStyles();
            noteClearBtn.click(); 
            mailClearBtn.click(); 
            eobErrors1.textContent = '';
            eobErrors2.textContent = '';
            idrErrors.textContent = '';
            idrErrors.classList.remove('text-success', 'text-danger');

            // 2. Process EOBs
            const eobUpdatedText = eobUpdatedInput.value;
            const eobOldText = eobOldInput.value;
            
            globalEobData.updated = parseEOB(eobUpdatedText);
            globalEobData.old = parseEOB(eobOldText);

            displayEOBResults(globalEobData.updated, globalEobData.old);
            
            // 3. Process IDR
            parseAndDisplayIDR();

            // 4. Perform Matching
            performMatching();
        }

        
        // --- Note Generation & Validation Functions ---

        function validateAndGenerateNote() {
            let validationPassed = true;
            let activeIdrRows = [];
            finalReviewAdjustments.style.display = 'none'; 
            noteWarningNoEOB.style.display = 'none';
            noteWarningClaimMismatch.style.display = 'none';
            
            const idrRows = document.querySelectorAll('#idrDataTableBody tr');
            let idrClaimNumbers = []; 
            
            idrRows.forEach((row, index) => {
                const winLoseInput = row.querySelector('.win-lose-input');
                const refundInput = row.querySelector('.refund-input');
                
                let rowData = {
                    idrNum: row.cells[2].textContent,
                    claimNum: row.cells[3].textContent, 
                    cpt: row.cells[4].textContent,
                    mediator: row.cells[6].textContent, 
                    addlPmt: row.cells[9].textContent, 
                    additionalStatus: row.cells[14].textContent, 
                    winLoseStatus: '',
                    refundStatus: ''
                };
                
                if(rowData.claimNum !== '--' && rowData.claimNum !== 'Not Found') {
                    idrClaimNumbers.push(rowData.claimNum);
                }
                
                let currentWLStatus = '';
                if (winLoseInput) {
                    if (winLoseInput.value.trim() === '') {
                        validationPassed = false;
                        winLoseInput.classList.add('is-invalid');
                    }
                    currentWLStatus = winLoseInput.value.toLowerCase();
                } else {
                    currentWLStatus = row.cells[13].textContent.toLowerCase(); 
                }
                rowData.winLoseStatus = currentWLStatus;

                if (refundInput) {
                    rowData.refundStatus = refundInput.value;
                    if (currentWLStatus === 'win' && refundInput.value.trim() === '') {
                        validationPassed = false;
                        refundInput.classList.add('is-invalid');
                        refundInput.closest('td').classList.add('bg-mismatch');
                    }
                }
                
                activeIdrRows.push(rowData);
            });

            if (!validationPassed) {
                noteInitialInput.value = "ERROR";
                noteTextInput.value = "ERROR: PLEASE FILL ALL REQUIRED W/L AND REFUND FIELDS IN THE IDR TABLE (MARKED IN RED).";
                return;
            }
            
            const allSame = idrClaimNumbers.every(c => c === idrClaimNumbers[0]);
            if (!allSame && idrClaimNumbers.length > 0) {
                noteWarningClaimMismatch.style.display = 'block';
            }
            
            // --- Determine Initial (NEW LOGIC) ---
            let initial = "IDR FOLLOW UP"; // Default
            let allTasksDone = activeIdrRows.length > 0;
            let closedAndEmptyRefund = false;

            activeIdrRows.forEach(row => {
                const wl = row.winLoseStatus;
                const ad = row.additionalStatus.toLowerCase();
                const rf = row.refundStatus.toLowerCase();

                if (wl === 'win') {
                    if (ad !== 'received' || rf !== 'received') allTasksDone = false;
                } else if (wl === 'lose') {
                    if (ad !== 'received') allTasksDone = false; 
                } else if (wl === 'closed' || wl === 'close') {
                    if (rf === 'waiting') allTasksDone = false; // NEW: If waiting, not done.
                    if (rf === '') closedAndEmptyRefund = true; // NEW: If closed and empty, it's done.
                } else {
                    allTasksDone = false;
                }
            });

            if (allTasksDone) {
                initial = "FINAL REVIEW";
            }
            
            if (activeIdrRows.length === 1 && initial !== "FINAL REVIEW") {
                const status = activeIdrRows[0].winLoseStatus;
                if (status === 'win') initial = 'IDR WIN';
                else if (status === 'lose') initial = 'IDR LOSE';
                else if (status === 'closed' || status === 'close') {
                    // NEW: "Closed" logic
                    if (activeIdrRows[0].refundStatus.toLowerCase() === 'waiting') {
                        initial = 'IDR FOLLOW UP';
                    } else {
                        initial = 'FINAL REVIEW'; // If "Received" or empty
                    }
                }
            }
            
            noteInitialInput.value = initial;
            
            // --- EOB Data ---
            const eobExists = globalEobData.updated || globalEobData.old;
            const eobData = globalEobData.updated || globalEobData.old; // Prefer updated
            
            const eobClaimNo = eobData?.claimNo || 'N/A';
            const eobBilled = eobData?.billedAmt || 0;
            const eobPaid = eobData?.paidAmt || 0;
            const ptRespSum = eobData?.ptRespSum || 0; 

            const today = getFormattedDate(); 
            const name = noteNameInput.value || 'PRANTO R';
            
            let note = `${today}>${initial}>${name}>WORKING ON TRACKING SHEET. `;
            
            if (eobExists) {
                note += `CLAIM: ${eobClaimNo}; TOTAL BILL ${formatCurrency(eobBilled)}, INS PAID ${formatCurrency(eobPaid)}, PT RESPONSIBLITY ${formatCurrency(ptRespSum)}. NEGOTIATION AND IDR DONE. `;
            } else {
                noteWarningNoEOB.style.display = 'block';
                let claimForNote = (activeIdrRows.length > 0) ? activeIdrRows[0].claimNum : 'N/A';
                note += `CLAIM: ${claimForNote}. NEGOTIATION AND IDR DONE. `;
            }

            // --- IDR Details (NEW LOGIC) ---
            activeIdrRows.forEach(row => {
                let wlStatus = (row.winLoseStatus === '--' || row.winLoseStatus === 'not found' || row.winLoseStatus === '') ? 'N/A' : row.winLoseStatus.toUpperCase();
                
                // NEW: Handle "CLOSED" status
                if (wlStatus === 'CLOSED' || wlStatus === 'CLOSE') {
                    note += `${row.idrNum}: STATUS IS ${wlStatus}. `;
                    // Only mention refund
                    if (row.refundStatus.toLowerCase() === 'received') {
                        note += "WE RECEIVED FEE REFUND. ";
                    } else if (row.refundStatus.toLowerCase() === 'waiting') {
                        note += "WE ARE WAITING FOR FEE REFUND. ";
                    }
                } else {
                    // Standard Win/Lose logic
                    note += `${row.idrNum}: IDR SUBMITTED ON CPT ${row.cpt} TO MEDIATOR ${row.mediator}. STATUS IS ${wlStatus} WITH ADDITIONAL ${row.addlPmt}. `;
                    
                    if (row.additionalStatus.toLowerCase() === 'received') {
                        note += "WE RECEIVED ADDITIONAL PAYMENT. ";
                    } else {
                        note += "WE ARE WAITING FOR ADDITIONAL PAYMENT. ";
                    }
                    
                    if (row.winLoseStatus === 'win') {
                        if (row.refundStatus.toLowerCase() === 'received') {
                            note += "WE RECEIVED FEE REFUND. ";
                        } else {
                            note += "WE ARE WAITING FOR FEE REFUND. ";
                        }
                    }
                }
            });
            
            // --- Final Action ---
            if (initial === 'FINAL REVIEW') {
                note += "NO FURTHER ACTION NEEDED. BALANCE TO BE ADJUSTED.";
                
                if(eobExists) {
                    const adjustWithPtVal = eobBilled - (eobPaid + ptRespSum);
                    const adjustWithoutPtVal = eobBilled - eobPaid;
                    adjustWithPt.textContent = formatCurrency(adjustWithPtVal);
                    adjustWithoutPt.textContent = formatCurrency(adjustWithoutPtVal);
                    finalReviewAdjustments.style.display = 'block';
                }
            } else {
                note += "WAITING TO COMPLETE THE IDR PROCESS BEFORE ADJUSTMENT.";
                finalReviewAdjustments.style.display = 'none';
            }
            
            noteTextInput.value = note.trim().toUpperCase();
        }
        
        // --- Mail Generation Function ---
        function generateMail() {
            mailTypeInput.classList.remove('is-invalid');
            mailDetermDateInput.classList.remove('is-invalid');
            mailTextInput.value = ''; 
            mailNoteTextInput.value = ''; 
            mailTextInput.classList.remove('bg-match', 'text-success', 'is-invalid');

            const eobExists = globalEobData.updated || globalEobData.old;
            const idrRows = document.querySelectorAll('#idrDataTableBody tr');
            
            if (!eobExists) {
                mailTextInput.value = "ERROR: EOB Data is missing. Please paste the EOB text.";
                mailTextInput.classList.add('is-invalid');
                return;
            }
            if (idrRows.length === 0) {
                mailTextInput.value = "ERROR: No IDR results found. Please extract IDR data first.";
                mailTextInput.classList.add('is-invalid');
                return;
            }
            if (idrRows.length > 1) {
                mailTextInput.value = "ERROR: Mail Generation only works for a single IDR result. Please process only one IDR entry.";
                mailTextInput.classList.add('is-invalid');
                return;
            }
            
            const emailType = mailTypeInput.value;
            if (emailType === "") {
                mailTypeInput.classList.add('is-invalid');
                mailTextInput.value = "ERROR: Please select an Email Type (1st or 2nd).";
                return;
            }
            const determDate = mailDetermDateInput.value.trim();
            const dateRegex = /^\d{1,2}\/\d{1,2}\/\d{2,4}$/;
            if (determDate === "" || determDate === "--" || !dateRegex.test(determDate)) {
                mailDetermDateInput.classList.add('is-invalid');
                mailTextInput.value = "ERROR: Determination Date is missing or invalid. Please correct it.";
                return;
            }
            
            const idrRow = idrRows[0];
            const additionalStatus = idrRow.cells[14].textContent; 

            if (additionalStatus.toLowerCase() === 'received') {
                mailTextInput.value = "WARNING: Additional Payment is already marked as 'Received'. Email is not required.";
                mailTextInput.classList.add('bg-match', 'text-success');
                return;
            }
            
            const provider = globalEobData.updated?.provider || globalEobData.old?.provider || 'Not Found';
            let eobClaim = globalEobData.updated?.claimNo || globalEobData.old?.claimNo || 'Not Found';
            
            const idrNum = idrRow.cells[2].textContent;
            const idrClaim = idrRow.cells[3].textContent; 
            const cpt = idrRow.cells[4].textContent;
            const initialPmt = idrRow.cells[5].textContent; 
            const mediator = idrRow.cells[6].textContent; 
            const addlPmt = idrRow.cells[9].textContent; 
            
            let finalClaim = (eobClaim !== '--' && eobClaim !== 'Not Found') ? eobClaim : idrClaim;
            
            const myName = mailNameInput.value || 'Pranto Rodrix';
            const myInitial = mailInitialInput.value || 'PRANTO R'; 

            const initialPmtNum = parseCurrency(initialPmt);
            const addlPmtNum = parseCurrency(addlPmt);
            const oonRateNum = initialPmtNum + addlPmtNum; 

            let subject = `Urgent Request for Claim Reprocessing as per IDR Determination - ${idrNum} and Claim Number: ${finalClaim}`;
            if (emailType === '2nd Email') {
                subject += " (2nd Email)";
            }
            mailSubjectInput.value = subject;
            
            let mailBody = currentEmailTemplate; // Use the potentially edited template
            
            mailBody = mailBody.replace(/\[DETERMINATION_DATE\]/g, determDate); 
            mailBody = mailBody.replace(/\[MEDIATOR_NAME\]/g, mediator);
            mailBody = mailBody.replace(/\[PROVIDER_NAME\]/g, provider);
            mailBody = mailBody.replace(/\[OON_RATE\]/g, formatCurrency(oonRateNum));
            mailBody = mailBody.replace(/\[CPT_CODE\]/g, cpt);
            mailBody = mailBody.replace(/\[CLAIM_NUMBER\]/g, finalClaim);
            mailBody = mailBody.replace(/\[INITIAL_PAYMENT\]/g, formatCurrency(initialPmtNum));
            mailBody = mailBody.replace(/\[OUTSTANDING_BALANCE\]/g, formatCurrency(addlPmtNum));
            mailBody = mailBody.replace(/\[MY_NAME\]/g, myName);
            
            mailTextInput.value = mailBody.trim();

            const today = getFormattedDate(); 
            let noteType = (emailType === '1st Email') ? "1st FOLLOW UP" : "2nd FOLLOW UP";
            
            let emailNote = `${today}>IDR FOLLOW UP>${myInitial}>WORKING ON IDR TRACKING SHEET. NEGOTIATION AND IDR DONE. ACCORDING TO OUR RECORDS, FOR ${finalClaim}; WE HAVE NOT RECEIVED THE ADDITIONAL PAYMENT AMOUNT OF ${formatCurrency(addlPmtNum)} AND THE UPDATED EOB, AS PER THE DETERMINATION OF ${idrNum}, BY ${mediator} DATED ${determDate}. FOR BCBS ATTENTION, WE SENT ${noteType} EMAIL TO BCBS FOR THE IDR ADDITIONAL PAYMENT.`;
            
            mailNoteTextInput.value = emailNote.trim().toUpperCase();
        }

        // --- Table Input Autocomplete ---

        function autocompleteRefund(input) {
            const value = input.value.toLowerCase();
            if (value === 'r') input.value = 'Received';
            if (value === 'w') input.value = 'Waiting';
            
            if (input.value !== '') {
                input.classList.remove('is-invalid');
                input.closest('td').classList.remove('bg-mismatch');
            }
        }
        window.autocompleteRefund = autocompleteRefund; // গ্লোবাল করা হলো
        
        document.getElementById('idrDataTableBody').addEventListener('input', function(e) {
            const target = e.target;
            
            if (target.classList.contains('refund-input')) {
                autocompleteRefund(target);
            }
            
            if (target.classList.contains('win-lose-input')) {
                const value = target.value.toLowerCase();
                if (value === 'w') target.value = 'Win';
                if (value === 'l') target.value = 'Lose';
                if (value === 'c') target.value = 'Closed';
                
                const tr = target.closest('tr');
                const refundInput = tr.querySelector('.refund-input');
                const refundCell = refundInput.closest('td');
                const newStatus = target.value.toLowerCase();
                
                if (newStatus === 'win') {
                    refundInput.disabled = false;
                    if (refundInput.value === '') {
                        refundCell.classList.add('bg-mismatch');
                        refundInput.classList.add('is-invalid');
                    } else {
                         refundCell.classList.remove('bg-mismatch');
                         refundInput.classList.remove('is-invalid');
                    }
                } else if (newStatus === 'lose') {
                    refundInput.disabled = true;
                    refundInput.value = '';
                    refundCell.classList.remove('bg-mismatch');
                    refundInput.classList.remove('is-invalid');
                } else if (newStatus === 'closed' || newStatus === 'close') {
                    refundInput.disabled = false; 
                    refundCell.classList.remove('bg-mismatch'); 
                    refundInput.classList.remove('is-invalid');
                } else {
                    refundInput.disabled = false;
                    refundCell.classList.remove('bg-mismatch');
                    refundInput.classList.remove('is-invalid');
                }
            }
        });

    </script>
</body>
</html>
