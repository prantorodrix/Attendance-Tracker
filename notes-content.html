<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Website</title>
    
    <!-- Google Font: Poppins & Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* --- 1. Premium Navbar Styles --- */
        body {
            font-family: 'Poppins', sans-serif; /* Default font */
            background-color: #f4f7f6;
        }

        .premium-navbar {
            background-color: #1a1a1a; /* Dark premium background */
            padding: 1rem 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .premium-navbar .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            /* Gradient Logo Text */
            background: linear-gradient(to right, #6a11cb 0%, #2575fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent; /* Fallback */
        }

        .premium-navbar .nav-link {
            color: #ccc; /* Light text color */
            font-weight: 500;
            margin: 0 0.5rem;
            position: relative;
            transition: color 0.3s ease;
            cursor: pointer; /* Change cursor for JS links */
        }

        /* Hover Animation: Underline */
        .premium-navbar .nav-link::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, #6a11cb 0%, #2575fc 100%);
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.3s ease-out;
        }

        .premium-navbar .nav-link:hover {
            color: #fff; /* Brighter text on hover */
        }

        .premium-navbar .nav-link:hover::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        .premium-navbar .nav-link.active {
            color: #fff;
            font-weight: 600;
        }
        
        .premium-navbar .nav-link.active::after {
             transform: scaleX(1); /* Keep underline for active */
             transform-origin: bottom left;
        }

        /* Premium Button */
        .btn-premium {
            background-image: linear-gradient(to right, #6a11cb 0%, #2575fc 100%);
            color: #fff;
            border: none;
            border-radius: 50px;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(106, 17, 203, 0.3);
        }

        .btn-premium:hover {
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(106, 17, 203, 0.5);
        }
        
        /* --- 2. Home Page Hero Section Style --- */
        .hero-section {
            background: linear-gradient(to right, #141e30, #243b55);
            color: white;
            padding: 8rem 0;
            text-align: center;
        }
        .hero-section h1 {
            font-size: 3.5rem;
            font-weight: 700;
        }
        .hero-section p {
            font-size: 1.25rem;
            color: #ccc;
        }

        /* --- 3. EOB/IDR Processor Styles --- */
        .eob-content {
            padding-top: 30px; 
            font-family: 'Inter', sans-serif; /* EOB tool uses Inter font */
        }
        .card {
            margin-bottom: 25px;
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        .card:last-child {
            margin-bottom: 0;
        }
        
        /* NEW: Result List Styles */
        .result-list {
            font-size: 0.9rem; /* Smaller font */
        }
        .result-list p {
            margin-bottom: 0.5rem; /* Tighter spacing */
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            white-space: nowrap; /* No line wrap */
        }
         .result-list p:last-child {
            border-bottom: none;
            margin-bottom: 0;
         }
        .result-list strong {
            color: #343a40;
            margin-right: 10px;
        }
        .result-list .output-value {
            font-weight: bold;
            color: #28a745;
            text-align: right;
        }
        .result-list .output-value.text-dark {
             color: #212529 !important;
        }

        /* NEW: IDR Result Table Style */
        .result-table {
            font-size: 0.9rem; /* Smaller font */
        }
        .result-table th, .result-table td {
            vertical-align: middle;
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            white-space: nowrap; /* No line wrap */
        }
        /* Header cells */
        .result-table thead th { 
            background-color: #e9ecef;
            text-align: left;
        }
        /* Body row header cells */
         .result-table tbody th {
            font-weight: bold;
            color: #212529;
            text-align: left;
         }
         /* Body data cells */
         .result-table td {
            font-weight: bold;
            color: #212529;
            text-align: left; /* NEW: Left align results */
         }
        .result-table .output-value-amount {
            color: #28a745;
        }

        textarea {
            border-radius: 8px;
            font-family: monospace;
            min-height: 200px; /* EOB Text Area */
        }
        
        .idr-textarea {
             min-height: 100px; /* Smaller IDR boxes */
        }
        
        /* NEW: Comparison BG Colors */
        .bg-match { 
            background-color: #d4edda !important; /* light green */
            border-radius: 5px;
        }
        .bg-mismatch { 
            background-color: #f8d7da !important; /* light red */
            border-radius: 5px;
        }
        .bg-overpaid { 
            background-color: #fff3cd !important; /* light yellow */
            border-radius: 5px;
        }
        
        /* Comparison for list view */
        .result-list .output-value.bg-match,
        .result-list .output-value.bg-mismatch,
        .result-list .output-value.bg-overpaid {
             padding: 2px 6px;
        }
        
        /* NEW: Editable input styles */
        .editable-input {
            width: 100px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
        }
        .editable-input:disabled {
            background-color: #e9ecef;
            border-color: #dee2e6;
        }
        
        /* NEW: Error animation */
        @keyframes shake-red {
            0% { transform: translateX(0); box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25); }
            25% { transform: translateX(5px); }
            50% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
            100% { transform: translateX(0); box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0); }
        }
        .is-invalid {
            border-color: #dc3545;
            /* animation: shake-red 0.5s ease-out; */
        }
        .form-control.is-invalid, .form-select.is-invalid {
             border-color: #dc3545;
             animation: shake-red 0.5s ease-out;
        }
        .editable-input.is-invalid {
            background-color: #f8d7da;
        }
        
        /* NEW: Sticky Column CSS */
        .result-table th:nth-child(1), .result-table td:nth-child(1), /* Result # */
        .result-table th:nth-child(2), .result-table td:nth-child(2), /* Ticket # */
        .result-table th:nth-child(3), .result-table td:nth-child(3), /* IDR # */
        .result-table th:nth-child(4), .result-table td:nth-child(4),  /* Claim # */
        .result-table th:nth-child(5), .result-table td:nth-child(5)  /* CPT */
        {
            position: sticky;
            z-index: 2;
        }
        
        /* Define widths and sticky positions */
        .result-table th:nth-child(1), .result-table td:nth-child(1) { left: 0; min-width: 100px; }
        .result-table th:nth-child(2), .result-table td:nth-child(2) { left: 100px; min-width: 120px; }
        .result-table th:nth-child(3), .result-table td:nth-child(3) { left: 220px; min-width: 120px; }
        .result-table th:nth-child(4), .result-table td:nth-child(4) { left: 340px; min-width: 150px; } /* Claim # */
        .result-table th:nth-child(5), .result-table td:nth-child(5) { left: 490px; min-width: 80px; } /* CPT */


        /* Sticky column backgrounds */
        .result-table thead th {
            background-color: #cfe2ff; /* table-primary */
        }
         /* Sticky body header (Result #) */
        .result-table tbody th {
            background-color: #f8f9fa; /* Row header bg */
        }
        /* Sticky body data cells need solid background */
        .result-table tbody td:nth-child(2),
        .result-table tbody td:nth-child(3),
        .result-table tbody td:nth-child(4),
        .result-table tbody td:nth-child(5) {
             background-color: #ffffff;
        }
        
        /* NEW: Note Generation Section */
        #note_Text, #note_Mail_Text, #mail_Note_Text {
            min-height: 200px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        /* NEW: Accordion Button Style */
        .accordion-button {
            padding: 1rem 1.25rem;
        }
        .accordion-button:not(.collapsed) {
            color: #0c63e4;
            background-color: #e7f1ff;
        }
        .accordion-button:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        /* NEW: Click-to-copy style */
        .form-control[readonly].copyable {
            cursor: pointer;
            background-color: #e9ecef;
        }
        .form-control[readonly].copyable:hover {
            background-color: #dde6ef;
        }
        
        /* NEW: Copyable textarea */
        #note_Text.copyable, #mail_Note_Text.copyable, #mail_Note_Text.copyable {
            cursor: pointer;
        }
        #note_Text.copyable:hover, #mail_Note_Text.copyable:hover, #note_Mail_Text.copyable:hover {
            background-color: #f8f9fa;
        }
        
        /* NEW: Button hover styles */
        #note_CopyBtn:hover {
            background-color: #157347;
        }
         #note_Mail_CopyBtn:hover {
            background-color: #1a8a8a;
        }
        
        /* NEW: Timezone Selector */
        .timezone-selector {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            z-index: 10;
        }
        .timezone-selector .form-check-label {
            font-size: 0.8rem;
            font-weight: 600;
        }
        .timezone-selector .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

    </style>
</head>
<body>

    <!-- Premium Menubar (REMOVED) -->
    
    <!-- SECTION 1: Home Page Content (REMOVED) -->
    
    <!-- SECTION 2: Dashboard (EOB Tool) Content -->
    <!-- NEW: Made visible, reduced padding (my-3 px-4) -->
    <div id="dashboard-page" class="container-fluid eob-content my-3 px-4">

        <!-- NEW: Timezone Selector (REMOVED) -->
        <!--
        <div class="timezone-selector card p-2 shadow-sm">
            ...
        </div>
        -->

        <!-- NEW: 4-Column EOB Layout, reduced gap (g-3) -->
        <div class="row g-3">
            
            <!-- Column 1: Input Area -->
            <div class="col-3">
                <!-- Section 1: Input Card -->
                <div class="card p-4 h-100 d-flex flex-column">
                    <!-- EOB Input -->
                    <div class="mb-3 flex-grow-1 d-flex flex-column">
                        <label for="eobTextInput" class="form-label fw-bold">Full EOB Text:</label>
                        <textarea class="form-control h-100" id="eobTextInput" 
                                  placeholder="Patient Information
Patient: ROMERO, ELVIRA
Patient Account Number: TKT12345
..."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Column 2: EOB Output Area 1 -->
            <div class="col-3">
                <!-- EOB Output Card 1 -->
                <div class="card p-4 h-100">
                    <h5 class="text-success fw-bold">EOB Results (1)</h5>
                    <hr>
                    <div id="eob-results-list-1" class="result-list">
                        <p><strong>Ticket #:</strong> <span id="eob_Ticket" class="output-value text-dark">--</span></p>
                        <p><strong>Patient:</strong> <span id="eob_Patient" class="output-value text-dark">--</span></p>
                        <p><strong>Claim #:</strong> <span id="eob_Claim" class="output-value text-dark">--</span></p>
                        <p><strong>Billed:</strong> <span id="eob_Billed" class="output-value">--</span></p>
                    </div>
                </div>
            </div>
            
            <!-- Column 3: EOB Output Area 2 -->
            <div class="col-3">
                 <!-- EOB Output Card 2 -->
                <div class="card p-4 h-100">
                     <h5 class="text-success fw-bold">EOB Results (2)</h5>
                     <hr>
                    <div id="eob-results-list-2" class="result-list">
                        <p><strong>Paid:</strong> <span id="eob_Paid" class="output-value">--</span></p>
                        <!-- NEW: Field swap -->
                        <p><strong>PT Responsibility:</strong> <span id="eob_PtResp_Sum" class="output-value">--</span></p>
                        <p><strong>Provider:</strong> <span id="eob_Provider" class="output-value text-dark">--</span></p>
                        <p><strong>Addl. Paid:</strong> <span id="eob_AddlPaid" class="output-value">--</span></p>
                    </div>
                </div>
            </div>

            <!-- Column 4: Buttons -->
            <div class="col-3">
                <!-- Button Card -->
                <div class="card p-3 h-100 d-flex flex-column justify-content-center">
                     <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary btn-lg w-100 rounded-pill" id="processButton">
                            <i class="bi bi-magic"></i> Extract
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-lg w-100 rounded-pill" id="clearButton">
                           Clear
                        </button>
                        <a href="index.html" ><button type="button" class="btn btn-dark btn-sm rounded-lg shadow-md w-100">
                           <i class="bi bi-check2-circle"></i> Back to Main Page
                        </button></a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- NEW: IDR Section Rows, reduced gap (g-3 mt-3) -->
        <div class="row g-3 mt-3">
            <!-- IDR Input Accordion -->
            <div class="col-12">
                <div class="accordion" id="idrInputAccordion">
                    <!-- IDR 2024+ -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingIdr2024">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIdr2024" aria-expanded="true" aria-controls="collapseIdr2024">
                                <span class="h5 mb-0 fw-bold text-primary">IDR Inputs (2024+)</span>
                            </button>
                        </h2>
                        <div id="collapseIdr2024" class="accordion-collapse collapse show" aria-labelledby="headingIdr2024">
                            <div class="accordion-body">
                                 <div class="row g-3">
                                     <div class="col-3">
                                        <label for="idrTextInput1" class="form-label fw-bold">IDR Text 1:</label>
                                        <textarea class="form-control idr-textarea" id="idrTextInput1" rows="3"></textarea>
                                    </div>
                                     <div class="col-3">
                                        <label for="idrTextInput2" class="form-label fw-bold">IDR Text 2:</label>
                                        <textarea class="form-control idr-textarea" id="idrTextInput2" rows="3"></textarea>
                                    </div>
                                     <div class="col-3">
                                        <label for="idrTextInput3" class="form-label fw-bold">IDR Text 3:</label>
                                        <textarea class="form-control idr-textarea" id="idrTextInput3" rows="3"></textarea>
                                    </div>
                                     <div class="col-3">
                                        <label for="idrTextInput4" class="form-label fw-bold">IDR Text 4:</label>
                                        <textarea class="form-control idr-textarea" id="idrTextInput4" rows="3"></textarea>
                                    </div>
                                 </div>
                            </div>
                        </div>
                    </div>
                    <!-- IDR 2022-23 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingIdr2022">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIdr2022" aria-expanded="false" aria-controls="collapseIdr2022">
                                <span class="h5 mb-0 fw-bold text-primary">IDR Inputs (2022-23)</span>
                            </button>
                        </h2>
                        <div id="collapseIdr2022" class="accordion-collapse collapse" aria-labelledby="headingIdr2022">
                            <div class="accordion-body">
                                 <div class="row g-3">
                                     <div class="col-3">
                                        <label for="idr2022TextInput1" class="form-label fw-bold">IDR Text 1 (22-23):</label>
                                        <textarea class="form-control idr-textarea" id="idr2022TextInput1" rows="3"></textarea>
                                    </div>
                                     <div class="col-3">
                                        <label for="idr2022TextInput2" class="form-label fw-bold">IDR Text 2 (22-23):</label>
                                        <textarea class="form-control idr-textarea" id="idr2022TextInput2" rows="3"></textarea>
                                    </div>
                                     <div class="col-3">
                                        <label for="idr2022TextInput3" class="form-label fw-bold">IDR Text 3 (22-23):</label>
                                        <textarea class="form-control idr-textarea" id="idr2022TextInput3" rows="3"></textarea>
                                    </div>
                                     <div class="col-3">
                                        <label for="idr2022TextInput4" class="form-label fw-bold">IDR Text 4 (22-23):</label>
                                        <textarea class="form-control idr-textarea" id="idr2022TextInput4" rows="3"></textarea>
                                    </div>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- IDR Output Card -->
            <div class="col-12">
                 <div class="card p-4">
                     <h5 class="text-primary fw-bold">IDR Results</h5>
                     <hr>
                     <div class="table-responsive">
                        <table class="table table-striped table-bordered result-table" id="idrResultTable">
                            <thead id="idrDataTableHeader">
                                <!-- Header generated by JS -->
                                <tr class="table-primary">
                                    <th scope="col" class="sticky-col" style="left: 0;">Result #</th>
                                    <th scope="col" class="sticky-col" style="left: 100px;">Ticket #</th>
                                    <th scope="col" class="sticky-col" style="left: 220px;">IDR #</th>
                                    <th scope="col" class="sticky-col" style="left: 340px;">Claim #</th>
                                    <th scope="col" class="sticky-col" style="left: 490px;">CPT</th>
                                    <th scope="col">Initial Pmt</th>
                                    <th scope="col">Mediator</th>
                                    <th scope="col">Determ. Date</th>
                                    <th scope="col">Determ. W/L</th> <!-- Renamed -->
                                    <th scope="col">Addl. Pmt</th>
                                    <th scope="col">Pmt Date</th>
                                    <th scope="col">Fee Refund</th>
                                    <th scope="col">Fee Refund Date</th>
                                    <!-- Status and Status Date Removed -->
                                    <!-- NEW Summary Columns -->
                                    <th scope="col">W/L (Manual)</th>
                                    <th scope="col">Additional</th>
                                    <th scope="col">Refund</th>
                                </tr>
                            </thead>
                            <tbody id="idrDataTableBody">
                                <!-- Body generated by JS -->
                            </tbody>
                        </table>
                    </div>
                 </div>
            </div>

            <!-- NEW: Final Note Section (Accordion) -->
            <div class="col-12">
                <div class="accordion" id="noteAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                <span class="h5 mb-0 fw-bold">Final Review_Win_Lose_Follow Up</span>
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#noteAccordion">
                            <div class="accordion-body">
                                <div class="row g-3">
                                    <div class="col-3">
                                        <label for="note_Name" class="form-label fw-bold">Name:</label>
                                        <input type="text" class="form-control" id="note_Name" value="PRANTO R">
                                        <label for="note_Initial" class="form-label fw-bold mt-2">Initial:</label>
                                        <input type="text" class="form-control" id="note_Initial">
                                        <!-- NEW: Final Review Adjustment Lines -->
                                        <div id="finalReviewAdjustments" class="mt-2" style="display: none;">
                                            <h6 class="text-decoration-underline" style="font-size: 0.9rem;">Adjustments:</h6>
                                            <p class="mb-1 result-list" style="font-size: 0.85rem;"><strong>Adjust with PT:</strong> <span id="adjustWithPt" class="output-value">--</span></p>
                                            <p class="mb-0 result-list" style="font-size: 0.85rem;"><strong>Adjust Without PT:</strong> <span id="adjustWithoutPt" class="output-value">--</span></p>
                                        </div>
                                        <!-- NEW: Note Warnings -->
                                        <div id="note_Warning_NoEOB" class="text-danger fw-bold mt-2" style="font-size: 0.9rem; display: none;">No EOB Found.</div>
                                        <div id="note_Warning_ClaimMismatch" class="text-danger fw-bold mt-2" style="font-size: 0.9rem; display: none;">IDR Claim numbers Didn't Match..</div>
                                    </div>
                                    <div class="col-7">
                                        <label for="note_Text" class="form-label fw-bold">Correspondence Note: (Click to Copy)</label>
                                        <textarea class="form-control copyable" id="note_Text" rows="10" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Note')"></textarea>
                                    </div>
                                    <div class="col-2 d-flex flex-column justify-content-end">
                                         <!-- NEW: Generate Note Button -->
                                         <button class="btn btn-info rounded-pill w-100 mb-2" id="note_GenerateBtn">
                                             <i class="bi bi-pencil-square"></i> Generate Note
                                         </button>
                                         <!-- Removed Copy Button -->
                                         <span id="copy_Confirmation_Note" class="text-success text-center fw-bold mt-1" style="display: none;">Copied!</span>
                                         <button class="btn btn-outline-secondary rounded-pill w-100 mt-2" id="note_ClearBtn">
                                             <i class="bi bi-x-circle"></i> Clear Note
                                         </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

             <!-- NEW: Mail Generator Section -->
            <div class="col-12">
                <div class="accordion" id="mailAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingMail">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMail" aria-expanded="false" aria-controls="collapseMail">
                                <span class="h5 mb-0 fw-bold">Auto Email Generator</span>
                            </button>
                        </h2>
                        <div id="collapseMail" class="accordion-collapse collapse" aria-labelledby="headingMail" data-bs-parent="#mailAccordion">
                            <div class="accordion-body">
                                <!-- Row for Inputs -->
                                <div class="row g-3 mb-3">
                                    <div class="col-3">
                                        <label for="note_Mail_Name" class="form-label fw-bold">My Name:</label>
                                        <input type="text" class="form-control" id="note_Mail_Name" value="Pranto Rodrix">
                                        <label for="note_Mail_Initial" class="form-label fw-bold mt-2">My Initial:</label>
                                        <input type="text" class="form-control" id="note_Mail_Initial" value="PRANTO R">
                                    </div>
                                    <div class="col-3">
                                        <label for="note_Mail_To" class="form-label fw-bold">To: (Click to copy)</label>
                                        <input type="email" class="form-control copyable" id="note_Mail_To" value="nsa.disputes@bcbstx.com" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Mail')">
                                        <label for="note_Mail_CC" class="form-label fw-bold mt-2">CC: (Click to copy)</label>
                                        <input type="email" class="form-control copyable" id="note_Mail_CC" value="mislam@roundtmc.com, razo@leverngear.com" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Mail')">
                                    </div>
                                    <div class="col-4">
                                        <label for="note_Mail_Subject" class="form-label fw-bold">Subject: (Click to Copy)</label>
                                        <input type="text" class="form-control copyable" id="note_Mail_Subject" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Mail')">
                                        
                                        <!-- NEW: Determination Date -->
                                        <label for="note_Mail_Determ_Date" class="form-label fw-bold mt-2">Determination Date:</label>
                                        <input type="text" class="form-control" id="note_Mail_Determ_Date" placeholder="Auto-fills from IDR Result 1">
                                    </div>
                                    <div class="col-2">
                                        <label for="note_Mail_Type" class="form-label fw-bold">Email Type:</label>
                                        <select class="form-select" id="note_Mail_Type">
                                            <option value="" selected>Select...</option>
                                            <option value="1st Email">1st Email</option>
                                            <option value="2nd Email">2nd Email</option>
                                        </select>
                                         <button class="btn btn-secondary w-100 mt-2" data-bs-toggle="modal" data-bs-target="#emailTemplateModal">
                                            <i class="bi bi-pencil"></i> Edit Template
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Row for Mail Body, Note, and Buttons -->
                                <div class="row g-3">
                                    <!-- Mail Body -->
                                    <div class="col-6">
                                        <label for="note_Mail_Text" class="form-label fw-bold">Mail Body: (Click to Copy)</label>
                                        <textarea class="form-control copyable" id="note_Mail_Text" rows="10" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Mail')"></textarea>
                                    </div>
                                     <!-- Email Note -->
                                    <div class="col-4">
                                        <label for="mail_Note_Text" class="form-label fw-bold">Note for Email: (Click to Copy)</label>
                                        <textarea class="form-control copyable" id="mail_Note_Text" rows="10" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Mail')"></textarea>
                                    </div>
                                    <!-- Mail Buttons -->
                                    <div class="col-2 d-flex flex-column justify-content-start">
                                         <button class="btn btn-info rounded-pill w-100 mb-2" id="note_Mail_GenerateBtn">
                                             <i class="bi bi-pencil-square"></i> Generate
                                         </button>
                                         <span id="copy_Confirmation_Mail" class="text-success text-center fw-bold mt-1 mb-2" style="display: none;">Copied!</span>
                                         <button class="btn btn-outline-secondary rounded-pill w-100" id="note_Mail_ClearBtn">
                                             <i class="bi bi-x-circle"></i> Clear
                                         </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    
    <!-- NEW: Email Edit Modal -->
    <div class="modal fade" id="emailTemplateModal" tabindex="-1" aria-labelledby="emailTemplateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emailTemplateModalLabel">Edit Email Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Edit the template below. The placeholders like [CLAIM_NUMBER] will be filled automatically.</p>
                    <textarea id="email_Template_Text" class="form-control" rows="20"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Save Template</button>
                </div>
            </div>
        </div>
    </div>

    
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Page Navigation & EOB Logic Script -->
    <script>
        // --- 1. Page Navigation Logic (REMOVED) ---
        
        // --- 2. Data Extraction Logic ---
        
        // NEW: Formats a number into currency (e.g., 1500.5 => $1,500.50)
        function formatCurrency(num) {
            if (isNaN(num)) {
                num = 0;
            }
            // Ensure commas are added
            return '$' + num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // NEW: Helper function to find a value by label, skipping empty lines
        function extractValueSkippingLines(text, labelRegex) {
            const match = text.match(labelRegex);
            if (!match) return null;

            const labelEndIndex = match.index + match[0].length;
            const subsequentText = text.substring(labelEndIndex);
            
            const lines = subsequentText.split(/[\r\n]+/);
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (trimmedLine.length > 0) {
                    if (trimmedLine.match(/^[a-zA-Z\s\.\/()-]+:/)) {
                        continue; 
                    }
                    return trimmedLine; 
                }
            }
            return null; // No value found
        }
        
        function parseCurrency(value) {
            if (typeof value !== 'string') return 0;
            const cleaned = value.replace(/[$,\s]/g, '');
            return parseFloat(cleaned) || 0;
        }
        
        function getColumnValue(columns, index) {
            if (columns && columns.length > index && columns[index] !== "") {
                return columns[index].trim();
            }
            return "--";
        }
        
        // NEW: Date formatting function
        function getFormattedDate() {
            // REMOVED Timezone Toggle
            // Force BD Time (UTC+6)
            const now = new Date();
            // Simulating BD time by adding 6 hours to UTC. 
            // This is a simple approximation. A library like 'moment-timezone' is needed for perfect accuracy.
            // For now, we'll use the client's local date but format it as mm/dd/yy
            const bdTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Dhaka' }));
            
            const mm = String(bdTime.getMonth() + 1).padStart(2, '0');
            const dd = String(bdTime.getDate()).padStart(2, '0');
            const yy = String(bdTime.getFullYear()).slice(-2);
            
            // Force mm/dd/yy format
            return `${mm}/${dd}/${yy}`;
        }

        // --- Get EOB Cell Elements ---
        const eobTicketCell = document.getElementById('eob_Ticket');
        const eobAddlPaidCell = document.getElementById('eob_AddlPaid');
        
        // --- NEW: Note Generation Elements ---
        const noteNameInput = document.getElementById('note_Name');
        const noteInitialInput = document.getElementById('note_Initial');
        const noteTextInput = document.getElementById('note_Text');
        const noteGenerateBtn = document.getElementById('note_GenerateBtn'); 
        const noteClearBtn = document.getElementById('note_ClearBtn');
        const copyConfirmationNote = document.getElementById('copy_Confirmation_Note'); // Renamed
        const finalReviewAdjustments = document.getElementById('finalReviewAdjustments'); 
        const adjustWithPt = document.getElementById('adjustWithPt');
        const adjustWithoutPt = document.getElementById('adjustWithoutPt');
        const noteWarningNoEOB = document.getElementById('note_Warning_NoEOB'); 
        const noteWarningClaimMismatch = document.getElementById('note_Warning_ClaimMismatch'); 
        
        // --- NEW: Mail Generation Elements ---
        const mailNameInput = document.getElementById('note_Mail_Name');
        const mailInitialInput = document.getElementById('note_Mail_Initial'); // NEW
        const mailToInput = document.getElementById('note_Mail_To');
        const mailCcInput = document.getElementById('note_Mail_CC');
        const mailTypeInput = document.getElementById('note_Mail_Type');
        const mailSubjectInput = document.getElementById('note_Mail_Subject');
        const mailDetermDateInput = document.getElementById('note_Mail_Determ_Date'); // NEW
        const mailGenerateBtn = document.getElementById('note_Mail_GenerateBtn');
        const mailClearBtn = document.getElementById('note_Mail_ClearBtn');
        const mailTextInput = document.getElementById('note_Mail_Text');
        const mailNoteTextInput = document.getElementById('mail_Note_Text'); // NEW
        const copyConfirmationMail = document.getElementById('copy_Confirmation_Mail'); // NEW
        const emailTemplateText = document.getElementById('email_Template_Text');

        // NEW: Default Email Template
        const defaultEmailTemplate = `Dear BCBS,

We are writing to formally request the prompt payment of the additional reimbursement as required by the final determination in the Federal Independent Dispute Resolution (IDR) process under the No Surprises Act (NSA).
On [DETERMINATION_DATE], [MEDIATOR_NAME] —the certified IDR entity—issued a final, legally binding determination in favor of , [PROVIDER_NAME] regarding the above-referenced claim. The IDR entity selected the out-of-network payment amount of [OON_RATE] for service code [CPT_CODE]. as offered by [PROVIDER_NAME] as the appropriate rate for this claim.
According to the NSA and its implementing regulations (including 45 CFR 149.510(c)(4)(vii)), the plan or issuer must pay the balance of the total plan or coverage amount selected by the certified IDR entity, less any initial payment already made and any applicable patient cost-sharing, within 30 calendar days of the determination notification. As of today, this payment is outstanding.

Request for Payment:
Please remit the outstanding balance, calculated as follows:
Claim Number: [CLAIM_NUMBER]
IDR-Determined OON Rate: [OON_RATE]
Less Initial Payment: [INITIAL_PAYMENT]
------------------------
Total Outstanding Balance: [OUTSTANDING_BALANCE]

This request is made pursuant to the No Surprises Act and its regulations, which require payment of the IDR-determined amount within 30 calendar days of the decision. Failure to remit payment in a timely manner may be reported to the appropriate regulatory authorities for noncompliance
If you have any questions or require additional documentation to process this payment, please contact us at bcbs_nsaandidr@roundtmc.com.

As per Federal guidelines additional payment amounts must be made within 30 days of the determination. If we do not receive the additional payment amount a CMS complaint may be filed. We appreciate your prompt attention to this matter.

For your reference we have attached the primary EOB and IDR determination.


Thank You
Regards
---------------
[MY_NAME]`;
        
        // Load default template into modal
        emailTemplateText.value = defaultEmailTemplate;

        
        // --- EOB Result Clear Function ---
        function clearEobResults() {
             const eobCells = document.querySelectorAll('#eob-results-list-1 .output-value, #eob-results-list-2 .output-value');
            eobCells.forEach(cell => {
                cell.textContent = '--';
                cell.classList.remove('bg-match', 'bg-mismatch', 'bg-overpaid'); // Clear styles
            });
            // Specifically clear the sum field
            document.getElementById('eob_PtResp_Sum').textContent = '--';
        }

        // Function to reset comparison styles
        function clearComparisonStyles() {
            eobTicketCell.classList.remove('bg-match', 'bg-mismatch', 'bg-overpaid');
            eobAddlPaidCell.classList.remove('bg-match', 'bg-mismatch', 'bg-overpaid');
            
            const idrCells = document.querySelectorAll('#idrDataTableBody td');
            idrCells.forEach(cell => {
                cell.classList.remove('bg-match', 'bg-mismatch', 'bg-overpaid');
                const input = cell.querySelector('input');
                if(input) {
                    input.classList.remove('is-invalid');
                    input.closest('td').classList.remove('bg-mismatch'); // Clear red bg on cell
                }
            });
        }
        
        // --- Clear Button Logic ---
        document.getElementById('clearButton').addEventListener('click', function() {
            document.getElementById('eobTextInput').value = '';
            document.getElementById('idrTextInput1').value = '';
            document.getElementById('idrTextInput2').value = '';
            document.getElementById('idrTextInput3').value = '';
            document.getElementById('idrTextInput4').value = ''; 
            document.getElementById('idr2022TextInput1').value = '';
            document.getElementById('idr2022TextInput2').value = '';
            document.getElementById('idr2022TextInput3').value = '';
            document.getElementById('idr2022TextInput4').value = ''; 

            clearEobResults();
            
            document.getElementById('idrDataTableBody').innerHTML = ''; 
            
            // Clear Note section
            noteClearBtn.click();

            clearComparisonStyles();
            
            // Clear mail
            mailClearBtn.click();
        });
        
        // --- Note Section Button Logic ---
        noteTextInput.addEventListener('click', function() {
            copyToClipboard(noteTextInput, 'copy_Confirmation_Note');
        });
        
        noteClearBtn.addEventListener('click', function() {
             noteInitialInput.value = '';
             noteTextInput.value = '';
             finalReviewAdjustments.style.display = 'none'; 
             noteWarningNoEOB.style.display = 'none'; 
             noteWarningClaimMismatch.style.display = 'none'; 
        });
        
        // --- NEW: Generate Note Button Logic ---
        noteGenerateBtn.addEventListener('click', function() {
            validateAndGenerateNote();
        });
        
        // --- NEW: Mail Section Button Logic ---
        mailClearBtn.addEventListener('click', function() {
            mailSubjectInput.value = '';
            mailTextInput.value = '';
            mailNoteTextInput.value = ''; // Clear new note
            mailCcInput.value = 'mislam@roundtmc.com, razo@leverngear.com';
            mailToInput.value = 'nsa.disputes@bcbstx.com';
            mailTypeInput.value = '';
            mailDetermDateInput.value = ''; // Clear new date
            mailTypeInput.classList.remove('is-invalid');
            mailDetermDateInput.classList.remove('is-invalid');
        });
        
        mailGenerateBtn.addEventListener('click', function() {
            generateMail();
        });
        
        mailNoteTextInput.addEventListener('click', function() {
             copyToClipboard(mailNoteTextInput, 'copy_Confirmation_Mail');
        });
        mailTextInput.addEventListener('click', function() {
             copyToClipboard(mailTextInput, 'copy_Confirmation_Mail');
        });
        mailSubjectInput.addEventListener('click', function() {
             copyToClipboard(mailSubjectInput, 'copy_Confirmation_Mail');
        });

        // --- NEW: Click to Copy for Mail ---
        function copyToClipboard(input, confirmationId) {
            input.select();
            document.execCommand('copy');
            
            const confirmationEl = document.getElementById(confirmationId);
            if (confirmationEl) {
                confirmationEl.style.display = 'block';
                setTimeout(() => { confirmationEl.style.display = 'none'; }, 2000);
            }
        }


        // --- Main "Extract All Data" Button ---
        document.getElementById('processButton').addEventListener('click', function() {
            
            clearComparisonStyles();
            noteClearBtn.click(); // Clear note section
            mailClearBtn.click(); // Clear mail section

            // --- 2. Run EOB Tool Logic ---
            const eobText = document.getElementById('eobTextInput').value;
            let ticketNo = 'Not Found', addlPaidAmt = 0; 

            if (eobText.trim() === "") {
                clearEobResults(); 
            } else {
                const ticketNoMatch = eobText.match(/(Patient Account Number|Pt Acct No)\s*:?[\s\r\n]+([^\r\n]+)/i); 
                const ptNameMatch = eobText.match(/(Patient|Pt Name)(?! Information)\s*:?[\s\r\n]+([^\r\n]+)/i); 
                const claimNoMatch = eobText.match(/(Claim I?D|Claim No|Claim Number|Control Number)\s*:?[\s\r\n]+([^\r\n]+)/i); 
                const billingProviderMatch = eobText.match(/(Billing Provider|Provider Name)\s*:?[\s\r\n]+([^\r\n]+)/i);
                
                // FIXED: Use helper function for multi-line gaps for ALL money fields
                const billedStr = extractValueSkippingLines(eobText, /Billed( Amount)?\s*:?/i) || '$0.00';
                const paidStr = extractValueSkippingLines(eobText, /(Plan Paid|Paid Amount)\s*:?/i) || '$0.00'; // FIXED Regex
                const ptRespStr = extractValueSkippingLines(eobText, /(Copay\/Deductible Amount|Copay|Deductible|Responsibility)\s*:?/i) || '$0.00';
                const coinsuranceStr = extractValueSkippingLines(eobText, /(Coinsurance Amount|Coinsurance|Co-insurance)\s*:?/i) || '$0.00';
                const addlPaidStr = extractValueSkippingLines(eobText, /Additional Paid( Amount)?\s*:?/i) || '$0.00';

                ticketNo = ticketNoMatch ? ticketNoMatch[2].trim() : 'Not Found'; 
                const ptName = ptNameMatch ? ptNameMatch[2].trim() : 'Not Found';
                const eobClaimNo = claimNoMatch ? claimNoMatch[2].trim() : 'Not Found'; 
                const billingProvider = billingProviderMatch ? billingProviderMatch[2].trim() : 'Not Found';
                
                const billedAmt = parseCurrency(billedStr); 
                const paidAmt = parseCurrency(paidStr); 
                const coinsuranceAmt = parseCurrency(coinsuranceStr);
                const ptRespAmt = parseCurrency(ptRespStr); // Parse PtResp
                addlPaidAmt = parseCurrency(addlPaidStr); 

                eobTicketCell.textContent = ticketNo; 
                document.getElementById('eob_Patient').textContent = ptName;
                document.getElementById('eob_Claim').textContent = eobClaimNo;
                document.getElementById('eob_Billed').textContent = formatCurrency(billedAmt);
                document.getElementById('eob_Paid').textContent = formatCurrency(paidAmt);
                
                const ptRespSum = ptRespAmt + coinsuranceAmt;
                document.getElementById('eob_PtResp_Sum').textContent = formatCurrency(ptRespSum);

                document.getElementById('eob_Provider').textContent = billingProvider;
                eobAddlPaidCell.textContent = formatCurrency(addlPaidAmt);
            }
            
            // --- 3. Run IDR Tool Logic ---
            const idrTextInputs = [
                { year: '2024+', text: document.getElementById('idrTextInput1').value, map: '2024+' },
                { year: '2024+', text: document.getElementById('idrTextInput2').value, map: '2024+' },
                { year: '2024+', text: document.getElementById('idrTextInput3').value, map: '2024+' },
                { year: '2024+', text: document.getElementById('idrTextInput4').value, map: '2024+' },
                { year: '2022-23', text: document.getElementById('idr2022TextInput1').value, map: '2022-23' },
                { year: '2022-23', text: document.getElementById('idr2022TextInput2').value, map: '2022-23' },
                { year: '2022-23', text: document.getElementById('idr2022TextInput3').value, map: '2022-23' },
                { year: '2022-23', text: document.getElementById('idr2022TextInput4').value, map: '2022-23' }
            ];
            
            // FIXED: Added Claim # to fields and maps
            const idrFields = [
                "Ticket #", "IDR #", "Claim #", "CPT", "Initial Pmt", "Mediator", 
                "Determ. Date", "Determ. W/L", "Addl. Pmt", "Pmt Date", 
                "Fee Refund", "Fee Refund Date",
                "W/L (Manual)", "Additional", "Refund" // Summary Fields
            ];
            
            // Map for 2024+
            const idrFieldIndexMap_2024 = {
                "Ticket #": 2, "IDR #": 1, "Claim #": 3, "CPT": 4, "Initial Pmt": 7, "Mediator": 8,
                "Determ. Date": 16, "Determ. W/L": 17, "Addl. Pmt": 18, "Pmt Date": 19,
                "Fee Refund": 20, "Fee Refund Date": 21,
                "W/L (Manual)": null, "Additional": null, "Refund": null
            };
            
            // NEW: Map for 2022-23
            const idrFieldIndexMap_2022 = {
                "Ticket #": 1, "IDR #": 5, "Claim #": 2, "CPT": 3, "Initial Pmt": 7, "Mediator": 8,
                "Determ. Date": 18, "Determ. W/L": 19, "Addl. Pmt": 20, "Pmt Date": 21,
                "Fee Refund": 22, "Fee Refund Date": 23,
                "W/L (Manual)": null, "Additional": null, "Refund": null
            };
            
            const mapDictionary = {
                '2024+': idrFieldIndexMap_2024,
                '2022-23': idrFieldIndexMap_2022
            };

            const idrTableBody = document.getElementById('idrDataTableBody');
            idrTableBody.innerHTML = ''; 
            
            let allIdrAddlPmts = []; 
            let resultCounter = 1;
            let firstIdrDetermDate = null; // NEW: For email

            idrTextInputs.forEach((input, index) => {
                if (input.text.trim() === "") {
                    return; 
                }
                
                const currentMap = mapDictionary[input.map];
                
                const columns = input.text.split(/\t|\s{2,}/);
                let rowHtml = `<tr><th scope="row" class="sticky-col">Result ${resultCounter} (${input.year})</th>`;
                let rowResult = {}; 

                idrFields.forEach(field => {
                    if (currentMap[field] !== null) {
                        rowResult[field] = getColumnValue(columns, currentMap[field]);
                    }
                });
                
                // NEW: Store first determ date
                if (resultCounter === 1) {
                    firstIdrDetermDate = rowResult["Determ. Date"];
                }

                idrFields.forEach(field => {
                    let displayValue = rowResult[field];
                    let cellHtml = '';
                    let cellId = `idr_${field.replace(/[^A-Za-z0-9]/g, '_')}_${index+1}`; 
                    let stickyClass = '';
                    
                    if(field === 'Ticket #' || field === 'IDR #' || field === 'Claim #' || field === 'CPT') {
                        stickyClass = 'sticky-col';
                    }

                    let isAmount = field === 'Initial Pmt' || field === 'Addl. Pmt' || field === 'Fee Refund';
                    let amountClass = isAmount ? 'output-value-amount' : '';
                    
                    if (isAmount && displayValue !== '--' && displayValue !== 'Not Found') {
                         displayValue = formatCurrency(parseCurrency(displayValue));
                    } else if (isAmount) {
                        displayValue = '$0.00'; // Default for empty amounts
                    }

                    if (field === "W/L (Manual)") {
                        let winLoseValue = rowResult["Determ. W/L"];
                        rowResult[field] = winLoseValue; // Store determined value
                        if (winLoseValue === "--" || winLoseValue === "Not Found") {
                            cellHtml = `<td ${cellId} class="${stickyClass}"><input type="text" class="form-control form-control-sm editable-input win-lose-input" data-row-index="${index}"></td>`;
                        } else {
                            cellHtml = `<td ${cellId} class="${stickyClass}">${winLoseValue}</td>`;
                        }
                    } else if (field === "Additional") {
                        const paymentDate = rowResult["Pmt Date"];
                        displayValue = (paymentDate !== "--" && paymentDate !== "Not Found") ? "Received" : "Waiting";
                        rowResult[field] = displayValue; // Store derived value
                        cellHtml = `<td ${cellId} class="${stickyClass}">${displayValue}</td>`;
                    } else if (field === "Refund") {
                        const winLoseValue = rowResult["Determ. W/L"] ? rowResult["Determ. W/L"].toLowerCase() : '';
                        let isDisabled = (winLoseValue === 'lose'); 
                        let isInvalid = (winLoseValue === 'win'); 
                        
                        if (winLoseValue === 'close') {
                            isDisabled = false;
                            isInvalid = false;
                        }
                        
                        cellHtml = `<td class="${stickyClass} ${isInvalid ? 'bg-mismatch' : ''}">
                                        <input type="text" 
                                               class="form-control form-control-sm editable-input refund-input ${isInvalid ? 'is-invalid' : ''}" 
                                               data-row-index="${index}" 
                                               oninput="autocompleteRefund(this)" 
                                               ${isDisabled ? 'disabled' : ''}>
                                    </td>`;
                        rowResult[field] = isDisabled ? 'N/A' : ''; 
                    } else {
                        // Standard cell
                        cellHtml = `<td id="${cellId}" class="${stickyClass} ${amountClass}">${displayValue}</td>`;
                    }
                    
                    rowHtml += cellHtml;
                });

                rowHtml += '</tr>';
                idrTableBody.innerHTML += rowHtml;
                
                allIdrAddlPmts.push(parseCurrency(rowResult["Addl. Pmt"]));
                resultCounter++; // Increment result number
            });
            
            // --- 4. Run Comparison Logic ---
            
            const allIdrTicketCells = document.querySelectorAll('#idrDataTableBody td:nth-child(2)'); // Ticket #
            const allIdrAddlPmtCells = document.querySelectorAll('#idrDataTableBody td:nth-child(10)'); // Addl. Pmt (FIXED from 9)
            
            let eobTicketMatched = false;
            allIdrTicketCells.forEach(cell => {
                if (ticketNo !== 'Not Found' && cell.textContent !== '--') {
                     if (ticketNo === cell.textContent) {
                        cell.classList.add('bg-match');
                        eobTicketMatched = true;
                    } else {
                        cell.classList.add('bg-mismatch');
                    }
                }
            });
            
            if (eobText.trim().length > 0 && allIdrTicketCells.length > 0) {
                if (eobTicketMatched) {
                    eobTicketCell.classList.add('bg-match');
                } else {
                    eobTicketCell.classList.add('bg-mismatch');
                }
            }
            
            // REMOVED: Additional Payment Color Logic
            
            // NEW: Auto-fill determination date
            if (firstIdrDetermDate) {
                mailDetermDateInput.value = firstIdrDetermDate;
            }
        });
        
        // --- 6. Note Generation & Validation Functions ---

        function validateAndGenerateNote() {
            let validationPassed = true;
            let activeIdrRows = [];
            finalReviewAdjustments.style.display = 'none'; // Hide adjustments by default
            noteWarningNoEOB.style.display = 'none';
            noteWarningClaimMismatch.style.display = 'none';
            
            const idrRows = document.querySelectorAll('#idrDataTableBody tr');
            let idrClaimNumbers = []; // For mismatch check
            
            // Recall table structure:
            // 0: Result #, 1: Ticket #, 2: IDR #, 3: Claim #, 4: CPT
            // 5: Initial Pmt, 6: Mediator, 7: Determ. Date, 8: Determ. W/L
            // 9: Addl. Pmt, 10: Pmt Date, 11: Fee Refund, 12: Fee Refund Date
            // 13: W/L (Manual), 14: Additional, 15: Refund
            
            idrRows.forEach((row, index) => {
                const winLoseInput = row.querySelector('.win-lose-input');
                const refundInput = row.querySelector('.refund-input');
                
                let rowData = {
                    idrNum: row.cells[2].textContent,
                    claimNum: row.cells[3].textContent, 
                    cpt: row.cells[4].textContent,
                    mediator: row.cells[6].textContent, // FIXED: Index 6
                    addlPmt: row.cells[9].textContent, // FIXED: Index 9
                    additionalStatus: row.cells[14].textContent, // FIXED: Index 14
                    winLoseStatus: '',
                    refundStatus: ''
                };
                
                if(rowData.claimNum !== '--' && rowData.claimNum !== 'Not Found') {
                    idrClaimNumbers.push(rowData.claimNum);
                }
                
                // --- Validation ---
                let currentWLStatus = '';
                if (winLoseInput) {
                    if (winLoseInput.value.trim() === '') {
                        validationPassed = false;
                        winLoseInput.classList.add('is-invalid');
                    }
                    currentWLStatus = winLoseInput.value.toLowerCase();
                } else {
                    currentWLStatus = row.cells[13].textContent.toLowerCase(); // FIXED: Index 13
                }
                rowData.winLoseStatus = currentWLStatus;

                if (refundInput) {
                    if (currentWLStatus === 'win' && refundInput.value.trim() === '') {
                        validationPassed = false;
                        refundInput.classList.add('is-invalid');
                        refundInput.closest('td').classList.add('bg-mismatch');
                    }
                    rowData.refundStatus = refundInput.value;
                }
                
                activeIdrRows.push(rowData);
            });

            if (!validationPassed) {
                noteInitialInput.value = "ERROR";
                noteTextInput.value = "ERROR: PLEASE FILL ALL REQUIRED W/L AND REFUND FIELDS IN THE IDR TABLE (MARKED IN RED).";
                return;
            }
            
            // --- Check for Claim # mismatch ---
            const allSame = idrClaimNumbers.every(c => c === idrClaimNumbers[0]);
            if (!allSame && idrClaimNumbers.length > 0) {
                noteWarningClaimMismatch.style.display = 'block';
            }
            
            // --- Calculate Initial ---
            let initial = "IDR FOLLOW UP"; // Default
            let allReceived = activeIdrRows.length > 0;
            
            activeIdrRows.forEach(row => {
                if (row.additionalStatus.toLowerCase() !== 'received') allReceived = false;
                
                if (row.winLoseStatus === 'win' && row.refundStatus.toLowerCase() !== 'received') {
                    allReceived = false;
                }
                
                // NEW: If "closed" and refund is "waiting", it's not final
                if (row.winLoseStatus === 'close' && row.refundStatus.toLowerCase() === 'waiting') {
                    allReceived = false; 
                }
            });

            if (allReceived) {
                initial = "FINAL REVIEW";
            } else if (activeIdrRows.length === 1) {
                const status = activeIdrRows[0].winLoseStatus;
                if (status === 'win') initial = 'IDR WIN';
                else if (status === 'lose') initial = 'IDR LOSE';
                else initial = 'IDR FOLLOW UP'; // For "Close" or other
            } else if (activeIdrRows.length > 1) {
                initial = "IDR FOLLOW UP";
            }
            
            noteInitialInput.value = initial;
            
            // --- Generate Note Text ---
            const eobText = document.getElementById('eobTextInput').value.trim();
            const eobExists = eobText.length > 0 && document.getElementById('eob_Claim').textContent !== '--';
            
            const eobClaimNo = document.getElementById('eob_Claim').textContent;
            const eobBilled = parseCurrency(document.getElementById('eob_Billed').textContent);
            const eobPaid = parseCurrency(document.getElementById('eob_Paid').textContent);
            const ptRespSum = parseCurrency(document.getElementById('eob_PtResp_Sum').textContent); // Get the calculated sum

            const today = getFormattedDate(); // NEW: Use timezone-aware date
            const name = noteNameInput.value || 'PRANTO R';
            
            let note = `${today}>${initial}>${name}>WORKING ON TRACKING SHEET. `;
            
            if (eobExists) {
                note += `CLAIM: ${eobClaimNo}; TOTAL BILL ${formatCurrency(eobBilled)}, INS PAID ${formatCurrency(eobPaid)}, PT RESPONSIBLITY ${formatCurrency(ptRespSum)}. NEGOTIATION AND IDR DONE. `;
            } else {
                noteWarningNoEOB.style.display = 'block';
                let claimForNote = (activeIdrRows.length > 0) ? activeIdrRows[0].claimNum : 'N/A';
                note += `CLAIM: ${claimForNote}. NEGOTIATION AND IDR DONE. `;
            }

            activeIdrRows.forEach(row => {
                let wlStatus = (row.winLoseStatus === '--' || row.winLoseStatus === 'not found' || row.winLoseStatus === '') ? 'N/A' : row.winLoseStatus.toUpperCase();
                
                note += `${row.idrNum}: IDR SUBMITTED ON CPT ${row.cpt} TO MEDIATOR ${row.mediator}. STATUS IS ${wlStatus} WITH ADDITIONAL ${row.addlPmt}. `;
                
                if (row.additionalStatus.toLowerCase() === 'received') {
                    note += "WE RECEIVED ADDITIONAL PAYMENT. ";
                } else {
                    note += "WE ARE WAITING FOR ADDITIONAL PAYMENT. ";
                }
                
                if (row.winLoseStatus === 'win') {
                    if (row.refundStatus.toLowerCase() === 'received') {
                        note += "WE RECEIVED FEE REFUND. ";
                    } else {
                        note += "WE ARE WAITING FOR FEE REFUND. ";
                    }
                }
                
                if (row.winLoseStatus === 'close' && row.refundStatus.toLowerCase() === 'received') {
                     note += "STATUS CLOSED AND WE RECEIVED FEE REFUND. ";
                }
            });
            
            // NEW: Add final sentence
            if (initial === 'FINAL REVIEW') {
                note += "NO FURTHER ACTION NEEDED. BALANCE TO BE ADJUSTED.";
                // Calculate and show adjustments
                const adjustWithPtVal = eobBilled - (eobPaid + ptRespSum);
                const adjustWithoutPtVal = eobBilled - eobPaid;
                adjustWithPt.textContent = formatCurrency(adjustWithPtVal);
                adjustWithoutPt.textContent = formatCurrency(adjustWithoutPtVal);
                finalReviewAdjustments.style.display = 'block';
            } else {
                note += "WAITING TO COMPLETE THE IDR PROCESS BEFORE ADJUSTMENT.";
                finalReviewAdjustments.style.display = 'none';
            }
            
            noteTextInput.value = note.trim().toUpperCase();
        }
        
        // --- NEW: Mail Generation Function ---
        function generateMail() {
            mailTypeInput.classList.remove('is-invalid');
            mailDetermDateInput.classList.remove('is-invalid');
            mailTextInput.value = ''; // Clear previous mail
            mailNoteTextInput.value = ''; // Clear previous note
            
            const eobText = document.getElementById('eobTextInput').value.trim();
            const idrRows = document.querySelectorAll('#idrDataTableBody tr');
            
            // Validation
            if (eobText.length === 0 || document.getElementById('eob_Claim').textContent === '--') {
                mailTextInput.value = "ERROR: EOB Data is missing. Please paste the EOB text.";
                return;
            }
            if (idrRows.length === 0) {
                mailTextInput.value = "ERROR: No IDR results found. Please extract IDR data first.";
                return;
            }
            if (idrRows.length > 1) {
                mailTextInput.value = "ERROR: Mail Generation only works for a single IDR result. Please process only one IDR entry.";
                return;
            }
            const emailType = mailTypeInput.value;
            if (emailType === "") {
                mailTypeInput.classList.add('is-invalid');
                mailTextInput.value = "ERROR: Please select an Email Type (1st or 2nd).";
                return;
            }
            // NEW: Validate determination date
            const determDate = mailDetermDateInput.value.trim();
            const dateRegex = /^\d{1,2}\/\d{1,2}\/\d{2,4}$/;
            if (determDate === "" || determDate === "--" || !dateRegex.test(determDate)) {
                mailDetermDateInput.classList.add('is-invalid');
                mailTextInput.value = "ERROR: Determination Date is missing or invalid. Please correct it.";
                return;
            }
            
            const idrRow = idrRows[0];
            
            // Get EOB data
            const provider = document.getElementById('eob_Provider').textContent;
            let eobClaim = document.getElementById('eob_Claim').textContent;
            
            // Get IDR data (FIXED INDICES)
            const idrNum = idrRow.cells[2].textContent;
            const idrClaim = idrRow.cells[3].textContent; 
            const cpt = idrRow.cells[4].textContent;
            const initialPmt = idrRow.cells[5].textContent; 
            const mediator = idrRow.cells[6].textContent; 
            // const determDate = idrRow.cells[7].textContent; // Now from input
            const addlPmt = idrRow.cells[9].textContent; // FIXED: Index 9
            
            let finalClaim = (eobClaim !== '--' && eobClaim !== 'Not Found') ? eobClaim : idrClaim;
            
            const myName = mailNameInput.value || 'Pranto Rodrix';
            const myInitial = mailInitialInput.value || 'PRANTO R'; // NEW

            // Calculate values
            const initialPmtNum = parseCurrency(initialPmt);
            const addlPmtNum = parseCurrency(addlPmt);
            const oonRateNum = initialPmtNum + addlPmtNum; // This is the IDR-Determined Rate

            // Generate Subject
            let subject = `Urgent Request for Claim Reprocessing as per IDR Determination - ${idrNum} and Claim Number: ${finalClaim}`;
            if (emailType === '2nd Email') {
                subject += " (2nd Email)";
            }
            mailSubjectInput.value = subject;
            
            // Get template from modal textarea
            let mailBody = emailTemplateText.value;
            
            // Replace placeholders
            mailBody = mailBody.replace(/\[DETERMINATION_DATE\]/g, determDate); // FIXED
            mailBody = mailBody.replace(/\[MEDIATOR_NAME\]/g, mediator);
            mailBody = mailBody.replace(/\[PROVIDER_NAME\]/g, provider);
            mailBody = mailBody.replace(/\[OON_RATE\]/g, formatCurrency(oonRateNum));
            mailBody = mailBody.replace(/\[CPT_CODE\]/g, cpt);
            mailBody = mailBody.replace(/\[CLAIM_NUMBER\]/g, finalClaim);
            mailBody = mailBody.replace(/\[INITIAL_PAYMENT\]/g, formatCurrency(initialPmtNum));
            mailBody = mailBody.replace(/\[OUTSTANDING_BALANCE\]/g, formatCurrency(addlPmtNum));
            mailBody = mailBody.replace(/\[MY_NAME\]/g, myName);
            
            mailTextInput.value = mailBody.trim();

            // --- Generate Email Note ---
            const today = getFormattedDate(); // NEW: Use timezone-aware date
            let noteType = (emailType === '1st Email') ? "1st FOLLOW UP" : "2nd FOLLOW UP";
            
            let emailNote = `${today}>IDR FOLLOW UP>${myInitial}>WORKING ON IDR TRACKING SHEET. NEGOTIATION AND IDR DONE. ACCORDING TO OUR RECORDS, FOR ${finalClaim}; WE HAVE NOT RECEIVED THE ADDITIONAL PAYMENT AMOUNT OF ${formatCurrency(addlPmtNum)} AND THE UPDATED EOB, AS PER THE DETERMINATION OF ${idrNum}, BY ${mediator} DATED ${determDate}. FOR BCBS ATTENTION, WE SENT ${noteType} EMAIL TO BCBS FOR THE IDR ADDITIONAL PAYMENT.`;
            
            mailNoteTextInput.value = emailNote.trim().toUpperCase();
        }


        // --- NEW: Autocomplete and Logic for Summary Table ---
        function autocompleteRefund(input) {
            const value = input.value.toLowerCase();
            if (value === 'r') input.value = 'Received';
            if (value === 'w') input.value = 'Waiting';
            
            // If user types, remove red warning
            if (input.value !== '') {
                input.classList.remove('is-invalid');
                input.closest('td').classList.remove('bg-mismatch');
            }
        }
        
        // Add event listener to summary table body for delegation
        document.getElementById('idrDataTableBody').addEventListener('input', function(e) {
            const target = e.target;
            
            // Autocomplete for Refund
            if (target.classList.contains('refund-input')) {
                autocompleteRefund(target);
            }
            
            // Logic for Win/Lose input
            if (target.classList.contains('win-lose-input')) {
                // NEW: Autocomplete for W/L/C
                const value = target.value.toLowerCase();
                if (value === 'w') target.value = 'Win';
                if (value === 'l') target.value = 'Lose';
                if (value === 'c') target.value = 'Closed';
                
                const tr = target.closest('tr');
                const refundInput = tr.querySelector('.refund-input');
                const refundCell = refundInput.closest('td');
                const newStatus = target.value.toLowerCase();
                
                if (newStatus === 'win') {
                    refundInput.disabled = false;
                    if (refundInput.value === '') {
                        refundCell.classList.add('bg-mismatch');
                        refundInput.classList.add('is-invalid');
                    } else {
                         refundCell.classList.remove('bg-mismatch');
                         refundInput.classList.remove('is-invalid');
                    }
                } else if (newStatus === 'lose') {
                    refundInput.disabled = true;
                    refundInput.value = '';
                    refundCell.classList.remove('bg-mismatch');
                    refundInput.classList.remove('is-invalid');
                } else if (newStatus === 'close') {
                    refundInput.disabled = false; // Now editable
                    refundCell.classList.remove('bg-mismatch'); // Not mandatory
                    refundInput.classList.remove('is-invalid');
                } else {
                    refundInput.disabled = false;
                    refundCell.classList.remove('bg-mismatch');
                    refundInput.classList.remove('is-invalid');
                }
            }
        });

    </script>
</body>
</html>

