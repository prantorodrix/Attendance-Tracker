<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<!-- HEAD -->
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Pranto's Note Tool</title>
<link rel="icon" type="image/png" href="note.png">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
:root{--f:'Poppins',sans-serif;--bg:#FFF;--txt:#212529;--pri:#6366f1;--sd:280px;--sh:5px 5px 10px #b8b9be,-5px -5px 10px #fff;--ins:inset 3px 3px 3px #b8b9be,inset -3px -3px 3px #fff;--cd:#eaeef1}
[data-bs-theme="dark"]{--bg:#1a1a1a;--txt:#e0e0e0;--sh:5px 5px 10px #0d0d0d,-5px -5px 10px #272727;--ins:inset 3px 3px 7px #0d0d0d,inset -3px -3px 7px #272727;--cd:#1a1a1a}
body{font-family:var(--f);background:var(--bg);height:100vh;overflow:hidden;transition:.3s;font-size:.85rem;color:var(--txt)}
#top{position:fixed;top:0;width:100%;height:60px;z-index:1000;display:flex;align-items:center;padding:0 1.5rem;background:var(--cd);box-shadow:var(--sh)}
#wrap{display:flex;margin-top:60px;height:calc(100vh - 60px)}
#sb{width:var(--sd);min-width:250px;display:flex;flex-direction:column;background:var(--cd);border-right:1px solid rgba(0,0,0,.05)}
#sb-c{flex:1;overflow-y:auto;padding:.5rem}
#main{flex:1;overflow-y:auto;padding:1rem}
.card{background:var(--cd);border-radius:15px;box-shadow:var(--sh);border:none;margin-bottom:1rem}
.form-control,.form-select{background:var(--cd);border:none;border-radius:10px;font-size:.85rem;color:var(--txt);box-shadow:var(--ins);transition:.2s}
.form-control:focus,.form-select:focus{box-shadow:var(--ins),0 0 0 2px var(--pri);outline:0}
.form-control[readonly]{cursor:pointer;opacity:.8}textarea{resize:none;font-family:monospace;overflow:hidden}
.btn-neu{display:flex;align-items:center;gap:8px;border-radius:25px;padding:6px 20px;border:none;font-weight:600;font-size:13px;background:var(--cd);box-shadow:var(--sh);color:var(--pri);transition:.2s}
.btn-neu:hover{transform:translateY(1px);box-shadow:var(--ins)}.btn-neu-danger{color:#dc3545}.btn-neu-danger:hover{color:#b02a37}
.nav-tabs-glass{border-bottom:none;padding:0 .5rem;display:flex;gap:10px}
.nav-tabs-glass .nav-link{border:none;background:var(--cd);color:var(--txt);font-weight:600;border-radius:10px;box-shadow:var(--sh);padding:8px 15px;font-size:.85rem}
.nav-tabs-glass .nav-link.active{color:var(--pri);box-shadow:var(--ins)}
.text-gradient{background:linear-gradient(90deg,#06b6d4,#a855f7,#ec4899);-webkit-background-clip:text;color:transparent;font-weight:700}
.idr-item{display:flex;justify-content:space-between;font-size:.8rem;padding:3px 0;align-items:center;border-bottom:1px solid rgba(0,0,0,.03)}
.idr-val{font-weight:700;text-align:right;max-width:130px;overflow:hidden;text-overflow:ellipsis}
.bg-match{background:rgba(16,185,129,.15)!important;color:#059669!important;padding:0 4px;border-radius:4px}
.bg-mismatch{background:rgba(239,68,68,.15)!important;color:#dc2626!important;padding:0 4px;border-radius:4px}
.bg-overpaid{background:rgba(255,193,7,.2)!important;color:#b45309!important;padding:0 4px;border-radius:4px}[data-bs-theme="dark"] .bg-overpaid{color:#ffc107!important}
.tab-pane.active{animation:fi .3s ease-out}@keyframes fi{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
#eob-bar{display:none;padding:.6rem 1rem;margin-bottom:1rem;background:var(--cd);box-shadow:var(--sh);border-radius:12px;font-weight:600;white-space:nowrap;overflow-x:auto;color:var(--pri)}
#eob-bar.visible{display:flex;gap:15px;align-items:center}
.fix-w{position:fixed;bottom:15px;left:15px;z-index:1050;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);padding:6px 12px;border-radius:10px;color:#fff;font-family:'Rajdhani';box-shadow:0 4px 15px rgba(0,0,0,.3);display:flex;gap:5px;align-items:baseline}
.tm-m{font-size:1.6rem;font-weight:700;line-height:1}.sc-a{font-size:.9rem;color:#00BCD4;width:18px;text-align:center}
.eob-d-item{display:flex;justify-content:space-between;border-bottom:1px solid rgba(0,0,0,.05);padding:4px 0;font-size:.85rem}
.eob-v{font-weight:700;color:var(--pri)}.ed-inp{padding:2px 5px;border-radius:5px;border:none;background:var(--cd);box-shadow:var(--ins);width:80px;font-size:.8rem;color:var(--txt)}
.form-control:disabled{opacity:.5;cursor:not-allowed}.is-invalid{box-shadow:inset 3px 3px 7px rgba(220,53,69,.2),inset -3px -3px 7px rgba(220,53,69,.1)!important;border:1px solid #dc3545!important}
.wl-inp{width:100px;font-weight:700;text-align:right;color:var(--txt)}
</style>
</head>
<body>
<!-- BODY -->
<div id="top">
    <div class="d-flex justify-content-between w-100 align-items-center">
        <div>Made by <span class="text-gradient">Pranto Rodrix</span></div>
        <div class="d-flex gap-3 align-items-center">
            <nav class="d-none d-md-flex gap-3 me-4 small fw-bold opacity-75">
                <a href="typing.html" class="text-reset text-decoration-none">Typing</a><a href="nsa.html" class="text-reset text-decoration-none">NSA</a><a href="appeal.html" class="text-reset text-decoration-none">Appeal</a><a href="index.html" class="text-reset text-decoration-none">Main</a>
            </nav>
            <button id="processBtn" class="btn-neu"><i class="bi bi-magic"></i> Extract</button>
            <button id="clearBtn" class="btn-neu btn-neu-danger"><i class="bi bi-trash"></i> Clear</button>
            <button id="theme-toggle" class="btn-neu" style="padding:6px 10px;"><i class="bi bi-sun-fill"></i></button>
        </div>
    </div>
</div>
<div id="wrap">
    <div id="sb">
        <div class="p-3 border-bottom"><h6 class="m-0 fw-bold text-primary small"><i class="bi bi-list-columns-reverse me-2"></i>IDR Results</h6></div>
        <div id="sb-c"><div class="text-center text-muted small mt-5">Paste IDR data & Extract</div></div>
    </div>
    <div id="main">
        <div class="container-fluid px-0">
            <div id="eob-bar"></div>
            <div class="row g-3 mb-3">
                <div class="col-lg-3"><div class="card h-100 p-3 d-flex flex-column"><label class="small fw-bold text-primary mb-2">Updated EOB</label><textarea class="form-control flex-grow-1" id="eobUp" placeholder="Paste Updated EOB"></textarea></div></div>
                <div class="col-lg-6"><div class="card p-3 h-100"><label class="small fw-bold text-primary mb-2">IDR Reports</label>
                    <div class="row g-2 mb-2"><div class="col-4"><textarea class="form-control" id="idr1" rows="3" placeholder="2024+ (1)"></textarea></div><div class="col-4"><textarea class="form-control" id="idr2" rows="3" placeholder="2024+ (2)"></textarea></div><div class="col-4"><textarea class="form-control" id="idr3" rows="3" placeholder="2024+ (3)"></textarea></div></div>
                    <div class="row g-2"><div class="col-4"><textarea class="form-control" id="idr4" rows="3" placeholder="22-23 (1)"></textarea></div><div class="col-4"><textarea class="form-control" id="idr5" rows="3" placeholder="22-23 (2)"></textarea></div><div class="col-4"><textarea class="form-control" id="idr6" rows="3" placeholder="22-23 (3)"></textarea></div></div>
                </div></div>
                <div class="col-lg-3"><div class="card h-100 p-3"><h6 class="fw-bold text-primary small mb-3 border-bottom pb-2">EOB Details</h6><div id="eob-det"><div class="text-muted small text-center mt-4">No Data</div></div></div></div>
            </div>
            <div class="card">
                <div class="p-3 pb-0"><ul class="nav nav-tabs-glass" id="mT"><li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#t-cor">Correspondence</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#t-em">Email</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#t-ref">Refund</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#t-inel">Ineligible</button></li></ul></div>
                <div class="card-body p-4"><div class="tab-content">
                    <!-- CORRESPONDENCE -->
                    <div class="tab-pane fade show active" id="t-cor"><div class="row g-3">
                        <div class="col-md-3"><button class="btn-neu w-100 justify-content-center text-primary mt-3" onclick="genCor()">Generate Note</button><label class="small fw-bold ms-1">Date</label><input type="date" class="form-control mb-2 dt-inp" id="cDt"><label class="small fw-bold ms-1">Name</label><input type="text" class="form-control mb-2 nm-inp" id="cNm" placeholder="Name"><label class="small fw-bold ms-1">Initial</label><input type="text" class="form-control mb-3 in-inp" id="cIni" placeholder="Auto/Manual"><div id="cAdj" class="mt-2 d-none"><h6 class="small fw-bold text-primary">Adjustments</h6><div class="small">With PT: <span id="adj1" class="fw-bold">--</span></div><div class="small">Without PT: <span id="adj2" class="fw-bold">--</span></div></div><div id="cWarn" class="mt-2 text-danger small fw-bold d-none"></div></div>
                        <div class="col-md-9"><textarea id="cOut" class="form-control" rows="12" readonly placeholder="Note will appear here..."></textarea></div>
                    </div></div>
                    <!-- EMAIL -->
                    <div class="tab-pane fade" id="t-em"><div class="row g-2 mb-3">
                        <div class="col-md-2"><label class="small fw-bold">Date</label><input type="date" class="form-control dt-inp" id="mDt"></div><div class="col-md-2"><label class="small fw-bold">Name</label><input type="text" class="form-control nm-inp" id="mNm" placeholder="Name"></div><div class="col-md-1"><label class="small fw-bold">Init</label><input type="text" class="form-control in-inp" id="mIni" placeholder="Init"></div>
                        <div class="col-md-2"><label class="small fw-bold">Scenario</label><select class="form-select" id="mSc" onchange="togEm()"><option value="ins">Standard (Insurance)</option><option value="pt">High PT (Patient)</option></select></div>
                        <div class="col-md-2"><label class="small fw-bold">EOB Addl (Manual)</label><input type="number" class="form-control" id="mMan" placeholder="For High PT" disabled></div>
                        <div class="col-md-2"><label class="small fw-bold">Type</label><select class="form-select" id="mTyp"><option value="1">1st Email</option><option value="2">2nd Email</option></select></div>
                        <div class="col-md-1 d-flex align-items-end"><button class="btn-neu w-100 justify-content-center text-primary" onclick="genEm()"><i class="bi bi-send"></i></button></div>
                    </div><div class="row g-2 mb-3">
                        <div class="col-md-4"><label class="small fw-bold">Determination Date</label><input type="text" class="form-control" id="mDet" placeholder="MM/DD/YYYY"></div><div class="col-md-4"><label class="small fw-bold">Subject</label><input type="text" class="form-control" id="mSub" readonly></div><div class="col-md-4"><label class="small fw-bold">CC</label><input type="text" class="form-control" id="mCC" value="mislam@roundtmc.com, razo@leverngear.com" readonly></div>
                    </div><div class="row g-3">
                        <div class="col-md-6"><label class="small fw-bold">Email Body</label><textarea id="mBod" class="form-control" rows="15" readonly></textarea></div><div class="col-md-6"><label class="small fw-bold">Tracking Note</label><textarea id="mNot" class="form-control" rows="15" readonly></textarea></div>
                    </div></div>
                    <!-- REFUND -->
                    <div class="tab-pane fade" id="t-ref"><div class="row g-3">
                        <div class="col-md-3"><label class="small fw-bold ms-1">Date</label><input type="date" class="form-control mb-2 dt-inp" id="rDt"><input type="text" class="form-control mb-2 nm-inp" id="rNm" placeholder="Name"><input type="text" class="form-control mb-2" id="rAmt" placeholder="Amount"><input type="text" class="form-control mb-2" id="rRefDt" placeholder="Ref Date"><input type="text" class="form-control mb-3" id="rDis" placeholder="Dispute #"><button class="btn-neu w-100 justify-content-center text-primary" onclick="genRef()">Generate</button></div>
                        <div class="col-md-9"><textarea id="rOut" class="form-control" rows="12" readonly></textarea></div>
                    </div></div>
                    <!-- INELIGIBLE -->
                    <div class="tab-pane fade" id="t-inel"><div class="row g-3">
                        <div class="col-md-3"><label class="small fw-bold ms-1">Date</label><input type="date" class="form-control mb-2 dt-inp" id="iDt"><input type="text" class="form-control mb-2 nm-inp" id="iNm" placeholder="Name"><input type="text" class="form-control mb-3" id="iDis" placeholder="Dispute #"><button class="btn-neu w-100 justify-content-center text-primary" onclick="genInel()">Generate</button></div>
                        <div class="col-md-9"><textarea id="iOut" class="form-control" rows="12" readonly></textarea></div>
                    </div></div>
                </div></div>
            </div>
            <footer class="mt-5 pt-4 border-top text-center text-muted small pb-5"><p class="mb-1 fw-bold">Pranto's Note Tool &copy; 2025</p></footer>
        </div>
    </div>
</div>
<!-- WATCH -->
<div class="fix-w"><div class="tm-m" id="bdTm">--:--</div><div class="sc-a" id="bdSc">00</div></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- JS -->
<script>
let gD={e:null,i:[]};
document.addEventListener('DOMContentLoaded',()=>{
    // FORCE CLEAN STORAGE ON LOAD
    try {
        let n = localStorage.getItem('myN');
        let i = localStorage.getItem('myI');
        
        if (n === 'undefined' || n === 'null' || n === null) {
            localStorage.removeItem('myN');
            n = '';
        }
        if (i === 'undefined' || i === 'null' || i === null) {
            localStorage.removeItem('myI');
            i = '';
        }
        
        // Set values immediately
        document.querySelectorAll('.nm-inp').forEach(e => e.value = n);
        document.querySelectorAll('.in-inp').forEach(e => e.value = i);
        
    } catch(e) { console.log('Storage error', e); }

    iDts();lThm();rInp();sWch();togEm();syncF('dt-inp');syncF('nm-inp');syncF('in-inp');
});

function iDts(){const d=new Date().toLocaleString("en-US",{timeZone:"Asia/Dhaka"}),n=new Date(d),s=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;document.querySelectorAll('.dt-inp').forEach(i=>{if(!i.value)i.value=s})}
function sWch(){const u=()=>{const d=new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Dhaka"})),h=d.getHours(),m=d.getMinutes(),s=d.getSeconds();document.getElementById('bdTm').textContent=`${String(h%12||12).padStart(2,'0')}:${String(m).padStart(2,'0')} ${h>=12?'PM':'AM'}`;document.getElementById('bdSc').textContent=String(s).padStart(2,'0')};setInterval(u,1000);u()}
/* EVENTS */
document.getElementById('processBtn').addEventListener('click',function(){const b=this,o=b.innerHTML;b.innerHTML='<span class="spinner-border spinner-border-sm"></span>';setTimeout(()=>{procAll();b.innerHTML=o},300)});
document.getElementById('clearBtn').addEventListener('click',()=>{
    document.querySelectorAll('textarea,input[type=number]').forEach(e=>e.value='');
    document.querySelectorAll('input[type=text]').forEach(e=>{
        // PROTECT NAME, INITIAL, DATE
        if(!e.classList.contains('nm-inp') && !e.classList.contains('in-inp') && !e.classList.contains('dt-inp') && e.id !== 'mDet') {
            e.value='';
        }
    });
    document.getElementById('sb-c').innerHTML='<div class="text-center text-muted small mt-5">Paste IDR data & Extract</div>';
    document.getElementById('eob-bar').classList.remove('visible');document.getElementById('eob-det').innerHTML='<div class="text-muted small text-center mt-4">No Data</div>';
    document.getElementById('cAdj').classList.add('d-none');document.getElementById('cWarn').classList.add('d-none');gD={e:null,i:[]};
});
function syncF(c){
    const f=document.querySelectorAll('.'+c);
    f.forEach(i=>i.addEventListener('input',e=>{
        f.forEach(j=>{if(j!==e.target) j.value=e.target.value})
    }))
}
/* PARSING */
function procAll(){
    gD.e=pEOB(document.getElementById('eobUp').value);dEOB(gD.e);
    const i=[];for(let j=1;j<=6;j++)i.push(document.getElementById('idr'+j).value);
    gD.i=pIDR(i);dIDR(gD.i);match();
    if(gD.i.length>0&&gD.i[0].dt)document.getElementById('mDet').value=gD.i[0].dt;
}
function pEOB(t){
    if(!t)return null;
    const ex=r=>{const m=t.match(r);if(!m)return'$0.00';return t.substring(m.index+m[0].length).split('\n').find(l=>l.trim()&&!l.match(/^[a-zA-Z\s\.\/()-]+:/))?.trim()||'$0.00'},pc=s=>parseFloat(s.replace(/[$,\s]/g,''))||0,gv=r=>t.match(r)?.[2].trim()||'--';
    let cn=pc(ex(/(Coinsurance Amount|Coinsurance)\s*:?/i)),dd=pc(ex(/(Deductible Amount|Deductible)\s*:?/i)),cp=pc(ex(/(Copay Amount|Copay)\s*:?/i));
    let pt=cn+dd+cp; if(pt===0)pt=pc(ex(/(Copay\/Deductible Amount|Responsibility)\s*:?/i));
    return{tic:gv(/(Patient Account Number|Pt Acct No)\s*:?[\s\r\n]+([^\r\n]+)/i),clm:gv(/(Claim I?D|Claim No|Claim Number)\s*:?[\s\r\n]+([^\r\n]+)/i),prv:gv(/(Billing Provider Name|Provider Name)\s*:?[\s\r\n]+([^\r\n]+)/i),bil:pc(ex(/(Total Bill|Billed Amount)\s*:?/i)),pd:pc(ex(/(^|[\r\n])(Plan Payment|Total Payment|Plan Paid|Paid Amount|Total Paid)\s*:?/i)),pt,adl:pc(ex(/(Insurance Current Paid Amount|Additional Paid)\s*:?/i)),cn,dd,cp};
}
function pIDR(inp){
    let r=[];inp.forEach(t=>{if(!t.trim())return;const c=t.split(/\t|\s{2,}/);
        let m=(c.length>18)?{id:1,cl:3,cp:4,in:7,md:8,dt:16,wl:17,ad:18,pm:19}:{id:5,cl:2,cp:3,in:7,md:8,dt:18,wl:19,ad:20,pm:21};
        r.push({id:c[m.id]?.trim()||'--',cl:c[m.cl]?.trim()||'--',cp:c[m.cp]?.trim()||'--',in:parseFloat(c[m.in]?.replace(/[$,]/g,''))||0,md:c[m.md]?.trim()||'--',wl:c[m.wl]?.trim()||'--',dt:c[m.dt]?.trim(),ad:parseFloat(c[m.ad]?.replace(/[$,]/g,''))||0,pm:c[m.pm]?.trim()});
    });return r;
}
/* UI */
const fmt=n=>'$'+(n||0).toLocaleString('en-US',{minimumFractionDigits:2});
function dEOB(d){
    if(!d){document.getElementById('eob-det').innerHTML='<div class="text-muted small mt-4 text-center">No Data</div>';return}
    document.getElementById('eob-bar').innerHTML=`<span class="text-primary fw-bold">${d.tic}</span> <span class="opacity-50 mx-2">|</span> <span class="fw-bold">${d.clm}</span> <span class="opacity-50 mx-2">|</span> Bill: ${fmt(d.bil)} <span class="opacity-50 mx-2">|</span> Paid: ${fmt(d.pd)} <span class="opacity-50 mx-2">|</span> PT: ${fmt(d.pt)} <span class="opacity-50 mx-2">|</span> <span class="fw-bold" id="eob_a">${fmt(d.adl)}</span>`;
    document.getElementById('eob-bar').classList.add('visible');
    document.getElementById('eob-det').innerHTML=`<div class="eob-d-item"><span>Coins</span><span class="eob-v">${fmt(d.cn)}</span></div><div class="eob-d-item"><span>Ded</span><span class="eob-v">${fmt(d.dd)}</span></div><div class="eob-d-item"><span>Copay</span><span class="eob-v">${fmt(d.cp)}</span></div><div class="eob-d-item"><span>Addl</span><span class="eob-v" id="eob_da">${fmt(d.adl)}</span></div>`;
}
function dIDR(d){
    const s=document.getElementById('sb-c');s.innerHTML='';
    d.forEach((r,i)=>{
        const w=r.wl.toLowerCase();
        let as=(r.pm&&r.pm.length>4)?`<span class="badge bg-success ms-1">Received</span>`:`<span class="badge bg-secondary ms-1">Waiting</span>`;
        let wlHtml=(r.wl==='--'||!r.wl)?`<input type="text" class="ed-inp wl-inp" placeholder="w/l/c" oninput="hWL(this,${i})">`:`<span class="idr-val fw-bold" data-wl="${w}">${r.wl}</span>`;
        const dis=(w.includes('lose')&&!w.includes('close'));
        s.innerHTML+=`<div class="card sidebar-card shadow-sm border-0"><div class="fw-bold text-primary border-bottom pb-1 mb-1 d-flex justify-content-between"><span>Result ${i+1}</span><span class="badge bg-light text-dark border">${r.id}</span></div><div class="idr-item"><span>Claim</span><span class="idr-val">${r.cl}</span></div><div class="idr-item"><span>W/L</span>${wlHtml}</div><div class="idr-item"><span>Addl</span><span class="idr-val idr-addl-val" data-val="${r.ad}" data-st="${as.includes('Received')?'Received':'Waiting'}">${fmt(r.ad)}${as}</span></div><div class="idr-item mt-1"><span>Refund</span><input type="text" class="ed-inp ref-inp" placeholder="${dis?'Disabled':'w/r'}" oninput="hRef(this,${i})" ${dis?'disabled':''} data-row="${i}"></div></div>`;
        gD.i[i].refSt=''; if(!r.wl)gD.i[i].wl='';
    });
}
function match(){
    if(!gD.e)return; const ea=gD.e.adl,ir=gD.i;if(!ir.length)return;
    let tot=0;ir.forEach(r=>tot+=r.ad);const e1=document.getElementById('eob_a'),e2=document.getElementById('eob_da');
    [e1,e2].forEach(e=>{if(e){e.classList.remove('bg-match','bg-mismatch','bg-overpaid');if(ea>0||tot>0){if(Math.abs(ea-tot)<0.01)e.classList.add('bg-match');else if(ea>tot)e.classList.add('bg-overpaid');else e.classList.add('bg-mismatch');}}});
}
function hRef(i,x){let v=i.value.toLowerCase();if(v==='w')v='Waiting';if(v==='r')v='Received';i.value=v;gD.i[x].refSt=v;}
function hWL(i,x){let v=i.value.toLowerCase();if(v==='w')v='Win';if(v==='l')v='Lose';if(v==='c')v='Closed';i.value=v;gD.i[x].wl=v;const dis=(v.includes('lose')&&!v.includes('close'));const ri=i.closest('.card').querySelector('.ref-inp');ri.disabled=dis;if(dis)ri.value='';}
const norm=s=>(s||'').toUpperCase().split('X')[0];
function fDt(v){if(!v)return'MM/DD/YY';const[y,m,d]=v.split('-');return`${m}/${d}/${y.slice(-2)}`;}
function ani(e,t){e.value='';const w=t.split(' ');let i=0;if(e.tm)clearInterval(e.tm);e.tm=setInterval(()=>{if(i<w.length){e.value+=(i>0?' ':'')+w[i];e.scrollTop=e.scrollHeight;i++}else clearInterval(e.tm)},10);}
/* CORRESPONDENCE */
function genCor(){
    const e=document.getElementById('cNm');e.classList.remove('is-invalid');document.getElementById('cAdj').classList.add('d-none');document.getElementById('cWarn').classList.add('d-none');
    const nm=e.value.toUpperCase();if(!nm){e.classList.add('is-invalid');return;}
    const d=gD,dt=fDt(document.getElementById('cDt').value);let ini=document.getElementById('cIni').value.toUpperCase();
    if(!d.i.length){document.getElementById('cOut').value="ERROR: No IDR Data";return;}const eb=d.e||{},ir=d.i[0]||{};
    if(d.i.length>1){const c1=d.i[0].cl,c2=d.i[1].cl;if(norm(c1)!==norm(c2)||(d.e&&norm(d.e.clm)!==norm(c1))){document.getElementById('cWarn').innerText="Claim mismatch";document.getElementById('cWarn').classList.remove('d-none');}}
    if(!ini){
        let adn=true; d.i.forEach(r=>{const w=(r.wl||'').toLowerCase(),rf=(r.refSt||'').toLowerCase(),ad=(r.pm&&r.pm.length>4)?'received':'waiting';
        if(w.includes('win')){if(ad==='waiting'||rf==='waiting'||rf==='')adn=false}else if(w.includes('lose')){if(ad==='waiting')adn=false}else if(w.includes('close')){if(rf==='waiting')adn=false}else adn=false});
        if(d.i.length>1) ini=adn?'FINAL REVIEW':'IDR FOLLOW UP';
        else{const r=d.i[0],w=(r.wl||'').toLowerCase(),rf=(r.refSt||'').toLowerCase(),ad=(r.pm&&r.pm.length>4)?'received':'waiting';
        if(w.includes('win')){if(rf===''){document.getElementById('cOut').value="Error: Refund Required";return}ini=(ad==='received'&&rf==='received')?'FINAL REVIEW':'IDR WIN'}else if(w.includes('lose'))ini=(ad==='received')?'FINAL REVIEW':'IDR LOSE';else if(w.includes('close'))ini=(rf==='waiting')?'IDR FOLLOW UP':'FINAL REVIEW';else ini='IDR FOLLOW UP';}
    }
    let n=`${dt}>${ini}>${nm}>WORKING ON TRACKING SHEET. CLAIM: ${eb.clm||ir.cl||'--'}; TOTAL BILL ${fmt(eb.bil)}, INS PAID ${fmt(eb.pd)}, PT RESP ${fmt(eb.pt)}. NEGOTIATION AND IDR DONE. `;
    d.i.forEach(r=>{
        const w=r.wl.toLowerCase(),ad=(r.pm&&r.pm.length>4)?'received':'waiting';
        n+=`${r.id}: IDR SUBMITTED ON CPT ${r.cp}. STATUS IS ${r.wl}. `;
        if((w.includes('win')||w.includes('lose')) && !w.includes('close')){n+=`ADDITIONAL ${fmt(r.ad)}. ${ad==='received'?'WE RECEIVED ADDITIONAL PAYMENT':'WE ARE WAITING FOR ADDITIONAL PAYMENT'}. `;}
        if((w.includes('win')||w.includes('close'))&&r.refSt)n+=`${r.refSt.toLowerCase()==='received'?'WE RECEIVED FEE REFUND':'WE ARE WAITING FOR FEE REFUND'}. `;
    });
    if(ini==='FINAL REVIEW'){n+="NO FURTHER ACTION NEEDED. BALANCE TO BE ADJUSTED.";if(eb.bil){document.getElementById('adj1').innerText=fmt(eb.bil-(eb.pd+eb.pt));document.getElementById('adj2').innerText=fmt(eb.bil-eb.pd);document.getElementById('cAdj').classList.remove('d-none')}}else n+="WAITING TO COMPLETE PROCESS.";
    ani(document.getElementById('cOut'),n);
}
/* EMAIL */
function togEm(){const s=document.getElementById('mSc').value,m=document.getElementById('mMan');m.disabled=(s!=='pt');if(s!=='pt')m.value='';document.getElementById('mCC').value=(s==='pt')?'mislam@roundtmc.com, razo@leverngear.com, sufia@leverngear.com':'mislam@roundtmc.com, razo@leverngear.com';}
function genEm(){
    const v=['mNm','mIni','mTyp','mDet'];let ok=true;v.forEach(x=>{const e=document.getElementById(x);e.classList.remove('is-invalid');if(!e.value.trim()){e.classList.add('is-invalid');ok=false}});if(!ok)return;
    const d=gD,dt=fDt(document.getElementById('mDt').value),nm=document.getElementById('mNm').value,ini=document.getElementById('mIni').value,typ=document.getElementById('mTyp').value,sc=document.getElementById('mSc').value,mn=parseFloat(document.getElementById('mMan').value),det=document.getElementById('mDet').value;
    if(!d.i.length){document.getElementById('mBod').value="ERROR: No IDR Data";return}
    const i=d.i[0],e=d.e||{},clm=e.clm||i.cl||'--',eAd=(!isNaN(mn))?mn:(e.adl||0),out=Math.max(0,i.ad-eAd);
    let sub='',bod='',nt=(typ=='1')?'1ST':'2ND';
    if(sc==='pt'){
        if(isNaN(mn)){document.getElementById('mBod').value="Error: Manual Addl Req";return}
        sub=`Urgent Request for Claim Reprocessing with additionally (High PT)- Dispute Number [${i.id}]`;
        bod=`Dear BCBS Representative,\n\nWe are emailing regarding the recently processed IDR case, ${i.id} that was finalized and paid. The newly processed EOB under claim number ${clm} shows an additional payment to the patient’s responsibility (copay, coinsurance, and/or deductible). This is in violation of the Federal Guidelines for the IDR Process. Per the Federal Guidelines, if the Mediator finds in favor of the Facility/Physician, the payment is to be made to the Facility/Physician and not to the patient’s responsibility. This newly processed EOB with the addition to the patient responsibility is in violation of the Guidelines and needs to be reprocessed with the payment to be made directly to our Facility/Physician Group.\n\nI am writing to bring your attention to the following details:\nClaim Number: ${clm}\nIDR-Determined OON Rate: ${fmt(i.in+i.ad)}\nLess Initial Payment: ${fmt(i.in)}\n------------------------\nTotal Outstanding Balance: ${fmt(i.ad)}\n\n(Note: In Update EOB, Additional: ${fmt(eAd)}. A total of ${fmt(out)} is less than our expected additional payment that has been added to the patient's responsibility.)\n\nThe Federal Manuals state verbatim:\n“NOTE: This determination of the OON rate does not change the participant’s, beneficiary’s, or enrollee’s cost sharing, which is based on the recognized amount, or, in the case of air ambulance services, the lower of the QPA or billed charges.”\n\nSources: Federal Independent Dispute Resolution (IDR) Process Guidance for Disputing Parties Manual March 2023, pg 27, October 2022, pg 29, April 2022, pg 27 and Federal Independent Dispute Resolution (IDR) Process Guidance for Certified IDR Entities Manual March 2023, pg 25, October 2022, pg 26, April 2022, pg 25\n\nPlease reprocess and pay this claim by the Federal Guidelines or we will have to escalate this issue to the CMS Complaint website.\n\nThank You.\n--------------------------------\n${nm}`;
        nt+=' HIGH PT EMAIL';
    }else{
        sub=`Urgent Request for Claim Reprocessing as per IDR Determination - ${i.id} - Claim: ${clm}`+(typ=='2'?' (2nd Email)':'');
        bod=`Dear BCBS,\n\nWe are writing to formally request the prompt payment of the additional reimbursement as required by the final determination in the Federal Independent Dispute Resolution (IDR) process under the No Surprises Act (NSA).\nOn ${det}, ${i.md} —the certified IDR entity—issued a final, legally binding determination in favor of , ${e.prv||'PROVIDER'} regarding the above-referenced claim. The IDR entity selected the out-of-network payment amount of ${fmt(i.in+i.ad)} for service code ${i.cp||'--'}. as offered by ${e.prv||'PROVIDER'} as the appropriate rate for this claim.\nAccording to the NSA and its implementing regulations (including 45 CFR 149.510(c)(4)(vii)), the plan or issuer must pay the balance of the total plan or coverage amount selected by the certified IDR entity, less any initial payment already made and any applicable patient cost-sharing, within 30 calendar days of the determination notification. As of today, this payment is outstanding.\n\nRequest for Payment:\nPlease remit the outstanding balance, calculated as follows:\nClaim Number: ${clm}\nIDR-Determined OON Rate: ${fmt(i.in+i.ad)}\nLess Initial Payment: ${fmt(i.in)}\n------------------------\nTotal Outstanding Balance: ${fmt(i.ad)}\n\nThis request is made pursuant to the No Surprises Act and its regulations, which require payment of the IDR-determined amount within 30 calendar days of the decision. Failure to remit payment in a timely manner may be reported to the appropriate regulatory authorities for noncompliance\nIf you have any questions or require additional documentation to process this payment, please contact us at bcbs_nsaandidr@roundtmc.com.\n\nAs per Federal guidelines additional payment amounts must be made within 30 days of the determination. If we do not receive the additional payment amount a CMS complaint may be filed. We appreciate your prompt attention to this matter.\n\nFor your reference we have attached the primary EOB and IDR determination.\n\n\nThank You\nRegards\n---------------\n${nm}`;
        nt+=' FOLLOW UP EMAIL';
    }
    document.getElementById('mSub').value=sub; ani(document.getElementById('mBod'),bod);
    ani(document.getElementById('mNot'),`${dt}>IDR FOLLOW UP>${ini}>WORKING ON IDR TRACKING SHEET. NEGOTIATION AND IDR DONE. ACCORDING TO OUR RECORDS, FOR ${clm}; WE HAVE NOT RECEIVED THE ADDITIONAL PAYMENT AMOUNT OF ${fmt(i.ad)} AND THE UPDATED EOB, AS PER THE DETERMINATION OF ${i.id}, BY ${i.md.toUpperCase()} DATED ${det}. FOR BCBS ATTENTION, WE SENT ${nt} TO BCBS FOR THE IDR ADDITIONAL PAYMENT.`);
}
/* OTHER GENERATORS */
function genRef(){const dt=fDt(document.getElementById('rDt').value),nm=document.getElementById('rNm').value.toUpperCase();ani(document.getElementById('rOut'),`${dt}>IDR WIN>${nm}>WORKING ON MEDIATION REFUND. RECEIVED REFUND OF ${document.getElementById('rAmt').value} DATED ${document.getElementById('rRefDt').value} FOR ${document.getElementById('rDis').value}. WAITING FOR ADDITIONAL PAYMENT.`)}
function genInel(){const dt=fDt(document.getElementById('iDt').value),nm=document.getElementById('iNm').value.toUpperCase();ani(document.getElementById('iOut'),`${dt}>FINAL REVIEW>${nm}>WORKING ON TRACKING SHEET. ${document.getElementById('iDis').value}: STATUS IS CLOSED. NO FURTHER ACTION NEEDED. BALANCE TO BE ADJUSTED.`)}
function lThm(){document.getElementById('theme-toggle').addEventListener('click',()=>{const h=document.documentElement,c=h.getAttribute('data-bs-theme');h.setAttribute('data-bs-theme',c==='light'?'dark':'light')})}
function rInp(){
    document.querySelectorAll('input').forEach(x=>x.addEventListener('input',e=>{
        if(e.target.classList.contains('nm-inp'))localStorage.setItem('myN',e.target.value);
        if(e.target.classList.contains('in-inp'))localStorage.setItem('myI',e.target.value);
    }));
}
document.querySelectorAll('textarea[readonly],input[readonly]').forEach(e=>e.addEventListener('click',function(){if(this.value)this.select(),document.execCommand('copy')}));
</script>
</body>
</html>
