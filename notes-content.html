<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<!-- HEAD -->
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Pranto's Note Tool</title>
<link rel="icon" type="image/png" href="note.png">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
/* THEME VARIABLES */
:root {
    --f: 'Poppins', sans-serif;
    /* Light Theme: Pure white and very light grays */
    --bg: #f0f2f5; 
    --txt: #2d3436;
    --pri: #6c5ce7;
    --sec: #0984e3;
    --sd: 280px;
    --sh: 8px 8px 20px rgba(0,0,0,0.06), -8px -8px 20px rgba(255,255,255,0.8);
    --ins: inset 2px 2px 5px rgba(0,0,0,0.03), inset -2px -2px 5px rgba(255,255,255,1);
    --cd: #ffffff;
    --watch-bg: rgba(255, 255, 255, 0.2);
    --watch-border: rgba(255, 255, 255, 0.4);
}

[data-bs-theme="dark"] {
    /* Dark Theme */
    --bg: #000000;
    --txt: #dfe6e9;
    --pri: #a29bfe;
    --sec: #74b9ff;
    --sh: 0 4px 15px rgba(0,0,0,0.5);
    --ins: inset 0 0 0 1px rgba(255,255,255,0.1);
    --cd: #1e1e1e;
    --watch-bg: rgba(0, 0, 0, 0.4);
    --watch-border: rgba(255, 255, 255, 0.1);
}

body { font-family: var(--f); background: var(--bg); height: 100vh; overflow: hidden; transition: background .4s, color .4s; font-size: .85rem; color: var(--txt); }
#top { position: fixed; top: 0; width: 100%; height: 60px; z-index: 1000; display: flex; align-items: center; padding: 0 1.5rem; background: var(--cd); box-shadow: 0 2px 10px rgba(0,0,0,0.05); backdrop-filter: blur(10px); }
#wrap { display: flex; margin-top: 60px; height: calc(100vh - 60px); }
#sb { width: var(--sd); min-width: 250px; display: flex; flex-direction: column; background: var(--cd); border-right: 1px solid rgba(0,0,0,.05); transition: .3s; }
#sb-c { flex: 1; overflow-y: auto; padding: .8rem; }
#main { flex: 1; overflow-y: auto; padding: 1.5rem; }

/* Cards & Inputs */
.card { background: var(--cd); border-radius: 20px; box-shadow: var(--sh); border: none; margin-bottom: 1.5rem; transition: transform .3s; }
.form-control, .form-select { background: var(--cd); border: 1px solid rgba(0,0,0,0.05); border-radius: 12px; font-size: .85rem; color: var(--txt); box-shadow: var(--ins); transition: all .3s ease; padding: 10px; }
[data-bs-theme="dark"] .form-control, [data-bs-theme="dark"] .form-select { border: 1px solid rgba(255,255,255,0.1); box-shadow: none; background: #2d2d2d; }
.form-control:focus, .form-select:focus { box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2); outline: 0; border-color: var(--pri); transform: translateY(-1px); }
.form-control[readonly] { cursor: pointer; opacity: .9; background: rgba(0,0,0,0.02); }
textarea { resize: none; font-family: 'Consolas', monospace; overflow: hidden; line-height: 1.4; }

/* Buttons */
.btn-neu { display: flex; align-items: center; gap: 8px; border-radius: 30px; padding: 8px 24px; border: none; font-weight: 600; font-size: 13px; background: var(--cd); box-shadow: var(--sh); color: var(--pri); transition: all .3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
[data-bs-theme="dark"] .btn-neu { background: #2d2d2d; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
.btn-neu:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(108, 92, 231, 0.2); }
.btn-neu:active { transform: translateY(-1px); }
.btn-neu-danger { color: #ff7675; }
.btn-neu-danger:hover { color: #d63031; box-shadow: 0 10px 20px rgba(214, 48, 49, 0.2); }

/* Tabs */
.nav-tabs-glass { border-bottom: none; padding: 0 .5rem; display: flex; gap: 12px; }
.nav-tabs-glass .nav-link { border: none; background: var(--cd); color: var(--txt); font-weight: 600; border-radius: 12px; box-shadow: var(--sh); padding: 10px 20px; font-size: .85rem; transition: all .3s; opacity: 0.7; }
[data-bs-theme="dark"] .nav-tabs-glass .nav-link { background: #2d2d2d; }
.nav-tabs-glass .nav-link:hover { opacity: 1; transform: translateY(-2px); }
.nav-tabs-glass .nav-link.active { color: var(--pri); opacity: 1; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05); transform: none; }
[data-bs-theme="dark"] .nav-tabs-glass .nav-link.active { box-shadow: inset 0 0 10px rgba(0,0,0,0.5); background: #252525; }

/* Typography */
.text-gradient { background: linear-gradient(135deg, #0984e3, #6c5ce7, #fd79a8); -webkit-background-clip: text; color: transparent; font-weight: 800; letter-spacing: 0.5px; }
.fw-bold { font-weight: 600 !important; }

/* IDR Items */
.idr-item { display: flex; justify-content: space-between; font-size: .85rem; padding: 6px 0; align-items: center; border-bottom: 1px solid rgba(0,0,0,.03); transition: .2s; }
[data-bs-theme="dark"] .idr-item { border-bottom: 1px solid rgba(255,255,255,.05); }
.idr-item:last-child { border-bottom: none; }
.idr-val { font-weight: 700; text-align: right; max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--txt); }

/* Status Badges */
.bg-match { background: rgba(0, 184, 148, 0.15) !important; color: #00b894 !important; padding: 2px 6px; border-radius: 6px; }
.bg-mismatch { background: rgba(214, 48, 49, 0.15) !important; color: #d63031 !important; padding: 2px 6px; border-radius: 6px; }
.bg-overpaid { background: rgba(253, 203, 110, 0.2) !important; color: #e17055 !important; padding: 2px 6px; border-radius: 6px; }

/* Animation */
.tab-pane { display: none; }
.tab-pane.active { display: block; animation: slideUp .4s cubic-bezier(0.165, 0.84, 0.44, 1); }
@keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

/* EOB Bar */
#eob-bar { display: none; padding: .8rem 1.2rem; margin-bottom: 1.5rem; background: var(--cd); box-shadow: var(--sh); border-radius: 15px; font-weight: 600; white-space: nowrap; overflow-x: auto; color: var(--pri); animation: fadeIn .3s; }
#eob-bar.visible { display: flex; gap: 20px; align-items: center; }

/* Floating Watch - Circular */
.watch-container { position: fixed; bottom: 20px; left: 20px; width: 90px; height: 90px; z-index: 1050; display: flex; justify-content: center; align-items: center; border-radius: 50%; background: var(--watch-bg); backdrop-filter: blur(15px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: 1px solid var(--watch-border); }
.watch-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotate(-90deg); }
.watch-circle-bg { fill: none; stroke: rgba(108, 92, 231, 0.1); stroke-width: 6; }
.watch-circle-progress { fill: none; stroke: var(--pri); stroke-width: 6; stroke-linecap: round; stroke-dasharray: 251; stroke-dashoffset: 251; transition: stroke-dashoffset 1s linear, stroke 0.3s; }
.watch-time { position: relative; z-index: 1; text-align: center; color: var(--txt); font-family: 'Rajdhani', sans-serif; line-height: 1; }
.wt-hm { font-size: 1.4rem; font-weight: 700; display: block; }
.wt-ampm { font-size: 0.7rem; font-weight: 600; color: var(--sec); letter-spacing: 1px; }

/* Helpers */
.ed-inp { padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(0,0,0,0.1); background: var(--cd); width: 80px; font-size: .8rem; color: var(--txt); transition: .2s; }
[data-bs-theme="dark"] .ed-inp { background: #2d2d2d; border: 1px solid rgba(255,255,255,0.1); }
.ed-inp:focus { border-color: var(--pri); outline: none; }
.wl-inp { width: 100px; font-weight: 700; text-align: right; }
</style>
</head>
<body>
<!-- BODY -->
<div id="top">
    <div class="d-flex justify-content-between w-100 align-items-center">
        <div class="d-flex align-items-center gap-2">
            <i class="bi bi-journal-text text-primary fs-4"></i>
            <span class="fw-bold" style="font-size: 1.1rem;">Pranto's Note Tool</span>
        </div>
        <div class="d-flex gap-3 align-items-center">
            <nav class="d-none d-md-flex gap-2 me-3 small fw-bold opacity-75">
                <a href="typing.html" class="btn btn-sm btn-link text-reset text-decoration-none">Typing</a>
                <a href="nsa.html" class="btn btn-sm btn-link text-reset text-decoration-none">NSA</a>
                <a href="appeal.html" class="btn btn-sm btn-link text-reset text-decoration-none">Appeal</a>
            </nav>
            <button id="processBtn" class="btn-neu"><i class="bi bi-magic"></i> Extract</button>
            <button id="clearBtn" class="btn-neu btn-neu-danger"><i class="bi bi-trash"></i> Clear</button>
            <button id="theme-toggle" class="btn-neu" style="padding:8px 12px;"><i class="bi bi-sun-fill"></i></button>
        </div>
    </div>
</div>
<div id="wrap">
    <div id="sb">
        <div class="p-4 border-bottom"><h6 class="m-0 fw-bold text-primary small text-uppercase"><i class="bi bi-list-columns-reverse me-2"></i>IDR Results</h6></div>
        <div id="sb-c"><div class="text-center text-muted small mt-5 opacity-75"><i class="bi bi-clipboard-data fs-1 d-block mb-2"></i>Paste IDR data & Extract</div></div>
    </div>
    <div id="main">
        <div class="container-fluid px-0">
            <div id="eob-bar"></div>
            <div class="row g-4 mb-4">
                <div class="col-lg-3"><div class="card h-100 p-4 d-flex flex-column"><label class="small fw-bold text-primary mb-3 text-uppercase">Updated EOB</label><textarea class="form-control flex-grow-1" id="eobUp" placeholder="Paste Updated EOB Text..."></textarea></div></div>
                <div class="col-lg-6"><div class="card p-4 h-100"><label class="small fw-bold text-primary mb-3 text-uppercase">IDR Reports</label>
                    <div class="row g-2 mb-2"><div class="col-4"><textarea class="form-control" id="idr1" rows="3" placeholder="2024+ (1)"></textarea></div><div class="col-4"><textarea class="form-control" id="idr2" rows="3" placeholder="2024+ (2)"></textarea></div><div class="col-4"><textarea class="form-control" id="idr3" rows="3" placeholder="2024+ (3)"></textarea></div></div>
                    <div class="row g-2"><div class="col-4"><textarea class="form-control" id="idr4" rows="3" placeholder="22-23 (1)"></textarea></div><div class="col-4"><textarea class="form-control" id="idr5" rows="3" placeholder="22-23 (2)"></textarea></div><div class="col-4"><textarea class="form-control" id="idr6" rows="3" placeholder="22-23 (3)"></textarea></div></div>
                </div></div>
                <div class="col-lg-3"><div class="card h-100 p-4"><h6 class="fw-bold text-primary small mb-4 border-bottom pb-2 text-uppercase">EOB Details</h6><div id="eob-det"><div class="text-muted small text-center mt-5 opacity-75">No Data Available</div></div></div></div>
            </div>
            <div class="card">
                <div class="p-3 pb-0"><ul class="nav nav-tabs-glass" id="mT"><li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#t-cor">Correspondence</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#t-em">Email</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#t-upd">IDR Update</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#t-ref">Refund</button></li></ul></div>
                <div class="card-body p-4"><div class="tab-content">
                    <!-- CORRESPONDENCE -->
                    <div class="tab-pane fade show active" id="t-cor"><div class="row g-4">
                        <div class="col-md-3">
                            <button class="btn-neu w-100 justify-content-center text-primary mt-1 mb-4 py-3" onclick="genCor()"><i class="bi bi-pencil-square"></i> Generate Note</button>
                            <div class="mb-3"><label class="small fw-bold ms-1 text-muted">Date</label><input type="date" class="form-control dt-inp" id="cDt"></div>
                            <div class="mb-3"><label class="small fw-bold ms-1 text-muted">Name</label><input type="text" class="form-control" id="cNm" placeholder="Enter Name"></div>
                            <div class="mb-3"><label class="small fw-bold ms-1 text-muted">Initial</label><input type="text" class="form-control" id="cIni" placeholder="Auto / Manual"></div>
                            <div id="cAdj" class="mt-3 p-3 bg-light rounded d-none border"><h6 class="small fw-bold text-primary mb-2">Adjustments</h6><div class="d-flex justify-content-between small mb-1"><span>With PT:</span><span id="adj1" class="fw-bold">--</span></div><div class="d-flex justify-content-between small"><span>Without PT:</span><span id="adj2" class="fw-bold">--</span></div></div>
                            <div id="cWarn" class="mt-3 alert alert-danger small fw-bold d-none py-2 px-3"><i class="bi bi-exclamation-triangle me-2"></i><span id="cWarnMsg">Error</span></div>
                        </div>
                        <div class="col-md-9"><textarea id="cOut" class="form-control h-100" style="min-height: 400px;" readonly placeholder="Generated note will appear here..."></textarea></div>
                    </div></div>
                    <!-- EMAIL -->
                    <div class="tab-pane fade" id="t-em"><div class="row g-3 mb-4">
                        <div class="col-md-2"><label class="small fw-bold text-muted">Date</label><input type="date" class="form-control dt-inp" id="mDt"></div><div class="col-md-2"><label class="small fw-bold text-muted">Name</label><input type="text" class="form-control" id="mNm" placeholder="Name"></div>
                        <div class="col-md-1"><label class="small fw-bold text-muted">Init</label><input type="text" class="form-control in-inp" id="mIni" placeholder="Init"></div>
                        <div class="col-md-2"><label class="small fw-bold text-muted">Scenario</label><select class="form-select" id="mSc" onchange="togEm()"><option value="ins">Standard (Insurance)</option><option value="pt">High PT (Patient)</option></select></div>
                        <div class="col-md-2"><label class="small fw-bold text-muted">EOB Addl (Manual)</label><input type="number" class="form-control" id="mMan" placeholder="For High PT" disabled></div>
                        <div class="col-md-2"><label class="small fw-bold text-muted">Type</label><select class="form-select" id="mTyp"><option value="1">1st Email</option><option value="2">2nd Email</option></select></div>
                        <div class="col-md-1 d-flex align-items-end"><button class="btn-neu w-100 justify-content-center text-primary" onclick="genEm()"><i class="bi bi-send-fill"></i></button></div>
                    </div><div class="row g-3 mb-4">
                        <div class="col-md-4"><label class="small fw-bold text-muted">Determination Date</label><input type="text" class="form-control" id="mDet" placeholder="MM/DD/YYYY"></div><div class="col-md-4"><label class="small fw-bold text-muted">Subject</label><input type="text" class="form-control" id="mSub" readonly></div><div class="col-md-4"><label class="small fw-bold text-muted">CC</label><input type="text" class="form-control" id="mCC" value="mislam@roundtmc.com, razo@leverngear.com" readonly></div>
                    </div><div class="row g-4">
                        <div class="col-md-6"><label class="small fw-bold text-primary mb-2">Email Body</label><textarea id="mBod" class="form-control" rows="15" readonly></textarea></div><div class="col-md-6"><label class="small fw-bold text-primary mb-2">Tracking Note</label><textarea id="mNot" class="form-control" rows="15" readonly></textarea></div>
                    </div></div>
                    <!-- IDR UPDATE -->
                    <div class="tab-pane fade" id="t-upd"><div class="row g-3 mb-4">
                        <div class="col-md-2"><label class="small fw-bold text-muted">Date</label><input type="date" class="form-control dt-inp" id="uDt"></div>
                        <div class="col-md-2"><label class="small fw-bold text-muted">Name</label><input type="text" class="form-control" id="uNm" placeholder="Name"></div>
                        <div class="col-md-1"><label class="small fw-bold text-muted">Init</label><input type="text" class="form-control in-inp" id="uIni" placeholder="Init"></div>
                        <div class="col-md-2"><label class="small fw-bold text-muted">Dispute #</label><input type="text" class="form-control" id="uDis" placeholder="DISP-XXXX"></div>
                        <div class="col-md-2"><label class="small fw-bold text-muted">Mediator</label><input type="text" class="form-control" id="uMed" placeholder="Mediator Name"></div>
                        <div class="col-md-2"><label class="small fw-bold text-muted">Type</label><select class="form-select" id="uTyp"><option value="check">Check & Offer</option><option value="pay">Payment Det</option></select></div>
                        <div class="col-md-1 d-flex align-items-end"><button class="btn-neu w-100 justify-content-center text-primary" onclick="genUpd()"><i class="bi bi-send-fill"></i></button></div>
                    </div><div class="row g-3 mb-4">
                        <div class="col-md-2 offset-md-8"><label class="small fw-bold text-muted">Follow Up</label><select class="form-select" id="uFol"><option value="1">1st Follow Up</option><option value="2">2nd Follow Up</option></select></div>
                        <div class="col-md-12"><label class="small fw-bold text-muted">Subject</label><input type="text" class="form-control" id="uSub" readonly></div>
                    </div><div class="row g-4">
                        <div class="col-md-6"><label class="small fw-bold text-primary mb-2">Email Body</label><textarea id="uBod" class="form-control" rows="15" readonly></textarea></div>
                        <div class="col-md-6"><label class="small fw-bold text-primary mb-2">Tracking Note</label><textarea id="uNot" class="form-control" rows="15" readonly></textarea></div>
                    </div></div>
                    <!-- REFUND -->
                    <div class="tab-pane fade" id="t-ref"><div class="row g-4">
                        <div class="col-md-3">
                            <label class="small fw-bold text-muted">Date</label><input type="date" class="form-control mb-3 dt-inp" id="rDt">
                            <input type="text" class="form-control mb-3 nm-inp" id="rNm" placeholder="Name">
                            <input type="text" class="form-control mb-3" id="rAmt" placeholder="Amount">
                            <input type="text" class="form-control mb-3" id="rRefDt" placeholder="Ref Date">
                            <input type="text" class="form-control mb-4" id="rDis" placeholder="Dispute #">
                            <button class="btn-neu w-100 justify-content-center text-primary" onclick="genRef()">Generate</button>
                        </div>
                        <div class="col-md-9"><textarea id="rOut" class="form-control h-100" style="min-height: 400px;" readonly></textarea></div>
                    </div></div>
                </div></div>
            </div>
            <footer class="mt-5 pt-4 border-top text-center text-muted small pb-5 opacity-75"><p class="mb-1 fw-bold">Pranto's Note Tool &copy; 2025</p></footer>
        </div>
    </div>
</div>
<!-- WATCH (Circular Progress) -->
<div class="watch-container">
    <svg class="watch-svg" viewBox="0 0 100 100">
        <circle class="watch-circle-bg" cx="50" cy="50" r="40"></circle>
        <circle class="watch-circle-progress" id="wProg" cx="50" cy="50" r="40"></circle>
    </svg>
    <div class="watch-time">
        <span class="wt-hm" id="bdTm">--:--</span>
        <span class="wt-ampm" id="bdAP">AM</span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- JS -->
<script>
let gD={e:null,i:[]};
document.addEventListener('DOMContentLoaded',()=>{
    const sT=localStorage.getItem('theme')||'light';
    document.documentElement.setAttribute('data-bs-theme',sT);
    try{let i=localStorage.getItem('myI');if(i)document.querySelectorAll('.in-inp').forEach(e=>e.value=i);}catch(e){}
    iDts();lThm();rInp();sWch();togEm();syncF('dt-inp');
});

function iDts(){const d=new Date().toLocaleString("en-US",{timeZone:"Asia/Dhaka"}),n=new Date(d),s=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;document.querySelectorAll('.dt-inp').forEach(i=>{if(!i.value)i.value=s})}

function sWch(){
    const u=()=>{
        const d=new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Dhaka"}));
        let h=d.getHours(),m=d.getMinutes(),s=d.getSeconds();
        const am=h>=12?'PM':'AM'; h=h%12||12;
        document.getElementById('bdTm').textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
        document.getElementById('bdAP').textContent=am;
        // Progress Ring Logic
        const c=251; // 2 * PI * 40 ~= 251
        const off=c-(s/60)*c;
        const p=document.getElementById('wProg');
        p.style.strokeDashoffset=off;
        // Color Cycle per minute
        const hue = (s * 6); // 0 to 360
        p.style.stroke = `hsl(${hue}, 70%, 60%)`;
    };
    setInterval(u,1000); u();
}

/* EVENTS */
document.getElementById('processBtn').addEventListener('click',function(){const b=this,o=b.innerHTML;b.innerHTML='<span class="spinner-border spinner-border-sm"></span>';setTimeout(()=>{procAll();b.innerHTML=o},300)});
document.getElementById('clearBtn').addEventListener('click',()=>{
    document.querySelectorAll('textarea,input[type=number]').forEach(e=>e.value='');
    document.querySelectorAll('input[type=text]').forEach(e=>{
        if(!e.classList.contains('in-inp') && e.id!=='cIni' && !e.classList.contains('dt-inp') && e.id !== 'mDet') e.value='';
    });
    document.getElementById('sb-c').innerHTML='<div class="text-center text-muted small mt-5 opacity-75"><i class="bi bi-clipboard-data fs-1 d-block mb-2"></i>Paste IDR data & Extract</div>';
    document.getElementById('eob-bar').classList.remove('visible');
    document.getElementById('eob-det').innerHTML='<div class="text-muted small text-center mt-5 opacity-75">No Data Available</div>';
    document.getElementById('cAdj').classList.add('d-none');
    document.getElementById('cWarn').classList.add('d-none');gD={e:null,i:[]};
});
function syncF(c){const f=document.querySelectorAll('.'+c);f.forEach(i=>i.addEventListener('input',e=>{f.forEach(j=>{if(j!==e.target)j.value=e.target.value})}))}

/* PARSING */
function procAll(){
    gD.e=pEOB(document.getElementById('eobUp').value);dEOB(gD.e);
    const i=[];for(let j=1;j<=6;j++)i.push(document.getElementById('idr'+j).value);
    gD.i=pIDR(i);dIDR(gD.i);match();
    if(gD.i.length>0&&gD.i[0].dt)document.getElementById('mDet').value=gD.i[0].dt;
    if(gD.i.length>0&&gD.i[0].md)document.getElementById('uMed').value=gD.i[0].md; 
    if(gD.i.length>0&&gD.i[0].id&&gD.i[0].id!='--')document.getElementById('uDis').value=gD.i[0].id; 
}
function pEOB(t){
    if(!t)return null;
    const ex=r=>{const m=t.match(r);if(!m)return'$0.00';return t.substring(m.index+m[0].length).split('\n').find(l=>l.trim()&&!l.match(/^[a-zA-Z\s\.\/()-]+:/))?.trim()||'$0.00'},pc=s=>parseFloat(s.replace(/[$,\s]/g,''))||0,gv=r=>t.match(r)?.[2].trim()||'--';
    let cn=pc(ex(/(Coinsurance Amount|Coinsurance)\s*:?/i)),dd=pc(ex(/(Deductible Amount|Deductible)\s*:?/i)),cp=pc(ex(/(Copay Amount|Copay)\s*:?/i));
    let pt=cn+dd+cp; if(pt===0)pt=pc(ex(/(Copay\/Deductible Amount|Responsibility)\s*:?/i));
    return{tic:gv(/(Patient Account Number|Pt Acct No)\s*:?[\s\r\n]+([^\r\n]+)/i),clm:gv(/(Claim I?D|Claim No|Claim Number)\s*:?[\s\r\n]+([^\r\n]+)/i),prv:gv(/(Billing Provider Name|Provider Name)\s*:?[\s\r\n]+([^\r\n]+)/i),bil:pc(ex(/(Total Bill|Billed Amount)\s*:?/i)),pd:pc(ex(/(^|[\r\n])(Plan Payment|Total Payment|Plan Paid|Paid Amount|Total Paid)\s*:?/i)),pt,adl:pc(ex(/(Insurance Current Paid Amount|Additional Paid)\s*:?/i)),cn,dd,cp};
}
function pIDR(inp){
    let r=[];inp.forEach(t=>{if(!t.trim())return;const c=t.split(/\t|\s{2,}/);
        let m=(c.length>18)?{id:1,cl:3,cp:4,in:7,md:8,dt:16,wl:17,ad:18,pm:19}:{id:5,cl:2,cp:3,in:7,md:8,dt:18,wl:19,ad:20,pm:21};
        r.push({id:c[m.id]?.trim()||'--',cl:c[m.cl]?.trim()||'--',cp:c[m.cp]?.trim()||'--',in:parseFloat(c[m.in]?.replace(/[$,]/g,''))||0,md:c[m.md]?.trim()||'--',wl:c[m.wl]?.trim()||'--',dt:c[m.dt]?.trim(),ad:parseFloat(c[m.ad]?.replace(/[$,]/g,''))||0,pm:c[m.pm]?.trim()});
    });return r;
}

/* UI */
const fmt=n=>'$'+(n||0).toLocaleString('en-US',{minimumFractionDigits:2});
function dEOB(d){
    if(!d){document.getElementById('eob-det').innerHTML='<div class="text-muted small text-center mt-5 opacity-75">No Data Available</div>';return}
    document.getElementById('eob-bar').innerHTML=`<span class="text-primary fw-bold">${d.tic}</span> <span class="opacity-50 mx-2">|</span> <span class="fw-bold">${d.clm}</span> <span class="opacity-50 mx-2">|</span> Bill: ${fmt(d.bil)} <span class="opacity-50 mx-2">|</span> Paid: ${fmt(d.pd)} <span class="opacity-50 mx-2">|</span> PT: ${fmt(d.pt)} <span class="opacity-50 mx-2">|</span> <span class="fw-bold" id="eob_a">${fmt(d.adl)}</span>`;
    document.getElementById('eob-bar').classList.add('visible');
    document.getElementById('eob-det').innerHTML=`<div class="eob-d-item"><span>Coins</span><span class="eob-v">${fmt(d.cn)}</span></div><div class="eob-d-item"><span>Ded</span><span class="eob-v">${fmt(d.dd)}</span></div><div class="eob-d-item"><span>Copay</span><span class="eob-v">${fmt(d.cp)}</span></div><div class="eob-d-item"><span>Addl</span><span class="eob-v" id="eob_da">${fmt(d.adl)}</span></div>`;
}
function dIDR(d){
    const s=document.getElementById('sb-c');s.innerHTML='';
    d.forEach((r,i)=>{
        const w=r.wl.toLowerCase();
        let as=(r.pm&&r.pm.length>4)?`<span class="badge bg-success ms-1">Received</span>`:`<span class="badge bg-secondary ms-1">Waiting</span>`;
        let wlHtml=(r.wl==='--'||!r.wl)?`<input type="text" class="ed-inp wl-inp" placeholder="w/l/c" oninput="hWL(this,${i})">`:`<span class="idr-val fw-bold" data-wl="${w}">${r.wl}</span>`;
        
        // LOGIC FIX: Enable refund input if 'closed' is present, even if it looks like lose
        const isClosed = w.includes('close');
        const isLose = w.includes('lose') && !isClosed;
        const disableRefund = isLose; // Only disable if it is PURE lose (not closed)

        s.innerHTML+=`
        <div class="card sidebar-card shadow-sm border-0">
            <div class="fw-bold text-primary border-bottom pb-2 mb-2 d-flex justify-content-between align-items-center">
                <span>Result ${i+1}</span>
            </div>
            <div class="idr-item"><span>Ticket #</span><span class="idr-val badge bg-light text-dark border">${r.id}</span></div>
            <div class="idr-item"><span>Mediator</span><span class="idr-val text-truncate" title="${r.md}">${r.md}</span></div>
            <div class="idr-item"><span>Claim</span><span class="idr-val">${r.cl}</span></div>
            <div class="idr-item"><span>W/L</span>${wlHtml}</div>
            <div class="idr-item"><span>Addl</span><span class="idr-val idr-addl-val" data-val="${r.ad}" data-st="${as.includes('Received')?'Received':'Waiting'}">${fmt(r.ad)}${as}</span></div>
            <div class="idr-item mt-1"><span>Refund</span><input type="text" class="ed-inp ref-inp" placeholder="${disableRefund?'Disabled':'w/r'}" oninput="hRef(this,${i})" ${disableRefund?'disabled':''} data-row="${i}"></div>
        </div>`;
        gD.i[i].refSt=''; if(!r.wl)gD.i[i].wl='';
    });
}
function match(){
    if(!gD.e)return; const ea=gD.e.adl,ir=gD.i;if(!ir.length)return;
    let tot=0;ir.forEach(r=>tot+=r.ad);const e1=document.getElementById('eob_a'),e2=document.getElementById('eob_da');
    [e1,e2].forEach(e=>{if(e){e.classList.remove('bg-match','bg-mismatch','bg-overpaid');if(ea>0||tot>0){if(Math.abs(ea-tot)<0.01)e.classList.add('bg-match');else if(ea>tot)e.classList.add('bg-overpaid');else e.classList.add('bg-mismatch');}}});
}
function hRef(i,x){let v=i.value.toLowerCase();if(v==='w')v='Waiting';if(v==='r')v='Received';i.value=v;gD.i[x].refSt=v;}
function hWL(i,x){
    let v=i.value.toLowerCase();
    if(v==='w')v='Win';if(v==='l')v='Lose';if(v==='c')v='Closed';i.value=v;gD.i[x].wl=v;
    
    // Explicit check
    const isClosed = v.includes('close');
    const isLose = v.includes('lose') && !isClosed;
    const shouldDisable = isLose; 

    const ri=i.closest('.card').querySelector('.ref-inp');
    ri.disabled = shouldDisable;
    if(shouldDisable) ri.value='';
}
const norm=s=>(s||'').toUpperCase().split('X')[0];
function fDt(v){if(!v)return'MM/DD/YY';const[y,m,d]=v.split('-');return`${m}/${d}/${y.slice(-2)}`;}
function ani(e,t){e.value='';const w=t.split(' ');let i=0;if(e.tm)clearInterval(e.tm);e.tm=setInterval(()=>{if(i<w.length){e.value+=(i>0?' ':'')+w[i];e.scrollTop=e.scrollHeight;i++}else clearInterval(e.tm)},10);}

/* CORRESPONDENCE */
function genCor(){
    const e=document.getElementById('cNm');e.classList.remove('is-invalid');document.getElementById('cAdj').classList.add('d-none');document.getElementById('cWarn').classList.add('d-none');
    const nm=e.value.toUpperCase();if(!nm){e.classList.add('is-invalid');return;}
    const d=gD,dt=fDt(document.getElementById('cDt').value);let ini=document.getElementById('cIni').value.toUpperCase();
    if(!d.i.length){document.getElementById('cOut').value="ERROR: No IDR Data";return;}const eb=d.e||{},ir=d.i[0]||{};
    if(d.i.length>1){const c1=d.i[0].cl,c2=d.i[1].cl;if(norm(c1)!==norm(c2)||(d.e&&norm(d.e.clm)!==norm(c1))){document.getElementById('cWarnMsg').innerText="Claim mismatch";document.getElementById('cWarn').classList.remove('d-none');}}
    
    if(!ini){
        let adn=true; d.i.forEach(r=>{const w=(r.wl||'').toLowerCase(),rf=(r.refSt||'').toLowerCase(),ad=(r.pm&&r.pm.length>4)?'received':'waiting';
        
        if(w.includes('win')){if(ad==='waiting'||rf==='waiting'||rf==='')adn=false}
        else if(w.includes('close')){if(rf==='waiting')adn=false}
        else if(w.includes('lose') && !w.includes('close')){if(ad==='waiting')adn=false}
        else adn=false});
        if(d.i.length>1) ini=adn?'FINAL REVIEW':'IDR FOLLOW UP';
        else{
            const r=d.i[0],w=(r.wl||'').toLowerCase(),rf=(r.refSt||'').toLowerCase(),ad=(r.pm&&r.pm.length>4)?'received':'waiting';
            if(w.includes('win')){
                if(rf===''){document.getElementById('cOut').value="Error: Refund Required for WIN";return}
                ini=(ad==='received'&&rf==='received')?'FINAL REVIEW':'IDR WIN';
            }
            else if(w.includes('close')){
                // Closed Logic: Refund Waiting -> IDR FOLLOW UP. Else (Received/Empty) -> FINAL REVIEW
                ini=(rf==='waiting')?'IDR FOLLOW UP':'FINAL REVIEW';
            }
            else if(w.includes('lose')){
                ini=(ad==='received')?'FINAL REVIEW':'IDR LOSE';
            }
            else ini='IDR FOLLOW UP';
        }
    }
    
    let n=`${dt}>${ini}>${nm}>WORKING ON TRACKING SHEET. CLAIM: ${eb.clm||ir.cl||'--'}; TOTAL BILL ${fmt(eb.bil)}, INS PAID ${fmt(eb.pd)}, PT RESP ${fmt(eb.pt)}. NEGOTIATION AND IDR DONE. `;
    d.i.forEach(r=>{
        const w=r.wl.toLowerCase(),ad=(r.pm&&r.pm.length>4)?'received':'waiting';
        n+=`${r.id} (${r.md}): IDR SUBMITTED ON CPT ${r.cp}. STATUS IS ${r.wl}. `;
        if((w.includes('win')||w.includes('lose')) && !w.includes('close')){n+=`ADDITIONAL ${fmt(r.ad)}. ${ad==='received'?'WE RECEIVED ADDITIONAL PAYMENT':'WE ARE WAITING FOR ADDITIONAL PAYMENT'}. `;}
        if((w.includes('win')||w.includes('close'))&&r.refSt)n+=`${r.refSt.toLowerCase()==='received'?'WE RECEIVED FEE REFUND':'WE ARE WAITING FOR FEE REFUND'}. `;
    });
    if(ini==='FINAL REVIEW'){n+="NO FURTHER ACTION NEEDED. BALANCE TO BE ADJUSTED.";if(eb.bil){document.getElementById('adj1').innerText=fmt(eb.bil-(eb.pd+eb.pt));document.getElementById('adj2').innerText=fmt(eb.bil-eb.pd);document.getElementById('cAdj').classList.remove('d-none')}}else n+="WAITING TO COMPLETE PROCESS.";
    ani(document.getElementById('cOut'),n);
}

/* EMAIL & UPDATES */
function togEm(){const s=document.getElementById('mSc').value,m=document.getElementById('mMan');m.disabled=(s!=='pt');if(s!=='pt')m.value='';document.getElementById('mCC').value=(s==='pt')?'mislam@roundtmc.com, razo@leverngear.com, sufia@leverngear.com':'mislam@roundtmc.com, razo@leverngear.com';}
function genEm(){
    const v=['mNm','mIni','mTyp','mDet'];let ok=true;v.forEach(x=>{const e=document.getElementById(x);e.classList.remove('is-invalid');if(!e.value.trim()){e.classList.add('is-invalid');ok=false}});if(!ok)return;
    const d=gD,dt=fDt(document.getElementById('mDt').value),nm=document.getElementById('mNm').value,ini=document.getElementById('mIni').value,typ=document.getElementById('mTyp').value,sc=document.getElementById('mSc').value,mn=parseFloat(document.getElementById('mMan').value),det=document.getElementById('mDet').value;
    if(!d.i.length){document.getElementById('mBod').value="ERROR: No IDR Data";return}
    const i=d.i[0],e=d.e||{},clm=e.clm||i.cl||'--',eAd=(!isNaN(mn))?mn:(e.adl||0),out=Math.max(0,i.ad-eAd);
    let sub='',bod='',nt=(typ=='1')?'1ST':'2ND';
    if(sc==='pt'){
        if(isNaN(mn)){document.getElementById('mBod').value="Error: Manual Addl Req";return}
        sub=`Urgent Request for Claim Reprocessing with additionally (High PT)- Dispute Number [${i.id}]`;
        bod=`Dear BCBS Representative,\n\nWe are emailing regarding the recently processed IDR case, ${i.id} that was finalized and paid. The newly processed EOB under claim number ${clm} shows an additional payment to the patient’s responsibility (copay, coinsurance, and/or deductible). This is in violation of the Federal Guidelines for the IDR Process. Per the Federal Guidelines, if the Mediator finds in favor of the Facility/Physician, the payment is to be made to the Facility/Physician and not to the patient’s responsibility. This newly processed EOB with the addition to the patient responsibility is in violation of the Guidelines and needs to be reprocessed with the payment to be made directly to our Facility/Physician Group.\n\nI am writing to bring your attention to the following details:\nClaim Number: ${clm}\nIDR-Determined OON Rate: ${fmt(i.in+i.ad)}\nLess Initial Payment: ${fmt(i.in)}\n------------------------\nTotal Outstanding Balance: ${fmt(i.ad)}\n\n(Note: In Update EOB, Additional: ${fmt(eAd)}. A total of ${fmt(out)} is less than our expected additional payment that has been added to the patient's responsibility.)\n\nThe Federal Manuals state verbatim:\n“NOTE: This determination of the OON rate does not change the participant’s, beneficiary’s, or enrollee’s cost sharing, which is based on the recognized amount, or, in the case of air ambulance services, the lower of the QPA or billed charges.”\n\nSources: Federal Independent Dispute Resolution (IDR) Process Guidance for Disputing Parties Manual March 2023, pg 27, October 2022, pg 29, April 2022, pg 27 and Federal Independent Dispute Resolution (IDR) Process Guidance for Certified IDR Entities Manual March 2023, pg 25, October 2022, pg 26, April 2022, pg 25\n\nPlease reprocess and pay this claim by the Federal Guidelines or we will have to escalate this issue to the CMS Complaint website.\n\nThank You.\n--------------------------------\n${nm}`;
        nt+=' HIGH PT EMAIL';
    }else{
        sub=`Urgent Request for Claim Reprocessing as per IDR Determination - ${i.id} - Claim: ${clm}`+(typ=='2'?' (2nd Email)':'');
        bod=`Dear BCBS,\n\nWe are writing to formally request the prompt payment of the additional reimbursement as required by the final determination in the Federal Independent Dispute Resolution (IDR) process under the No Surprises Act (NSA).\nOn ${det}, ${i.md} —the certified IDR entity—issued a final, legally binding determination in favor of , ${e.prv||'PROVIDER'} regarding the above-referenced claim. The IDR entity selected the out-of-network payment amount of ${fmt(i.in+i.ad)} for service code ${i.cp||'--'}. as offered by ${e.prv||'PROVIDER'} as the appropriate rate for this claim.\nAccording to the NSA and its implementing regulations (including 45 CFR 149.510(c)(4)(vii)), the plan or issuer must pay the balance of the total plan or coverage amount selected by the certified IDR entity, less any initial payment already made and any applicable patient cost-sharing, within 30 calendar days of the determination notification. As of today, this payment is outstanding.\n\nRequest for Payment:\nPlease remit the outstanding balance, calculated as follows:\nClaim Number: ${clm}\nIDR-Determined OON Rate: ${fmt(i.in+i.ad)}\nLess Initial Payment: ${fmt(i.in)}\n------------------------\nTotal Outstanding Balance: ${fmt(i.ad)}\n\nThis request is made pursuant to the No Surprises Act and its regulations, which require payment of the IDR-determined amount within 30 calendar days of the decision. Failure to remit payment in a timely manner may be reported to the appropriate regulatory authorities for noncompliance\nIf you have any questions or require additional documentation to process this payment, please contact us at bcbs_nsaandidr@roundtmc.com.\n\nAs per Federal guidelines additional payment amounts must be made within 30 days of the determination. If we do not receive the additional payment amount a CMS complaint may be filed. We appreciate your prompt attention to this matter.\n\nFor your reference we have attached the primary EOB and IDR determination.\n\n\nThank You\nRegards\n---------------\n${nm}`;
        nt+=' FOLLOW UP EMAIL';
    }
    document.getElementById('mSub').value=sub; ani(document.getElementById('mBod'),bod);
    ani(document.getElementById('mNot'),`${dt}>IDR FOLLOW UP>${ini}>WORKING ON IDR TRACKING SHEET. NEGOTIATION AND IDR DONE. ACCORDING TO OUR RECORDS, FOR ${clm}; WE HAVE NOT RECEIVED THE ADDITIONAL PAYMENT AMOUNT OF ${fmt(i.ad)} AND THE UPDATED EOB, AS PER THE DETERMINATION OF ${i.id}, BY ${i.md.toUpperCase()} DATED ${det}. FOR BCBS ATTENTION, WE SENT ${nt} TO BCBS FOR THE IDR ADDITIONAL PAYMENT.`);
}
function genUpd(){
    const ids=['uNm','uIni','uDis','uMed'];let ok=true; ids.forEach(i=>{const e=document.getElementById(i); e.classList.remove('is-invalid'); if(!e.value.trim()){e.classList.add('is-invalid');ok=false}});if(!ok) return;
    const dt=fDt(document.getElementById('uDt').value),nm=document.getElementById('uNm').value,ini=document.getElementById('uIni').value.toUpperCase(),dis=document.getElementById('uDis').value,med=document.getElementById('uMed').value,typ=document.getElementById('uTyp').value,fol=document.getElementById('uFol').value;
    const is2nd=(fol==='2'); let sub, bod, not; const followUpText=is2nd?"2ND":"1ST"; const subFollowUp=is2nd?" (2nd follow up)":"";
    if(typ==='check') {
        sub=`Update on IDR dispute – ${dis}${subFollowUp}`;
        bod=`Dear ${med},\n\nI am writing to request an update status of ${dis}. It has been 60 days since we have received confirmation from CMS that ${med} is the Mediator for this dispute.\nWe have not yet received any acknowledgement from ${med} regarding this matter.\n\nWe are kindly requesting that you provide a status update at your earliest convenience.\n\nThanks!.\n--------------\n${nm}`;
        not=`${dt}>IDR FOLLOW UP>${ini}>${nm.toUpperCase()}>WORKING ON IDR TRACKING SHEET. NEGOTIATION AND IDR DONE. DISPUTE NUMBER ${dis}, IT HAS BEEN 60 DAYS SINCE WE HAVE RECEIVED CONFIRMATION THAT THE MEDIATOR IS SELECTED FROM CMS FOR THIS DISPUTE. WE HAVE NOT YET RECEIVED ANY ACKNOWLEDGEMENT FROM THE MEDIATOR REGARDING THIS MATTER. FOR BCBS ATTENTION, WE SENT ${followUpText} FOLLOW UP EMAIL TO BCBS FOR THE UPDATE IDR STATUS.`;
    } else {
        sub=`Request for Payment Determination ${dis}${subFollowUp}`;
        bod=`Dear ${med},\n\nI am writing to request the final determination for ${dis}. It\nhas been over 60 days since we submitted our offer letter and\nmediation fee. Please kindly provide a written determination at your\nearliest convenience.\n\nThanks!\n-----------------\n${nm}`;
        not=`${dt}>IDR FOLLOW UP>${ini}>${nm.toUpperCase()}>WORKING ON IDR TRACKING SHEET. NEGOTIATION AND IDR DONE. DISPUTE NUMBER ${dis}, IT HAS BEEN OVER 60 DAYS SINCE WE SUBMITTED OUR OFFER LETTER AND MEDIATION FEE. FOR BCBS ATTENTION, WE SENT ${followUpText} FOLLOW UP EMAIL TO BCBS FOR THE PAYMENT DETERMINATION.`;
    }
    document.getElementById('uSub').value=sub; ani(document.getElementById('uBod'),bod); ani(document.getElementById('uNot'),not);
}
function genRef(){const dt=fDt(document.getElementById('rDt').value),nm=document.getElementById('rNm').value.toUpperCase();ani(document.getElementById('rOut'),`${dt}>IDR WIN>${nm}>WORKING ON MEDIATION REFUND. RECEIVED REFUND OF ${document.getElementById('rAmt').value} DATED ${document.getElementById('rRefDt').value} FOR ${document.getElementById('rDis').value}. WAITING FOR ADDITIONAL PAYMENT.`)}

function lThm(){document.getElementById('theme-toggle').addEventListener('click',()=>{const h=document.documentElement,c=h.getAttribute('data-bs-theme'),n=c==='light'?'dark':'light';h.setAttribute('data-bs-theme',n);localStorage.setItem('theme',n)})}
function rInp(){document.querySelectorAll('input').forEach(x=>x.addEventListener('input',e=>{if(e.target.classList.contains('in-inp'))localStorage.setItem('myI',e.target.value)}))}
document.querySelectorAll('textarea[readonly],input[readonly]').forEach(e=>e.addEventListener('click',function(){if(this.value)this.select(),document.execCommand('copy')}));
</script>
</body>
</html>
