<!DOCTYPE html>
<!-- data-bs-theme="light" ডিফল্ট হিসেবে সেট করা হলো -->
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pranto's Note</title>
    <link rel="icon" type="image/png" href="note.png"> 
    <!-- Google Font: Roboto (index.html থেকে আনা) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* --- index.html থেকে আনা Base & Typography --- */
        :root {
            --bs-body-font-family: 'Roboto', sans-serif;
            --bs-heading-font-family: 'Roboto', sans-serif;
            
            /* --- Light Mode (Translucent Glass) --- */
            --bs-body-bg-light: #f3e7ff; 
            --bs-body-color-light: #212529;
            --bs-tertiary-bg-light: rgba(255, 255, 255, 0.7); 
            --bs-secondary-bg-light: #f8f9fa; 
            --bs-border-color-light: rgba(0, 0, 0, 0.1); 
            
            --bs-glass-bg-light: rgba(255, 255, 255, 0.6); 
            --bs-glass-border-light: var(--bs-border-color-light);
            --bs-card-bg-light: var(--bs-tertiary-bg-light);
            --bs-card-border-light: var(--bs-border-color-light);

            /* --- Dark Mode (Translucent Glass) --- */
            --bs-body-bg-dark: #0a0c10; 
            --bs-body-color-dark: #e0e0e0;
            --bs-tertiary-bg-dark: rgba(22, 27, 34, 0.7); 
            --bs-secondary-bg-dark: #2a2a2a;
            --bs-border-color-dark: rgba(255, 255, 255, 0.1); 
            --bs-light-bg-subtle-dark: #161b22;

            --bs-glass-bg-dark: rgba(10, 12, 16, 0.6); 
            --bs-glass-border-dark: var(--bs-border-color-dark);
            --bs-card-bg-dark: var(--bs-tertiary-bg-dark); /* ডার্ক মোড কার্ডের রঙ */
            --bs-card-border-dark: var(--bs-border-color-dark);

            --bs-primary-dark: #00f0b5;
            --bs-primary-rgb-dark: 0, 240, 181;
        }

        [data-bs-theme="light"] {
            --bs-body-bg: var(--bs-body-bg-light);
            --bs-body-color: var(--bs-body-color-light);
            --bs-tertiary-bg: var(--bs-tertiary-bg-light);
            --bs-secondary-bg: var(--bs-secondary-bg-light);
            --bs-border-color: var(--bs-border-color-light);
            --bs-light-bg-subtle: var(--bs-light-bg-subtle-light);

            --bs-glass-bg: var(--bs-glass-bg-light);
            --bs-glass-border: var(--bs-glass-border-light);
            --bs-card-bg: var(--bs-card-bg-light);
            --bs-card-border: var(--bs-card-border-light);
        }

        [data-bs-theme="dark"] {
            --bs-body-bg: var(--bs-body-bg-dark);
            --bs-body-color: var(--bs-body-color-dark);
            --bs-tertiary-bg: var(--bs-tertiary-bg-dark);
            --bs-secondary-bg: var(--bs-secondary-bg-dark);
            --bs-border-color: var(--bs-border-color-dark);
            --bs-light-bg-subtle: var(--bs-light-bg-subtle-dark);

            --bs-glass-bg: var(--bs-glass-bg-dark);
            --bs-glass-border: var(--bs-glass-border-dark);
            --bs-card-bg: var(--bs-card-bg-dark);
            --bs-card-border: var(--bs-border-color-dark);

            --bs-primary: var(--bs-primary-dark);
            --bs-primary-rgb: var(--bs-primary-rgb-dark);
            --bs-link-color: var(--bs-primary-dark);
            --bs-link-color-rgb: var(--bs-primary-rgb-dark);
            --bs-link-hover-color: #33ffc7;
        }

        body {
            font-family: var(--bs-body-font-family); /* Roboto ফন্ট ব্যবহার করা হলো */
            background-color: transparent; /* অ্যানিমেটেড ব্যাকগ্রাউন্ড দেখানোর জন্য */
            transition: background-color 0.3s ease;
        }
        
        /* --- index.html থেকে আনা Animated Background --- */
        #animated-bg-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: -10; 
            overflow: hidden;
        }
        .bg-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(20px); 
            -webkit-filter: blur(20px);
            opacity: 0;
            transition: opacity 1.5s ease-in-out; 
            transform: scale(1.1); 
        }
        .bg-image.active {
            opacity: 1;
        }

        /* Light Theme Images */
        [data-bs-theme="light"] .bg-image-light.bg-1 { background-image: url('https://cdn.pixabay.com/photo/2024/11/02/05/13/winter-9168141_1280.jpg'); }
        [data-bs-theme="light"] .bg-image-light.bg-2 { background-image: url('https://cdn.pixabay.com/photo/2024/11/02/05/13/winter-9168141_1280.jpg'); }
        [data-bs-theme="light"] .bg-image-light.bg-3 { background-image: url('https://cdn.pixabay.com/photo/2024/11/02/05/13/winter-9168141_1280.jpg'); }
        
        /* Dark Theme Images */
        [data-bs-theme="dark"] .bg-image-dark.bg-1 { background-image: url('https://cdn.pixabay.com/photo/2021/01/10/18/01/milky-way-5905903_1280.jpg'); }
        [data-bs-theme="dark"] .bg-image-dark.bg-2 { background-image: url('https://cdn.pixabay.com/photo/2021/01/10/18/01/milky-way-5905903_1280.jpg'); }
        [data-bs-theme="dark"] .bg-image-dark.bg-3 { background-image: url('https://cdn.pixabay.com/photo/2021/01/10/18/01/milky-way-5905903_1280.jpg'); }

        [data-bs-theme="light"] .bg-image-dark { display: none; }
        [data-bs-theme="dark"] .bg-image-light { display: none; }
        
        h1, h2, h3, h4, h5, h6, .fw-bold {
            font-family: var(--bs-heading-font-family);
            font-weight: 700;
        }

        /* --- index.html থেকে আনা Glass Card Style --- */
        .card {
            background-color: var(--bs-card-bg);
            border: 1px solid var(--bs-card-border);
            border-radius: 1.5rem; /* More rounded */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
        }
        
        [data-bs-theme="dark"] .card {
             box-shadow: none;
             border-radius: 0.75rem; /* Less rounded for tech look */
        }

        /* --- notes-content.txt থেকে আনা Tool Styles (UI Kit) --- */
        
        /* Input/Textarea গুলোকে Glass UI এর সাথে মানানসই করা */
        .form-control, .form-select {
            background-color: var(--bs-tertiary-bg);
            color: var(--bs-body-color);
            border: 1px solid var(--bs-border-color);
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--bs-tertiary-bg);
            color: var(--bs-body-color);
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 3px rgba(var(--bs-primary-rgb), 0.2);
        }
        
        .result-list {
            font-size: 0.9rem; 
        }
        .result-list p {
            margin-bottom: 0.5rem; 
            border-bottom: 1px solid var(--bs-border-color); /* Updated Border */
            padding-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            white-space: nowrap; 
        }
         .result-list p:last-child {
            border-bottom: none;
            margin-bottom: 0;
         }
        .result-list strong {
            color: var(--bs-body-color); /* Updated Text Color */
            margin-right: 10px;
        }
        .result-list .output-value {
            font-weight: bold;
            color: #28a745;
            text-align: right;
        }
        .result-list .output-value.text-dark {
             color: var(--bs-body-color) !important; /* Updated Text Color */
        }

        /* টেবিল স্টাইল Glass UI এর সাথে মানানসই করা */
        .result-table {
            font-size: 0.9rem; 
        }
        .result-table th, .result-table td {
            vertical-align: middle;
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            white-space: nowrap; 
            border-color: var(--bs-border-color); /* Updated Border */
            color: var(--bs-body-color); /* Updated Text Color */
        }
        .result-table thead th { 
            background-color: var(--bs-secondary-bg); /* Updated Header BG */
            text-align: left;
        }
         .result-table tbody th {
            font-weight: bold;
            color: var(--bs-body-color);
            text-align: left;
         }
         .result-table td {
            font-weight: bold;
            color: var(--bs-body-color);
            text-align: left; 
         }
        .result-table .output-value-amount {
            color: #28a745;
        }

        textarea {
            font-family: monospace;
            min-height: 200px; 
        }
        
        .idr-textarea {
             min-height: 100px; 
        }
        
        /* Comparison BG Colors (এগুলো ঠিক আছে) */
        .bg-match { 
            background-color: rgba(212, 237, 218, 0.7) !important; /* light green */
            color: #0f5132 !important;
            border-radius: 5px;
        }
        .bg-mismatch { 
            background-color: rgba(248, 215, 218, 0.7) !important; /* light red */
            color: #842029 !important;
            border-radius: 5px;
        }
        .bg-overpaid { 
            background-color: rgba(255, 243, 205, 0.7) !important; /* light yellow */
            color: #664d03 !important;
            border-radius: 5px;
        }
        
        /* ডার্ক মোডে Comparison কালার */
        [data-bs-theme="dark"] .bg-match { 
            background-color: rgba(13, 26, 18, 0.8) !important;
            color: #34c356 !important;
        }
        [data-bs-theme="dark"] .bg-mismatch { 
            background-color: rgba(43, 17, 20, 0.8) !important;
            color: #ea5462 !important;
        }
        [data-bs-theme="dark"] .bg-overpaid { 
            background-color: rgba(36, 28, 10, 0.8) !important;
            color: #ffca2c !important;
        }

        .result-list .output-value.bg-match,
        .result-list .output-value.bg-mismatch,
        .result-list .output-value.bg-overpaid {
             padding: 2px 6px;
        }
        
        .editable-input {
            width: 100px;
            background-color: var(--bs-tertiary-bg); /* Updated */
            color: var(--bs-body-color); /* Updated */
            border: 1px solid var(--bs-border-color); /* Updated */
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
        }
        .editable-input:disabled {
            background-color: var(--bs-secondary-bg);
            border-color: var(--bs-border-color);
        }
        
        @keyframes shake-red {
            0% { transform: translateX(0); box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25); }
            25% { transform: translateX(5px); }
            50% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
            100% { transform: translateX(0); box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0); }
        }
        .is-invalid {
            border-color: #dc3545;
        }
        .form-control.is-invalid, .form-select.is-invalid {
             border-color: #dc3545;
             animation: shake-red 0.5s ease-out;
        }
        /* --- Footer --- */
        #main-footer {
            background-color: var(--bs-card-bg);
            border-top: 1px solid var(--bs-card-border);
            padding: 3rem 1rem;
            margin-top: 3rem;
            color: var(--bs-secondary-color);
            border-radius: 10px;
        }
        #main-footer h5 {
            color: var(--bs-body-color);
            font-weight: 600;
        }
        #main-footer .footer-links {
            list-style: none;
            padding-left: 0;
        }
        #main-footer .footer-links li {
            margin-bottom: 0.5rem;
        }
        #main-footer .footer-links a {
            text-decoration: none;
            color: var(--bs-secondary-color);
            transition: all 0.2s ease;
        }
        #main-footer .footer-links a:hover {
            color: var(--bs-primary);
            text-decoration: underline;
        }
        #main-footer .social-links a {
            font-size: 1.5rem;
            color: var(--bs-secondary-color);
            margin-right: 1rem;
            transition: all 0.2s ease;
        }
        #main-footer .social-links a:hover {
            color: var(--bs-primary);
            transform: scale(1.1);
        }

        
        /* Sticky Column CSS (Glass UI) */
        .result-table th:nth-child(1), .result-table td:nth-child(1), 
        .result-table th:nth-child(2), .result-table td:nth-child(2), 
        .result-table th:nth-child(3), .result-table td:nth-child(3), 
        .result-table th:nth-child(4), .result-table td:nth-child(4), 
        .result-table th:nth-child(5), .result-table td:nth-child(5)
        {
            position: sticky;
            z-index: 2;
        }
        
        .result-table th:nth-child(1), .result-table td:nth-child(1) { left: 0; min-width: 100px; }
        .result-table th:nth-child(2), .result-table td:nth-child(2) { left: 100px; min-width: 120px; }
        .result-table th:nth-child(3), .result-table td:nth-child(3) { left: 220px; min-width: 120px; }
        .result-table th:nth-child(4), .result-table td:nth-child(4) { left: 340px; min-width: 150px; } 
        .result-table th:nth-child(5), .result-table td:nth-child(5) { left: 490px; min-width: 80px; } 

        /* Sticky column backgrounds (Glass UI) */
        .result-table thead th {
            background-color: var(--bs-secondary-bg); /* Updated */
        }
        .result-table tbody th {
            background-color: var(--bs-tertiary-bg); /* Updated */
        }
        .result-table tbody td:nth-child(2),
        .result-table tbody td:nth-child(3),
        .result-table tbody td:nth-child(4),
        .result-table tbody td:nth-child(5) {
             background-color: var(--bs-card-bg); /* Updated */
        }
        
        #note_Text, #note_Mail_Text, #mail_Note_Text {
            min-height: 200px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        /* Accordion Button Style (Glass UI) */
        .accordion-item {
            background-color: transparent; /* Full Glass */
            border: none;
        }
        .accordion-button {
            background-color: var(--bs-card-bg); /* Glass */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--bs-card-border);
            border-radius: 1rem !important;
            color: var(--bs-body-color);
        }
        .accordion-button:not(.collapsed) {
            color: var(--bs-primary);
            background-color: var(--bs-tertiary-bg);
            box-shadow: none;
        }
        .accordion-button:focus {
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
            border-color: var(--bs-primary);
        }
        .accordion-body {
            /* বডি-কে কার্ডের মতো দেখানো হচ্ছে */
            background-color: var(--bs-card-bg);
            border: 1px solid var(--bs-card-border);
            border-radius: 1rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            margin-top: 1rem;
            padding: 1.5rem;
        }

        .form-control[readonly].copyable {
            cursor: pointer;
            background-color: var(--bs-secondary-bg);
        }
        [data-bs-theme="light"] .form-control[readonly].copyable:hover {
            background-color: #e9ecef;
        }
        [data-bs-theme="dark"] .form-control[readonly].copyable:hover {
            background-color: #3a3a3a;
        }
        
        /* --- index.html থেকে আনা Theme Toggle Button --- */
        #theme-toggle-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1030;
        }
        .btn-theme-toggle {
            background-color: var(--bs-glass-bg);
            border: 1px solid var(--bs-glass-border);
            color: var(--bs-secondary-color);
            font-weight: 600;
            transition: all 0.2s ease;
            border-radius: 13px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        [data-bs-theme="light"] .btn-theme-toggle {
            color: #495057;
        }
        .btn-theme-toggle:hover {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
            color: #fff;
            box-shadow: 0 4px 12px rgba(var(--bs-primary-rgb), 0.3);
        }
        [data-bs-theme="dark"] .btn-theme-toggle {
            color: var(--bs-body-color-dark);
        }
        [data-bs-theme="dark"] .btn-theme-toggle:hover {
            background-color: var(--bs-primary-dark);
            border-color: var(--bs-primary-dark);
            color: #000;
            box-shadow: 0 4px 12px rgba(var(--bs-primary-rgb-dark), 0.3);
        }

    </style>
</head>
<body>

    <!-- ======== index.html থেকে আনা Animated BG Container ======== -->
    <div id="animated-bg-container">
        <!-- Light Theme Images -->
        <div class="bg-image bg-image-light bg-1 active"></div>
        <div class="bg-image bg-image-light bg-2"></div>
        <div class="bg-image bg-image-light bg-3"></div>
        <!-- Dark Theme Images -->
        <div class="bg-image bg-image-dark bg-1"></div>
        <div class="bg-image bg-image-dark bg-2"></div>
        <div class="bg-image bg-image-dark bg-3"></div>
    </div>

    <!-- ======== index.html থেকে আনা Theme Toggle Button ======== -->
 <div id="theme-toggle-container" class="col-11" style="
    /* Main Container Styles */
    font-family:'Poppins',sans-serif; font-weight:600;
    padding:8px 80px; /* Daan o Ban dhar theke 30px jaiga chhara holo */
    border-radius:10px; 
    display:flex; justify-content:space-between; align-items:center; 
    background:rgba(255,255,255,0.05); backdrop-filter:blur(8px); 
    border:1px solid rgba(255,255,255,0.1); 
    box-shadow:0 4px 15px rgba(0,0,0,0.1); color:#fff;
    font-size:14px; width: 100%;
        ">
    <!-- Left Content: Made By Pranto Rodrix -->
    <div style="flex-shrink: 0;">
        Made by 
        <span style="
            background:linear-gradient(90deg,#06b6d4 0%, #a855f7 50%, #ec4899 100%);
            -webkit-background-clip:text; background-clip:text; color:transparent; 
            text-shadow:0 0 6px rgba(168,85,247,0.4);
            font-weight:700;">
            Pranto Rodrix
        </span>
    </div>

    <!-- Right Button: Back to Main Page -->
    <a href="index.html" 
       onclick="window.open(this.href, '_self'); return false;"
       style="
        /* Button Styles */
        display: inline-flex; align-items: center; text-decoration: none;
        padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 13px;
        white-space: nowrap; cursor: pointer; transition: all 0.2s ease;
        
        /* Glass Effect */
        background: rgba(255, 255, 255, 0.15); 
        /* Color shada kora holo jate Dark Theme e dekha jay */
        color: #fff; 
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        /* Text shadow kalo kora holo jate Light Theme e shada lekha shpoto hoy */
        text-shadow: 0 0 2px rgba(0,0,0,0.8); 
    " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'; this.style.transform='translateY(-1px)'" 
       onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'; this.style.transform='translateY(0)'">
       
        <!-- Arrow Icon (←) -->
        <span style="margin-right: 4px; font-size: 16px;">&#x2190;</span> 
        Main Page
    </a>
  </div>

    <div id="theme-toggle-container" class="" style="margin-top:2px;">
        <button id="theme-toggle" class="btn btn-theme-toggle d-flex align-items-center justify-content-center px-3 py-2">
            <i id="theme-icon" class="bi bi-sun-fill me-2"></i>
            <span id="theme-text" class="fw-medium">Light</span>
        </button>
    </div>

    <!-- ======== notes-content.txt থেকে আনা Tool Content ======== -->
    <!-- Glass UI এর সাথে মানানসই করার জন্য container-fluid ব্যবহার করা হলো -->
    <div id="dashboard-page" class="container-fluid eob-content my-3 px-4">

<!-- 4-Column EOB Layout, Glass Card ব্যবহার করা হয়েছে -->
        <div class="row g-3" style="margin-top:60px">
            
            <!-- Column 1: Input Area -->
            <div class="col-3">
                <!-- Section 1: Input Card (Glass UI) -->
                <div class="card p-4 h-100 d-flex flex-column">
                    <!-- EOB Input -->
                    <div class="mb-3 flex-grow-1 d-flex flex-column">
                        <label for="eobTextInput" class="form-label fw-bold">EOB:</label>
                        <textarea class="form-control h-100" id="eobTextInput" 
                                  placeholder="Paste Your
EOB Details Here"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Column 2: EOB Output Area 1 -->
            <div class="col-3">
                 <!-- EOB Output Card 1 (Glass UI) -->
                <div class="card p-4 h-100">
                    <h5 class="text-success fw-bold">EOB Results</h5>
                    <!--<hr style="border-color: var(--bs-border-color);">-->
                    <div id="eob-results-list-1" class="result-list">
                        <p><strong>Ticket #:</strong> <span id="eob_Ticket" class="output-value text-dark">--</span></p>
                        <p><strong>Patient:</strong> <span id="eob_Patient" class="output-value text-dark">--</span></p>
                        <p><strong>Claim #:</strong> <span id="eob_Claim" class="output-value text-dark">--</span></p>
                        <p><strong>Billed:</strong> <span id="eob_Billed" class="output-value">--</span></p>
                    </div>
                </div>
            </div>
            
            <!-- Column 3: EOB Output Area 2 -->
            <div class="col-3">
                 <!-- EOB Output Card 2 (Glass UI) -->
                <div class="card p-4 h-100">
                     <!--<h5 class="text-success fw-bold">EOB Results (2)</h5>-->
                     <!--<hr style="border-color: var(--bs-border-color);">-->
                    <div id="eob-results-list-2" class="result-list">
                        <p><strong>Paid:</strong> <span id="eob_Paid" class="output-value">--</span></p>
                        <p><strong>PT Resp:</strong> <span id="eob_PtResp_Sum" class="output-value">--</span></p>
                        <p><strong>Facility:</strong> <span id="eob_Provider" class="output-value text-dark">--</span></p>
                        <p><strong>Addl. Paid:</strong> <span id="eob_AddlPaid" class="output-value">--</span></p>
                    </div>
                </div>
            </div>

            <!-- Column 4: Buttons -->
            <div class="col-1">
              
            </div>
            <div class="col-2">
                <!-- Button Card (Glass UI) -->
                <div class=" p-1 h-100 d-flex flex-column justify-content-center">
                     <div class="d-grid gap-4">
                        <button type="button" class="btn btn-primary btn-lg w-100 rounded-pill" id="processButton">
                            <i class="bi bi-magic"></i> Extract
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-lg w-100 rounded-pill" id="clearButton">
                            <i class="bi bi-x-lg"></i> Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- IDR Section Rows (Glass UI) -->
        <div class="row g-3 mt-3">
            <!-- IDR Input Accordion (Glass UI) -->
            <div class="col-12">
                <div class="accordion" id="idrInputAccordion">
                    <!-- IDR 2024+ -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingIdr2024">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIdr2024" aria-expanded="true" aria-controls="collapseIdr2024">
                                <span class="h5 mb-0 fw-bold">IDR Inputs (2024+)</span>
                            </button>
                        </h2>
                        <div id="collapseIdr2024" class="accordion-collapse collapse show" aria-labelledby="headingIdr2024">
                            <div class="accordion-body">
                                 <div class="row g-3">
                                     <div class="col-3">
                                        <label for="idrTextInput1" class="form-label fw-bold">IDR Text 1:</label>
                                        <textarea class="form-control idr-textarea" id="idrTextInput1" rows="3"></textarea>
                                    </div>
                                     <div class="col-3">
                                        <label for="idrTextInput2" class="form-label fw-bold">IDR Text 2:</label>
                                        <textarea class="form-control idr-textarea" id="idrTextInput2" rows="3"></textarea>
                                    </div>
                                     <div class="col-3">
                                        <label for="idrTextInput3" class="form-label fw-bold">IDR Text 3:</label>
                                        <textarea class="form-control idr-textarea" id="idrTextInput3" rows="3"></textarea>
                                    </div>
                                     <div class="col-3">
                                        <label for="idrTextInput4" class="form-label fw-bold">IDR Text 4:</label>
                                        <textarea class="form-control idr-textarea" id="idrTextInput4" rows="3"></textarea>
                                    </div>
                                 </div>
                            </div>
                        </div>
                    </div>
                    <!-- IDR 2022-23 -->
                    <div class="accordion-item mt-3"> <!-- গ্যাপের জন্য mt-3 যোগ করা হলো -->
                        <h2 class="accordion-header" id="headingIdr2022">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIdr2022" aria-expanded="false" aria-controls="collapseIdr2022">
                                <span class="h5 mb-0 fw-bold">IDR Inputs (2022-23)</span>
                            </button>
                        </h2>
                        <div id="collapseIdr2022" class="accordion-collapse collapse" aria-labelledby="headingIdr2022">
                            <div class="accordion-body">
                                 <div class="row g-3">
                                     <div class="col-3">
                                        <label for="idr2022TextInput1" class="form-label fw-bold">IDR Text 1 (22-23):</label>
                                        <textarea class="form-control idr-textarea" id="idr2022TextInput1" rows="3"></textarea>
                                    </div>
                                     <div class="col-3">
                                        <label for="idr2022TextInput2" class="form-label fw-bold">IDR Text 2 (22-23):</label>
                                        <textarea class="form-control idr-textarea" id="idr2022TextInput2" rows="3"></textarea>
                                    </div>
                                     <div class="col-3">
                                        <label for="idr2022TextInput3" class="form-label fw-bold">IDR Text 3 (22-23):</label>
                                        <textarea class="form-control idr-textarea" id="idr2022TextInput3" rows="3"></textarea>
                                    </div>
                                     <div class="col-3">
                                        <label for="idr2022TextInput4" class="form-label fw-bold">IDR Text 4 (22-23):</label>
                                        <textarea class="form-control idr-textarea" id="idr2022TextInput4" rows="3"></textarea>
                                    </div>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- IDR Output Card (Glass UI) -->
            <div class="col-12">
                 <div class="card p-4">
                     <h5 class="text-primary fw-bold">IDR Results</h5>
                     <hr style="border-color: var(--bs-border-color);">
                     <div class="table-responsive">
                        <!-- টেবিলকে ডার্ক মোডের সাথে মানানসই করা হয়েছে -->
                        <table class="table table-borderless result-table" id="idrResultTable">
                            <thead id="idrDataTableHeader">
                                <tr class="">
                                    <th scope="col" class="sticky-col" style="left: 0;">Result #</th>
                                    <th scope="col" class="sticky-col" style="left: 100px;">Ticket #</th>
                                    <th scope="col" class="sticky-col" style="left: 220px;">IDR #</th>
                                    <th scope="col" class="sticky-col" style="left: 340px;">Claim #</th>
                                    <th scope="col" class="sticky-col" style="left: 490px;">CPT</th>
                                    <th scope="col">Initial Pmt</th>
                                    <th scope="col">Mediator</th>
                                    <th scope="col">Determ. Date</th>
                                    <th scope="col">Determ. W/L</th> 
                                    <th scope="col">Addl. Pmt</th>
                                    <th scope="col">Pmt Date</th>
                                    <th scope="col">Fee Refund</th>
                                    <th scope="col">Fee Refund Date</th>
                                    <th scope="col">W/L (Manual)</th>
                                    <th scope="col">Additional</th>
                                    <th scope="col">Refund</th>
                                </tr>
                            </thead>
                            <tbody id="idrDataTableBody">
                                <!-- Body generated by JS -->
                            </tbody>
                        </table>
                    </div>
                 </div>
            </div>

            <!-- Final Note Section (Glass UI) -->
            <div class="col-12">
                <div class="accordion" id="noteAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                <span class="h5 mb-0 fw-bold">Final Review_Win_Lose_Follow Up</span>
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#noteAccordion">
                            <div class="accordion-body">
                                <div class="row g-3">
                                    <div class="col-3">
                                        <label for="note_Name" class="form-label fw-bold">Name:</label>
                                        <input type="text" class="form-control" id="note_Name" value="PRANTO R">
                                        <label for="note_Initial" class="form-label fw-bold mt-2">Initial:</label>
                                        <input type="text" class="form-control" id="note_Initial">
                                        
                                        <div id="finalReviewAdjustments" class="mt-2" style="display: none;">
                                            <h6 class="text-decoration-underline" style="font-size: 0.9rem;">Adjustments:</h6>
                                            <p class="mb-1 result-list" style="font-size: 0.85rem;"><strong>Adjust with PT:</strong> <span id="adjustWithPt" class="output-value">--</span></p>
                                            <p class="mb-0 result-list" style="font-size: 0.85rem;"><strong>Adjust Without PT:</strong> <span id="adjustWithoutPt" class="output-value">--</span></p>
                                        </div>
                                        
                                        <div id="note_Warning_NoEOB" class="text-danger fw-bold mt-2" style="font-size: 0.9rem; display: none;">No EOB Found.</div>
                                        <div id="note_Warning_ClaimMismatch" class="text-danger fw-bold mt-2" style="font-size: 0.9rem; display: none;">IDR Claim numbers Didn't Match..</div>
                                    </div>
                                    <div class="col-7">
                                        <label for="note_Text" class="form-label fw-bold">Correspondence Note: (Click to Copy)</label>
                                        <textarea class="form-control copyable" id="note_Text" rows="10" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Note')"></textarea>
                                    </div>
                                    <div class="col-2 d-flex flex-column justify-content-end">
                                         <button class="btn btn-info rounded-pill w-100 mb-2" id="note_GenerateBtn">
                                             <i class="bi bi-pencil-square"></i> Generate Note
                                         </button>
                                         <span id="copy_Confirmation_Note" class="text-success text-center fw-bold mt-1" style="display: none;">Copied!</span>
                                         <button class="btn btn-outline-secondary rounded-pill w-100 mt-2" id="note_ClearBtn">
                                             <i class="bi bi-x-circle"></i> Clear Note
                                         </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

             <!-- Mail Generator Section (Glass UI) -->
            <div class="col-12">
                <div class="accordion" id="mailAccordion">
                    <div class="accordion-item mt-3"> <!-- গ্যাপের জন্য mt-3 যোগ করা হলো -->
                        <h2 class="accordion-header" id="headingMail">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMail" aria-expanded="false" aria-controls="collapseMail">
                                <span class="h5 mb-0 fw-bold">Auto Email Generator</span>
                            </button>
                        </h2>
                        <div id="collapseMail" class="accordion-collapse collapse" aria-labelledby="headingMail" data-bs-parent="#mailAccordion">
                            <div class="accordion-body">
                                <!-- Row for Inputs -->
                                <div class="row g-3 mb-3">
                                    <div class="col-3">
                                        <label for="note_Mail_Name" class="form-label fw-bold">My Name:</label>
                                        <input type="text" class="form-control" id="note_Mail_Name" value="Pranto Rodrix">
                                        <label for="note_Mail_Initial" class="form-label fw-bold mt-2">My Initial:</label>
                                        <input type="text" class="form-control" id="note_Mail_Initial" value="PRANTO R">
                                    </div>
                                    <div class="col-3">
                                        <label for="note_Mail_To" class="form-label fw-bold">To: (Click to copy)</label>
                                        <input type="email" class="form-control copyable" id="note_Mail_To" value="nsa.disputes@bcbstx.com" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Mail')">
                                        <label for="note_Mail_CC" class="form-label fw-bold mt-2">CC: (Click to copy)</label>
                                        <input type="email" class="form-control copyable" id="note_Mail_CC" value="mislam@roundtmc.com, razo@leverngear.com" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Mail')">
                                    </div>
                                    <div class="col-4">
                                        <label for="note_Mail_Subject" class="form-label fw-bold">Subject: (Click to Copy)</label>
                                        <input type="text" class="form-control copyable" id="note_Mail_Subject" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Mail')">
                                        
                                        <label for="note_Mail_Determ_Date" class="form-label fw-bold mt-2">Determination Date:</label>
                                        <input type="text" class="form-control" id="note_Mail_Determ_Date" placeholder="Auto-fills from IDR Result 1">
                                    </div>
                                    <div class="col-2">
                                        <label for="note_Mail_Type" class="form-label fw-bold">Email Type:</label>
                                        <select class="form-select" id="note_Mail_Type">
                                            <option value="" selected>Select...</option>
                                            <option value="1st Email">1st Email</option>
                                            <option value="2nd Email">2nd Email</option>
                                        </select>
                                         <button class="btn btn-secondary w-100 mt-2" data-bs-toggle="modal" data-bs-target="#emailTemplateModal">
                                            <i class="bi bi-pencil"></i> Edit Template
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Row for Mail Body, Note, and Buttons -->
                                <div class="row g-3">
                                    <!-- Mail Body -->
                                    <div class="col-6">
                                        <label for="note_Mail_Text" class="form-label fw-bold">Mail Body: (Click to Copy)</label>
                                        <textarea class="form-control copyable" id="note_Mail_Text" rows="10" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Mail')"></textarea>
                                    </div>
                                     <!-- Email Note -->
                                    <div class="col-4">
                                        <label for="mail_Note_Text" class="form-label fw-bold">Note for Email: (Click to Copy)</label>
                                        <textarea class="form-control copyable" id="mail_Note_Text" rows="10" readonly onclick="copyToClipboard(this, 'copy_Confirmation_Mail')"></textarea>
                                    </div>
                                    <!-- Mail Buttons -->
                                    <div class="col-2 d-flex flex-column justify-content-start">
                                         <button class="btn btn-info rounded-pill w-100 mb-2" id="note_Mail_GenerateBtn">
                                             <i class="bi bi-pencil-square"></i> Generate
                                         </button>
                                         <span id="copy_Confirmation_Mail" class="text-success text-center fw-bold mt-1 mb-2" style="display: none;">Copied!</span>
                                         <button class="btn btn-outline-secondary rounded-pill w-100" id="note_Mail_ClearBtn">
                                             <i class="bi bi-x-circle"></i> Clear
                                         </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    
    <!-- Email Edit Modal (Glass UI) -->
    <div class="modal fade" id="emailTemplateModal" tabindex="-1" aria-labelledby="emailTemplateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <!-- Glass Modal Content -->
            <div class="modal-content" style="background-color: var(--bs-glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--bs-glass-border);">
                <div class="modal-header" style="border-bottom-color: var(--bs-border-color);">
                    <h5 class="modal-title" id="emailTemplateModalLabel">Edit Email Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Edit the template below. The placeholders like [CLAIM_NUMBER] will be filled automatically.</p>
                    <textarea id="email_Template_Text" class="form-control" rows="20"></textarea>
                </div>
                <div class="modal-footer" style="border-top-color: var(--bs-border-color);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Save Template</button>
                </div>
            </div>
        </div>
    </div>

    <!--Footer Section-->
    <!-- NEW: Added .fade-in-section -->
            <footer id="main-footer" class="fade-in-section">
                <div class="container-fluid">
                    <div class="row g-4">
                        <!-- Column 1: About -->
                        <div class="col-4">
                            <h5><i class="bi bi-bar-chart-line-fill me-2 text-primary"></i>My Portfolio</h5>
                            <p class="small">
                                Your personal dashboard for tracking monthly performance, attendance, and career milestones.
                            </p>
                            <div class="mt-3 social-links">
                                <a href="https://www.linkedin.com/in/pranto-rodrix-90463615b/" target="blank" title="LinkedIn"><i class="bi bi-linkedin"></i></a>
                                <a href="https://github.com/prantorodrix/Attendance-Tracker" target="blank" title="GitHub"><i class="bi bi-github"></i></a>
                                <a href="https://x.com/pranto83945" target="blank" title="Twitter"><i class="bi bi-twitter-x"></i></a>
                            </div>
                        </div>
                        
                        <!-- Column 2: Quick Links -->
                        <div class="col-2">
                            <h5>Quick Links</h5>
                            <ul class="footer-links">
                                <li><a href="#profile-section">Profile</a></li>
                                <li><a href="#performance-section">Performance</a></li>
                                <li><a href="#dashboard-section">Dashboard</a></li>
                                <li><a href="#attendance-section">Attendance</a></li>
                                <li><a href="#idr-notes-section">IDR Notes</a></li>
                            </ul>
                        </div>

                        <!-- Column 3: Help & Support -->
                        <div class="col-3">
                            <h5>Help & Support</h5>
                            <ul class="footer-links">
                                <li><a href="#">FAQs</a></li>
                                <li><a href="#">Report an Issue</a></li>
                                <li><a href="#">Documentation</a></li>
                                <li><a href="#">Contact Support</a></li>
                            </ul>
                        </div>
                        
                        <!-- Column 4: Contact Info -->
                        <div class="col-3">
                            <h5>Contact</h5>
                            <ul class="footer-links">
                                <li class="d-flex align-items-center">
                                    <i class="bi bi-telephone-fill me-2"></i>
                                    <a href="tel:+8801700000000">+8801318138951</a>
                                </li>
                                <li class="d-flex align-items-center">
                                    <i class="bi bi-envelope-fill me-2"></i>
                                    <a href="mailto:prantorodrix@example.com">prantorodrix9@gmail.com</a>
                                </li>
                                <li class="d-flex align-items-center">
                                    <i class="bi bi-geo-alt-fill me-2"></i>
                                    <span>Dhaka, Bangladesh</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <hr class="my-4">
                    <div class="text-center small">
                        <p class="mb-0">Made by <span class="fw-semibold text-primary"><a href="https://www.facebook.com/pranto.anthony1/" target="black" title="Facebook">@PrantoRodrix</a></span></p>
                        <p class="mb-0">&copy; <span id="footer-year">2025</span> My Portfolio. All rights reserved.</p>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Page Navigation & EOB Logic Script -->
    <script>
        // --- DOM Elements ---
        const htmlEl = document.documentElement;
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const themeText = document.getElementById('theme-text');

        // --- index.html থেকে আনা Theme Toggle Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            updateAnimatedBackground(); // ইনিশিয়াল ব্যাকগ্রাউন্ড সেট
        });

        themeToggle.addEventListener('click', () => {
            const newTheme = htmlEl.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        });

        function setTheme(theme) {
            htmlEl.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            if (theme === 'dark') {
                themeIcon.classList.remove('bi-sun-fill');
                themeIcon.classList.add('bi-moon-fill');
                themeText.textContent = '';
            } else {
                themeIcon.classList.remove('bi-moon-fill');
                themeIcon.classList.add('bi-sun-fill');
                themeText.textContent = '';
            }
            updateAnimatedBackground(); // থিম চেঞ্জ হলে ব্যাকগ্রাউন্ড আপডেট
        }

        // --- index.html থেকে আনা Animated Background Logic ---
        // একটিভ ব্যাকগ্রাউন্ড ইমেজ ট্র্যাক করার জন্য
        let currentImageIndex = 0;

        function updateAnimatedBackground() {
            const theme = htmlEl.getAttribute('data-bs-theme');
            const bgImages = document.querySelectorAll(`.bg-image-${theme}`);
            if (bgImages.length === 0) return;

            // সব ইমেজ থেকে 'active' ক্লাস রিমুভ করা
            bgImages.forEach(img => img.classList.remove('active'));
            
            // পরবর্তী ইমেজ ইনডেক্স সেট করা
            currentImageIndex = (currentImageIndex + 1) % bgImages.length;
            
            // নতুন ইমেজকে 'active' করা
            bgImages[currentImageIndex].classList.add('active');
        }

        // প্রতি 5 সেকেন্ডে ব্যাকগ্রাউন্ড পরিবর্তন
        setInterval(updateAnimatedBackground, 5000);


        // --- notes-content.txt থেকে আনা Data Extraction Logic ---
        
        function formatCurrency(num) {
            if (isNaN(num)) {
                num = 0;
            }
            return '$' + num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function extractValueSkippingLines(text, labelRegex) {
            const match = text.match(labelRegex);
            if (!match) return null;

            const labelEndIndex = match.index + match[0].length;
            const subsequentText = text.substring(labelEndIndex);
            
            const lines = subsequentText.split(/[\r\n]+/);
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (trimmedLine.length > 0) {
                    if (trimmedLine.match(/^[a-zA-Z\s\.\/()-]+:/)) {
                        continue; 
                    }
                    return trimmedLine; 
                }
            }
            return null; 
        }
        
        function parseCurrency(value) {
            if (typeof value !== 'string') return 0;
            const cleaned = value.replace(/[$,\s]/g, '');
            return parseFloat(cleaned) || 0;
        }
        
        function getColumnValue(columns, index) {
            if (columns && columns.length > index && columns[index] !== "") {
                return columns[index].trim();
            }
            return "--";
        }
        
        function getFormattedDate() {
            const now = new Date();
            const bdTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Dhaka' }));
            
            const mm = String(bdTime.getMonth() + 1).padStart(2, '0');
            const dd = String(bdTime.getDate()).padStart(2, '0');
            const yy = String(bdTime.getFullYear()).slice(-2);
            
            return `${mm}/${dd}/${yy}`;
        }

        // --- Get EOB Cell Elements ---
        const eobTicketCell = document.getElementById('eob_Ticket');
        const eobAddlPaidCell = document.getElementById('eob_AddlPaid');
        
        // --- Note Generation Elements ---
        const noteNameInput = document.getElementById('note_Name');
        const noteInitialInput = document.getElementById('note_Initial');
        const noteTextInput = document.getElementById('note_Text');
        const noteGenerateBtn = document.getElementById('note_GenerateBtn'); 
        const noteClearBtn = document.getElementById('note_ClearBtn');
        const copyConfirmationNote = document.getElementById('copy_Confirmation_Note'); 
        const finalReviewAdjustments = document.getElementById('finalReviewAdjustments'); 
        const adjustWithPt = document.getElementById('adjustWithPt');
        const adjustWithoutPt = document.getElementById('adjustWithoutPt');
        const noteWarningNoEOB = document.getElementById('note_Warning_NoEOB'); 
        const noteWarningClaimMismatch = document.getElementById('note_Warning_ClaimMismatch'); 
        
        // --- Mail Generation Elements ---
        const mailNameInput = document.getElementById('note_Mail_Name');
        const mailInitialInput = document.getElementById('note_Mail_Initial'); 
        const mailToInput = document.getElementById('note_Mail_To');
        const mailCcInput = document.getElementById('note_Mail_CC');
        const mailTypeInput = document.getElementById('note_Mail_Type');
        const mailSubjectInput = document.getElementById('note_Mail_Subject');
        const mailDetermDateInput = document.getElementById('note_Mail_Determ_Date'); 
        const mailGenerateBtn = document.getElementById('note_Mail_GenerateBtn');
        const mailClearBtn = document.getElementById('note_Mail_ClearBtn');
        const mailTextInput = document.getElementById('note_Mail_Text');
        const mailNoteTextInput = document.getElementById('mail_Note_Text'); 
        const copyConfirmationMail = document.getElementById('copy_Confirmation_Mail'); 
        const emailTemplateText = document.getElementById('email_Template_Text');

        const defaultEmailTemplate = `Dear BCBS,

We are writing to formally request the prompt payment of the additional reimbursement as required by the final determination in the Federal Independent Dispute Resolution (IDR) process under the No Surprises Act (NSA).
On [DETERMINATION_DATE], [MEDIATOR_NAME] —the certified IDR entity—issued a final, legally binding determination in favor of , [PROVIDER_NAME] regarding the above-referenced claim. The IDR entity selected the out-of-network payment amount of [OON_RATE] for service code [CPT_CODE]. as offered by [PROVIDER_NAME] as the appropriate rate for this claim.
According to the NSA and its implementing regulations (including 45 CFR 149.510(c)(4)(vii)), the plan or issuer must pay the balance of the total plan or coverage amount selected by the certified IDR entity, less any initial payment already made and any applicable patient cost-sharing, within 30 calendar days of the determination notification. As of today, this payment is outstanding.

Request for Payment:
Please remit the outstanding balance, calculated as follows:
Claim Number: [CLAIM_NUMBER]
IDR-Determined OON Rate: [OON_RATE]
Less Initial Payment: [INITIAL_PAYMENT]
------------------------
Total Outstanding Balance: [OUTSTANDING_BALANCE]

This request is made pursuant to the No Surprises Act and its regulations, which require payment of the IDR-determined amount within 30 calendar days of the decision. Failure to remit payment in a timely manner may be reported to the appropriate regulatory authorities for noncompliance
If you have any questions or require additional documentation to process this payment, please contact us at bcbs_nsaandidr@roundtmc.com.

As per Federal guidelines additional payment amounts must be made within 30 days of the determination. If we do not receive the additional payment amount a CMS complaint may be filed. We appreciate your prompt attention to this matter.

For your reference we have attached the primary EOB and IDR determination.


Thank You
Regards
---------------
[MY_NAME]`;
        
        emailTemplateText.value = defaultEmailTemplate;

        
        function clearEobResults() {
             const eobCells = document.querySelectorAll('#eob-results-list-1 .output-value, #eob-results-list-2 .output-value');
            eobCells.forEach(cell => {
                cell.textContent = '--';
                cell.classList.remove('bg-match', 'bg-mismatch', 'bg-overpaid'); 
            });
            document.getElementById('eob_PtResp_Sum').textContent = '--';
        }

        function clearComparisonStyles() {
            eobTicketCell.classList.remove('bg-match', 'bg-mismatch', 'bg-overpaid');
            eobAddlPaidCell.classList.remove('bg-match', 'bg-mismatch', 'bg-overpaid');
            
            const idrCells = document.querySelectorAll('#idrDataTableBody td');
            idrCells.forEach(cell => {
                cell.classList.remove('bg-match', 'bg-mismatch', 'bg-overpaid');
                const input = cell.querySelector('input');
                if(input) {
                    input.classList.remove('is-invalid');
                    input.closest('td').classList.remove('bg-mismatch'); 
                }
            });
        }
        
        document.getElementById('clearButton').addEventListener('click', function() {
            document.getElementById('eobTextInput').value = '';
            document.getElementById('idrTextInput1').value = '';
            document.getElementById('idrTextInput2').value = '';
            document.getElementById('idrTextInput3').value = '';
            document.getElementById('idrTextInput4').value = ''; 
            document.getElementById('idr2022TextInput1').value = '';
            document.getElementById('idr2022TextInput2').value = '';
            document.getElementById('idr2022TextInput3').value = '';
            document.getElementById('idr2022TextInput4').value = ''; 

            clearEobResults();
            
            document.getElementById('idrDataTableBody').innerHTML = ''; 
            
            noteClearBtn.click();
            clearComparisonStyles();
            mailClearBtn.click();
        });
        
        noteTextInput.addEventListener('click', function() {
            copyToClipboard(noteTextInput, 'copy_Confirmation_Note');
        });
        
        noteClearBtn.addEventListener('click', function() {
             noteInitialInput.value = '';
             noteTextInput.value = '';
             finalReviewAdjustments.style.display = 'none'; 
             noteWarningNoEOB.style.display = 'none'; 
             noteWarningClaimMismatch.style.display = 'none'; 
        });
        
        noteGenerateBtn.addEventListener('click', function() {
            validateAndGenerateNote();
        });
        
        mailClearBtn.addEventListener('click', function() {
            mailSubjectInput.value = '';
            mailTextInput.value = '';
            mailNoteTextInput.value = ''; 
            mailCcInput.value = 'mislam@roundtmc.com, razo@leverngear.com';
            mailToInput.value = 'nsa.disputes@bcbstx.com';
            mailTypeInput.value = '';
            mailDetermDateInput.value = ''; 
            mailTypeInput.classList.remove('is-invalid');
            mailDetermDateInput.classList.remove('is-invalid');
        });
        
        mailGenerateBtn.addEventListener('click', function() {
            generateMail();
        });
        
        mailNoteTextInput.addEventListener('click', function() {
             copyToClipboard(mailNoteTextInput, 'copy_Confirmation_Mail');
        });
        mailTextInput.addEventListener('click', function() {
             copyToClipboard(mailTextInput, 'copy_Confirmation_Mail');
        });
        mailSubjectInput.addEventListener('click', function() {
             copyToClipboard(mailSubjectInput, 'copy_Confirmation_Mail');
        });

        function copyToClipboard(input, confirmationId) {
            input.select();
            document.execCommand('copy');
            
            const confirmationEl = document.getElementById(confirmationId);
            if (confirmationEl) {
                confirmationEl.style.display = 'block';
                setTimeout(() => { confirmationEl.style.display = 'none'; }, 2000);
            }
        }

        document.getElementById('processButton').addEventListener('click', function() {
            
            clearComparisonStyles();
            noteClearBtn.click(); 
            mailClearBtn.click(); 

            // --- EOB Tool Logic ---
            const eobText = document.getElementById('eobTextInput').value;
            let ticketNo = 'Not Found', addlPaidAmt = 0; 

            if (eobText.trim() === "") {
                clearEobResults(); 
            } else {
                const ticketNoMatch = eobText.match(/(Patient Account Number|Pt Acct No)\s*:?[\s\r\n]+([^\r\n]+)/i); 
                const ptNameMatch = eobText.match(/(Patient|Pt Name)(?! Information)\s*:?[\s\r\n]+([^\r\n]+)/i); 
                const claimNoMatch = eobText.match(/(Claim I?D|Claim No|Claim Number|Control Number)\s*:?[\s\r\n]+([^\r\n]+)/i); 
                const billingProviderMatch = eobText.match(/(Billing Provider|Provider Name)\s*:?[\s\r\n]+([^\r\n]+)/i);
                
                const billedStr = extractValueSkippingLines(eobText, /Billed( Amount)?\s*:?/i) || '$0.00';
                const paidStr = extractValueSkippingLines(eobText, /(Plan Paid|Paid Amount)\s*:?/i) || '$0.00'; 
                const ptRespStr = extractValueSkippingLines(eobText, /(Copay\/Deductible Amount|Copay|Deductible|Responsibility)\s*:?/i) || '$0.00';
                const coinsuranceStr = extractValueSkippingLines(eobText, /(Coinsurance Amount|Coinsurance|Co-insurance)\s*:?/i) || '$0.00';
                const addlPaidStr = extractValueSkippingLines(eobText, /Additional Paid( Amount)?\s*:?/i) || '$0.00';

                ticketNo = ticketNoMatch ? ticketNoMatch[2].trim() : 'Not Found'; 
                const ptName = ptNameMatch ? ptNameMatch[2].trim() : 'Not Found';
                const eobClaimNo = claimNoMatch ? claimNoMatch[2].trim() : 'Not Found'; 
                const billingProvider = billingProviderMatch ? billingProviderMatch[2].trim() : 'Not Found';
                
                const billedAmt = parseCurrency(billedStr); 
                const paidAmt = parseCurrency(paidStr); 
                const coinsuranceAmt = parseCurrency(coinsuranceStr);
                const ptRespAmt = parseCurrency(ptRespStr); 
                addlPaidAmt = parseCurrency(addlPaidStr); 

                eobTicketCell.textContent = ticketNo; 
                document.getElementById('eob_Patient').textContent = ptName;
                document.getElementById('eob_Claim').textContent = eobClaimNo;
                document.getElementById('eob_Billed').textContent = formatCurrency(billedAmt);
                document.getElementById('eob_Paid').textContent = formatCurrency(paidAmt);
                
                const ptRespSum = ptRespAmt + coinsuranceAmt;
                document.getElementById('eob_PtResp_Sum').textContent = formatCurrency(ptRespSum);

                document.getElementById('eob_Provider').textContent = billingProvider;
                eobAddlPaidCell.textContent = formatCurrency(addlPaidAmt);
            }
            
            // --- IDR Tool Logic ---
            const idrTextInputs = [
                { year: '2024+', text: document.getElementById('idrTextInput1').value, map: '2024+' },
                { year: '2024+', text: document.getElementById('idrTextInput2').value, map: '2024+' },
                { year: '2024+', text: document.getElementById('idrTextInput3').value, map: '2024+' },
                { year: '2024+', text: document.getElementById('idrTextInput4').value, map: '2024+' },
                { year: '2022-23', text: document.getElementById('idr2022TextInput1').value, map: '2022-23' },
                { year: '2022-23', text: document.getElementById('idr2022TextInput2').value, map: '2022-23' },
                { year: '2022-23', text: document.getElementById('idr2022TextInput3').value, map: '2022-23' },
                { year: '2022-23', text: document.getElementById('idr2022TextInput4').value, map: '2022-23' }
            ];
            
            const idrFields = [
                "Ticket #", "IDR #", "Claim #", "CPT", "Initial Pmt", "Mediator", 
                "Determ. Date", "Determ. W/L", "Addl. Pmt", "Pmt Date", 
                "Fee Refund", "Fee Refund Date",
                "W/L (Manual)", "Additional", "Refund" 
            ];
            
            const idrFieldIndexMap_2024 = {
                "Ticket #": 2, "IDR #": 1, "Claim #": 3, "CPT": 4, "Initial Pmt": 7, "Mediator": 8,
                "Determ. Date": 16, "Determ. W/L": 17, "Addl. Pmt": 18, "Pmt Date": 19,
                "Fee Refund": 20, "Fee Refund Date": 21,
                "W/L (Manual)": null, "Additional": null, "Refund": null
            };
            
            const idrFieldIndexMap_2022 = {
                "Ticket #": 1, "IDR #": 5, "Claim #": 2, "CPT": 3, "Initial Pmt": 7, "Mediator": 8,
                "Determ. Date": 18, "Determ. W/L": 19, "Addl. Pmt": 20, "Pmt Date": 21,
                "Fee Refund": 22, "Fee Refund Date": 23,
                "W/L (Manual)": null, "Additional": null, "Refund": null
            };
            
            const mapDictionary = {
                '2024+': idrFieldIndexMap_2024,
                '2022-23': idrFieldIndexMap_2022
            };

            const idrTableBody = document.getElementById('idrDataTableBody');
            idrTableBody.innerHTML = ''; 
            
            let allIdrAddlPmts = []; 
            let resultCounter = 1;
            let firstIdrDetermDate = null; 

            idrTextInputs.forEach((input, index) => {
                if (input.text.trim() === "") {
                    return; 
                }
                
                const currentMap = mapDictionary[input.map];
                
                const columns = input.text.split(/\t|\s{2,}/);
                let rowHtml = `<tr><th scope="row" class="sticky-col">Result ${resultCounter} (${input.year})</th>`;
                let rowResult = {}; 

                idrFields.forEach(field => {
                    if (currentMap[field] !== null) {
                        rowResult[field] = getColumnValue(columns, currentMap[field]);
                    }
                });
                
                if (resultCounter === 1) {
                    firstIdrDetermDate = rowResult["Determ. Date"];
                }

                idrFields.forEach(field => {
                    let displayValue = rowResult[field];
                    let cellHtml = '';
                    let cellId = `idr_${field.replace(/[^A-Za-z0-9]/g, '_')}_${index+1}`; 
                    let stickyClass = '';
                    
                    if(field === 'Ticket #' || field === 'IDR #' || field === 'Claim #' || field === 'CPT') {
                        stickyClass = 'sticky-col';
                    }

                    let isAmount = field === 'Initial Pmt' || field === 'Addl. Pmt' || field === 'Fee Refund';
                    let amountClass = isAmount ? 'output-value-amount' : '';
                    
                    if (isAmount && displayValue !== '--' && displayValue !== 'Not Found') {
                         displayValue = formatCurrency(parseCurrency(displayValue));
                    } else if (isAmount) {
                        displayValue = '$0.00'; 
                    }

                    if (field === "W/L (Manual)") {
                        let winLoseValue = rowResult["Determ. W/L"];
                        rowResult[field] = winLoseValue; 
                        if (winLoseValue === "--" || winLoseValue === "Not Found") {
                            cellHtml = `<td ${cellId} class="${stickyClass}"><input type="text" class="form-control form-control-sm editable-input win-lose-input" data-row-index="${index}"></td>`;
                        } else {
                            cellHtml = `<td ${cellId} class="${stickyClass}">${winLoseValue}</td>`;
                        }
                    } else if (field === "Additional") {
                        const paymentDate = rowResult["Pmt Date"];
                        displayValue = (paymentDate !== "--" && paymentDate !== "Not Found") ? "Received" : "Waiting";
                        rowResult[field] = displayValue; 
                        cellHtml = `<td ${cellId} class="${stickyClass}">${displayValue}</td>`;
                    } else if (field === "Refund") {
                        const winLoseValue = rowResult["Determ. W/L"] ? rowResult["Determ. W/L"].toLowerCase() : '';
                        let isDisabled = (winLoseValue === 'lose'); 
                        let isInvalid = (winLoseValue === 'win'); 
                        
                        if (winLoseValue === 'close') {
                            isDisabled = false;
                            isInvalid = false;
                        }
                        
                        cellHtml = `<td class="${stickyClass} ${isInvalid ? 'bg-mismatch' : ''}">
                                        <input type="text" 
                                               class="form-control form-control-sm editable-input refund-input ${isInvalid ? 'is-invalid' : ''}" 
                                               data-row-index="${index}" 
                                               oninput="autocompleteRefund(this)" 
                                               ${isDisabled ? 'disabled' : ''}>
                                    </td>`;
                        rowResult[field] = isDisabled ? 'N/A' : ''; 
                    } else {
                        // Standard cell
                        cellHtml = `<td id="${cellId}" class="${stickyClass} ${amountClass}">${displayValue}</td>`;
                    }
                    
                    rowHtml += cellHtml;
                });

                rowHtml += '</tr>';
                idrTableBody.innerHTML += rowHtml;
                
                allIdrAddlPmts.push(parseCurrency(rowResult["Addl. Pmt"]));
                resultCounter++; 
            });
            
            // --- Comparison Logic ---
            const allIdrTicketCells = document.querySelectorAll('#idrDataTableBody td:nth-child(2)'); 
            const allIdrAddlPmtCells = document.querySelectorAll('#idrDataTableBody td:nth-child(10)'); 
            
            let eobTicketMatched = false;
            allIdrTicketCells.forEach(cell => {
                if (ticketNo !== 'Not Found' && cell.textContent !== '--') {
                     if (ticketNo === cell.textContent) {
                        cell.classList.add('bg-match');
                        eobTicketMatched = true;
                    } else {
                        cell.classList.add('bg-mismatch');
                    }
                }
            });
            
            if (eobText.trim().length > 0 && allIdrTicketCells.length > 0) {
                if (eobTicketMatched) {
                    eobTicketCell.classList.add('bg-match');
                } else {
                    eobTicketCell.classList.add('bg-mismatch');
                }
            }
            
            if (firstIdrDetermDate) {
                mailDetermDateInput.value = firstIdrDetermDate;
            }
        });
        
        // --- Note Generation & Validation Functions ---

        function validateAndGenerateNote() {
            let validationPassed = true;
            let activeIdrRows = [];
            finalReviewAdjustments.style.display = 'none'; 
            noteWarningNoEOB.style.display = 'none';
            noteWarningClaimMismatch.style.display = 'none';
            
            const idrRows = document.querySelectorAll('#idrDataTableBody tr');
            let idrClaimNumbers = []; 
            
            idrRows.forEach((row, index) => {
                const winLoseInput = row.querySelector('.win-lose-input');
                const refundInput = row.querySelector('.refund-input');
                
                let rowData = {
                    idrNum: row.cells[2].textContent,
                    claimNum: row.cells[3].textContent, 
                    cpt: row.cells[4].textContent,
                    mediator: row.cells[6].textContent, 
                    addlPmt: row.cells[9].textContent, 
                    additionalStatus: row.cells[14].textContent, 
                    winLoseStatus: '',
                    refundStatus: ''
                };
                
                if(rowData.claimNum !== '--' && rowData.claimNum !== 'Not Found') {
                    idrClaimNumbers.push(rowData.claimNum);
                }
                
                let currentWLStatus = '';
                if (winLoseInput) {
                    if (winLoseInput.value.trim() === '') {
                        validationPassed = false;
                        winLoseInput.classList.add('is-invalid');
                    }
                    currentWLStatus = winLoseInput.value.toLowerCase();
                } else {
                    currentWLStatus = row.cells[13].textContent.toLowerCase(); 
                }
                rowData.winLoseStatus = currentWLStatus;

                if (refundInput) {
                    if (currentWLStatus === 'win' && refundInput.value.trim() === '') {
                        validationPassed = false;
                        refundInput.classList.add('is-invalid');
                        refundInput.closest('td').classList.add('bg-mismatch');
                    }
                    rowData.refundStatus = refundInput.value;
                }
                
                activeIdrRows.push(rowData);
            });

            if (!validationPassed) {
                noteInitialInput.value = "ERROR";
                noteTextInput.value = "ERROR: PLEASE FILL ALL REQUIRED W/L AND REFUND FIELDS IN THE IDR TABLE (MARKED IN RED).";
                return;
            }
            
            const allSame = idrClaimNumbers.every(c => c === idrClaimNumbers[0]);
            if (!allSame && idrClaimNumbers.length > 0) {
                noteWarningClaimMismatch.style.display = 'block';
            }
            
            let initial = "IDR FOLLOW UP"; 
            let allReceived = activeIdrRows.length > 0;
            
            activeIdrRows.forEach(row => {
                if (row.additionalStatus.toLowerCase() !== 'received') allReceived = false;
                
                if (row.winLoseStatus === 'win' && row.refundStatus.toLowerCase() !== 'received') {
                    allReceived = false;
                }
                
                if (row.winLoseStatus === 'close' && row.refundStatus.toLowerCase() === 'waiting') {
                    allReceived = false; 
                }
            });

            if (allReceived) {
                initial = "FINAL REVIEW";
            } else if (activeIdrRows.length === 1) {
                const status = activeIdrRows[0].winLoseStatus;
                if (status === 'win') initial = 'IDR WIN';
                else if (status === 'lose') initial = 'IDR LOSE';
                else initial = 'IDR FOLLOW UP'; 
            } else if (activeIdrRows.length > 1) {
                initial = "IDR FOLLOW UP";
            }
            
            noteInitialInput.value = initial;
            
            const eobText = document.getElementById('eobTextInput').value.trim();
            const eobExists = eobText.length > 0 && document.getElementById('eob_Claim').textContent !== '--';
            
            const eobClaimNo = document.getElementById('eob_Claim').textContent;
            const eobBilled = parseCurrency(document.getElementById('eob_Billed').textContent);
            const eobPaid = parseCurrency(document.getElementById('eob_Paid').textContent);
            const ptRespSum = parseCurrency(document.getElementById('eob_PtResp_Sum').textContent); 

            const today = getFormattedDate(); 
            const name = noteNameInput.value || 'PRANTO R';
            
            let note = `${today}>${initial}>${name}>WORKING ON TRACKING SHEET. `;
            
            if (eobExists) {
                note += `CLAIM: ${eobClaimNo}; TOTAL BILL ${formatCurrency(eobBilled)}, INS PAID ${formatCurrency(eobPaid)}, PT RESPONSIBLITY ${formatCurrency(ptRespSum)}. NEGOTIATION AND IDR DONE. `;
            } else {
                noteWarningNoEOB.style.display = 'block';
                let claimForNote = (activeIdrRows.length > 0) ? activeIdrRows[0].claimNum : 'N/A';
                note += `CLAIM: ${claimForNote}. NEGOTIATION AND IDR DONE. `;
            }

            activeIdrRows.forEach(row => {
                let wlStatus = (row.winLoseStatus === '--' || row.winLoseStatus === 'not found' || row.winLoseStatus === '') ? 'N/A' : row.winLoseStatus.toUpperCase();
                
                note += `${row.idrNum}: IDR SUBMITTED ON CPT ${row.cpt} TO MEDIATOR ${row.mediator}. STATUS IS ${wlStatus} WITH ADDITIONAL ${row.addlPmt}. `;
                
                if (row.additionalStatus.toLowerCase() === 'received') {
                    note += "WE RECEIVED ADDITIONAL PAYMENT. ";
                } else {
                    note += "WE ARE WAITING FOR ADDITIONAL PAYMENT. ";
                }
                
                if (row.winLoseStatus === 'win') {
                    if (row.refundStatus.toLowerCase() === 'received') {
                        note += "WE RECEIVED FEE REFUND. ";
                    } else {
                        note += "WE ARE WAITING FOR FEE REFUND. ";
                    }
                }
                
                if (row.winLoseStatus === 'close' && row.refundStatus.toLowerCase() === 'received') {
                     note += "STATUS CLOSED AND WE RECEIVED FEE REFUND. ";
                }
            });
            
            if (initial === 'FINAL REVIEW') {
                note += "NO FURTHER ACTION NEEDED. BALANCE TO BE ADJUSTED.";
                const adjustWithPtVal = eobBilled - (eobPaid + ptRespSum);
                const adjustWithoutPtVal = eobBilled - eobPaid;
                adjustWithPt.textContent = formatCurrency(adjustWithPtVal);
                adjustWithoutPt.textContent = formatCurrency(adjustWithoutPtVal);
                finalReviewAdjustments.style.display = 'block';
            } else {
                note += "WAITING TO COMPLETE THE IDR PROCESS BEFORE ADJUSTMENT.";
                finalReviewAdjustments.style.display = 'none';
            }
            
            noteTextInput.value = note.trim().toUpperCase();
        }
        
        // --- Mail Generation Function ---
        function generateMail() {
            mailTypeInput.classList.remove('is-invalid');
            mailDetermDateInput.classList.remove('is-invalid');
            mailTextInput.value = ''; 
            mailNoteTextInput.value = ''; 
            
            const eobText = document.getElementById('eobTextInput').value.trim();
            const idrRows = document.querySelectorAll('#idrDataTableBody tr');
            
            if (eobText.length === 0 || document.getElementById('eob_Claim').textContent === '--') {
                mailTextInput.value = "ERROR: EOB Data is missing. Please paste the EOB text.";
                return;
            }
            if (idrRows.length === 0) {
                mailTextInput.value = "ERROR: No IDR results found. Please extract IDR data first.";
                return;
            }
            if (idrRows.length > 1) {
                mailTextInput.value = "ERROR: Mail Generation only works for a single IDR result. Please process only one IDR entry.";
                return;
            }
            const emailType = mailTypeInput.value;
            if (emailType === "") {
                mailTypeInput.classList.add('is-invalid');
                mailTextInput.value = "ERROR: Please select an Email Type (1st or 2nd).";
                return;
            }
            const determDate = mailDetermDateInput.value.trim();
            const dateRegex = /^\d{1,2}\/\d{1,2}\/\d{2,4}$/;
            if (determDate === "" || determDate === "--" || !dateRegex.test(determDate)) {
                mailDetermDateInput.classList.add('is-invalid');
                mailTextInput.value = "ERROR: Determination Date is missing or invalid. Please correct it.";
                return;
            }
            
            const idrRow = idrRows[0];
            
            const provider = document.getElementById('eob_Provider').textContent;
            let eobClaim = document.getElementById('eob_Claim').textContent;
            
            const idrNum = idrRow.cells[2].textContent;
            const idrClaim = idrRow.cells[3].textContent; 
            const cpt = idrRow.cells[4].textContent;
            const initialPmt = idrRow.cells[5].textContent; 
            const mediator = idrRow.cells[6].textContent; 
            const addlPmt = idrRow.cells[9].textContent; 
            
            let finalClaim = (eobClaim !== '--' && eobClaim !== 'Not Found') ? eobClaim : idrClaim;
            
            const myName = mailNameInput.value || 'Pranto Rodrix';
            const myInitial = mailInitialInput.value || 'PRANTO R'; 

            const initialPmtNum = parseCurrency(initialPmt);
            const addlPmtNum = parseCurrency(addlPmt);
            const oonRateNum = initialPmtNum + addlPmtNum; 

            let subject = `Urgent Request for Claim Reprocessing as per IDR Determination - ${idrNum} and Claim Number: ${finalClaim}`;
            if (emailType === '2nd Email') {
                subject += " (2nd Email)";
            }
            mailSubjectInput.value = subject;
            
            let mailBody = emailTemplateText.value;
            
            mailBody = mailBody.replace(/\[DETERMINATION_DATE\]/g, determDate); 
            mailBody = mailBody.replace(/\[MEDIATOR_NAME\]/g, mediator);
            mailBody = mailBody.replace(/\[PROVIDER_NAME\]/g, provider);
            mailBody = mailBody.replace(/\[OON_RATE\]/g, formatCurrency(oonRateNum));
            mailBody = mailBody.replace(/\[CPT_CODE\]/g, cpt);
            mailBody = mailBody.replace(/\[CLAIM_NUMBER\]/g, finalClaim);
            mailBody = mailBody.replace(/\[INITIAL_PAYMENT\]/g, formatCurrency(initialPmtNum));
            mailBody = mailBody.replace(/\[OUTSTANDING_BALANCE\]/g, formatCurrency(addlPmtNum));
            mailBody = mailBody.replace(/\[MY_NAME\]/g, myName);
            
            mailTextInput.value = mailBody.trim();

            const today = getFormattedDate(); 
            let noteType = (emailType === '1st Email') ? "1st FOLLOW UP" : "2nd FOLLOW UP";
            
            let emailNote = `${today}>IDR FOLLOW UP>${myInitial}>WORKING ON IDR TRACKING SHEET. NEGOTIATION AND IDR DONE. ACCORDING TO OUR RECORDS, FOR ${finalClaim}; WE HAVE NOT RECEIVED THE ADDITIONAL PAYMENT AMOUNT OF ${formatCurrency(addlPmtNum)} AND THE UPDATED EOB, AS PER THE DETERMINATION OF ${idrNum}, BY ${mediator} DATED ${determDate}. FOR BCBS ATTENTION, WE SENT ${noteType} EMAIL TO BCBS FOR THE IDR ADDITIONAL PAYMENT.`;
            
            mailNoteTextInput.value = emailNote.trim().toUpperCase();
        }


        function autocompleteRefund(input) {
            const value = input.value.toLowerCase();
            if (value === 'r') input.value = 'Received';
            if (value === 'w') input.value = 'Waiting';
            
            if (input.value !== '') {
                input.classList.remove('is-invalid');
                input.closest('td').classList.remove('bg-mismatch');
            }
        }
        window.autocompleteRefund = autocompleteRefund; // গ্লোবাল করা হলো
        
        document.getElementById('idrDataTableBody').addEventListener('input', function(e) {
            const target = e.target;
            
            if (target.classList.contains('refund-input')) {
                autocompleteRefund(target);
            }
            
            if (target.classList.contains('win-lose-input')) {
                const value = target.value.toLowerCase();
                if (value === 'w') target.value = 'Win';
                if (value === 'l') target.value = 'Lose';
                if (value === 'c') target.value = 'Closed';
                
                const tr = target.closest('tr');
                const refundInput = tr.querySelector('.refund-input');
                const refundCell = refundInput.closest('td');
                const newStatus = target.value.toLowerCase();
                
                if (newStatus === 'win') {
                    refundInput.disabled = false;
                    if (refundInput.value === '') {
                        refundCell.classList.add('bg-mismatch');
                        refundInput.classList.add('is-invalid');
                    } else {
                         refundCell.classList.remove('bg-mismatch');
                         refundInput.classList.remove('is-invalid');
                    }
                } else if (newStatus === 'lose') {
                    refundInput.disabled = true;
                    refundInput.value = '';
                    refundCell.classList.remove('bg-mismatch');
                    refundInput.classList.remove('is-invalid');
                } else if (newStatus === 'close') {
                    refundInput.disabled = false; 
                    refundCell.classList.remove('bg-mismatch'); 
                    refundInput.classList.remove('is-invalid');
                } else {
                    refundInput.disabled = false;
                    refundCell.classList.remove('bg-mismatch');
                    refundInput.classList.remove('is-invalid');
                }
            }
        });

    </script>
</body>
</html>
