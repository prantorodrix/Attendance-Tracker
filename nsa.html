<!DOCTYPE html>
<!-- data-bs-theme="light" default -->
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pranto's NSA Tool</title>
    <link rel="icon" type="image/png" href="nsa.png"> 
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* --- Base Styles --- */
        :root {
            --font-heading: 'Poppins', sans-serif;
            --font-body: 'Inter', sans-serif;
            --bs-body-bg: #f3e7ff;
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(255, 255, 255, 0.5);
            --primary-gradient: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            --sidebar-width: 320px;
            --top-bar-height: 65px;
        }
        
        [data-bs-theme="dark"] {
            --bs-body-bg: #0a0c10;
            --glass-bg: rgba(16, 18, 23, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bs-body-bg);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s;
        }
        
        .bg-image {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-size: cover; background-position: center;
            filter: blur(10px); opacity: 0.8; transform: scale(1.1);
        }
        [data-bs-theme="light"] .bg-light-img { background-image: url('https://cdn.pixabay.com/photo/2018/01/14/23/12/nature-3082832_1280.jpg'); }
        [data-bs-theme="dark"] .bg-dark-img { background-image: url('https://cdn.pixabay.com/photo/2016/11/29/05/45/astronomy-1867616_1280.jpg'); }
        [data-bs-theme="light"] .bg-dark-img { display: none; }
        [data-bs-theme="dark"] .bg-light-img { display: none; }

        /* Glass Card */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* Top Bar */
        #top-bar-container {
            position: fixed; top: 0; width: 100%; height: var(--top-bar-height);
            z-index: 1000; display: flex; align-items: center; padding: 0 1.5rem;
            background: var(--glass-bg); border-bottom: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }

        /* Layout */
        #main-wrapper { display: flex; margin-top: var(--top-bar-height); height: calc(100vh - var(--top-bar-height)); }
        
        #sidebar {
            width: var(--sidebar-width); min-width: 280px;
            display: flex; flex-direction: column;
            border-right: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.05);
        }
        #sidebar-content { overflow-y: auto; flex: 1; padding: 0.5rem; }
        #main-content { flex: 1; overflow-y: auto; padding: 1rem; }

        /* Premium Buttons */
        .btn-premium {
            background: var(--primary-gradient); border: none; color: white;
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3); transition: transform 0.2s;
        }
        .btn-premium:hover { transform: translateY(-2px); color: white; }
        
        .nav-link-custom {
            color: var(--bs-body-color); padding: 0.5rem 1rem; border-radius: 8px;
            text-decoration: none; font-weight: 500; transition: 0.2s; font-size: 1rem;
        }
        .nav-link-custom.active { background: var(--primary-gradient); color: white; }
        .nav-link-custom.active:hover { color: white; }
        .nav-link-custom:hover:not(.active) { background: rgba(128,128,128,0.1); }

        .form-control, .form-select {
            background-color: var(--bs-tertiary-bg); border: 1px solid var(--glass-border);
            border-radius: 8px; font-size: 0.9rem;
        }
        .form-control:focus { box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2); border-color: #06b6d4; }
        
        .is-invalid { border-color: #ef4444 !important; box-shadow: 0 0 0 4px rgba(239,68,68,0.1) !important; animation: shake 0.4s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25%, 75% {transform: translateX(4px);} 50% {transform: translateX(-4px);} }

        .nav-tabs-glass { border-bottom: 1px solid var(--glass-border); padding: 0 0.5rem; }
        .nav-tabs-glass .nav-link {
            border: none; background: transparent; color: var(--bs-body-color); opacity: 0.7; font-weight: 600;
        }
        .nav-tabs-glass .nav-link.active { opacity: 1; color: #06b6d4; border-bottom: 2px solid #06b6d4; }
        
        /* Result Table Styles */
        .nsa-result-table { 
            width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.75rem; 
            margin-bottom: 0.5rem;
        }
        .nsa-result-table th { 
            background: rgba(6, 182, 212, 0.1); color: var(--bs-secondary-color); 
            font-weight: 700; padding: 6px 8px; text-align: left; border-bottom: 1px solid var(--glass-border);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;
        }
        .nsa-result-table td { 
            padding: 6px 8px; color: var(--bs-body-color); border-bottom: 1px solid var(--glass-border);
            word-break: break-word; vertical-align: top; font-weight: 600;
        }
        .nsa-result-table tr:last-child td { border-bottom: none; }
        
        /* Member ID Highlight */
        .mem-prefix { color: #d946ef; font-weight: 900; font-size: 1.1em; }
        [data-bs-theme="dark"] .mem-prefix { color: #f0abfc; }

        /* Badges */
        .highlight-process {
            background: #0e7490; color: #ffffff !important;
            padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem;
        }
        [data-bs-theme="dark"] .highlight-process { background: #0891b2; }
        
        .highlight-lonster {
            background: #7e22ce; color: #ffffff !important;
            padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem;
        }
        [data-bs-theme="dark"] .highlight-lonster { background: #a855f7; }
        
        /* Excel Box - Light Green */
        .excel-box {
            background-color: #f0fdf4;
            border: 1px solid #10b981;
            cursor: pointer;
            transition: all 0.2s;
        }
        [data-bs-theme="dark"] .excel-box { background-color: rgba(16, 185, 129, 0.2); border-color: #34d399; }
        
        .excel-box:hover {
            background-color: #dcfce7;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
        }
        
        #excel_Copy_Input {
             font-family: monospace;
             font-size: 0.85rem;
             color: #047857; 
             font-weight: 600;
             background: transparent;
             border: none;
             width: 100%;
             cursor: pointer;
        }
        [data-bs-theme="dark"] #excel_Copy_Input { color: #6ee7b7; }
        #excel_Copy_Input:focus { outline: none; }

        /* CSS ভেরিয়েবল সেটআপ: ডার্ক মোড (ডিফল্ট) */
        :root {
            --bg-main: linear-gradient(135deg, #101010 0%, #050505 100%);
            --shadow-main: 0 10px 30px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
            --text-primary: #FFFFFF;
            --text-secondary: #777;
            --circle-bg-color: #333;
            --dot-fill: #FFFFFF;
        }

        /* লাইট মোডের জন্য স্টাইল ওভাররাইড (যদি বডিতে data-bs-theme="light" থাকে) */
        body[data-bs-theme="light"] {
            --bg-main: linear-gradient(135deg, #F0F0F0 0%, #FFFFFF 100%);
            --shadow-main: 0 8px 20px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05) inset;
            --text-primary: #1A1A1A;
            --text-secondary: #888;
            --circle-bg-color: #E0E0E0;
            --dot-fill: #1A1A1A;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            /* পেজের ডিফল্ট ব্যাকগ্রাউন্ড কালার ব্যবহার করার জন্য 'background' প্রপার্টি সরানো হলো */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            position: relative;
        }

        .time-card {
            position: relative;
            background: var(--bg-main); /* অ্যাডাপ্টিভ ব্যাকগ্রাউন্ড */
            border-radius: 15px; 
            box-shadow: var(--shadow-main); /* অ্যাডাপ্টিভ শ্যাডো */
            width: 100%;
            max-width: 380px; 
            padding: 20px; 
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .date-info {
            flex: 1;
            text-align: left;
            padding-right: 15px;
        }
        
        /* দেশের লেবেল */
        .country-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary); /* অ্যাডাপ্টিভ কালার */
            margin-bottom: 5px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .date-display {
            font-size: 0.9rem; 
            font-weight: 600;
            color: var(--text-secondary); /* অ্যাডাপ্টিভ কালার */
            margin-bottom: 3px;
        }

        .month-day {
            font-size: 1.5rem; 
            font-weight: 700;
            color: var(--text-primary); /* অ্যাডাপ্টিভ কালার */
            letter-spacing: 1px;
            line-height: 1.2;
        }

        .time-area {
            position: relative;
            width: 130px; 
            height: 130px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .time-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 2.0rem; 
            font-weight: 700;
            color: var(--text-primary); /* অ্যাডাপ্টিভ কালার */
            letter-spacing: -1px;
            position: absolute;
            z-index: 20;
        }
        
        .time-text span { /* AM/PM এর জন্য */
            font-size: 0.35em;
            vertical-align: super;
            margin-left: 3px;
            font-weight: 400;
        }
        
        /* বাংলাদেশ (BD) স্টাইল (অ্যাকসেন্ট কালার অপরিবর্তিত থাকবে) */
        .time-card-bd .time-text span, .time-card-bd .dot-accent, .time-card-bd .circle-progress {
            color: #00BCD4; /* সায়ান অ্যাকসেন্ট */
            stroke: #00BCD4; 
        }

        /* USA (US) স্টাইল (অ্যাকসেন্ট কালার অপরিবর্তিত থাকবে) */
        .time-card-us .time-text span, .time-card-us .dot-accent, .time-card-us .circle-progress {
            color: #FF7043; /* কমলা/লাল অ্যাকসেন্ট */
            stroke: #FF7043; 
        }

        .timer-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .circle-bg {
            stroke: var(--circle-bg-color); /* অ্যাডাপ্টিভ কালার */
            stroke-width: 6; 
            fill: none;
        }

        .circle-progress {
            stroke-width: 6; 
            fill: none;
            stroke-linecap: round;
            transform-origin: 50% 50%;
            transform: rotate(-90deg);
            transition: stroke-dashoffset 0.1s linear; 
        }

        .dot {
            fill: var(--dot-fill); /* অ্যাডাপ্টিভ কালার */
            animation: pulse 1.5s infinite alternate; 
        }

        .dot-accent {
            animation: pulse-accent 1.5s infinite alternate 0.5s; 
        }

        @keyframes pulse {
            from { opacity: 0.6; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1.1); }
        }

        @keyframes pulse-accent {
            from { opacity: 0.4; transform: scale(0.8); }
            to { opacity: 0.9; transform: scale(1.0); }
        }

        /* Loader */
        .btn-loading { pointer-events: none; color: transparent !important; position: relative; }
        .btn-loading::after {
            content: ''; position: absolute; top: 50%; left: 50%; margin: -9px;
            width: 18px; height: 18px; border: 2px solid #fff; border-radius: 50%;
            border-right-color: transparent; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to {transform:rotate(360deg);} }
        
        /* Textarea - No Scrollbar */
        textarea { font-family: monospace; resize: none; cursor: pointer !important; overflow: hidden; }
        textarea:focus { cursor: text !important; }
        #eobInput { overflow: auto; cursor: text !important; } 
        
        /* Footer */
        #main-footer {
            background-color: var(--bs-glass-bg); border-top: 1px solid var(--bs-glass-border);
            backdrop-filter: blur(10px); color: var(--bs-secondary-color);
            padding: 3rem 1.5rem 1.5rem 1.5rem; margin-top: 1.5rem; font-size: 0.9rem;
        }
        #main-footer h5 { font-weight: 700; color: var(--bs-body-color); margin-bottom: 1rem; font-size: 1.1rem; }
        #main-footer .footer-links { list-style: none; padding-left: 0; }
        #main-footer .footer-links li { margin-bottom: 0.5rem; }
        #main-footer .footer-links a { color: var(--bs-secondary-color); text-decoration: none; transition: color 0.2s ease; }
        #main-footer .footer-links a:hover { color: var(--bs-primary); text-decoration: underline; }
        #main-footer .social-links a { font-size: 1.5rem; color: var(--bs-secondary-color); margin-right: 1rem; transition: color 0.2s ease; }
        #main-footer .social-links a:hover { color: var(--bs-primary); }
        #main-footer .footer-bottom { border-top: 1px solid var(--bs-border-color); padding-top: 1.5rem; margin-top: 1.5rem; text-align: center; }
        #main-footer .footer-bottom a { color: var(--bs-primary); text-decoration: none; font-weight: 600; }
        #main-footer .footer-bottom a:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <div class="bg-image bg-light-img"></div>
    <div class="bg-image bg-dark-img"></div>

    <!-- Top Bar -->
    <div id="top-bar-container">
        <div class="row w-100 align-items-center m-0">
            <div class="col-auto p-0">
                Made by <span style="background:linear-gradient(90deg,#06b6d4 0%, #3b82f6 100%); -webkit-background-clip:text; background-clip:text; color:transparent; font-weight:700;">Pranto Rodrix</span>
            </div>
            <div class="col d-flex justify-content-center gap-2">
                <a href="#" class="nav-link-custom active">NSA</a>
                <!--<a href="appeal_tool.html" class="nav-link-custom">Appeal</a>-->
                <a href="index.html" class="nav-link-custom">Main Page</a>
            </div>
            <div class="col-auto p-0 d-flex gap-2">
                <button class="btn btn-premium btn-sm rounded-pill px-3 fw-bold" id="extractBtn"><i class="bi bi-magic"></i> Extract</button>
                <button class="btn btn-outline-danger btn-sm rounded-pill px-3 fw-bold" id="clearBtn"><i class="bi bi-trash"></i> Clear</button>
                <button id="theme-toggle" class="btn btn-light btn-sm rounded-circle"><i class="bi bi-sun-fill"></i></button>
            </div>
        </div>
    </div>

    <div id="main-wrapper">
        <!-- Sidebar -->
        <div id="sidebar">
            <div class="p-3 border-bottom border-color-subtle">
                <h6 class="text-primary m-0 fw-bold small text-uppercase"><i class="bi bi-clipboard-data me-2"></i>Table Input</h6>
            </div>
            <div id="sidebar-content">
                <div class="p-3 d-flex flex-column gap-3">
                    <!-- Paste Box -->
                    <div class="card p-0 overflow-hidden border-primary border-opacity-25 shadow-sm">
                        <textarea id="eobInput" class="form-control border-0 rounded-0" style="min-height: 120px; font-size:0.75rem; white-space: pre; background: rgba(255,255,255,0.5);" placeholder="Paste NSA Table Data here..."></textarea>
                    </div>

                    <!-- Time Boxes -->
                      <!-- বাংলাদেশ টাইম কার্ড -->
    <div class="time-card time-card-bd" id="bdWatch">
        <div class="date-info">
            <div class="country-label">Bd</div>
            <div class="date-display" id="bdFullDate">--</div>
            <div class="month-day" id="bdMonthDay">--</div>
        </div>
        
        <div class="time-area">
            <div class="time-text" id="bdDigitalTime">--:--<span>PM</span></div>
            
            <svg class="timer-svg" viewBox="0 0 100 100">
                <circle class="circle-bg" cx="50" cy="50" r="45"></circle>
                <circle class="circle-progress" id="bdSecondProgress" cx="50" cy="50" r="45"></circle>
                
                <circle class="dot" cx="50" cy="5" r="2"></circle> 
                <circle class="dot-accent" cx="95" cy="50" r="2"></circle>
            </svg>
        </div>
    </div>

    <!-- USA (CST) টাইম কার্ড -->
    <div class="time-card time-card-us" id="usWatch">
        <div class="date-info">
            <div class="country-label">USA (CST)</div>
            <div class="date-display" id="usFullDate">--</div>
            <div class="month-day" id="usMonthDay">--</div>
        </div>
        
        <div class="time-area">
            <div class="time-text" id="usDigitalTime">--:--<span>PM</span></div>
            
            <svg class="timer-svg" viewBox="0 0 100 100">
                <circle class="circle-bg" cx="50" cy="50" r="45"></circle>
                <circle class="circle-progress" id="usSecondProgress" cx="50" cy="50" r="45"></circle>
                
                <circle class="dot" cx="50" cy="5" r="2"></circle> 
                <circle class="dot-accent" cx="95" cy="50" r="2"></circle>
            </svg>
        </div>
    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <div class="row g-3 h-100">
                
                <!-- TOP: Results Table -->
                <div class="col-lg-12 d-flex flex-column gap-3">
                    <div class="card p-0 overflow-hidden flex-shrink-0" style="max-height: 45%;">
                        <div class="p-2 border-bottom bg-light-subtle d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold text-primary m-0 small text-uppercase">Extracted Table View</h6>
                            <div class="d-flex gap-2">
                                <div id="disputeIdBadge" class="small fw-bold text-secondary" style="display:none;">Dispute ID: --</div>
                                <div id="totalProcessBadge" class="highlight-process small" style="display:none;">Process: $0.00 / 0%</div>
                                <div id="lonsterBadge" class="highlight-lonster small" style="display:none;">Lonster: $0.00 (80%)</div>
                            </div>
                        </div>
                        <div class="card-body p-0 overflow-auto" id="table-output-container">
                            <div class="text-center text-muted p-5 small">
                                No data extracted yet.<br>Paste table content in sidebar and click Extract.
                            </div>
                        </div>
                    </div>

                    <!-- MIDDLE: Excel Copy Box -->
                    <div class="card p-2 excel-box" title="Click to copy">
                        <div class="d-flex justify-content-between align-items-center px-2">
                            <span class="small fw-bold text-success me-2" style="white-space: nowrap;"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Excel:</span>
                            <input type="text" id="excel_Copy_Input" readonly value="Date | Your Offer | Counter | Status | Date" onclick="copyExcelData()">
                            <i class="bi bi-clipboard-check text-success ms-2"></i>
                        </div>
                    </div>

                    <!-- BOTTOM: Notes -->
                    <div class="card flex-grow-1 overflow-hidden d-flex flex-column">
                        <div class="bg-light-subtle pt-2">
                            <ul class="nav nav-tabs-glass" id="noteTabs">
                                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#nsa-pane">NSA Note</button></li>
                            </ul>
                        </div>
                        
                        <div class="card-body d-flex flex-column gap-3">
                            <!-- Name & Date Inputs -->
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-transparent fw-bold text-primary">Name</span>
                                        <input type="text" class="form-control" id="note_Name" placeholder="Enter Name">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-transparent fw-bold text-primary">Date</span>
                                        <input type="date" class="form-control" id="note_Date" style="cursor:pointer;">
                                    </div>
                                </div>
                            </div>

                            <!-- Tab Content -->
                            <div class="tab-content flex-grow-1 position-relative h-100">
                                <div class="tab-pane fade show active h-100 d-flex flex-column" id="nsa-pane">
                                    <div class="mb-2">
                                        <label class="form-label small fw-bold text-muted">Status (Auto-Selected)</label>
                                        <select class="form-select form-select-sm" id="note_Status_NSA">
                                            <option value="" selected disabled>Auto-Selected...</option>
                                            <option value="In Review Plan">In Review Plan</option>
                                            <option value="System Rejected">System Rejected</option>
                                            <option value="Offer Rejected">Offer Rejected</option>
                                            <option value="Accepted">Accepted</option>
                                        </select>
                                    </div>
                                    <!-- Auto Generate on Extract/Change -->
                                    <textarea id="note_Output_NSA" class="form-control flex-grow-1" style="font-family:monospace; font-size:0.85rem;" readonly placeholder="Note will appear here automatically..."></textarea>
                                </div>
                                
                                <div id="copyMsg" class="position-absolute bottom-0 end-0 m-3 bg-success text-white px-2 py-1 rounded small opacity-0 transition">Copied!</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Footer -->
            <footer id="main-footer">
                <div class="row g-4">
                    <div class="col-lg-4 col-md-6">
                        <h5>About Pranto's NSA Tool</h5>
                        <p class="small mb-0">An automated tool for extracting and processing NSA negotiation data, designed to streamline workflows.</p>
                    </div>
                    <div class="col-lg-2 col-md-6">
                         <h6 class="fw-bold small text-uppercase">Quick Links</h6>
                         <ul class="list-unstyled small mb-0">
                             <li><a href="#">Dashboard</a></li>
                             <li><a href="#">Documentation</a></li>
                         </ul>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <h6 class="fw-bold small text-uppercase">Resources</h6>
                        <ul class="list-unstyled small mb-0">
                             <li><a href="#">NSA Guidelines</a></li>
                             <li><a href="#">Internal SOP</a></li>
                        </ul>
                    </div>
                    <div class="col-lg-3 col-md-6 text-end">
                        <h6 class="fw-bold small text-uppercase">Connect</h6>
                        <div class="footer-socials mb-2">
                            <i class="bi bi-facebook"></i> <i class="bi bi-linkedin"></i> <i class="bi bi-github"></i>
                        </div>
                        <p class="small text-muted mb-0">&copy; 2025 PrantoRodrix</p>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Global State ---
        let globalData = null;
        let globalVals = {};
        let manualDate = null; 

        // --- Initialize Date Function ---
        function initDate() {
            const now = new Date().toLocaleString("en-US", {timeZone: "Asia/Dhaka"});
            const d = new Date(now);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            const noteDateEl = document.getElementById('note_Date');
            if(noteDateEl) noteDateEl.value = `${y}-${m}-${dd}`;
        }
        initDate(); 

        // --- Theme ---
        const htmlEl = document.documentElement;
        document.getElementById('theme-toggle').addEventListener('click', () => {
            const t = htmlEl.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
            htmlEl.setAttribute('data-bs-theme', t);
        });

        // --- Persistence ---
        const noteName = document.getElementById('note_Name');
        noteName.value = localStorage.getItem('nsa_name') || '';
        noteName.addEventListener('input', () => localStorage.setItem('nsa_name', noteName.value));

        // --- Clear Function ---
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('eobInput').value = '';
            document.getElementById('note_Output_NSA').value = '';
            document.getElementById('note_Output_NSA').placeholder = "Extract Data first..."; 
            document.getElementById('note_Status_NSA').value = "";
            document.getElementById('table-output-container').innerHTML = '<div class="text-center text-muted p-5 small">No data extracted yet.<br>Paste table content in sidebar and click Extract.</div>';
            document.getElementById('totalProcessBadge').style.display = 'none';
            document.getElementById('lonsterBadge').style.display = 'none';
            document.getElementById('disputeIdBadge').style.display = 'none';
            document.getElementById('excel_Copy_Input').value = 'Date | Your Offer | Counter | Status | Date';
            
            globalData = null; 
            globalVals = {};
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            initDate();
        });

        // --- Extraction ---
        document.getElementById('extractBtn').addEventListener('click', function() {
            const btn = this; btn.classList.add('btn-loading');
            setTimeout(() => { processData(); btn.classList.remove('btn-loading'); }, 300);
        });

        // Status/Date/Name Change Listeners
        document.getElementById('note_Status_NSA').addEventListener('change', function() { if(globalData) generateCurrentNote(); updateExcelBox(); });
        document.getElementById('note_Date').addEventListener('change', function() { if(globalData) { generateCurrentNote(); updateExcelBox(); } });
        document.getElementById('note_Name').addEventListener('input', function() { if(globalData) generateCurrentNote(); });
        
        // --- Excel Copy Function ---
        function copyExcelData() {
            if(!globalData) return;
            const inputEl = document.getElementById('excel_Copy_Input');
            inputEl.select();
            document.execCommand('copy');
            
            const m = document.getElementById('copyMsg');
            m.innerText = "Excel Data Copied!";
            m.style.opacity = 1; 
            setTimeout(() => { m.style.opacity = 0; m.innerText = "Copied!"; }, 2000);
        }
        window.copyExcelData = copyExcelData; 

        function processData() {
            const text = document.getElementById('eobInput').value;
            if(!text.trim()) return;

            // Parsing Logic
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            
            const splitLine = (line) => {
                line = line.replace(/^_+|_+$/g, '');
                return line.split(/[_\t]+/).map(s => s.trim());
            };

            const getRegexVal = (regex) => {
                const m = text.match(regex);
                return m ? m[1].trim() : '--';
            }
            const parseCurr = (s) => parseFloat((s||'0').replace(/[$,\s_]/g,'')) || 0;

            // 1. Dispute ID
            let disputeId = getRegexVal(/Dispute ID[:\s]+([0-9]+)/i);
            if(disputeId === '--') disputeId = getRegexVal(/Negotiation[_\s]+(\d{2}\/\d{2}\/\d{4})[_\s]+([A-Z0-9]+)/)?.[2] || '--';

            // 2. Row Based Extraction Logic (Robust)
            const getValAfterHeader = (header) => {
                for(let i=0; i<lines.length; i++) {
                    if(lines[i].includes(header)) {
                        if(i+1 < lines.length) return lines[i+1];
                    }
                }
                return null;
            };
            
            const safeVal = (arr, i) => arr && arr.length > i ? arr[i] : '--';

            // Extract Rows
            const row1Raw = getValAfterHeader("Level of Review");
            const row1 = splitLine(row1Raw);
            const reviewLvl = safeVal(row1, 0);
            const notifDate = safeVal(row1, 1);
            const claimNo = safeVal(row1, 2);
            const plan = safeVal(row1, 3);
            const group = safeVal(row1, 4);

            const row2Raw = getValAfterHeader("Subscriber");
            const row2 = splitLine(row2Raw);
            const subId = safeVal(row2, 0);
            const patName = safeVal(row2, 1);
            const patDob = safeVal(row2, 2);
            const billedStr = safeVal(row2, 3);
            const allowedStr = safeVal(row2, 4);

            const row3Raw = getValAfterHeader("Patient Share");
            const row3 = splitLine(row3Raw);
            const ptStr = safeVal(row3, 0);
            const paidStr = safeVal(row3, 1);
            const dos = safeVal(row3, 2);
            
            // YOUR OFFER FIX (Last money in row 3)
            let offerStr = '--';
            let cpt = '--';
            
            // Try to find "Your Offer" from the text block between Patient Share and Plan Decision
            const row3Block = text.substring(text.indexOf("Patient Share"), text.indexOf("Plan Decision"));
            if(row3Block) {
                 let monies = row3Block.match(/\$[\d,.]+/g) || [];
                 // Logic: PT, Paid, ... Offer
                 // Offer is the LAST money
                 if(monies.length >= 1) offerStr = monies[monies.length - 1];
                 
                 // CPT Logic: Between DOS and Offer
                 // Find DOS location and Offer location
                 const dosMatch = row3Block.match(/(\d{2}\/\d{2}\/\d{4})/);
                 if(dosMatch && offerStr !== '--') {
                     const dosIdx = row3Block.indexOf(dosMatch[0]);
                     const offIdx = row3Block.lastIndexOf(offerStr);
                     if(dosIdx !== -1 && offIdx !== -1) {
                         let rawCpt = row3Block.substring(dosIdx + 10, offIdx).trim();
                         // Clean up
                         rawCpt = rawCpt.replace(/Service Code\(s\)/i, '').replace(/Your Offer/i, '').trim();
                         // Filter only codes
                         let codes = rawCpt.match(/[0-9A-Z]{5}/g);
                         if(codes) cpt = codes.join(', ');
                     }
                 }
            }
            if(cpt.length > 60) cpt = cpt.substring(0,60) + '...';

            // Row 4
            const row4Raw = getValAfterHeader("Plan Decision");
            const row4 = splitLine(row4Raw);
            const planDec = safeVal(row4, 0);
            
            let counterStr = '--';
            let yourDec = '--';
            let closedDate = '--';
            let regulation = '--';
            
            if(row4.length >= 2) {
                if(row4[1].includes('$')) {
                    counterStr = row4[1];
                    yourDec = safeVal(row4, 2);
                    closedDate = safeVal(row4, 3);
                    regulation = safeVal(row4, 4);
                } else {
                    if(row4[row4.length-1].includes('NSA')) regulation = row4[row4.length-1];
                    if(row4.length === 2) regulation = row4[1];
                    else yourDec = safeVal(row4, 1);
                }
            }
            if(regulation === '--' && text.includes("-NSA")) regulation = "NSA";

            globalData = {
                disputeId, claimNo, notifDate, dos, planDec, yourDec, regulation, cpt,
                billedStr, allowedStr, paidStr, ptStr, offerStr, counterStr,
                reviewLvl, plan, group, subId, patName, patDob, closedDate
            };
            
            globalVals = {
                billed: parseCurr(billedStr),
                allowed: parseCurr(allowedStr),
                paid: parseCurr(paidStr),
                pt: parseCurr(ptStr),
                offer: parseCurr(offerStr),
                counter: parseCurr(counterStr)
            };
            
            autoSelectStatus();
            generateTableUI();
            updateExcelBox();
            generateCurrentNote(); 
        }
        
        function formatCurrency(num) {
            return '$' + (parseFloat(num) || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function getDateObj() {
             const dateInputVal = document.getElementById('note_Date').value;
            if(dateInputVal) {
                const [y, m, d] = dateInputVal.split('-');
                return new Date(y, m-1, d);
            } else {
                return new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Dhaka"}));
            }
        }

        function updateExcelBox() {
            if(!globalData) return;
            const dObj = getDateObj();
            const dateStr = `${String(dObj.getMonth()+1).padStart(2,'0')}/${String(dObj.getDate()).padStart(2,'0')}/${String(dObj.getFullYear()).slice(-2)}`;
            
            const offer = formatCurrency(globalVals.offer);
            const counter = globalVals.counter > 0 ? formatCurrency(globalVals.counter) : "";
            const status = document.getElementById('note_Status_NSA').value || "";
            
            // TAB separated for Excel rows
            const val = `${dateStr}\t${offer}\t${counter}\t${status}\t${dateStr}`;
            document.getElementById('excel_Copy_Input').value = val;
        }

        function autoSelectStatus() {
            const statusSelect = document.getElementById('note_Status_NSA');
            const pd = (globalData.planDec || '').toLowerCase().trim();
            const yd = (globalData.yourDec || '').toLowerCase().trim();
            const reg = (globalData.regulation || '').toLowerCase().trim();

            if (pd === '-' || pd === '' || pd.includes('nsa')) {
                statusSelect.value = "In Review Plan";
            } 
            else if (pd.includes('not accepted')) {
                if (yd === '--' || yd === '' || yd === '-' || yd.includes('not')) {
                    if(globalVals.counter > 0) statusSelect.value = "Offer Rejected";
                    else statusSelect.value = "System Rejected";
                }
                else if (yd.includes('accepted')) statusSelect.value = "Accepted";
            }
            else if (pd.includes('accepted')) {
                statusSelect.value = "Accepted";
            }
        }

        function generateTableUI() {
            const container = document.getElementById('table-output-container');
            
            let subDisplay = globalData.subId;
            if (subDisplay && subDisplay.length > 3) {
                subDisplay = `<span class="mem-prefix">${subDisplay.substring(0,3)}</span>${subDisplay.substring(3)}`;
            }

            const procAmt = globalVals.allowed;
            const procPct = (globalVals.billed > 0) ? ((procAmt / globalVals.billed) * 100).toFixed(0) : 0;
            const badge = document.getElementById('totalProcessBadge');
            badge.style.display = 'block';
            badge.innerText = `Process: $${procAmt.toFixed(2)} / ${procPct}%`;
            
            const lonsterAmt = globalVals.billed * 0.80;
            const lonsterBadge = document.getElementById('lonsterBadge');
            if(lonsterBadge) {
                lonsterBadge.style.display = 'block';
                lonsterBadge.innerText = `Lonster: $${lonsterAmt.toFixed(2)} (80%)`;
            }

            const row = (lbl, val, col='') => `<td><span class="d-block small text-muted text-uppercase" style="font-size:0.65rem;">${lbl}</span><span class="fw-bold ${col}">${val}</span></td>`;

            let html = '<table class="nsa-result-table">';
            if(globalData.disputeId !== '--') {
                html += `<tr><td colspan="5" class="text-center bg-info-subtle text-primary fw-bold border-bottom">Dispute ID: ${globalData.disputeId}</td></tr>`;
            }
            html += `<tr>${row('LEVEL', globalData.reviewLvl)}${row('NOTIFICATION', globalData.notifDate)}${row('CLAIM NO.', globalData.claimNo)}${row('PLAN', globalData.plan)}${row('GROUP', globalData.group)}</tr>`;
            html += `<tr><td><span class="d-block small text-muted text-uppercase" style="font-size:0.65rem;">SUBSCRIBER</span><span class="fw-bold">${subDisplay}</span></td>${row('PATIENT', globalData.patName)}${row('DOB', globalData.patDob)}${row('BILLED', globalData.billedStr, 'text-primary')}${row('ALLOWED', globalData.allowedStr, 'text-primary')}</tr>`;
            html += `<tr>${row('PT SHARE', globalData.ptStr)}${row('PAID', globalData.paidStr, 'text-success')}${row('DOS', globalData.dos)}${row('CPT', globalData.cpt)}${row('YOUR OFFER', globalData.offerStr)}</tr>`;
            html += `<tr>${row('PLAN DEC.', globalData.planDec)}${row('COUNTER', globalData.counterStr)}${row('MY DEC.', globalData.yourDec)}${row('CLOSED', globalData.closedDate)}${row('REG.', globalData.regulation)}</tr>`;
            html += '</table>';
            container.innerHTML = html;
        }

        function generateCurrentNote() {
            if (!globalData || !globalData.claimNo) return;

            const nameEl = document.getElementById('note_Name');
            if(!nameEl.value) { nameEl.classList.add('is-invalid'); return; }
            else nameEl.classList.remove('is-invalid');
            const name = nameEl.value.trim().toUpperCase();

            const status = document.getElementById('note_Status_NSA').value;
            
            let dObj;
            const dateInputVal = document.getElementById('note_Date').value;
            if(dateInputVal) {
                const [y, m, d] = dateInputVal.split('-');
                dObj = new Date(y, m-1, d);
            } else {
                dObj = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Dhaka"}));
            }
            const dateStr = `${String(dObj.getMonth()+1).padStart(2,'0')}/${String(dObj.getDate()).padStart(2,'0')}/${String(dObj.getFullYear()).slice(-2)}`;

            const fmt = (n) => '$' + (n || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            const getD = (k) => globalData[k] || '--';
            const getV = (k) => fmt(globalVals[k]);

            let note = "";

            if (status === "In Review Plan") {
                note = `${dateStr}>NSA NEG>${name}>WORKING ON NSA PROJECT. CLAIM # ${getD('claimNo')}, BILLED AMOUNT ${getV('billed')}, ALLOWED AMOUNT ${getV('allowed')}, WITH MENTION THAT CLAIM PROCESSED PER NSA. SENT NSA NEGOTIATION OFFER OF ${getV('offer')}, PER FAIR HEALTH AMOUNT, THROUGH AVAILITY. Dispute ID: ${getD('disputeId')}.`;
            } 
            else if (status === "System Rejected") {
                note = `${dateStr}>NSA NEG>${name}>WORKING ON NSA PROJECT. CLAIM # ${getD('claimNo')}, BILLED AMOUNT ${getV('billed')}, ALLOWED AMOUNT ${getV('allowed')}, WITH MENTION THAT CLAIM PROCESSED PER NSA. SENT NSA NEGOTIATION OFFER OF ${getV('offer')}, AS PER FAIR HEALTH AMOUNT, THROUGH AVAILITY. OFFER IMMEDIATELY REJECTED BY BCBS. PUTTING TICKET ON NSA NEGO TRACKING GOOGLE SHEET TO START IDR PROCESS. Dispute ID: ${getD('disputeId')}.`;
            }
            else if (status === "Offer Rejected") {
                 note = `${dateStr}>NSA NEG>${name}>WORKING ON NSA PROJECT. CLAIM # ${getD('claimNo')}, BILLED AMOUNT ${getV('billed')}, ALLOWED AMOUNT ${getV('allowed')}, WITH MENTION THAT CLAIM PROCESSED PER NSA. SENT NSA NEGOTIATION OFFER OF ${getV('offer')}, BCBS MADE COUNTER OFFER OF ${getV('counter')}. THROUGH AVAILITY. OFFER REJECTED AS IT IS BELOW FAIR HEALTH AMOUNT. WILL FOLLOW UP TO SEE IF ANOTHER COUNTER NEGOTIATION OFFER WILL BE MADE OR NEED TO START IDR PROCESS. Dispute ID: ${getD('disputeId')}.`;
            }
            else if (status === "Accepted") {
                 note = `${dateStr}>NSA ACCEPTED>${name}>WORKING ON NSA PROJECT. CLAIM # ${getD('claimNo')}, BILLED AMOUNT ${getV('billed')}, ALLOWED AMOUNT ${getV('allowed')}, WITH MENTION THAT CLAIM PROCESSED PER NSA. SENT NSA NEGOTIATION OFFER OF ${getV('offer')}, AS PAR FAIR HEALTH AMOUNT. THROUGH AVAILITY. COUNTER OFFER ${getV('counter')}. WE ACCEPT IT. WILL WAIT FOR PAYMENT TO POST BEFORE SENDING FOR ADJUSTMENT. Dispute ID: ${getD('disputeId')}.`;
            }

            const out = document.getElementById('note_Output_NSA');
            animateText(out, note);
        }

        function animateText(el, text) {
            if(el.dataset.int) clearInterval(el.dataset.int);
            el.value = "";
            const words = text.split(' ');
            let i = 0;
            el.dataset.int = setInterval(()=>{
                if(i<words.length) { el.value += (i>0?" ":"") + words[i]; el.scrollTop=el.scrollHeight; i++; }
                else clearInterval(el.dataset.int);
            }, 15);
        }
        
        document.getElementById('note_Output_NSA').addEventListener('click', function() {
            if(!this.value || this.value.includes("Extract")) return;
            this.select(); document.execCommand('copy');
            const m = document.getElementById('copyMsg'); m.style.opacity=1; setTimeout(()=>m.style.opacity=0, 2000);
        });
        
        document.getElementById('note_Name').addEventListener('input', function() { 
            this.classList.remove('is-invalid'); 
            if(globalData) generateCurrentNote();
        });
        
        // Initialize Date
        function initDate() {
            const now = new Date().toLocaleString("en-US", {timeZone: "Asia/Dhaka"});
            const d = new Date(now);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            const noteDateEl = document.getElementById('note_Date');
            if(noteDateEl) noteDateEl.value = `${y}-${m}-${dd}`;
        }
        initDate();
// সার্কুলার প্রোগ্রেস বারের জন্য কনস্ট্যান্ট
        const radius = 45;
        const circumference = 2 * Math.PI * radius;

        // প্রোগ্রেস সেট করার ফাংশন
        function setProgress(progressElement, percent) {
            progressElement.style.strokeDasharray = `${circumference} ${circumference}`;
            const offset = circumference - percent / 100 * circumference;
            progressElement.style.strokeDashoffset = offset;
        }
        
        // ঘড়ি আপডেট করার প্রধান ফাংশন
        function updateWatch(prefix, timeZone) {
            const timeElement = document.getElementById(prefix + 'DigitalTime');
            const fullDateElement = document.getElementById(prefix + 'FullDate');
            const monthDayElement = document.getElementById(prefix + 'MonthDay');
            const progressElement = document.getElementById(prefix + 'SecondProgress');

            if (!timeElement || !progressElement) return;

            const now = new Date();

            // তারিখের জন্য
            const optionsDate = { weekday: 'long', timeZone: timeZone };
            const optionsMonthDay = { month: 'short', day: 'numeric', timeZone: timeZone };
            
            fullDateElement.textContent = now.toLocaleDateString('en-US', optionsDate);
            monthDayElement.textContent = now.toLocaleDateString('en-US', optionsMonthDay);

            // সময়ের জন্য (12-ঘন্টা AM/PM)
            const optionsTime = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true,
                timeZone: timeZone
            };
            let timeString = now.toLocaleTimeString('en-US', optionsTime);
            
            // সেকেন্ড আলাদা করা
            const timeParts = timeString.split(':');
            const seconds = parseInt(timeParts[2].substring(0, 2)); 

            const timeWithoutSeconds = timeParts[0] + ':' + timeParts[1];
            const ampm = timeParts[2].substring(2);

            timeElement.innerHTML = `${timeWithoutSeconds}<span>${ampm}</span>`;

            // সেকেন্ড প্রোগ্রেস বার আপডেট করা
            const percent = (seconds / 60) * 100;
            setProgress(progressElement, percent);
        }

        // বাংলাদেশ সময় আপডেট
        function updateBangladeshTime() {
            updateWatch('bd', 'Asia/Dhaka');
        }

        // USA সময় আপডেট
        function updateUSATime() {
            updateWatch('us', 'America/Chicago');
        }

        // প্রথমবার কল করা
        updateBangladeshTime();
        updateUSATime();
        
        // প্রতি সেকেন্ডে আপডেট করার জন্য ইন্টারভাল সেট করা 
        setInterval(updateBangladeshTime, 1000);
        setInterval(updateUSATime, 1000);
    </script>
</body>
</html>
