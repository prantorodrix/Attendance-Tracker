<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pranto's NSA Tool</title>
    <link rel="icon" type="image/png" href="index.png">
    
    <!-- Fonts & CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --f: 'Outfit', sans-serif; --mono: 'Rajdhani', monospace; --nav-h: 70px;
            --pri: #06b6d4; --sec: #3b82f6; --txt: #334155; --txt-l: #64748b;
            --bg-body: #f1f5f9; 
            --bg-grad: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            --glass: rgba(255, 255, 255, 0.9); --blur: 20px; 
            --bor: 1px solid rgba(255, 255, 255, 0.6); 
            --sh: 0 10px 30px rgba(0,0,0,0.04);
            --card-bg: #ffffff; --nav-bg: rgba(255, 255, 255, 0.95);
            --input-bg: #ffffff;
            --w-bg: rgba(255, 255, 255, 0.8);
        }
        [data-bs-theme="dark"] {
            --txt: #f1f5f9; --txt-l: #94a3b8; 
            --bg-body: #0f172a;
            --bg-grad: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --glass: rgba(30, 41, 59, 0.9); 
            --bor: 1px solid rgba(255, 255, 255, 0.1);
            --card-bg: rgba(30, 41, 59, 0.7); --nav-bg: rgba(15, 23, 42, 0.9);
            --input-bg: rgba(0, 0, 0, 0.2);
            --w-bg: rgba(20, 25, 35, 0.8);
        }

        body {
            font-family: var(--f); background: var(--bg-grad);
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; color: var(--txt);
            transition: background 0.3s ease;
        }

        /* --- NAVBAR --- */
        #nav {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 1250px; height: 65px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 1.5rem; z-index: 1100;
            background: var(--nav-bg); backdrop-filter: blur(var(--blur));
            border: var(--bor); border-radius: 50px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.08);
        }
        .brand { font-size: 1.3rem; font-weight: 700; background: linear-gradient(90deg, var(--pri), var(--sec)); -webkit-background-clip: text; color: transparent; white-space: nowrap; }
        .menu { display: flex; gap: 1.5rem; align-items: center; }
        .n-lnk { text-decoration: none; color: var(--txt); font-weight: 600; font-size: 0.9rem; opacity: 0.7; transition: .3s; position: relative; white-space: nowrap; }
        .n-lnk:hover, .n-lnk.active { opacity: 1; color: var(--pri); }
        .n-lnk.active::after { content: ''; position: absolute; bottom: -4px; left: 0; width: 100%; height: 2px; background: var(--pri); border-radius: 2px; }
        
        /* Dropdowns */
        .drop-box { position: relative; cursor: pointer; display: flex; align-items: center; }
        .drop-menu {
            position: absolute; top: 100%; left: 50%; transform: translateX(-50%) translateY(15px);
            background: var(--nav-bg); border: var(--bor); border-radius: 16px; padding: 8px; min-width: 170px;
            opacity: 0; visibility: hidden; transition: .3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 4px;
        }
        .drop-box:hover .drop-menu { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(5px); }
        .d-item { text-decoration: none; color: var(--txt); font-size: 0.85rem; padding: 8px 12px; border-radius: 10px; transition: .2s; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .d-item:hover { background: rgba(6, 182, 212, 0.1); color: var(--pri); }

        /* Right Section & Buttons */
        .n-rt { display: flex; align-items: center; gap: 10px; }
        .btn-nav-act {
            border: none; padding: 6px 14px; border-radius: 20px;
            font-weight: 600; font-size: 0.8rem; letter-spacing: 0.3px;
            color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.2s ease; display: flex; align-items: center; gap: 5px; cursor: pointer;
        }
        .btn-ext { background: linear-gradient(135deg, #06b6d4, #3b82f6); }
        .btn-clr { background: linear-gradient(135deg, #ef4444, #f43f5e); }
        .btn-nav-act:hover { transform: translateY(-1px); filter: brightness(110%); }
        
        .t-btn { width: 34px; height: 34px; border-radius: 50%; border: var(--bor); background: transparent; color: var(--txt); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: .3s; }
        .t-btn:hover { background: var(--pri); color: #fff; transform: rotate(20deg); }
        .p-pic { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid transparent; background: linear-gradient(var(--nav-bg), var(--nav-bg)) padding-box, linear-gradient(45deg, var(--pri), var(--sec)) border-box; cursor: pointer; }

        /* --- LAYOUT --- */
        #wrap { display: flex; margin-top: 100px; height: calc(100vh - 100px); }
        #sb { width: 300px; background: var(--glass); border-right: var(--bor); backdrop-filter: blur(15px); display: flex; flex-direction: column; margin-left: 20px; border-radius: 20px 0 0 20px; margin-bottom: 20px; box-shadow: var(--sh); height: calc(100vh - 120px); }
        #sb-c { flex: 1; overflow-y: auto; padding: 1rem; height: 100%; }
        #main { flex: 1; padding: 0 2rem 1.5rem 1.5rem; overflow-y: auto; display: flex; flex-direction: column; } /* Reduced padding */

        /* --- COMPONENTS --- */
        .card { background: var(--card-bg); border: var(--bor); border-radius: 16px; box-shadow: var(--sh); margin-bottom: 0.8rem; border: none; } /* Reduced margin */
        .form-control, .form-select {
            background: var(--input-bg); border: 1px solid rgba(0,0,0,0.1); border-radius: 10px;
            font-size: 0.9rem; color: var(--txt); box-shadow: inset 2px 2px 5px rgba(0,0,0,0.02); transition: .2s;
        }
        [data-bs-theme="dark"] .form-control { border-color: rgba(255,255,255,0.1); }
        .form-control:focus { box-shadow: 0 0 0 2px var(--pri); outline: 0; border-color: transparent; }
        .form-control.is-invalid { border-color: #dc3545 !important; box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.25) !important; }
        textarea.form-control { resize: none; overflow: hidden; }
        .input-group > .input-group-text { border-radius: 10px 0 0 10px; background: var(--bg-body); border: 1px solid rgba(0,0,0,0.1); color: var(--txt-l); font-size: 0.85rem; font-weight: 600; }
        [data-bs-theme="dark"] .input-group > .input-group-text { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        .input-group > .form-control { border-radius: 0 10px 10px 0; }

        /* Result Table */
        .nsa-result-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.75rem; margin-bottom: 0.5rem; }
        .nsa-result-table th { background: rgba(6, 182, 212, 0.1); color: var(--txt); font-weight: 700; padding: 6px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .nsa-result-table td { padding: 6px; color: var(--txt); border-bottom: 1px solid rgba(0,0,0,0.05); font-weight: 600; word-break: break-word; }
        .nsa-result-table tr:last-child td { border-bottom: none; }
        .mem-prefix { color: #d946ef; font-weight: 900; }
        .hl-proc { background: #0e7490; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
        .hl-lon { background: #7e22ce; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }

        /* Premium Watch Card */
        .time-card { 
            background: var(--bs-focus-ring-color); border-radius: 16px; padding: 15px; 
            display: flex; align-items: center; justify-content: space-between; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); border: var(--bor); 
            margin-bottom: 10px; transition: .3s; backdrop-filter: blur(10px);
        }
        .time-card:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
        .country-lbl { font-size: 0.7rem; font-weight: 800; color: var(--pri); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; }
        .date-disp { font-size: 0.85rem; font-weight: 600; color: var(--txt); opacity: 0.8; }
        .time-disp { font-family: var(--mono); font-size: 2rem; font-weight: 700; color: var(--txt); line-height: 1; }
        .time-disp span { font-size: 0.4em; margin-left: 2px; color: var(--txt-l); }
        .timer-svg { width: 60px; height: 60px; transform: rotate(-90deg); }
        .c-bg { stroke: rgba(0,0,0,0.05); stroke-width: 33px; fill: none; } [data-bs-theme="dark"] .c-bg { stroke: rgba(255,255,255,0.1); }
        .c-prog { stroke: var(--pri); stroke-width: 4; fill: none; stroke-linecap: round; transition: 0.1s linear; stroke-dasharray: 157; } /* 2*pi*25 */

        /* Footer */
        footer { background: var(--nav-bg); backdrop-filter: blur(12px); border-top: var(--bor); padding: 3rem 0 1.5rem; margin-top: auto; border-radius: 20px 20px 0 0; }
        .f-brand { font-size: 1.3rem; font-weight: 700; color: var(--txt); margin-bottom: 1rem; display: block; }
        .f-lnk { display: block; color: var(--txt-l); text-decoration: none; font-size: .85rem; margin-bottom: .6rem; transition: .2s; }
        .f-lnk:hover { color: var(--pri); transform: translateX(3px); }
        .s-ico { width: 32px; height: 32px; border-radius: 50%; background: rgba(6, 182, 212, 0.1); color: var(--pri); display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; transition: .2s; }
        .s-ico:hover { background: var(--pri); color: white; transform: translateY(-2px); }
        
        /* Excel Box */
        .excel-box { background: rgba(16,185,129,0.05); border: 1px solid rgba(16,185,129,0.2); cursor: pointer; transition: .2s; border-radius: 10px; }
        .excel-box:hover { background: rgba(16,185,129,0.1); transform: translateY(-2px); }
        .excel-box.copied-anim { background-color: rgba(16, 185, 129, 0.3) !important; transform: scale(0.98); } /* Animation Class */
        #excel_Copy_Input { background: transparent; border: none; color: #059669; font-weight: 600; font-size: 0.85rem; width: 100%; cursor: pointer; outline: none; }
        
        /* NOTE BOX FIXED AREA */
        #note_Output_NSA {
            height: 300px; /* Fixed height */
            min-height: 300px;
            overflow-y: auto; /* Scrollable */
            font-family: monospace; 
            font-size: 0.85rem;
        }
    </style>
</head>
<body>

<nav id="nav">
    <div class="brand">Pranto's Workspace</div>
    <div class="menu d-none d-lg-flex">
        <a href="index.html" class="n-lnk">Home</a>
        <div class="drop-box">
            <span class="n-lnk active">BCBS <i class="bi bi-chevron-down small"></i></span>
            <div class="drop-menu">
                <a href="idr.html" class="d-item"><i class="bi bi-file-text"></i> IDR</a>
                <a href="nsa.html" class="d-item"><i class="bi bi-shield"></i> NSA</a>
                <a href="appeal.html" class="d-item"><i class="bi bi-arrow-repeat"></i> Appeal</a>
            </div>
        </div>
        <div class="drop-box">
            <span class="n-lnk">Others <i class="bi bi-chevron-down small"></i></span>
            <div class="drop-menu">
                <a href="typing.html" class="d-item"><i class="bi bi-keyboard-fill"></i> Typing</a>
                <a href="#" class="d-item"><i class="bi bi-stars"></i> New</a>
            </div>
        </div>
        <a href="#" class="n-lnk">Contact Us</a>
    </div>
    <div class="n-rt">
        <button id="extractBtn" class="btn-nav-act btn-ext"><i class="bi bi-magic"></i> Extract</button>
        <button id="clearBtn" class="btn-nav-act btn-clr"><i class="bi bi-trash"></i> Clear</button>
        <div style="width:1px; height:20px; background:var(--txt); opacity:0.2; margin:0 5px;"></div>
        <button id="theme-toggle" class="t-btn"><i id="theme-icon" class="bi bi-sun-fill"></i></button>
        <div class="dropdown">
            <img src="https://ui-avatars.com/api/?name=Pranto+Rodrix&background=06b6d4&color=fff&bold=true" class="p-pic" data-bs-toggle="dropdown">
            <ul class="dropdown-menu dropdown-menu-end border-0 shadow" style="background:var(--nav-bg); backdrop-filter:blur(10px)">
                <li><a class="dropdown-item text-danger fw-bold" href="index.html"><i class="bi bi-box-arrow-right me-2"></i>Log Out</a></li>
            </ul>
        </div>
    </div>
</nav>

<div id="wrap">
    <!-- Sidebar -->
    <div id="sb">
        <div class="p-3 border-bottom border-color-subtle">
            <h6 class="text-primary m-0 fw-bold small text-uppercase"><i class="bi bi-clipboard-data me-2"></i>Input & Time</h6>
        </div>
        <div id="sb-c">
            <div class="d-flex flex-column gap-3">
                <div class="card p-0 overflow-hidden border-primary border-opacity-25 shadow-sm">
                    <textarea id="eobInput" class="form-control border-0 rounded-0" style="min-height: 150px; font-size:0.75rem; white-space: pre; background: rgba(255,255,255,0.5);" placeholder="Paste NSA Table Data here..."></textarea>
                </div>
                <!-- USA Watch -->
                <div class="time-card" id="usWatch">
                    <div><div class="country-lbl">USA (CST)</div><div class="date-disp" id="usDate">--</div></div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="time-disp" id="usTime">--:--<span>PM</span></div>
                        <svg class="timer-svg" viewBox="0 0 100 100"><circle class="c-bg" cx="50" cy="50" r="25"/><circle class="c-prog" id="usProg" cx="50" cy="50" r="25"/></svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main -->
    <div id="main">
        <div class="row g-2 h-100">
            <div class="col-lg-12 d-flex flex-column gap-3">
                <!-- Result Table -->
                <div class="card p-0 overflow-hidden flex-shrink-0" style="max-height: 350px;">
                    <div class="p-2 border-bottom bg-light-subtle d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold text-primary m-0 small text-uppercase">Extracted Data</h6>
                        <div class="d-flex gap-2">
                            <div id="disputeIdBadge" class="small fw-bold text-secondary" style="display:none;">Dispute ID: --</div>
                            <div id="totalProcessBadge" class="hl-proc" style="display:none;">Process: $0 / 0%</div>
                            <div id="lonsterBadge" class="hl-lon" style="display:none;">Lonster: $0</div>
                        </div>
                    </div>
                    <div class="card-body p-0 overflow-auto" id="table-output-container">
                        <div class="text-center text-muted p-5 small">No data extracted yet.<br>Paste table content in sidebar and click Extract.</div>
                    </div>
                </div>

                <!-- Excel Copy -->
                <div class="card p-2 excel-box" id="excelBoxContainer" onclick="copyExcelData()" title="Click to copy">
                    <div class="d-flex justify-content-between align-items-center px-2">
                        <span class="small fw-bold text-success me-2"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Excel:</span>
                        <!-- Added 'readonly' and handled click in parent container -->
                        <input type="text" id="excel_Copy_Input" readonly value="Date | Your Offer | Counter | Status | Date">
                        <i id="excelCopyIcon" class="bi bi-clipboard-check text-success ms-2"></i>
                    </div>
                </div>

                <!-- Notes -->
                <div class="card flex-grow-1 overflow-hidden d-flex flex-column mb-0">
                    <div class="bg-light-subtle pt-2 border-bottom">
                        <ul class="nav nav-tabs px-3" style="border:none; margin-bottom:-1px">
                            <li class="nav-item"><button class="nav-link active" style="border-bottom:2px solid var(--pri); color:var(--pri)">NSA Note</button></li>
                        </ul>
                    </div>
                    <div class="card-body d-flex flex-column gap-2 p-3">
                        <div class="row g-2">
                            <div class="col-6"><div class="input-group input-group-sm"><span class="input-group-text bg-transparent fw-bold text-primary">Name</span><input type="text" class="form-control" id="note_Name" placeholder="Enter Name"></div></div>
                            <div class="col-6"><div class="input-group input-group-sm"><span class="input-group-text bg-transparent fw-bold text-primary">Date</span><input type="date" class="form-control" id="note_Date" style="cursor:pointer;"></div></div>
                        </div>
                        <div class="flex-grow-1 position-relative d-flex flex-column">
                            <div class="mb-2"><label class="form-label small fw-bold text-muted">Status (Auto-Selected)</label><select class="form-select form-select-sm" id="note_Status_NSA"><option value="" selected disabled>Auto-Selected...</option><option value="In Review Plan">In Review Plan</option><option value="System Rejected">System Rejected</option><option value="Offer Rejected">Offer Rejected</option><option value="Accepted">Accepted</option></select></div>
                            <textarea id="note_Output_NSA" class="form-control flex-grow-1" readonly placeholder="Note will appear here automatically..."></textarea>
                            <div id="copyMsg" class="position-absolute bottom-0 end-0 m-3 bg-success text-white px-2 py-1 rounded small opacity-0 transition">Copied!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let globalData=null, globalVals={}, manualDate=null;
    const htmlEl=document.documentElement;

    document.addEventListener('DOMContentLoaded', () => {
        const st=localStorage.getItem('theme')||'light'; htmlEl.setAttribute('data-bs-theme',st);
        const sn=localStorage.getItem('nsa_name'); if(sn)document.getElementById('note_Name').value=sn;
        initDate(); startWatches();
    });

    document.getElementById('theme-toggle').addEventListener('click',()=>{
        const t=htmlEl.getAttribute('data-bs-theme')==='dark'?'light':'dark';
        htmlEl.setAttribute('data-bs-theme',t); localStorage.setItem('theme',t);
    });

    // 1. Name Save Listener
    document.getElementById('note_Name').addEventListener('input', e => localStorage.setItem('nsa_name', e.target.value));

    // 2. Clear Button Listener
    document.getElementById('clearBtn').addEventListener('click', () => {
        document.getElementById('eobInput').value = '';
        document.getElementById('note_Output_NSA').value = '';
        document.getElementById('note_Status_NSA').value = "";
        document.getElementById('table-output-container').innerHTML = '<div class="text-center text-muted p-5 small">No data extracted yet.<br>Paste table content in sidebar and click Extract.</div>';
        document.getElementById('totalProcessBadge').style.display = 'none';
        document.getElementById('lonsterBadge').style.display = 'none';
        document.getElementById('disputeIdBadge').style.display = 'none';
        document.getElementById('excel_Copy_Input').value = 'Date | Your Offer | Counter | Status | Date';
        globalData = null;
        globalVals = {};
        initDate(); 
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    });

    // 3. Note Textarea Click to Copy
    document.getElementById('note_Output_NSA').addEventListener('click', function() {
        if (this.value.trim() === "") return;
        this.select(); this.setSelectionRange(0, 99999);
        try {
            const successful = document.execCommand('copy');
            if(successful) {
                const originalBorder = this.style.border;
                this.style.border = '2px solid green';
                const m = document.getElementById('copyMsg');
                m.style.opacity = 1;
                setTimeout(() => {
                    this.style.border = originalBorder;
                    m.style.opacity = 0;
                }, 800);
            }
        } catch (err) { console.error('Copy failed', err); }
    });

    document.getElementById('extractBtn').addEventListener('click',function(){const b=this;b.innerHTML='...';setTimeout(()=>{processData();b.innerHTML='<i class="bi bi-magic"></i> Extract'},300)});
    ['note_Status_NSA','note_Date','note_Name'].forEach(id=>document.getElementById(id).addEventListener(id==='note_Name'?'input':'change',()=>{if(globalData){generateCurrentNote();updateExcelBox()}}));

    // ----------------------------------------------------
    // UPDATED EXCEL LOGIC BEGINS HERE
    // ----------------------------------------------------

    // Logic to update the text inside the input
    function updateExcelBox(){
        if(!globalData)return;
        const dVal=document.getElementById('note_Date').value.split('-');
        const dt=`${dVal[1]}/${dVal[2]}/${dVal[0].slice(-2)}`;
        
        let status = document.getElementById('note_Status_NSA').value;
        let lastDate = dt;

        // Custom Logic: If status is 'In Review Plan', keep it normal and remove last date
        if(status === "In Review Plan") {
            lastDate = ""; // Last date missing
        } else {
            status = status.toUpperCase(); // Otherwise All CAPS
        }

        const counterText = globalVals.counter > 0 ? formatCurrency(globalVals.counter) : "";
        document.getElementById('excel_Copy_Input').value = `${dt}\t${formatCurrency(globalVals.offer)}\t${counterText}\t${status}\t${lastDate}`;
    }

    // Logic to Copy without visual selection + Animation
    function copyExcelData(){
        const input = document.getElementById('excel_Copy_Input');
        // Basic check to ensure we have data
        if(!input.value.includes('\t') && !globalData) return;

        // 1. Select and Copy
        input.select();
        input.setSelectionRange(0, 99999); // For mobile
        document.execCommand('copy');
        
        // 2. Remove Selection Immediately (User requested no selection visible)
        window.getSelection().removeAllRanges();
        input.blur();

        // 3. Animation Feedback
        const box = document.getElementById('excelBoxContainer');
        const icon = document.getElementById('excelCopyIcon');
        
        // Flash animation class
        box.classList.add('copied-anim');
        setTimeout(() => box.classList.remove('copied-anim'), 300);

        // Icon change
        const oldClass = icon.className;
        icon.className = 'bi bi-check-lg text-success ms-2';
        setTimeout(() => icon.className = oldClass, 1500);
    }
    // ----------------------------------------------------
    // UPDATED EXCEL LOGIC ENDS HERE
    // ----------------------------------------------------

    function processData(){
        const txt=document.getElementById('eobInput').value; if(!txt.trim())return;
        const lines=txt.split('\n').map(l=>l.trim()).filter(l=>l), split=l=>l.replace(/^_+|_+$/g,'').split(/[_\t]+/).map(s=>s.trim());
        const safe=(a,i)=>a&&a.length>i?a[i]:'--';
        
        const getVal=h=>{for(let i=0;i<lines.length;i++)if(lines[i].includes(h)&&i+1<lines.length)return lines[i+1];return null};
        const parse=s=>parseFloat((s||'0').replace(/[$,\s_]/g,''))||0;

        let dispId=txt.match(/Dispute ID[:\s]+([0-9]+)/i)?.[1]||txt.match(/Negotiation[_\s]+(\d{2}\/\d{2}\/\d{4})[_\s]+([A-Z0-9]+)/)?.[2]||'--';
        
        const r1=split(getVal("Level of Review")||""), r2=split(getVal("Subscriber")||""), r3=split(getVal("Patient Share")||""), r4=split(getVal("Plan Decision")||"");
        
        // Offer Logic
        let off='--', cpt='--';
        const blk=txt.substring(txt.indexOf("Patient Share"),txt.indexOf("Plan Decision"));
        if(blk){
            let ms=blk.match(/\$[\d,.]+/g)||[]; if(ms.length)off=ms[ms.length-1];
            const dm=blk.match(/(\d{2}\/\d{2}\/\d{4})/);
            if(dm&&off!=='--'){
                const raw=blk.substring(blk.indexOf(dm[0])+10,blk.lastIndexOf(off)).replace(/Service Code\(s\)/i,'').replace(/Your Offer/i,'').trim();
                let cs=raw.match(/[0-9A-Z]{5}/g); if(cs) cpt=cs.join(', ');
            }
        }
        if(cpt.length>60)cpt=cpt.substring(0,60)+'...';

        let ctr='--', yd='--', cd='--', reg='--';
        if(r4.length>=2){
            if(r4[1].includes('$')){ctr=r4[1];yd=safe(r4,2);cd=safe(r4,3);reg=safe(r4,4);}
            else{if(r4[r4.length-1].includes('NSA'))reg=r4[r4.length-1]; if(r4.length===2)reg=r4[1];else yd=safe(r4,1);}
        }
        if(reg==='--'&&txt.includes("-NSA"))reg="NSA";

        globalData={disputeId:dispId,claimNo:safe(r1,2),notifDate:safe(r1,1),dos:safe(r3,2),planDec:safe(r4,0),yourDec:yd,regulation:reg,cpt,billedStr:safe(r2,3),allowedStr:safe(r2,4),paidStr:safe(r3,1),ptStr:safe(r3,0),offerStr:off,counterStr:ctr,reviewLvl:safe(r1,0),plan:safe(r1,3),group:safe(r1,4),subId:safe(r2,0),patName:safe(r2,1),patDob:safe(r2,2),closedDate:cd};
        globalVals={billed:parse(globalData.billedStr),allowed:parse(globalData.allowedStr),offer:parse(off),counter:parse(ctr)};
        
        autoSelectStatus(); generateTableUI(); updateExcelBox(); generateCurrentNote();
    }

    function generateTableUI(){
        const con=document.getElementById('table-output-container');
        let sub=globalData.subId; if(sub.length>3)sub=`<span class="mem-prefix">${sub.substring(0,3)}</span>${sub.substring(3)}`;
        const pp=(globalVals.billed>0)?((globalVals.allowed/globalVals.billed)*100).toFixed(0):0;
        document.getElementById('totalProcessBadge').style.display='block'; document.getElementById('totalProcessBadge').innerText=`Proc: $${globalVals.allowed.toFixed(2)} / ${pp}%`;
        document.getElementById('lonsterBadge').style.display='block'; document.getElementById('lonsterBadge').innerText=`Lonster: $${(globalVals.billed*0.8).toFixed(2)}`;
        if(globalData.disputeId!=='--'){const b=document.getElementById('disputeIdBadge');b.style.display='block';b.innerText=`ID: ${globalData.disputeId}`;}

        const row=(l,v,c='')=>`<td><span class="d-block small text-muted text-uppercase" style="font-size:0.65rem">${l}</span><span class="fw-bold ${c}">${v}</span></td>`;
        let h=`<table class="nsa-result-table"><tr>${row('LEVEL',globalData.reviewLvl)}${row('NOTIF',globalData.notifDate)}${row('CLAIM',globalData.claimNo)}${row('PLAN',globalData.plan)}${row('GROUP',globalData.group)}</tr>`;
        h+=`<tr><td><span class="d-block small text-muted">SUB</span><b>${sub}</b></td>${row('PATIENT',globalData.patName)}${row('DOB',globalData.patDob)}${row('BILLED',globalData.billedStr,'text-primary')}${row('ALLOWED',globalData.allowedStr,'text-primary')}</tr>`;
        h+=`<tr>${row('PT SHARE',globalData.ptStr)}${row('PAID',globalData.paidStr,'text-success')}${row('DOS',globalData.dos)}${row('CPT',globalData.cpt)}${row('OFFER',globalData.offerStr)}</tr>`;
        h+=`<tr>${row('PLAN DEC',globalData.planDec)}${row('COUNTER',globalData.counterStr)}${row('MY DEC',globalData.yourDec)}${row('CLOSED',globalData.closedDate)}${row('REG',globalData.regulation)}</tr></table>`;
        con.innerHTML=h;
    }

    function generateCurrentNote(){
        if(!globalData)return;
        const nm=document.getElementById('note_Name').value.trim().toUpperCase(), st=document.getElementById('note_Status_NSA').value;
        if(!nm){document.getElementById('note_Name').classList.add('is-invalid');return;}
        
        const dVal=document.getElementById('note_Date').value.split('-'), dt=`${dVal[1]}/${dVal[2]}/${dVal[0].slice(-2)}`;
        const fmt=n=>'$'+(n||0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,','), gV=k=>fmt(globalVals[k]);
        
        let n="";
        // Note logic remains unchanged as per request, just status
        if(st==="In Review Plan") n=`${dt}>NSA NEG>${nm}>WORKING ON NSA PROJECT. CLAIM # ${globalData.claimNo}, BILLED AMOUNT ${gV('billed')}, ALLOWED AMOUNT ${gV('allowed')}, WITH MENTION THAT CLAIM PROCESSED PER NSA. SENT NSA NEGOTIATION OFFER OF ${gV('offer')}, PER FAIR HEALTH AMOUNT, THROUGH AVAILITY. Dispute ID: ${globalData.disputeId}.`;
        else if(st==="System Rejected") n=`${dt}>NSA NEG>${nm}>WORKING ON NSA PROJECT. CLAIM # ${globalData.claimNo}, BILLED AMOUNT ${gV('billed')}, ALLOWED AMOUNT ${gV('allowed')}, WITH MENTION THAT CLAIM PROCESSED PER NSA. SENT NSA NEGOTIATION OFFER OF ${gV('offer')}, AS PER FAIR HEALTH AMOUNT, THROUGH AVAILITY. OFFER IMMEDIATELY REJECTED BY BCBS. PUTTING TICKET ON NSA NEGO TRACKING GOOGLE SHEET TO START IDR PROCESS. Dispute ID: ${globalData.disputeId}.`;
        else if(st==="Offer Rejected") n=`${dt}>NSA NEG>${nm}>WORKING ON NSA PROJECT. CLAIM # ${globalData.claimNo}, BILLED AMOUNT ${gV('billed')}, ALLOWED AMOUNT ${gV('allowed')}, WITH MENTION THAT CLAIM PROCESSED PER NSA. SENT NSA NEGOTIATION OFFER OF ${gV('offer')}, BCBS MADE COUNTER OFFER OF ${gV('counter')}. THROUGH AVAILITY. OFFER REJECTED AS IT IS BELOW FAIR HEALTH AMOUNT. WILL FOLLOW UP TO SEE IF ANOTHER COUNTER NEGOTIATION OFFER WILL BE MADE OR NEED TO START IDR PROCESS. Dispute ID: ${globalData.disputeId}.`;
        else if(st==="Accepted") n=`${dt}>NSA ACCEPTED>${nm}>WORKING ON NSA PROJECT. CLAIM # ${globalData.claimNo}, BILLED AMOUNT ${gV('billed')}, ALLOWED AMOUNT ${gV('allowed')}, WITH MENTION THAT CLAIM PROCESSED PER NSA. SENT NSA NEGOTIATION OFFER OF ${gV('offer')}, AS PAR FAIR HEALTH AMOUNT. THROUGH AVAILITY. COUNTER OFFER ${gV('counter')}. WE ACCEPT IT. WILL WAIT FOR PAYMENT TO POST BEFORE SENDING FOR ADJUSTMENT. Dispute ID: ${globalData.disputeId}.`;
        
        const out=document.getElementById('note_Output_NSA');
        if(out.dataset.int) clearInterval(out.dataset.int); out.value=""; const w=n.split(' '); let i=0;
        out.dataset.int=setInterval(()=>{if(i<w.length){out.value+=(i>0?" ":"")+w[i];out.scrollTop=out.scrollHeight;i++}else clearInterval(out.dataset.int)},10);
    }

    function autoSelectStatus(){
        const s=document.getElementById('note_Status_NSA'), pd=(globalData.planDec||'').toLowerCase(), yd=(globalData.yourDec||'').toLowerCase();
        if(pd.includes('not accepted')) {
            if(yd.includes('not')) s.value = (globalVals.counter>0) ? "Offer Rejected" : "System Rejected";
            else if(yd.includes('accepted')) s.value = "Accepted";
            else s.value = (globalVals.counter>0) ? "Offer Rejected" : "System Rejected";
        }
        else if(pd.includes('accepted')) s.value = "Accepted";
        else s.value="In Review Plan";
    }
    
    function formatCurrency(n){return '$'+(parseFloat(n)||0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',')}
    function initDate(){const d=new Date(new Date().toLocaleString("en-US",{timeZone:"America/New_York"})); document.getElementById('note_Date').value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
    
    function startWatches(){
        const upd=(p,tz)=>{
            const el=document.getElementById(p+'Time'), dt=document.getElementById(p+'Date'), pr=document.getElementById(p+'Prog'); if(!el)return;
            const n=new Date(new Date().toLocaleString("en-US",{timeZone:tz}));
            dt.textContent=n.toLocaleDateString('en-US',{weekday:'short',day:'numeric',month:'short'});
            el.innerHTML=`${String(n.getHours()%12||12).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}<span>${n.getHours()>=12?'PM':'AM'}</span>`;
            const totalSec = n.getSeconds() + n.getMilliseconds()/1000;
            const percent = (totalSec / 60) * 157; 
            pr.style.strokeDashoffset = 157 - percent;
        };
        setInterval(()=>{upd('us','America/Chicago')},50);
    }
</script>
</body>
</html>
