<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Test</title>
    
    <!-- NEW: Premium Font (Poppins) + Mono for typing -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Chart.js for speed graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- Base & Typography (from Index.txt) --- */
        :root {
            /* NEW: Premium Font */
            --bs-body-font-family: 'Poppins', sans-serif;
            --bs-heading-font-family: 'Poppins', sans-serif;
            
            /* --- Light Mode (Translucent Glass) --- */
            --bs-body-bg-light: #f3e7ff; 
            --bs-body-color-light: #212529;
            --bs-tertiary-bg-light: rgba(255, 255, 255, 0.7); 
            --bs-secondary-bg-light: #f8f9fa; 
            --bs-border-color-light: rgba(0, 0, 0, 0.1); 
            
            --bs-glass-bg-light: rgba(255, 255, 255, 0.6); 
            --bs-glass-border-light: var(--bs-border-color-light);
            --bs-card-bg-light: var(--bs-tertiary-bg-light);
            --bs-card-border-light: var(--bs-border-color-light);

            /* --- Dark Mode (Translucent Glass) --- */
            --bs-body-bg-dark: #0a0c10; 
            --bs-body-color-dark: #e0e0e0;
            --bs-tertiary-bg-dark: rgba(22, 27, 34, 0.7); 
            --bs-secondary-bg-dark: #2a2a2a;
            --bs-border-color-dark: rgba(255, 255, 255, 0.1); 
            --bs-light-bg-subtle-dark: #161b22;

            --bs-glass-bg-dark: rgba(10, 12, 16, 0.6); 
            --bs-glass-border-dark: var(--bs-border-color-dark);
            --bs-card-bg-dark: var(--bs-tertiary-bg-dark); 
            --bs-card-border-dark: var(--bs-border-color-dark);

            --bs-primary-dark: #00f0b5;
            --bs-primary-rgb-dark: 0, 240, 181;
            
            /* Finger Colors */
            --finger-lp: #ff80ed; /* Pink */
            --finger-lr: #ffc40c; /* Yellow */
            --finger-lm: #34b86c; /* Green */
            --finger-li: #41a4ff; /* Blue */
            --finger-t:  #8b5cf6; /* Violet */
            --finger-ri: #41a4ff; /* Blue */
            --finger-rm: #34b86c; /* Green */
            --finger-rr: #ffc40c; /* Yellow */
            --finger-rp: #ff80ed; /* Pink */
        }

        [data-bs-theme="light"] {
            --bs-body-bg: var(--bs-body-bg-light);
            --bs-body-color: var(--bs-body-color-light);
            --bs-tertiary-bg: var(--bs-tertiary-bg-light);
            --bs-secondary-bg: var(--bs-secondary-bg-light);
            --bs-border-color: var(--bs-border-color-light);
            --bs-light-bg-subtle: var(--bs-light-bg-subtle-light);

            --bs-glass-bg: var(--bs-glass-bg-light);
            --bs-glass-border: var(--bs-glass-border-light);
            --bs-card-bg: var(--bs-card-bg-light);
            --bs-card-border: var(--bs-card-border-light);
        }

        [data-bs-theme="dark"] {
            --bs-body-bg: var(--bs-body-bg-dark);
            --bs-body-color: var(--bs-body-color-dark);
            --bs-tertiary-bg: var(--bs-tertiary-bg-dark);
            --bs-secondary-bg: var(--bs-secondary-bg-dark);
            --bs-border-color: var(--bs-border-color-dark);
            --bs-light-bg-subtle: var(--bs-light-bg-subtle-dark);

            --bs-glass-bg: var(--bs-glass-bg-dark);
            --bs-glass-border: var(--bs-glass-border-dark);
            --bs-card-bg: var(--bs-card-bg-dark);
            --bs-card-border: var(--bs-border-color-dark);

            --bs-primary: var(--bs-primary-dark);
            --bs-primary-rgb: var(--bs-primary-rgb-dark);
            --bs-link-color: var(--bs-primary-dark);
            --bs-link-color-rgb: var(--bs-primary-rgb-dark);
            --bs-link-hover-color: #33ffc7;
        }

        body {
            font-family: var(--bs-body-font-family);
            background-color: transparent; 
            transition: background-color 0.3s ease;
            padding-top: 70px; /* Fixed navbar height */
            overflow: hidden; /* Prevent body scroll */
        }
        
        /* --- Animated Background Container (from Index.txt) --- */
        #animated-bg-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: -10; 
            overflow: hidden;
        }
        .bg-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(20px); 
            -webkit-filter: blur(20px);
            opacity: 0;
            transition: opacity 1.5s ease-in-out; 
            transform: scale(1.1); 
        }
        .bg-image.active {
            opacity: 1;
        }
        /* Background Images (from Index.txt) */
        [data-bs-theme="light"] .bg-image-light.bg-1 { background-image: url('https://cdn.pixabay.com/photo/2014/09/21/14/39/surface-455124_1280.jpg'); }
        [data-bs-theme="light"] .bg-image-light.bg-2 { background-image: url('https.cdn.pixabay.com/photo/2015/10/24/11/09/drop-1004250_1280.jpg'); }
        [data-bs-theme="light"] .bg-image-light.bg-3 { background-image: url('https.cdn.pixabay.com/photo/2018/01/12/14/24/night-3078326_1280.jpg'); }
        [data-bs-theme="dark"] .bg-image-dark.bg-1 { background-image: url('https://cdn.pixabay.com/photo/2022/08/02/02/28/cherry-7359319_1280.jpg'); }
        [data-bs-theme="dark"] .bg-image-dark.bg-2 { background-image: url('https://cdn.pixabay.com/photo/2020/04/20/20/47/red-5069808_1280.jpg'); }
        [data-bs-theme="dark"] .bg-image-dark.bg-3 { background-image: url('https://cdn.pixabay.com/photo/2015/07/10/14/56/moon-839306_1280.jpg'); }
        [data-bs-theme="light"] .bg-image-dark { display: none; }
        [data-bs-theme="dark"] .bg-image-light { display: none; }
        
        h1, h2, h3, h4, h5, h6, .fw-bold {
            font-family: var(--bs-heading-font-family);
            font-weight: 700;
        }

        /* --- Glass Card Style (from Index.txt) --- */
        .card {
            background-color: var(--bs-card-bg);
            border: 1px solid var(--bs-card-border);
            border-radius: 1rem; /* Smaller radius */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
        }
        [data-bs-theme="dark"] .card {
             box-shadow: none;
             border-radius: 0.75rem;
        }

        /* --- Fixed Menubar --- */
        .navbar-glass {
            background-color: var(--bs-glass-bg);
            border-bottom: 1px solid var(--bs-glass-border);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }
        .navbar-brand .logo-icon {
            background: linear-gradient(to right, #6a11cb 0%, #2575fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        [data-bs-theme="dark"] .navbar-brand .logo-icon {
            background: linear-gradient(to right, #00f0b5 0%, #00c9ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .nav-link {
            font-weight: 500;
        }
        .nav-link.active {
            color: var(--bs-primary) !important;
            font-weight: 700;
        }

        /* --- NEW: Theme Toggle Button (for Theme Bar) --- */
        .btn-theme-toggle {
            background-color: var(--bs-secondary-bg);
            border: 1px solid var(--bs-border-color);
            color: var(--bs-secondary-color);
            transition: all 0.2s ease;
            border-radius: 13px;
        }
        .btn-theme-toggle:hover {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
            color: #fff;
            box-shadow: 0 4px 12px rgba(var(--bs-primary-rgb), 0.3);
        }
        [data-bs-theme="dark"] .btn-theme-toggle {
            background-color: var(--bs-tertiary-bg-dark);
            border-color: var(--bs-border-color-dark);
            color: var(--bs-body-color-dark);
        }
        [data-bs-theme="dark"] .btn-theme-toggle:hover {
            background-color: var(--bs-primary-dark);
            border-color: var(--bs-primary-dark);
            color: #000;
        }

        /* --- Main Layout --- */
        .main-container {
            height: calc(100vh - 70px); /* Full height minus navbar */
            display: flex;
            gap: 0.75rem; /* Minimized gap */
            padding: 0.75rem;
        }

        .left-column {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-width: 0; /* Prevent flex overflow */
        }
        
        .top-row {
            display: flex;
            gap: 0.75rem;
            flex-shrink: 0; /* Don't shrink top row */
        }

        .settings-panel {
            width: 35%;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            padding: 0.75rem; /* Minimized padding */
        }

        .typing-area {
            width: 65%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 0.75rem; /* Minimized padding */
        }

        .keyboard-area {
            flex-grow: 1; /* Fill remaining vertical space */
            flex-shrink: 1;
            padding: 0.75rem; /* Minimized padding */
            overflow: hidden; /* Hide keyboard overflow */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stats-panel {
            width: 25%;
            max-width: 300px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            padding: 1rem; /* Minimized padding */
        }

        /* --- Settings Panel --- */
        .paragraph-list-box {
            flex-grow: 1; 
            overflow-y: auto;
            max-height: 150px; /* Minimized height */
        }
        .paragraph-list-box .list-group-item {
            cursor: pointer;
            background-color: rgba(128, 128, 128, 0.1);
            border-color: var(--bs-border-color);
            transition: all 0.2s ease;
            padding: 0.5rem 0.75rem; /* Minimized padding */
            /* Single line headline */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .paragraph-list-box .list-group-item:hover {
            background-color: rgba(128, 128, 128, 0.2);
        }
        .paragraph-list-box .list-group-item.active {
            background-color: var(--bs-primary);
            color: #fff;
            border-color: var(--bs-primary);
        }
        [data-bs-theme="dark"] .paragraph-list-box .list-group-item.active {
            color: #000;
        }

        /* --- Middle Typing Area --- */
        #source-paragraph-display {
            font-family: 'Roboto Mono', monospace; 
            font-size: 1.1rem; /* Minimized size */
            line-height: 1.7;
            height: 180px; /* Minimized height */
            overflow-y: auto;
            border-radius: 0.75rem;
            padding: 0.75rem;
            background-color: rgba(128, 128, 128, 0.1);
            transition: background-image 0.3s ease;
        }
        #source-paragraph-display span {
            transition: all 0.1s ease;
        }
        .char-correct { color: #28a745; }
        .char-incorrect { color: #dc3545; background-color: rgba(220, 53, 69, 0.1); }
        .char-current {
            background-color: rgba(var(--bs-primary-rgb), 0.3);
            border-radius: 2px;
        }

        #typing-input {
            font-family: 'Roboto Mono', monospace;
            font-size: 1.1rem; /* Minimized size */
            height: 130px; /* Minimized height */
            resize: none;
            background-color: var(--bs-card-bg);
            border: 1px solid var(--bs-card-border);
            transition: background-image 0.3s ease;
        }
        #typing-input:focus {
            background-color: var(--bs-card-bg);
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 3px rgba(var(--bs-primary-rgb), 0.2);
            color: var(--bs-body-color);
        }
        
        /* NEW: Focus Gradient Theme */
        body.focus-gradient-enabled #typing-input:focus {
             background-image: linear-gradient(to bottom right, var(--bs-card-bg), rgba(var(--bs-primary-rgb), 0.1));
        }
        body.focus-gradient-enabled #source-paragraph-display {
             background-image: linear-gradient(to top left, rgba(128, 128, 128, 0.1), rgba(var(--bs-primary-rgb), 0.05));
        }
        
        
        /* --- Realistic Keyboard --- */
        #keyboard-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        #keyboard {
            user-select: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .keyboard-row {
            display: flex;
            justify-content: center;
            margin-bottom: 5px; /* Minimized gap */
        }
        .key {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 0.85rem;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.1);
            border-bottom: 3px solid rgba(0,0,0,0.3);
            background-image: linear-gradient(to bottom, var(--bs-tertiary-bg), rgba(128,128,128,0.1));
            padding: 8px; /* Minimized padding */
            min-width: 36px; /* Minimized size */
            height: 36px; /* Minimized size */
            margin: 0 3px;
            transition: all 0.05s ease;
        }
        [data-bs-theme="dark"] .key {
            border: 1px solid rgba(255,255,255,0.1);
            border-bottom: 3px solid rgba(0,0,0,0.5);
            background-image: linear-gradient(to bottom, var(--bs-tertiary-bg), rgba(0,0,0,0.2));
        }
        
        /* NEW: Key Press Effect */
        .key:active, .key.active-press { 
            transform: translateY(2px); /* Press down */
            border-bottom-width: 1px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
            /* Full color highlight */
            background-image: none;
            background-color: var(--bs-primary);
            color: #000;
            border-color: var(--bs-primary);
        }
        
        /* Special key widths */
        .key[data-key="Backspace"], .key[data-key="Enter"] { width: 80px; }
        .key[data-key="Tab"], .key[data-key="\\"] { width: 55px; }
        .key[data-key="CapsLock"] { width: 70px; }
        .key[data-key="ShiftLeft"] { width: 95px; }
        .key[data-key="ShiftRight"] { width: 95px; }
        .key[data-key="ControlLeft"], .key[data-key="ControlRight"] { width: 50px; }
        .key[data-key="AltLeft"], .key[data-key="AltRight"] { width: 50px; }
        .key[data-key="MetaLeft"] { width: 50px; }
        .key[data-key=" "] { width: 300px; }

        /* Finger Colors (Theme Default) */
        #keyboard.theme-default .key.finger-lp { background-color: var(--finger-lp); color: #000; }
        #keyboard.theme-default .key.finger-lr { background-color: var(--finger-lr); color: #000; }
        #keyboard.theme-default .key.finger-lm { background-color: var(--finger-lm); color: #000; }
        #keyboard.theme-default .key.finger-li { background-color: var(--finger-li); color: #000; }
        #keyboard.theme-default .key.finger-t  { background-color: var(--finger-t);  color: #fff; }
        #keyboard.theme-default .key.finger-ri { background-color: var(--finger-ri); color: #000; }
        #keyboard.theme-default .key.finger-rm { background-color: var(--finger-rm); color: #000; }
        #keyboard.theme-default .key.finger-rr { background-color: var(--finger-rr); color: #000; }
        #keyboard.theme-default .key.finger-rp { background-color: var(--finger-rp); color: #000; }
        
        /* --- NEW: Hand SVGs --- */
        .hand-svg {
            width: 150px;
            height: auto;
            opacity: 0.7;
            transition: all 0.3s ease;
        }
        .hand-svg path {
            fill: var(--bs-tertiary-bg);
            stroke: var(--bs-border-color);
            stroke-width: 2;
            transition: fill 0.1s ease;
        }
        /* Highlight finger */
        .hand-svg path.active {
            fill: var(--bs-primary);
            stroke: var(--bs-primary);
        }
        body.hands-hidden #left-hand,
        body.hands-hidden #right-hand {
            display: none;
        }
        
        /* --- NEW: Theme Bar --- */
        #theme-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        #theme-bar .btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
        }
        #theme-bar .form-switch .form-check-label {
            font-size: 0.8rem;
            font-weight: 500;
        }


        /* --- Right Stats Panel --- */
        .stats-panel {
            gap: 0.75rem; /* Minimized gap */
        }
        .stat-display {
            text-align: center;
            flex-shrink: 0;
        }
        .stat-value {
            font-size: 3rem; /* Minimized size */
            font-weight: 700;
            color: var(--bs-primary);
            line-height: 1;
        }
        .stat-label {
            font-size: 0.9rem; /* Minimized size */
            font-weight: 500;
            color: var(--bs-secondary-color);
        }
        #speed-chart-container {
            flex-grow: 1; /* Fill remaining space */
            min-height: 150px; /* Min height */
        }
        
        /* --- Modal --- */
        .modal-content {
             background-color: var(--bs-glass-bg); 
             backdrop-filter: blur(20px);
             -webkit-backdrop-filter: blur(20px);
             border: 1px solid var(--bs-card-border);
             border-radius: 1rem;
        }

        /* --- Footer (Copied from Index.txt) --- */
        #main-footer {
            background-color: var(--bs-card-bg);
            border-top: 1px solid var(--bs-card-border);
            padding: 2rem 1rem; /* Minimized padding */
            margin: 0.75rem;
            color: var(--bs-secondary-color);
            border-radius: 1rem;
        }
        #main-footer h5 {
            color: var(--bs-body-color);
            font-weight: 600;
        }
        #main-footer .footer-links {
            list-style: none;
            padding-left: 0;
        }
        #main-footer .footer-links li {
            margin-bottom: 0.5rem;
        }
        #main-footer .footer-links a {
            text-decoration: none;
            color: var(--bs-secondary-color);
            transition: all 0.2s ease;
        }
        #main-footer .footer-links a:hover {
            color: var(--bs-primary);
            text-decoration: underline;
        }
        #main-footer .social-links a {
            font-size: 1.5rem;
            color: var(--bs-secondary-color);
            margin-right: 1rem;
            transition: all 0.2s ease;
        }
        #main-footer .social-links a:hover {
            color: var(--bs-primary);
            transform: scale(1.1);
        }
        
        /* --- History View --- */
        #history-view {
            padding: 1.5rem;
        }
        #history-table-container {
            max-height: calc(100vh - 200px); /* Full height minus nav and title */
            overflow-y: auto;
        }

        /* --- Tab Animation --- */
        .tab-pane {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .tab-pane:not(.show) {
            opacity: 0;
            transform: translateY(10px);
            display: block; /* Keep it in flow for transition */
            height: 0;
            overflow: hidden;
        }
        .tab-pane.show {
            opacity: 1;
            transform: translateY(0);
        }

    </style>
</head>

<body>
    <!-- Animated Background -->
    <div id="animated-bg-container">
        <div class="bg-image bg-image-light bg-1 active"></div>
        <div class="bg-image bg-image-light bg-2"></div>
        <div class="bg-image bg-image-light bg-3"></div>
        <div class="bg-image bg-image-dark bg-1"></div>
        <div class="bg-image bg-image-dark bg-2"></div>
        <div class="bg-image bg-image-dark bg-3"></div>
    </div>

    <!-- Fixed Menubar -->
    <nav class="navbar navbar-expand-lg navbar-glass fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                <i class="bi bi-keyboard-fill logo-icon"></i>
                Typing Test
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <!-- NEW: Centered Nav -->
                <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#" id="home-link">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="history-link">History</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Pranto's Note</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Main Page</a>
                    </li>
                </ul>
                <!-- Theme Toggle Button (REMOVED) -->
            </div>
        </div>
    </nav>

    <!-- Main Container Wrapper -->
    <div class="main-container">

        <!-- Main View (Typing) -->
        <div id="main-view" class="d-flex w-100 h-100" style="gap: 0.75rem;">
            <!-- Left Column (Settings, Typing, Keyboard) -->
            <div class="left-column">
                
                <!-- Top Row (Settings + Typing) -->
                <div class="top-row">
                    <!-- Left Panel: Settings -->
                    <div class="card settings-panel">
                        <!-- Category -->
                        <div class="mb-2">
                            <label for="category-select" class="form-label fw-bold">Category</label>
                            <select class="form-select form-select-sm" id="category-select">
                                <option value="Easy" selected>Easy</option>
                                <option value="Medium">Medium</option>
                                <option value="Hard">Hard</option>
                                <option value="Number Practice">Number Practice</option>
                            </select>
                        </div>
                        <!-- Time -->
                        <div class="mb-2">
                            <label class="form-label fw-bold">Time (Minutes)</label>
                            <div class="d-flex" id="time-select-group">
                                <button class="btn btn-sm btn-outline-primary active w-100 me-2" data-time="1">1</button>
                                <button class="btn btn-sm btn-outline-primary w-100 me-2" data-time="2">2</button>
                                <button class="btn btn-sm btn-outline-primary w-100 me-2" data-time="3">3</button>
                                <button class="btn btn-sm btn-outline-primary w-100" data-time="5">5</button>
                            </div>
                        </div>
                        <!-- Paragraph List -->
                        <div class="d-flex flex-column flex-grow-1">
                            <label class="form-label fw-bold">Paragraphs</label>
                            <div class="list-group paragraph-list-box" id="paragraph-list">
                                <!-- Paragraphs will be loaded by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Middle Panel: Typing Area -->
                    <div class="card typing-area">
                        <!-- Paragraph Display -->
                        <div id="source-paragraph-display" class="mb-2 card-body">
                            Click a paragraph from the list to start...
                        </div>
                        <!-- Typing Input -->
                        <textarea id="typing-input" class="form-control" placeholder="Start typing here..." disabled></textarea>
                    </div>
                </div>

                <!-- Bottom Row (Keyboard & Themes) -->
                <div class="card keyboard-area">
                    <!-- NEW: Keyboard + Hands Container -->
                    <div id="keyboard-container">
                        <!-- Left Hand SVG -->
                        <svg id="left-hand" class="hand-svg" viewBox="0 0 200 200" style="width: 120px;">
                            <path id="lf-pinky" data-finger="lf-pinky" d="M50 100 A 15 15 0 0 1 65 80 L 75 40 A 15 15 0 0 1 105 40 L 115 80 A 15 15 0 0 1 130 100 Z" transform="rotate(-30 85 70) scale(0.8) translate(-10, 40)"/>
                            <path id="lf-ring" data-finger="lf-ring" d="M50 100 A 15 15 0 0 1 65 80 L 75 30 A 15 15 0 0 1 105 30 L 115 80 A 15 15 0 0 1 130 100 Z" transform="rotate(-15 85 65) scale(0.9) translate(15, 20)"/>
                            <path id="lf-middle" data-finger="lf-middle" d="M50 100 A 15 15 0 0 1 65 80 L 75 20 A 15 15 0 0 1 105 20 L 115 80 A 15 15 0 0 1 130 100 Z" transform="rotate(0 85 60) scale(1) translate(40, 10)"/>
                            <path id="lf-index" data-finger="lf-index" d="M50 100 A 15 15 0 0 1 65 80 L 75 30 A 15 15 0 0 1 105 30 L 115 80 A 15 15 0 0 1 130 100 Z" transform="rotate(15 85 65) scale(0.9) translate(65, 20)"/>
                            <path id="lf-thumb" data-finger="lf-thumb" d="M50 100 A 20 20 0 0 1 70 70 L 100 60 A 20 20 0 0 1 140 60 L 160 70 A 20 20 0 0 1 180 100 Z" transform="rotate(60 110 80) scale(0.6) translate(50, 80)"/>
                            <!-- Palm -->
                            <path d="M40 180 A 30 30 0 0 1 70 150 L 130 140 A 30 30 0 0 1 160 170 L 140 190 A 30 30 0 0 1 100 200 L 60 190 A 30 30 0 0 1 40 180 Z" transform="translate(10, -30)" />
                        </svg>

                        <!-- Virtual Keyboard -->
                        <div id="keyboard" class="theme-default">
                            <div class="keyboard-row">
                                <div class="key finger-lp" data-key="`" data-finger="lf-pinky">`</div>
                                <div class="key finger-lp" data-key="1" data-finger="lf-pinky">1</div>
                                <div class="key finger-lr" data-key="2" data-finger="lf-ring">2</div>
                                <div class="key finger-lm" data-key="3" data-finger="lf-middle">3</div>
                                <div class="key finger-li" data-key="4" data-finger="lf-index">4</div>
                                <div class="key finger-li" data-key="5" data-finger="lf-index">5</div>
                                <div class="key finger-ri" data-key="6" data-finger="rf-index">6</div>
                                <div class="key finger-ri" data-key="7" data-finger="rf-index">7</div>
                                <div class="key finger-rm" data-key="8" data-finger="rf-middle">8</div>
                                <div class="key finger-rr" data-key="9" data-finger="rf-ring">9</div>
                                <div class="key finger-rp" data-key="0" data-finger="rf-pinky">0</div>
                                <div class="key finger-rp" data-key="-" data-finger="rf-pinky">-</div>
                                <div class="key finger-rp" data-key="=" data-finger="rf-pinky">=</div>
                                <div class="key finger-rp" data-key="Backspace" data-finger="rf-pinky">Backspace</div>
                            </div>
                            <div class="keyboard-row">
                                <div class="key finger-lp" data-key="Tab" data-finger="lf-pinky">Tab</div>
                                <div class="key finger-lp" data-key="q" data-finger="lf-pinky">Q</div>
                                <div class="key finger-lr" data-key="w" data-finger="lf-ring">W</div>
                                <div class="key finger-lm" data-key="e" data-finger="lf-middle">E</div>
                                <div class="key finger-li" data-key="r" data-finger="lf-index">R</div>
                                <div class="key finger-li" data-key="t" data-finger="lf-index">T</div>
                                <div class="key finger-ri" data-key="y" data-finger="rf-index">Y</div>
                                <div class="key finger-ri" data-key="u" data-finger="rf-index">U</div>
                                <div class="key finger-rm" data-key="i" data-finger="rf-middle">I</div>
                                <div class="key finger-rr" data-key="o" data-finger="rf-ring">O</div>
                                <div class="key finger-rp" data-key="p" data-finger="rf-pinky">P</div>
                                <div class="key finger-rp" data-key="[" data-finger="rf-pinky">[</div>
                                <div class="key finger-rp" data-key="]" data-finger="rf-pinky">]</div>
                                <div class="key finger-rp" data-key="\" data-finger="rf-pinky">| \</div>
                            </div>
                            <div class="keyboard-row">
                                <div class="key finger-lp" data-key="CapsLock" data-finger="lf-pinky">CapsLock</div>
                                <div class="key finger-lp" data-key="a" data-finger="lf-pinky">A</div>
                                <div class="key finger-lr" data-key="s" data-finger="lf-ring">S</div>
                                <div class="key finger-lm" data-key="d" data-finger="lf-middle">D</div>
                                <div class="key finger-li" data-key="f" data-finger="lf-index">F</div>
                                <div class="key finger-li" data-key="g" data-finger="lf-index">G</div>
                                <div class="key finger-ri" data-key="h" data-finger="rf-index">H</div>
                                <div class="key finger-ri" data-key="j" data-finger="rf-index">J</div>
                                <div class="key finger-rm" data-key="k" data-finger="rf-middle">K</div>
                                <div class="key finger-rr" data-key="l" data-finger="rf-ring">L</div>
                                <div class="key finger-rp" data-key=";" data-finger="rf-pinky">;</div>
                                <div class="key finger-rp" data-key="'" data-finger="rf-pinky">'</div>
                                <div class="key finger-rp" data-key="Enter" data-finger="rf-pinky">Enter</div>
                            </div>
                            <div class="keyboard-row">
                                <div class="key finger-lp" data-key="ShiftLeft" data-finger="lf-pinky">Shift</div>
                                <div class="key finger-lp" data-key="z" data-finger="lf-pinky">Z</div>
                                <div class="key finger-lr" data-key="x" data-finger="lf-ring">X</div>
                                <div class="key finger-lm" data-key="c" data-finger="lf-middle">C</div>
                                <div class="key finger-li" data-key="v" data-finger="lf-index">V</div>
                                <div class="key finger-li" data-key="b" data-finger="lf-index">B</div>
                                <div class="key finger-ri" data-key="n" data-finger="rf-index">N</div>
                                <div class="key finger-ri" data-key="m" data-finger="rf-index">M</div>
                                <div class="key finger-rm" data-key="," data-finger="rf-middle">,</div>
                                <div class="key finger-rr" data-key="." data-finger="rf-ring">.</div>
                                <div class="key finger-rp" data-key="/" data-finger="rf-pinky">/</div>
                                <div class="key finger-rp" data-key="ShiftRight" data-finger="rf-pinky">Shift</div>
                            </div>
                            <div class="keyboard-row">
                                <div class="key finger-lp" data-key="ControlLeft" data-finger="lf-pinky">Ctrl</div>
                                <div class="key finger-li" data-key="MetaLeft" data-finger="lf-index">Win</div>
                                <div class="key finger-lm" data-key="AltLeft" data-finger="lf-middle">Alt</div>
                                <div class="key finger-t" data-key=" " data-finger="lf-thumb rf-thumb">Space</div>
                                <div class="key finger-rm" data-key="AltRight" data-finger="rf-middle">Alt</div>
                                <div class="key finger-rp" data-key="ControlRight" data-finger="rf-pinky">Ctrl</div>
                            </div>
                        </div>
                        
                        <!-- Right Hand SVG -->
                        <svg id="right-hand" class="hand-svg" viewBox="0 0 200 200" style="width: 120px; transform: scaleX(-1);">
                            <path id="rf-pinky" data-finger="rf-pinky" d="M50 100 A 15 15 0 0 1 65 80 L 75 40 A 15 15 0 0 1 105 40 L 115 80 A 15 15 0 0 1 130 100 Z" transform="rotate(-30 85 70) scale(0.8) translate(-10, 40)"/>
                            <path id="rf-ring" data-finger="rf-ring" d="M50 100 A 15 15 0 0 1 65 80 L 75 30 A 15 15 0 0 1 105 30 L 115 80 A 15 15 0 0 1 130 100 Z" transform="rotate(-15 85 65) scale(0.9) translate(15, 20)"/>
                            <path id="rf-middle" data-finger="rf-middle" d="M50 100 A 15 15 0 0 1 65 80 L 75 20 A 15 15 0 0 1 105 20 L 115 80 A 15 15 0 0 1 130 100 Z" transform="rotate(0 85 60) scale(1) translate(40, 10)"/>
                            <path id="rf-index" data-finger="rf-index" d="M50 100 A 15 15 0 0 1 65 80 L 75 30 A 15 15 0 0 1 105 30 L 115 80 A 15 15 0 0 1 130 100 Z" transform="rotate(15 85 65) scale(0.9) translate(65, 20)"/>
                            <path id="rf-thumb" data-finger="rf-thumb" d="M50 100 A 20 20 0 0 1 70 70 L 100 60 A 20 20 0 0 1 140 60 L 160 70 A 20 20 0 0 1 180 100 Z" transform="rotate(60 110 80) scale(0.6) translate(50, 80)"/>
                            <!-- Palm -->
                            <path d="M40 180 A 30 30 0 0 1 70 150 L 130 140 A 30 30 0 0 1 160 170 L 140 190 A 30 30 0 0 1 100 200 L 60 190 A 30 30 0 0 1 40 180 Z" transform="translate(10, -30)" />
                        </svg>
                    </div>

                    <!-- NEW: Theme Bar -->
                    <div id="theme-bar" class="card p-2 mt-2">
                        <div class="d-flex justify-content-center align-items-center gap-3">
                            <!-- Dark/Light Toggle -->
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="theme-toggle-switch">
                                <label class="form-check-label" for="theme-toggle-switch">Dark Mode</label>
                            </div>
                            <!-- Hand Guide Toggle -->
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="hand-toggle" checked>
                                <label class="form-check-label" for="hand-toggle">Hand Guide</label>
                            </div>
                            <!-- Focus Gradient Toggle -->
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="focus-toggle">
                                <label class="form-check-label" for="focus-toggle">Focus Gradient</label>
                            </div>
                            <!-- Keyboard Theme -->
                            <button id="keyboard-theme" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-palette-fill"></i> Keyboard Theme
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Stats -->
            <div class="card stats-panel">
                <!-- Timer -->
                <div class="stat-display mb-3">
                    <div id="timer-display" class="stat-value" style="font-size: 3.5rem;">1:00</div>
                    <div class="stat-label">Time Remaining</div>
                </div>
                <!-- WPM -->
                <div class="stat-display mb-3">
                    <div id="wpm-display" class="stat-value">0</div>
                    <div class="stat-label">Words / Min</div>
                </div>
                <!-- Accuracy -->
                <div class="stat-display mb-3">
                    <div id="accuracy-display" class="stat-value">100%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <!-- Restart Button -->
                <button id="restart-button" class="btn btn-outline-danger btn-lg w-100 mb-3" disabled>
                    <i class="bi bi-arrow-clockwise"></i> Restart Test
                </button>
                <!-- Speed Chart -->
                <div id="speed-chart-container" class="mt-auto">
                    <canvas id="speed-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- NEW: History View (Hidden) -->
        <div id="history-view" class="d-none w-100 h-100">
            <div class="card w-100 h-100 d-flex flex-column">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="bi bi-clock-history me-2"></i>Typing History</h4>
                    <button id="clear-history-btn" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash"></i> Clear All
                    </button>
                </div>
                <div class="card-body" id="history-table-container">
                    <table class="table table-striped table-hover">
                        <thead class="sticky-top">
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Time</th>
                                <th>WPM</th>
                                <th>Accuracy</th>
                                <th>Characters</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                            <!-- History rows will be loaded by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div> <!-- End Main Container -->


    <!-- Footer (Copied from Index.txt) -->
    <footer id="main-footer">
        <div class="container-fluid">
            <div class="row g-4">
                <!-- Column 1: About -->
                <div class="col-4">
                    <h5><i class="bi bi-keyboard-fill me-2 text-primary"></i>Typing Test</h5>
                    <p class="small">
                        Your personal tool for tracking typing speed, accuracy, and daily progress.
                    </p>
                    <div class="mt-3 social-links">
                        <a href="https://www.linkedin.com/in/pranto-rodrix-90463615b/" target="blank" title="LinkedIn"><i class="bi bi-linkedin"></i></a>
                        <a href="https://github.com/prantorodrix" target="blank" title="GitHub"><i class="bi bi-github"></i></a>
                        <a href="https://x.com/pranto83945" target="blank" title="Twitter"><i class="bi bi-twitter-x"></i></a>
                    </div>
                </div>
                
                <!-- Column 2: Quick Links -->
                <div class="col-2">
                    <h5>Quick Links</h5>
                    <ul class="footer-links">
                        <li><a href="#" id="footer-home-link">Home</a></li>
                        <li><a href="#" id="footer-history-link">History</a></li>
                        <li><a href="index.html">Main Page</a></li>
                    </ul>
                </div>

                <!-- Column 3: Help & Support -->
                <div class="col-3">
                    <h5>Help & Support</h5>
                    <ul class="footer-links">
                        <li><a href="#">FAQs</a></li>
                        <li><a href="#">Report an Issue</a></li>
                        <li><a href="#">Contact Support</a></li>
                    </ul>
                </div>
                
                <!-- Column 4: Contact Info -->
                <div class="col-3">
                    <h5>Contact</h5>
                    <ul class="footer-links">
                        <li class="d-flex align-items-center">
                            <i class="bi bi-telephone-fill me-2"></i>
                            <a href="tel:+8801318138951">+8801318138951</a>
                        </li>
                        <li class="d-flex align-items-center">
                            <i class="bi bi-envelope-fill me-2"></i>
                            <a href="mailto:prantorodrix9@gmail.com">prantorodrix9@gmail.com</a>
                        </li>
                        <li class="d-flex align-items-center">
                            <i class="bi bi-geo-alt-fill me-2"></i>
                            <span>Dhaka, Bangladesh</span>
                        </li>
                    </ul>
                </div>
            </div>
            <hr class="my-3">
            <div class="text-center small">
                <p class="mb-0">Made by <span class="fw-semibold text-primary"><a href="https://www.facebook.com/pranto.anthony1/" target="black" title="Facebook">@PrantoRodrix</a></span></p>
                <p class="mb-0">&copy; <span id="footer-year">2025</span> Typing Test. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Result Modal -->
    <div class="modal fade" id="result-modal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h1 class="modal-title fs-4 fw-bold" id="resultModalLabel">
                        <i class="bi bi-check-circle-fill text-success"></i> Test Complete!
                    </h1>
                </div>
                <div class="modal-body">
                    <p>Here is your result for the test:</p>
                    <div class="row text-center g-3">
                        <div class="col-6">
                            <div class="card p-2">
                                <div class="stat-value" id="modal-wpm">0</div>
                                <div class="stat-label">WPM</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card p-2">
                                <div class="stat-value" id="modal-accuracy">100%</div>
                                <div class="stat-label">Accuracy</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card p-2">
                                <span id="modal-chars" class="fs-5 fw-bold">0 / 0</span>
                                <div class="stat-label">Characters (Correct / Total)</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card p-2">
                                <span id="modal-time" class="fs-5 fw-bold">0s</span>
                                <div class="stat-label">Time Taken</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-primary" id="save-button">
                        <i class="bi bi-save"></i> Save the progress
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="close-button">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- 1. Theme & Background Logic (from Index.txt) ---
        const htmlEl = document.documentElement;
        // Theme elements moved to Theme Bar
        let currentImageIndex = 0;

        // --- 2. Typing Paragraph Data ---
        const paragraphData = {
            "Easy": [
                {
                    title: "1) The Beauty of a Sunny Day",
                    text: "A sunny day brings warmth and light that can lift anyone's spirits. People often go outside to enjoy the fresh air, taking long walks in the park or simply relaxing in their backyards. The sky is clear, and the sunlight sparkles on the surface of lakes and rivers. Birds sing, and flowers bloom in colorful arrays. A sunny day is not only a gift to nature but also a chance for humans to connect with the outdoors. Whether you're with family, friends, or enjoying time alone, there is something special about the sunlight that brightens the world. Children laugh as they play, and even adults find themselves more active, enjoying the energy the sun provides. The entire atmosphere changes, making everything feel more alive and hopeful. A simple sunny day can offer an escape from the hustle of daily life and create moments of peace."
                },
                {
                    title: "2) The Importance of Friendship",
                    text: "Friendship is one of the most valuable relationships a person can have. True friends support each other during both good and bad times. They provide comfort, laughter, and companionship. A good friend listens without judgment, offers advice when needed, and shares in the joys and challenges of life. Friendships are built on trust and mutual respect, and they help individuals grow emotionally. No matter how busy life may get, having a close friend by your side can make all the difference in the world. Friends also help us see life from different perspectives, broadening our views. They provide a sense of belonging and remind us that we're not alone in the world. Through friendship, we find support in facing life's challenges and share in each other's successes."
                },
                {
                    title: "3) The Joy of Reading",
                    text: "Reading is one of the most enjoyable and educational activities a person can do. Books have the ability to transport readers to different worlds, eras, and perspectives. Whether you're reading fiction or nonfiction, there is always something to learn or imagine. The pages of a good book are filled with adventures, mysteries, and new ideas. Reading also improves vocabulary, enhances concentration, and sparks creativity. It's a timeless activity that has enriched human culture for centuries and will continue to do so for generations to come. For many, reading provides an escape from the mundane, offering a place to explore other realities. It's a quiet pursuit that allows the mind to wander freely, while offering knowledge in every page. The joy of reading lies in the freedom it provides to discover new things while expanding one's understanding of the world."
                },
                {
                    title: "4) A Simple Cup of Tea",
                    text: "There's something comforting about a cup of tea. Whether you drink it hot or cold, with milk or without, tea has the power to calm your mind and soothe your senses. Many cultures around the world have their own tea rituals and traditions, each one filled with meaning and history. The warmth of the cup, the delicate fragrance, and the simple act of sipping tea can make even the busiest day feel more peaceful. A cup of tea is not just a drink; it's a moment of quiet reflection. Tea has been shown to have numerous health benefits, from improving digestion to reducing stress levels. It brings people together, often serving as a focal point for conversation. Whether enjoyed alone or with others, tea has a way of making everything feel more serene."
                },
                {
                    title: "5) The Fun of Gardening",
                    text: "Gardening is an enjoyable hobby that many people around the world engage in. Whether youre planting flowers, vegetables, or herbs, tending to a garden brings a sense of accomplishment. Watching plants grow from seeds into fully developed flowers or crops is a rewarding experience. Gardening also provides an opportunity to spend time outdoors, enjoy nature, and learn about different plant species. Its a relaxing activity that can reduce stress and create beautiful spaces in your home. Many gardeners find peace in the repetitive, hands-on work of planting, weeding, and watering. The process of growing something from the ground up is deeply satisfying. Plus, gardens attract beneficial insects like bees and butterflies, contributing to the local ecosystem."
                }
            ],
            "Medium": [
                {
                    title: "1) The Future of Technology",
                    text: "Technology has advanced at an incredible rate over the past few decades, and its potential seems limitless. With innovations in artificial intelligence, robotics, and biotechnology, the future holds many exciting possibilities. We can expect machines to become even smarter, able to assist in tasks that were once thought to be only human endeavors. The way we live, work, and communicate will continue to change, and many jobs will be transformed by automation. However, the rise of new technologies also brings challenges, such as privacy concerns and the need for ethical considerations in their use. The growing reliance on digital tools has also raised questions about the sustainability of technology, especially when it comes to resource usage and e-waste. As we advance, society will need to find a balance between technological progress and the preservation of human values. Its clear that the future of technology will not only reshape industries but also redefine our very way of life."
                },
                {
                    title: "2) The Influence of Social Media",
                    text: "Social media has revolutionized the way people communicate and share information. Platforms like Instagram, Twitter, and Facebook allow individuals to connect with others across the globe instantly. While social media has many positive aspects, such as providing a platform for marginalized voices and fostering relationships, it also has negative consequences. Overuse of social media can lead to feelings of isolation, anxiety, and a distorted sense of reality. Balancing time spent on social platforms with real-life interactions is key to maintaining mental well-being. Social medias role in shaping public opinion has become undeniable, sometimes influencing elections or public policies. It also acts as a mirror, reflecting both the beauty and the flaws of human society. As a result, its important for users to cultivate mindful habits and critical thinking when navigating these platforms."
                },
                {
                    title: "3) The Changing Climate",
                    text: "Climate change is one of the most pressing issues facing the world today. The Earths temperature is rising at an alarming rate, leading to more frequent and severe weather events, such as hurricanes, droughts, and floods. The burning of fossil fuels, deforestation, and industrial pollution are major contributors to global warming. It is crucial that nations work together to reduce carbon emissions, switch to renewable energy sources, and implement sustainable practices. Protecting the planet is not just about preserving natural beauty; its about ensuring a livable future for generations to come. The economic consequences of climate change are also significant, as natural disasters destroy infrastructure and disrupt food supplies. Climate change demands a global response, where every country, regardless of size or wealth, contributes to mitigating its impact. Only through collective action can we hope to stabilize the planet's climate and reduce future harm."
                },
                {
                    title: "4) The Power of Music",
                    text: "Music has the unique ability to evoke emotions, trigger memories, and connect people from different cultures. Throughout history, music has been used as a form of expression, healing, and communication. From classical symphonies to modern pop hits, music can stir the soul in ways words cannot. It plays an important role in rituals, celebrations, and even therapy. Research has shown that music can reduce stress, improve mood, and enhance cognitive function. Whether it's the rhythm of a drumbeat or the harmony of a piano, music has a profound impact on the human experience. It allows individuals to express feelings they may struggle to put into words, and can create a shared bond between people. Whether listening to a favorite song or participating in live performances, music serves as a universal language that transcends barriers. It truly has the power to bring joy, comfort, and healing."
                },
                {
                    title: "5) The Evolution of Education",
                    text: "Education has evolved significantly over the years, from traditional classroom settings to online learning and self-directed education. The internet has made knowledge accessible to people all around the world, allowing students to take courses, watch lectures, and engage with experts from their homes. With advances in technology, virtual classrooms, and digital resources, education is more flexible and customizable than ever before. However, despite these advancements, challenges remain, such as disparities in access to technology and the need for more inclusive learning environments. As education becomes more digital, there are concerns about the lack of personal connection in online learning environments. The need for interactive and engaging content to keep students interested has led to the rise of gamification and multimedia tools. Education will continue to evolve, but its essential to ensure that all students, regardless of their background, have equal access to these new opportunities."
                }
            ],
            "Hard": [
                {
                    title: "1) The Complexity of Calculating Pi",
                    text: "Pi () is one of the most famous mathematical constants, representing the ratio of a circle's circumference to its diameter. The value of pi starts as 3.14159, but its true decimal expansion continues infinitely without repeating. As of recent computational breakthroughs, pi has been calculated to over 62.8 trillion decimal places. This feat requires immense computing power, utilizing advanced algorithms like the Chudnovsky algorithm, which involves complex formulas and rapid convergence to achieve extreme precision. Even though only a few decimal places are necessary for practical calculations, pis expansion serves as an important benchmark for testing computational limits. Interestingly, the digits of pi have been the subject of fascination, with mathematicians and enthusiasts often searching for patterns or meaningful sequences hidden within its endless string of numbers. Despite pi's infinite nature, calculations such as 3.1415926535... extend to far more places, giving rise to new challenges in numerical computation and storage efficiency."
                },
                {
                    title: "2) The Uncertainty Principle",
                    text: "The Heisenberg Uncertainty Principle, formulated in 1927 by Werner Heisenberg, is a fundamental concept in quantum mechanics that describes the limits of precision with which certain pairs of physical properties, such as position and momentum, can be known. According to the principle, the more precisely one property is measured, the less precisely the other can be determined. Mathematically, this is represented as x * p   / 2, where x is the uncertainty in position, p is the uncertainty in momentum, and  is the reduced Planck constant, approximately equal to 1.0545718  10 Js. This principle not only defines the boundaries of measurement but also challenges the deterministic nature of classical physics. As quantum mechanics deals with subatomic particles, the existence of probabilities over certainties creates a dynamic, unpredictable reality where even precise values can only be approximated within a certain margin. This uncertainty has profound implications for fields ranging from particle physics to the development of quantum computers."
                },
                {
                    title: "3) Compound Interest in Finance",
                    text: "In finance, compound interest refers to the interest on both the initial principal and the accumulated interest from previous periods. The formula for compound interest is A = P (1 + r/n)^(nt), where A is the amount of money accumulated after n years, including interest, P is the principal amount, r is the annual interest rate (decimal), n is the number of times that interest is compounded per unit t, and t is the time the money is invested or borrowed for in years. For example, if you invest $5,000 at an interest rate of 7.5% annually, compounded quarterly for 10 years, the formula would look like this: A = 5000(1 + 0.075/4)^(410). When plugged into a calculator, the result gives the total amount, demonstrating how the investment grows exponentially over time. This principle is not only crucial for savings accounts and loans but also for evaluating complex financial portfolios, where minor fluctuations in interest rates or compounding periods can lead to significant differences in the final outcomes, often requiring detailed mathematical software for accurate predictions."
                },
                {
                    title: "4D) The Fibonacci Sequence",
                    text: "The Fibonacci sequence is a series of numbers in which each number is the sum of the two preceding ones, starting from 0 and 1. Mathematically, the sequence is expressed as F(n) = F(n-1) + F(n-2), where n > 1. The first few terms are 0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, and so on. This sequence is closely related to the golden ratio, denoted by  (phi), which is approximately 1.6180339887... As the Fibonacci sequence progresses, the ratio of consecutive Fibonacci numbers approximates the golden ratio more and more closely. The sequence appears in various fields such as computer algorithms, biology (e.g., the branching of trees, the arrangement of leaves, and the spiral patterns of shells), and even art and architecture. In fact, the Fibonacci spiral, derived from plotting the sequence on a logarithmic scale, is used to model natural growth patterns. The mathematical elegance of the Fibonacci sequence continues to fascinate mathematicians, scientists, and artists alike, offering a bridge between abstract theory and real-world phenomena."
                },
                {
                    title: "5) Statistical Significance",
                    text: "In statistical analysis, determining the significance of a result is crucial for understanding the likelihood that the observed data occurred by chance. One of the most common tools used to measure statistical significance is the p-value, which represents the probability of obtaining a result at least as extreme as the one observed, given that the null hypothesis is true. A p-value less than 0.05 (usually 0.01 or 0.001) is typically considered statistically significant, meaning there is less than a 5%, 1%, or 0.1% chance that the result is due to random variation. However, it is important to note that a small p-value does not guarantee practical significance. For instance, a study with a sample size of 10,000 may find a statistically significant difference that is too small to matter in real-world applications. Additionally, multiple comparisons or tests may require adjustments, such as the Bonferroni correction, to avoid Type I errors. Researchers must interpret p-values carefully, considering the context of the data, the study design, and the potential for both Type I and Type II errors (false positives and false negatives). The concept of statistical significance is fundamental to ensuring that conclusions drawn from research are both reliable and meaningful."
                }
            ],
            "Number Practice": [
                {
                    title: "1) Easy Numbers",
                    text: "124 567 890 2301 4456 7890 112 334 556 778 990 1200 4501 6789 2345 7891 6677 4488 9900 1011 2233 4455 6677 8899 1212 3434 5656 7878 9090 2020 3030 4040 5050 6060 7070 8080 9090 1111 2222 3333 4444 5555 6666 7777 8888 9999 1234 2345 3456 4567 5678 6789 7890 8901 9012 1023 2134 3245 4356 5467 6578 7689 8790 9801 1092 2193 3294 4395 5496 6597 7698"
                },
                {
                    title: "2) Medium Numbers",
                    text: "$120.50 $899 $3,450.99 05/12/2024 11/09/2023 78.00% 12/07/25 $1,200 03/05/2022 $560.45 $450.75 22-04-2023 99.99% 15/11/2025 $7,800 31-12-2020 $1,499.50 09/09/2024 $250 18-07-2021 $4,300.00 12/08/2024 07/12/2020 $990.40 $8,999.99 24-06-2023 $12,450.75 01-01-2022 $45.90 16-09-2025 2024/11/07 2025-03-14 $650.80 $450.99 $12.00 120.45% 30-09-2024 02/02/2020 $4,560.77 $2,999.00 20-11-2023 2026/04/25"
                },
                {
                    title: "3) Hard Numbers",
                    text: "99.4503 1200.009 0.00455 45.7789 9921.00451 @12063 $28/01/2022 1,200,450.77 0.000345 55.90012 782.441.009@ 2024-11-15 2025/07/28 11/07/2025 07-31-2024 $12,450.993 $889.0045 $99,450.75$$ 123.456.789 4500.00981 0.00000077 99123.55609 0.990045 8.0099001 55,778.009 0.00440001 2023-12-31 12/29/2025 2027/01/09 30-04-2028 1,999,450.8871 77.004400 0.5567009 $1,200,450.004 $78.00456 $4,50,990.778 0.9900.112 (type literally) 5500.090077 0.00001234"
                }
            ]
        };


        // --- 3. Application State & DOM Elements ---

        // Settings
        const categorySelect = document.getElementById('category-select');
        const timeSelectGroup = document.getElementById('time-select-group');
        const paragraphList = document.getElementById('paragraph-list');

        // Typing Area
        const sourceParagraphDisplay = document.getElementById('source-paragraph-display');
        const typingInput = document.getElementById('typing-input');
        const keyboard = document.getElementById('keyboard');
        const keyboardKeys = document.querySelectorAll('.key');

        // Stats
        const timerDisplay = document.getElementById('timer-display');
        const wpmDisplay = document.getElementById('wpm-display');
        const accuracyDisplay = document.getElementById('accuracy-display');
        const restartButton = document.getElementById('restart-button');
        
        // Chart
        const speedChartCanvas = document.getElementById('speed-chart');
        let speedChart;
        let chartData = [];

        // Modal
        const resultModal = new bootstrap.Modal(document.getElementById('result-modal'));
        const modalWpm = document.getElementById('modal-wpm');
        const modalAccuracy = document.getElementById('modal-accuracy');
        const modalChars = document.getElementById('modal-chars');
        const modalTime = document.getElementById('modal-time');
        const saveButton = document.getElementById('save-button');
        const closeButton = document.getElementById('close-button');

        // SPA View Elements
        const mainView = document.getElementById('main-view');
        const historyView = document.getElementById('history-view');
        const homeLink = document.getElementById('home-link');
        const historyLink = document.getElementById('history-link');
        const footerHomeLink = document.getElementById('footer-home-link');
        const footerHistoryLink = document.getElementById('footer-history-link');
        const historyTableBody = document.getElementById('history-table-body');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        
        // NEW: Theme Bar Elements
        const themeToggleSwitch = document.getElementById('theme-toggle-switch');
        const handToggle = document.getElementById('hand-toggle');
        const focusToggle = document.getElementById('focus-toggle');
        const keyboardTheme = document.getElementById('keyboard-theme');


        // Game State
        let selectedTime = 60; // Default 1 min (in seconds)
        let selectedCategory = 'Easy';
        let selectedParagraph = "";
        let sourceTextChars = [];
        let timerInterval;
        let timeRemaining = selectedTime;
        let testActive = false;
        let currentIndex = 0;
        let correctChars = 0;
        let incorrectChars = 0;
        let totalTypedChars = 0;
        let testStartTime;
        let currentTestResult = {};
        
        // --- 4. Function Declarations (Moved up for safety) ---
        
        /**
         * Updates the timer display on the screen.
         */
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }
        
        /**
         * Initializes the speed chart.
         */
        function initSpeedChart() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded.');
                return;
            }
            const ctx = speedChartCanvas.getContext('2d');
            const initialTheme = htmlEl.getAttribute('data-bs-theme') || 'light';
            let gridColor = (initialTheme === 'dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            let fontColor = (initialTheme === 'dark') ? '#e0e0e0' : '#212529';
            let primaryColor = (initialTheme === 'dark') ? '#00f0b5' : '#6a11cb';


            speedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'WPM',
                        data: [],
                        borderColor: primaryColor,
                        backgroundColor: `rgba(${(initialTheme === 'dark' ? '0, 240, 181' : '106, 17, 203')}, 0.1)`,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: fontColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: fontColor },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true }
                    }
                }
            });
        }
        
        /**
         * Updates chart colors on theme change.
         */
        function updateChartColors(theme) {
            if (!speedChart) return;

            let gridColor = (theme === 'dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            let fontColor = (theme === 'dark') ? '#e0e0e0' : '#212529';
            let primaryColor = (theme === 'dark') ? '#00f0b5' : '#6a11cb';
            let bgColor = (theme === 'dark') ? 'rgba(0, 240, 181, 0.1)' : 'rgba(106, 17, 203, 0.1)';

            speedChart.options.scales.y.ticks.color = fontColor;
            speedChart.options.scales.y.grid.color = gridColor;
            speedChart.options.scales.x.ticks.color = fontColor;
            speedChart.options.scales.x.grid.color = gridColor;
            
            speedChart.data.datasets[0].borderColor = primaryColor;
            speedChart.data.datasets[0].backgroundColor = bgColor;
            
            speedChart.update();
        }

        // --- 5. Initialization ---

        function initializeApp() {
            // Setup Listeners
            categorySelect.addEventListener('change', handleCategoryChange);
            timeSelectGroup.addEventListener('click', handleTimeChange);
            paragraphList.addEventListener('click', handleParagraphSelect);
            typingInput.addEventListener('input', handleTyping);
            
            // FIX: Prevent Tab from changing focus
            typingInput.addEventListener('keydown', (e) => {
                if (e.key === "Tab") {
                    e.preventDefault();
                    // Handle tab insertion manually if needed
                }
                
                // NEW: Manually handle spacebar for highlighting and logic
                if (e.key === ' ') {
                    e.preventDefault();
                    if (!testActive) startTest();
                    if (testActive) {
                        typingInput.value += ' ';
                        // Manually trigger the input event logic
                        const inputEvent = new Event('input', { bubbles: true });
                        typingInput.dispatchEvent(inputEvent);
                    }
                }
            });
            
            restartButton.addEventListener('click', resetTest);
            saveButton.addEventListener('click', saveProgress);
            closeButton.addEventListener('click', resetTest);

            // SPA Navigation Listeners
            homeLink.addEventListener('click', (e) => {
                e.preventDefault();
                showMainView();
            });
            historyLink.addEventListener('click', (e) => {
                e.preventDefault();
                showHistoryView();
            });
            footerHomeLink.addEventListener('click', (e) => {
                e.preventDefault();
                showMainView();
            });
            footerHistoryLink.addEventListener('click', (e) => {
                e.preventDefault();
                showHistoryView();
            });
            clearHistoryBtn.addEventListener('click', clearHistory);


            // Virtual Keyboard listeners
            window.addEventListener('keydown', highlightKey);
            window.addEventListener('keyup', unhighlightKey);

            // NEW: Theme Bar Listeners
            themeToggleSwitch.addEventListener('change', (e) => {
                const newTheme = e.target.checked ? 'dark' : 'light';
                setTheme(newTheme);
            });
            handToggle.addEventListener('change', (e) => {
                document.body.classList.toggle('hands-hidden', !e.target.checked);
            });
            focusToggle.addEventListener('change', (e) => {
                document.body.classList.toggle('focus-gradient-enabled', e.target.checked);
            });
            keyboardTheme.addEventListener('click', () => {
                if (keyboard.classList.contains('theme-default')) {
                    keyboard.classList.remove('theme-default');
                    keyboard.classList.add('theme-color');
                    keyboardTheme.textContent = "Theme: Color";
                } else {
                    keyboard.classList.remove('theme-color');
                    keyboard.classList.add('theme-default');
                    keyboardTheme.textContent = "Theme: Default";
                }
            });


            // Initial Load
            loadParagraphList(selectedCategory);
            updateTimerDisplay(); // Moved to top, error fixed
            initSpeedChart(); // Moved to top, error fixed
        }
        
        // --- Theme & Background ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            updateAnimatedBackground(); 
            document.getElementById('footer-year').textContent = new Date().getFullYear();
            
            // --- App Initialization ---
            initializeApp(); // Call initializeApp
        });

        function setTheme(theme) {
            htmlEl.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            
            // Update toggle switch
            themeToggleSwitch.checked = (theme === 'dark');
            
            updateAnimatedBackground();
            if (speedChart) {
                updateChartColors(theme);
            }
        }

        function updateAnimatedBackground() {
            const theme = htmlEl.getAttribute('data-bs-theme');
            const bgImages = document.querySelectorAll(`.bg-image-${theme}`);
            if (bgImages.length === 0) return;
            bgImages.forEach(img => img.classList.remove('active'));
            currentImageIndex = (currentImageIndex + 1) % bgImages.length;
            bgImages[currentImageIndex].classList.add('active');
        }
        setInterval(updateAnimatedBackground, 5000);


        // --- 6. Settings & Loading Logic ---

        function handleCategoryChange(e) {
            selectedCategory = e.target.value;
            loadParagraphList(selectedCategory);
            resetTest();
        }

        function handleTimeChange(e) {
            if (e.target.tagName === 'BUTTON') {
                timeSelectGroup.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                selectedTime = parseInt(e.target.dataset.time) * 60;
                resetTest();
            }
        }

        function loadParagraphList(category) {
            paragraphList.innerHTML = '';
            const paragraphs = paragraphData[category];
            paragraphs.forEach((para, index) => {
                const item = document.createElement('a');
                item.href = "#";
                item.className = 'list-group-item list-group-item-action';
                item.textContent = para.title;
                item.dataset.category = category;
                item.dataset.index = index;
                paragraphList.appendChild(item);
            });
            if (paragraphs.length > 0) {
                paragraphList.firstElementChild.classList.add('active');
                loadParagraph(category, 0);
            }
        }

        function handleParagraphSelect(e) {
            e.preventDefault();
            if (e.target.tagName === 'A') {
                paragraphList.querySelectorAll('a').forEach(a => a.classList.remove('active'));
                e.target.classList.add('active');
                const category = e.target.dataset.category;
                const index = parseInt(e.target.dataset.index);
                loadParagraph(category, index);
            }
        }

        function loadParagraph(category, index) {
            resetTest(); 
            selectedParagraph = paragraphData[category][index].text;
            sourceParagraphDisplay.innerHTML = ''; 
            
            sourceTextChars = selectedParagraph.split('');
            sourceTextChars.forEach(char => {
                const span = document.createElement('span');
                span.textContent = char;
                sourceParagraphDisplay.appendChild(span);
            });
            
            sourceParagraphDisplay.firstElementChild?.classList.add('char-current');
            typingInput.disabled = false;
        }

        // --- 7. Test & Core Logic ---

        function resetTest() {
            clearInterval(timerInterval);
            timerInterval = null;
            
            testActive = false;
            timeRemaining = selectedTime;
            currentIndex = 0;
            correctChars = 0;
            incorrectChars = 0;
            totalTypedChars = 0;
            currentTestResult = {};
            chartData = [];

            updateTimerDisplay(); 
            wpmDisplay.textContent = '0';
            accuracyDisplay.textContent = '100%';
            typingInput.value = '';
            restartButton.disabled = true;

            if (sourceParagraphDisplay.firstElementChild) {
                 sourceParagraphDisplay.querySelectorAll('span').forEach(span => {
                    span.className = '';
                });
                sourceParagraphDisplay.firstElementChild.classList.add('char-current');
            } else {
                typingInput.disabled = true;
                sourceParagraphDisplay.textContent = 'Click a paragraph from the list to start...';
            }
            
            if (speedChart) {
                speedChart.data.labels = [];
                speedChart.data.datasets[0].data = [];
                speedChart.update();
            }
        }

        function handleTyping(e) {
            // 'e' can be an 'input' event or a 'keydown' event (for spacebar)
            
            if (!testActive) {
                // This check is now redundant because startTest() is called from keydown/input
                // but we keep it as a safeguard.
                startTest();
            }
            
            const typedText = typingInput.value;
            let typedChar;
            
            // Determine the character that was just typed
            if (e.key === ' ') {
                // Handle spacebar event
                typedChar = ' ';
            } else if (e.type === 'input') {
                // Handle normal input event
                typedChar = typedText[currentIndex]; // Check against the char at the current index
            } else {
                // Not an event we care about
                return;
            }

            // Handle backspace 
            if (typedText.length < currentIndex) {
                currentIndex--;
                totalTypedChars--; // This logic might be complex, let's simplify
                
                // On backspace, just re-evaluate the whole string
                // This is less efficient but more robust
                totalTypedChars = typedText.length;
                currentIndex = typedText.length;
                correctChars = 0;
                incorrectChars = 0;
                
                sourceParagraphDisplay.querySelectorAll('span').forEach((span, index) => {
                    if (index < currentIndex) {
                        if (typedText[index] === sourceTextChars[index]) {
                            span.className = 'char-correct';
                            correctChars++;
                        } else {
                            span.className = 'char-incorrect';
                            incorrectChars++;
                        }
                    } else if (index === currentIndex) {
                        span.className = 'char-current';
                    } else {
                        span.className = '';
                    }
                });
                
                updateStats();
                return;
            }

            // Handle standard character (or spacebar from keydown)
            if (currentIndex >= sourceTextChars.length) {
                // If we are at the end, only allow backspace
                if (e.key !== 'Backspace') { 
                    typingInput.value = typedText.substring(0, typedText.length - 1);
                }
                return;
            }

            const sourceChar = sourceTextChars[currentIndex];
            totalTypedChars++;
            const span = sourceParagraphDisplay.children[currentIndex];
            
            if (typedChar === sourceChar) {
                span.className = 'char-correct';
                correctChars++;
            } else {
                span.className = 'char-incorrect';
                incorrectChars++;
            }

            currentIndex++;

            // Check for end of test (by text completion)
            if (currentIndex === sourceTextChars.length) {
                endTest();
                return;
            }

            // Move cursor
            if(sourceParagraphDisplay.children[currentIndex]) {
                sourceParagraphDisplay.children[currentIndex].classList.add('char-current');
            }
            
            // Scroll paragraph display
            const currentSpan = sourceParagraphDisplay.children[currentIndex];
            if(currentSpan) {
                const displayRect = sourceParagraphDisplay.getBoundingClientRect();
                const spanRect = currentSpan.getBoundingClientRect();
                if (spanRect.bottom > displayRect.bottom - 20) {
                    sourceParagraphDisplay.scrollTop += spanRect.bottom - displayRect.bottom + 40;
                }
                if (spanRect.top < displayRect.top + 20) {
                     sourceParagraphDisplay.scrollTop -= displayRect.top - spanRect.top + 40;
                }
            }
            
            updateStats();
        }


        function startTest() {
            if (testActive) return; // Prevent multiple starts
            
            testActive = true;
            testStartTime = new Date();
            restartButton.disabled = false;

            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();

                // Update chart every second
                updateStats(); 
                updateChart(calculateWPM());

                if (timeRemaining <= 0) {
                    endTest();
                }
            }, 1000);
        }

        function endTest() {
            clearInterval(timerInterval);
            timerInterval = null;
            testActive = false;
            typingInput.disabled = true;
            restartButton.disabled = false;

            const finalWPM = calculateWPM();
            const finalAccuracy = calculateAccuracy();
            
            currentTestResult = {
                date: new Date().toLocaleString(),
                category: selectedCategory,
                time: selectedTime,
                wpm: finalWPM,
                accuracy: finalAccuracy,
                charsCorrect: correctChars,
                charsTotal: totalTypedChars
            };

            // Show modal
            modalWpm.textContent = finalWPM;
            modalAccuracy.textContent = `${finalAccuracy}%`;
            modalChars.textContent = `${correctChars} / ${totalTypedChars}`;
            modalTime.textContent = `${selectedTime}s`;
            resultModal.show();
        }

        function updateStats() {
            wpmDisplay.textContent = calculateWPM();
            accuracyDisplay.textContent = `${calculateAccuracy()}%`;
        }

        function calculateWPM() {
            const timeElapsedMinutes = (new Date() - testStartTime) / 60000;
            if (timeElapsedMinutes === 0) return 0;
            const wpm = Math.round((correctChars / 5) / timeElapsedMinutes);
            return wpm < 0 ? 0 : wpm;
        }

        function calculateAccuracy() {
            if (totalTypedChars === 0) return 100;
            const accuracy = Math.round((correctChars / totalTypedChars) * 100);
            return accuracy < 0 ? 0 : accuracy;
        }

        // --- 8. Chart Logic ---
        
        function updateChart(wpm) {
            if (!speedChart) return;
            const timeElapsed = Math.floor((new Date() - testStartTime) / 1000);
            speedChart.data.labels.push(`${timeElapsed}s`);
            speedChart.data.datasets[0].data.push(wpm);
            speedChart.update();
        }

        // --- 9. Virtual Keyboard Logic ---

        function highlightKey(e) {
            // This function ONLY handles VISUALS (and starting the test)
            
            // Start test on first keypress
            if (!testActive && e.key.length === 1 && !e.ctrlKey && !e.altKey) {
                 typingInput.focus();
                 // StartTest() will be called by the 'input' event
                 // or by the spacebar handler
            }
            
            // Handle spacebar key code
            const keyCode = (e.key === ' ') ? ' ' : (e.key.toLowerCase() || e.code);
            const keyElement = document.querySelector(`.key[data-key="${keyCode}"]`) ||
                               document.querySelector(`.key[data-key="${e.code}"]`);
            
            if (keyElement) {
                keyElement.classList.add('active-press');
                
                // Highlight hand finger
                const finger = keyElement.dataset.finger;
                if (finger) {
                    if (finger === 'lf-thumb rf-thumb') {
                        document.getElementById('lf-thumb')?.classList.add('active');
                        document.getElementById('rf-thumb')?.classList.add('active');
                    } else {
                        document.getElementById(finger)?.classList.add('active');
                    }
                }
            }
        }

        function unhighlightKey(e) {
            const keyCode = (e.key === ' ') ? ' ' : (e.key.toLowerCase() || e.code);
            const keyElement = document.querySelector(`.key[data-key="${keyCode}"]`) ||
                               document.querySelector(`.key[data-key="${e.code}"]`);
            
            if (keyElement) {
                keyElement.classList.remove('active-press');
                
                // Unhighlight hand finger
                const finger = keyElement.dataset.finger;
                if (finger) {
                    if (finger === 'lf-thumb rf-thumb') {
                        document.getElementById('lf-thumb')?.classList.remove('active');
                        document.getElementById('rf-thumb')?.classList.remove('active');
                    } else {
                        document.getElementById(finger)?.classList.remove('active');
                    }
                }
            }
        }

        // --- 10. SPA Navigation & Save Logic ---

        function showMainView() {
            historyView.classList.add('d-none');
            mainView.classList.add('d-flex');
            mainView.classList.remove('d-none');

            historyLink.classList.remove('active');
            homeLink.classList.add('active');
            
            resetTest();
        }
        
        function showHistoryView() {
            mainView.classList.add('d-none');
            mainView.classList.remove('d-flex');
            historyView.classList.remove('d-none');
            
            homeLink.classList.remove('active');
            historyLink.classList.add('active');
            
            loadHistory();
        }
        
        function loadHistory() {
            let history = JSON.parse(localStorage.getItem('typingHistory')) || [];
            historyTableBody.innerHTML = ''; // Clear old data

            if (history.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No saved progress found.</td></tr>';
                return;
            }

            history.reverse().forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.date}</td>
                    <td>${item.category}</td>
                    <td>${item.time / 60} min</td>
                    <td>${item.wpm}</td>
                    <td>${item.accuracy}%</td>
                    <td>${item.charsCorrect} / ${item.charsTotal}</td>
                `;
                historyTableBody.appendChild(tr);
            });
        }
        
        function clearHistory() {
            if (confirm('Are you sure you want to clear all typing history? This cannot be undone.')) {
                localStorage.removeItem('typingHistory');
                loadHistory(); // Reload the empty table
            }
        }

        function saveProgress() {
            if (!currentTestResult.date) return;
            
            let history = JSON.parse(localStorage.getItem('typingHistory')) || [];
            history.push(currentTestResult);
            localStorage.setItem('typingHistory', JSON.stringify(history));
            
            resultModal.hide();
            resetTest();
        }

    </script>

</body>
</html>
